"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.WindowsDriver = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _winappdriver = require("./winappdriver");

var _logger = _interopRequireDefault(require("./logger"));

var _desiredCaps = require("./desired-caps");

var _index = _interopRequireDefault(require("./commands/index"));

var _constants = require("constants");

const NO_PROXY = [['GET', new RegExp('^/session/[^/]+/appium/(?!app/)[^/]+')], ['POST', new RegExp('^/session/[^/]+/appium/(?!app/)[^/]+')], ['POST', new RegExp('^/session/[^/]+/element/[^/]+/elements?$')], ['POST', new RegExp('^/session/[^/]+/elements?$')], ['POST', new RegExp('^/session/[^/]+/execute')], ['POST', new RegExp('^/session/[^/]+/execute/sync')], ['POST', new RegExp('^/session/[^/]+/appium/device/push_file')], ['POST', new RegExp('^/session/[^/]+/appium/device/pull_file')], ['POST', new RegExp('^/session/[^/]+/appium/device/pull_folder')]];

class WindowsDriver extends _appiumBaseDriver.BaseDriver {
  constructor(opts = {}, shouldValidateCaps = true) {
    super(opts, shouldValidateCaps);
    this.desiredCapConstraints = _desiredCaps.desiredCapConstraints;
    this.locatorStrategies = ['xpath', 'id', 'name', 'class name', 'accessibility id'];
    this.resetState();

    for (const [cmd, fn] of _lodash.default.toPairs(_index.default)) {
      WindowsDriver.prototype[cmd] = fn;
    }
  }

  resetState() {
    this.jwpProxyAvoid = NO_PROXY;
    this.isProxyActive = false;
    this.winAppDriver = null;
    this._screenRecorder = null;
  }

  async createSession(...args) {
    if (!_appiumSupport.system.isWindows()) {
      throw new Error('WinAppDriver tests only run on Windows');
    }

    try {
      const [sessionId, caps] = await super.createSession(...args);

      if (caps.prerun) {
        _logger.default.info('Executing prerun PowerShell script');

        if (!_lodash.default.isString(caps.prerun.command) && !_lodash.default.isString(caps.prerun.script)) {
          throw new Error(`'prerun' capability value must either contain ` + `'script' or 'command' entry of string type`);
        }

        this.ensureFeatureEnabled(_constants.POWER_SHELL_FEATURE);
        const output = await this.execPowerShell(caps.prerun);

        if (output) {
          _logger.default.info(`Prerun script output: ${output}`);
        }
      }

      await this.startWinAppDriverSession();
      return [sessionId, caps];
    } catch (e) {
      await this.deleteSession();
      throw e;
    }
  }

  async startWinAppDriverSession() {
    this.winAppDriver = new _winappdriver.WinAppDriver({
      port: this.opts.systemPort
    });
    await this.winAppDriver.start(this.caps);
    this.proxyReqRes = this.winAppDriver.proxy.proxyReqRes.bind(this.winAppDriver.proxy);
    this.isProxyActive = true;
  }

  async deleteSession() {
    var _this$_screenRecorder, _this$winAppDriver;

    _logger.default.debug('Deleting WinAppDriver session');

    await ((_this$_screenRecorder = this._screenRecorder) === null || _this$_screenRecorder === void 0 ? void 0 : _this$_screenRecorder.stop(true));
    await ((_this$winAppDriver = this.winAppDriver) === null || _this$winAppDriver === void 0 ? void 0 : _this$winAppDriver.stop());

    if (this.opts.postrun) {
      if (!_lodash.default.isString(this.opts.postrun.command) && !_lodash.default.isString(this.opts.postrun.script)) {
        _logger.default.error(`'postrun' capability value must either contain ` + `'script' or 'command' entry of string type`);
      } else {
        _logger.default.info('Executing postrun PowerShell script');

        try {
          this.ensureFeatureEnabled(_constants.POWER_SHELL_FEATURE);
          const output = await this.execPowerShell(this.opts.postrun);

          if (output) {
            _logger.default.info(`Postrun script output: ${output}`);
          }
        } catch (e) {
          _logger.default.error(e.message);
        }
      }
    }

    this.resetState();
    await super.deleteSession();
  }

  proxyActive() {
    return this.isProxyActive;
  }

  canProxy() {
    return true;
  }

  getProxyAvoidList() {
    return this.jwpProxyAvoid;
  }

}

exports.WindowsDriver = WindowsDriver;
var _default = WindowsDriver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kcml2ZXIuanMiXSwibmFtZXMiOlsiTk9fUFJPWFkiLCJSZWdFeHAiLCJXaW5kb3dzRHJpdmVyIiwiQmFzZURyaXZlciIsImNvbnN0cnVjdG9yIiwib3B0cyIsInNob3VsZFZhbGlkYXRlQ2FwcyIsImRlc2lyZWRDYXBDb25zdHJhaW50cyIsImxvY2F0b3JTdHJhdGVnaWVzIiwicmVzZXRTdGF0ZSIsImNtZCIsImZuIiwiXyIsInRvUGFpcnMiLCJjb21tYW5kcyIsInByb3RvdHlwZSIsImp3cFByb3h5QXZvaWQiLCJpc1Byb3h5QWN0aXZlIiwid2luQXBwRHJpdmVyIiwiX3NjcmVlblJlY29yZGVyIiwiY3JlYXRlU2Vzc2lvbiIsImFyZ3MiLCJzeXN0ZW0iLCJpc1dpbmRvd3MiLCJFcnJvciIsInNlc3Npb25JZCIsImNhcHMiLCJwcmVydW4iLCJsb2ciLCJpbmZvIiwiaXNTdHJpbmciLCJjb21tYW5kIiwic2NyaXB0IiwiZW5zdXJlRmVhdHVyZUVuYWJsZWQiLCJQT1dFUl9TSEVMTF9GRUFUVVJFIiwib3V0cHV0IiwiZXhlY1Bvd2VyU2hlbGwiLCJzdGFydFdpbkFwcERyaXZlclNlc3Npb24iLCJlIiwiZGVsZXRlU2Vzc2lvbiIsIldpbkFwcERyaXZlciIsInBvcnQiLCJzeXN0ZW1Qb3J0Iiwic3RhcnQiLCJwcm94eVJlcVJlcyIsInByb3h5IiwiYmluZCIsImRlYnVnIiwic3RvcCIsInBvc3RydW4iLCJlcnJvciIsIm1lc3NhZ2UiLCJwcm94eUFjdGl2ZSIsImNhblByb3h5IiwiZ2V0UHJveHlBdm9pZExpc3QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsUUFBUSxHQUFHLENBQ2YsQ0FBQyxLQUFELEVBQVEsSUFBSUMsTUFBSixDQUFXLHNDQUFYLENBQVIsQ0FEZSxFQUVmLENBQUMsTUFBRCxFQUFTLElBQUlBLE1BQUosQ0FBVyxzQ0FBWCxD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eUJNLE1BQU8sRUFBMUM7QUFDRDtBQUNGLFNBTkQsQ0FNRSxPQUFPRyxDQUFQLEVBQVU7QUFDVlYsMEJBQUlzQixLQUFKLENBQVVaLENBQUMsQ0FBQ2EsT0FBWjtBQUNEO0FBQ0Y7QUFDRjs7QUFFRCxTQUFLMUMsVUFBTDtBQUVBLFVBQU0sTUFBTThCLGFBQU4sRUFBTjtBQUNEOztBQUVEYSxFQUFBQSxXQUFXLEdBQUk7QUFDYixXQUFPLEtBQUtuQyxhQUFaO0FBQ0Q7O0FBRURvQyxFQUFBQSxRQUFRLEdBQUk7QUFFVixXQUFPLElBQVA7QUFDRDs7QUFFREMsRUFBQUEsaUJBQWlCLEdBQWlCO0FBQ2hDLFdBQU8sS0FBS3RDLGFBQVo7QUFDRDs7QUF0R29DOzs7ZUEwR3hCZCxhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEJhc2VEcml2ZXIgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgc3lzdGVtIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgV2luQXBwRHJpdmVyIH0gZnJvbSAnLi93aW5hcHBkcml2ZXInO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBkZXNpcmVkQ2FwQ29uc3RyYWludHMgfSBmcm9tICcuL2Rlc2lyZWQtY2Fwcyc7XG5pbXBvcnQgY29tbWFuZHMgZnJvbSAnLi9jb21tYW5kcy9pbmRleCc7XG5pbXBvcnQgeyBQT1dFUl9TSEVMTF9GRUFUVVJFIH0gZnJvbSAnY29uc3RhbnRzJztcblxuY29uc3QgTk9fUFJPWFkgPSBbXG4gIFsnR0VUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL2FwcGl1bS8oPyFhcHAvKVteL10rJyldLFxuICBbJ1BPU1QnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvYXBwaXVtLyg/IWFwcC8pW14vXSsnKV0sXG4gIFsnUE9TVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9lbGVtZW50L1teL10rL2VsZW1lbnRzPyQnKV0sXG4gIFsnUE9TVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9lbGVtZW50cz8kJyldLFxuICBbJ1BPU1QnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvZXhlY3V0ZScpXSxcbiAgWydQT1NUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL2V4ZWN1dGUvc3luYycpXSxcbiAgWydQT1NUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL2FwcGl1bS9kZXZpY2UvcHVzaF9maWxlJyldLFxuICBbJ1BPU1QnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvYXBwaXVtL2RldmljZS9wdWxsX2ZpbGUnKV0sXG4gIFsnUE9TVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9hcHBpdW0vZGV2aWNlL3B1bGxfZm9sZGVyJyldLFxuXTtcblxuLy8gQXBwaXVtIGluc3RhbnRpYXRlcyB0aGlzIGNsYXNzXG5jbGFzcyBXaW5kb3dzRHJpdmVyIGV4dGVuZHMgQmFzZURyaXZlciB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30sIHNob3VsZFZhbGlkYXRlQ2FwcyA9IHRydWUpIHtcbiAgICBzdXBlcihvcHRzLCBzaG91bGRWYWxpZGF0ZUNhcHMpO1xuICAgIHRoaXMuZGVzaXJlZENhcENvbnN0cmFpbnRzID0gZGVzaXJlZENhcENvbnN0cmFpbnRzO1xuICAgIHRoaXMubG9jYXRvclN0cmF0ZWdpZXMgPSBbXG4gICAgICAneHBhdGgnLFxuICAgICAgJ2lkJyxcbiAgICAgICduYW1lJyxcbiAgICAgICdjbGFzcyBuYW1lJyxcbiAgICAgICdhY2Nlc3NpYmlsaXR5IGlkJyxcbiAgICBdO1xuICAgIHRoaXMucmVzZXRTdGF0ZSgpO1xuXG4gICAgZm9yIChjb25zdCBbY21kLCBmbl0gb2YgXy50b1BhaXJzKGNvbW1hbmRzKSkge1xuICAgICAgV2luZG93c0RyaXZlci5wcm90b3R5cGVbY21kXSA9IGZuO1xuICAgIH1cbiAgfVxuXG4gIHJlc2V0U3RhdGUgKCkge1xuICAgIHRoaXMuandwUHJveHlBdm9pZCA9IE5PX1BST1hZO1xuICAgIHRoaXMuaXNQcm94eUFjdGl2ZSA9IGZhbHNlO1xuICAgIHRoaXMud2luQXBwRHJpdmVyID0gbnVsbDtcbiAgICB0aGlzLl9zY3JlZW5SZWNvcmRlciA9IG51bGw7XG4gIH1cblxuICBhc3luYyBjcmVhdGVTZXNzaW9uICguLi5hcmdzKSB7XG4gICAgaWYgKCFzeXN0ZW0uaXNXaW5kb3dzKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignV2luQXBwRHJpdmVyIHRlc3RzIG9ubHkgcnVuIG9uIFdpbmRvd3MnKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgW3Nlc3Npb25JZCwgY2Fwc10gPSBhd2FpdCBzdXBlci5jcmVhdGVTZXNzaW9uKC4uLmFyZ3MpO1xuICAgICAgaWYgKGNhcHMucHJlcnVuKSB7XG4gICAgICAgIGxvZy5pbmZvKCdFeGVjdXRpbmcgcHJlcnVuIFBvd2VyU2hlbGwgc2NyaXB0Jyk7XG4gICAgICAgIGlmICghXy5pc1N0cmluZyhjYXBzLnByZXJ1bi5jb21tYW5kKSAmJiAhXy5pc1N0cmluZyhjYXBzLnByZXJ1bi5zY3JpcHQpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAncHJlcnVuJyBjYXBhYmlsaXR5IHZhbHVlIG11c3QgZWl0aGVyIGNvbnRhaW4gYCArXG4gICAgICAgICAgICBgJ3NjcmlwdCcgb3IgJ2NvbW1hbmQnIGVudHJ5IG9mIHN0cmluZyB0eXBlYCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5lbnN1cmVGZWF0dXJlRW5hYmxlZChQT1dFUl9TSEVMTF9GRUFUVVJFKTtcbiAgICAgICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgdGhpcy5leGVjUG93ZXJTaGVsbChjYXBzLnByZXJ1bik7XG4gICAgICAgIGlmIChvdXRwdXQpIHtcbiAgICAgICAgICBsb2cuaW5mbyhgUHJlcnVuIHNjcmlwdCBvdXRwdXQ6ICR7b3V0cHV0fWApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0V2luQXBwRHJpdmVyU2Vzc2lvbigpO1xuICAgICAgcmV0dXJuIFtzZXNzaW9uSWQsIGNhcHNdO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzdGFydFdpbkFwcERyaXZlclNlc3Npb24gKCkge1xuICAgIHRoaXMud2luQXBwRHJpdmVyID0gbmV3IFdpbkFwcERyaXZlcih7XG4gICAgICBwb3J0OiB0aGlzLm9wdHMuc3lzdGVtUG9ydCxcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLndpbkFwcERyaXZlci5zdGFydCh0aGlzLmNhcHMpO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLndpbkFwcERyaXZlci5wcm94eS5wcm94eVJlcVJlcy5iaW5kKHRoaXMud2luQXBwRHJpdmVyLnByb3h5KTtcbiAgICAvLyBub3cgdGhhdCBldmVyeXRoaW5nIGhhcyBzdGFydGVkIHN1Y2Nlc3NmdWxseSwgdHVybiBvbiBwcm94eWluZyBzbyBhbGxcbiAgICAvLyBzdWJzZXF1ZW50IHNlc3Npb24gcmVxdWVzdHMgZ28gc3RyYWlnaHQgdG8vZnJvbSBXaW5BcHBEcml2ZXJcbiAgICB0aGlzLmlzUHJveHlBY3RpdmUgPSB0cnVlO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgbG9nLmRlYnVnKCdEZWxldGluZyBXaW5BcHBEcml2ZXIgc2Vzc2lvbicpO1xuICAgIGF3YWl0IHRoaXMuX3NjcmVlblJlY29yZGVyPy5zdG9wKHRydWUpO1xuICAgIGF3YWl0IHRoaXMud2luQXBwRHJpdmVyPy5zdG9wKCk7XG5cbiAgICBpZiAodGhpcy5vcHRzLnBvc3RydW4pIHtcbiAgICAgIGlmICghXy5pc1N0cmluZyh0aGlzLm9wdHMucG9zdHJ1bi5jb21tYW5kKSAmJiAhXy5pc1N0cmluZyh0aGlzLm9wdHMucG9zdHJ1bi5zY3JpcHQpKSB7XG4gICAgICAgIGxvZy5lcnJvcihgJ3Bvc3RydW4nIGNhcGFiaWxpdHkgdmFsdWUgbXVzdCBlaXRoZXIgY29udGFpbiBgICtcbiAgICAgICAgICBgJ3NjcmlwdCcgb3IgJ2NvbW1hbmQnIGVudHJ5IG9mIHN0cmluZyB0eXBlYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuaW5mbygnRXhlY3V0aW5nIHBvc3RydW4gUG93ZXJTaGVsbCBzY3JpcHQnKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICB0aGlzLmVuc3VyZUZlYXR1cmVFbmFibGVkKFBPV0VSX1NIRUxMX0ZFQVRVUkUpO1xuICAgICAgICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHRoaXMuZXhlY1Bvd2VyU2hlbGwodGhpcy5vcHRzLnBvc3RydW4pO1xuICAgICAgICAgIGlmIChvdXRwdXQpIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKGBQb3N0cnVuIHNjcmlwdCBvdXRwdXQ6ICR7b3V0cHV0fWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIGxvZy5lcnJvcihlLm1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5yZXNldFN0YXRlKCk7XG5cbiAgICBhd2FpdCBzdXBlci5kZWxldGVTZXNzaW9uKCk7XG4gIH1cblxuICBwcm94eUFjdGl2ZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuaXNQcm94eUFjdGl2ZTtcbiAgfVxuXG4gIGNhblByb3h5ICgpIHtcbiAgICAvLyB3ZSBjYW4gYWx3YXlzIHByb3h5IHRvIHRoZSBXaW5BcHBEcml2ZXIgc2VydmVyXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBnZXRQcm94eUF2b2lkTGlzdCAoLypzZXNzaW9uSWQqLykge1xuICAgIHJldHVybiB0aGlzLmp3cFByb3h5QXZvaWQ7XG4gIH1cbn1cblxuZXhwb3J0IHsgV2luZG93c0RyaXZlciB9O1xuZXhwb3J0IGRlZmF1bHQgV2luZG93c0RyaXZlcjtcbiJdLCJmaWxlIjoibGliL2RyaXZlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
