"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _teen_process = require("teen_process");

var _bluebird = _interopRequireDefault(require("bluebird"));

const commands = {};
const RETRY_PAUSE = 300;
const RETRY_TIMEOUT = 5000;
const DEFAULT_TIME_LIMIT = 60 * 10;
const PROCESS_SHUTDOWN_TIMEOUT = 10 * 1000;
const DEFAULT_EXT = 'mp4';
const FFMPEG_BINARY = `ffmpeg${_appiumSupport.system.isWindows() ? '.exe' : ''}`;
const DEFAULT_FPS = 15;
const DEFAULT_PRESET = 'veryfast';

async function uploadRecordedMedia(localFile, remotePath = null, uploadOptions = {}) {
  if (_lodash.default.isEmpty(remotePath)) {
    const {
      size
    } = await _appiumSupport.fs.stat(localFile);

    _logger.default.debug(`The size of the resulting screen recording is ${_appiumSupport.util.toReadableSizeString(size)}`);

    return (await _appiumSupport.util.toInMemoryBase64(localFile)).toString();
  }

  const {
    user,
    pass,
    method,
    headers,
    fileFieldName,
    formFields
  } = uploadOptions;
  const options = {
    method: method || 'PUT',
    headers,
    fileFieldName,
    formFields
  };

  if (user && pass) {
    options.auth = {
      user,
      pass
    };
  }

  await _appiumSupport.net.uploadFile(localFile, remotePath, options);
  return '';
}

async function requireFfmpegPath() {
  try {
    return await _appiumSupport.fs.which(FFMPEG_BINARY);
  } catch (e) {
    _logger.default.errorAndThrow(`${FFMPEG_BINARY} has not been found in PATH. ` + `Please make sure it is installed`);
  }
}

class ScreenRecorder {
  constructor(videoPath, opts = {}) {
    this._videoPath = videoPath;
    this._process = null;
    this._fps = opts.fps && opts.fps > 0 ? opts.fps : DEFAULT_FPS;
    this._audioInput = opts.audioInput;
    this._captureCursor = opts.captureCursor;
    this._captureClicks = opts.captureClicks;
    this._preset = opts.preset || DEFAULT_PRESET;
    this._videoFilter = opts.videoFilter;
    this._timeLimit = opts.timeLimit && opts.timeLimit > 0 ? opts.timeLimit : DEFAULT_TIME_LIMIT;
  }

  async getVideoPath() {
    return (await _appiumSupport.fs.exists(this._videoPath)) ? this._videoPath : '';
  }

  isRunning() {
    var _this$_process;

    return !!((_this$_process = this._process) !== null && _this$_process !== void 0 && _this$_process.isRunning);
  }

  async _enforceTermination() {
    if (this._process && this.isRunning()) {
      _logger.default.debug('Force-stopping the currently running video recording');

      try {
        await this._process.stop('SIGKILL');
      } catch (ign) {}
    }

    this._process = null;
    const videoPath = await this.getVideoPath();

    if (videoPath) {
      await _appiumSupport.fs.rimraf(videoPath);
    }

    return '';
  }

  async start() {
    const ffmpeg = await requireFfmpegPath();
    const args = ['-loglevel', 'error', '-t', `${this._timeLimit}`, '-f', 'gdigrab', ...(this._captureCursor ? ['-capture_cursor', '1'] : []), ...(this._captureClicks ? ['-capture_mouse_clicks', '1'] : []), '-framerate', `${this._fps}`, '-i', 'desktop', ...(this._audioInput ? ['-f', 'dshow', '-i', `audio=${this._audioInput}`] : []), '-vcodec', 'libx264', '-preset', this._preset, '-tune', 'zerolatency', '-pix_fmt', 'yuv420p', '-movflags', '+faststart', '-fflags', 'nobuffer', '-f', DEFAULT_EXT, '-r', `${this._fps}`, ...(this._videoFilter ? ['-filter:v', this._videoFilter] : [])];
    const fullCmd = [ffmpeg, ...args, this._videoPath];
    this._process = new _teen_process.SubProcess(fullCmd[0], fullCmd.slice(1), {
      windowsHide: true
    });

    _logger.default.debug(`Starting ${FFMPEG_BINARY}: ${_appiumSupport.util.quote(fullCmd)}`);

    this._process.on('output', (stdout, stderr) => {
      if (_lodash.default.trim(stdout || stderr)) {
        _logger.default.debug(`[${FFMPEG_BINARY}] ${stdout || stderr}`);
      }
    });

    this._process.once('exit', async (code, signal) => {
      this._process = null;

      if (code === 0) {
        _logger.default.debug('Screen recording exited without errors');
      } else {
        await this._enforceTermination();

        _logger.default.warn(`Screen recording exited with error code ${code}, signal ${signal}`);
      }
    });

    await this._process.start(0);

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        if (await this.getVideoPath()) {
          return true;
        }

        if (!this._process) {
          throw new Error(`${FFMPEG_BINARY} process died unexpectedly`);
        }

        return false;
      }, {
        waitMs: RETRY_TIMEOUT,
        intervalMs: RETRY_PAUSE
      });
    } catch (e) {
      await this._enforceTermination();

      _logger.default.errorAndThrow(`The expected screen record file '${this._videoPath}' does not exist. ` + `Check the server log for more details`);
    }

    _logger.default.info(`The video recording has started. Will timeout in ${_appiumSupport.util.pluralize('second', this._timeLimit, true)}`);
  }

  async stop(force = false) {
    if (force) {
      return await this._enforceTermination();
    }

    if (!this.isRunning()) {
      _logger.default.debug('Screen recording is not running. Returning the recent result');

      return await this.getVideoPath();
    }

    return new _bluebird.default((resolve, reject) => {
      const timer = setTimeout(async () => {
        await this._enforceTermination();
        reject(new Error(`Screen recording has failed to exit after ${PROCESS_SHUTDOWN_TIMEOUT}ms`));
      }, PROCESS_SHUTDOWN_TIMEOUT);

      this._process.once('exit', async (code, signal) => {
        clearTimeout(timer);

        if (code === 0) {
          resolve(await this.getVideoPath());
        } else {
          reject(new Error(`Screen recording exited with error code ${code}, signal ${signal}`));
        }
      });

      this._process.proc.stdin.write('q');

      this._process.proc.stdin.end();
    });
  }

}

commands.startRecordingScreen = async function startRecordingScreen(options = {}) {
  var _this$_screenRecorder, _this$_screenRecorder2;

  const {
    timeLimit,
    videoFilter,
    fps,
    preset,
    captureCursor,
    captureClicks,
    audioInput,
    forceRestart = true
  } = options;

  if ((_this$_screenRecorder = this._screenRecorder) !== null && _this$_screenRecorder !== void 0 && (_this$_screenRecorder2 = _this$_screenRecorder.isRunning) !== null && _this$_screenRecorder2 !== void 0 && _this$_screenRecorder2.call(_this$_screenRecorder)) {
    _logger.default.debug('The screen recording is already running');

    if (!forceRestart) {
      _logger.default.debug('Doing nothing');

      return;
    }

    _logger.default.debug('Forcing the active screen recording to stop');

    await this._screenRecorder.stop(true);
  }

  this._screenRecorder = null;
  const videoPath = await _appiumSupport.tempDir.path({
    prefix: _appiumSupport.util.uuidV4().substring(0, 8),
    suffix: `.${DEFAULT_EXT}`
  });
  this._screenRecorder = new ScreenRecorder(videoPath, {
    fps: parseInt(fps, 10),
    timeLimit: parseInt(timeLimit, 10),
    preset,
    captureCursor,
    captureClicks,
    videoFilter,
    audioInput
  });

  try {
    await this._screenRecorder.start();
  } catch (e) {
    this._screenRecorder = null;
    throw e;
  }
};

commands.stopRecordingScreen = async function stopRecordingScreen(options = {}) {
  if (!this._screenRecorder) {
    _logger.default.debug('No screen recording has been started. Doing nothing');

    return '';
  }

  _logger.default.debug('Retrieving the resulting video data');

  const videoPath = await this._screenRecorder.stop();

  if (!videoPath) {
    _logger.default.debug('No video data is found. Returning an empty string');

    return '';
  }

  return await uploadRecordedMedia(videoPath, options.remotePath, options);
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9yZWNvcmQtc2NyZWVuLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiUkVUUllfUEFVU0UiLCJSRVRSWV9USU1FT1VUIiwiREVGQVVMVF9USU1FX0xJTUlUIiwiUFJPQ0VTU19TSFVURE9XTl9USU1FT1VUIiwiREVGQVVMVF9FWFQiLCJGRk1QRUdfQklOQVJZIiwic3lzdGVtIiwiaXNXaW5kb3dzIiwiREVGQVVMVF9GUFMiLCJERUZBVUxUX1BSRVNFVCIsInVwbG9hZFJlY29yZGVkTWVkaWEiLCJsb2NhbEZpbGUiLCJyZW1vdGVQYXRoIiwidXBsb2FkT3B0aW9ucyIsIl8iLCJpc0VtcHR5Iiwic2l6ZSIsImZzIiwic3RhdCIsImxvZyIsImRlYnVnIiwidXRpbCIsInRvUmVhZGFibGVTaXplU3RyaW5nIiwidG9Jbk1lbW9yeUJhc2U2NCIsInRvU3RyaW5nIiwidXNlciIsInBhc3MiLCJtZXRob2QiLCJoZWFkZXJzIiwiZmlsZUZpZWxkTmFtZSIsImZvcm1GaWVsZHMiLCJvcHRpb25zIiwiYXV0aCIsIm5ldCIsInVwbG9hZEZpbGUiLCJyZXF1aXJlRmZtcGVnUGF0aCIsIndoaWNoIiwiZSIsImVycm9yQW5kVGhyb3ciLCJTY3JlZW5SZWNvcmRlciIsImNvbnN0cnVjdG9yIiwidmlkZW9QYXRoIiwib3B0cyIsIl92aWRlb1BhdGgiLCJfcHJvY2VzcyIsIl9mcHMiLCJmcHMiLCJfYXVkaW9JbnB1dCIsImF1ZGlvSW5wdXQiLCJfY2FwdHVyZUN1cnNvciIsImNhcHR1cmVDdXJzb3IiLCJfY2FwdHVyZUNsaWNrcyIsImNhcHR1cmVDbGlja3MiLCJfcHJlc2V0IiwicHJlc2V0IiwiX3ZpZGVvRmlsdGVyIiwidmlkZW9GaWx0ZXIiLCJfdGltZUxpbWl0IiwidGltZUxpbWl0IiwiZ2V0VmlkZW9QYXRoIiwiZXhpc3RzIiwiaXNSdW5uaW5nIiwiX2VuZm9yY2VUZXJtaW5hdGlvbiIsInN0b3AiLCJpZ24iLCJyaW1yYWYiLCJzdGFydCIsImZmbXBlZyIsImFyZ3MiLCJmdWxsQ21kIiwiU3ViUHJvY2VzcyIsInNsaWNlIiwid2luZG93c0hpZGUiLCJxdW90ZSIsIm9uIiwic3Rkb3V0Iiwic3RkZXJyIiwidHJpbSIsIm9uY2UiLCJjb2RlIiwic2lnbmFsIiwid2FybiIsIkVycm9yIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImluZm8iLCJwbHVyYWxpemUiLCJmb3JjZSIsIkIiLCJyZXNvbHZlIiwicmVqZWN0IiwidGltZXIiLCJzZXRUaW1lb3V0IiwiY2xlYXJUaW1lb3V0IiwicHJvYyIsInN0ZGluIiwid3JpdGUiLCJlbmQiLCJzdGFydFJlY29yZGluZ1NjcmVlbiIsImZvcmNlUmVzdGFydCIsIl9zY3JlZW5SZWNvcmRlciIsInRlbXBEaXIiLCJwYXRoIiwicHJlZml4IiwidXVpZFY0Iiwic3Vic3RyaW5nIiwic3VmZml4IiwicGFyc2VJbnQiLCJzdG9wUmVjb3JkaW5nU2NyZWVuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLFFBQVEsR0FBRyxFQUFqQjtBQUVBLE1BQU1DLFdBQVcsR0FBRyxHQUFwQjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxJQUF0QjtBQUNBLE1BQU1DLGtCQUFrQixHQUFHLEtBQUssRUFBaEM7QUFDQSxNQUFNQyx3QkFBd0IsR0FBRyxLQUFLLElBQXRDO0FBQ0EsTUFBTUMsV0FBVyxHQUFHLEtBQXBCO0FBQ0EsTUFBTUMsYUFBYSxHQUFJLFNBQVFDLHNCQUFPQyxTQUFQLEtBQXFCLE1BQXJCLEdBQThCLEVBQUcsRUFBaEU7QUFDQSxNQUFNQyxXQUFXLEdBQUcsRUFBcEI7QUFDQSxNQUFNQyxjQUFjLEdBQUcsVUFBdkI7O0FBR0EsZUFBZUMsbUJBQWYsQ0FBb0NDLFNBQXBDLEVBQStDQyxVQUFVLEdBQUcsSUFBNUQsRUFBa0VDLGFBQWEsR0FBRyxFQUFsRixFQUFzRjtBQUNwRixNQUFJQyxnQkFBRUMsT0FBRixDQUFVSCxVQUFWLENBQUosRUFBMkI7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QUNBLFdBQU8sRUFBUDtBQUNEOztBQUVERCxrQkFBSUMsS0FBSixDQUFVLHFDQUFWOztBQUNBLFFBQU1xQixTQUFTLEdBQUcsTUFBTSxLQUFLMkQsZUFBTCxDQUFxQnJDLElBQXJCLEVBQXhCOztBQUNBLE1BQUksQ0FBQ3RCLFNBQUwsRUFBZ0I7QUFDZHRCLG9CQUFJQyxLQUFKLENBQVUsbURBQVY7O0FBQ0EsV0FBTyxFQUFQO0FBQ0Q7O0FBQ0QsU0FBTyxNQUFNVixtQkFBbUIsQ0FBQytCLFNBQUQsRUFBWVYsT0FBTyxDQUFDbkIsVUFBcEIsRUFBZ0NtQixPQUFoQyxDQUFoQztBQUNELENBYkQ7O2VBZWVoQyxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHdhaXRGb3JDb25kaXRpb24gfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyB1dGlsLCBmcywgbmV0LCBzeXN0ZW0sIHRlbXBEaXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBTdWJQcm9jZXNzIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuY29uc3QgY29tbWFuZHMgPSB7fTtcblxuY29uc3QgUkVUUllfUEFVU0UgPSAzMDA7XG5jb25zdCBSRVRSWV9USU1FT1VUID0gNTAwMDtcbmNvbnN0IERFRkFVTFRfVElNRV9MSU1JVCA9IDYwICogMTA7IC8vIDEwIG1pbnV0ZXNcbmNvbnN0IFBST0NFU1NfU0hVVERPV05fVElNRU9VVCA9IDEwICogMTAwMDtcbmNvbnN0IERFRkFVTFRfRVhUID0gJ21wNCc7XG5jb25zdCBGRk1QRUdfQklOQVJZID0gYGZmbXBlZyR7c3lzdGVtLmlzV2luZG93cygpID8gJy5leGUnIDogJyd9YDtcbmNvbnN0IERFRkFVTFRfRlBTID0gMTU7XG5jb25zdCBERUZBVUxUX1BSRVNFVCA9ICd2ZXJ5ZmFzdCc7XG5cblxuYXN5bmMgZnVuY3Rpb24gdXBsb2FkUmVjb3JkZWRNZWRpYSAobG9jYWxGaWxlLCByZW1vdGVQYXRoID0gbnVsbCwgdXBsb2FkT3B0aW9ucyA9IHt9KSB7XG4gIGlmIChfLmlzRW1wdHkocmVtb3RlUGF0aCkpIHtcbiAgICBjb25zdCB7c2l6ZX0gPSBhd2FpdCBmcy5zdGF0KGxvY2FsRmlsZSk7XG4gICAgbG9nLmRlYnVnKGBUaGUgc2l6ZSBvZiB0aGUgcmVzdWx0aW5nIHNjcmVlbiByZWNvcmRpbmcgaXMgJHt1dGlsLnRvUmVhZGFibGVTaXplU3RyaW5nKHNpemUpfWApO1xuICAgIHJldHVybiAoYXdhaXQgdXRpbC50b0luTWVtb3J5QmFzZTY0KGxvY2FsRmlsZSkpLnRvU3RyaW5nKCk7XG4gIH1cblxuICBjb25zdCB7dXNlciwgcGFzcywgbWV0aG9kLCBoZWFkZXJzLCBmaWxlRmllbGROYW1lLCBmb3JtRmllbGRzfSA9IHVwbG9hZE9wdGlvbnM7XG4gIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgbWV0aG9kOiBtZXRob2QgfHwgJ1BVVCcsXG4gICAgaGVhZGVycyxcbiAgICBmaWxlRmllbGROYW1lLFxuICAgIGZvcm1GaWVsZHMsXG4gIH07XG4gIGlmICh1c2VyICYmIHBhc3MpIHtcbiAgICBvcHRpb25zLmF1dGggPSB7dXNlciwgcGFzc307XG4gIH1cbiAgYXdhaXQgbmV0LnVwbG9hZEZpbGUobG9jYWxGaWxlLCByZW1vdGVQYXRoLCBvcHRpb25zKTtcbiAgcmV0dXJuICcnO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXF1aXJlRmZtcGVnUGF0aCAoKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IGZzLndoaWNoKEZGTVBFR19CSU5BUlkpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYCR7RkZNUEVHX0JJTkFSWX0gaGFzIG5vdCBiZWVuIGZvdW5kIGluIFBBVEguIGAgK1xuICAgICAgYFBsZWFzZSBtYWtlIHN1cmUgaXQgaXMgaW5zdGFsbGVkYCk7XG4gIH1cbn1cblxuY2xhc3MgU2NyZWVuUmVjb3JkZXIge1xuICBjb25zdHJ1Y3RvciAodmlkZW9QYXRoLCBvcHRzID0ge30pIHtcbiAgICB0aGlzLl92aWRlb1BhdGggPSB2aWRlb1BhdGg7XG4gICAgdGhpcy5fcHJvY2VzcyA9IG51bGw7XG4gICAgdGhpcy5fZnBzID0gKG9wdHMuZnBzICYmIG9wdHMuZnBzID4gMCkgPyBvcHRzLmZwcyA6IERFRkFVTFRfRlBTO1xuICAgIHRoaXMuX2F1ZGlvSW5wdXQgPSBvcHRzLmF1ZGlvSW5wdXQ7XG4gICAgdGhpcy5fY2FwdHVyZUN1cnNvciA9IG9wdHMuY2FwdHVyZUN1cnNvcjtcbiAgICB0aGlzLl9jYXB0dXJlQ2xpY2tzID0gb3B0cy5jYXB0dXJlQ2xpY2tzO1xuICAgIHRoaXMuX3ByZXNldCA9IG9wdHMucHJlc2V0IHx8IERFRkFVTFRfUFJFU0VUO1xuICAgIHRoaXMuX3ZpZGVvRmlsdGVyID0gb3B0cy52aWRlb0ZpbHRlcjtcbiAgICB0aGlzLl90aW1lTGltaXQgPSAob3B0cy50aW1lTGltaXQgJiYgb3B0cy50aW1lTGltaXQgPiAwKVxuICAgICAgPyBvcHRzLnRpbWVMaW1pdFxuICAgICAgOiBERUZBVUxUX1RJTUVfTElNSVQ7XG4gIH1cblxuICBhc3luYyBnZXRWaWRlb1BhdGggKCkge1xuICAgIHJldHVybiAoYXdhaXQgZnMuZXhpc3RzKHRoaXMuX3ZpZGVvUGF0aCkpID8gdGhpcy5fdmlkZW9QYXRoIDogJyc7XG4gIH1cblxuICBpc1J1bm5pbmcgKCkge1xuICAgIHJldHVybiAhISh0aGlzLl9wcm9jZXNzPy5pc1J1bm5pbmcpO1xuICB9XG5cbiAgYXN5bmMgX2VuZm9yY2VUZXJtaW5hdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMuX3Byb2Nlc3MgJiYgdGhpcy5pc1J1bm5pbmcoKSkge1xuICAgICAgbG9nLmRlYnVnKCdGb3JjZS1zdG9wcGluZyB0aGUgY3VycmVudGx5IHJ1bm5pbmcgdmlkZW8gcmVjb3JkaW5nJyk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLl9wcm9jZXNzLnN0b3AoJ1NJR0tJTEwnKTtcbiAgICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICB9XG4gICAgdGhpcy5fcHJvY2VzcyA9IG51bGw7XG4gICAgY29uc3QgdmlkZW9QYXRoID0gYXdhaXQgdGhpcy5nZXRWaWRlb1BhdGgoKTtcbiAgICBpZiAodmlkZW9QYXRoKSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYodmlkZW9QYXRoKTtcbiAgICB9XG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKCkge1xuICAgIGNvbnN0IGZmbXBlZyA9IGF3YWl0IHJlcXVpcmVGZm1wZWdQYXRoKCk7XG5cbiAgICBjb25zdCBhcmdzID0gW1xuICAgICAgJy1sb2dsZXZlbCcsICdlcnJvcicsXG4gICAgICAnLXQnLCBgJHt0aGlzLl90aW1lTGltaXR9YCxcbiAgICAgICctZicsICdnZGlncmFiJyxcbiAgICAgIC4uLih0aGlzLl9jYXB0dXJlQ3Vyc29yID8gWyctY2FwdHVyZV9jdXJzb3InLCAnMSddIDogW10pLFxuICAgICAgLi4uKHRoaXMuX2NhcHR1cmVDbGlja3MgPyBbJy1jYXB0dXJlX21vdXNlX2NsaWNrcycsICcxJ10gOiBbXSksXG4gICAgICAnLWZyYW1lcmF0ZScsIGAke3RoaXMuX2Zwc31gLFxuICAgICAgJy1pJywgJ2Rlc2t0b3AnLFxuICAgICAgLi4uKHRoaXMuX2F1ZGlvSW5wdXQgPyBbJy1mJywgJ2RzaG93JywgJy1pJywgYGF1ZGlvPSR7dGhpcy5fYXVkaW9JbnB1dH1gXSA6IFtdKSxcbiAgICAgICctdmNvZGVjJywgJ2xpYngyNjQnLFxuICAgICAgJy1wcmVzZXQnLCB0aGlzLl9wcmVzZXQsXG4gICAgICAnLXR1bmUnLCAnemVyb2xhdGVuY3knLFxuICAgICAgJy1waXhfZm10JywgJ3l1djQyMHAnLFxuICAgICAgJy1tb3ZmbGFncycsICcrZmFzdHN0YXJ0JyxcbiAgICAgICctZmZsYWdzJywgJ25vYnVmZmVyJyxcbiAgICAgICctZicsIERFRkFVTFRfRVhULFxuICAgICAgJy1yJywgYCR7dGhpcy5fZnBzfWAsXG4gICAgICAuLi4odGhpcy5fdmlkZW9GaWx0ZXIgPyBbJy1maWx0ZXI6dicsIHRoaXMuX3ZpZGVvRmlsdGVyXSA6IFtdKSxcbiAgICBdO1xuXG4gICAgY29uc3QgZnVsbENtZCA9IFtcbiAgICAgIGZmbXBlZyxcbiAgICAgIC4uLmFyZ3MsXG4gICAgICB0aGlzLl92aWRlb1BhdGgsXG4gICAgXTtcbiAgICB0aGlzLl9wcm9jZXNzID0gbmV3IFN1YlByb2Nlc3MoZnVsbENtZFswXSwgZnVsbENtZC5zbGljZSgxKSwge1xuICAgICAgd2luZG93c0hpZGU6IHRydWUsXG4gICAgfSk7XG4gICAgbG9nLmRlYnVnKGBTdGFydGluZyAke0ZGTVBFR19CSU5BUll9OiAke3V0aWwucXVvdGUoZnVsbENtZCl9YCk7XG4gICAgdGhpcy5fcHJvY2Vzcy5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICBpZiAoXy50cmltKHN0ZG91dCB8fCBzdGRlcnIpKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgWyR7RkZNUEVHX0JJTkFSWX1dICR7c3Rkb3V0IHx8IHN0ZGVycn1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLl9wcm9jZXNzLm9uY2UoJ2V4aXQnLCBhc3luYyAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICB0aGlzLl9wcm9jZXNzID0gbnVsbDtcbiAgICAgIGlmIChjb2RlID09PSAwKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnU2NyZWVuIHJlY29yZGluZyBleGl0ZWQgd2l0aG91dCBlcnJvcnMnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX2VuZm9yY2VUZXJtaW5hdGlvbigpO1xuICAgICAgICBsb2cud2FybihgU2NyZWVuIHJlY29yZGluZyBleGl0ZWQgd2l0aCBlcnJvciBjb2RlICR7Y29kZX0sIHNpZ25hbCAke3NpZ25hbH1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLl9wcm9jZXNzLnN0YXJ0KDApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgaWYgKGF3YWl0IHRoaXMuZ2V0VmlkZW9QYXRoKCkpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuX3Byb2Nlc3MpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7RkZNUEVHX0JJTkFSWX0gcHJvY2VzcyBkaWVkIHVuZXhwZWN0ZWRseWApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0sIHtcbiAgICAgICAgd2FpdE1zOiBSRVRSWV9USU1FT1VULFxuICAgICAgICBpbnRlcnZhbE1zOiBSRVRSWV9QQVVTRSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGF3YWl0IHRoaXMuX2VuZm9yY2VUZXJtaW5hdGlvbigpO1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSBleHBlY3RlZCBzY3JlZW4gcmVjb3JkIGZpbGUgJyR7dGhpcy5fdmlkZW9QYXRofScgZG9lcyBub3QgZXhpc3QuIGAgK1xuICAgICAgICBgQ2hlY2sgdGhlIHNlcnZlciBsb2cgZm9yIG1vcmUgZGV0YWlsc2ApO1xuICAgIH1cbiAgICBsb2cuaW5mbyhgVGhlIHZpZGVvIHJlY29yZGluZyBoYXMgc3RhcnRlZC4gV2lsbCB0aW1lb3V0IGluICR7dXRpbC5wbHVyYWxpemUoJ3NlY29uZCcsIHRoaXMuX3RpbWVMaW1pdCwgdHJ1ZSl9YCk7XG4gIH1cblxuICBhc3luYyBzdG9wIChmb3JjZSA9IGZhbHNlKSB7XG4gICAgaWYgKGZvcmNlKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZW5mb3JjZVRlcm1pbmF0aW9uKCk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmlzUnVubmluZygpKSB7XG4gICAgICBsb2cuZGVidWcoJ1NjcmVlbiByZWNvcmRpbmcgaXMgbm90IHJ1bm5pbmcuIFJldHVybmluZyB0aGUgcmVjZW50IHJlc3VsdCcpO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0VmlkZW9QYXRoKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IHRpbWVyID0gc2V0VGltZW91dChhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuX2VuZm9yY2VUZXJtaW5hdGlvbigpO1xuICAgICAgICByZWplY3QobmV3IEVycm9yKGBTY3JlZW4gcmVjb3JkaW5nIGhhcyBmYWlsZWQgdG8gZXhpdCBhZnRlciAke1BST0NFU1NfU0hVVERPV05fVElNRU9VVH1tc2ApKTtcbiAgICAgIH0sIFBST0NFU1NfU0hVVERPV05fVElNRU9VVCk7XG5cbiAgICAgIHRoaXMuX3Byb2Nlc3Mub25jZSgnZXhpdCcsIGFzeW5jIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgICAgaWYgKGNvZGUgPT09IDApIHtcbiAgICAgICAgICByZXNvbHZlKGF3YWl0IHRoaXMuZ2V0VmlkZW9QYXRoKCkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYFNjcmVlbiByZWNvcmRpbmcgZXhpdGVkIHdpdGggZXJyb3IgY29kZSAke2NvZGV9LCBzaWduYWwgJHtzaWduYWx9YCkpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5fcHJvY2Vzcy5wcm9jLnN0ZGluLndyaXRlKCdxJyk7XG4gICAgICB0aGlzLl9wcm9jZXNzLnByb2Muc3RkaW4uZW5kKCk7XG4gICAgfSk7XG4gIH1cbn1cblxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0YXJ0UmVjb3JkaW5nT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdmlkZW9GaWx0ZXIgLSBUaGUgdmlkZW8gZmlsdGVyIHNwZWMgdG8gYXBwbHkgZm9yIGZmbXBlZy5cbiAqIFNlZSBodHRwczovL3RyYWMuZmZtcGVnLm9yZy93aWtpL0ZpbHRlcmluZ0d1aWRlIGZvciBtb3JlIGRldGFpbHMgb24gdGhlIHBvc3NpYmxlIHZhbHVlcy5cbiAqIEV4YW1wbGU6IFNldCBpdCB0byBgc2NhbGU9aWZub3QoZ3RlKGl3XFwsMTAyNClcXCxpd1xcLDEwMjQpOi0yYCBpbiBvcmRlciB0byBsaW1pdCB0aGUgdmlkZW8gd2lkdGhcbiAqIHRvIDEwMjRweC4gVGhlIGhlaWdodCB3aWxsIGJlIGFkanVzdGVkIGF1dG9tYXRpY2FsbHkgdG8gbWF0Y2ggdGhlIGFjdHVhbCByYXRpby5cbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfHN0cmluZ30gZnBzIFsxNV0gLSBUaGUgY291bnQgb2YgZnJhbWVzIHBlciBzZWNvbmQgaW4gdGhlIHJlc3VsdGluZyB2aWRlby5cbiAqIFRoZSBncmVhdGVyIGZwcyBpdCBoYXMgdGhlIGJpZ2dlciBmaWxlIHNpemUgaXMuXG4gKiBAcHJvcGVydHkge3N0cmluZ30gcHJlc2V0IFt2ZXJ5ZmFzdF0gLSBPbmUgb2YgdGhlIHN1cHBvcnRlZCBlbmNvZGluZyBwcmVzZXRzLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOlxuICogLSB1bHRyYWZhc3RcbiAqIC0gc3VwZXJmYXN0XG4gKiAtIHZlcnlmYXN0XG4gKiAtIGZhc3RlclxuICogLSBmYXN0XG4gKiAtIG1lZGl1bVxuICogLSBzbG93XG4gKiAtIHNsb3dlclxuICogLSB2ZXJ5c2xvd1xuICogQSBwcmVzZXQgaXMgYSBjb2xsZWN0aW9uIG9mIG9wdGlvbnMgdGhhdCB3aWxsIHByb3ZpZGUgYSBjZXJ0YWluIGVuY29kaW5nIHNwZWVkIHRvIGNvbXByZXNzaW9uIHJhdGlvLlxuICogQSBzbG93ZXIgcHJlc2V0IHdpbGwgcHJvdmlkZSBiZXR0ZXIgY29tcHJlc3Npb24gKGNvbXByZXNzaW9uIGlzIHF1YWxpdHkgcGVyIGZpbGVzaXplKS5cbiAqIFRoaXMgbWVhbnMgdGhhdCwgZm9yIGV4YW1wbGUsIGlmIHlvdSB0YXJnZXQgYSBjZXJ0YWluIGZpbGUgc2l6ZSBvciBjb25zdGFudCBiaXQgcmF0ZSwgeW91IHdpbGwgYWNoaWV2ZSBiZXR0ZXJcbiAqIHF1YWxpdHkgd2l0aCBhIHNsb3dlciBwcmVzZXQuIFJlYWQgaHR0cHM6Ly90cmFjLmZmbXBlZy5vcmcvd2lraS9FbmNvZGUvSC4yNjQgZm9yIG1vcmUgZGV0YWlscy5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY2FwdHVyZUN1cnNvciBbZmFsc2VdIC0gV2hldGhlciB0byBjYXB0dXJlIHRoZSBtb3VzZSBjdXJzb3Igd2hpbGUgcmVjb3JkaW5nXG4gKiB0aGUgc2NyZWVuXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGNhcHR1cmVDbGlja3MgW2ZhbHNlXSAtIFdoZXRoZXIgdG8gY2FwdHVyZSBtb3VzZSBjbGlja3Mgd2hpbGUgcmVjb3JkaW5nIHRoZVxuICogc2NyZWVuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IGF1ZGlvSW5wdXQgLSBJZiBzZXQgdGhlbiB0aGUgZ2l2ZW4gYXVkaW8gaW5wdXQgd2lsbCBiZSB1c2VkIHRvIHJlY29yZCB0aGUgY29tcHV0ZXIgYXVkaW9cbiAqIGFsb25nIHdpdGggdGhlIGRlc2t0b3AgdmlkZW8uIFRoZSBsaXN0IG9mIGF2YWlsYWJsZSBkZXZpY2VzIGNvdWxkIGJlIHJldHJpZXZlZCB1c2luZ1xuICogYGZmbXBlZyAtbGlzdF9kZXZpY2VzIHRydWUgLWYgZHNob3cgLWkgZHVtbXlgIGNvbW1hbmQuXG4gKiBAcHJvcGVydHkge3N0cmluZ3xudW1iZXJ9IHRpbWVMaW1pdCBbNjAwXSAtIFRoZSBtYXhpbXVtIHJlY29yZGluZyB0aW1lLCBpbiBzZWNvbmRzLiBUaGUgZGVmYXVsdFxuICogdmFsdWUgaXMgNjAwIHNlY29uZHMgKDEwIG1pbnV0ZXMpLlxuICogQHByb3BlcnR5IHtib29sZWFufSBmb3JjZVJlc3RhcnQgW3RydWVdIC0gV2hldGhlciB0byBpZ25vcmUgdGhlIGNhbGwgaWYgYSBzY3JlZW4gcmVjb3JkaW5nIGlzIGN1cnJlbnRseSBydW5uaW5nXG4gKiAoYGZhbHNlYCkgb3IgdG8gc3RhcnQgYSBuZXcgcmVjb3JkaW5nIGltbWVkaWF0ZWx5IGFuZCB0ZXJtaW5hdGUgdGhlIGV4aXN0aW5nIG9uZSBpZiBydW5uaW5nIChgdHJ1ZWApLlxuICovXG5cbi8qKlxuICogUmVjb3JkIHRoZSBkaXNwbGF5IGluIGJhY2tncm91bmQgd2hpbGUgdGhlIGF1dG9tYXRlZCB0ZXN0IGlzIHJ1bm5pbmcuXG4gKiBUaGlzIG1ldGhvZCByZXF1aXJlcyBGRk1QRUcgKGh0dHBzOi8vd3d3LmZmbXBlZy5vcmcvZG93bmxvYWQuaHRtbCkgdG8gYmUgaW5zdGFsbGVkXG4gKiBhbmQgcHJlc2VudCBpbiBQQVRILlxuICogVGhlIHJlc3VsdGluZyB2aWRlbyB1c2VzIEgyNjQgY29kZWMgYW5kIGlzIHJlYWR5IHRvIGJlIHBsYXllZCBieSBtZWRpYSBwbGF5ZXJzIGJ1aWx0LWluIGludG8gd2ViIGJyb3dzZXJzLlxuICpcbiAqIEBwYXJhbSB7P1N0YXJ0UmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzY3JlZW4gcmVjb3JkaW5nIGhhcyBmYWlsZWQgdG8gc3RhcnQgb3IgaXMgbm90IHN1cHBvcnRlZCBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKi9cbmNvbW1hbmRzLnN0YXJ0UmVjb3JkaW5nU2NyZWVuID0gYXN5bmMgZnVuY3Rpb24gc3RhcnRSZWNvcmRpbmdTY3JlZW4gKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgdGltZUxpbWl0LFxuICAgIHZpZGVvRmlsdGVyLFxuICAgIGZwcyxcbiAgICBwcmVzZXQsXG4gICAgY2FwdHVyZUN1cnNvcixcbiAgICBjYXB0dXJlQ2xpY2tzLFxuICAgIGF1ZGlvSW5wdXQsXG4gICAgZm9yY2VSZXN0YXJ0ID0gdHJ1ZSxcbiAgfSA9IG9wdGlvbnM7XG4gIGlmICh0aGlzLl9zY3JlZW5SZWNvcmRlcj8uaXNSdW5uaW5nPy4oKSkge1xuICAgIGxvZy5kZWJ1ZygnVGhlIHNjcmVlbiByZWNvcmRpbmcgaXMgYWxyZWFkeSBydW5uaW5nJyk7XG4gICAgaWYgKCFmb3JjZVJlc3RhcnQpIHtcbiAgICAgIGxvZy5kZWJ1ZygnRG9pbmcgbm90aGluZycpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsb2cuZGVidWcoJ0ZvcmNpbmcgdGhlIGFjdGl2ZSBzY3JlZW4gcmVjb3JkaW5nIHRvIHN0b3AnKTtcbiAgICBhd2FpdCB0aGlzLl9zY3JlZW5SZWNvcmRlci5zdG9wKHRydWUpO1xuICB9XG4gIHRoaXMuX3NjcmVlblJlY29yZGVyID0gbnVsbDtcblxuICBjb25zdCB2aWRlb1BhdGggPSBhd2FpdCB0ZW1wRGlyLnBhdGgoe1xuICAgIHByZWZpeDogdXRpbC51dWlkVjQoKS5zdWJzdHJpbmcoMCwgOCksXG4gICAgc3VmZml4OiBgLiR7REVGQVVMVF9FWFR9YCxcbiAgfSk7XG4gIHRoaXMuX3NjcmVlblJlY29yZGVyID0gbmV3IFNjcmVlblJlY29yZGVyKHZpZGVvUGF0aCwge1xuICAgIGZwczogcGFyc2VJbnQoZnBzLCAxMCksXG4gICAgdGltZUxpbWl0OiBwYXJzZUludCh0aW1lTGltaXQsIDEwKSxcbiAgICBwcmVzZXQsXG4gICAgY2FwdHVyZUN1cnNvcixcbiAgICBjYXB0dXJlQ2xpY2tzLFxuICAgIHZpZGVvRmlsdGVyLFxuICAgIGF1ZGlvSW5wdXQsXG4gIH0pO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuX3NjcmVlblJlY29yZGVyLnN0YXJ0KCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aGlzLl9zY3JlZW5SZWNvcmRlciA9IG51bGw7XG4gICAgdGhyb3cgZTtcbiAgfVxufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTdG9wUmVjb3JkaW5nT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIHRoZSByZW1vdGUgbG9jYXRpb24sIHdoZXJlIHRoZSByZXN1bHRpbmcgdmlkZW8gc2hvdWxkIGJlIHVwbG9hZGVkLlxuICogVGhlIGZvbGxvd2luZyBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZDogaHR0cC9odHRwcywgZnRwLlxuICogTnVsbCBvciBlbXB0eSBzdHJpbmcgdmFsdWUgKHRoZSBkZWZhdWx0IHNldHRpbmcpIG1lYW5zIHRoZSBjb250ZW50IG9mIHJlc3VsdGluZ1xuICogZmlsZSBzaG91bGQgYmUgZW5jb2RlZCBhcyBCYXNlNjQgYW5kIHBhc3NlZCBhcyB0aGUgZW5kcG9pbnQgcmVzcG9uc2UgdmFsdWUuXG4gKiBBbiBleGNlcHRpb24gd2lsbCBiZSB0aHJvd24gaWYgdGhlIGdlbmVyYXRlZCBtZWRpYSBmaWxlIGlzIHRvbyBiaWcgdG9cbiAqIGZpdCBpbnRvIHRoZSBhdmFpbGFibGUgcHJvY2VzcyBtZW1vcnkuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHVzZXIgLSBUaGUgbmFtZSBvZiB0aGUgdXNlciBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGFzcyAtIFRoZSBwYXNzd29yZCBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gbWV0aG9kIC0gVGhlIGh0dHAgbXVsdGlwYXJ0IHVwbG9hZCBtZXRob2QgbmFtZS4gVGhlICdQVVQnIG9uZSBpcyB1c2VkIGJ5IGRlZmF1bHQuXG4gKiBAcHJvcGVydHkgez9PYmplY3R9IGhlYWRlcnMgLSBBZGRpdGlvbmFsIGhlYWRlcnMgbWFwcGluZyBmb3IgbXVsdGlwYXJ0IGh0dHAocykgdXBsb2Fkc1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSBmaWxlRmllbGROYW1lIFtmaWxlXSAtIFRoZSBuYW1lIG9mIHRoZSBmb3JtIGZpZWxkLCB3aGVyZSB0aGUgZmlsZSBjb250ZW50IEJMT0Igc2hvdWxkIGJlIHN0b3JlZCBmb3JcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwKHMpIHVwbG9hZHNcbiAqIEBwcm9wZXJ0eSB7P09iamVjdHxBcnJheTxQYWlyPn0gZm9ybUZpZWxkcyAtIEFkZGl0aW9uYWwgZm9ybSBmaWVsZHMgZm9yIG11bHRpcGFydCBodHRwKHMpIHVwbG9hZHNcbiAqL1xuXG4vKipcbiAqIFN0b3AgcmVjb3JkaW5nIHRoZSBzY3JlZW4uXG4gKiBJZiBubyBzY3JlZW4gcmVjb3JkaW5nIGhhcyBiZWVuIHN0YXJ0ZWQgYmVmb3JlIHRoZW4gdGhlIG1ldGhvZCByZXR1cm5zIGFuIGVtcHR5IHN0cmluZy5cbiAqXG4gKiBAcGFyYW0gez9TdG9wUmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHJlY29yZGVkIG1lZGlhIGZpbGUgaWYgJ3JlbW90ZVBhdGgnXG4gKiBwYXJhbWV0ZXIgaXMgZmFsc3kgb3IgYW4gZW1wdHkgc3RyaW5nLlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBnZXR0aW5nIHRoZSBuYW1lIG9mIGEgbWVkaWEgZmlsZVxuICogb3IgdGhlIGZpbGUgY29udGVudCBjYW5ub3QgYmUgdXBsb2FkZWQgdG8gdGhlIHJlbW90ZSBsb2NhdGlvblxuICogb3Igc2NyZWVuIHJlY29yZGluZyBpcyBub3Qgc3VwcG9ydGVkIG9uIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqL1xuY29tbWFuZHMuc3RvcFJlY29yZGluZ1NjcmVlbiA9IGFzeW5jIGZ1bmN0aW9uIHN0b3BSZWNvcmRpbmdTY3JlZW4gKG9wdGlvbnMgPSB7fSkge1xuICBpZiAoIXRoaXMuX3NjcmVlblJlY29yZGVyKSB7XG4gICAgbG9nLmRlYnVnKCdObyBzY3JlZW4gcmVjb3JkaW5nIGhhcyBiZWVuIHN0YXJ0ZWQuIERvaW5nIG5vdGhpbmcnKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICBsb2cuZGVidWcoJ1JldHJpZXZpbmcgdGhlIHJlc3VsdGluZyB2aWRlbyBkYXRhJyk7XG4gIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRoaXMuX3NjcmVlblJlY29yZGVyLnN0b3AoKTtcbiAgaWYgKCF2aWRlb1BhdGgpIHtcbiAgICBsb2cuZGVidWcoJ05vIHZpZGVvIGRhdGEgaXMgZm91bmQuIFJldHVybmluZyBhbiBlbXB0eSBzdHJpbmcnKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IHVwbG9hZFJlY29yZGVkTWVkaWEodmlkZW9QYXRoLCBvcHRpb25zLnJlbW90ZVBhdGgsIG9wdGlvbnMpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9yZWNvcmQtc2NyZWVuLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
