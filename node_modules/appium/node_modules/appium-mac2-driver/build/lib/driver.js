"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _wdaMac = _interopRequireDefault(require("./wda-mac"));

var _desiredCaps = require("./desired-caps");

var _index = _interopRequireDefault(require("./commands/index"));

var _logger = _interopRequireDefault(require("./logger"));

const NO_PROXY = [['GET', new RegExp('^/session/[^/]+/appium')], ['POST', new RegExp('^/session/[^/]+/appium')], ['POST', new RegExp('^/session/[^/]+/element/[^/]+/elements?$')], ['POST', new RegExp('^/session/[^/]+/elements?$')], ['POST', new RegExp('^/session/[^/]+/execute')], ['POST', new RegExp('^/session/[^/]+/execute/sync')], ['GET', new RegExp('^/session/[^/]+/timeouts$')], ['POST', new RegExp('^/session/[^/]+/timeouts$')]];

class Mac2Driver extends _appiumBaseDriver.BaseDriver {
  constructor(opts = {}) {
    super(opts);
    this.desiredCapConstraints = _desiredCaps.desiredCapConstraints;
    this.locatorStrategies = ['id', 'name', 'accessibility id', 'xpath', 'class name', '-ios predicate string', 'predicate string', '-ios class chain', 'class chain'];
    this.resetState();
    this.settings = new _appiumBaseDriver.DeviceSettings({}, this.onSettingsUpdate.bind(this));

    for (const [cmd, fn] of _lodash.default.toPairs(_index.default)) {
      Mac2Driver.prototype[cmd] = fn;
    }
  }

  async onSettingsUpdate(key, value) {
    return await this.wda.proxy.command('/appium/settings', 'POST', {
      settings: {
        [key]: value
      }
    });
  }

  resetState() {
    this.wda = null;
    this.proxyReqRes = null;
    this.isProxyActive = false;
    this._screenRecorder = null;
  }

  proxyActive() {
    return this.isProxyActive;
  }

  getProxyAvoidList() {
    return NO_PROXY;
  }

  canProxy() {
    return true;
  }

  async createSession(...args) {
    const [sessionId, caps] = await super.createSession(...args);
    this.wda = _wdaMac.default;

    try {
      if (caps.prerun) {
        if (!_lodash.default.isString(caps.prerun.command) && !_lodash.default.isString(caps.prerun.script)) {
          throw new Error(`'prerun' capability value must either contain ` + `'script' or 'command' entry of string type`);
        }

        _logger.default.info('Executing prerun AppleScript');

        const output = await this.macosExecAppleScript(caps.prerun);

        if (_lodash.default.trim(output)) {
          _logger.default.info(`Prerun script output: ${output}`);
        }
      }

      await this.wda.startSession(caps);
    } catch (e) {
      await this.deleteSession();
      throw e;
    }

    this.proxyReqRes = this.wda.proxy.proxyReqRes.bind(this.wda.proxy);
    this.isProxyActive = true;
    return [sessionId, caps];
  }

  async deleteSession() {
    var _this$_screenRecorder, _this$wda;

    await ((_this$_screenRecorder = this._screenRecorder) === null || _this$_screenRecorder === void 0 ? void 0 : _this$_screenRecorder.stop(true));
    await ((_this$wda = this.wda) === null || _this$wda === void 0 ? void 0 : _this$wda.stopSession());

    if (this.opts.postrun) {
      if (!_lodash.default.isString(this.opts.postrun.command) && !_lodash.default.isString(this.opts.postrun.script)) {
        _logger.default.error(`'postrun' capability value must either contain ` + `'script' or 'command' entry of string type`);
      } else {
        _logger.default.info('Executing postrun AppleScript');

        try {
          const output = await this.macosExecAppleScript(this.opts.postrun);

          if (_lodash.default.trim(output)) {
            _logger.default.info(`Postrun script output: ${output}`);
          }
        } catch (e) {
          _logger.default.error(e.message);
        }
      }
    }

    this.resetState();
    await super.deleteSession();
  }

}

var _default = Mac2Driver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kcml2ZXIuanMiXSwibmFtZXMiOlsiTk9fUFJPWFkiLCJSZWdFeHAiLCJNYWMyRHJpdmVyIiwiQmFzZURyaXZlciIsImNvbnN0cnVjdG9yIiwib3B0cyIsImRlc2lyZWRDYXBDb25zdHJhaW50cyIsImxvY2F0b3JTdHJhdGVnaWVzIiwicmVzZXRTdGF0ZSIsInNldHRpbmdzIiwiRGV2aWNlU2V0dGluZ3MiLCJvblNldHRpbmdzVXBkYXRlIiwiYmluZCIsImNtZCIsImZuIiwiXyIsInRvUGFpcnMiLCJjb21tYW5kcyIsInByb3RvdHlwZSIsImtleSIsInZhbHVlIiwid2RhIiwicHJveHkiLCJjb21tYW5kIiwicHJveHlSZXFSZXMiLCJpc1Byb3h5QWN0aXZlIiwiX3NjcmVlblJlY29yZGVyIiwicHJveHlBY3RpdmUiLCJnZXRQcm94eUF2b2lkTGlzdCIsImNhblByb3h5IiwiY3JlYXRlU2Vzc2lvbiIsImFyZ3MiLCJzZXNzaW9uSWQiLCJjYXBzIiwiV0RBX01BQ19TRVJWRVIiLCJwcmVydW4iLCJpc1N0cmluZyIsInNjcmlwdCIsIkVycm9yIiwibG9nIiwiaW5mbyIsIm91dHB1dCIsIm1hY29zRXhlY0FwcGxlU2NyaXB0IiwidHJpbSIsInN0YXJ0U2Vzc2lvbiIsImUiLCJkZWxldGVTZXNzaW9uIiwic3RvcCIsInN0b3BTZXNzaW9uIiwicG9zdHJ1biIsImVycm9yIiwibWVzc2FnZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxRQUFRLEdBQUcsQ0FDZixDQUFDLEtBQUQsRUFBUSxJQUFJQyxNQUFKLENBQVcsd0JBQVgsQ0FBUixDQURlLEVBRWYsQ0FBQyxNQUFELEVBQVMsSUFBSUEsTUFBSixDQUFXLHdCQUFYLENBQVQsQ0FGZSxFQUdmLENBQUMsTUFBRCxFQUFTLElBQUlBLE1BQUosQ0FBVywwQ0FBWCxDQUFULENBSGUsRUFJZixDQUFDLE1BQUQsRUFBUyxJQUFJ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QUFvQjtBQUNsQkYsNEJBQUlDLElBQUosQ0FBVSwwQkFBeUJDLE1BQU8sRUFBMUM7QUFDRDtBQUNGLFNBTEQsQ0FLRSxPQUFPSSxDQUFQLEVBQVU7QUFDVk4sMEJBQUlXLEtBQUosQ0FBVUwsQ0FBQyxDQUFDTSxPQUFaO0FBQ0Q7QUFDRjtBQUNGOztBQUVELFNBQUszQyxVQUFMO0FBRUEsVUFBTSxNQUFNc0MsYUFBTixFQUFOO0FBQ0Q7O0FBckdpQzs7ZUF3R3JCNUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBCYXNlRHJpdmVyLCBEZXZpY2VTZXR0aW5ncyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgV0RBX01BQ19TRVJWRVIgZnJvbSAnLi93ZGEtbWFjJztcbmltcG9ydCB7IGRlc2lyZWRDYXBDb25zdHJhaW50cyB9IGZyb20gJy4vZGVzaXJlZC1jYXBzJztcbmltcG9ydCBjb21tYW5kcyBmcm9tICcuL2NvbW1hbmRzL2luZGV4JztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuXG5jb25zdCBOT19QUk9YWSA9IFtcbiAgWydHRVQnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvYXBwaXVtJyldLFxuICBbJ1BPU1QnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvYXBwaXVtJyldLFxuICBbJ1BPU1QnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvZWxlbWVudC9bXi9dKy9lbGVtZW50cz8kJyldLFxuICBbJ1BPU1QnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvZWxlbWVudHM/JCcpXSxcbiAgWydQT1NUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL2V4ZWN1dGUnKV0sXG4gIFsnUE9TVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9leGVjdXRlL3N5bmMnKV0sXG4gIFsnR0VUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL3RpbWVvdXRzJCcpXSxcbiAgWydQT1NUJywgbmV3IFJlZ0V4cCgnXi9zZXNzaW9uL1teL10rL3RpbWVvdXRzJCcpXSxcbl07XG5cbmNsYXNzIE1hYzJEcml2ZXIgZXh0ZW5kcyBCYXNlRHJpdmVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIHN1cGVyKG9wdHMpO1xuICAgIHRoaXMuZGVzaXJlZENhcENvbnN0cmFpbnRzID0gZGVzaXJlZENhcENvbnN0cmFpbnRzO1xuICAgIHRoaXMubG9jYXRvclN0cmF0ZWdpZXMgPSBbXG4gICAgICAnaWQnLFxuICAgICAgJ25hbWUnLFxuICAgICAgJ2FjY2Vzc2liaWxpdHkgaWQnLFxuXG4gICAgICAneHBhdGgnLFxuXG4gICAgICAnY2xhc3MgbmFtZScsXG5cbiAgICAgICctaW9zIHByZWRpY2F0ZSBzdHJpbmcnLFxuICAgICAgJ3ByZWRpY2F0ZSBzdHJpbmcnLFxuXG4gICAgICAnLWlvcyBjbGFzcyBjaGFpbicsXG4gICAgICAnY2xhc3MgY2hhaW4nLFxuICAgIF07XG4gICAgdGhpcy5yZXNldFN0YXRlKCk7XG4gICAgdGhpcy5zZXR0aW5ncyA9IG5ldyBEZXZpY2VTZXR0aW5ncyh7fSwgdGhpcy5vblNldHRpbmdzVXBkYXRlLmJpbmQodGhpcykpO1xuXG4gICAgZm9yIChjb25zdCBbY21kLCBmbl0gb2YgXy50b1BhaXJzKGNvbW1hbmRzKSkge1xuICAgICAgTWFjMkRyaXZlci5wcm90b3R5cGVbY21kXSA9IGZuO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIG9uU2V0dGluZ3NVcGRhdGUgKGtleSwgdmFsdWUpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy53ZGEucHJveHkuY29tbWFuZCgnL2FwcGl1bS9zZXR0aW5ncycsICdQT1NUJywge1xuICAgICAgc2V0dGluZ3M6IHtba2V5XTogdmFsdWV9XG4gICAgfSk7XG4gIH1cblxuICByZXNldFN0YXRlICgpIHtcbiAgICB0aGlzLndkYSA9IG51bGw7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IG51bGw7XG4gICAgdGhpcy5pc1Byb3h5QWN0aXZlID0gZmFsc2U7XG4gICAgdGhpcy5fc2NyZWVuUmVjb3JkZXIgPSBudWxsO1xuICB9XG5cbiAgcHJveHlBY3RpdmUgKCkge1xuICAgIHJldHVybiB0aGlzLmlzUHJveHlBY3RpdmU7XG4gIH1cblxuICBnZXRQcm94eUF2b2lkTGlzdCAoKSB7XG4gICAgcmV0dXJuIE5PX1BST1hZO1xuICB9XG5cbiAgY2FuUHJveHkgKCkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlU2Vzc2lvbiAoLi4uYXJncykge1xuICAgIGNvbnN0IFtzZXNzaW9uSWQsIGNhcHNdID0gYXdhaXQgc3VwZXIuY3JlYXRlU2Vzc2lvbiguLi5hcmdzKTtcbiAgICB0aGlzLndkYSA9IFdEQV9NQUNfU0VSVkVSO1xuICAgIHRyeSB7XG4gICAgICBpZiAoY2Fwcy5wcmVydW4pIHtcbiAgICAgICAgaWYgKCFfLmlzU3RyaW5nKGNhcHMucHJlcnVuLmNvbW1hbmQpICYmICFfLmlzU3RyaW5nKGNhcHMucHJlcnVuLnNjcmlwdCkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCdwcmVydW4nIGNhcGFiaWxpdHkgdmFsdWUgbXVzdCBlaXRoZXIgY29udGFpbiBgICtcbiAgICAgICAgICAgIGAnc2NyaXB0JyBvciAnY29tbWFuZCcgZW50cnkgb2Ygc3RyaW5nIHR5cGVgKTtcbiAgICAgICAgfVxuICAgICAgICBsb2cuaW5mbygnRXhlY3V0aW5nIHByZXJ1biBBcHBsZVNjcmlwdCcpO1xuICAgICAgICBjb25zdCBvdXRwdXQgPSBhd2FpdCB0aGlzLm1hY29zRXhlY0FwcGxlU2NyaXB0KGNhcHMucHJlcnVuKTtcbiAgICAgICAgaWYgKF8udHJpbShvdXRwdXQpKSB7XG4gICAgICAgICAgbG9nLmluZm8oYFByZXJ1biBzY3JpcHQgb3V0cHV0OiAke291dHB1dH1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgYXdhaXQgdGhpcy53ZGEuc3RhcnRTZXNzaW9uKGNhcHMpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMud2RhLnByb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy53ZGEucHJveHkpO1xuICAgIHRoaXMuaXNQcm94eUFjdGl2ZSA9IHRydWU7XG4gICAgcmV0dXJuIFtzZXNzaW9uSWQsIGNhcHNdO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgYXdhaXQgdGhpcy5fc2NyZWVuUmVjb3JkZXI/LnN0b3AodHJ1ZSk7XG4gICAgYXdhaXQgdGhpcy53ZGE/LnN0b3BTZXNzaW9uKCk7XG5cbiAgICBpZiAodGhpcy5vcHRzLnBvc3RydW4pIHtcbiAgICAgIGlmICghXy5pc1N0cmluZyh0aGlzLm9wdHMucG9zdHJ1bi5jb21tYW5kKSAmJiAhXy5pc1N0cmluZyh0aGlzLm9wdHMucG9zdHJ1bi5zY3JpcHQpKSB7XG4gICAgICAgIGxvZy5lcnJvcihgJ3Bvc3RydW4nIGNhcGFiaWxpdHkgdmFsdWUgbXVzdCBlaXRoZXIgY29udGFpbiBgICtcbiAgICAgICAgICBgJ3NjcmlwdCcgb3IgJ2NvbW1hbmQnIGVudHJ5IG9mIHN0cmluZyB0eXBlYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuaW5mbygnRXhlY3V0aW5nIHBvc3RydW4gQXBwbGVTY3JpcHQnKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCBvdXRwdXQgPSBhd2FpdCB0aGlzLm1hY29zRXhlY0FwcGxlU2NyaXB0KHRoaXMub3B0cy5wb3N0cnVuKTtcbiAgICAgICAgICBpZiAoXy50cmltKG91dHB1dCkpIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKGBQb3N0cnVuIHNjcmlwdCBvdXRwdXQ6ICR7b3V0cHV0fWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIGxvZy5lcnJvcihlLm1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5yZXNldFN0YXRlKCk7XG5cbiAgICBhd2FpdCBzdXBlci5kZWxldGVTZXNzaW9uKCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTWFjMkRyaXZlcjtcbiJdLCJmaWxlIjoibGliL2RyaXZlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
