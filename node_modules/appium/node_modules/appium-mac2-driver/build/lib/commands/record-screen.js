"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _teen_process = require("teen_process");

var _bluebird = _interopRequireDefault(require("bluebird"));

const commands = {};
const RETRY_PAUSE = 300;
const RETRY_TIMEOUT = 5000;
const DEFAULT_TIME_LIMIT = 60 * 10;
const PROCESS_SHUTDOWN_TIMEOUT = 10 * 1000;
const DEFAULT_EXT = 'mp4';
const FFMPEG_BINARY = 'ffmpeg';
const DEFAULT_FPS = 15;
const DEFAULT_PRESET = 'veryfast';

async function uploadRecordedMedia(localFile, remotePath = null, uploadOptions = {}) {
  if (_lodash.default.isEmpty(remotePath)) {
    const {
      size
    } = await _appiumSupport.fs.stat(localFile);

    _logger.default.debug(`The size of the resulting screen recording is ${_appiumSupport.util.toReadableSizeString(size)}`);

    return (await _appiumSupport.util.toInMemoryBase64(localFile)).toString();
  }

  const {
    user,
    pass,
    method,
    headers,
    fileFieldName,
    formFields
  } = uploadOptions;
  const options = {
    method: method || 'PUT',
    headers,
    fileFieldName,
    formFields
  };

  if (user && pass) {
    options.auth = {
      user,
      pass
    };
  }

  await _appiumSupport.net.uploadFile(localFile, remotePath, options);
  return '';
}

async function requireFfmpegPath() {
  try {
    return await _appiumSupport.fs.which(FFMPEG_BINARY);
  } catch (e) {
    _logger.default.errorAndThrow(`${FFMPEG_BINARY} has not been found in PATH. ` + `Please make sure it is installed`);
  }
}

class ScreenRecorder {
  constructor(videoPath, opts = {}) {
    this._videoPath = videoPath;
    this._process = null;
    this._fps = opts.fps && opts.fps > 0 ? opts.fps : DEFAULT_FPS;
    this._deviceId = opts.deviceId;
    this._captureCursor = opts.captureCursor;
    this._captureClicks = opts.captureClicks;
    this._preset = opts.preset || DEFAULT_PRESET;
    this._videoFilter = opts.videoFilter;
    this._timeLimit = opts.timeLimit && opts.timeLimit > 0 ? opts.timeLimit : DEFAULT_TIME_LIMIT;
  }

  async getVideoPath() {
    return (await _appiumSupport.fs.exists(this._videoPath)) ? this._videoPath : '';
  }

  isRunning() {
    var _this$_process;

    return !!((_this$_process = this._process) !== null && _this$_process !== void 0 && _this$_process.isRunning);
  }

  async _enforceTermination() {
    if (this._process && this.isRunning()) {
      _logger.default.debug('Force-stopping the currently running video recording');

      try {
        await this._process.stop('SIGKILL');
      } catch (ign) {}
    }

    this._process = null;
    const videoPath = await this.getVideoPath();

    if (videoPath) {
      await _appiumSupport.fs.rimraf(videoPath);
    }

    return '';
  }

  async start() {
    const ffmpeg = await requireFfmpegPath();
    const args = ['-loglevel', 'error', '-t', `${this._timeLimit}`, '-f', 'avfoundation', ...(this._captureCursor ? ['-capture_cursor', '1'] : []), ...(this._captureClicks ? ['-capture_mouse_clicks', '1'] : []), '-framerate', `${this._fps}`, '-i', this._deviceId, '-vcodec', 'libx264', '-preset', this._preset, '-tune', 'zerolatency', '-pix_fmt', 'yuv420p', '-movflags', '+faststart', '-fflags', 'nobuffer', '-f', DEFAULT_EXT, '-r', `${this._fps}`, ...(this._videoFilter ? ['-filter:v', this._videoFilter] : [])];
    const fullCmd = [ffmpeg, ...args, this._videoPath];
    this._process = new _teen_process.SubProcess(fullCmd[0], fullCmd.slice(1));

    _logger.default.debug(`Starting ${FFMPEG_BINARY}: ${_appiumSupport.util.quote(fullCmd)}`);

    this._process.on('output', (stdout, stderr) => {
      if (_lodash.default.trim(stdout || stderr)) {
        _logger.default.debug(`[${FFMPEG_BINARY}] ${stdout || stderr}`);
      }
    });

    this._process.once('exit', async (code, signal) => {
      this._process = null;

      if (code === 0) {
        _logger.default.debug('Screen recording exited without errors');
      } else {
        await this._enforceTermination();

        _logger.default.warn(`Screen recording exited with error code ${code}, signal ${signal}`);
      }
    });

    await this._process.start(0);

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        if (await this.getVideoPath()) {
          return true;
        }

        if (!this._process) {
          throw new Error(`${FFMPEG_BINARY} process died unexpectedly`);
        }

        return false;
      }, {
        waitMs: RETRY_TIMEOUT,
        intervalMs: RETRY_PAUSE
      });
    } catch (e) {
      await this._enforceTermination();

      _logger.default.errorAndThrow(`The expected screen record file '${this._videoPath}' does not exist. ` + `Check the server log for more details`);
    }

    _logger.default.info(`The video recording has started. Will timeout in ${_appiumSupport.util.pluralize('second', this._timeLimit, true)}`);
  }

  async stop(force = false) {
    if (force) {
      return await this._enforceTermination();
    }

    if (!this.isRunning()) {
      _logger.default.debug('Screen recording is not running. Returning the recent result');

      return await this.getVideoPath();
    }

    return new _bluebird.default((resolve, reject) => {
      const timer = setTimeout(async () => {
        await this._enforceTermination();
        reject(new Error(`Screen recording has failed to exit after ${PROCESS_SHUTDOWN_TIMEOUT}ms`));
      }, PROCESS_SHUTDOWN_TIMEOUT);

      this._process.once('exit', async (code, signal) => {
        clearTimeout(timer);

        if (code === 0) {
          resolve(await this.getVideoPath());
        } else {
          reject(new Error(`Screen recording exited with error code ${code}, signal ${signal}`));
        }
      });

      this._process.proc.stdin.write('q');

      this._process.proc.stdin.end();
    });
  }

}

commands.startRecordingScreen = async function startRecordingScreen(options = {}) {
  var _this$_screenRecorder, _this$_screenRecorder2;

  const {
    timeLimit,
    videoFilter,
    fps,
    preset,
    captureCursor,
    captureClicks,
    deviceId,
    forceRestart = true
  } = options;

  if (_lodash.default.isNil(deviceId)) {
    throw new Error(`'deviceId' option must be provided. Run 'ffmpeg -f avfoundation -list_devices true -i' ` + 'to fetch the list of available device ids');
  }

  if ((_this$_screenRecorder = this._screenRecorder) !== null && _this$_screenRecorder !== void 0 && (_this$_screenRecorder2 = _this$_screenRecorder.isRunning) !== null && _this$_screenRecorder2 !== void 0 && _this$_screenRecorder2.call(_this$_screenRecorder)) {
    _logger.default.debug('The screen recording is already running');

    if (!forceRestart) {
      _logger.default.debug('Doing nothing');

      return;
    }

    _logger.default.debug('Forcing the active screen recording to stop');

    await this._screenRecorder.stop(true);
  }

  this._screenRecorder = null;
  const videoPath = await _appiumSupport.tempDir.path({
    prefix: _appiumSupport.util.uuidV4().substring(0, 8),
    suffix: `.${DEFAULT_EXT}`
  });
  this._screenRecorder = new ScreenRecorder(videoPath, {
    fps: parseInt(fps, 10),
    timeLimit: parseInt(timeLimit, 10),
    preset,
    captureCursor,
    captureClicks,
    videoFilter,
    deviceId
  });

  try {
    await this._screenRecorder.start();
  } catch (e) {
    this._screenRecorder = null;
    throw e;
  }
};

commands.stopRecordingScreen = async function stopRecordingScreen(options = {}) {
  if (!this._screenRecorder) {
    _logger.default.debug('No screen recording has been started. Doing nothing');

    return '';
  }

  _logger.default.debug('Retrieving the resulting video data');

  const videoPath = await this._screenRecorder.stop();

  if (!videoPath) {
    _logger.default.debug('No video data is found. Returning an empty string');

    return '';
  }

  return await uploadRecordedMedia(videoPath, options.remotePath, options);
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9yZWNvcmQtc2NyZWVuLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiUkVUUllfUEFVU0UiLCJSRVRSWV9USU1FT1VUIiwiREVGQVVMVF9USU1FX0xJTUlUIiwiUFJPQ0VTU19TSFVURE9XTl9USU1FT1VUIiwiREVGQVVMVF9FWFQiLCJGRk1QRUdfQklOQVJZIiwiREVGQVVMVF9GUFMiLCJERUZBVUxUX1BSRVNFVCIsInVwbG9hZFJlY29yZGVkTWVkaWEiLCJsb2NhbEZpbGUiLCJyZW1vdGVQYXRoIiwidXBsb2FkT3B0aW9ucyIsIl8iLCJpc0VtcHR5Iiwic2l6ZSIsImZzIiwic3RhdCIsImxvZyIsImRlYnVnIiwidXRpbCIsInRvUmVhZGFibGVTaXplU3RyaW5nIiwidG9Jbk1lbW9yeUJhc2U2NCIsInRvU3RyaW5nIiwidXNlciIsInBhc3MiLCJtZXRob2QiLCJoZWFkZXJzIiwiZmlsZUZpZWxkTmFtZSIsImZvcm1GaWVsZHMiLCJvcHRpb25zIiwiYXV0aCIsIm5ldCIsInVwbG9hZEZpbGUiLCJyZXF1aXJlRmZtcGVnUGF0aCIsIndoaWNoIiwiZSIsImVycm9yQW5kVGhyb3ciLCJTY3JlZW5SZWNvcmRlciIsImNvbnN0cnVjdG9yIiwidmlkZW9QYXRoIiwib3B0cyIsIl92aWRlb1BhdGgiLCJfcHJvY2VzcyIsIl9mcHMiLCJmcHMiLCJfZGV2aWNlSWQiLCJkZXZpY2VJZCIsIl9jYXB0dXJlQ3Vyc29yIiwiY2FwdHVyZUN1cnNvciIsIl9jYXB0dXJlQ2xpY2tzIiwiY2FwdHVyZUNsaWNrcyIsIl9wcmVzZXQiLCJwcmVzZXQiLCJfdmlkZW9GaWx0ZXIiLCJ2aWRlb0ZpbHRlciIsIl90aW1lTGltaXQiLCJ0aW1lTGltaXQiLCJnZXRWaWRlb1BhdGgiLCJleGlzdHMiLCJpc1J1bm5pbmciLCJfZW5mb3JjZVRlcm1pbmF0aW9uIiwic3RvcCIsImlnbiIsInJpbXJhZiIsInN0YXJ0IiwiZmZtcGVnIiwiYXJncyIsImZ1bGxDbWQiLCJTdWJQcm9jZXNzIiwic2xpY2UiLCJxdW90ZSIsIm9uIiwic3Rkb3V0Iiwic3RkZXJyIiwidHJpbSIsIm9uY2UiLCJjb2RlIiwic2lnbmFsIiwid2FybiIsIkVycm9yIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImluZm8iLCJwbHVyYWxpemUiLCJmb3JjZSIsIkIiLCJyZXNvbHZlIiwicmVqZWN0IiwidGltZXIiLCJzZXRUaW1lb3V0IiwiY2xlYXJUaW1lb3V0IiwicHJvYyIsInN0ZGluIiwid3JpdGUiLCJlbmQiLCJzdGFydFJlY29yZGluZ1NjcmVlbiIsImZvcmNlUmVzdGFydCIsImlzTmlsIiwiX3NjcmVlblJlY29yZGVyIiwidGVtcERpciIsInBhdGgiLCJwcmVmaXgiLCJ1dWlkVjQiLCJzdWJzdHJpbmciLCJzdWZmaXgiLCJwYXJzZUludCIsInN0b3BSZWNvcmRpbmdTY3JlZW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsUUFBUSxHQUFHLEVBQWpCO0FBRUEsTUFBTUMsV0FBVyxHQUFHLEdBQXBCO0FBQ0EsTUFBTUMsYUFBYSxHQUFHLElBQXRCO0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUcsS0FBSyxFQUFoQztBQUNBLE1BQU1DLHdCQUF3QixHQUFHLEtBQUssSUFBdEM7QUFDQSxNQUFNQyxXQUFXLEdBQUcsS0FBcEI7QUFDQSxNQUFNQyxhQUFhLEdBQUcsUUFBdEI7QUFDQSxNQUFNQyxXQUFXLEdBQUcsRUFBcEI7QUFDQSxNQUFNQyxjQUFjLEdBQUcsVUFBdkI7O0FBR0EsZUFBZUMsbUJBQWYsQ0FBb0NDLFNBQXBDLEVBQStDQyxVQUFVLEdBQUcsSUFBNUQsRUFBa0VDLGFBQWEsR0FBRyxFQUFsRixFQUFzRjtBQUNwRixNQUFJQyxnQkFBRUMsT0FBRixDQUFVSCxVQUFWLENBQUosRUFBMkI7QUFDekIsVUFBTTtBQUFDSSxNQUFBQTtBQUFELFFBQVMsTUFBTUMsa0JBQUdDLElBQUgsQ0FBUVAsU0FBUixDQUFyQjs7QUFD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SSxDQUFDdEIsU0FBTCxFQUFnQjtBQUNkdEIsb0JBQUlDLEtBQUosQ0FBVSxtREFBVjs7QUFDQSxXQUFPLEVBQVA7QUFDRDs7QUFDRCxTQUFPLE1BQU1WLG1CQUFtQixDQUFDK0IsU0FBRCxFQUFZVixPQUFPLENBQUNuQixVQUFwQixFQUFnQ21CLE9BQWhDLENBQWhDO0FBQ0QsQ0FiRDs7ZUFlZTlCLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IHV0aWwsIGZzLCBuZXQsIHRlbXBEaXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBTdWJQcm9jZXNzIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuXG5jb25zdCBjb21tYW5kcyA9IHt9O1xuXG5jb25zdCBSRVRSWV9QQVVTRSA9IDMwMDtcbmNvbnN0IFJFVFJZX1RJTUVPVVQgPSA1MDAwO1xuY29uc3QgREVGQVVMVF9USU1FX0xJTUlUID0gNjAgKiAxMDsgLy8gMTAgbWludXRlc1xuY29uc3QgUFJPQ0VTU19TSFVURE9XTl9USU1FT1VUID0gMTAgKiAxMDAwO1xuY29uc3QgREVGQVVMVF9FWFQgPSAnbXA0JztcbmNvbnN0IEZGTVBFR19CSU5BUlkgPSAnZmZtcGVnJztcbmNvbnN0IERFRkFVTFRfRlBTID0gMTU7XG5jb25zdCBERUZBVUxUX1BSRVNFVCA9ICd2ZXJ5ZmFzdCc7XG5cblxuYXN5bmMgZnVuY3Rpb24gdXBsb2FkUmVjb3JkZWRNZWRpYSAobG9jYWxGaWxlLCByZW1vdGVQYXRoID0gbnVsbCwgdXBsb2FkT3B0aW9ucyA9IHt9KSB7XG4gIGlmIChfLmlzRW1wdHkocmVtb3RlUGF0aCkpIHtcbiAgICBjb25zdCB7c2l6ZX0gPSBhd2FpdCBmcy5zdGF0KGxvY2FsRmlsZSk7XG4gICAgbG9nLmRlYnVnKGBUaGUgc2l6ZSBvZiB0aGUgcmVzdWx0aW5nIHNjcmVlbiByZWNvcmRpbmcgaXMgJHt1dGlsLnRvUmVhZGFibGVTaXplU3RyaW5nKHNpemUpfWApO1xuICAgIHJldHVybiAoYXdhaXQgdXRpbC50b0luTWVtb3J5QmFzZTY0KGxvY2FsRmlsZSkpLnRvU3RyaW5nKCk7XG4gIH1cblxuICBjb25zdCB7dXNlciwgcGFzcywgbWV0aG9kLCBoZWFkZXJzLCBmaWxlRmllbGROYW1lLCBmb3JtRmllbGRzfSA9IHVwbG9hZE9wdGlvbnM7XG4gIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgbWV0aG9kOiBtZXRob2QgfHwgJ1BVVCcsXG4gICAgaGVhZGVycyxcbiAgICBmaWxlRmllbGROYW1lLFxuICAgIGZvcm1GaWVsZHMsXG4gIH07XG4gIGlmICh1c2VyICYmIHBhc3MpIHtcbiAgICBvcHRpb25zLmF1dGggPSB7dXNlciwgcGFzc307XG4gIH1cbiAgYXdhaXQgbmV0LnVwbG9hZEZpbGUobG9jYWxGaWxlLCByZW1vdGVQYXRoLCBvcHRpb25zKTtcbiAgcmV0dXJuICcnO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXF1aXJlRmZtcGVnUGF0aCAoKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IGZzLndoaWNoKEZGTVBFR19CSU5BUlkpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYCR7RkZNUEVHX0JJTkFSWX0gaGFzIG5vdCBiZWVuIGZvdW5kIGluIFBBVEguIGAgK1xuICAgICAgYFBsZWFzZSBtYWtlIHN1cmUgaXQgaXMgaW5zdGFsbGVkYCk7XG4gIH1cbn1cblxuY2xhc3MgU2NyZWVuUmVjb3JkZXIge1xuICBjb25zdHJ1Y3RvciAodmlkZW9QYXRoLCBvcHRzID0ge30pIHtcbiAgICB0aGlzLl92aWRlb1BhdGggPSB2aWRlb1BhdGg7XG4gICAgdGhpcy5fcHJvY2VzcyA9IG51bGw7XG4gICAgdGhpcy5fZnBzID0gKG9wdHMuZnBzICYmIG9wdHMuZnBzID4gMCkgPyBvcHRzLmZwcyA6IERFRkFVTFRfRlBTO1xuICAgIHRoaXMuX2RldmljZUlkID0gb3B0cy5kZXZpY2VJZDtcbiAgICB0aGlzLl9jYXB0dXJlQ3Vyc29yID0gb3B0cy5jYXB0dXJlQ3Vyc29yO1xuICAgIHRoaXMuX2NhcHR1cmVDbGlja3MgPSBvcHRzLmNhcHR1cmVDbGlja3M7XG4gICAgdGhpcy5fcHJlc2V0ID0gb3B0cy5wcmVzZXQgfHwgREVGQVVMVF9QUkVTRVQ7XG4gICAgdGhpcy5fdmlkZW9GaWx0ZXIgPSBvcHRzLnZpZGVvRmlsdGVyO1xuICAgIHRoaXMuX3RpbWVMaW1pdCA9IChvcHRzLnRpbWVMaW1pdCAmJiBvcHRzLnRpbWVMaW1pdCA+IDApXG4gICAgICA/IG9wdHMudGltZUxpbWl0XG4gICAgICA6IERFRkFVTFRfVElNRV9MSU1JVDtcbiAgfVxuXG4gIGFzeW5jIGdldFZpZGVvUGF0aCAoKSB7XG4gICAgcmV0dXJuIChhd2FpdCBmcy5leGlzdHModGhpcy5fdmlkZW9QYXRoKSkgPyB0aGlzLl92aWRlb1BhdGggOiAnJztcbiAgfVxuXG4gIGlzUnVubmluZyAoKSB7XG4gICAgcmV0dXJuICEhKHRoaXMuX3Byb2Nlc3M/LmlzUnVubmluZyk7XG4gIH1cblxuICBhc3luYyBfZW5mb3JjZVRlcm1pbmF0aW9uICgpIHtcbiAgICBpZiAodGhpcy5fcHJvY2VzcyAmJiB0aGlzLmlzUnVubmluZygpKSB7XG4gICAgICBsb2cuZGVidWcoJ0ZvcmNlLXN0b3BwaW5nIHRoZSBjdXJyZW50bHkgcnVubmluZyB2aWRlbyByZWNvcmRpbmcnKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX3Byb2Nlc3Muc3RvcCgnU0lHS0lMTCcpO1xuICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgIH1cbiAgICB0aGlzLl9wcm9jZXNzID0gbnVsbDtcbiAgICBjb25zdCB2aWRlb1BhdGggPSBhd2FpdCB0aGlzLmdldFZpZGVvUGF0aCgpO1xuICAgIGlmICh2aWRlb1BhdGgpIHtcbiAgICAgIGF3YWl0IGZzLnJpbXJhZih2aWRlb1BhdGgpO1xuICAgIH1cbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICBhc3luYyBzdGFydCAoKSB7XG4gICAgY29uc3QgZmZtcGVnID0gYXdhaXQgcmVxdWlyZUZmbXBlZ1BhdGgoKTtcblxuICAgIGNvbnN0IGFyZ3MgPSBbXG4gICAgICAnLWxvZ2xldmVsJywgJ2Vycm9yJyxcbiAgICAgICctdCcsIGAke3RoaXMuX3RpbWVMaW1pdH1gLFxuICAgICAgJy1mJywgJ2F2Zm91bmRhdGlvbicsXG4gICAgICAuLi4odGhpcy5fY2FwdHVyZUN1cnNvciA/IFsnLWNhcHR1cmVfY3Vyc29yJywgJzEnXSA6IFtdKSxcbiAgICAgIC4uLih0aGlzLl9jYXB0dXJlQ2xpY2tzID8gWyctY2FwdHVyZV9tb3VzZV9jbGlja3MnLCAnMSddIDogW10pLFxuICAgICAgJy1mcmFtZXJhdGUnLCBgJHt0aGlzLl9mcHN9YCxcbiAgICAgICctaScsIHRoaXMuX2RldmljZUlkLFxuICAgICAgJy12Y29kZWMnLCAnbGlieDI2NCcsXG4gICAgICAnLXByZXNldCcsIHRoaXMuX3ByZXNldCxcbiAgICAgICctdHVuZScsICd6ZXJvbGF0ZW5jeScsXG4gICAgICAnLXBpeF9mbXQnLCAneXV2NDIwcCcsXG4gICAgICAnLW1vdmZsYWdzJywgJytmYXN0c3RhcnQnLFxuICAgICAgJy1mZmxhZ3MnLCAnbm9idWZmZXInLFxuICAgICAgJy1mJywgREVGQVVMVF9FWFQsXG4gICAgICAnLXInLCBgJHt0aGlzLl9mcHN9YCxcbiAgICAgIC4uLih0aGlzLl92aWRlb0ZpbHRlciA/IFsnLWZpbHRlcjp2JywgdGhpcy5fdmlkZW9GaWx0ZXJdIDogW10pLFxuICAgIF07XG5cbiAgICBjb25zdCBmdWxsQ21kID0gW1xuICAgICAgZmZtcGVnLFxuICAgICAgLi4uYXJncyxcbiAgICAgIHRoaXMuX3ZpZGVvUGF0aCxcbiAgICBdO1xuICAgIHRoaXMuX3Byb2Nlc3MgPSBuZXcgU3ViUHJvY2VzcyhmdWxsQ21kWzBdLCBmdWxsQ21kLnNsaWNlKDEpKTtcbiAgICBsb2cuZGVidWcoYFN0YXJ0aW5nICR7RkZNUEVHX0JJTkFSWX06ICR7dXRpbC5xdW90ZShmdWxsQ21kKX1gKTtcbiAgICB0aGlzLl9wcm9jZXNzLm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgIGlmIChfLnRyaW0oc3Rkb3V0IHx8IHN0ZGVycikpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBbJHtGRk1QRUdfQklOQVJZfV0gJHtzdGRvdXQgfHwgc3RkZXJyfWApO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMuX3Byb2Nlc3Mub25jZSgnZXhpdCcsIGFzeW5jIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgIHRoaXMuX3Byb2Nlc3MgPSBudWxsO1xuICAgICAgaWYgKGNvZGUgPT09IDApIHtcbiAgICAgICAgbG9nLmRlYnVnKCdTY3JlZW4gcmVjb3JkaW5nIGV4aXRlZCB3aXRob3V0IGVycm9ycycpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgdGhpcy5fZW5mb3JjZVRlcm1pbmF0aW9uKCk7XG4gICAgICAgIGxvZy53YXJuKGBTY3JlZW4gcmVjb3JkaW5nIGV4aXRlZCB3aXRoIGVycm9yIGNvZGUgJHtjb2RlfSwgc2lnbmFsICR7c2lnbmFsfWApO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMuX3Byb2Nlc3Muc3RhcnQoMCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgICBpZiAoYXdhaXQgdGhpcy5nZXRWaWRlb1BhdGgoKSkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5fcHJvY2Vzcykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJHtGRk1QRUdfQklOQVJZfSBwcm9jZXNzIGRpZWQgdW5leHBlY3RlZGx5YCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSwge1xuICAgICAgICB3YWl0TXM6IFJFVFJZX1RJTUVPVVQsXG4gICAgICAgIGludGVydmFsTXM6IFJFVFJZX1BBVVNFLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgYXdhaXQgdGhpcy5fZW5mb3JjZVRlcm1pbmF0aW9uKCk7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVGhlIGV4cGVjdGVkIHNjcmVlbiByZWNvcmQgZmlsZSAnJHt0aGlzLl92aWRlb1BhdGh9JyBkb2VzIG5vdCBleGlzdC4gYCArXG4gICAgICAgIGBDaGVjayB0aGUgc2VydmVyIGxvZyBmb3IgbW9yZSBkZXRhaWxzYCk7XG4gICAgfVxuICAgIGxvZy5pbmZvKGBUaGUgdmlkZW8gcmVjb3JkaW5nIGhhcyBzdGFydGVkLiBXaWxsIHRpbWVvdXQgaW4gJHt1dGlsLnBsdXJhbGl6ZSgnc2Vjb25kJywgdGhpcy5fdGltZUxpbWl0LCB0cnVlKX1gKTtcbiAgfVxuXG4gIGFzeW5jIHN0b3AgKGZvcmNlID0gZmFsc2UpIHtcbiAgICBpZiAoZm9yY2UpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9lbmZvcmNlVGVybWluYXRpb24oKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnU2NyZWVuIHJlY29yZGluZyBpcyBub3QgcnVubmluZy4gUmV0dXJuaW5nIHRoZSByZWNlbnQgcmVzdWx0Jyk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRWaWRlb1BhdGgoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgdGltZXIgPSBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5fZW5mb3JjZVRlcm1pbmF0aW9uKCk7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IoYFNjcmVlbiByZWNvcmRpbmcgaGFzIGZhaWxlZCB0byBleGl0IGFmdGVyICR7UFJPQ0VTU19TSFVURE9XTl9USU1FT1VUfW1zYCkpO1xuICAgICAgfSwgUFJPQ0VTU19TSFVURE9XTl9USU1FT1VUKTtcblxuICAgICAgdGhpcy5fcHJvY2Vzcy5vbmNlKCdleGl0JywgYXN5bmMgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICBpZiAoY29kZSA9PT0gMCkge1xuICAgICAgICAgIHJlc29sdmUoYXdhaXQgdGhpcy5nZXRWaWRlb1BhdGgoKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgU2NyZWVuIHJlY29yZGluZyBleGl0ZWQgd2l0aCBlcnJvciBjb2RlICR7Y29kZX0sIHNpZ25hbCAke3NpZ25hbH1gKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLl9wcm9jZXNzLnByb2Muc3RkaW4ud3JpdGUoJ3EnKTtcbiAgICAgIHRoaXMuX3Byb2Nlc3MucHJvYy5zdGRpbi5lbmQoKTtcbiAgICB9KTtcbiAgfVxufVxuXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RhcnRSZWNvcmRpbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2aWRlb0ZpbHRlciAtIFRoZSB2aWRlbyBmaWx0ZXIgc3BlYyB0byBhcHBseSBmb3IgZmZtcGVnLlxuICogU2VlIGh0dHBzOi8vdHJhYy5mZm1wZWcub3JnL3dpa2kvRmlsdGVyaW5nR3VpZGUgZm9yIG1vcmUgZGV0YWlscyBvbiB0aGUgcG9zc2libGUgdmFsdWVzLlxuICogRXhhbXBsZTogU2V0IGl0IHRvIGBzY2FsZT1pZm5vdChndGUoaXdcXCwxMDI0KVxcLGl3XFwsMTAyNCk6LTJgIGluIG9yZGVyIHRvIGxpbWl0IHRoZSB2aWRlbyB3aWR0aFxuICogdG8gMTAyNHB4LiBUaGUgaGVpZ2h0IHdpbGwgYmUgYWRqdXN0ZWQgYXV0b21hdGljYWxseSB0byBtYXRjaCB0aGUgYWN0dWFsIHJhdGlvLlxuICogQHByb3BlcnR5IHtudW1iZXJ8c3RyaW5nfSBmcHMgWzE1XSAtIFRoZSBjb3VudCBvZiBmcmFtZXMgcGVyIHNlY29uZCBpbiB0aGUgcmVzdWx0aW5nIHZpZGVvLlxuICogVGhlIGdyZWF0ZXIgZnBzIGl0IGhhcyB0aGUgYmlnZ2VyIGZpbGUgc2l6ZSBpcy5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBwcmVzZXQgW3ZlcnlmYXN0XSAtIE9uZSBvZiB0aGUgc3VwcG9ydGVkIGVuY29kaW5nIHByZXNldHMuIFBvc3NpYmxlIHZhbHVlcyBhcmU6XG4gKiAtIHVsdHJhZmFzdFxuICogLSBzdXBlcmZhc3RcbiAqIC0gdmVyeWZhc3RcbiAqIC0gZmFzdGVyXG4gKiAtIGZhc3RcbiAqIC0gbWVkaXVtXG4gKiAtIHNsb3dcbiAqIC0gc2xvd2VyXG4gKiAtIHZlcnlzbG93XG4gKiBBIHByZXNldCBpcyBhIGNvbGxlY3Rpb24gb2Ygb3B0aW9ucyB0aGF0IHdpbGwgcHJvdmlkZSBhIGNlcnRhaW4gZW5jb2Rpbmcgc3BlZWQgdG8gY29tcHJlc3Npb24gcmF0aW8uXG4gKiBBIHNsb3dlciBwcmVzZXQgd2lsbCBwcm92aWRlIGJldHRlciBjb21wcmVzc2lvbiAoY29tcHJlc3Npb24gaXMgcXVhbGl0eSBwZXIgZmlsZXNpemUpLlxuICogVGhpcyBtZWFucyB0aGF0LCBmb3IgZXhhbXBsZSwgaWYgeW91IHRhcmdldCBhIGNlcnRhaW4gZmlsZSBzaXplIG9yIGNvbnN0YW50IGJpdCByYXRlLCB5b3Ugd2lsbCBhY2hpZXZlIGJldHRlclxuICogcXVhbGl0eSB3aXRoIGEgc2xvd2VyIHByZXNldC4gUmVhZCBodHRwczovL3RyYWMuZmZtcGVnLm9yZy93aWtpL0VuY29kZS9ILjI2NCBmb3IgbW9yZSBkZXRhaWxzLlxuICogQHByb3BlcnR5IHtib29sZWFufSBjYXB0dXJlQ3Vyc29yIFtmYWxzZV0gLSBXaGV0aGVyIHRvIGNhcHR1cmUgdGhlIG1vdXNlIGN1cnNvciB3aGlsZSByZWNvcmRpbmdcbiAqIHRoZSBzY3JlZW5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY2FwdHVyZUNsaWNrcyBbZmFsc2VdIC0gV2hldGhlciB0byBjYXB0dXJlIG1vdXNlIGNsaWNrcyB3aGlsZSByZWNvcmRpbmcgdGhlXG4gKiBzY3JlZW5cbiAqIEBwcm9wZXJ0eSB7IXN0cmluZ3xudW1iZXJ9IGRldmljZUlkIC0gU2NyZWVuIGRldmljZSBpbmRleCB0byB1c2UgZm9yIHRoZSByZWNvcmRpbmcuXG4gKiBUaGUgbGlzdCBvZiBhdmFpbGFibGUgZGV2aWNlcyBjb3VsZCBiZSByZXRyaWV2ZWQgdXNpbmdcbiAqIGBmZm1wZWcgLWYgYXZmb3VuZGF0aW9uIC1saXN0X2RldmljZXMgdHJ1ZSAtaWAgY29tbWFuZC5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfG51bWJlcn0gdGltZUxpbWl0IFs2MDBdIC0gVGhlIG1heGltdW0gcmVjb3JkaW5nIHRpbWUsIGluIHNlY29uZHMuIFRoZSBkZWZhdWx0XG4gKiB2YWx1ZSBpcyA2MDAgc2Vjb25kcyAoMTAgbWludXRlcykuXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGZvcmNlUmVzdGFydCBbdHJ1ZV0gLSBXaGV0aGVyIHRvIGlnbm9yZSB0aGUgY2FsbCBpZiBhIHNjcmVlbiByZWNvcmRpbmcgaXMgY3VycmVudGx5IHJ1bm5pbmdcbiAqIChgZmFsc2VgKSBvciB0byBzdGFydCBhIG5ldyByZWNvcmRpbmcgaW1tZWRpYXRlbHkgYW5kIHRlcm1pbmF0ZSB0aGUgZXhpc3Rpbmcgb25lIGlmIHJ1bm5pbmcgKGB0cnVlYCkuXG4gKi9cblxuLyoqXG4gKiBSZWNvcmQgdGhlIGRpc3BsYXkgaW4gYmFja2dyb3VuZCB3aGlsZSB0aGUgYXV0b21hdGVkIHRlc3QgaXMgcnVubmluZy5cbiAqIFRoaXMgbWV0aG9kIHJlcXVpcmVzIEZGTVBFRyAoaHR0cHM6Ly93d3cuZmZtcGVnLm9yZy9kb3dubG9hZC5odG1sKSB0byBiZSBpbnN0YWxsZWRcbiAqIGFuZCBwcmVzZW50IGluIFBBVEguIEFsc28sIHRoZSBBcHBpdW0gcHJvY2VzcyBtdXN0IGJlIGFsbG93ZWQgdG8gYWNjZXNzIHNjcmVlbiByZWNvcmRpbmdcbiAqIGluIFN5c3RlbSBQcmVmZXJlbmNlcy0+U2VjdXJpdHkgJiBQcml2YWN5LT5TY3JlZW4gUmVjb3JkaW5nLlxuICogVGhlIHJlc3VsdGluZyB2aWRlbyB1c2VzIEgyNjQgY29kZWMgYW5kIGlzIHJlYWR5IHRvIGJlIHBsYXllZCBieSBtZWRpYSBwbGF5ZXJzIGJ1aWx0LWluIGludG8gd2ViIGJyb3dzZXJzLlxuICpcbiAqIEBwYXJhbSB7P1N0YXJ0UmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzY3JlZW4gcmVjb3JkaW5nIGhhcyBmYWlsZWQgdG8gc3RhcnQgb3IgaXMgbm90IHN1cHBvcnRlZCBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKi9cbmNvbW1hbmRzLnN0YXJ0UmVjb3JkaW5nU2NyZWVuID0gYXN5bmMgZnVuY3Rpb24gc3RhcnRSZWNvcmRpbmdTY3JlZW4gKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgdGltZUxpbWl0LFxuICAgIHZpZGVvRmlsdGVyLFxuICAgIGZwcyxcbiAgICBwcmVzZXQsXG4gICAgY2FwdHVyZUN1cnNvcixcbiAgICBjYXB0dXJlQ2xpY2tzLFxuICAgIGRldmljZUlkLFxuICAgIGZvcmNlUmVzdGFydCA9IHRydWUsXG4gIH0gPSBvcHRpb25zO1xuXG4gIGlmIChfLmlzTmlsKGRldmljZUlkKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgJ2RldmljZUlkJyBvcHRpb24gbXVzdCBiZSBwcm92aWRlZC4gUnVuICdmZm1wZWcgLWYgYXZmb3VuZGF0aW9uIC1saXN0X2RldmljZXMgdHJ1ZSAtaScgYCArXG4gICAgICAndG8gZmV0Y2ggdGhlIGxpc3Qgb2YgYXZhaWxhYmxlIGRldmljZSBpZHMnKTtcbiAgfVxuXG4gIGlmICh0aGlzLl9zY3JlZW5SZWNvcmRlcj8uaXNSdW5uaW5nPy4oKSkge1xuICAgIGxvZy5kZWJ1ZygnVGhlIHNjcmVlbiByZWNvcmRpbmcgaXMgYWxyZWFkeSBydW5uaW5nJyk7XG4gICAgaWYgKCFmb3JjZVJlc3RhcnQpIHtcbiAgICAgIGxvZy5kZWJ1ZygnRG9pbmcgbm90aGluZycpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsb2cuZGVidWcoJ0ZvcmNpbmcgdGhlIGFjdGl2ZSBzY3JlZW4gcmVjb3JkaW5nIHRvIHN0b3AnKTtcbiAgICBhd2FpdCB0aGlzLl9zY3JlZW5SZWNvcmRlci5zdG9wKHRydWUpO1xuICB9XG4gIHRoaXMuX3NjcmVlblJlY29yZGVyID0gbnVsbDtcblxuICBjb25zdCB2aWRlb1BhdGggPSBhd2FpdCB0ZW1wRGlyLnBhdGgoe1xuICAgIHByZWZpeDogdXRpbC51dWlkVjQoKS5zdWJzdHJpbmcoMCwgOCksXG4gICAgc3VmZml4OiBgLiR7REVGQVVMVF9FWFR9YCxcbiAgfSk7XG4gIHRoaXMuX3NjcmVlblJlY29yZGVyID0gbmV3IFNjcmVlblJlY29yZGVyKHZpZGVvUGF0aCwge1xuICAgIGZwczogcGFyc2VJbnQoZnBzLCAxMCksXG4gICAgdGltZUxpbWl0OiBwYXJzZUludCh0aW1lTGltaXQsIDEwKSxcbiAgICBwcmVzZXQsXG4gICAgY2FwdHVyZUN1cnNvcixcbiAgICBjYXB0dXJlQ2xpY2tzLFxuICAgIHZpZGVvRmlsdGVyLFxuICAgIGRldmljZUlkLFxuICB9KTtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLl9zY3JlZW5SZWNvcmRlci5zdGFydCgpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhpcy5fc2NyZWVuUmVjb3JkZXIgPSBudWxsO1xuICAgIHRocm93IGU7XG4gIH1cbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RvcFJlY29yZGluZ09wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcGF0aCB0byB0aGUgcmVtb3RlIGxvY2F0aW9uLCB3aGVyZSB0aGUgcmVzdWx0aW5nIHZpZGVvIHNob3VsZCBiZSB1cGxvYWRlZC5cbiAqIFRoZSBmb2xsb3dpbmcgcHJvdG9jb2xzIGFyZSBzdXBwb3J0ZWQ6IGh0dHAvaHR0cHMsIGZ0cC5cbiAqIE51bGwgb3IgZW1wdHkgc3RyaW5nIHZhbHVlICh0aGUgZGVmYXVsdCBzZXR0aW5nKSBtZWFucyB0aGUgY29udGVudCBvZiByZXN1bHRpbmdcbiAqIGZpbGUgc2hvdWxkIGJlIGVuY29kZWQgYXMgQmFzZTY0IGFuZCBwYXNzZWQgYXMgdGhlIGVuZHBvaW50IHJlc3BvbnNlIHZhbHVlLlxuICogQW4gZXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duIGlmIHRoZSBnZW5lcmF0ZWQgbWVkaWEgZmlsZSBpcyB0b28gYmlnIHRvXG4gKiBmaXQgaW50byB0aGUgYXZhaWxhYmxlIHByb2Nlc3MgbWVtb3J5LlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB1c2VyIC0gVGhlIG5hbWUgb2YgdGhlIHVzZXIgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBhc3MgLSBUaGUgcGFzc3dvcmQgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG1ldGhvZCAtIFRoZSBodHRwIG11bHRpcGFydCB1cGxvYWQgbWV0aG9kIG5hbWUuIFRoZSAnUFVUJyBvbmUgaXMgdXNlZCBieSBkZWZhdWx0LlxuICogQHByb3BlcnR5IHs/T2JqZWN0fSBoZWFkZXJzIC0gQWRkaXRpb25hbCBoZWFkZXJzIG1hcHBpbmcgZm9yIG11bHRpcGFydCBodHRwKHMpIHVwbG9hZHNcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gZmlsZUZpZWxkTmFtZSBbZmlsZV0gLSBUaGUgbmFtZSBvZiB0aGUgZm9ybSBmaWVsZCwgd2hlcmUgdGhlIGZpbGUgY29udGVudCBCTE9CIHNob3VsZCBiZSBzdG9yZWQgZm9yXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cChzKSB1cGxvYWRzXG4gKiBAcHJvcGVydHkgez9PYmplY3R8QXJyYXk8UGFpcj59IGZvcm1GaWVsZHMgLSBBZGRpdGlvbmFsIGZvcm0gZmllbGRzIGZvciBtdWx0aXBhcnQgaHR0cChzKSB1cGxvYWRzXG4gKi9cblxuLyoqXG4gKiBTdG9wIHJlY29yZGluZyB0aGUgc2NyZWVuLlxuICogSWYgbm8gc2NyZWVuIHJlY29yZGluZyBoYXMgYmVlbiBzdGFydGVkIGJlZm9yZSB0aGVuIHRoZSBtZXRob2QgcmV0dXJucyBhbiBlbXB0eSBzdHJpbmcuXG4gKlxuICogQHBhcmFtIHs/U3RvcFJlY29yZGluZ09wdGlvbnN9IG9wdGlvbnMgLSBUaGUgYXZhaWxhYmxlIG9wdGlvbnMuXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBCYXNlNjQtZW5jb2RlZCBjb250ZW50IG9mIHRoZSByZWNvcmRlZCBtZWRpYSBmaWxlIGlmICdyZW1vdGVQYXRoJ1xuICogcGFyYW1ldGVyIGlzIGZhbHN5IG9yIGFuIGVtcHR5IHN0cmluZy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgZ2V0dGluZyB0aGUgbmFtZSBvZiBhIG1lZGlhIGZpbGVcbiAqIG9yIHRoZSBmaWxlIGNvbnRlbnQgY2Fubm90IGJlIHVwbG9hZGVkIHRvIHRoZSByZW1vdGUgbG9jYXRpb25cbiAqIG9yIHNjcmVlbiByZWNvcmRpbmcgaXMgbm90IHN1cHBvcnRlZCBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKi9cbmNvbW1hbmRzLnN0b3BSZWNvcmRpbmdTY3JlZW4gPSBhc3luYyBmdW5jdGlvbiBzdG9wUmVjb3JkaW5nU2NyZWVuIChvcHRpb25zID0ge30pIHtcbiAgaWYgKCF0aGlzLl9zY3JlZW5SZWNvcmRlcikge1xuICAgIGxvZy5kZWJ1ZygnTm8gc2NyZWVuIHJlY29yZGluZyBoYXMgYmVlbiBzdGFydGVkLiBEb2luZyBub3RoaW5nJyk7XG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgbG9nLmRlYnVnKCdSZXRyaWV2aW5nIHRoZSByZXN1bHRpbmcgdmlkZW8gZGF0YScpO1xuICBjb25zdCB2aWRlb1BhdGggPSBhd2FpdCB0aGlzLl9zY3JlZW5SZWNvcmRlci5zdG9wKCk7XG4gIGlmICghdmlkZW9QYXRoKSB7XG4gICAgbG9nLmRlYnVnKCdObyB2aWRlbyBkYXRhIGlzIGZvdW5kLiBSZXR1cm5pbmcgYW4gZW1wdHkgc3RyaW5nJyk7XG4gICAgcmV0dXJuICcnO1xuICB9XG4gIHJldHVybiBhd2FpdCB1cGxvYWRSZWNvcmRlZE1lZGlhKHZpZGVvUGF0aCwgb3B0aW9ucy5yZW1vdGVQYXRoLCBvcHRpb25zKTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvcmVjb3JkLXNjcmVlbi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
