"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.REQ_A4M_APP_PATH = exports.A4M_APP_BUNDLE_ID = exports.DEFAULT_A4M_PORT = exports.DEFAULT_A4M_HOST = exports.AppiumForMac = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _logger = _interopRequireDefault(require("./logger"));

var _teen_process = require("teen_process");

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

const DEFAULT_A4M_HOST = '127.0.0.1';
exports.DEFAULT_A4M_HOST = DEFAULT_A4M_HOST;
const DEFAULT_A4M_PORT = 4622;
exports.DEFAULT_A4M_PORT = DEFAULT_A4M_PORT;
const REQ_A4M_APP_PATH = '/Applications/AppiumForMac.app';
exports.REQ_A4M_APP_PATH = REQ_A4M_APP_PATH;
const A4M_APP_BUNDLE_ID = 'com.appium.AppiumForMac';
exports.A4M_APP_BUNDLE_ID = A4M_APP_BUNDLE_ID;

const a4mLog = _appiumSupport.logger.getLogger('Appium4Mac');

class AppiumForMac {
  constructor(opts = {}) {
    this.proxyHost = opts.a4mHost;
    this.proxyPort = opts.a4mPort;
    this.a4mAppPath = opts.a4mAppPath;
    this.killAllA4MAppBeforeStart = opts.killAllA4MAppBeforeStart || true;
    this.proc = null;
    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.proxyHost,
      port: this.proxyPort
    });
  }

  async start() {
    if (!(await _appiumSupport.fs.exists(this.a4mAppPath))) {
      throw new Error(`Could not verify AppiumForMacDriver install in '${this.a4mAppPath}'; please install it to '${this.a4mAppPath}'`);
    }

    const startDetector = (stdout, stderr) => stderr.includes('Started HTTP server');

    let processIsAlive = false;

    try {
      if (this.killAllA4MAppBeforeStart) {
        await this.killAll();
      }

      const a4mBinary = _path.default.resolve(this.a4mAppPath, 'Contents', 'MacOS', 'AppiumForMac');

      this.proc = new _teen_process.SubProcess(a4mBinary, []);
      processIsAlive = true;

      for (let stream of ['STDOUT', 'STDERR']) {
        this.proc.on(`lines-${stream.toLowerCase()}`, lines => {
          for (let l of lines) {
            a4mLog.info(`[${stream}] ${l.trim()}`);
          }
        });
      }

      this.proc.on('exit', (code, signal) => {
        processIsAlive = false;
        let msg = `AppiumForMac exited unexpectedly with code ${code}, ` + `signal ${signal}`;

        _logger.default.error(msg);
      });

      _logger.default.info(`Spawning AppiumForMac with: ${this.a4mAppPath}`);

      await this.proc.start(startDetector);
      await this.waitForOnline();
    } catch (e) {
      this.emit(AppiumForMac.EVENT_ERROR, e);

      if (processIsAlive) {
        await this.proc.stop();
      }

      _logger.default.errorAndThrow(e);
    }
  }

  sessionId() {
    if (this.state !== AppiumForMac.STATE_ONLINE) {
      return null;
    }

    return this.jwproxy.sessionId;
  }

  async waitForOnline() {
    return true;
  }

  async getStatus() {
    return await this.sendCommand('/status', 'GET');
  }

  async startSession(caps) {
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    await this.sendCommand('/session', 'POST', {
      desiredCapabilities: caps
    });
  }

  async stop() {
    try {
      if (this.proc) {
        await this.proc.stop();
      }
    } catch (e) {
      _logger.default.error(e);
    }
  }

  async sendCommand(url, method, body) {
    let res;

    try {
      res = await this.jwproxy.command(url, method, body);
    } catch (e) {
      if (e.message.indexOf('Did not get a valid response object') === -1 || e.message.indexOf('value') !== -1) {
        throw e;
      }
    }

    return res;
  }

  async proxyReq(req, res) {
    return await this.jwproxy.proxyReqRes(req, res);
  }

  async killAll() {
    const processName = 'AppiumForMac';

    _logger.default.info(`Killing any old AppiumForMac`);

    await _appiumSupport.process.killProcess(processName);

    _logger.default.info('Successfully cleaned up old Appium4Mac servers');
  }

  async deleteSession() {
    _logger.default.debug('Deleting AppiumForMac server session');

    try {
      await this.sendCommand('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation AppiumForMac deleteSession worked; ` + `Error was: ${err}`);
    }
  }

}

exports.AppiumForMac = AppiumForMac;
var _default = AppiumForMac;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hcHBpdW0tZm9yLW1hYy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX0E0TV9IT1NUIiwiREVGQVVMVF9BNE1fUE9SVCIsIlJFUV9BNE1fQVBQX1BBVEgiLCJBNE1fQVBQX0JVTkRMRV9JRCIsImE0bUxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIkFwcGl1bUZvck1hYyIsImNvbnN0cnVjdG9yIiwib3B0cyIsInByb3h5SG9zdCIsImE0bUhvc3QiLCJwcm94eVBvcnQiLCJhNG1Qb3J0IiwiYTRtQXBwUGF0aCIsImtpbGxBbGxBNE1BcHBCZWZvcmVTdGFydCIsInByb2MiLCJqd3Byb3h5IiwiSldQcm94eSIsInNlcnZlciIsInBvcnQiLCJzdGFydCIsImZzIiwiZXhpc3RzIiwiRXJyb3IiLCJzdGFydERldGVjdG9yIiwic3Rkb3V0Iiwic3RkZXJyIiwiaW5jbHVkZXMiLCJwcm9jZXNzSXNBbGl2ZSIsImtpbGxBbGwiLCJhNG1CaW5hcnkiLCJwYXRoIiwicmVzb2x2ZSIsIlN1YlByb2Nlc3MiLCJzdHJlYW0iLCJvbiIsInRvTG93ZXJDYXNlIiwibGluZXMiLCJsIiwiaW5mbyIsInRyaW0iLCJjb2RlIiwic2lnbmFsIiwibXNnIiwibG9nIiwiZXJyb3IiLCJ3YWl0Rm9yT25saW5lIiwiZSIsImVtaXQiLCJFVkVOVF9FUlJPUiIsInN0b3AiLCJlcnJvckFuZFRocm93Iiwic2Vzc2lvbklkIiwic3RhdGUiLCJTVEFURV9PTkxJTkUiLCJnZXRTdGF0dXMiLCJzZW5kQ29tbWFuZCIsInN0YXJ0U2Vzc2lvbiIsImNhcHMiLCJwcm94eVJlcVJlcyIsImJpbmQiLCJkZXNpcmVkQ2FwYWJpbGl0aWVzIiwidXJsIiwibWV0aG9kIiwiYm9keSIsInJlcyIsImNvbW1hbmQiLCJtZXNzYWdlIiwiaW5kZXhPZiIsInByb3h5UmVxIiwicmVxIiwicHJvY2Vzc05hbWUiLCJwcm9jZXNzIiwia2lsbFByb2Nlc3MiLCJkZWxldGVTZXNzaW9uIiwiZGVidWciLCJlcnIiLCJ3YXJu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aXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgU3ViUHJvY2VzcyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBmcywgbG9nZ2VyLCBwcm9jZXNzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbmNvbnN0IERFRkFVTFRfQTRNX0hPU1QgPSAnMTI3LjAuMC4xJztcbmNvbnN0IERFRkFVTFRfQTRNX1BPUlQgPSA0NjIyO1xuXG5jb25zdCBSRVFfQTRNX0FQUF9QQVRIID0gJy9BcHBsaWNhdGlvbnMvQXBwaXVtRm9yTWFjLmFwcCc7XG5jb25zdCBBNE1fQVBQX0JVTkRMRV9JRCA9ICdjb20uYXBwaXVtLkFwcGl1bUZvck1hYyc7XG5cbmNvbnN0IGE0bUxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ0FwcGl1bTRNYWMnKTtcblxuY2xhc3MgQXBwaXVtRm9yTWFjIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIHRoaXMucHJveHlIb3N0ID0gb3B0cy5hNG1Ib3N0O1xuICAgIHRoaXMucHJveHlQb3J0ID0gb3B0cy5hNG1Qb3J0O1xuICAgIHRoaXMuYTRtQXBwUGF0aCA9IG9wdHMuYTRtQXBwUGF0aDtcbiAgICB0aGlzLmtpbGxBbGxBNE1BcHBCZWZvcmVTdGFydCA9IG9wdHMua2lsbEFsbEE0TUFwcEJlZm9yZVN0YXJ0IHx8IHRydWU7XG4gICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICB0aGlzLmp3cHJveHkgPSBuZXcgSldQcm94eSh7c2VydmVyOiB0aGlzLnByb3h5SG9zdCwgcG9ydDogdGhpcy5wcm94eVBvcnR9KTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0ICgpIHtcbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyh0aGlzLmE0bUFwcFBhdGgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCB2ZXJpZnkgQXBwaXVtRm9yTWFjRHJpdmVyIGluc3RhbGwgaW4gJyR7dGhpcy5hNG1BcHBQYXRofSc7IHBsZWFzZSBpbnN0YWxsIGl0IHRvICcke3RoaXMuYTRtQXBwUGF0aH0nYCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhcnREZXRlY3RvciA9IChzdGRvdXQsIHN0ZGVycikgPT4gc3RkZXJyLmluY2x1ZGVzKCdTdGFydGVkIEhUVFAgc2VydmVyJyk7XG5cbiAgICBsZXQgcHJvY2Vzc0lzQWxpdmUgPSBmYWxzZTtcbiAgICB0cnkge1xuICAgICAgaWYgKHRoaXMua2lsbEFsbEE0TUFwcEJlZm9yZVN0YXJ0KSB7XG4gICAgICAgIGF3YWl0IHRoaXMua2lsbEFsbCgpO1xuICAgICAgfVxuXG4gICAgICAvLyBzZXQgdXAgb3VyIHN1YnByb2Nlc3Mgb2JqZWN0XG4gICAgICBjb25zdCBhNG1CaW5hcnkgPSBwYXRoLnJlc29sdmUodGhpcy5hNG1BcHBQYXRoLCAnQ29udGVudHMnLCAnTWFjT1MnLCAnQXBwaXVtRm9yTWFjJyk7XG4gICAgICB0aGlzLnByb2MgPSBuZXcgU3ViUHJvY2VzcyhhNG1CaW5hcnksIFtdKTtcbiAgICAgIHByb2Nlc3NJc0FsaXZlID0gdHJ1ZTtcblxuICAgICAgLy8gaGFuZGxlIGxvZyBvdXRwdXRcbiAgICAgIGZvciAobGV0IHN0cmVhbSBvZiBbJ1NURE9VVCcsICdTVERFUlInXSkge1xuICAgICAgICB0aGlzLnByb2Mub24oYGxpbmVzLSR7c3RyZWFtLnRvTG93ZXJDYXNlKCl9YCwgKGxpbmVzKSA9PiB7XG4gICAgICAgICAgZm9yIChsZXQgbCBvZiBsaW5lcykge1xuICAgICAgICAgICAgYTRtTG9nLmluZm8oYFske3N0cmVhbX1dICR7bC50cmltKCl9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gaGFuZGxlIG91dC1vZi1ib3VuZCBleGl0IGJ5IHNpbXBseSBsb2dnaW5nXG4gICAgICAvLyBUT0RPIGFkZCBhYmlsaXR5IGZvciBkcml2ZXIgdG8gaGFuZGxlIHRoaXMgZ3JhY2VmdWxseSBhbmQgbWF5YmVcbiAgICAgIC8vIHJlc3RhcnRcbiAgICAgIHRoaXMucHJvYy5vbignZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgICAgcHJvY2Vzc0lzQWxpdmUgPSBmYWxzZTtcbiAgICAgICAgbGV0IG1zZyA9IGBBcHBpdW1Gb3JNYWMgZXhpdGVkIHVuZXhwZWN0ZWRseSB3aXRoIGNvZGUgJHtjb2RlfSwgYCArXG4gICAgICAgICAgICAgICAgICBgc2lnbmFsICR7c2lnbmFsfWA7XG4gICAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgfSk7XG4gICAgICBsb2cuaW5mbyhgU3Bhd25pbmcgQXBwaXVtRm9yTWFjIHdpdGg6ICR7dGhpcy5hNG1BcHBQYXRofWApO1xuXG4gICAgICAvLyBzdGFydCBzdWJwcm9jIGFuZCB3YWl0IGZvciBzdGFydERldGVjdG9yXG4gICAgICBhd2FpdCB0aGlzLnByb2Muc3RhcnQoc3RhcnREZXRlY3Rvcik7XG5cbiAgICAgIGF3YWl0IHRoaXMud2FpdEZvck9ubGluZSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuZW1pdChBcHBpdW1Gb3JNYWMuRVZFTlRfRVJST1IsIGUpO1xuICAgICAgLy8ganVzdCBiZWNhdXNlIHdlIGhhZCBhbiBlcnJvciBkb2Vzbid0IG1lYW4gdGhlIHdpbmFwcGRyaXZlciBwcm9jZXNzXG4gICAgICAvLyBmaW5pc2hlZDsgd2Ugc2hvdWxkIGNsZWFuIHVwIGlmIG5lY2Vzc2FyeVxuICAgICAgaWYgKHByb2Nlc3NJc0FsaXZlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvYy5zdG9wKCk7XG4gICAgICB9XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhlKTtcbiAgICB9XG4gIH1cblxuICBzZXNzaW9uSWQgKCkge1xuICAgIGlmICh0aGlzLnN0YXRlICE9PSBBcHBpdW1Gb3JNYWMuU1RBVEVfT05MSU5FKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5qd3Byb3h5LnNlc3Npb25JZDtcbiAgfVxuXG4gIGFzeW5jIHdhaXRGb3JPbmxpbmUgKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgICAvLyBUT0RPOiBBY3R1YWxseSBjaGVjayB2aWEgSFRUUFxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgYXN5bmMgZ2V0U3RhdHVzICgpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kQ29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoY2Fwcykge1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuICAgIGF3YWl0IHRoaXMuc2VuZENvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCB7ZGVzaXJlZENhcGFiaWxpdGllczogY2Fwc30pO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0aGlzLnByb2MpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm9jLnN0b3AoKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cuZXJyb3IoZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VuZENvbW1hbmQgKHVybCwgbWV0aG9kLCBib2R5KSB7XG4gICAgbGV0IHJlcztcbiAgICAvLyBuZWVkIHRvIGNvdmVyIG92ZXIgQTRNJ3MgYmFkIGhhbmRsaW5nIG9mIHJlc3BvbnNlcywgd2hpY2ggc29tZXRpbWVzXG4gICAgLy8gZG9uJ3QgaGF2ZSAndmFsdWUnIHByb3BlcnRpZXNcbiAgICB0cnkge1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlLm1lc3NhZ2UuaW5kZXhPZignRGlkIG5vdCBnZXQgYSB2YWxpZCByZXNwb25zZSBvYmplY3QnKSA9PT0gLTEgfHxcbiAgICAgICAgICBlLm1lc3NhZ2UuaW5kZXhPZigndmFsdWUnKSAhPT0gLTEpIHtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIGFzeW5jIHByb3h5UmVxIChyZXEsIHJlcykge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMocmVxLCByZXMpO1xuICB9XG5cbiAgYXN5bmMga2lsbEFsbCAoKSB7XG4gICAgY29uc3QgcHJvY2Vzc05hbWUgPSAnQXBwaXVtRm9yTWFjJztcbiAgICAvLyBqcyBoaW50IGNhbm5vdCBoYW5kbGUgYmFja3RpY2tzLCBldmVuIGVzY2FwZWQsIHdpdGhpbiB0ZW1wbGF0ZSBsaXRlcmFsc1xuICAgIGxvZy5pbmZvKGBLaWxsaW5nIGFueSBvbGQgQXBwaXVtRm9yTWFjYCk7XG4gICAgYXdhaXQgcHJvY2Vzcy5raWxsUHJvY2Vzcyhwcm9jZXNzTmFtZSk7XG4gICAgbG9nLmluZm8oJ1N1Y2Nlc3NmdWxseSBjbGVhbmVkIHVwIG9sZCBBcHBpdW00TWFjIHNlcnZlcnMnKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZy5kZWJ1ZygnRGVsZXRpbmcgQXBwaXVtRm9yTWFjIHNlcnZlciBzZXNzaW9uJyk7XG4gICAgLy8gcmVseSBvbiBqd3Byb3h5J3MgaW50ZWxsaWdlbmNlIHRvIGtub3cgd2hhdCB3ZSdyZSB0YWxraW5nIGFib3V0IGFuZFxuICAgIC8vIGRlbGV0ZSB0aGUgY3VycmVudCBzZXNzaW9uXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuc2VuZENvbW1hbmQoJy8nLCAnREVMRVRFJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIEFwcGl1bUZvck1hYyBkZWxldGVTZXNzaW9uIHdvcmtlZDsgYCArXG4gICAgICAgIGBFcnJvciB3YXM6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBBcHBpdW1Gb3JNYWMsIERFRkFVTFRfQTRNX0hPU1QsIERFRkFVTFRfQTRNX1BPUlQsXG4gIEE0TV9BUFBfQlVORExFX0lELCBSRVFfQTRNX0FQUF9QQVRIIH07XG5leHBvcnQgZGVmYXVsdCBBcHBpdW1Gb3JNYWM7XG4iXSwiZmlsZSI6ImxpYi9hcHBpdW0tZm9yLW1hYy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
