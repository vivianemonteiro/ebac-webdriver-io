"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _iosDeploy = _interopRequireDefault(require("./ios-deploy"));

var _utils = require("./utils");

var _basedevice = _interopRequireDefault(require("./basedevice"));

class TvOs extends _basedevice.default {
  constructor() {
    super();
    this.bundleId;
    this.caps;
    this.iosdeploy;
    this.driver;
  }

  async execScript(script) {
    let shell = require('shelljs');

    script += ` --id ${this.caps.udid}`;

    _logger.default.info(`script: ${script}`);

    try {
      return await shell.exec(script);
    } catch (err) {
      _logger.default.debug(`Stdout: '${err.stdout}'. Stderr: '${err.stderr}'.`);

      throw new Error(`Could not run '${script}': '${err.message}'`);
    }
  }

  async closeApp() {
    _logger.default.info(`tvOS: Close App`);

    let commandObject = {
      name: 'CloseApp'
    };
    let commandJSON = JSON.stringify(commandObject);
    let data = await this.driver.executeSocketCommand(commandJSON);
    let result;

    try {
      result = JSON.parse(data);
    } catch (e) {
      throw new Error('Bad response from CloseApp');
    }

    if (result.status === _utils.youiEngineDriverReturnValues.WEBDRIVER_UNKNOWN_COMMAND) {
      throw new Error('This command is only supported in You.i Engine v5.1.0+');
    }
  }

  async endSession() {
    _logger.default.info(`tvOS: End Session`);

    if (this.caps.fullReset) {
      await this.removeApp(this.bundleId);
    } else {
      await this.closeApp();
    }
  }

  async installApp(appPath) {
    _logger.default.info(`tvOS: Installing and launching app`);

    await this.iosdeploy.installApp(appPath);
  }

  async isAppInstalled(bundleId) {
    _logger.default.info(`tvOS: Check if App is installed`);

    return await this.iosdeploy.isAppInstalled(bundleId);
  }

  async launchApp() {
    _logger.default.info(`tvOS: Launching app`);

    await this.iosdeploy.launchApp(this.caps.app);
  }

  async removeApp(bundleId) {
    _logger.default.info(`tvOS: Deleting app`);

    await this.iosdeploy.removeApp(bundleId);
  }

  async startSession(caps, driver) {
    _logger.default.info(`tvOS: Start Session`);

    this.caps = caps;
    this.driver = driver;
    this.iosdeploy = new _iosDeploy.default(caps.udid);
    await this.iosdeploy.checkStatus();

    let shell = require('shelljs');

    this.bundleId = await shell.exec(`osascript -e 'id of app "${caps.app}"'`).replace(/(\r\n|\n|\r)/gm, '');
    let devAppInstalled = await this.isAppInstalled(this.bundleId);

    if (caps.fullReset || !devAppInstalled) {
      await this.installApp(caps.app);
    } else {
      await this.launchApp();
    }
  }

}

var _default = TvOs;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90dm9zLmpzIl0sIm5hbWVzIjpbIlR2T3MiLCJCYXNlRGV2aWNlIiwiY29uc3RydWN0b3IiLCJidW5kbGVJZCIsImNhcHMiLCJpb3NkZXBsb3kiLCJkcml2ZXIiLCJleGVjU2NyaXB0Iiwic2NyaXB0Iiwic2hlbGwiLCJyZXF1aXJlIiwidWRpZCIsImxvZ2dlciIsImluZm8iLCJleGVjIiwiZXJyIiwiZGVidWciLCJzdGRvdXQiLCJzdGRlcnIiLCJFcnJvciIsIm1lc3NhZ2UiLCJjbG9zZUFwcCIsImNvbW1hbmRPYmplY3QiLCJuYW1lIiwiY29tbWFuZEpTT04iLCJKU09OIiwic3RyaW5naWZ5IiwiZGF0YSIsImV4ZWN1dGVTb2NrZXRDb21tYW5kIiwicmVzdWx0IiwicGFyc2UiLCJlIiwic3RhdHVzIiwieW91aUVuZ2luZURyaXZlclJldHVyblZhbHVlcyIsIldFQkRSSVZFUl9VTktOT1dOX0NPTU1BTkQiLCJlbmRTZXNzaW9uIiwiZnVsbFJlc2V0IiwicmVtb3ZlQXBwIiwiaW5zdGFsbEFwcCIsImFwcFBhdGgiLCJpc0FwcEluc3RhbGxlZCIsImxhdW5jaEFwcCIsImFwcCIsInN0YXJ0U2Vzc2lvbiIsIklPU0RlcGxveSIsImNoZWNrU3RhdHVzIiwicmVwbGFjZSIsImRldkFwcEluc3RhbGxlZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxJQUFOLFNBQW1CQyxtQkFBbkIsQ0FBOEI7QUFFNUJDLEVBQUFBLFdBQVcsR0FBSTtBQUNiO0FBQ0EsU0FBS0MsUUFBTDtBQUNBLFNBQUtDLElBQUw7QUFDQSxTQUFLQyxTQUFMO0FBQ0EsU0FBS0MsTUFBTDtBQUNEOztBQUVlLFFBQVZDLFVBQVUsQ0FBRUMsTUFBRixFQUFVO0FBQ3hCLFFBQUlDLEtBQUssR0FBR0MsT0FBTyxDQUFDLFNBQUQsQ0FBbkI7O0FBQ0FGLElBQUFBLE1BQU0sSUFBSyxTQUFRLEtBQUtKLElBQUwsQ0FBVU8sSUFBSyxF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TixDQUFZLDRCQUEyQlYsSUFBSSxDQUFDc0MsR0FBSSxJQUFoRCxFQUFxREksT0FBckQsQ0FBNkQsZ0JBQTdELEVBQStFLEVBQS9FLENBQXRCO0FBQ0EsUUFBSUMsZUFBZSxHQUFHLE1BQU0sS0FBS1AsY0FBTCxDQUFvQixLQUFLckMsUUFBekIsQ0FBNUI7O0FBQ0EsUUFBSUMsSUFBSSxDQUFDZ0MsU0FBTCxJQUFrQixDQUFDVyxlQUF2QixFQUF3QztBQUN0QyxZQUFNLEtBQUtULFVBQUwsQ0FBZ0JsQyxJQUFJLENBQUNzQyxHQUFyQixDQUFOO0FBRUQsS0FIRCxNQUdPO0FBQ0wsWUFBTSxLQUFLRCxTQUFMLEVBQU47QUFDRDtBQUNGOztBQTFGMkI7O2VBNkZmekMsSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IElPU0RlcGxveSBmcm9tICcuL2lvcy1kZXBsb3knO1xuaW1wb3J0IHsgeW91aUVuZ2luZURyaXZlclJldHVyblZhbHVlcyB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IEJhc2VEZXZpY2UgZnJvbSAnLi9iYXNlZGV2aWNlJztcblxuY2xhc3MgVHZPcyBleHRlbmRzIEJhc2VEZXZpY2Uge1xuXG4gIGNvbnN0cnVjdG9yICgpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuYnVuZGxlSWQ7XG4gICAgdGhpcy5jYXBzO1xuICAgIHRoaXMuaW9zZGVwbG95O1xuICAgIHRoaXMuZHJpdmVyO1xuICB9XG5cbiAgYXN5bmMgZXhlY1NjcmlwdCAoc2NyaXB0KSB7XG4gICAgbGV0IHNoZWxsID0gcmVxdWlyZSgnc2hlbGxqcycpO1xuICAgIHNjcmlwdCArPSBgIC0taWQgJHt0aGlzLmNhcHMudWRpZH1gO1xuICAgIGxvZ2dlci5pbmZvKGBzY3JpcHQ6ICR7c2NyaXB0fWApO1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgc2hlbGwuZXhlYyhzY3JpcHQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBTdGRvdXQ6ICcke2Vyci5zdGRvdXR9Jy4gU3RkZXJyOiAnJHtlcnIuc3RkZXJyfScuYCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBydW4gJyR7c2NyaXB0fSc6ICcke2Vyci5tZXNzYWdlfSdgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjbG9zZUFwcCAoKSB7XG4gICAgbG9nZ2VyLmluZm8oYHR2T1M6IENsb3NlIEFwcGApO1xuICAgIGxldCBjb21tYW5kT2JqZWN0ID0ge1xuICAgICAgbmFtZTogJ0Nsb3NlQXBwJ1xuICAgIH07XG4gICAgbGV0IGNvbW1hbmRKU09OID0gSlNPTi5zdHJpbmdpZnkoY29tbWFuZE9iamVjdCk7XG4gICAgbGV0IGRhdGEgPSBhd2FpdCB0aGlzLmRyaXZlci5leGVjdXRlU29ja2V0Q29tbWFuZChjb21tYW5kSlNPTik7XG4gICAgbGV0IHJlc3VsdDtcblxuICAgIHRyeSB7XG4gICAgICByZXN1bHQgPSBKU09OLnBhcnNlKGRhdGEpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQmFkIHJlc3BvbnNlIGZyb20gQ2xvc2VBcHAnKTtcbiAgICB9XG4gICAgLy8gZ2V0IHN0YXR1cyByZXR1cm5lZCBhbmQgaGFuZGxlIGVycm9ycyByZXR1cm5lZCBmcm9tIHNlcnZlclxuICAgIGlmIChyZXN1bHQuc3RhdHVzID09PSB5b3VpRW5naW5lRHJpdmVyUmV0dXJuVmFsdWVzLldFQkRSSVZFUl9VTktOT1dOX0NPTU1BTkQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGhpcyBjb21tYW5kIGlzIG9ubHkgc3VwcG9ydGVkIGluIFlvdS5pIEVuZ2luZSB2NS4xLjArJyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZW5kU2Vzc2lvbiAoKSB7XG4gICAgbG9nZ2VyLmluZm8oYHR2T1M6IEVuZCBTZXNzaW9uYCk7XG4gICAgLy8gSWYgbXVsdGlwbGUgYXBwcyB3aXRoIG91ciBzb2NrZXQgYXJlIGluc3RhbGxlZCwgaXQgd2lsbCBjb25uZWN0IHRvIHRoZSBmaXJzdCBhcHAgaW5zdGFsbGVkLlxuICAgIC8vIEZvciB0aGlzIHJlYXNvbiwgZXZlcnkgYXBwIHNob3VsZCBiZSB1bmluc3RhbGxlZCBhZnRlciBydW5uaW5nLlxuICAgIGlmICh0aGlzLmNhcHMuZnVsbFJlc2V0KSB7XG4gICAgICBhd2FpdCB0aGlzLnJlbW92ZUFwcCh0aGlzLmJ1bmRsZUlkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy5jbG9zZUFwcCgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxBcHAgKGFwcFBhdGgpIHtcbiAgICBsb2dnZXIuaW5mbyhgdHZPUzogSW5zdGFsbGluZyBhbmQgbGF1bmNoaW5nIGFwcGApO1xuICAgIGF3YWl0IHRoaXMuaW9zZGVwbG95Lmluc3RhbGxBcHAoYXBwUGF0aCk7XG4gIH1cblxuICBhc3luYyBpc0FwcEluc3RhbGxlZCAoYnVuZGxlSWQpIHtcbiAgICBsb2dnZXIuaW5mbyhgdHZPUzogQ2hlY2sgaWYgQXBwIGlzIGluc3RhbGxlZGApO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmlvc2RlcGxveS5pc0FwcEluc3RhbGxlZChidW5kbGVJZCk7XG4gIH1cblxuICBhc3luYyBsYXVuY2hBcHAgKCkge1xuICAgIGxvZ2dlci5pbmZvKGB0dk9TOiBMYXVuY2hpbmcgYXBwYCk7XG4gICAgYXdhaXQgdGhpcy5pb3NkZXBsb3kubGF1bmNoQXBwKHRoaXMuY2Fwcy5hcHApO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlQXBwIChidW5kbGVJZCkge1xuICAgIGxvZ2dlci5pbmZvKGB0dk9TOiBEZWxldGluZyBhcHBgKTtcbiAgICBhd2FpdCB0aGlzLmlvc2RlcGxveS5yZW1vdmVBcHAoYnVuZGxlSWQpO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXNzaW9uIChjYXBzLCBkcml2ZXIpIHtcbiAgICBsb2dnZXIuaW5mbyhgdHZPUzogU3RhcnQgU2Vzc2lvbmApO1xuICAgIHRoaXMuY2FwcyA9IGNhcHM7XG4gICAgdGhpcy5kcml2ZXIgPSBkcml2ZXI7XG4gICAgdGhpcy5pb3NkZXBsb3kgPSBuZXcgSU9TRGVwbG95KGNhcHMudWRpZCk7XG4gICAgYXdhaXQgdGhpcy5pb3NkZXBsb3kuY2hlY2tTdGF0dXMoKTtcblxuICAgIC8vIENoZWNrIGlmIGFwcCBpcyBpbnN0YWxsZWRcbiAgICBsZXQgc2hlbGwgPSByZXF1aXJlKCdzaGVsbGpzJyk7XG4gICAgdGhpcy5idW5kbGVJZCA9IGF3YWl0IHNoZWxsLmV4ZWMoYG9zYXNjcmlwdCAtZSAnaWQgb2YgYXBwIFwiJHtjYXBzLmFwcH1cIidgKS5yZXBsYWNlKC8oXFxyXFxufFxcbnxcXHIpL2dtLCAnJyk7XG4gICAgbGV0IGRldkFwcEluc3RhbGxlZCA9IGF3YWl0IHRoaXMuaXNBcHBJbnN0YWxsZWQodGhpcy5idW5kbGVJZCk7XG4gICAgaWYgKGNhcHMuZnVsbFJlc2V0IHx8ICFkZXZBcHBJbnN0YWxsZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuaW5zdGFsbEFwcChjYXBzLmFwcCk7XG4gICAgICAvL2F3YWl0IHRoaXMubGF1bmNoQXBwKGNhcHMuYXBwKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy5sYXVuY2hBcHAoKTtcbiAgICB9XG4gIH1cblxufVxuZXhwb3J0IGRlZmF1bHQgVHZPcztcbiJdLCJmaWxlIjoibGliL3R2b3MuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
