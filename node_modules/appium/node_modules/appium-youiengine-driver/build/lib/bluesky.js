"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _basedevice = _interopRequireDefault(require("./basedevice"));

var _asyncbox = require("asyncbox");

class BlueSky extends _basedevice.default {
  constructor() {
    super();
    this.channelId;
    this.caps;
    this.shell;
  }

  async closeApp() {
    _logger.default.info(`BlueSky: Close App`);

    await this.shell.exec(`curl -d '' http://${this.caps.youiEngineAppAddress}:8060/keypress/home`);
    let activeApp;

    do {
      await (0, _asyncbox.sleep)(1000);
      activeApp = await this.shell.exec(`curl http://${this.caps.youiEngineAppAddress}:8060/query/active-app`);
    } while (!activeApp.includes(`<app>Roku</app>`));
  }

  async endSession() {
    _logger.default.info(`BlueSky: End Session`);

    if (this.caps.fullReset) {
      await this.removeApp(this.channelId);
    } else {
      await this.closeApp();
    }
  }

  async installApp(appPath) {
    _logger.default.info(`BlueSky: Installing and launching app`);

    if (await this.isAppInstalled(this.channelId)) {
      await this.removeApp(this.channelId);
    }

    await this.shell.exec(`curl -v -# -f -i --user '${this.caps.username}:${this.caps.password}' --digest --progress-bar -F 'mysubmit=Install' -F 'archive=@${appPath}' -F 'passwd=' http://${this.caps.youiEngineAppAddress}/plugin_install | grep '<font color' | sed 's/<font color=\'red\'>//' `);
    await this.launchApp();
  }

  async isAppInstalled(channelId = this.channelId) {
    _logger.default.info(`BlueSky: Check if App is installed`);

    let devAppInstalled = false;
    let installedApps = await this.shell.exec(`curl http://${this.caps.youiEngineAppAddress}:8060/query/apps`);

    if (installedApps.includes(`id="${channelId}"`)) {
      devAppInstalled = true;
    }

    return devAppInstalled;
  }

  async launchApp() {
    _logger.default.info(`BlueSky: Launch app`);

    let activeApp;

    do {
      await (0, _asyncbox.sleep)(5000);
      await this.shell.exec(`curl -d '' http://${this.caps.youiEngineAppAddress}:8060/launch/${this.channelId}`);
      activeApp = await this.shell.exec(`curl http://${this.caps.youiEngineAppAddress}:8060/query/active-app`);
    } while (!activeApp.includes(`id="${this.channelId}"`));
  }

  async removeApp(channelId) {
    _logger.default.info(`BlueSky: Delete app`);

    await this.shell.exec(`curl --user ${this.caps.username}:${this.caps.password} --digest --progress-bar --show-error -F 'mysubmit=Delete' -F 'archive=' --output /tmp/dev_server_out --write-out '%{http_code}' 'http://${this.caps.youiEngineAppAddress}/plugin_install'`);
  }

  async startSession(caps) {
    _logger.default.info(`BlueSky: Start Session`);

    this.caps = caps;
    this.shell = require('shelljs');
    this.channelId = 'dev';

    if (caps.channelId) {
      this.channelId = caps.channelId;
    }

    let devAppInstalled = await this.isAppInstalled(this.channelId);

    if (caps.fullReset || !devAppInstalled) {
      await this.installApp(caps.app);
    } else {
      await this.launchApp();
    }
  }

}

var _default = BlueSky;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ibHVlc2t5LmpzIl0sIm5hbWVzIjpbIkJsdWVTa3kiLCJCYXNlRGV2aWNlIiwiY29uc3RydWN0b3IiLCJjaGFubmVsSWQiLCJjYXBzIiwic2hlbGwiLCJjbG9zZUFwcCIsImxvZ2dlciIsImluZm8iLCJleGVjIiwieW91aUVuZ2luZUFwcEFkZHJlc3MiLCJhY3RpdmVBcHAiLCJpbmNsdWRlcyIsImVuZFNlc3Npb24iLCJmdWxsUmVzZXQiLCJyZW1vdmVBcHAiLCJpbnN0YWxsQXBwIiwiYXBwUGF0aCIsImlzQXBwSW5zdGFsbGVkIiwidXNlcm5hbWUiLCJwYXNzd29yZCIsImxhdW5jaEFwcCIsImRldkFwcEluc3RhbGxlZCIsImluc3RhbGxlZEFwcHMiLCJzdGFydFNlc3Npb24iLCJyZXF1aXJlIiwiYXBwIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLE9BQU4sU0FBc0JDLG1CQUF0QixDQUFpQztBQUUvQkMsRUFBQUEsV0FBVyxHQUFJO0FBQ2I7QUFDQSxTQUFLQyxTQUFMO0FBQ0EsU0FBS0MsSUFBTDtBQUNBLFNBQUtDLEtBQUw7QUFDRDs7QUFFYSxRQUFSQyxRQUFRLEdBQUk7QUFDaEJDLG9CQUFPQyxJQUFQLENBQWEsb0JBQWI7O0FBQ0EsVUFBTSxLQUFLSCxLQUFMLENBQVdJLElBQVgsQ0FBaUIscUJBQW9CLEtBQUtMLElBQUwsQ0FBVU0sb0JBQXFCLHFCQUFwRSxDQUFOO0FBQ0EsUUFBSUMsU0FBSjs7QUFDQSxPQUFHO0FBQ0QsWUFBTSxxQkFBTyxJQUFQLENBQU47QUFDQUEsTUFBQUEsU0FBUyxHQUFHLE1BQU0sS0FBS04sS0FBTCxDQUFXSSxJQUFYLENBQWlCLGVBQWMsS0FBS0wsSUFBTCxDQUFVTSxvQkFBcUIsd0JBQTlELENBQWxCO0FBQ0QsS0FIRCxRQUdTLENBQUVDLFNBQVMsQ0FBQ0MsUUFBVixDQUFvQixpQkFBcEIsQ0FIWDtBQUlEOztBQUVlLFFBQVZDLFVBQVUsR0FBSTtBQUNs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LENBQWdCWixJQUFJLENBQUNzQixHQUFyQixDQUFOO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsWUFBTSxLQUFLTCxTQUFMLEVBQU47QUFDRDtBQUNGOztBQWhGOEI7O2VBb0ZsQnJCLE8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBCYXNlRGV2aWNlIGZyb20gJy4vYmFzZWRldmljZSc7XG5pbXBvcnQgeyBzbGVlcCB9IGZyb20gJ2FzeW5jYm94JztcblxuY2xhc3MgQmx1ZVNreSBleHRlbmRzIEJhc2VEZXZpY2Uge1xuXG4gIGNvbnN0cnVjdG9yICgpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuY2hhbm5lbElkO1xuICAgIHRoaXMuY2FwcztcbiAgICB0aGlzLnNoZWxsO1xuICB9XG5cbiAgYXN5bmMgY2xvc2VBcHAgKCkge1xuICAgIGxvZ2dlci5pbmZvKGBCbHVlU2t5OiBDbG9zZSBBcHBgKTtcbiAgICBhd2FpdCB0aGlzLnNoZWxsLmV4ZWMoYGN1cmwgLWQgJycgaHR0cDovLyR7dGhpcy5jYXBzLnlvdWlFbmdpbmVBcHBBZGRyZXNzfTo4MDYwL2tleXByZXNzL2hvbWVgKTtcbiAgICBsZXQgYWN0aXZlQXBwO1xuICAgIGRvIHtcbiAgICAgIGF3YWl0IHNsZWVwICgxMDAwKTtcbiAgICAgIGFjdGl2ZUFwcCA9IGF3YWl0IHRoaXMuc2hlbGwuZXhlYyhgY3VybCBodHRwOi8vJHt0aGlzLmNhcHMueW91aUVuZ2luZUFwcEFkZHJlc3N9OjgwNjAvcXVlcnkvYWN0aXZlLWFwcGApO1xuICAgIH0gd2hpbGUgKCEoYWN0aXZlQXBwLmluY2x1ZGVzKGA8YXBwPlJva3U8L2FwcD5gKSkpO1xuICB9XG5cbiAgYXN5bmMgZW5kU2Vzc2lvbiAoKSB7XG4gICAgbG9nZ2VyLmluZm8oYEJsdWVTa3k6IEVuZCBTZXNzaW9uYCk7XG4gICAgaWYgKHRoaXMuY2Fwcy5mdWxsUmVzZXQpIHtcbiAgICAgIGF3YWl0IHRoaXMucmVtb3ZlQXBwKHRoaXMuY2hhbm5lbElkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy5jbG9zZUFwcCgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxBcHAgKGFwcFBhdGgpIHtcbiAgICBsb2dnZXIuaW5mbyhgQmx1ZVNreTogSW5zdGFsbGluZyBhbmQgbGF1bmNoaW5nIGFwcGApO1xuICAgIGlmIChhd2FpdCB0aGlzLmlzQXBwSW5zdGFsbGVkKHRoaXMuY2hhbm5lbElkKSkge1xuICAgICAgYXdhaXQgdGhpcy5yZW1vdmVBcHAodGhpcy5jaGFubmVsSWQpO1xuICAgIH1cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdXNlbGVzcy1lc2NhcGVcbiAgICBhd2FpdCB0aGlzLnNoZWxsLmV4ZWMoYGN1cmwgLXYgLSMgLWYgLWkgLS11c2VyICcke3RoaXMuY2Fwcy51c2VybmFtZX06JHt0aGlzLmNhcHMucGFzc3dvcmR9JyAtLWRpZ2VzdCAtLXByb2dyZXNzLWJhciAtRiAnbXlzdWJtaXQ9SW5zdGFsbCcgLUYgJ2FyY2hpdmU9QCR7YXBwUGF0aH0nIC1GICdwYXNzd2Q9JyBodHRwOi8vJHt0aGlzLmNhcHMueW91aUVuZ2luZUFwcEFkZHJlc3N9L3BsdWdpbl9pbnN0YWxsIHwgZ3JlcCAnPGZvbnQgY29sb3InIHwgc2VkICdzLzxmb250IGNvbG9yPVxcJ3JlZFxcJz4vLycgYCk7XG4gICAgYXdhaXQgdGhpcy5sYXVuY2hBcHAoKTtcbiAgfVxuXG4gIGFzeW5jIGlzQXBwSW5zdGFsbGVkIChjaGFubmVsSWQgPSB0aGlzLmNoYW5uZWxJZCkge1xuICAgIGxvZ2dlci5pbmZvKGBCbHVlU2t5OiBDaGVjayBpZiBBcHAgaXMgaW5zdGFsbGVkYCk7XG4gICAgLy8gQ2hlY2sgaWYgYXBwIGlzIGluc3RhbGxlZFxuICAgIGxldCBkZXZBcHBJbnN0YWxsZWQgPSBmYWxzZTtcbiAgICBsZXQgaW5zdGFsbGVkQXBwcyA9IGF3YWl0IHRoaXMuc2hlbGwuZXhlYyhgY3VybCBodHRwOi8vJHt0aGlzLmNhcHMueW91aUVuZ2luZUFwcEFkZHJlc3N9OjgwNjAvcXVlcnkvYXBwc2ApO1xuICAgIGlmIChpbnN0YWxsZWRBcHBzLmluY2x1ZGVzKGBpZD1cIiR7Y2hhbm5lbElkfVwiYCkpIHtcbiAgICAgIGRldkFwcEluc3RhbGxlZCA9IHRydWU7XG4gICAgfVxuICAgIHJldHVybiBkZXZBcHBJbnN0YWxsZWQ7XG4gIH1cblxuICBhc3luYyBsYXVuY2hBcHAgKCkge1xuICAgIGxvZ2dlci5pbmZvKGBCbHVlU2t5OiBMYXVuY2ggYXBwYCk7XG4gICAgbGV0IGFjdGl2ZUFwcDtcbiAgICBkbyB7XG4gICAgICBhd2FpdCBzbGVlcCg1MDAwKTtcbiAgICAgIGF3YWl0IHRoaXMuc2hlbGwuZXhlYyhgY3VybCAtZCAnJyBodHRwOi8vJHt0aGlzLmNhcHMueW91aUVuZ2luZUFwcEFkZHJlc3N9OjgwNjAvbGF1bmNoLyR7dGhpcy5jaGFubmVsSWR9YCk7XG4gICAgICBhY3RpdmVBcHAgPSBhd2FpdCB0aGlzLnNoZWxsLmV4ZWMoYGN1cmwgaHR0cDovLyR7dGhpcy5jYXBzLnlvdWlFbmdpbmVBcHBBZGRyZXNzfTo4MDYwL3F1ZXJ5L2FjdGl2ZS1hcHBgKTtcbiAgICB9IHdoaWxlICghKGFjdGl2ZUFwcC5pbmNsdWRlcyhgaWQ9XCIke3RoaXMuY2hhbm5lbElkfVwiYCkpKTtcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZUFwcCAoY2hhbm5lbElkKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW51c2VkLXZhcnNcbiAgICBsb2dnZXIuaW5mbyhgQmx1ZVNreTogRGVsZXRlIGFwcGApO1xuICAgIGF3YWl0IHRoaXMuc2hlbGwuZXhlYyhgY3VybCAtLXVzZXIgJHt0aGlzLmNhcHMudXNlcm5hbWV9OiR7dGhpcy5jYXBzLnBhc3N3b3JkfSAtLWRpZ2VzdCAtLXByb2dyZXNzLWJhciAtLXNob3ctZXJyb3IgLUYgJ215c3VibWl0PURlbGV0ZScgLUYgJ2FyY2hpdmU9JyAtLW91dHB1dCAvdG1wL2Rldl9zZXJ2ZXJfb3V0IC0td3JpdGUtb3V0ICcle2h0dHBfY29kZX0nICdodHRwOi8vJHt0aGlzLmNhcHMueW91aUVuZ2luZUFwcEFkZHJlc3N9L3BsdWdpbl9pbnN0YWxsJ2ApO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXNzaW9uIChjYXBzKSB7XG4gICAgbG9nZ2VyLmluZm8oYEJsdWVTa3k6IFN0YXJ0IFNlc3Npb25gKTtcbiAgICB0aGlzLmNhcHMgPSBjYXBzO1xuICAgIHRoaXMuc2hlbGwgPSByZXF1aXJlKCdzaGVsbGpzJyk7XG4gICAgdGhpcy5jaGFubmVsSWQgPSAnZGV2JztcbiAgICBpZiAoY2Fwcy5jaGFubmVsSWQpIHtcbiAgICAgIHRoaXMuY2hhbm5lbElkID0gY2Fwcy5jaGFubmVsSWQ7XG4gICAgfVxuICAgIC8vIENoZWNrIGlmIGFwcCBpcyBpbnN0YWxsZWRcbiAgICBsZXQgZGV2QXBwSW5zdGFsbGVkID0gYXdhaXQgdGhpcy5pc0FwcEluc3RhbGxlZCh0aGlzLmNoYW5uZWxJZCk7XG5cbiAgICBpZiAoY2Fwcy5mdWxsUmVzZXQgfHwgIWRldkFwcEluc3RhbGxlZCkge1xuICAgICAgYXdhaXQgdGhpcy5pbnN0YWxsQXBwKGNhcHMuYXBwKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy5sYXVuY2hBcHAoKTtcbiAgICB9XG4gIH1cblxufVxuXG5leHBvcnQgZGVmYXVsdCBCbHVlU2t5O1xuIl0sImZpbGUiOiJsaWIvYmx1ZXNreS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
