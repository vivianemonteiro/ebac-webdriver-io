"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _cssSelectorParser = require("css-selector-parser");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

const CssConverter = {};
const parser = new _cssSelectorParser.CssSelectorParser();
parser.registerSelectorPseudos('has');
parser.registerNestingOperators('>', '+', '~');
parser.registerAttrEqualityMods('^', '$', '*', '~');
parser.enableSubstitutes();
const BOOLEAN_ATTRS = ['visible', 'accessible', 'accessibility-container', 'enabled'];
const NUMERIC_ATTRS = ['index'];
const STR_ATTRS = ['label', 'name', 'value', 'type'];
const ALL_ATTRS = [...BOOLEAN_ATTRS, ...NUMERIC_ATTRS, ...STR_ATTRS];
const ATTRIBUTE_ALIASES = [['name', ['id']], ['index', ['nth-child']]];

function toCamelCase(str) {
  if (!str) {
    return '';
  }

  const tokens = str.split('-').map(str => str.charAt(0).toUpperCase() + str.slice(1).toLowerCase());
  const out = tokens.join('');
  return out.charAt(0).toLowerCase() + out.slice(1);
}

function requireBoolean(css) {
  var _css$value;

  const val = ((_css$value = css.value) === null || _css$value === void 0 ? void 0 : _css$value.toLowerCase()) || 'true';

  switch (val) {
    case '0':
    case 'false':
      return '0';

    case '1':
    case 'true':
      return '1';

    default:
      throw new TypeError(`'${css.name}' must be true, false or empty. Found '${css.value}'`);
  }
}

function requireAttributeName(css) {
  const attrName = css.name.toLowerCase();

  if (ALL_ATTRS.includes(attrName)) {
    return attrName.toLowerCase();
  }

  for (const [officialAttr, aliasAttrs] of ATTRIBUTE_ALIASES) {
    if (aliasAttrs.includes(attrName)) {
      return officialAttr;
    }
  }

  throw new Error(`'${attrName}' is not a valid attribute. ` + `Supported attributes are '${ALL_ATTRS.join(', ')}'`);
}

function parseAttr(cssAttr) {
  if (cssAttr.valueType && cssAttr.valueType !== 'string') {
    throw new TypeError(`'${cssAttr.name}=${cssAttr.value}' is an invalid attribute. ` + `Only 'string' and empty attribute types are supported. Found '${cssAttr.valueType}'`);
  }

  const attrName = toCamelCase(requireAttributeName(cssAttr));

  if (!STR_ATTRS.includes(attrName) && !BOOLEAN_ATTRS.includes(attrName)) {
    throw new Error(`'${attrName}' is not supported. Supported attributes are ` + `'${[...STR_ATTRS, ...BOOLEAN_ATTRS].join(', ')}'`);
  }

  if (attrName === 'index') {
    return {
      index: cssAttr.value
    };
  }

  if (BOOLEAN_ATTRS.includes(attrName)) {
    return `${attrName} == ${requireBoolean(cssAttr)}`;
  }

  let value = cssAttr.value || '';

  if (value === '') {
    return `[${attrName} LIKE ${value}]`;
  }

  switch (cssAttr.operator) {
    case '=':
      return `${attrName} == "${value}"`;

    case '*=':
      return `${attrName} MATCHES "${_lodash.default.escapeRegExp(value)}"`;

    case '^=':
      return `${attrName} BEGINSWITH "${value}"`;

    case '$=':
      return `${attrName} ENDSWITH "${value}"`;

    case '~=':
      return `${attrName} CONTAINS "${value}"`;

    default:
      throw new Error(`Unsupported CSS attribute operator '${cssAttr.operator}'. ` + ` '=', '*=', '^=', '$=' and '~=' are supported.`);
  }
}

function parsePseudo(cssPseudo) {
  if (cssPseudo.valueType && cssPseudo.valueType !== 'string') {
    throw new Error(`'${cssPseudo.name}=${cssPseudo.value}'. ` + `Unsupported css pseudo class value type: '${cssPseudo.valueType}'. Only 'string' type or empty is supported.`);
  }

  const pseudoName = requireAttributeName(cssPseudo);

  if (BOOLEAN_ATTRS.includes(pseudoName)) {
    return `${toCamelCase(pseudoName)} == ${requireBoolean(cssPseudo)}`;
  }

  if (pseudoName === 'index') {
    return {
      index: cssPseudo.value
    };
  }
}

function parseCssRule(cssRule) {
  const {
    nestingOperator
  } = cssRule;

  if (nestingOperator && nestingOperator !== ' ' && nestingOperator !== '>') {
    throw new Error(`'${nestingOperator}' is not a supported combinator. ` + `Only child combinator (>) and descendant combinator are supported.`);
  }

  let iosClassChainSelector = '';

  if (cssRule.classNames) {
    throw new _appiumBaseDriver.errors.InvalidSelectorError(`'${[cssRule || '', ...cssRule.classNames].join('.')}'
      is not a valid ios class. Must be a single string (e.g.: XCUIElementTypeWindow) without
      dots separating them`);
  }

  if (cssRule.tagName && cssRule.tagName !== '*' && !cssRule.tagName.toLowerCase().startsWith('xcuielementtype')) {
    const capitalizedTagName = cssRule.tagName.charAt(0).toUpperCase() + cssRule.tagName.slice(1);
    cssRule.tagName = `XCUIElementType${capitalizedTagName}`;
  }

  iosClassChainSelector += cssRule.tagName || '*';
  let attrs = [];

  if (cssRule.id) {
    attrs.push(`name == "${cssRule.id}"`);
  }

  if (cssRule.attrs) {
    for (const attr of cssRule.attrs) {
      attrs.push(parseAttr(attr));
    }
  }

  if (cssRule.pseudos) {
    for (const pseudo of cssRule.pseudos) {
      attrs.push(parsePseudo(pseudo));
    }
  }

  const nonIndexAttrs = attrs.filter(attr => _lodash.default.isString(attr));

  if (nonIndexAttrs && nonIndexAttrs.length > 0) {
    iosClassChainSelector += `[\`${nonIndexAttrs.join(' AND ')}\`]`;
  }

  const indexAttr = attrs.find(attr => _lodash.default.isObject(attr) && attr.index);

  if (indexAttr) {
    iosClassChainSelector += `[${indexAttr.index}]`;
  }

  if (cssRule.rule) {
    iosClassChainSelector += `/${parseCssRule(cssRule.rule)}`;
  }

  if (cssRule.nestingOperator === '>') {
    return iosClassChainSelector;
  } else {
    return `**/` + iosClassChainSelector;
  }
}

function parseCssObject(css) {
  switch (css.type) {
    case 'rule':
      return parseCssRule(css);

    case 'ruleSet':
      return parseCssObject(css.rule);

    case 'selectors':
      return css.selectors.map(selector => parseCssObject(selector)).join('; ');

    default:
      throw new Error(`iOS Class Chain does not support '${css.type}' css. Only supports 'rule', 'ruleSet', 'selectors'`);
  }
}

CssConverter.toIosClassChainSelector = function toIosClassChainSelector(cssSelector) {
  let cssObj;

  try {
    cssObj = parser.parse(cssSelector);
  } catch (e) {
    throw new _appiumBaseDriver.errors.InvalidSelectorError(`Invalid CSS selector '${cssSelector}'. Reason: '${e.message}'`);
  }

  try {
    return parseCssObject(cssObj);
  } catch (e) {
    throw new _appiumBaseDriver.errors.InvalidSelectorError(`Unsupported CSS selector '${cssSelector}'. Reason: '${e.message}'`);
  }
};

var _default = CssConverter;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jc3MtY29udmVydGVyLmpzIl0sIm5hbWVzIjpbIkNzc0NvbnZlcnRlciIsInBhcnNlciIsIkNzc1NlbGVjdG9yUGFyc2VyIiwicmVnaXN0ZXJTZWxlY3RvclBzZXVkb3MiLCJyZWdpc3Rlck5lc3RpbmdPcGVyYXRvcnMiLCJyZWdpc3RlckF0dHJFcXVhbGl0eU1vZHMiLCJlbmFibGVTdWJzdGl0dXRlcyIsIkJPT0xFQU5fQVRUUlMiLCJOVU1FUklDX0FUVFJTIiwiU1RSX0FUVFJTIiwiQUxMX0FUVFJTIiwiQVRUUklCVVRFX0FMSUFTRVMiLCJ0b0NhbWVsQ2FzZSIsInN0ciIsInRva2VucyIsInNwbGl0IiwibWFwIiwiY2hhckF0IiwidG9VcHBlckNhc2UiLCJzbGljZSIsInRvTG93ZXJDYXNlIiwib3V0Iiwiam9pbiIsInJlcXVpcmVCb29sZWFuIiwiY3NzIiwidmFsIiwidmFsdWUiLCJUeXBlRXJyb3IiLCJuYW1lIiwicmVxdWlyZUF0dHJpYnV0ZU5hbWUiLCJhdHRyTmFtZSIsImluY2x1ZGVzIiwib2ZmaWNpYWxBdHRyIiwiYWxpYXNBdHRycyIsIkVycm9yIiwicGFyc2VBdHRyIiwiY3NzQXR0ciIsInZhbHVlVHlwZSIsImluZGV4Iiwib3BlcmF0b3IiLCJfIiwiZXNjYXBlUmVnRXhwIiwicGFyc2VQc2V1ZG8iLCJjc3NQc2V1ZG8iLCJwc2V1ZG9OYW1lIiwicGFyc2VDc3NSdWxlIiwiY3NzUnVsZSIsIm5lc3RpbmdPcGVyYXRvciIsImlvc0NsYXNzQ2hhaW5TZWxlY3RvciIsImNsYXNzTmFtZXMiLCJlcnJvcnMiLCJJbnZhbGlkU2VsZWN0b3JFcnJvciIsInRhZ05hbWUiLCJzdGFydHNXaXRoIiwiY2FwaXRhbGl6ZWRUYWdOYW1lIiwiYXR0cnMiLCJpZCIsInB1c2giLCJhdHRyIiwicHNldWRvcyIsInBzZXVkbyIsIm5vbkluZGV4QXR0cnMiLCJmaWx0ZXIiLCJpc1N0cmluZyIsImxlbmd0aCIsImluZGV4QXR0ciIsImZpbmQiLCJpc09iamVjdCIsInJ1bGUiLCJwYXJzZUNzc09iamVjdCIsInR5cGUiLCJzZWxlY3RvcnMiLCJzZWxlY3RvciIsInRvSW9zQ2xhc3NDaGFpblNlbGVjdG9yIiwiY3NzU2VsZWN0b3IiLCJjc3NPYmoiLCJwYXJzZSIsImUiLCJtZXNzYWdlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLFlBQVksR0FBRyxFQUFyQjtBQUVBLE1BQU1DLE1BQU0sR0FBRyxJQUFJQyxvQ0FBSixFQUFmO0FBQ0FELE1BQU0sQ0FBQ0UsdUJBQVAsQ0FBK0IsS0FBL0I7QUFDQUYsTUFBTSxDQUFDRyx3QkFBUCxDQUFnQyxHQUFoQyxFQUFxQyxHQUFyQyxFQUEwQyxHQUExQztBQUNBSCxNQUFNLENBQUNJLHdCQUFQLENBQWdDLEdBQWhDLEVBQXFDLEdBQXJDLEVBQTBDLEdBQTFDLEVBQStDLEdBQS9DO0FBQ0FKLE1BQU0sQ0FBQ0ssaUJBQVA7QUFFQSxNQUFNQyxhQUFhLEdBQUcsQ0FDcEIsU0FEb0IsRUFDVCxZQURTLEVBQ0sseUJBREwsRUFDZ0MsU0FEaEMsQ0FBdEI7QUFJQSxNQUFNQyxhQUFhLEdBQUcsQ0FDcEIsT0FEb0IsQ0FBdEI7QUFJQSxNQUFNQyxTQUFTLEdBQUcsQ0FDaEIsT0FEZ0IsRUFDUCxNQURPLEVBQ0MsT0FERCxFQUNVLE1BRFYsQ0FBbEI7QUFJQSxNQUFNQyxTQUFTLEdBQUcsQ0FDaEIsR0FBR0gsYUFEYSxFQUVoQixHQUFHQyxhQUZhLEVBR2hCLEdBQUdDLFNBSGEsQ0FBbEI7QUFNQSxNQUFNRSxpQkFBaUIsR0FBRyxDQUN4QixDQUFDLE1BQUQsRUFBUyxDQUFDLElBQUQsQ0FBVCxDQUR3QixFQUV4QixDQUFDLE9BQUQsRUFBVSxDQUFDLFdBQUQsQ0FBVixDQUZ3QixDQUExQjs7QUFXQSxTQUFTQyxXQUFULENBQXNCQyxHQUF0QixFQUEyQjtBQUN6QixNQUFJLENBQUNBLEdBQUwsRUFBVTtBQUNSLFdBQU8sRUFBUDtBQUNEOztBQUNELFFBQU1DLE1BQU0sR0FBR0Qs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QU47QUFDRDs7QUFDRCxNQUFJO0FBQ0YsV0FBT1QsY0FBYyxDQUFDTSxNQUFELENBQXJCO0FBQ0QsR0FGRCxDQUVFLE9BQU9FLENBQVAsRUFBVTtBQUNWLFVBQU0sSUFBSTNCLHlCQUFPQyxvQkFBWCxDQUFpQyw2QkFBNEJ1QixXQUFZLGVBQWNHLENBQUMsQ0FBQ0MsT0FBUSxHQUFqRyxDQUFOO0FBQ0Q7QUFDRixDQVpEOztlQWNlOUUsWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENzc1NlbGVjdG9yUGFyc2VyIH0gZnJvbSAnY3NzLXNlbGVjdG9yLXBhcnNlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcblxuY29uc3QgQ3NzQ29udmVydGVyID0ge307XG5cbmNvbnN0IHBhcnNlciA9IG5ldyBDc3NTZWxlY3RvclBhcnNlcigpO1xucGFyc2VyLnJlZ2lzdGVyU2VsZWN0b3JQc2V1ZG9zKCdoYXMnKTtcbnBhcnNlci5yZWdpc3Rlck5lc3RpbmdPcGVyYXRvcnMoJz4nLCAnKycsICd+Jyk7XG5wYXJzZXIucmVnaXN0ZXJBdHRyRXF1YWxpdHlNb2RzKCdeJywgJyQnLCAnKicsICd+Jyk7XG5wYXJzZXIuZW5hYmxlU3Vic3RpdHV0ZXMoKTtcblxuY29uc3QgQk9PTEVBTl9BVFRSUyA9IFtcbiAgJ3Zpc2libGUnLCAnYWNjZXNzaWJsZScsICdhY2Nlc3NpYmlsaXR5LWNvbnRhaW5lcicsICdlbmFibGVkJyxcbl07XG5cbmNvbnN0IE5VTUVSSUNfQVRUUlMgPSBbXG4gICdpbmRleCdcbl07XG5cbmNvbnN0IFNUUl9BVFRSUyA9IFtcbiAgJ2xhYmVsJywgJ25hbWUnLCAndmFsdWUnLCAndHlwZScsXG5dO1xuXG5jb25zdCBBTExfQVRUUlMgPSBbXG4gIC4uLkJPT0xFQU5fQVRUUlMsXG4gIC4uLk5VTUVSSUNfQVRUUlMsXG4gIC4uLlNUUl9BVFRSUyxcbl07XG5cbmNvbnN0IEFUVFJJQlVURV9BTElBU0VTID0gW1xuICBbJ25hbWUnLCBbJ2lkJ11dLFxuICBbJ2luZGV4JywgWydudGgtY2hpbGQnXV0sXG5dO1xuXG4vKipcbiAqIENvbnZlcnQgaHlwaGVuIHNlcGFyYXRlZCB3b3JkIHRvIGNhbWVsIGNhc2VcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gc3RyXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgaHlwaGVuIHNlcGFyYXRlZCB3b3JkIHRyYW5zbGF0ZWQgdG8gY2FtZWwgY2FzZVxuICovXG5mdW5jdGlvbiB0b0NhbWVsQ2FzZSAoc3RyKSB7XG4gIGlmICghc3RyKSB7XG4gICAgcmV0dXJuICcnO1xuICB9XG4gIGNvbnN0IHRva2VucyA9IHN0ci5zcGxpdCgnLScpLm1hcCgoc3RyKSA9PiBzdHIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc2xpY2UoMSkudG9Mb3dlckNhc2UoKSk7XG4gIGNvbnN0IG91dCA9IHRva2Vucy5qb2luKCcnKTtcbiAgcmV0dXJuIG91dC5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSArIG91dC5zbGljZSgxKTtcbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBDc3NOYW1lVmFsdWVPYmplY3RcbiAqIEBwcm9wZXJ0eSB7P25hbWV9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIENTUyBvYmplY3RcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdmFsdWUgVGhlIHZhbHVlIG9mIHRoZSBDU1Mgb2JqZWN0XG4gKi9cblxuLyoqXG4gKiBHZXQgdGhlIGJvb2xlYW4gZnJvbSBhIENTUyBvYmplY3QuIElmIGVtcHR5LCByZXR1cm4gdHJ1ZS4gSWYgbm90IHRydWUvZmFsc2UvZW1wdHksIHRocm93IGV4Y2VwdGlvblxuICpcbiAqIEBwYXJhbSB7Q3NzTmFtZVZhbHVlT2JqZWN0fSBjc3MgQSBDU1Mgb2JqZWN0IHRoYXQgaGFzICduYW1lJyBhbmQgJ3ZhbHVlJ1xuICogQHJldHVybnMge3N0cmluZ30gRWl0aGVyICd0cnVlJyBvciAnZmFsc2UnLiBJZiB2YWx1ZSBpcyBlbXB0eSwgcmV0dXJuICd0cnVlJ1xuICovXG5mdW5jdGlvbiByZXF1aXJlQm9vbGVhbiAoY3NzKSB7XG4gIGNvbnN0IHZhbCA9IGNzcy52YWx1ZT8udG9Mb3dlckNhc2UoKSB8fCAndHJ1ZSc7IC8vIGFuIG9taXR0ZWQgYm9vbGVhbiBhdHRyaWJ1dGUgbWVhbnMgJ3RydWUnIChlLmcuOiBpbnB1dFtjaGVja2VkXSBtZWFucyBjaGVja2VkIGlzIHRydWUpXG4gIHN3aXRjaCAodmFsKSB7XG4gICAgY2FzZSAnMCc6XG4gICAgY2FzZSAnZmFsc2UnOlxuICAgICAgcmV0dXJuICcwJztcbiAgICBjYXNlICcxJzpcbiAgICBjYXNlICd0cnVlJzpcbiAgICAgIHJldHVybiAnMSc7XG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYCcke2Nzcy5uYW1lfScgbXVzdCBiZSB0cnVlLCBmYWxzZSBvciBlbXB0eS4gRm91bmQgJyR7Y3NzLnZhbHVlfSdgKTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCB0aGUgY2Fub25pY2FsIGZvcm0gb2YgYSBDU1MgYXR0cmlidXRlIG5hbWVcbiAqXG4gKiBDb252ZXJ0cyB0byBsb3dlcmNhc2UgYW5kIGlmIGFuIGF0dHJpYnV0ZSBuYW1lIGlzIGFuIGFsaWFzIGZvciBzb21ldGhpbmcgZWxzZSwgcmV0dXJuXG4gKiB3aGF0IGl0IGlzIGFuIGFsaWFzIGZvclxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBjc3MgQ1NTIG9iamVjdFxuICogQHJldHVybnMge3N0cmluZ30gVGhlIGNhbm9uaWNhbCBhdHRyaWJ1dGUgbmFtZVxuICovXG5mdW5jdGlvbiByZXF1aXJlQXR0cmlidXRlTmFtZSAoY3NzKSB7XG4gIGNvbnN0IGF0dHJOYW1lID0gY3NzLm5hbWUudG9Mb3dlckNhc2UoKTtcblxuICAvLyBDaGVjayBpZiBpdCdzIHN1cHBvcnRlZCBhbmQgaWYgaXQgaXMsIHJldHVybiBpdFxuICBpZiAoQUxMX0FUVFJTLmluY2x1ZGVzKGF0dHJOYW1lKSkge1xuICAgIHJldHVybiBhdHRyTmFtZS50b0xvd2VyQ2FzZSgpO1xuICB9XG5cbiAgLy8gSWYgYXR0ck5hbWUgaXMgYW4gYWxpYXMgZm9yIHNvbWV0aGluZyBlbHNlLCByZXR1cm4gdGhhdFxuICBmb3IgKGNvbnN0IFtvZmZpY2lhbEF0dHIsIGFsaWFzQXR0cnNdIG9mIEFUVFJJQlVURV9BTElBU0VTKSB7XG4gICAgaWYgKGFsaWFzQXR0cnMuaW5jbHVkZXMoYXR0ck5hbWUpKSB7XG4gICAgICByZXR1cm4gb2ZmaWNpYWxBdHRyO1xuICAgIH1cbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoYCcke2F0dHJOYW1lfScgaXMgbm90IGEgdmFsaWQgYXR0cmlidXRlLiBgICtcbiAgICBgU3VwcG9ydGVkIGF0dHJpYnV0ZXMgYXJlICcke0FMTF9BVFRSUy5qb2luKCcsICcpfSdgKTtcbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBDc3NBdHRyXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHZhbHVlVHlwZSBUeXBlIG9mIGF0dHJpYnV0ZSAobXVzdCBiZSBzdHJpbmcgb3IgZW1wdHkpXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHZhbHVlIFZhbHVlIG9mIHRoZSBhdHRyaWJ1dGVcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gb3BlcmF0b3IgVGhlIG9wZXJhdG9yIGJldHdlZW4gdmFsdWUgYW5kIHZhbHVlIHR5cGUgKD0sICo9LCAsIF49LCAkPSlcbiAqL1xuXG4vKipcbiAqIENvbnZlcnQgYSBDU1MgYXR0cmlidXRlIGludG8gYSBVaVNlbGVjdG9yIG1ldGhvZCBjYWxsXG4gKlxuICogQHBhcmFtIHtDc3NBdHRyfSBjc3NBdHRyIENTUyBhdHRyaWJ1dGUgb2JqZWN0XG4gKiBAcmV0dXJucyB7c3RyaW5nfSBDU1MgYXR0cmlidXRlIHBhcnNlZCBhcyBVaVNlbGVjdG9yXG4gKi9cbmZ1bmN0aW9uIHBhcnNlQXR0ciAoY3NzQXR0cikge1xuICBpZiAoY3NzQXR0ci52YWx1ZVR5cGUgJiYgY3NzQXR0ci52YWx1ZVR5cGUgIT09ICdzdHJpbmcnKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgJyR7Y3NzQXR0ci5uYW1lfT0ke2Nzc0F0dHIudmFsdWV9JyBpcyBhbiBpbnZhbGlkIGF0dHJpYnV0ZS4gYCArXG4gICAgICBgT25seSAnc3RyaW5nJyBhbmQgZW1wdHkgYXR0cmlidXRlIHR5cGVzIGFyZSBzdXBwb3J0ZWQuIEZvdW5kICcke2Nzc0F0dHIudmFsdWVUeXBlfSdgKTtcbiAgfVxuICBjb25zdCBhdHRyTmFtZSA9IHRvQ2FtZWxDYXNlKHJlcXVpcmVBdHRyaWJ1dGVOYW1lKGNzc0F0dHIpKTtcblxuICAvLyBWYWxpZGF0ZSB0aGF0IGl0J3MgYSBzdXBwb3J0ZWQgYXR0cmlidXRlXG4gIGlmICghU1RSX0FUVFJTLmluY2x1ZGVzKGF0dHJOYW1lKSAmJiAhQk9PTEVBTl9BVFRSUy5pbmNsdWRlcyhhdHRyTmFtZSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCcke2F0dHJOYW1lfScgaXMgbm90IHN1cHBvcnRlZC4gU3VwcG9ydGVkIGF0dHJpYnV0ZXMgYXJlIGAgK1xuICAgICAgYCcke1suLi5TVFJfQVRUUlMsIC4uLkJPT0xFQU5fQVRUUlNdLmpvaW4oJywgJyl9J2ApO1xuICB9XG5cbiAgLy8gUGFyc2UgaW5kZXggaWYgaXQncyBhbiBpbmRleCBhdHRyaWJ1dGVcbiAgaWYgKGF0dHJOYW1lID09PSAnaW5kZXgnKSB7XG4gICAgcmV0dXJuIHtpbmRleDogY3NzQXR0ci52YWx1ZX07XG4gIH1cbiAgaWYgKEJPT0xFQU5fQVRUUlMuaW5jbHVkZXMoYXR0ck5hbWUpKSB7XG4gICAgcmV0dXJuIGAke2F0dHJOYW1lfSA9PSAke3JlcXVpcmVCb29sZWFuKGNzc0F0dHIpfWA7XG4gIH1cblxuICBsZXQgdmFsdWUgPSBjc3NBdHRyLnZhbHVlIHx8ICcnO1xuICBpZiAodmFsdWUgPT09ICcnKSB7XG4gICAgcmV0dXJuIGBbJHthdHRyTmFtZX0gTElLRSAke3ZhbHVlfV1gO1xuICB9XG5cbiAgc3dpdGNoIChjc3NBdHRyLm9wZXJhdG9yKSB7XG4gICAgY2FzZSAnPSc6XG4gICAgICByZXR1cm4gYCR7YXR0ck5hbWV9ID09IFwiJHt2YWx1ZX1cImA7XG4gICAgY2FzZSAnKj0nOlxuICAgICAgcmV0dXJuIGAke2F0dHJOYW1lfSBNQVRDSEVTIFwiJHtfLmVzY2FwZVJlZ0V4cCh2YWx1ZSl9XCJgO1xuICAgIGNhc2UgJ149JzpcbiAgICAgIHJldHVybiBgJHthdHRyTmFtZX0gQkVHSU5TV0lUSCBcIiR7dmFsdWV9XCJgO1xuICAgIGNhc2UgJyQ9JzpcbiAgICAgIHJldHVybiBgJHthdHRyTmFtZX0gRU5EU1dJVEggXCIke3ZhbHVlfVwiYDtcbiAgICBjYXNlICd+PSc6XG4gICAgICByZXR1cm4gYCR7YXR0ck5hbWV9IENPTlRBSU5TIFwiJHt2YWx1ZX1cImA7XG4gICAgZGVmYXVsdDpcbiAgICAgIC8vIFVucmVhY2hhYmxlLCBidXQgYWRkaW5nIGVycm9yIGluIGNhc2UgYSBuZXcgQ1NTIGF0dHJpYnV0ZSBpcyBhZGRlZC5cbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgQ1NTIGF0dHJpYnV0ZSBvcGVyYXRvciAnJHtjc3NBdHRyLm9wZXJhdG9yfScuIGAgK1xuICAgICAgICBgICc9JywgJyo9JywgJ149JywgJyQ9JyBhbmQgJ349JyBhcmUgc3VwcG9ydGVkLmApO1xuICB9XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQ3NzUHNldWRvXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHZhbHVlVHlwZSBUaGUgdHlwZSBvZiBDU1MgcHNldWRvIHNlbGVjdG9yIChodHRwczovL3d3dy5ucG1qcy5jb20vcGFja2FnZS9jc3Mtc2VsZWN0b3ItcGFyc2VyIGZvciByZWZlcmVuY2UpXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHBzZXVkbyBzZWxlY3RvclxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgb2YgdGhlIHBzZXVkbyBzZWxlY3RvclxuICovXG5cbi8qKlxuICogQ29udmVydCBhIENTUyBwc2V1ZG8gY2xhc3MgdG8gYSBVaVNlbGVjdG9yXG4gKlxuICogQHBhcmFtIHtDc3NQc2V1ZG99IGNzc1BzZXVkbyBDU1MgUHNldWRvIGNsYXNzXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBQc2V1ZG8gc2VsZWN0b3IgcGFyc2VkIGFzIFVpU2VsZWN0b3JcbiAqL1xuZnVuY3Rpb24gcGFyc2VQc2V1ZG8gKGNzc1BzZXVkbykge1xuICBpZiAoY3NzUHNldWRvLnZhbHVlVHlwZSAmJiBjc3NQc2V1ZG8udmFsdWVUeXBlICE9PSAnc3RyaW5nJykge1xuICAgIHRocm93IG5ldyBFcnJvcihgJyR7Y3NzUHNldWRvLm5hbWV9PSR7Y3NzUHNldWRvLnZhbHVlfScuIGAgK1xuICAgICAgYFVuc3VwcG9ydGVkIGNzcyBwc2V1ZG8gY2xhc3MgdmFsdWUgdHlwZTogJyR7Y3NzUHNldWRvLnZhbHVlVHlwZX0nLiBPbmx5ICdzdHJpbmcnIHR5cGUgb3IgZW1wdHkgaXMgc3VwcG9ydGVkLmApO1xuICB9XG5cbiAgY29uc3QgcHNldWRvTmFtZSA9IHJlcXVpcmVBdHRyaWJ1dGVOYW1lKGNzc1BzZXVkbyk7XG5cbiAgaWYgKEJPT0xFQU5fQVRUUlMuaW5jbHVkZXMocHNldWRvTmFtZSkpIHtcbiAgICByZXR1cm4gYCR7dG9DYW1lbENhc2UocHNldWRvTmFtZSl9ID09ICR7cmVxdWlyZUJvb2xlYW4oY3NzUHNldWRvKX1gO1xuICB9XG5cbiAgaWYgKHBzZXVkb05hbWUgPT09ICdpbmRleCcpIHtcbiAgICByZXR1cm4ge2luZGV4OiBjc3NQc2V1ZG8udmFsdWV9O1xuICB9XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQ3NzUnVsZVxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBuZXN0aW5nT3BlcmF0b3IgVGhlIG5lc3Rpbmcgb3BlcmF0b3IgKGFrYTogY29tYmluYXRvciBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9DU1MvQ1NTX1NlbGVjdG9ycylcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdGFnTmFtZSBUaGUgdGFnIG5hbWUgKGFrYTogdHlwZSBzZWxlY3RvciBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9DU1MvVHlwZV9zZWxlY3RvcnMpXG4gKiBAcHJvcGVydHkgez9zdHJpbmdbXX0gY2xhc3NOYW1lcyBBbiBhcnJheSBvZiBDU1MgY2xhc3MgbmFtZXNcbiAqIEBwcm9wZXJ0eSB7P0Nzc0F0dHJbXX0gYXR0cnMgQW4gYXJyYXkgb2YgQ1NTIGF0dHJpYnV0ZXNcbiAqIEBwcm9wZXJ0eSB7P0Nzc1BzZXVkb1tdfSBhdHRycyBBbiBhcnJheSBvZiBDU1MgcHNldWRvc1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSBpZCBDU1MgaWRlbnRpZmllclxuICogQHByb3BlcnR5IHs/Q3NzUnVsZX0gcnVsZSBBIGRlc2NlbmRhbnQgb2YgdGhpcyBDU1MgcnVsZVxuICovXG5cbi8qKlxuICogQ29udmVydCBhIENTUyBydWxlIHRvIGEgVWlTZWxlY3RvclxuICogQHBhcmFtIHtDc3NSdWxlfSBjc3NSdWxlIENTUyBydWxlIGRlZmluaXRpb25cbiAqL1xuZnVuY3Rpb24gcGFyc2VDc3NSdWxlIChjc3NSdWxlKSB7XG4gIGNvbnN0IHsgbmVzdGluZ09wZXJhdG9yIH0gPSBjc3NSdWxlO1xuICBpZiAobmVzdGluZ09wZXJhdG9yICYmIG5lc3RpbmdPcGVyYXRvciAhPT0gJyAnICYmIG5lc3RpbmdPcGVyYXRvciAhPT0gJz4nKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAnJHtuZXN0aW5nT3BlcmF0b3J9JyBpcyBub3QgYSBzdXBwb3J0ZWQgY29tYmluYXRvci4gYCArXG4gICAgICBgT25seSBjaGlsZCBjb21iaW5hdG9yICg+KSBhbmQgZGVzY2VuZGFudCBjb21iaW5hdG9yIGFyZSBzdXBwb3J0ZWQuYCk7XG4gIH1cblxuICBsZXQgaW9zQ2xhc3NDaGFpblNlbGVjdG9yID0gJyc7XG4gIGlmIChjc3NSdWxlLmNsYXNzTmFtZXMpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRTZWxlY3RvckVycm9yKGAnJHtbY3NzUnVsZSB8fCAnJywgLi4uY3NzUnVsZS5jbGFzc05hbWVzXS5qb2luKCcuJyl9J1xuICAgICAgaXMgbm90IGEgdmFsaWQgaW9zIGNsYXNzLiBNdXN0IGJlIGEgc2luZ2xlIHN0cmluZyAoZS5nLjogWENVSUVsZW1lbnRUeXBlV2luZG93KSB3aXRob3V0XG4gICAgICBkb3RzIHNlcGFyYXRpbmcgdGhlbWApO1xuICB9XG4gIGlmIChjc3NSdWxlLnRhZ05hbWUgJiYgY3NzUnVsZS50YWdOYW1lICE9PSAnKicgJiYgIWNzc1J1bGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoJ3hjdWllbGVtZW50dHlwZScpKSB7XG4gICAgY29uc3QgY2FwaXRhbGl6ZWRUYWdOYW1lID0gY3NzUnVsZS50YWdOYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgY3NzUnVsZS50YWdOYW1lLnNsaWNlKDEpO1xuICAgIGNzc1J1bGUudGFnTmFtZSA9IGBYQ1VJRWxlbWVudFR5cGUke2NhcGl0YWxpemVkVGFnTmFtZX1gO1xuICB9XG4gIGlvc0NsYXNzQ2hhaW5TZWxlY3RvciArPSAoY3NzUnVsZS50YWdOYW1lIHx8ICcqJyk7XG5cbiAgbGV0IGF0dHJzID0gW107XG4gIGlmIChjc3NSdWxlLmlkKSB7XG4gICAgYXR0cnMucHVzaChgbmFtZSA9PSBcIiR7Y3NzUnVsZS5pZH1cImApO1xuICB9XG4gIGlmIChjc3NSdWxlLmF0dHJzKSB7XG4gICAgZm9yIChjb25zdCBhdHRyIG9mIGNzc1J1bGUuYXR0cnMpIHtcbiAgICAgIGF0dHJzLnB1c2gocGFyc2VBdHRyKGF0dHIpKTtcbiAgICB9XG4gIH1cbiAgaWYgKGNzc1J1bGUucHNldWRvcykge1xuICAgIGZvciAoY29uc3QgcHNldWRvIG9mIGNzc1J1bGUucHNldWRvcykge1xuICAgICAgYXR0cnMucHVzaChwYXJzZVBzZXVkbyhwc2V1ZG8pKTtcbiAgICB9XG4gIH1cbiAgY29uc3Qgbm9uSW5kZXhBdHRycyA9IGF0dHJzLmZpbHRlcigoYXR0cikgPT4gXy5pc1N0cmluZyhhdHRyKSk7XG4gIGlmIChub25JbmRleEF0dHJzICYmIG5vbkluZGV4QXR0cnMubGVuZ3RoID4gMCkge1xuICAgIGlvc0NsYXNzQ2hhaW5TZWxlY3RvciArPSBgW1xcYCR7bm9uSW5kZXhBdHRycy5qb2luKCcgQU5EICcpfVxcYF1gO1xuICB9XG5cbiAgY29uc3QgaW5kZXhBdHRyID0gYXR0cnMuZmluZCgoYXR0cikgPT4gXy5pc09iamVjdChhdHRyKSAmJiBhdHRyLmluZGV4KTtcbiAgaWYgKGluZGV4QXR0cikge1xuICAgIGlvc0NsYXNzQ2hhaW5TZWxlY3RvciArPSBgWyR7aW5kZXhBdHRyLmluZGV4fV1gO1xuICB9XG5cbiAgaWYgKGNzc1J1bGUucnVsZSkge1xuICAgIGlvc0NsYXNzQ2hhaW5TZWxlY3RvciArPSBgLyR7cGFyc2VDc3NSdWxlKGNzc1J1bGUucnVsZSl9YDtcbiAgfVxuXG4gIGlmIChjc3NSdWxlLm5lc3RpbmdPcGVyYXRvciA9PT0gJz4nKSB7XG4gICAgcmV0dXJuIGlvc0NsYXNzQ2hhaW5TZWxlY3RvcjtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYCoqL2AgKyBpb3NDbGFzc0NoYWluU2VsZWN0b3I7XG4gIH1cbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBDc3NPYmplY3RcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdHlwZSBUeXBlIG9mIENTUyBvYmplY3QuICdydWxlJywgJ3J1bGVzZXQnIG9yICdzZWxlY3RvcnMnXG4gKi9cblxuLyoqXG4gKiBDb252ZXJ0IENTUyBvYmplY3QgdG8gaU9TIENsYXNzIENoYWluIHNlbGVjdG9yXG4gKiBAcGFyYW0ge0Nzc09iamVjdH0gY3NzIENTUyBvYmplY3RcbiAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBDU1Mgb2JqZWN0IHBhcnNlZCBhcyBhIFVpU2VsZWN0b3JcbiAqL1xuZnVuY3Rpb24gcGFyc2VDc3NPYmplY3QgKGNzcykge1xuICBzd2l0Y2ggKGNzcy50eXBlKSB7XG4gICAgY2FzZSAncnVsZSc6XG4gICAgICByZXR1cm4gcGFyc2VDc3NSdWxlKGNzcyk7XG4gICAgY2FzZSAncnVsZVNldCc6XG4gICAgICByZXR1cm4gcGFyc2VDc3NPYmplY3QoY3NzLnJ1bGUpO1xuICAgIGNhc2UgJ3NlbGVjdG9ycyc6XG4gICAgICByZXR1cm4gY3NzLnNlbGVjdG9ycy5tYXAoKHNlbGVjdG9yKSA9PiBwYXJzZUNzc09iamVjdChzZWxlY3RvcikpLmpvaW4oJzsgJyk7XG5cbiAgICBkZWZhdWx0OlxuICAgICAgLy8gVGhpcyBpcyBuZXZlciByZWFjaGFibGUsIGJ1dCBpZiBpdCBldmVyIGlzIGRvIHRoaXMuXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGlPUyBDbGFzcyBDaGFpbiBkb2VzIG5vdCBzdXBwb3J0ICcke2Nzcy50eXBlfScgY3NzLiBPbmx5IHN1cHBvcnRzICdydWxlJywgJ3J1bGVTZXQnLCAnc2VsZWN0b3JzJ2ApO1xuICB9XG59XG5cbi8qKlxuICogQ29udmVydCBhIENTUyBzZWxlY3RvciB0byBhIGlPUyBDbGFzcyBDaGFpbiBzZWxlY3RvclxuICogQHBhcmFtIHtzdHJpbmd9IGNzc1NlbGVjdG9yIENTUyBTZWxlY3RvclxuICogQHJldHVybnMge3N0cmluZ30gVGhlIENTUyBzZWxlY3RvciBjb252ZXJ0ZWQgdG8gYW4gaU9TIENsYXNzIENoYWluXG4gKi9cbkNzc0NvbnZlcnRlci50b0lvc0NsYXNzQ2hhaW5TZWxlY3RvciA9IGZ1bmN0aW9uIHRvSW9zQ2xhc3NDaGFpblNlbGVjdG9yIChjc3NTZWxlY3Rvcikge1xuICBsZXQgY3NzT2JqO1xuICB0cnkge1xuICAgIGNzc09iaiA9IHBhcnNlci5wYXJzZShjc3NTZWxlY3Rvcik7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRTZWxlY3RvckVycm9yKGBJbnZhbGlkIENTUyBzZWxlY3RvciAnJHtjc3NTZWxlY3Rvcn0nLiBSZWFzb246ICcke2UubWVzc2FnZX0nYCk7XG4gIH1cbiAgdHJ5IHtcbiAgICByZXR1cm4gcGFyc2VDc3NPYmplY3QoY3NzT2JqKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZFNlbGVjdG9yRXJyb3IoYFVuc3VwcG9ydGVkIENTUyBzZWxlY3RvciAnJHtjc3NTZWxlY3Rvcn0nLiBSZWFzb246ICcke2UubWVzc2FnZX0nYCk7XG4gIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IENzc0NvbnZlcnRlcjsiXSwiZmlsZSI6ImxpYi9jc3MtY29udmVydGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
