"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _asyncbox = require("asyncbox");

var _bluebird = _interopRequireDefault(require("bluebird"));

const commands = {};
exports.commands = commands;
const PERF_RECORD_FEAT_NAME = 'perf_record';
const PERF_RECORD_SECURITY_MESSAGE = 'Performance measurement requires relaxing security for simulator. ' + `Please set '--relaxed-security' or '--allow-insecure' with '${PERF_RECORD_FEAT_NAME}' ` + 'referencing https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/security.md for more details.';
const DEFAULT_TIMEOUT_MS = 5 * 60 * 1000;
const STOP_TIMEOUT_MS = 3 * 60 * 1000;
const STARTUP_TIMEOUT_MS = 60 * 1000;
const DEFAULT_PROFILE_NAME = 'Activity Monitor';
const DEFAULT_EXT = '.trace';
const DEFAULT_PID = 'current';
const INSTRUMENTS = 'instruments';
const XCRUN = 'xcrun';
const XCTRACE = 'xctrace';

async function requireXctrace() {
  let xcrunPath;

  try {
    xcrunPath = await _appiumSupport.fs.which(XCRUN);
  } catch (e) {
    _logger.default.errorAndThrow(`${XCRUN} has not been found in PATH. ` + `Please make sure XCode development tools are installed`);
  }

  try {
    await (0, _teen_process.exec)(xcrunPath, [XCTRACE, 'help']);
  } catch (e) {
    _logger.default.errorAndThrow(`${XCTRACE} is not available for the active Xcode version. ` + `Please make sure XCode is up to date. Original error: ${e.stderr || e.message}`);
  }

  return xcrunPath;
}

async function requireInstruments() {
  try {
    return await _appiumSupport.fs.which(INSTRUMENTS);
  } catch (e) {
    _logger.default.errorAndThrow(`${INSTRUMENTS} has not been found in PATH. ` + `Please make sure XCode development tools are installed`);
  }
}

class PerfRecorder {
  constructor(reportRoot, udid, opts = {}) {
    this._process = null;
    this._zippedReportPath = '';
    this._timeout = opts.timeout && opts.timeout > 0 ? opts.timeout : DEFAULT_TIMEOUT_MS;
    this._profileName = opts.profileName || DEFAULT_PROFILE_NAME;
    this._reportPath = _path.default.resolve(reportRoot, `appium_perf__${this._profileName.replace(/\W/g, '_')}__${Date.now()}${DEFAULT_EXT}`);
    this._pid = opts.pid;
    this._udid = udid;
    this._logger = _appiumSupport.logger.getLogger(`${_lodash.default.truncate(this._profileName, {
      length: 10
    })}@${this._udid.substring(0, 8)}`);
    this._archivePromise = null;
  }

  get profileName() {
    return this._profileName;
  }

  async getOriginalReportPath() {
    return (await _appiumSupport.fs.exists(this._reportPath)) ? this._reportPath : '';
  }

  async getZippedReportPath() {
    if (!this._archivePromise) {
      this._archivePromise = (async () => {
        const originalReportPath = await this.getOriginalReportPath();

        if (!originalReportPath) {
          return '';
        }

        const zippedReportPath = await _appiumSupport.tempDir.path({
          prefix: _path.default.parse(originalReportPath).name,
          suffix: '.zip'
        });
        await _appiumSupport.zip.toArchive(zippedReportPath, {
          cwd: _path.default.dirname(this._reportPath)
        });
        await _appiumSupport.fs.rimraf(_path.default.dirname(this._reportPath));
        this._zippedReportPath = zippedReportPath;
        return this._zippedReportPath;
      })();
    }

    return await this._archivePromise;
  }

  isRunning() {
    var _this$_process;

    return !!((_this$_process = this._process) !== null && _this$_process !== void 0 && _this$_process.isRunning);
  }

  async _enforceTermination() {
    if (this._process && this.isRunning()) {
      this._logger.debug('Force-stopping the currently running perf recording');

      try {
        await this._process.stop('SIGKILL');
      } catch (ign) {}
    }

    this._process = null;

    const performCleanup = async () => {
      try {
        await _bluebird.default.all([this._zippedReportPath, _path.default.dirname(this._reportPath)].filter(Boolean).map(x => _appiumSupport.fs.rimraf(x)));
      } catch (e) {
        this._logger.warn(e.message);
      }
    };

    if (this._archivePromise) {
      this._archivePromise.finally(async () => {
        await performCleanup();
        this._archivePromise = null;
      }).catch(() => {});
    }

    await performCleanup();
    return '';
  }

  async start() {
    let binaryPath;

    try {
      binaryPath = await requireXctrace();
    } catch (e) {
      _logger.default.debug(e.message);

      _logger.default.info(`Defaulting to ${INSTRUMENTS} usage`);

      binaryPath = await requireInstruments();
    }

    const args = [];
    const toolName = _path.default.basename(binaryPath) === XCRUN ? XCTRACE : INSTRUMENTS;

    if (toolName === XCTRACE) {
      args.push(XCTRACE, 'record', '--device', this._udid, '--template', this._profileName, '--output', this._reportPath, '--time-limit', `${this._timeout}ms`);

      if (this._pid) {
        args.push('--attach', `${this._pid}`);
      } else {
        args.push('--all-processes');
      }
    } else {
      args.push('-w', this._udid, '-t', this._profileName, '-D', this._reportPath, '-l', `${this._timeout}`);

      if (this._pid) {
        args.push('-p', `${this._pid}`);
      }
    }

    const fullCmd = [binaryPath, ...args];
    this._process = new _teen_process.SubProcess(fullCmd[0], fullCmd.slice(1));
    this._archivePromise = null;

    this._logger.debug(`Starting performance recording: ${_appiumSupport.util.quote(fullCmd)}`);

    this._process.on('output', (stdout, stderr) => {
      if (_lodash.default.trim(stdout || stderr)) {
        this._logger.debug(`[${toolName}] ${stdout || stderr}`);
      }
    });

    this._process.once('exit', async (code, signal) => {
      this._process = null;

      if (code === 0) {
        this._logger.debug('Performance recording exited without errors');

        try {
          await this.getZippedReportPath();
        } catch (e) {
          this._logger.warn(e);
        }
      } else {
        await this._enforceTermination();

        this._logger.warn(`Performance recording exited with error code ${code}, signal ${signal}`);
      }
    });

    await this._process.start(0);

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        if (await this.getOriginalReportPath()) {
          return true;
        }

        if (!this._process) {
          throw new Error(`${toolName} process died unexpectedly`);
        }

        return false;
      }, {
        waitMs: STARTUP_TIMEOUT_MS,
        intervalMs: 500
      });
    } catch (e) {
      await this._enforceTermination();
      const listProfilesCommand = toolName === XCTRACE ? `${XCRUN} ${XCTRACE} list templates` : `${INSTRUMENTS} -s`;

      this._logger.errorAndThrow(`There is no ${DEFAULT_EXT} file found for performance profile ` + `'${this._profileName}'. Make sure the profile is supported on this device. ` + `You could use '${listProfilesCommand}' command to see the list of all available profiles. ` + `Check the server log for more details`);
    }

    this._logger.info(`The performance recording has started. Will timeout in ${this._timeout}ms`);
  }

  async stop(force = false) {
    if (force) {
      return await this._enforceTermination();
    }

    if (!this.isRunning()) {
      this._logger.debug('Performance recording is not running. Returning the recent result');

      return await this.getZippedReportPath();
    }

    try {
      await this._process.stop('SIGINT', STOP_TIMEOUT_MS);
    } catch (e) {
      this._logger.errorAndThrow(`Performance recording has failed to exit after ${STOP_TIMEOUT_MS}ms`);
    }

    return await this.getZippedReportPath();
  }

}

commands.mobileStartPerfRecord = async function mobileStartPerfRecord(opts = {}) {
  if (!this.isFeatureEnabled(PERF_RECORD_FEAT_NAME) && !this.isRealDevice()) {
    _logger.default.errorAndThrow(PERF_RECORD_SECURITY_MESSAGE);
  }

  const {
    timeout = DEFAULT_TIMEOUT_MS,
    profileName = DEFAULT_PROFILE_NAME,
    pid
  } = opts;

  if (!_lodash.default.isEmpty(this._perfRecorders)) {
    for (const recorder of this._perfRecorders.filter(x => x.profileName === profileName)) {
      if (recorder.isRunning()) {
        _logger.default.debug(`Performance recorder for '${profileName}' on device '${this.opts.device.udid}' ` + ` is already running. Doing nothing`);

        return;
      }

      _lodash.default.pull(this._perfRecorders, recorder);

      await recorder.stop(true);
    }
  }

  let realPid;

  if (pid) {
    if (_lodash.default.toLower(pid) === DEFAULT_PID) {
      const appInfo = await this.proxyCommand('/wda/activeAppInfo', 'GET');
      realPid = appInfo.pid;
    } else {
      realPid = pid;
    }
  }

  const recorder = new PerfRecorder(await _appiumSupport.tempDir.openDir(), this.opts.device.udid, {
    timeout: parseInt(timeout, 10),
    profileName,
    pid: parseInt(realPid, 10)
  });
  await recorder.start();
  this._perfRecorders = [...(this._perfRecorders || []), recorder];
};

commands.mobileStopPerfRecord = async function mobileStopPerfRecord(opts = {}) {
  if (!this.isFeatureEnabled(PERF_RECORD_FEAT_NAME) && !this.isRealDevice()) {
    _logger.default.errorAndThrow(PERF_RECORD_SECURITY_MESSAGE);
  }

  if (_lodash.default.isEmpty(this._perfRecorders)) {
    _logger.default.info('No performance recorders have been started. Doing nothing');

    return '';
  }

  const {
    profileName = DEFAULT_PROFILE_NAME,
    remotePath
  } = opts;

  const recorders = this._perfRecorders.filter(x => x.profileName === profileName);

  if (_lodash.default.isEmpty(recorders)) {
    _logger.default.errorAndThrow(`There are no records for performance profile '${profileName}' ` + `and device ${this.opts.device.udid}. Have you started the profiling before?`);
  }

  const recorder = _lodash.default.first(recorders);

  const resultPath = await recorder.stop();

  if (!(await _appiumSupport.fs.exists(resultPath))) {
    _logger.default.errorAndThrow(`There is no ${DEFAULT_EXT} file found for performance profile '${profileName}' ` + `and device ${this.opts.device.udid}. Make sure the selected profile is supported on this device`);
  }

  const result = await (0, _utils.encodeBase64OrUpload)(resultPath, remotePath, opts);

  _lodash.default.pull(this._perfRecorders, recorder);

  await _appiumSupport.fs.rimraf(resultPath);
  return result;
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9wZXJmb3JtYW5jZS5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsIlBFUkZfUkVDT1JEX0ZFQVRfTkFNRSIsIlBFUkZfUkVDT1JEX1NFQ1VSSVRZX01FU1NBR0UiLCJERUZBVUxUX1RJTUVPVVRfTVMiLCJTVE9QX1RJTUVPVVRfTVMiLCJTVEFSVFVQX1RJTUVPVVRfTVMiLCJERUZBVUxUX1BST0ZJTEVfTkFNRSIsIkRFRkFVTFRfRVhUIiwiREVGQVVMVF9QSUQiLCJJTlNUUlVNRU5UUyIsIlhDUlVOIiwiWENUUkFDRSIsInJlcXVpcmVYY3RyYWNlIiwieGNydW5QYXRoIiwiZnMiLCJ3aGljaCIsImUiLCJsb2ciLCJlcnJvckFuZFRocm93Iiwic3RkZXJyIiwibWVzc2FnZSIsInJlcXVpcmVJbnN0cnVtZW50cyIsIlBlcmZSZWNvcmRlciIsImNvbnN0cnVjdG9yIiwicmVwb3J0Um9vdCIsInVkaWQiLCJvcHRzIiwiX3Byb2Nlc3MiLCJfemlwcGVkUmVwb3J0UGF0aCIsIl90aW1lb3V0IiwidGltZW91dCIsIl9wcm9maWxlTmFtZSIsInByb2ZpbGVOYW1lIiwiX3JlcG9ydFBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsInJlcGxhY2UiLCJEYXRlIiwibm93IiwiX3BpZCIsInBpZCIsIl91ZGlkIiwiX2xvZ2dlciIsImxvZ2dlciIsImdldExvZ2dlciIsIl8iLCJ0cnVuY2F0ZSIsImxlbmd0aCIsInN1YnN0cmluZyIsIl9hcmNoaXZlUHJvbWlzZSIsImdldE9yaWdpbmFsUmVwb3J0UGF0aCIsImV4aXN0cyIsImdldFppcHBlZFJlcG9ydFBhdGgiLCJvcmlnaW5hbFJlcG9ydFBhdGgiLCJ6aXBwZWRSZXBvcnRQYXRoIiwidGVtcERpciIsInByZWZpeCIsInBhcnNlIiwibmFtZSIsInN1ZmZpeCIsInppcCIsInRvQXJjaGl2ZSIsImN3ZCIsImRpcm5hbWUiLCJyaW1yYWYiLCJpc1J1bm5pbmciLCJfZW5mb3JjZVRlcm1pbmF0aW9uIiwiZGVidWciLCJzdG9wIiwiaWduIiwicGVyZm9ybUNsZWFudXAiLCJCIiwiYWxsIiwiZmlsdGVyIiwiQm9vbGVhbiIsIm1hcCIsIngiLCJ3YXJuIiwiZmluYWxseSIsImNhdGNoIiwic3RhcnQiLCJiaW5hcnlQYXRoIiwiaW5mbyIsImFyZ3MiLCJ0b29sTmFtZSIsImJhc2VuYW1lIiwicHVzaCIsImZ1bGxDbWQiLCJTdWJQcm9jZXNzIiwic2xpY2UiLCJ1dGlsIiwicXVvdGUiLCJvbiIsInN0ZG91dCIsInRyaW0iLCJvbmNlIiwiY29kZSIsInNpZ25hbCIsIkVycm9yIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImxpc3RQcm9maWxlc0NvbW1hbmQiLCJmb3JjZSIsIm1vYmlsZVN0YXJ0UGVyZlJlY29yZCIsImlzRmVhdHVyZUVuYWJsZWQiLCJpc1JlYWxEZXZpY2UiLCJpc0VtcHR5IiwiX3BlcmZSZWNvcmRlcnMiLCJyZWNvcmRlciIsImRldmljZSIsInB1bGwiLCJyZWFsUGlkIiwidG9Mb3dlciIsImFwcEluZm8iLCJwcm94eUNvbW1hbmQiLCJvcGVuRGlyIiwicGFyc2VJbnQiLCJtb2JpbGVTdG9wUGVyZlJlY29yZCIsInJlbW90ZVBhdGgiLCJyZWNvcmRlcnMiLCJmaXJzdCIsInJlc3VsdFBhdGgiLCJyZXN1bHQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsUUFBUSxHQUFHLEVBQWpCOztBQUVBLE1BQU1DLHFCQUFxQixHQUFHLGFBQTlCO0FBQ0EsTUFBTUMsNEJBQTRCLEdBQUcsdUVBQ2xDLCtEQUE4REQscUJBQXNCLElBRGxELEdBRW5DLHVIQUZGO0FBR0EsTUFBTUUsa0JBQWtCLEdBQUcsSUFBSSxFQUFKLEdBQVMsSUFBcEM7QUFDQSxNQUFNQyxlQUFlLEdBQUcsSUFBSSxFQUFKLEdBQVMsSUFBakM7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxLQUFLLElBQWhDO0FBQ0EsTUFBTUMsb0JBQW9CLEdBQUcs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RCxDQUFsQjs7QUFDQSxNQUFJYSxnQkFBRTZELE9BQUYsQ0FBVWEsU0FBVixDQUFKLEVBQTBCO0FBQ3hCdEcsb0JBQUlDLGFBQUosQ0FBbUIsaURBQWdEYyxXQUFZLElBQTdELEdBQ2YsY0FBYSxLQUFLTixJQUFMLENBQVVtRixNQUFWLENBQWlCcEYsSUFBSywwQ0FEdEM7QUFFRDs7QUFFRCxRQUFNbUYsUUFBUSxHQUFHL0QsZ0JBQUUyRSxLQUFGLENBQVFELFNBQVIsQ0FBakI7O0FBQ0EsUUFBTUUsVUFBVSxHQUFHLE1BQU1iLFFBQVEsQ0FBQ3hDLElBQVQsRUFBekI7O0FBQ0EsTUFBSSxFQUFDLE1BQU10RCxrQkFBR3FDLE1BQUgsQ0FBVXNFLFVBQVYsQ0FBUCxDQUFKLEVBQWtDO0FBQ2hDeEcsb0JBQUlDLGFBQUosQ0FBbUIsZUFBY1gsV0FBWSx3Q0FBdUN5QixXQUFZLElBQTlFLEdBQ2YsY0FBYSxLQUFLTixJQUFMLENBQVVtRixNQUFWLENBQWlCcEYsSUFBSyw4REFEdEM7QUFFRDs7QUFFRCxRQUFNaUcsTUFBTSxHQUFHLE1BQU0saUNBQXFCRCxVQUFyQixFQUFpQ0gsVUFBakMsRUFBNkM1RixJQUE3QyxDQUFyQjs7QUFDQW1CLGtCQUFFaUUsSUFBRixDQUFPLEtBQUtILGNBQVosRUFBNEJDLFFBQTVCOztBQUNBLFFBQU05RixrQkFBR2tELE1BQUgsQ0FBVXlELFVBQVYsQ0FBTjtBQUNBLFNBQU9DLE1BQVA7QUFDRCxDQWhDRDs7ZUFvQ2UxSCxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMsIHppcCwgbG9nZ2VyLCB1dGlsLCB0ZW1wRGlyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgU3ViUHJvY2VzcywgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBlbmNvZGVCYXNlNjRPclVwbG9hZCB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IHdhaXRGb3JDb25kaXRpb24gfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cbmNvbnN0IGNvbW1hbmRzID0ge307XG5cbmNvbnN0IFBFUkZfUkVDT1JEX0ZFQVRfTkFNRSA9ICdwZXJmX3JlY29yZCc7XG5jb25zdCBQRVJGX1JFQ09SRF9TRUNVUklUWV9NRVNTQUdFID0gJ1BlcmZvcm1hbmNlIG1lYXN1cmVtZW50IHJlcXVpcmVzIHJlbGF4aW5nIHNlY3VyaXR5IGZvciBzaW11bGF0b3IuICcgK1xuICBgUGxlYXNlIHNldCAnLS1yZWxheGVkLXNlY3VyaXR5JyBvciAnLS1hbGxvdy1pbnNlY3VyZScgd2l0aCAnJHtQRVJGX1JFQ09SRF9GRUFUX05BTUV9JyBgICtcbiAgJ3JlZmVyZW5jaW5nIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2Jsb2IvbWFzdGVyL2RvY3MvZW4vd3JpdGluZy1ydW5uaW5nLWFwcGl1bS9zZWN1cml0eS5tZCBmb3IgbW9yZSBkZXRhaWxzLic7XG5jb25zdCBERUZBVUxUX1RJTUVPVVRfTVMgPSA1ICogNjAgKiAxMDAwO1xuY29uc3QgU1RPUF9USU1FT1VUX01TID0gMyAqIDYwICogMTAwMDtcbmNvbnN0IFNUQVJUVVBfVElNRU9VVF9NUyA9IDYwICogMTAwMDtcbmNvbnN0IERFRkFVTFRfUFJPRklMRV9OQU1FID0gJ0FjdGl2aXR5IE1vbml0b3InO1xuY29uc3QgREVGQVVMVF9FWFQgPSAnLnRyYWNlJztcbmNvbnN0IERFRkFVTFRfUElEID0gJ2N1cnJlbnQnO1xuY29uc3QgSU5TVFJVTUVOVFMgPSAnaW5zdHJ1bWVudHMnO1xuY29uc3QgWENSVU4gPSAneGNydW4nO1xuY29uc3QgWENUUkFDRSA9ICd4Y3RyYWNlJztcblxuXG5hc3luYyBmdW5jdGlvbiByZXF1aXJlWGN0cmFjZSAoKSB7XG4gIGxldCB4Y3J1blBhdGg7XG4gIHRyeSB7XG4gICAgeGNydW5QYXRoID0gYXdhaXQgZnMud2hpY2goWENSVU4pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYCR7WENSVU59IGhhcyBub3QgYmVlbiBmb3VuZCBpbiBQQVRILiBgICtcbiAgICAgIGBQbGVhc2UgbWFrZSBzdXJlIFhDb2RlIGRldmVsb3BtZW50IHRvb2xzIGFyZSBpbnN0YWxsZWRgKTtcbiAgfVxuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoeGNydW5QYXRoLCBbWENUUkFDRSwgJ2hlbHAnXSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgJHtYQ1RSQUNFfSBpcyBub3QgYXZhaWxhYmxlIGZvciB0aGUgYWN0aXZlIFhjb2RlIHZlcnNpb24uIGAgK1xuICAgICAgYFBsZWFzZSBtYWtlIHN1cmUgWENvZGUgaXMgdXAgdG8gZGF0ZS4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5zdGRlcnIgfHwgZS5tZXNzYWdlfWApO1xuICB9XG4gIHJldHVybiB4Y3J1blBhdGg7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlcXVpcmVJbnN0cnVtZW50cyAoKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IGZzLndoaWNoKElOU1RSVU1FTlRTKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGAke0lOU1RSVU1FTlRTfSBoYXMgbm90IGJlZW4gZm91bmQgaW4gUEFUSC4gYCArXG4gICAgICBgUGxlYXNlIG1ha2Ugc3VyZSBYQ29kZSBkZXZlbG9wbWVudCB0b29scyBhcmUgaW5zdGFsbGVkYCk7XG4gIH1cbn1cblxuXG5jbGFzcyBQZXJmUmVjb3JkZXIge1xuICBjb25zdHJ1Y3RvciAocmVwb3J0Um9vdCwgdWRpZCwgb3B0cyA9IHt9KSB7XG4gICAgdGhpcy5fcHJvY2VzcyA9IG51bGw7XG4gICAgdGhpcy5femlwcGVkUmVwb3J0UGF0aCA9ICcnO1xuICAgIHRoaXMuX3RpbWVvdXQgPSAob3B0cy50aW1lb3V0ICYmIG9wdHMudGltZW91dCA+IDApID8gb3B0cy50aW1lb3V0IDogREVGQVVMVF9USU1FT1VUX01TO1xuICAgIHRoaXMuX3Byb2ZpbGVOYW1lID0gb3B0cy5wcm9maWxlTmFtZSB8fCBERUZBVUxUX1BST0ZJTEVfTkFNRTtcbiAgICB0aGlzLl9yZXBvcnRQYXRoID0gcGF0aC5yZXNvbHZlKHJlcG9ydFJvb3QsXG4gICAgICBgYXBwaXVtX3BlcmZfXyR7dGhpcy5fcHJvZmlsZU5hbWUucmVwbGFjZSgvXFxXL2csICdfJyl9X18ke0RhdGUubm93KCl9JHtERUZBVUxUX0VYVH1gKTtcbiAgICB0aGlzLl9waWQgPSBvcHRzLnBpZDtcbiAgICB0aGlzLl91ZGlkID0gdWRpZDtcbiAgICB0aGlzLl9sb2dnZXIgPSBsb2dnZXIuZ2V0TG9nZ2VyKFxuICAgICAgYCR7Xy50cnVuY2F0ZSh0aGlzLl9wcm9maWxlTmFtZSwge2xlbmd0aDogMTB9KX1AJHt0aGlzLl91ZGlkLnN1YnN0cmluZygwLCA4KX1gKTtcbiAgICB0aGlzLl9hcmNoaXZlUHJvbWlzZSA9IG51bGw7XG4gIH1cblxuICBnZXQgcHJvZmlsZU5hbWUgKCkge1xuICAgIHJldHVybiB0aGlzLl9wcm9maWxlTmFtZTtcbiAgfVxuXG4gIGFzeW5jIGdldE9yaWdpbmFsUmVwb3J0UGF0aCAoKSB7XG4gICAgcmV0dXJuIChhd2FpdCBmcy5leGlzdHModGhpcy5fcmVwb3J0UGF0aCkpID8gdGhpcy5fcmVwb3J0UGF0aCA6ICcnO1xuICB9XG5cbiAgYXN5bmMgZ2V0WmlwcGVkUmVwb3J0UGF0aCAoKSB7XG4gICAgLy8gVGhpcyBpcyB0byBwcmV2ZW50IHBvc3NpYmxlIHJhY2UgY29uZGl0aW9ucywgYmVjYXVzZSB0aGUgYXJjaGl2ZSBvcGVyYXRpb25cbiAgICAvLyBjb3VsZCBiZSBwcmV0dHkgdGltZS1pbnRlbnNpdmVcbiAgICBpZiAoIXRoaXMuX2FyY2hpdmVQcm9taXNlKSB7XG4gICAgICB0aGlzLl9hcmNoaXZlUHJvbWlzZSA9IChhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG9yaWdpbmFsUmVwb3J0UGF0aCA9IGF3YWl0IHRoaXMuZ2V0T3JpZ2luYWxSZXBvcnRQYXRoKCk7XG4gICAgICAgIGlmICghb3JpZ2luYWxSZXBvcnRQYXRoKSB7XG4gICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHppcHBlZFJlcG9ydFBhdGggPSBhd2FpdCB0ZW1wRGlyLnBhdGgoe1xuICAgICAgICAgIHByZWZpeDogcGF0aC5wYXJzZShvcmlnaW5hbFJlcG9ydFBhdGgpLm5hbWUsXG4gICAgICAgICAgc3VmZml4OiAnLnppcCdcbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IHppcC50b0FyY2hpdmUoemlwcGVkUmVwb3J0UGF0aCwge1xuICAgICAgICAgIGN3ZDogcGF0aC5kaXJuYW1lKHRoaXMuX3JlcG9ydFBhdGgpLFxuICAgICAgICB9KTtcbiAgICAgICAgYXdhaXQgZnMucmltcmFmKHBhdGguZGlybmFtZSh0aGlzLl9yZXBvcnRQYXRoKSk7XG4gICAgICAgIHRoaXMuX3ppcHBlZFJlcG9ydFBhdGggPSB6aXBwZWRSZXBvcnRQYXRoO1xuICAgICAgICByZXR1cm4gdGhpcy5femlwcGVkUmVwb3J0UGF0aDtcbiAgICAgIH0pKCk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLl9hcmNoaXZlUHJvbWlzZTtcbiAgfVxuXG4gIGlzUnVubmluZyAoKSB7XG4gICAgcmV0dXJuICEhKHRoaXMuX3Byb2Nlc3M/LmlzUnVubmluZyk7XG4gIH1cblxuICBhc3luYyBfZW5mb3JjZVRlcm1pbmF0aW9uICgpIHtcbiAgICBpZiAodGhpcy5fcHJvY2VzcyAmJiB0aGlzLmlzUnVubmluZygpKSB7XG4gICAgICB0aGlzLl9sb2dnZXIuZGVidWcoJ0ZvcmNlLXN0b3BwaW5nIHRoZSBjdXJyZW50bHkgcnVubmluZyBwZXJmIHJlY29yZGluZycpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5fcHJvY2Vzcy5zdG9wKCdTSUdLSUxMJyk7XG4gICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgfVxuICAgIHRoaXMuX3Byb2Nlc3MgPSBudWxsO1xuICAgIGNvbnN0IHBlcmZvcm1DbGVhbnVwID0gYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgQi5hbGwoW3RoaXMuX3ppcHBlZFJlcG9ydFBhdGgsIHBhdGguZGlybmFtZSh0aGlzLl9yZXBvcnRQYXRoKV1cbiAgICAgICAgICAuZmlsdGVyKEJvb2xlYW4pLm1hcCgoeCkgPT4gZnMucmltcmFmKHgpKSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRoaXMuX2xvZ2dlci53YXJuKGUubWVzc2FnZSk7XG4gICAgICB9XG4gICAgfTtcbiAgICBpZiAodGhpcy5fYXJjaGl2ZVByb21pc2UpIHtcbiAgICAgIHRoaXMuX2FyY2hpdmVQcm9taXNlXG4gICAgICAgIC5maW5hbGx5KGFzeW5jICgpID0+IHtcbiAgICAgICAgICBhd2FpdCBwZXJmb3JtQ2xlYW51cCgpO1xuICAgICAgICAgIHRoaXMuX2FyY2hpdmVQcm9taXNlID0gbnVsbDtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKCgpID0+IHt9KTtcbiAgICB9XG4gICAgYXdhaXQgcGVyZm9ybUNsZWFudXAoKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICBhc3luYyBzdGFydCAoKSB7XG4gICAgbGV0IGJpbmFyeVBhdGg7XG4gICAgdHJ5IHtcbiAgICAgIGJpbmFyeVBhdGggPSBhd2FpdCByZXF1aXJlWGN0cmFjZSgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy5kZWJ1ZyhlLm1lc3NhZ2UpO1xuICAgICAgbG9nLmluZm8oYERlZmF1bHRpbmcgdG8gJHtJTlNUUlVNRU5UU30gdXNhZ2VgKTtcbiAgICAgIGJpbmFyeVBhdGggPSBhd2FpdCByZXF1aXJlSW5zdHJ1bWVudHMoKTtcbiAgICB9XG5cbiAgICBjb25zdCBhcmdzID0gW107XG4gICAgY29uc3QgdG9vbE5hbWUgPSBwYXRoLmJhc2VuYW1lKGJpbmFyeVBhdGgpID09PSBYQ1JVTiA/IFhDVFJBQ0UgOiBJTlNUUlVNRU5UUztcbiAgICBpZiAodG9vbE5hbWUgPT09IFhDVFJBQ0UpIHtcbiAgICAgIGFyZ3MucHVzaChcbiAgICAgICAgWENUUkFDRSwgJ3JlY29yZCcsXG4gICAgICAgICctLWRldmljZScsIHRoaXMuX3VkaWQsXG4gICAgICAgICctLXRlbXBsYXRlJywgdGhpcy5fcHJvZmlsZU5hbWUsXG4gICAgICAgICctLW91dHB1dCcsIHRoaXMuX3JlcG9ydFBhdGgsXG4gICAgICAgICctLXRpbWUtbGltaXQnLCBgJHt0aGlzLl90aW1lb3V0fW1zYCxcbiAgICAgICk7XG4gICAgICBpZiAodGhpcy5fcGlkKSB7XG4gICAgICAgIGFyZ3MucHVzaCgnLS1hdHRhY2gnLCBgJHt0aGlzLl9waWR9YCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhcmdzLnB1c2goJy0tYWxsLXByb2Nlc3NlcycpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBodHRwczovL2hlbHAuYXBwbGUuY29tL2luc3RydW1lbnRzL21hYy9jdXJyZW50LyMvZGV2YjE0ZmZhYTVcbiAgICAgIGFyZ3MucHVzaChcbiAgICAgICAgJy13JywgdGhpcy5fdWRpZCxcbiAgICAgICAgJy10JywgdGhpcy5fcHJvZmlsZU5hbWUsXG4gICAgICAgICctRCcsIHRoaXMuX3JlcG9ydFBhdGgsXG4gICAgICAgICctbCcsIGAke3RoaXMuX3RpbWVvdXR9YCxcbiAgICAgICk7XG4gICAgICBpZiAodGhpcy5fcGlkKSB7XG4gICAgICAgIGFyZ3MucHVzaCgnLXAnLCBgJHt0aGlzLl9waWR9YCk7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGZ1bGxDbWQgPSBbYmluYXJ5UGF0aCwgLi4uYXJnc107XG4gICAgdGhpcy5fcHJvY2VzcyA9IG5ldyBTdWJQcm9jZXNzKGZ1bGxDbWRbMF0sIGZ1bGxDbWQuc2xpY2UoMSkpO1xuICAgIHRoaXMuX2FyY2hpdmVQcm9taXNlID0gbnVsbDtcbiAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFN0YXJ0aW5nIHBlcmZvcm1hbmNlIHJlY29yZGluZzogJHt1dGlsLnF1b3RlKGZ1bGxDbWQpfWApO1xuICAgIHRoaXMuX3Byb2Nlc3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgaWYgKF8udHJpbShzdGRvdXQgfHwgc3RkZXJyKSkge1xuICAgICAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFske3Rvb2xOYW1lfV0gJHtzdGRvdXQgfHwgc3RkZXJyfWApO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMuX3Byb2Nlc3Mub25jZSgnZXhpdCcsIGFzeW5jIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgIHRoaXMuX3Byb2Nlc3MgPSBudWxsO1xuICAgICAgaWYgKGNvZGUgPT09IDApIHtcbiAgICAgICAgdGhpcy5fbG9nZ2VyLmRlYnVnKCdQZXJmb3JtYW5jZSByZWNvcmRpbmcgZXhpdGVkIHdpdGhvdXQgZXJyb3JzJyk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgLy8gY2FjaGUgemlwcGVkIHJlcG9ydFxuICAgICAgICAgIGF3YWl0IHRoaXMuZ2V0WmlwcGVkUmVwb3J0UGF0aCgpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgdGhpcy5fbG9nZ2VyLndhcm4oZSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX2VuZm9yY2VUZXJtaW5hdGlvbigpO1xuICAgICAgICB0aGlzLl9sb2dnZXIud2FybihgUGVyZm9ybWFuY2UgcmVjb3JkaW5nIGV4aXRlZCB3aXRoIGVycm9yIGNvZGUgJHtjb2RlfSwgc2lnbmFsICR7c2lnbmFsfWApO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMuX3Byb2Nlc3Muc3RhcnQoMCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgICBpZiAoYXdhaXQgdGhpcy5nZXRPcmlnaW5hbFJlcG9ydFBhdGgoKSkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5fcHJvY2Vzcykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJHt0b29sTmFtZX0gcHJvY2VzcyBkaWVkIHVuZXhwZWN0ZWRseWApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0sIHtcbiAgICAgICAgd2FpdE1zOiBTVEFSVFVQX1RJTUVPVVRfTVMsXG4gICAgICAgIGludGVydmFsTXM6IDUwMCxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGF3YWl0IHRoaXMuX2VuZm9yY2VUZXJtaW5hdGlvbigpO1xuICAgICAgY29uc3QgbGlzdFByb2ZpbGVzQ29tbWFuZCA9IHRvb2xOYW1lID09PSBYQ1RSQUNFXG4gICAgICAgID8gYCR7WENSVU59ICR7WENUUkFDRX0gbGlzdCB0ZW1wbGF0ZXNgXG4gICAgICAgIDogYCR7SU5TVFJVTUVOVFN9IC1zYDtcbiAgICAgIHRoaXMuX2xvZ2dlci5lcnJvckFuZFRocm93KGBUaGVyZSBpcyBubyAke0RFRkFVTFRfRVhUfSBmaWxlIGZvdW5kIGZvciBwZXJmb3JtYW5jZSBwcm9maWxlIGAgK1xuICAgICAgICBgJyR7dGhpcy5fcHJvZmlsZU5hbWV9Jy4gTWFrZSBzdXJlIHRoZSBwcm9maWxlIGlzIHN1cHBvcnRlZCBvbiB0aGlzIGRldmljZS4gYCArXG4gICAgICAgIGBZb3UgY291bGQgdXNlICcke2xpc3RQcm9maWxlc0NvbW1hbmR9JyBjb21tYW5kIHRvIHNlZSB0aGUgbGlzdCBvZiBhbGwgYXZhaWxhYmxlIHByb2ZpbGVzLiBgICtcbiAgICAgICAgYENoZWNrIHRoZSBzZXJ2ZXIgbG9nIGZvciBtb3JlIGRldGFpbHNgKTtcbiAgICB9XG4gICAgdGhpcy5fbG9nZ2VyLmluZm8oYFRoZSBwZXJmb3JtYW5jZSByZWNvcmRpbmcgaGFzIHN0YXJ0ZWQuIFdpbGwgdGltZW91dCBpbiAke3RoaXMuX3RpbWVvdXR9bXNgKTtcbiAgfVxuXG4gIGFzeW5jIHN0b3AgKGZvcmNlID0gZmFsc2UpIHtcbiAgICBpZiAoZm9yY2UpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9lbmZvcmNlVGVybWluYXRpb24oKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZygnUGVyZm9ybWFuY2UgcmVjb3JkaW5nIGlzIG5vdCBydW5uaW5nLiBSZXR1cm5pbmcgdGhlIHJlY2VudCByZXN1bHQnKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFppcHBlZFJlcG9ydFBhdGgoKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5fcHJvY2Vzcy5zdG9wKCdTSUdJTlQnLCBTVE9QX1RJTUVPVVRfTVMpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuX2xvZ2dlci5lcnJvckFuZFRocm93KGBQZXJmb3JtYW5jZSByZWNvcmRpbmcgaGFzIGZhaWxlZCB0byBleGl0IGFmdGVyICR7U1RPUF9USU1FT1VUX01TfW1zYCk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFppcHBlZFJlcG9ydFBhdGgoKTtcbiAgfVxufVxuXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RhcnRQZXJmUmVjb3JkT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P251bWJlcnxzdHJpbmd9IHRpbWVvdXQgWzMwMDAwMF0gLSBUaGUgbWF4aW11bSBjb3VudCBvZiBtaWxsaXNlY29uZHMgdG8gcmVjb3JkIHRoZSBwcm9maWxpbmcgaW5mb3JtYXRpb24uXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHByb2ZpbGVOYW1lIFtBY3Rpdml0eSBNb25pdG9yXSAtIFRoZSBuYW1lIG9mIGV4aXN0aW5nIHBlcmZvcm1hbmNlIHByb2ZpbGUgdG8gYXBwbHkuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENhbiBhbHNvIGNvbnRhaW4gdGhlIGZ1bGwgcGF0aCB0byB0aGUgY2hvc2VuIHRlbXBsYXRlIG9uIHRoZSBzZXJ2ZXIgZmlsZSBzeXN0ZW0uXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE5vdGUsIHRoYXQgbm90IGFsbCBwcm9maWxlcyBhcmUgc3VwcG9ydGVkIG9uIG1vYmlsZSBkZXZpY2VzLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfG51bWJlcn0gcGlkIC0gVGhlIElEIG9mIHRoZSBwcm9jZXNzIHRvIG1lYXN1cmUgdGhlIHBlcmZvcm1hbmNlIGZvci5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNldCBpdCB0byBgY3VycmVudGAgaW4gb3JkZXIgdG8gbWVhc3VyZSB0aGUgcGVyZm9ybWFuY2Ugb2ZcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSBwcm9jZXNzLCB3aGljaCBiZWxvbmdzIHRvIHRoZSBjdXJyZW50bHkgYWN0aXZlIGFwcGxpY2F0aW9uLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQWxsIHByb2Nlc3NlcyBydW5uaW5nIG9uIHRoZSBkZXZpY2UgYXJlIG1lYXN1cmVkIGlmXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWQgaXMgdW5zZXQgKHRoZSBkZWZhdWx0IHNldHRpbmcpLlxuICovXG5cbi8qKlxuICogU3RhcnRzIHBlcmZvcm1hbmNlIHByb2ZpbGluZyBmb3IgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogUmVsYXhpbmcgc2VjdXJpdHkgaXMgbWFuZGF0b3J5IGZvciBzaW11bGF0b3JzLiBJdCBjYW4gYWx3YXlzIHdvcmsgZm9yIHJlYWwgZGV2aWNlcy5cbiAqXG4gKiBTaW5jZSBYQ29kZSAxNCB0aGUgbWV0aG9kIHRyaWVzIHRvIHVzZSBgeGN0cmFjZWAgdG9vbCB0byByZWNvcmQgcGVyZm9ybWFuY2Ugc3RhdHMuXG4gKiBUaGUgYGluc3RydW1lbnRzYCBkZXZlbG9wZXIgdXRpbGl0eSBpcyB1c2VkIGFzIGEgZmFsbGJhY2sgZm9yIHRoaXMgcHVycG9zZSBpZiBgeGN0cmFjZWBcbiAqIGlzIG5vdCBhdmFpbGFibGUuXG4gKiBJdCBpcyBwb3NzaWJsZSB0byByZWNvcmQgbXVsdGlwbGUgcHJvZmlsZXMgYXQgdGhlIHNhbWUgdGltZS5cbiAqIFJlYWQgaHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2xpYnJhcnkvY29udGVudC9kb2N1bWVudGF0aW9uL0RldmVsb3BlclRvb2xzL0NvbmNlcHR1YWwvSW5zdHJ1bWVudHNVc2VyR3VpZGUvUmVjb3JkaW5nLFBhdXNpbmcsYW5kU3RvcHBpbmdUcmFjZXMuaHRtbFxuICogZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBAcGFyYW0gez9TdGFydFBlcmZSZWNvcmRPcHRpb25zfSBvcHRzIC0gVGhlIHNldCBvZiBwb3NzaWJsZSBzdGFydCByZWNvcmQgb3B0aW9uc1xuICovXG5jb21tYW5kcy5tb2JpbGVTdGFydFBlcmZSZWNvcmQgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVTdGFydFBlcmZSZWNvcmQgKG9wdHMgPSB7fSkge1xuICBpZiAoIXRoaXMuaXNGZWF0dXJlRW5hYmxlZChQRVJGX1JFQ09SRF9GRUFUX05BTUUpICYmICF0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coUEVSRl9SRUNPUkRfU0VDVVJJVFlfTUVTU0FHRSk7XG4gIH1cblxuICBjb25zdCB7XG4gICAgdGltZW91dCA9IERFRkFVTFRfVElNRU9VVF9NUyxcbiAgICBwcm9maWxlTmFtZSA9IERFRkFVTFRfUFJPRklMRV9OQU1FLFxuICAgIHBpZCxcbiAgfSA9IG9wdHM7XG5cbiAgaWYgKCFfLmlzRW1wdHkodGhpcy5fcGVyZlJlY29yZGVycykpIHtcbiAgICBmb3IgKGNvbnN0IHJlY29yZGVyIG9mIHRoaXMuX3BlcmZSZWNvcmRlcnMuZmlsdGVyKCh4KSA9PiB4LnByb2ZpbGVOYW1lID09PSBwcm9maWxlTmFtZSkpIHtcbiAgICAgIGlmIChyZWNvcmRlci5pc1J1bm5pbmcoKSkge1xuICAgICAgICBsb2cuZGVidWcoYFBlcmZvcm1hbmNlIHJlY29yZGVyIGZvciAnJHtwcm9maWxlTmFtZX0nIG9uIGRldmljZSAnJHt0aGlzLm9wdHMuZGV2aWNlLnVkaWR9JyBgICtcbiAgICAgICAgICBgIGlzIGFscmVhZHkgcnVubmluZy4gRG9pbmcgbm90aGluZ2ApO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBfLnB1bGwodGhpcy5fcGVyZlJlY29yZGVycywgcmVjb3JkZXIpO1xuICAgICAgYXdhaXQgcmVjb3JkZXIuc3RvcCh0cnVlKTtcbiAgICB9XG4gIH1cblxuICBsZXQgcmVhbFBpZDtcbiAgaWYgKHBpZCkge1xuICAgIGlmIChfLnRvTG93ZXIocGlkKSA9PT0gREVGQVVMVF9QSUQpIHtcbiAgICAgIGNvbnN0IGFwcEluZm8gPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3dkYS9hY3RpdmVBcHBJbmZvJywgJ0dFVCcpO1xuICAgICAgcmVhbFBpZCA9IGFwcEluZm8ucGlkO1xuICAgIH0gZWxzZSB7XG4gICAgICByZWFsUGlkID0gcGlkO1xuICAgIH1cbiAgfVxuICBjb25zdCByZWNvcmRlciA9IG5ldyBQZXJmUmVjb3JkZXIoYXdhaXQgdGVtcERpci5vcGVuRGlyKCksIHRoaXMub3B0cy5kZXZpY2UudWRpZCwge1xuICAgIHRpbWVvdXQ6IHBhcnNlSW50KHRpbWVvdXQsIDEwKSxcbiAgICBwcm9maWxlTmFtZSxcbiAgICBwaWQ6IHBhcnNlSW50KHJlYWxQaWQsIDEwKSxcbiAgfSk7XG4gIGF3YWl0IHJlY29yZGVyLnN0YXJ0KCk7XG4gIHRoaXMuX3BlcmZSZWNvcmRlcnMgPSBbLi4uKHRoaXMuX3BlcmZSZWNvcmRlcnMgfHwgW10pLCByZWNvcmRlcl07XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0b3BSZWNvcmRpbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gdGhlIHJlbW90ZSBsb2NhdGlvbiwgd2hlcmUgdGhlIHJlc3VsdGluZyB6aXBwZWQgLnRyYWNlIGZpbGUgc2hvdWxkIGJlIHVwbG9hZGVkLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGZvbGxvd2luZyBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZDogaHR0cC9odHRwcywgZnRwLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTnVsbCBvciBlbXB0eSBzdHJpbmcgdmFsdWUgKHRoZSBkZWZhdWx0IHNldHRpbmcpIG1lYW5zIHRoZSBjb250ZW50IG9mIHJlc3VsdGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZSBzaG91bGQgYmUgemlwcGVkLCBlbmNvZGVkIGFzIEJhc2U2NCBhbmQgcGFzc2VkIGFzIHRoZSBlbmRwb2ludCByZXNwb25zZSB2YWx1ZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBpZiB0aGUgZ2VuZXJhdGVkIGZpbGUgaXMgdG9vIGJpZyB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZml0IGludG8gdGhlIGF2YWlsYWJsZSBwcm9jZXNzIG1lbW9yeS5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdXNlciAtIFRoZSBuYW1lIG9mIHRoZSB1c2VyIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGFzcyAtIFRoZSBwYXNzd29yZCBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG1ldGhvZCBbUFVUXSAtIFRoZSBodHRwIG11bHRpcGFydCB1cGxvYWQgbWV0aG9kIG5hbWUuIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBwcm9maWxlTmFtZSBbQWN0aXZpdHkgTW9uaXRvcl0gLSBUaGUgbmFtZSBvZiBhbiBleGlzdGluZyBwZXJmb3JtYW5jZSBwcm9maWxlIGZvciB3aGljaCB0aGUgcmVjb3JkaW5nIGhhcyBiZWVuIG1hZGUuXG4gKiBAcHJvcGVydHkgez9PYmplY3R9IGhlYWRlcnMgLSBBZGRpdGlvbmFsIGhlYWRlcnMgbWFwcGluZyBmb3IgbXVsdGlwYXJ0IGh0dHAocykgdXBsb2Fkc1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSBmaWxlRmllbGROYW1lIFtmaWxlXSAtIFRoZSBuYW1lIG9mIHRoZSBmb3JtIGZpZWxkLCB3aGVyZSB0aGUgZmlsZSBjb250ZW50IEJMT0Igc2hvdWxkIGJlIHN0b3JlZCBmb3JcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwKHMpIHVwbG9hZHNcbiAqIEBwcm9wZXJ0eSB7P09iamVjdHxBcnJheTxQYWlyPn0gZm9ybUZpZWxkcyAtIEFkZGl0aW9uYWwgZm9ybSBmaWVsZHMgZm9yIG11bHRpcGFydCBodHRwKHMpIHVwbG9hZHNcbiAqL1xuXG4vKipcbiAqIFN0b3BzIHBlcmZvcm1hbmNlIHByb2ZpbGluZyBmb3IgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogVGhlIHJlc3VsdGluZyBmaWxlIGluIC50cmFjZSBmb3JtYXQgY2FuIGJlIGVpdGhlciByZXR1cm5lZFxuICogZGlyZWN0bHkgYXMgYmFzZTY0LWVuY29kZWQgemlwIGFyY2hpdmUgb3IgdXBsb2FkZWQgdG8gYSByZW1vdGUgbG9jYXRpb25cbiAqIChzdWNoIGZpbGVzIGNhbiBiZSBwcmV0dHkgbGFyZ2UpLiBBZnRlcndhcmRzIGl0IGlzIHBvc3NpYmxlIHRvIHVuYXJjaGl2ZSBhbmRcbiAqIG9wZW4gc3VjaCBmaWxlIHdpdGggWGNvZGUgRGV2IFRvb2xzLlxuICpcbiAqIEBwYXJhbSB7P1N0b3BSZWNvcmRpbmdPcHRpb25zfSBvcHRzIC0gVGhlIHNldCBvZiBwb3NzaWJsZSBzdG9wIHJlY29yZCBvcHRpb25zXG4gKiBAcmV0dXJuIHtzdHJpbmd9IEVpdGhlciBhbiBlbXB0eSBzdHJpbmcgaWYgdGhlIHVwbG9hZCB3YXMgc3VjY2Vzc2Z1bCBvciBiYXNlLTY0IGVuY29kZWRcbiAqIGNvbnRlbnQgb2YgemlwcGVkIC50cmFjZSBmaWxlLlxuICogQHRocm93cyB7RXJyb3J9IElmIG5vIHBlcmZvcm1hbmNlIHJlY29yZGluZyB3aXRoIGdpdmVuIHByb2ZpbGUgbmFtZS9kZXZpY2UgdWRpZCBjb21iaW5hdGlvblxuICogaGFzIGJlZW4gc3RhcnRlZCBiZWZvcmUgb3IgdGhlIHJlc3VsdGluZyAudHJhY2UgZmlsZSBoYXMgbm90IGJlZW4gZ2VuZXJhdGVkIHByb3Blcmx5LlxuICovXG5jb21tYW5kcy5tb2JpbGVTdG9wUGVyZlJlY29yZCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVN0b3BQZXJmUmVjb3JkIChvcHRzID0ge30pIHtcbiAgaWYgKCF0aGlzLmlzRmVhdHVyZUVuYWJsZWQoUEVSRl9SRUNPUkRfRkVBVF9OQU1FKSAmJiAhdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KFBFUkZfUkVDT1JEX1NFQ1VSSVRZX01FU1NBR0UpO1xuICB9XG5cbiAgaWYgKF8uaXNFbXB0eSh0aGlzLl9wZXJmUmVjb3JkZXJzKSkge1xuICAgIGxvZy5pbmZvKCdObyBwZXJmb3JtYW5jZSByZWNvcmRlcnMgaGF2ZSBiZWVuIHN0YXJ0ZWQuIERvaW5nIG5vdGhpbmcnKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICBjb25zdCB7XG4gICAgcHJvZmlsZU5hbWUgPSBERUZBVUxUX1BST0ZJTEVfTkFNRSxcbiAgICByZW1vdGVQYXRoLFxuICB9ID0gb3B0cztcblxuICBjb25zdCByZWNvcmRlcnMgPSB0aGlzLl9wZXJmUmVjb3JkZXJzLmZpbHRlcigoeCkgPT4geC5wcm9maWxlTmFtZSA9PT0gcHJvZmlsZU5hbWUpO1xuICBpZiAoXy5pc0VtcHR5KHJlY29yZGVycykpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVGhlcmUgYXJlIG5vIHJlY29yZHMgZm9yIHBlcmZvcm1hbmNlIHByb2ZpbGUgJyR7cHJvZmlsZU5hbWV9JyBgICtcbiAgICAgIGBhbmQgZGV2aWNlICR7dGhpcy5vcHRzLmRldmljZS51ZGlkfS4gSGF2ZSB5b3Ugc3RhcnRlZCB0aGUgcHJvZmlsaW5nIGJlZm9yZT9gKTtcbiAgfVxuXG4gIGNvbnN0IHJlY29yZGVyID0gXy5maXJzdChyZWNvcmRlcnMpO1xuICBjb25zdCByZXN1bHRQYXRoID0gYXdhaXQgcmVjb3JkZXIuc3RvcCgpO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhyZXN1bHRQYXRoKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGVyZSBpcyBubyAke0RFRkFVTFRfRVhUfSBmaWxlIGZvdW5kIGZvciBwZXJmb3JtYW5jZSBwcm9maWxlICcke3Byb2ZpbGVOYW1lfScgYCArXG4gICAgICBgYW5kIGRldmljZSAke3RoaXMub3B0cy5kZXZpY2UudWRpZH0uIE1ha2Ugc3VyZSB0aGUgc2VsZWN0ZWQgcHJvZmlsZSBpcyBzdXBwb3J0ZWQgb24gdGhpcyBkZXZpY2VgKTtcbiAgfVxuXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGVuY29kZUJhc2U2NE9yVXBsb2FkKHJlc3VsdFBhdGgsIHJlbW90ZVBhdGgsIG9wdHMpO1xuICBfLnB1bGwodGhpcy5fcGVyZlJlY29yZGVycywgcmVjb3JkZXIpO1xuICBhd2FpdCBmcy5yaW1yYWYocmVzdWx0UGF0aCk7XG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5cbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3BlcmZvcm1hbmNlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
