"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.helpers = exports.extensions = exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _momentTimezone = _interopRequireDefault(require("moment-timezone"));

var _appiumIosDevice = require("appium-ios-device");

var _teen_process = require("teen_process");

var _appUtils = require("../app-utils");

let commands = {},
    helpers = {},
    extensions = {};
exports.extensions = extensions;
exports.helpers = helpers;
exports.commands = commands;
const MOMENT_FORMAT_ISO8601 = 'YYYY-MM-DDTHH:mm:ssZ';

commands.active = async function active() {
  if (this.isWebContext()) {
    return this.cacheWebElements(await this.executeAtom('active_element', []));
  }

  return await this.proxyCommand(`/element/active`, 'GET');
};

commands.background = async function background(seconds) {
  const homescreen = '/wda/homescreen';
  const deactivateApp = '/wda/deactivateApp';
  let endpoint;
  let params = {};

  const selectEndpoint = timeoutSeconds => {
    if (!_appiumSupport.util.hasValue(timeoutSeconds)) {
      endpoint = homescreen;
    } else if (!isNaN(timeoutSeconds)) {
      const duration = parseFloat(timeoutSeconds);

      if (duration >= 0) {
        params = {
          duration
        };
        endpoint = deactivateApp;
      } else {
        endpoint = homescreen;
      }
    }
  };

  if (_lodash.default.has(seconds, 'timeout')) {
    const {
      timeout
    } = seconds;
    selectEndpoint(isNaN(timeout) ? timeout : parseFloat(timeout) / 1000.0);
  } else {
    selectEndpoint(seconds);
  }

  if (!endpoint) {
    _logger.default.errorAndThrow(`Argument value is expected to be a valid number. ` + `${JSON.stringify(seconds)} has been provided instead`);
  }

  return await this.proxyCommand(endpoint, 'POST', params, endpoint !== homescreen);
};

commands.touchId = async function touchId(match = true) {
  await this.mobileSendBiometricMatch({
    match
  });
};

commands.toggleEnrollTouchId = async function toggleEnrollTouchId(isEnabled = true) {
  await this.mobileEnrollBiometric({
    isEnabled
  });
};

helpers.getWindowSizeWeb = async function getWindowSizeWeb() {
  return await this.executeAtom('get_window_size', []);
};

helpers.getWindowSizeNative = async function getWindowSizeNative() {
  return await this.proxyCommand(`/window/size`, 'GET');
};

commands.getWindowSize = async function getWindowSize(windowHandle = 'current') {
  if (windowHandle !== 'current') {
    throw new _appiumBaseDriver.errors.NotYetImplementedError('Currently only getting current window size is supported.');
  }

  if (!this.isWebContext()) {
    return await this.getWindowSizeNative();
  } else {
    return await this.getWindowSizeWeb();
  }
};

commands.getDeviceTime = async function getDeviceTime(format = MOMENT_FORMAT_ISO8601) {
  _logger.default.info('Attempting to capture iOS device date and time');

  if (!this.isRealDevice()) {
    _logger.default.info('On simulator. Assuming device time is the same as host time');

    const cmd = 'date';
    const args = ['+%Y-%m-%dT%H:%M:%S%z'];
    const inputFormat = 'YYYY-MM-DDTHH:mm:ssZZ';
    const stdout = (await (0, _teen_process.exec)(cmd, args)).stdout.trim();

    _logger.default.debug(`Got the following output out of '${cmd} ${args.join(' ')}': ${stdout}`);

    const parsedTimestamp = _momentTimezone.default.utc(stdout, inputFormat);

    if (!parsedTimestamp.isValid()) {
      _logger.default.warn(`Cannot parse the timestamp '${stdout}' returned by '${cmd}' command. Returning it as is`);

      return stdout;
    }

    return parsedTimestamp.utcOffset(parsedTimestamp._tzm || 0).format(format);
  }

  const {
    timestamp,
    utcOffset,
    timeZone
  } = await _appiumIosDevice.utilities.getDeviceTime(this.opts.udid);

  _logger.default.debug(`timestamp: ${timestamp}, utcOffset: ${utcOffset}, timeZone: ${timeZone}`);

  const utc = _momentTimezone.default.unix(timestamp).utc();

  if (Math.abs(utcOffset) <= 12 * 60) {
    return utc.utcOffset(utcOffset).format(format);
  }

  if (_lodash.default.includes(timeZone, '/')) {
    return utc.tz(timeZone).format(format);
  }

  if (Math.abs(timeZone) <= 12 * 60 * 60) {
    return utc.utcOffset(timeZone / 60).format(format);
  }

  _logger.default.warn('Did not know how to apply the UTC offset. Returning the timestamp without it');

  return utc.format(format);
};

commands.mobileGetDeviceTime = async function mobileGetDeviceTime(opts = {}) {
  return await this.getDeviceTime(opts.format);
};

commands.getWindowRect = async function getWindowRect() {
  const {
    width,
    height
  } = await this.getWindowSize();
  return {
    width,
    height,
    x: 0,
    y: 0
  };
};

commands.hideKeyboard = async function hideKeyboard(strategy, ...possibleKeys) {
  const keyNames = _lodash.default.compact(possibleKeys.slice(0, -1)).map(x => `${x}`);

  if (!keyNames.includes('done')) {
    keyNames.push('done');
  }

  await this.proxyCommand('/wda/keyboard/dismiss', 'POST', {
    keyNames
  });
};

commands.getStrings = async function getStrings(language, stringFile = null) {
  _logger.default.debug(`Gettings strings for language '${language}' and string file '${stringFile}'`);

  return await (0, _appUtils.parseLocalizableStrings)(Object.assign({}, this.opts, {
    language,
    stringFile,
    strictMode: true
  }));
};

commands.removeApp = async function removeApp(bundleId) {
  return await this.mobileRemoveApp({
    bundleId
  });
};

commands.launchApp = async function launchApp() {
  const appName = this.opts.app || this.opts.bundleId;

  try {
    await this.start();

    _logger.default.info(`Successfully launched the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while launching the '${appName}' app.`);

    throw err;
  }
};

commands.closeApp = async function closeApp() {
  const appName = this.opts.app || this.opts.bundleId;

  try {
    await this.stop();

    _logger.default.info(`Successfully closed the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while closing the '${appName}' app.`);

    throw err;
  }
};

commands.keys = async function keys(keys) {
  if (!this.isWebContext()) {
    throw new _appiumBaseDriver.errors.UnknownError('Command should be proxied to WDA');
  }

  let el = _appiumSupport.util.unwrapElement(await this.active());

  if (_lodash.default.isEmpty(el)) {
    throw new _appiumBaseDriver.errors.NoSuchElementError();
  }

  await this.setValue(keys, el);
};

commands.setUrl = async function setUrl(url) {
  _logger.default.debug(`Attempting to set url '${url}'`);

  if (this.isWebContext()) {
    this.setCurrentUrl(url);
    this.curWebFrames = [];
    await this.remote.navToUrl(url);
    return;
  }

  if (this.isRealDevice()) {
    await this.proxyCommand('/url', 'POST', {
      url
    });
  } else {
    await this.opts.device.simctl.openUrl(url);
  }
};

commands.getViewportRect = async function getViewportRect() {
  const scale = await this.getDevicePixelRatio();
  const statusBarHeight = Math.round((await this.getStatusBarHeight()) * scale);
  const windowSize = await this.getWindowSize();
  return {
    left: 0,
    top: statusBarHeight,
    width: windowSize.width * scale,
    height: windowSize.height * scale - statusBarHeight
  };
};

commands.getScreenInfo = async function getScreenInfo() {
  return await this.proxyCommand('/wda/screen', 'GET');
};

commands.getStatusBarHeight = async function getStatusBarHeight() {
  const {
    statusBarSize
  } = await this.getScreenInfo();
  return statusBarSize.height;
};

commands.getDevicePixelRatio = async function getDevicePixelRatio() {
  const {
    scale
  } = await this.getScreenInfo();
  return scale;
};

commands.mobilePressButton = async function mobilePressButton(opts = {}) {
  const {
    name,
    durationSeconds
  } = opts;

  if (!name) {
    throw new _appiumBaseDriver.errors.InvalidArgumentError('Button name is mandatory');
  }

  if (!_lodash.default.isNil(durationSeconds) && !_lodash.default.isNumber(durationSeconds)) {
    throw new _appiumBaseDriver.errors.InvalidArgumentError('durationSeconds should be a number');
  }

  return await this.proxyCommand('/wda/pressButton', 'POST', {
    name,
    duration: durationSeconds
  });
};

commands.mobileSiriCommand = async function mobileSiriCommand(opts = {}) {
  const {
    text
  } = opts;

  if (!_appiumSupport.util.hasValue(text)) {
    throw new _appiumBaseDriver.errors.InvalidArgumentError('"text" argument is mandatory');
  }

  return await this.proxyCommand('/wda/siri/activate', 'POST', {
    text
  });
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJNT01FTlRfRk9STUFUX0lTTzg2MDEiLCJhY3RpdmUiLCJpc1dlYkNvbnRleHQiLCJjYWNoZVdlYkVsZW1lbnRzIiwiZXhlY3V0ZUF0b20iLCJwcm94eUNvbW1hbmQiLCJiYWNrZ3JvdW5kIiwic2Vjb25kcyIsImhvbWVzY3JlZW4iLCJkZWFjdGl2YXRlQXBwIiwiZW5kcG9pbnQiLCJwYXJhbXMiLCJzZWxlY3RFbmRwb2ludCIsInRpbWVvdXRTZWNvbmRzIiwidXRpbCIsImhhc1ZhbHVlIiwiaXNOYU4iLCJkdXJhdGlvbiIsInBhcnNlRmxvYXQiLCJfIiwiaGFzIiwidGltZW91dCIsImxvZyIsImVycm9yQW5kVGhyb3ciLCJKU09OIiwic3RyaW5naWZ5IiwidG91Y2hJZCIsIm1hdGNoIiwibW9iaWxlU2VuZEJpb21ldHJpY01hdGNoIiwidG9nZ2xlRW5yb2xsVG91Y2hJZCIsImlzRW5hYmxlZCIsIm1vYmlsZUVucm9sbEJpb21ldHJpYyIsImdldFdpbmRvd1NpemVXZWIiLCJnZXRXaW5kb3dTaXplTmF0aXZlIiwiZ2V0V2luZG93U2l6ZSIsIndpbmRvd0hhbmRsZSIsImVycm9ycyIsIk5vdFlldEltcGxlbWVudGVkRXJyb3IiLCJnZXREZXZpY2VUaW1lIiwiZm9ybWF0IiwiaW5mbyIsImlzUmVhbERldmljZSIsImNtZCIsImFyZ3MiLCJpbnB1dEZvcm1hdCIsInN0ZG91dCIsInRyaW0iLCJkZWJ1ZyIsImpvaW4iLCJwYXJzZWRUaW1lc3RhbXAiLCJtb21lbnQiLCJ1dGMiLCJpc1ZhbGlkIiwid2FybiIsInV0Y09mZnNldCIsIl90em0iLCJ0aW1lc3RhbXAiLCJ0aW1lWm9uZSIsInV0aWxpdGllcyIsIm9wdHMiLCJ1ZGlkIiwidW5peCIsIk1hdGgiLCJhYnMiLCJpbmNsdWRlcyIsInR6IiwibW9iaWxlR2V0RGV2aWNlVGltZSIsImdldFdpbmRvd1JlY3QiLCJ3aWR0aCIsImhlaWdodCIsIngiLCJ5IiwiaGlkZUtleWJvYXJkIiwic3RyYXRlZ3kiLCJwb3NzaWJsZUtleXMiLCJrZXlOYW1lcyIsImNvbXBhY3QiLCJzbGljZSIsIm1hcCIsInB1c2giLCJnZXRTdHJpbmdzIiwibGFuZ3VhZ2UiLCJzdHJpbmdGaWxlIiwiT2JqZWN0IiwiYXNzaWduIiwic3RyaWN0TW9kZSIsInJlbW92ZUFwcCIsImJ1bmRsZUlkIiwibW9iaWxlUmVtb3ZlQXBwIiwibGF1bmNoQXBwIiwiYXBwTmFtZSIsImFwcCIsInN0YXJ0IiwiZXJyIiwiY2xvc2VBcHAiLCJzdG9wIiwia2V5cyIsIlVua25vd25FcnJvciIsImVsIiwidW53cmFwRWxlbWVudCIsImlzRW1wdHkiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJzZXRWYWx1ZSIsInNldFVybCIsInVybCIsInNldEN1cnJlbnRVcmwiLCJjdXJXZWJGcmFtZXMiLCJyZW1vdGUiLCJuYXZUb1VybCIsImRldmljZSIsInNpbWN0bCIsIm9wZW5VcmwiLCJnZXRWaWV3cG9ydFJlY3QiLCJzY2FsZSIsImdldERldmljZVBpeGVsUmF0aW8iLCJzdGF0dXNCYXJIZWlnaHQiLCJyb3VuZCIsImdldFN0YXR1c0JhckhlaWdodCIsIndpbmRvd1NpemUiLCJsZWZ0IiwidG9wIiwiZ2V0U2NyZWVuSW5mbyIsInN0YXR1c0JhclNpemUiLCJtb2JpbGVQcmVzc0J1dHRvbiIsIm5hbWUiLCJkdXJhdGlvblNlY29uZHMiLCJJbnZhbGlkQXJndW1lbnRFcnJvciIsImlzTmlsIiwiaXNOdW1iZXIiLCJtb2JpbGVTaXJpQ29tbWFuZCIsInRleHQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsUUFBUSxHQUFHLEVBQWY7QUFBQSxJQUFtQkMsT0FBTyxHQUFHLEVBQTdCO0FBQUEsSUFBaUNDLFVBQVUsR0FBRyxFQUE5Qzs7OztBQUVBLE1B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cGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQtdGltZXpvbmUnO1xuaW1wb3J0IHsgdXRpbGl0aWVzIH0gZnJvbSAnYXBwaXVtLWlvcy1kZXZpY2UnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBwYXJzZUxvY2FsaXphYmxlU3RyaW5ncyB9IGZyb20gJy4uL2FwcC11dGlscyc7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29uc3QgTU9NRU5UX0ZPUk1BVF9JU084NjAxID0gJ1lZWVktTU0tRERUSEg6bW06c3NaJztcblxuXG5jb21tYW5kcy5hY3RpdmUgPSBhc3luYyBmdW5jdGlvbiBhY3RpdmUgKCkge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiB0aGlzLmNhY2hlV2ViRWxlbWVudHMoYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnYWN0aXZlX2VsZW1lbnQnLCBbXSkpO1xuICB9XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChgL2VsZW1lbnQvYWN0aXZlYCwgJ0dFVCcpO1xufTtcblxuLyoqXG4gKiBDbG9zZSBhcHAgKHNpbXVsYXRlIGRldmljZSBob21lIGJ1dHRvbikuIEl0IGlzIHBvc3NpYmxlIHRvIHJlc3RvcmVcbiAqIHRoZSBhcHAgYWZ0ZXIgdGhlIHRpbWVvdXQgb3Iga2VlcCBpdCBtaW5pbWl6ZWQgYmFzZWQgb24gdGhlIHBhcmFtZXRlciB2YWx1ZS5cbiAqXG4gKiBAcGFyYW0gez9udW1iZXJ8T2JqZWN0fSBzZWNvbmRzXG4gKiAtIGFueSBwb3NpdGl2ZSBudW1iZXIgb2Ygc2Vjb25kczogY29tZSBiYWNrIGFmdGVyIFggc2Vjb25kc1xuICogLSBhbnkgbmVnYXRpdmUgbnVtYmVyIG9mIHNlY29uZHMgb3IgemVybzogbmV2ZXIgY29tZSBiYWNrXG4gKiAtIHVuZGVmaW5lZC9udWxsOiBuZXZlciBjb21lIGJhY2tcbiAqIC0ge3RpbWVvdXQ6IDUwMDB9OiBjb21lIGJhY2sgYWZ0ZXIgNSBzZWNvbmRzXG4gKiAtIHt0aW1lb3V0OiBudWxsfSwge3RpbWVvdXQ6IC0yfTogbmV2ZXIgY29tZSBiYWNrXG4gKi9cbmNvbW1hbmRzLmJhY2tncm91bmQgPSBhc3luYyBmdW5jdGlvbiBiYWNrZ3JvdW5kIChzZWNvbmRzKSB7XG4gIGNvbnN0IGhvbWVzY3JlZW4gPSAnL3dkYS9ob21lc2NyZWVuJztcbiAgY29uc3QgZGVhY3RpdmF0ZUFwcCA9ICcvd2RhL2RlYWN0aXZhdGVBcHAnO1xuXG4gIGxldCBlbmRwb2ludDtcbiAgbGV0IHBhcmFtcyA9IHt9O1xuICBjb25zdCBzZWxlY3RFbmRwb2ludCA9ICh0aW1lb3V0U2Vjb25kcykgPT4ge1xuICAgIGlmICghdXRpbC5oYXNWYWx1ZSh0aW1lb3V0U2Vjb25kcykpIHtcbiAgICAgIGVuZHBvaW50ID0gaG9tZXNjcmVlbjtcbiAgICB9IGVsc2UgaWYgKCFpc05hTih0aW1lb3V0U2Vjb25kcykpIHtcbiAgICAgIGNvbnN0IGR1cmF0aW9uID0gcGFyc2VGbG9hdCh0aW1lb3V0U2Vjb25kcyk7XG4gICAgICBpZiAoZHVyYXRpb24gPj0gMCkge1xuICAgICAgICBwYXJhbXMgPSB7ZHVyYXRpb259O1xuICAgICAgICBlbmRwb2ludCA9IGRlYWN0aXZhdGVBcHA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBlbmRwb2ludCA9IGhvbWVzY3JlZW47XG4gICAgICB9XG4gICAgfVxuICB9O1xuICBpZiAoXy5oYXMoc2Vjb25kcywgJ3RpbWVvdXQnKSkge1xuICAgIGNvbnN0IHt0aW1lb3V0fSA9IHNlY29uZHM7XG4gICAgc2VsZWN0RW5kcG9pbnQoaXNOYU4odGltZW91dCkgPyB0aW1lb3V0IDogcGFyc2VGbG9hdCh0aW1lb3V0KSAvIDEwMDAuMCk7XG4gIH0gZWxzZSB7XG4gICAgc2VsZWN0RW5kcG9pbnQoc2Vjb25kcyk7XG4gIH1cbiAgaWYgKCFlbmRwb2ludCkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBBcmd1bWVudCB2YWx1ZSBpcyBleHBlY3RlZCB0byBiZSBhIHZhbGlkIG51bWJlci4gYCArXG4gICAgICBgJHtKU09OLnN0cmluZ2lmeShzZWNvbmRzKX0gaGFzIGJlZW4gcHJvdmlkZWQgaW5zdGVhZGApO1xuICB9XG4gIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChlbmRwb2ludCwgJ1BPU1QnLCBwYXJhbXMsIGVuZHBvaW50ICE9PSBob21lc2NyZWVuKTtcbn07XG5cbmNvbW1hbmRzLnRvdWNoSWQgPSBhc3luYyBmdW5jdGlvbiB0b3VjaElkIChtYXRjaCA9IHRydWUpIHtcbiAgYXdhaXQgdGhpcy5tb2JpbGVTZW5kQmlvbWV0cmljTWF0Y2goe21hdGNofSk7XG59O1xuXG5jb21tYW5kcy50b2dnbGVFbnJvbGxUb3VjaElkID0gYXN5bmMgZnVuY3Rpb24gdG9nZ2xlRW5yb2xsVG91Y2hJZCAoaXNFbmFibGVkID0gdHJ1ZSkge1xuICBhd2FpdCB0aGlzLm1vYmlsZUVucm9sbEJpb21ldHJpYyh7aXNFbmFibGVkfSk7XG59O1xuXG5oZWxwZXJzLmdldFdpbmRvd1NpemVXZWIgPSBhc3luYyBmdW5jdGlvbiBnZXRXaW5kb3dTaXplV2ViICgpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF93aW5kb3dfc2l6ZScsIFtdKTtcbn07XG5cbmhlbHBlcnMuZ2V0V2luZG93U2l6ZU5hdGl2ZSA9IGFzeW5jIGZ1bmN0aW9uIGdldFdpbmRvd1NpemVOYXRpdmUgKCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC93aW5kb3cvc2l6ZWAsICdHRVQnKTtcbn07XG5cbmNvbW1hbmRzLmdldFdpbmRvd1NpemUgPSBhc3luYyBmdW5jdGlvbiBnZXRXaW5kb3dTaXplICh3aW5kb3dIYW5kbGUgPSAnY3VycmVudCcpIHtcbiAgaWYgKHdpbmRvd0hhbmRsZSAhPT0gJ2N1cnJlbnQnKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCdDdXJyZW50bHkgb25seSBnZXR0aW5nIGN1cnJlbnQgd2luZG93IHNpemUgaXMgc3VwcG9ydGVkLicpO1xuICB9XG5cbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZU5hdGl2ZSgpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemVXZWIoKTtcbiAgfVxufTtcblxuLyoqXG4gKiBSZXRyaWV2ZXMgdGhlIGN1cnJlbnQgZGV2aWNlJ3MgdGltZXN0YW1wLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBmb3JtYXQgLSBUaGUgc2V0IG9mIGZvcm1hdCBzcGVjaWZpZXJzLiBSZWFkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cHM6Ly9tb21lbnRqcy5jb20vZG9jcy8gdG8gZ2V0IHRoZSBmdWxsIGxpc3Qgb2Ygc3VwcG9ydGVkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZXRpbWUgZm9ybWF0IHNwZWNpZmllcnMuIFRoZSBkZWZhdWx0IGZvcm1hdCBpc1xuICogICAgICAgICAgICAgICAgICAgICAgICAgIGBZWVlZLU1NLUREVEhIOm1tOnNzWmAsIHdoaWNoIGNvbXBsaWVzIHRvIElTTy04NjAxXG4gKiBAcmV0dXJucyBGb3JtYXR0ZWQgZGF0ZXRpbWUgc3RyaW5nIG9yIHRoZSByYXcgY29tbWFuZCBvdXRwdXQgaWYgZm9ybWF0dGluZyBmYWlsc1xuICovXG5jb21tYW5kcy5nZXREZXZpY2VUaW1lID0gYXN5bmMgZnVuY3Rpb24gZ2V0RGV2aWNlVGltZSAoZm9ybWF0ID0gTU9NRU5UX0ZPUk1BVF9JU084NjAxKSB7XG4gIGxvZy5pbmZvKCdBdHRlbXB0aW5nIHRvIGNhcHR1cmUgaU9TIGRldmljZSBkYXRlIGFuZCB0aW1lJyk7XG4gIGlmICghdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGxvZy5pbmZvKCdPbiBzaW11bGF0b3IuIEFzc3VtaW5nIGRldmljZSB0aW1lIGlzIHRoZSBzYW1lIGFzIGhvc3QgdGltZScpO1xuICAgIGNvbnN0IGNtZCA9ICdkYXRlJztcbiAgICBjb25zdCBhcmdzID0gWycrJVktJW0tJWRUJUg6JU06JVMleiddO1xuICAgIGNvbnN0IGlucHV0Rm9ybWF0ID0gJ1lZWVktTU0tRERUSEg6bW06c3NaWic7XG4gICAgY29uc3Qgc3Rkb3V0ID0gKGF3YWl0IGV4ZWMoY21kLCBhcmdzKSkuc3Rkb3V0LnRyaW0oKTtcbiAgICBsb2cuZGVidWcoYEdvdCB0aGUgZm9sbG93aW5nIG91dHB1dCBvdXQgb2YgJyR7Y21kfSAke2FyZ3Muam9pbignICcpfSc6ICR7c3Rkb3V0fWApO1xuICAgIGNvbnN0IHBhcnNlZFRpbWVzdGFtcCA9IG1vbWVudC51dGMoc3Rkb3V0LCBpbnB1dEZvcm1hdCk7XG4gICAgaWYgKCFwYXJzZWRUaW1lc3RhbXAuaXNWYWxpZCgpKSB7XG4gICAgICBsb2cud2FybihgQ2Fubm90IHBhcnNlIHRoZSB0aW1lc3RhbXAgJyR7c3Rkb3V0fScgcmV0dXJuZWQgYnkgJyR7Y21kfScgY29tbWFuZC4gUmV0dXJuaW5nIGl0IGFzIGlzYCk7XG4gICAgICByZXR1cm4gc3Rkb3V0O1xuICAgIH1cbiAgICByZXR1cm4gcGFyc2VkVGltZXN0YW1wLnV0Y09mZnNldChwYXJzZWRUaW1lc3RhbXAuX3R6bSB8fCAwKS5mb3JtYXQoZm9ybWF0KTtcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICB0aW1lc3RhbXAsXG4gICAgdXRjT2Zmc2V0LFxuICAgIHRpbWVab25lLFxuICB9ID0gYXdhaXQgdXRpbGl0aWVzLmdldERldmljZVRpbWUodGhpcy5vcHRzLnVkaWQpO1xuICBsb2cuZGVidWcoYHRpbWVzdGFtcDogJHt0aW1lc3RhbXB9LCB1dGNPZmZzZXQ6ICR7dXRjT2Zmc2V0fSwgdGltZVpvbmU6ICR7dGltZVpvbmV9YCk7XG4gIGNvbnN0IHV0YyA9IG1vbWVudC51bml4KHRpbWVzdGFtcCkudXRjKCk7XG4gIC8vIGF0IHNvbWUgcG9pbnQgb2YgdGltZSBBcHBsZSBzdGFydGVkIHRvIHJldHVybiB0aW1lc3RhbXBzXG4gIC8vIGluIHV0Y09mZnNldCBpbnN0ZWFkIG9mIGFjdHVhbCBVVEMgb2Zmc2V0c1xuICBpZiAoTWF0aC5hYnModXRjT2Zmc2V0KSA8PSAxMiAqIDYwKSB7XG4gICAgcmV0dXJuIHV0Yy51dGNPZmZzZXQodXRjT2Zmc2V0KS5mb3JtYXQoZm9ybWF0KTtcbiAgfVxuICAvLyB0aW1lWm9uZSBjb3VsZCBlaXRoZXIgYmUgYSB0aW1lIHpvbmUgbmFtZSBvclxuICAvLyBhbiBVVEMgb2Zmc2V0IGluIHNlY29uZHNcbiAgaWYgKF8uaW5jbHVkZXModGltZVpvbmUsICcvJykpIHtcbiAgICByZXR1cm4gdXRjLnR6KHRpbWVab25lKS5mb3JtYXQoZm9ybWF0KTtcbiAgfVxuICBpZiAoTWF0aC5hYnModGltZVpvbmUpIDw9IDEyICogNjAgKiA2MCkge1xuICAgIHJldHVybiB1dGMudXRjT2Zmc2V0KHRpbWVab25lIC8gNjApLmZvcm1hdChmb3JtYXQpO1xuICB9XG4gIGxvZy53YXJuKCdEaWQgbm90IGtub3cgaG93IHRvIGFwcGx5IHRoZSBVVEMgb2Zmc2V0LiBSZXR1cm5pbmcgdGhlIHRpbWVzdGFtcCB3aXRob3V0IGl0Jyk7XG4gIHJldHVybiB1dGMuZm9ybWF0KGZvcm1hdCk7XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IERldmljZVRpbWVPcHRpb25zXG4gKiBAcHJvcGVydHkge3N0cmluZ30gZm9ybWF0IFtZWVlZLU1NLUREVEhIOm1tOnNzWl0gLSBTZWUgZ2V0RGV2aWNlVGltZSNmb3JtYXRcbiAqL1xuXG4vKipcbiAqIFJldHJpZXZlcyB0aGUgY3VycmVudCBkZXZpY2UgdGltZVxuICpcbiAqIEBwYXJhbSB7RGV2aWNlVGltZU9wdGlvbnN9IG9wdHNcbiAqIEByZXR1cm4ge3N0cmluZ30gRm9ybWF0dGVkIGRhdGV0aW1lIHN0cmluZyBvciB0aGUgcmF3IGNvbW1hbmQgb3V0cHV0IGlmIGZvcm1hdHRpbmcgZmFpbHNcbiAqL1xuY29tbWFuZHMubW9iaWxlR2V0RGV2aWNlVGltZSA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZUdldERldmljZVRpbWUgKG9wdHMgPSB7fSkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5nZXREZXZpY2VUaW1lKG9wdHMuZm9ybWF0KTtcbn07XG5cbi8vIEZvciBXM0NcbmNvbW1hbmRzLmdldFdpbmRvd1JlY3QgPSBhc3luYyBmdW5jdGlvbiBnZXRXaW5kb3dSZWN0ICgpIHtcbiAgY29uc3Qge3dpZHRoLCBoZWlnaHR9ID0gYXdhaXQgdGhpcy5nZXRXaW5kb3dTaXplKCk7XG4gIHJldHVybiB7XG4gICAgd2lkdGgsXG4gICAgaGVpZ2h0LFxuICAgIHg6IDAsXG4gICAgeTogMFxuICB9O1xufTtcblxuY29tbWFuZHMuaGlkZUtleWJvYXJkID0gYXN5bmMgZnVuY3Rpb24gaGlkZUtleWJvYXJkIChzdHJhdGVneSwgLi4ucG9zc2libGVLZXlzKSB7XG4gIC8vIGxhc3QgcGFyYW1ldGVyIGlzIHRoZSBzZXNzaW9uIGlkXG4gIGNvbnN0IGtleU5hbWVzID0gXy5jb21wYWN0KHBvc3NpYmxlS2V5cy5zbGljZSgwLCAtMSkpLm1hcCgoeCkgPT4gYCR7eH1gKTtcbiAgaWYgKCFrZXlOYW1lcy5pbmNsdWRlcygnZG9uZScpKSB7XG4gICAga2V5TmFtZXMucHVzaCgnZG9uZScpO1xuICB9XG4gIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvd2RhL2tleWJvYXJkL2Rpc21pc3MnLCAnUE9TVCcsIHtrZXlOYW1lc30pO1xufTtcblxuY29tbWFuZHMuZ2V0U3RyaW5ncyA9IGFzeW5jIGZ1bmN0aW9uIGdldFN0cmluZ3MgKGxhbmd1YWdlLCBzdHJpbmdGaWxlID0gbnVsbCkge1xuICBsb2cuZGVidWcoYEdldHRpbmdzIHN0cmluZ3MgZm9yIGxhbmd1YWdlICcke2xhbmd1YWdlfScgYW5kIHN0cmluZyBmaWxlICcke3N0cmluZ0ZpbGV9J2ApO1xuICByZXR1cm4gYXdhaXQgcGFyc2VMb2NhbGl6YWJsZVN0cmluZ3MoT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5vcHRzLCB7XG4gICAgbGFuZ3VhZ2UsXG4gICAgc3RyaW5nRmlsZSxcbiAgICBzdHJpY3RNb2RlOiB0cnVlLFxuICB9KSk7XG59O1xuXG5jb21tYW5kcy5yZW1vdmVBcHAgPSBhc3luYyBmdW5jdGlvbiByZW1vdmVBcHAgKGJ1bmRsZUlkKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLm1vYmlsZVJlbW92ZUFwcCh7YnVuZGxlSWR9KTtcbn07XG5cbmNvbW1hbmRzLmxhdW5jaEFwcCA9IGFzeW5jIGZ1bmN0aW9uIGxhdW5jaEFwcCAoKSB7XG4gIGNvbnN0IGFwcE5hbWUgPSB0aGlzLm9wdHMuYXBwIHx8IHRoaXMub3B0cy5idW5kbGVJZDtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLnN0YXJ0KCk7XG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBsYXVuY2hlZCB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFNvbWV0aGluZyB3ZW50IHdyb25nIHdoaWxlIGxhdW5jaGluZyB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmNsb3NlQXBwID0gYXN5bmMgZnVuY3Rpb24gY2xvc2VBcHAgKCkge1xuICBjb25zdCBhcHBOYW1lID0gdGhpcy5vcHRzLmFwcCB8fCB0aGlzLm9wdHMuYnVuZGxlSWQ7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5zdG9wKCk7XG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBjbG9zZWQgdGhlICcke2FwcE5hbWV9JyBhcHAuYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBTb21ldGhpbmcgd2VudCB3cm9uZyB3aGlsZSBjbG9zaW5nIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuY29tbWFuZHMua2V5cyA9IGFzeW5jIGZ1bmN0aW9uIGtleXMgKGtleXMpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoJ0NvbW1hbmQgc2hvdWxkIGJlIHByb3hpZWQgdG8gV0RBJyk7XG4gIH1cbiAgbGV0IGVsID0gdXRpbC51bndyYXBFbGVtZW50KGF3YWl0IHRoaXMuYWN0aXZlKCkpO1xuICBpZiAoXy5pc0VtcHR5KGVsKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gIH1cbiAgYXdhaXQgdGhpcy5zZXRWYWx1ZShrZXlzLCBlbCk7XG59O1xuXG5jb21tYW5kcy5zZXRVcmwgPSBhc3luYyBmdW5jdGlvbiBzZXRVcmwgKHVybCkge1xuICBsb2cuZGVidWcoYEF0dGVtcHRpbmcgdG8gc2V0IHVybCAnJHt1cmx9J2ApO1xuXG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhpcy5zZXRDdXJyZW50VXJsKHVybCk7XG4gICAgLy8gbWFrZSBzdXJlIHRvIGNsZWFyIG91dCBhbnkgbGVmdG92ZXIgd2ViIGZyYW1lc1xuICAgIHRoaXMuY3VyV2ViRnJhbWVzID0gW107XG4gICAgYXdhaXQgdGhpcy5yZW1vdGUubmF2VG9VcmwodXJsKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvdXJsJywgJ1BPU1QnLCB7dXJsfSk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgdGhpcy5vcHRzLmRldmljZS5zaW1jdGwub3BlblVybCh1cmwpO1xuICB9XG59O1xuXG5jb21tYW5kcy5nZXRWaWV3cG9ydFJlY3QgPSBhc3luYyBmdW5jdGlvbiBnZXRWaWV3cG9ydFJlY3QgKCkge1xuICBjb25zdCBzY2FsZSA9IGF3YWl0IHRoaXMuZ2V0RGV2aWNlUGl4ZWxSYXRpbygpO1xuICAvLyBzdGF0dXMgYmFyIGhlaWdodCBjb21lcyBpbiB1bnNjYWxlZCwgc28gc2NhbGUgaXRcbiAgY29uc3Qgc3RhdHVzQmFySGVpZ2h0ID0gTWF0aC5yb3VuZChhd2FpdCB0aGlzLmdldFN0YXR1c0JhckhlaWdodCgpICogc2NhbGUpO1xuICBjb25zdCB3aW5kb3dTaXplID0gYXdhaXQgdGhpcy5nZXRXaW5kb3dTaXplKCk7XG5cbiAgLy8gaW9zIHJldHVybnMgY29vcmRpbmF0ZXMvZGltZW5zaW9ucyBpbiBsb2dpY2FsIHBpeGVscywgbm90IGRldmljZSBwaXhlbHMsXG4gIC8vIHNvIHNjYWxlIHVwIHRvIGRldmljZSBwaXhlbHMuIHN0YXR1cyBiYXIgaGVpZ2h0IGlzIGFscmVhZHkgc2NhbGVkLlxuICByZXR1cm4ge1xuICAgIGxlZnQ6IDAsXG4gICAgdG9wOiBzdGF0dXNCYXJIZWlnaHQsXG4gICAgd2lkdGg6IHdpbmRvd1NpemUud2lkdGggKiBzY2FsZSxcbiAgICBoZWlnaHQ6ICgod2luZG93U2l6ZS5oZWlnaHQgKiBzY2FsZSkgLSBzdGF0dXNCYXJIZWlnaHQpLFxuICB9O1xufTtcblxuLy8gbWVtb2l6ZWQgaW4gY29uc3RydWN0b3JcbmNvbW1hbmRzLmdldFNjcmVlbkluZm8gPSBhc3luYyBmdW5jdGlvbiBnZXRTY3JlZW5JbmZvICgpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvd2RhL3NjcmVlbicsICdHRVQnKTtcbn07XG5cbmNvbW1hbmRzLmdldFN0YXR1c0JhckhlaWdodCA9IGFzeW5jIGZ1bmN0aW9uIGdldFN0YXR1c0JhckhlaWdodCAoKSB7XG4gIGNvbnN0IHtzdGF0dXNCYXJTaXplfSA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuSW5mbygpO1xuICByZXR1cm4gc3RhdHVzQmFyU2l6ZS5oZWlnaHQ7XG59O1xuXG4vLyBtZW1vaXplZCBpbiBjb25zdHJ1Y3RvclxuY29tbWFuZHMuZ2V0RGV2aWNlUGl4ZWxSYXRpbyA9IGFzeW5jIGZ1bmN0aW9uIGdldERldmljZVBpeGVsUmF0aW8gKCkge1xuICBjb25zdCB7c2NhbGV9ID0gYXdhaXQgdGhpcy5nZXRTY3JlZW5JbmZvKCk7XG4gIHJldHVybiBzY2FsZTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gUHJlc3NCdXR0b25PcHRpb25zXG4gKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBidXR0b24gdG8gYmUgcHJlc3NlZC5cbiAqIEBwcm9wZXJ0eSB7P251bWJlcn0gZHVyYXRpb25TZWNvbmRzIC0gRHVyYXRpb24gaW4gZmxvYXQgc2Vjb25kcy5cbiAqL1xuXG4vKipcbiAqIEVtdWxhdGVzIHByZXNzIHRoZSBnaXZlbiBkZXZpdmUgYnV0dG9uIG5hbWUuXG4gKlxuICogQHBhcmFtIHtQcmVzc0J1dHRvbk9wdGlvbnN9IG9wdHNcbiAqL1xuY29tbWFuZHMubW9iaWxlUHJlc3NCdXR0b24gPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVQcmVzc0J1dHRvbiAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtuYW1lLCBkdXJhdGlvblNlY29uZHN9ID0gb3B0cztcbiAgaWYgKCFuYW1lKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQXJndW1lbnRFcnJvcignQnV0dG9uIG5hbWUgaXMgbWFuZGF0b3J5Jyk7XG4gIH1cbiAgaWYgKCFfLmlzTmlsKGR1cmF0aW9uU2Vjb25kcykgJiYgIV8uaXNOdW1iZXIoZHVyYXRpb25TZWNvbmRzKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoJ2R1cmF0aW9uU2Vjb25kcyBzaG91bGQgYmUgYSBudW1iZXInKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvcHJlc3NCdXR0b24nLCAnUE9TVCcsXG4gICAge25hbWUsIGR1cmF0aW9uOiBkdXJhdGlvblNlY29uZHN9KTtcbn07XG5cbmNvbW1hbmRzLm1vYmlsZVNpcmlDb21tYW5kID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlU2lyaUNvbW1hbmQgKG9wdHMgPSB7fSkge1xuICBjb25zdCB7dGV4dH0gPSBvcHRzO1xuICBpZiAoIXV0aWwuaGFzVmFsdWUodGV4dCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRBcmd1bWVudEVycm9yKCdcInRleHRcIiBhcmd1bWVudCBpcyBtYW5kYXRvcnknKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvc2lyaS9hY3RpdmF0ZScsICdQT1NUJywge3RleHR9KTtcbn07XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuXG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycywgZXh0ZW5zaW9ucyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2dlbmVyYWwuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
