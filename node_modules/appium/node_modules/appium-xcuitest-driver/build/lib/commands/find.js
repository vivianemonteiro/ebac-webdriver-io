"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.helpers = exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _cssConverter = _interopRequireDefault(require("../css-converter"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

const MAGIC_FIRST_VIS_CHILD_SEL = /\/\*\[@firstVisible\s*=\s*('|")true\1\]/;
const MAGIC_SCROLLABLE_SEL = /\/\/\*\[@scrollable\s*=\s*('|")true\1\]/;
const WDA_CLASS_CHAIN_STRATEGY = 'class chain';
let helpers = {},
    commands = {},
    extensions = {};
exports.commands = commands;
exports.helpers = helpers;

helpers.findElOrEls = async function findElOrEls(strategy, selector, mult, context) {
  if (this.isWebview()) {
    return await this.findWebElementOrElements(strategy, selector, mult, context);
  } else {
    return await this.findNativeElementOrElements(strategy, selector, mult, context);
  }
};

helpers.findNativeElementOrElements = async function findNativeElementOrElements(strategy, selector, mult, context) {
  const initSelector = selector;
  let rewroteSelector = false;

  if (strategy === '-ios predicate string') {
    strategy = 'predicate string';
  } else if (strategy === '-ios class chain') {
    strategy = WDA_CLASS_CHAIN_STRATEGY;
  } else if (strategy === 'css selector') {
    strategy = WDA_CLASS_CHAIN_STRATEGY;
    selector = _cssConverter.default.toIosClassChainSelector(selector);
  }

  function stripViewFromSelector(selector) {
    const keepView = ['XCUIElementTypeScrollView', 'XCUIElementTypeCollectionView', 'XCUIElementTypeTextView', 'XCUIElementTypeWebView'].includes(selector);

    if (!keepView && selector.indexOf('View') === selector.length - 4) {
      return selector.substr(0, selector.length - 4);
    } else {
      return selector;
    }
  }

  if (strategy === 'class name') {
    if (selector.startsWith('UIA')) {
      selector = selector.substring(3);
    }

    if (!selector.startsWith('XCUIElementType')) {
      selector = stripViewFromSelector(`XCUIElementType${selector}`);
      rewroteSelector = true;
    }
  }

  if (strategy === 'xpath' && MAGIC_FIRST_VIS_CHILD_SEL.test(selector)) {
    return await this.getFirstVisibleChild(mult, context);
  } else if (strategy === 'xpath' && MAGIC_SCROLLABLE_SEL.test(selector)) {
    [strategy, selector] = rewriteMagicScrollable(mult);
  } else if (strategy === 'xpath') {
    selector = selector.replace(/(^|\/)(UIA)([^[/]+)/g, (str, g1, g2, g3) => {
      rewroteSelector = true;
      return g1 + stripViewFromSelector(`XCUIElementType${g3}`);
    });
  }

  if (rewroteSelector) {
    _logger.default.info(`Rewrote incoming selector from '${initSelector}' to ` + `'${selector}' to match XCUI type. You should consider ` + `updating your tests to use the new selectors directly`);
  }

  return await this.doNativeFind(strategy, selector, mult, context);
};

helpers.doNativeFind = async function doNativeFind(strategy, selector, mult, context) {
  context = _appiumSupport.util.unwrapElement(context);
  let endpoint = `/element${context ? `/${context}/element` : ''}${mult ? 's' : ''}`;
  let body = {
    using: strategy,
    value: selector
  };
  let method = 'POST';
  let els;

  try {
    await this.implicitWaitForCondition(async () => {
      try {
        els = await this.proxyCommand(endpoint, method, body);
      } catch (err) {
        els = [];
      }

      return !_lodash.default.isEmpty(els);
    });
  } catch (err) {
    if (err.message && err.message.match(/Condition unmet/)) {
      els = [];
    } else {
      throw err;
    }
  }

  if (mult) {
    return els;
  }

  if (_lodash.default.isEmpty(els)) {
    throw new _appiumBaseDriver.errors.NoSuchElementError();
  }

  return els;
};

helpers.getFirstVisibleChild = async function getFirstVisibleChild(mult, context) {
  _logger.default.info(`Getting first visible child`);

  if (mult) {
    throw new Error('Cannot get multiple first visible children!');
  }

  if (!context) {
    throw new Error('Cannot get first visible child without a context element');
  }

  let index = 1;

  while (true) {
    const strategy = WDA_CLASS_CHAIN_STRATEGY;
    const selector = `*[${index}]`;
    const nthChild = await this.doNativeFind(strategy, selector, false, context);
    const visible = await this.getAttribute('visible', nthChild);

    if (visible === 'true') {
      _logger.default.info(`Found first visible child at position ${index}`);

      return nthChild;
    }

    index++;
  }
};

function rewriteMagicScrollable(mult) {
  const pred = ['ScrollView', 'Table', 'CollectionView', 'WebView'].map(t => `type == "XCUIElementType${t}"`).join(' OR ');
  const strategy = WDA_CLASS_CHAIN_STRATEGY;
  let selector = '**/*[`' + pred + '`]';

  if (!mult) {
    selector += '[1]';
  }

  _logger.default.info('Rewrote request for scrollable descendants to class chain ' + `format with selector '${selector}'`);

  return [strategy, selector];
}

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maW5kLmpzIl0sIm5hbWVzIjpbIk1BR0lDX0ZJUlNUX1ZJU19DSElMRF9TRUwiLCJNQUdJQ19TQ1JPTExBQkxFX1NFTCIsIldEQV9DTEFTU19DSEFJTl9TVFJBVEVHWSIsImhlbHBlcnMiLCJjb21tYW5kcyIsImV4dGVuc2lvbnMiLCJmaW5kRWxPckVscyIsInN0cmF0ZWd5Iiwic2VsZWN0b3IiLCJtdWx0IiwiY29udGV4dCIsImlzV2VidmlldyIsImZpbmRXZWJFbGVtZW50T3JFbGVtZW50cyIsImZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyIsImluaXRTZWxlY3RvciIsInJld3JvdGVTZWxlY3RvciIsIkNzc0NvbnZlcnRlciIsInRvSW9zQ2xhc3NDaGFpblNlbGVjdG9yIiwic3RyaXBWaWV3RnJvbVNlbGVjdG9yIiwia2VlcFZpZXciLCJpbmNsdWRlcyIsImluZGV4T2YiLCJsZW5ndGgiLCJzdWJzdHIiLCJzdGFydHNXaXRoIiwic3Vic3RyaW5nIiwidGVzdCIsImdldEZpcnN0VmlzaWJsZUNoaWxkIiwicmV3cml0ZU1hZ2ljU2Nyb2xsYWJsZSIsInJlcGxhY2UiLCJzdHIiLCJnMSIsImcyIiwiZzMiLCJsb2ciLCJpbmZvIiwiZG9OYXRpdmVGaW5kIiwidXRpbCIsInVud3JhcEVsZW1lbnQiLCJlbmRwb2ludCIsImJvZHkiLCJ1c2luZyIsInZhbHVlIiwibWV0aG9kIiwiZWxzIiwiaW1wbGljaXRXYWl0Rm9yQ29uZGl0aW9uIiwicHJveHlDb21tYW5kIiwiZXJyIiwiXyIsImlzRW1wdHkiLCJtZXNzYWdlIiwibWF0Y2giLCJlcnJvcnMiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJFcnJvciIsImluZGV4IiwibnRoQ2hpbGQiLCJ2aXNpYmxlIiwiZ2V0QXR0cmlidXRlIiwicHJlZCIsIm1hcCIsInQiLCJqb2luIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNB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dGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IENzc0NvbnZlcnRlciBmcm9tICcuLi9jc3MtY29udmVydGVyJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuXG4vLyB3ZSBvdmVycmlkZSB0aGUgeHBhdGggc2VhcmNoIGZvciB0aGlzIGZpcnN0LXZpc2libGUtY2hpbGQgc2VsZWN0b3IsIHdoaWNoXG4vLyBsb29rcyBsaWtlIC8qW0BmaXJzdFZpc2libGU9XCJ0cnVlXCJdXG5jb25zdCBNQUdJQ19GSVJTVF9WSVNfQ0hJTERfU0VMID0gL1xcL1xcKlxcW0BmaXJzdFZpc2libGVcXHMqPVxccyooJ3xcIil0cnVlXFwxXFxdLztcblxuLy8gd2UgbGlrZXdpc2Ugb3ZlcnJpZGUgeHBhdGggc2VhcmNoIHRvIHByb3ZpZGUgYSBzaG9ydGN1dCBmb3IgZmluZGluZyBhbGxcbi8vIHNjcm9sbGFibGUgZWxlbWVudHNcbmNvbnN0IE1BR0lDX1NDUk9MTEFCTEVfU0VMID0gL1xcL1xcL1xcKlxcW0BzY3JvbGxhYmxlXFxzKj1cXHMqKCd8XCIpdHJ1ZVxcMVxcXS87XG5cbmNvbnN0IFdEQV9DTEFTU19DSEFJTl9TVFJBVEVHWSA9ICdjbGFzcyBjaGFpbic7XG5cbmxldCBoZWxwZXJzID0ge30sIGNvbW1hbmRzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuaGVscGVycy5maW5kRWxPckVscyA9IGFzeW5jIGZ1bmN0aW9uIGZpbmRFbE9yRWxzIChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpIHtcbiAgaWYgKHRoaXMuaXNXZWJ2aWV3KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kV2ViRWxlbWVudE9yRWxlbWVudHMoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgfVxufTtcblxuaGVscGVycy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMgPSBhc3luYyBmdW5jdGlvbiBmaW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMgKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge1xuICBjb25zdCBpbml0U2VsZWN0b3IgPSBzZWxlY3RvcjtcbiAgbGV0IHJld3JvdGVTZWxlY3RvciA9IGZhbHNlO1xuICBpZiAoc3RyYXRlZ3kgPT09ICctaW9zIHByZWRpY2F0ZSBzdHJpbmcnKSB7XG4gICAgLy8gV2ViRHJpdmVyQWdlbnQgdXNlcyAncHJlZGljYXRlIHN0cmluZydcbiAgICBzdHJhdGVneSA9ICdwcmVkaWNhdGUgc3RyaW5nJztcbiAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gJy1pb3MgY2xhc3MgY2hhaW4nKSB7XG4gICAgLy8gV2ViRHJpdmVyQWdlbnQgdXNlcyAnY2xhc3MgY2hhaW4nXG4gICAgc3RyYXRlZ3kgPSBXREFfQ0xBU1NfQ0hBSU5fU1RSQVRFR1k7XG4gIH0gZWxzZSBpZiAoc3RyYXRlZ3kgPT09ICdjc3Mgc2VsZWN0b3InKSB7XG4gICAgc3RyYXRlZ3kgPSBXREFfQ0xBU1NfQ0hBSU5fU1RSQVRFR1k7XG4gICAgc2VsZWN0b3IgPSBDc3NDb252ZXJ0ZXIudG9Jb3NDbGFzc0NoYWluU2VsZWN0b3Ioc2VsZWN0b3IpO1xuICB9XG5cbiAgLy8gQ2hlY2sgaWYgdGhlIHdvcmQgJ1ZpZXcnIGlzIGFwcGVuZGVkIHRvIHNlbGVjdG9yIGFuZCBpZiBpdCBpcywgc3RyaXAgaXQgb3V0XG4gIGZ1bmN0aW9uIHN0cmlwVmlld0Zyb21TZWxlY3RvciAoc2VsZWN0b3IpIHtcbiAgICAvLyBEb24ndCBzdHJpcCBpdCBvdXQgaWYgaXQncyBvbmUgb2YgdGhlc2UgNCBlbGVtZW50IHR5cGVzXG4gICAgLy8gKHNlZSBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svV2ViRHJpdmVyQWdlbnQvYmxvYi9tYXN0ZXIvV2ViRHJpdmVyQWdlbnRMaWIvVXRpbGl0aWVzL0ZCRWxlbWVudFR5cGVUcmFuc2Zvcm1lci5tIGZvciByZWZlcmVuY2UpXG4gICAgY29uc3Qga2VlcFZpZXcgPSBbXG4gICAgICAnWENVSUVsZW1lbnRUeXBlU2Nyb2xsVmlldycsXG4gICAgICAnWENVSUVsZW1lbnRUeXBlQ29sbGVjdGlvblZpZXcnLFxuICAgICAgJ1hDVUlFbGVtZW50VHlwZVRleHRWaWV3JyxcbiAgICAgICdYQ1VJRWxlbWVudFR5cGVXZWJWaWV3JyxcbiAgICBdLmluY2x1ZGVzKHNlbGVjdG9yKTtcblxuICAgIGlmICgha2VlcFZpZXcgJiYgc2VsZWN0b3IuaW5kZXhPZignVmlldycpID09PSBzZWxlY3Rvci5sZW5ndGggLSA0KSB7XG4gICAgICByZXR1cm4gc2VsZWN0b3Iuc3Vic3RyKDAsIHNlbGVjdG9yLmxlbmd0aCAtIDQpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gc2VsZWN0b3I7XG4gICAgfVxuICB9XG5cbiAgaWYgKHN0cmF0ZWd5ID09PSAnY2xhc3MgbmFtZScpIHtcbiAgICAvLyBYQ1VJVGVzdCBjbGFzc2VzIGhhdmUgYFhDVUlFbGVtZW50VHlwZWAgcHJlcGVuZGVkXG4gICAgLy8gZmlyc3QgY2hlY2sgaWYgdGhlcmUgaXMgdGhlIG9sZCBgVUlBYCBwcmVmaXhcbiAgICBpZiAoc2VsZWN0b3Iuc3RhcnRzV2l0aCgnVUlBJykpIHtcbiAgICAgIHNlbGVjdG9yID0gc2VsZWN0b3Iuc3Vic3RyaW5nKDMpO1xuICAgIH1cbiAgICAvLyBub3cgY2hlY2sgaWYgd2UgbmVlZCB0byBhZGQgYFhDVUlFbGVtZW50VHlwZWBcbiAgICBpZiAoIXNlbGVjdG9yLnN0YXJ0c1dpdGgoJ1hDVUlFbGVtZW50VHlwZScpKSB7XG4gICAgICBzZWxlY3RvciA9IHN0cmlwVmlld0Zyb21TZWxlY3RvcihgWENVSUVsZW1lbnRUeXBlJHtzZWxlY3Rvcn1gKTtcbiAgICAgIHJld3JvdGVTZWxlY3RvciA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgaWYgKHN0cmF0ZWd5ID09PSAneHBhdGgnICYmIE1BR0lDX0ZJUlNUX1ZJU19DSElMRF9TRUwudGVzdChzZWxlY3RvcikpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRGaXJzdFZpc2libGVDaGlsZChtdWx0LCBjb250ZXh0KTtcbiAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gJ3hwYXRoJyAmJiBNQUdJQ19TQ1JPTExBQkxFX1NFTC50ZXN0KHNlbGVjdG9yKSkge1xuICAgIFtzdHJhdGVneSwgc2VsZWN0b3JdID0gcmV3cml0ZU1hZ2ljU2Nyb2xsYWJsZShtdWx0KTtcbiAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gJ3hwYXRoJykge1xuICAgIC8vIFJlcGxhY2UgVUlBIGlmIGl0IGNvbWVzIGFmdGVyIGEgZm9yd2FyZCBzbGFzaCBvciBpcyBhdCB0aGUgYmVnaW5uaW5nIG9mIHRoZSBzdHJpbmdcbiAgICBzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoLyhefFxcLykoVUlBKShbXlsvXSspL2csIChzdHIsIGcxLCBnMiwgZzMpID0+IHtcbiAgICAgIHJld3JvdGVTZWxlY3RvciA9IHRydWU7XG4gICAgICByZXR1cm4gZzEgKyBzdHJpcFZpZXdGcm9tU2VsZWN0b3IoYFhDVUlFbGVtZW50VHlwZSR7ZzN9YCk7XG4gICAgfSk7XG4gIH1cblxuICBpZiAocmV3cm90ZVNlbGVjdG9yKSB7XG4gICAgbG9nLmluZm8oYFJld3JvdGUgaW5jb21pbmcgc2VsZWN0b3IgZnJvbSAnJHtpbml0U2VsZWN0b3J9JyB0byBgICtcbiAgICAgICAgICAgICBgJyR7c2VsZWN0b3J9JyB0byBtYXRjaCBYQ1VJIHR5cGUuIFlvdSBzaG91bGQgY29uc2lkZXIgYCArXG4gICAgICAgICAgICAgYHVwZGF0aW5nIHlvdXIgdGVzdHMgdG8gdXNlIHRoZSBuZXcgc2VsZWN0b3JzIGRpcmVjdGx5YCk7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgdGhpcy5kb05hdGl2ZUZpbmQoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbn07XG5cbmhlbHBlcnMuZG9OYXRpdmVGaW5kID0gYXN5bmMgZnVuY3Rpb24gZG9OYXRpdmVGaW5kIChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpIHtcbiAgY29udGV4dCA9IHV0aWwudW53cmFwRWxlbWVudChjb250ZXh0KTtcblxuICBsZXQgZW5kcG9pbnQgPSBgL2VsZW1lbnQke2NvbnRleHQgPyBgLyR7Y29udGV4dH0vZWxlbWVudGAgOiAnJ30ke211bHQgPyAncycgOiAnJ31gO1xuXG4gIGxldCBib2R5ID0ge1xuICAgIHVzaW5nOiBzdHJhdGVneSxcbiAgICB2YWx1ZTogc2VsZWN0b3JcbiAgfTtcblxuICBsZXQgbWV0aG9kID0gJ1BPU1QnO1xuXG4gIC8vIFRoaXMgaXMgZWl0aGVyIGFuIGFycmF5IGlzIG11bHQgPT09IHRydWVcbiAgLy8gb3IgYW4gb2JqZWN0IGlmIG11bHQgPT09IGZhbHNlXG4gIGxldCBlbHM7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5pbXBsaWNpdFdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgZWxzID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoZW5kcG9pbnQsIG1ldGhvZCwgYm9keSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgZWxzID0gW107XG4gICAgICB9XG4gICAgICAvLyB3ZSBzdWNjZWVkIGlmIHdlIGdldCBzb21lIGVsZW1lbnRzXG4gICAgICByZXR1cm4gIV8uaXNFbXB0eShlbHMpO1xuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyLm1lc3NhZ2UgJiYgZXJyLm1lc3NhZ2UubWF0Y2goL0NvbmRpdGlvbiB1bm1ldC8pKSB7XG4gICAgICAvLyBjb25kaXRpb24gd2FzIG5vdCBtZXQgc2V0dGluZyByZXMgdG8gZW1wdHkgYXJyYXlcbiAgICAgIGVscyA9IFtdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG4gIGlmIChtdWx0KSB7XG4gICAgcmV0dXJuIGVscztcbiAgfVxuICBpZiAoXy5pc0VtcHR5KGVscykpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICB9XG4gIHJldHVybiBlbHM7XG59O1xuXG5oZWxwZXJzLmdldEZpcnN0VmlzaWJsZUNoaWxkID0gYXN5bmMgZnVuY3Rpb24gZ2V0Rmlyc3RWaXNpYmxlQ2hpbGQgKG11bHQsIGNvbnRleHQpIHtcbiAgbG9nLmluZm8oYEdldHRpbmcgZmlyc3QgdmlzaWJsZSBjaGlsZGApO1xuICBpZiAobXVsdCkge1xuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGdldCBtdWx0aXBsZSBmaXJzdCB2aXNpYmxlIGNoaWxkcmVuIScpO1xuICB9XG4gIGlmICghY29udGV4dCkge1xuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGdldCBmaXJzdCB2aXNpYmxlIGNoaWxkIHdpdGhvdXQgYSBjb250ZXh0IGVsZW1lbnQnKTtcbiAgfVxuICBsZXQgaW5kZXggPSAxO1xuICAvLyBsb29wIHRocm91Z2ggY2hpbGRyZW4gdmlhIGNsYXNzLWNoYWluIGZpbmRzLCB1bnRpbCB3ZSBydW4gb3V0IG9mIGNoaWxkcmVuXG4gIC8vIG9yIHdlIGZpbmQgYSB2aXNpYmxlIG9uZS4gVGhpcyBsb29wIGxvb2tzIGluZmluaXRlIGJ1dCBpdHMgbm90LCBiZWNhdXNlIGF0XG4gIC8vIHNvbWUgcG9pbnQgdGhlIGNhbGwgdG8gZG9OYXRpdmVGaW5kIHdpbGwgdGhyb3cgd2l0aCBhbiBFbGVtZW50IE5vdCBGb3VuZFxuICAvLyBlcnJvciwgd2hlbiB0aGUgaW5kZXggZ2V0cyBoaWdoZXIgdGhhbiB0aGUgbnVtYmVyIG9mIGNoaWxkIGVsZW1lbnRzLiBUaGlzXG4gIC8vIGlzIHdoYXQgd2Ugd2FudCBiZWNhdXNlIHRoYXQgZXJyb3Igd2lsbCBoYWx0IHRoZSBsb29wIGFuZCBtYWtlIGl0IGFsbCB0aGVcbiAgLy8gd2F5IHRvIHRoZSBjbGllbnQuXG4gIHdoaWxlICh0cnVlKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc3RhbnQtY29uZGl0aW9uXG4gICAgY29uc3Qgc3RyYXRlZ3kgPSBXREFfQ0xBU1NfQ0hBSU5fU1RSQVRFR1k7XG4gICAgY29uc3Qgc2VsZWN0b3IgPSBgKlske2luZGV4fV1gO1xuICAgIGNvbnN0IG50aENoaWxkID0gYXdhaXQgdGhpcy5kb05hdGl2ZUZpbmQoc3RyYXRlZ3ksIHNlbGVjdG9yLCBmYWxzZSwgY29udGV4dCk7XG4gICAgY29uc3QgdmlzaWJsZSA9IGF3YWl0IHRoaXMuZ2V0QXR0cmlidXRlKCd2aXNpYmxlJywgbnRoQ2hpbGQpO1xuICAgIGlmICh2aXNpYmxlID09PSAndHJ1ZScpIHtcbiAgICAgIGxvZy5pbmZvKGBGb3VuZCBmaXJzdCB2aXNpYmxlIGNoaWxkIGF0IHBvc2l0aW9uICR7aW5kZXh9YCk7XG4gICAgICByZXR1cm4gbnRoQ2hpbGQ7XG4gICAgfVxuICAgIGluZGV4Kys7XG4gIH1cbn07XG5cbmZ1bmN0aW9uIHJld3JpdGVNYWdpY1Njcm9sbGFibGUgKG11bHQpIHtcbiAgY29uc3QgcHJlZCA9IFtcbiAgICAnU2Nyb2xsVmlldycsXG4gICAgJ1RhYmxlJyxcbiAgICAnQ29sbGVjdGlvblZpZXcnLFxuICAgICdXZWJWaWV3J1xuICBdLm1hcCgodCkgPT4gYHR5cGUgPT0gXCJYQ1VJRWxlbWVudFR5cGUke3R9XCJgKS5qb2luKCcgT1IgJyk7XG4gIGNvbnN0IHN0cmF0ZWd5ID0gV0RBX0NMQVNTX0NIQUlOX1NUUkFURUdZO1xuICBsZXQgc2VsZWN0b3IgPSAnKiovKltgJyArIHByZWQgKyAnYF0nO1xuICBpZiAoIW11bHQpIHtcbiAgICBzZWxlY3RvciArPSAnWzFdJztcbiAgfVxuICBsb2cuaW5mbygnUmV3cm90ZSByZXF1ZXN0IGZvciBzY3JvbGxhYmxlIGRlc2NlbmRhbnRzIHRvIGNsYXNzIGNoYWluICcgK1xuICAgICAgICAgICBgZm9ybWF0IHdpdGggc2VsZWN0b3IgJyR7c2VsZWN0b3J9J2ApO1xuICByZXR1cm4gW3N0cmF0ZWd5LCBzZWxlY3Rvcl07XG59XG5cblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVyc307XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvZmluZC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
