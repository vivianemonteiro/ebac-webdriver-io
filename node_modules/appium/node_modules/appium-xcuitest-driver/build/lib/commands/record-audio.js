"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _asyncbox = require("asyncbox");

const commands = {};
exports.commands = commands;
const AUDIO_RECORD_FEAT_NAME = 'audio_record';
const MAX_RECORDING_TIME_SEC = 60 * 60 * 12;
const DEFAULT_RECORDING_TIME_SEC = 60 * 3;
const PROCESS_STARTUP_TIMEOUT_MS = 5000;
const DEFAULT_SOURCE = 'avfoundation';
const DEFAULT_BITRATE = '128k';
const DEFAULT_CODEC = 'aac';
const DEFAULT_CHANNELS = 2;
const DEFAULT_RATE = 44100;
const DEFAULT_EXT = '.mp4';
const FFMPEG_BINARY = 'ffmpeg';

const ffmpegLogger = _appiumSupport.logger.getLogger(FFMPEG_BINARY);

class AudioRecorder {
  constructor(input, audioPath, opts = {}) {
    this.audioPath = audioPath;
    this.opts = opts;
    this.input = input;
    this.mainProcess = null;
  }

  async start(timeoutSeconds) {
    try {
      await _appiumSupport.fs.which(FFMPEG_BINARY);
    } catch (err) {
      throw new Error(`'${FFMPEG_BINARY}' binary is not found in PATH. Install it using 'brew install ffmpeg'. ` + `Check https://www.ffmpeg.org/download.html for more details.`);
    }

    const {
      audioSource = DEFAULT_SOURCE,
      audioCodec,
      audioBitrate,
      audioChannels,
      audioRate
    } = this.opts;
    const args = ['-t', `${timeoutSeconds}`, '-f', audioSource, '-i', this.input, '-c:a', audioCodec, '-b:a', audioBitrate, '-ac', `${audioChannels}`, '-ar', `${audioRate}`, this.audioPath];
    this.mainProcess = new _teen_process.SubProcess(FFMPEG_BINARY, args);
    let isCaptureStarted = false;
    this.mainProcess.on('output', (stdout, stderr) => {
      if (stderr) {
        if (stderr.trim().startsWith('size=')) {
          if (!isCaptureStarted) {
            isCaptureStarted = true;
          }
        } else {
          ffmpegLogger.info(`${stderr}`);
        }
      }
    });
    await this.mainProcess.start(0);

    try {
      await (0, _asyncbox.waitForCondition)(() => isCaptureStarted, {
        waitMs: PROCESS_STARTUP_TIMEOUT_MS,
        intervalMs: 300
      });
    } catch (e) {
      _logger.default.warn(`Audio recording process did not start within ${PROCESS_STARTUP_TIMEOUT_MS}ms. Continuing anyway`);
    }

    if (!this.mainProcess.isRunning) {
      this.mainProcess = null;
      throw new Error(`The audio recording process '${FFMPEG_BINARY}' died unexpectedly. ` + `Check server logs for more details`);
    }

    _logger.default.info(`Starting capture on audio input '${this.input}' with command: '${_appiumSupport.util.quote([FFMPEG_BINARY, ...args])}'. ` + `Will timeout in ${timeoutSeconds}s`);

    this.mainProcess.once('exit', (code, signal) => {
      if ([0, 255].includes(code)) {
        _logger.default.info(`The recording session on audio input '${this.input}' has been finished`);
      } else {
        _logger.default.debug(`The recording session on audio input '${this.input}' has exited ` + `with code ${code}, signal ${signal}`);
      }
    });
  }

  isRecording() {
    var _this$mainProcess;

    return !!((_this$mainProcess = this.mainProcess) !== null && _this$mainProcess !== void 0 && _this$mainProcess.isRunning);
  }

  async interrupt(force = false) {
    if (this.isRecording()) {
      const interruptPromise = this.mainProcess.stop(force ? 'SIGTERM' : 'SIGINT');
      this.mainProcess = null;

      try {
        await interruptPromise;
      } catch (e) {
        _logger.default.warn(`Cannot ${force ? 'terminate' : 'interrupt'} ${FFMPEG_BINARY}. ` + `Original error: ${e.message}`);

        return false;
      }
    }

    return true;
  }

  async finish() {
    await this.interrupt();
    return this.audioPath;
  }

  async cleanup() {
    if (await _appiumSupport.fs.exists(this.audioPath)) {
      await _appiumSupport.fs.rimraf(this.audioPath);
    }
  }

}

commands.startAudioRecording = async function startAudioRecording(options = {}) {
  var _this$_audioRecorder;

  if (!this.isFeatureEnabled(AUDIO_RECORD_FEAT_NAME)) {
    _logger.default.errorAndThrow(`Audio capture feature must be enabled on the server side. ` + `Please set '--relaxed-security' or '--allow-insecure' with '${AUDIO_RECORD_FEAT_NAME}' option. ` + `Read https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/security.md for more details.`);
  }

  const {
    timeLimit = DEFAULT_RECORDING_TIME_SEC,
    audioInput,
    audioSource,
    audioCodec = DEFAULT_CODEC,
    audioBitrate = DEFAULT_BITRATE,
    audioChannels = DEFAULT_CHANNELS,
    audioRate = DEFAULT_RATE,
    forceRestart
  } = options;

  if (!audioInput) {
    _logger.default.errorAndThrow(`The mandatory audioInput option is not provided. Please set it ` + `to a correct value (e. g. ':1'). Use 'ffmpeg -f avfoundation -list_devices true -i ""' ` + `command to list available input sources`);
  }

  if ((_this$_audioRecorder = this._audioRecorder) !== null && _this$_audioRecorder !== void 0 && _this$_audioRecorder.isRecording()) {
    _logger.default.info(`There is an active audio recording process`);

    if (forceRestart) {
      _logger.default.info(`Stopping it because 'forceRestart' option is set to true`);

      await this._audioRecorder.interrupt(true);
    } else {
      _logger.default.info(`Doing nothing. ` + `Set 'forceRestart' option to true if you'd like to start a new audio recording session`);

      return;
    }
  }

  if (this._audioRecorder) {
    await this._audioRecorder.cleanup();
    this._audioRecorder = null;
  }

  const audioPath = await _appiumSupport.tempDir.path({
    prefix: `appium_${_appiumSupport.util.uuidV4().substring(0, 8)}`,
    suffix: DEFAULT_EXT
  });
  const audioRecorder = new AudioRecorder(audioInput, audioPath, {
    audioSource,
    audioCodec,
    audioBitrate,
    audioChannels,
    audioRate
  });
  const timeoutSeconds = parseInt(timeLimit, 10);

  if (isNaN(timeoutSeconds) || timeoutSeconds > MAX_RECORDING_TIME_SEC || timeoutSeconds <= 0) {
    _logger.default.errorAndThrow(`The timeLimit value must be in range [1, ${MAX_RECORDING_TIME_SEC}] seconds. ` + `The value of '${timeLimit}' has been passed instead.`);
  }

  try {
    await audioRecorder.start(timeoutSeconds);
  } catch (e) {
    await audioRecorder.interrupt(true);
    await audioRecorder.cleanup();
    throw e;
  }

  this._audioRecorder = audioRecorder;
};

commands.stopAudioRecording = async function stopAudioRecording() {
  if (!this._audioRecorder) {
    _logger.default.info('Audio recording has not been started. There is nothing to stop');

    return '';
  }

  let resultPath;

  try {
    resultPath = await this._audioRecorder.finish();

    if (!(await _appiumSupport.fs.exists(resultPath))) {
      _logger.default.errorAndThrow(`${FFMPEG_BINARY} has failed ` + `to store the actual audio recording at '${resultPath}'`);
    }
  } catch (e) {
    await this._audioRecorder.interrupt(true);
    await this._audioRecorder.cleanup();
    this._audioRecorder = null;
    throw e;
  }

  return await (0, _utils.encodeBase64OrUpload)(resultPath);
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9yZWNvcmQtYXVkaW8uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJBVURJT19SRUNPUkRfRkVBVF9OQU1FIiwiTUFYX1JFQ09SRElOR19USU1FX1NFQyIsIkRFRkFVTFRfUkVDT1JESU5HX1RJTUVfU0VDIiwiUFJPQ0VTU19TVEFSVFVQX1RJTUVPVVRfTVMiLCJERUZBVUxUX1NPVVJDRSIsIkRFRkFVTFRfQklUUkFURSIsIkRFRkFVTFRfQ09ERUMiLCJERUZBVUxUX0NIQU5ORUxTIiwiREVGQVVMVF9SQVRFIiwiREVGQVVMVF9FWFQiLCJGRk1QRUdfQklOQVJZIiwiZmZtcGVnTG9nZ2VyIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiQXVkaW9SZWNvcmRlciIsImNvbnN0cnVjdG9yIiwiaW5wdXQiLCJhdWRpb1BhdGgiLCJvcHRzIiwibWFpblByb2Nlc3MiLCJzdGFydCIsInRpbWVvdXRTZWNvbmRzIiwiZnMiLCJ3aGljaCIsImVyciIsIkVycm9yIiwiYXVkaW9Tb3VyY2UiLCJhdWRpb0NvZGVjIiwiYXVkaW9CaXRyYXRlIiwiYXVkaW9DaGFubmVscyIsImF1ZGlvUmF0ZSIsImFyZ3MiLCJTdWJQcm9jZXNzIiwiaXNDYXB0dXJlU3RhcnRlZCIsIm9uIiwic3Rkb3V0Iiwic3RkZXJyIiwidHJpbSIsInN0YXJ0c1dpdGgiLCJpbmZvIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImUiLCJsb2ciLCJ3YXJuIiwiaXNSdW5uaW5nIiwidXRpbCIsInF1b3RlIiwib25jZSIsImNvZGUiLCJzaWduYWwiLCJpbmNsdWRlcyIsImRlYnVnIiwiaXNSZWNvcmRpbmciLCJpbnRlcnJ1cHQiLCJmb3JjZSIsImludGVycnVwdFByb21pc2UiLCJzdG9wIiwibWVzc2FnZSIsImZpbmlzaCIsImNsZWFudXAiLCJleGlzdHMiLCJyaW1yYWYiLCJzdGFydEF1ZGlvUmVjb3JkaW5nIiwib3B0aW9ucyIsImlzRmVhdHVyZUVuYWJsZWQiLCJlcnJvckFuZFRocm93IiwidGltZUxpbWl0IiwiYXVkaW9JbnB1dCIsImZvcmNlUmVzdGFydCIsIl9hdWRpb1JlY29yZGVyIiwidGVtcERpciIsInBhdGgiLCJwcmVmaXgiLCJ1dWlkVjQiLCJzdWJzdHJpbmciLCJzdWZmaXgiLCJhdWRpb1JlY29yZGVyIiwicGFyc2VJbnQiLCJpc05hTiIsInN0b3BBdWRpb1JlY29yZGluZyIsInJlc3VsdFBhdGgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsUUFBUSxHQUFHLEVBQWpCOztBQUVBLE1BQU1DLHNCQUFzQixHQUFHLGNBQS9CO0FBQ0EsTUFBTUMsc0JBQXNCLEdBQUcsS0FBSyxFQUFMLEdBQVUsRUFBekM7QUFDQSxNQUFNQywwQkFBMEIsR0FBRyxLQUFLLENBQXhDO0FBQ0EsTUFBTUMsMEJBQTBCLEdBQUcsSUFBbkM7QUFDQSxNQUFNQyxjQUFjLEdBQUcsY0FBdkI7QUFDQSxNQUFNQyxlQUFlLEdBQUcsTUFBeEI7QUFDQSxNQUFNQyxhQUFhLEdBQUcsS0FBdEI7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBRyxDQUF6QjtBQUNBLE1BQU1DLFlBQVksR0FBRyxLQUFyQjtBQUNBLE1BQU1DLFdBQVcsR0FBRyxNQUFwQjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxRQUF0Qjs7QUFDQSxNQUFNQyxZQUFZLEdBQUdDLHNCQUFPQyxTQUFQLENBQWlCSCxhQUFqQixDQUFyQjs7QUFHQSxNQUFNSSxhQUFOLENBQW9CO0FBQ2xCQyxFQUFBQSxXQUFXLENBQUVDLEtBQUYsRUFBU0MsU0FBVCxFQUFvQkMsSUFBSSxHQUFHLEVBQTNCLEVBQStCO0FBQ3hDLFNBQUtELFNBQUwsR0FBaUJBLFNBQWpCO0FBQ0EsU0FBS0MsSUFBTCxHQUFZQSxJQUFaO0FBQ0EsU0FBS0YsS0FBTCxHQUFhQSxLQUFiO0FBQ0EsU0FBS0csV0FBTCxHQUFtQixJQUFuQjtBQUNEOztBQUVVLFFBQUxDLEtBQUssQ0FBRUMsY0FBRixFQUFrQjtBQUMzQixRQUFJO0FB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LEdBQ2YsMkNBQTBDdUUsVUFBVyxHQUR4RDtBQUVEO0FBQ0YsR0FORCxDQU1FLE9BQU92QyxDQUFQLEVBQVU7QUFDVixVQUFNLEtBQUs0QixjQUFMLENBQW9CaEIsU0FBcEIsQ0FBOEIsSUFBOUIsQ0FBTjtBQUNBLFVBQU0sS0FBS2dCLGNBQUwsQ0FBb0JWLE9BQXBCLEVBQU47QUFDQSxTQUFLVSxjQUFMLEdBQXNCLElBQXRCO0FBQ0EsVUFBTTVCLENBQU47QUFDRDs7QUFDRCxTQUFPLE1BQU0saUNBQXFCdUMsVUFBckIsQ0FBYjtBQUNELENBcEJEOztlQXdCZWxGLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmcywgdGVtcERpciwgbG9nZ2VyLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgU3ViUHJvY2VzcyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBlbmNvZGVCYXNlNjRPclVwbG9hZCB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IHdhaXRGb3JDb25kaXRpb24gfSBmcm9tICdhc3luY2JveCc7XG5cblxuY29uc3QgY29tbWFuZHMgPSB7fTtcblxuY29uc3QgQVVESU9fUkVDT1JEX0ZFQVRfTkFNRSA9ICdhdWRpb19yZWNvcmQnO1xuY29uc3QgTUFYX1JFQ09SRElOR19USU1FX1NFQyA9IDYwICogNjAgKiAxMjtcbmNvbnN0IERFRkFVTFRfUkVDT1JESU5HX1RJTUVfU0VDID0gNjAgKiAzO1xuY29uc3QgUFJPQ0VTU19TVEFSVFVQX1RJTUVPVVRfTVMgPSA1MDAwO1xuY29uc3QgREVGQVVMVF9TT1VSQ0UgPSAnYXZmb3VuZGF0aW9uJztcbmNvbnN0IERFRkFVTFRfQklUUkFURSA9ICcxMjhrJztcbmNvbnN0IERFRkFVTFRfQ09ERUMgPSAnYWFjJztcbmNvbnN0IERFRkFVTFRfQ0hBTk5FTFMgPSAyO1xuY29uc3QgREVGQVVMVF9SQVRFID0gNDQxMDA7XG5jb25zdCBERUZBVUxUX0VYVCA9ICcubXA0JztcbmNvbnN0IEZGTVBFR19CSU5BUlkgPSAnZmZtcGVnJztcbmNvbnN0IGZmbXBlZ0xvZ2dlciA9IGxvZ2dlci5nZXRMb2dnZXIoRkZNUEVHX0JJTkFSWSk7XG5cblxuY2xhc3MgQXVkaW9SZWNvcmRlciB7XG4gIGNvbnN0cnVjdG9yIChpbnB1dCwgYXVkaW9QYXRoLCBvcHRzID0ge30pIHtcbiAgICB0aGlzLmF1ZGlvUGF0aCA9IGF1ZGlvUGF0aDtcbiAgICB0aGlzLm9wdHMgPSBvcHRzO1xuICAgIHRoaXMuaW5wdXQgPSBpbnB1dDtcbiAgICB0aGlzLm1haW5Qcm9jZXNzID0gbnVsbDtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0ICh0aW1lb3V0U2Vjb25kcykge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmcy53aGljaChGRk1QRUdfQklOQVJZKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJyR7RkZNUEVHX0JJTkFSWX0nIGJpbmFyeSBpcyBub3QgZm91bmQgaW4gUEFUSC4gSW5zdGFsbCBpdCB1c2luZyAnYnJldyBpbnN0YWxsIGZmbXBlZycuIGAgK1xuICAgICAgICBgQ2hlY2sgaHR0cHM6Ly93d3cuZmZtcGVnLm9yZy9kb3dubG9hZC5odG1sIGZvciBtb3JlIGRldGFpbHMuYCk7XG4gICAgfVxuXG4gICAgY29uc3Qge1xuICAgICAgYXVkaW9Tb3VyY2UgPSBERUZBVUxUX1NPVVJDRSxcbiAgICAgIGF1ZGlvQ29kZWMsXG4gICAgICBhdWRpb0JpdHJhdGUsXG4gICAgICBhdWRpb0NoYW5uZWxzLFxuICAgICAgYXVkaW9SYXRlLFxuICAgIH0gPSB0aGlzLm9wdHM7XG5cbiAgICBjb25zdCBhcmdzID0gW1xuICAgICAgJy10JywgYCR7dGltZW91dFNlY29uZHN9YCxcbiAgICAgICctZicsIGF1ZGlvU291cmNlLFxuICAgICAgJy1pJywgdGhpcy5pbnB1dCxcbiAgICAgICctYzphJywgYXVkaW9Db2RlYyxcbiAgICAgICctYjphJywgYXVkaW9CaXRyYXRlLFxuICAgICAgJy1hYycsIGAke2F1ZGlvQ2hhbm5lbHN9YCxcbiAgICAgICctYXInLCBgJHthdWRpb1JhdGV9YCxcbiAgICAgIHRoaXMuYXVkaW9QYXRoLFxuICAgIF07XG5cbiAgICB0aGlzLm1haW5Qcm9jZXNzID0gbmV3IFN1YlByb2Nlc3MoRkZNUEVHX0JJTkFSWSwgYXJncyk7XG4gICAgbGV0IGlzQ2FwdHVyZVN0YXJ0ZWQgPSBmYWxzZTtcbiAgICB0aGlzLm1haW5Qcm9jZXNzLm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgIGlmIChzdGRlcnIpIHtcbiAgICAgICAgaWYgKHN0ZGVyci50cmltKCkuc3RhcnRzV2l0aCgnc2l6ZT0nKSkge1xuICAgICAgICAgIGlmICghaXNDYXB0dXJlU3RhcnRlZCkge1xuICAgICAgICAgICAgaXNDYXB0dXJlU3RhcnRlZCA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGZmbXBlZ0xvZ2dlci5pbmZvKGAke3N0ZGVycn1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMubWFpblByb2Nlc3Muc3RhcnQoMCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oKCkgPT4gaXNDYXB0dXJlU3RhcnRlZCwge1xuICAgICAgICB3YWl0TXM6IFBST0NFU1NfU1RBUlRVUF9USU1FT1VUX01TLFxuICAgICAgICBpbnRlcnZhbE1zOiAzMDAsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cud2FybihgQXVkaW8gcmVjb3JkaW5nIHByb2Nlc3MgZGlkIG5vdCBzdGFydCB3aXRoaW4gJHtQUk9DRVNTX1NUQVJUVVBfVElNRU9VVF9NU31tcy4gQ29udGludWluZyBhbnl3YXlgKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLm1haW5Qcm9jZXNzLmlzUnVubmluZykge1xuICAgICAgdGhpcy5tYWluUHJvY2VzcyA9IG51bGw7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBhdWRpbyByZWNvcmRpbmcgcHJvY2VzcyAnJHtGRk1QRUdfQklOQVJZfScgZGllZCB1bmV4cGVjdGVkbHkuIGAgK1xuICAgICAgICBgQ2hlY2sgc2VydmVyIGxvZ3MgZm9yIG1vcmUgZGV0YWlsc2ApO1xuICAgIH1cbiAgICBsb2cuaW5mbyhgU3RhcnRpbmcgY2FwdHVyZSBvbiBhdWRpbyBpbnB1dCAnJHt0aGlzLmlucHV0fScgd2l0aCBjb21tYW5kOiAnJHt1dGlsLnF1b3RlKFtGRk1QRUdfQklOQVJZLCAuLi5hcmdzXSl9Jy4gYCArXG4gICAgICBgV2lsbCB0aW1lb3V0IGluICR7dGltZW91dFNlY29uZHN9c2ApO1xuICAgIHRoaXMubWFpblByb2Nlc3Mub25jZSgnZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgIC8vIGZmbXBlZyByZXR1cm5zIGNvZGUgMjU1IGlmIFNJR0lOVCBhcnJpdmVzXG4gICAgICBpZiAoWzAsIDI1NV0uaW5jbHVkZXMoY29kZSkpIHtcbiAgICAgICAgbG9nLmluZm8oYFRoZSByZWNvcmRpbmcgc2Vzc2lvbiBvbiBhdWRpbyBpbnB1dCAnJHt0aGlzLmlucHV0fScgaGFzIGJlZW4gZmluaXNoZWRgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgVGhlIHJlY29yZGluZyBzZXNzaW9uIG9uIGF1ZGlvIGlucHV0ICcke3RoaXMuaW5wdXR9JyBoYXMgZXhpdGVkIGAgK1xuICAgICAgICAgIGB3aXRoIGNvZGUgJHtjb2RlfSwgc2lnbmFsICR7c2lnbmFsfWApO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgaXNSZWNvcmRpbmcgKCkge1xuICAgIHJldHVybiAhISh0aGlzLm1haW5Qcm9jZXNzPy5pc1J1bm5pbmcpO1xuICB9XG5cbiAgYXN5bmMgaW50ZXJydXB0IChmb3JjZSA9IGZhbHNlKSB7XG4gICAgaWYgKHRoaXMuaXNSZWNvcmRpbmcoKSkge1xuICAgICAgY29uc3QgaW50ZXJydXB0UHJvbWlzZSA9IHRoaXMubWFpblByb2Nlc3Muc3RvcChmb3JjZSA/ICdTSUdURVJNJyA6ICdTSUdJTlQnKTtcbiAgICAgIHRoaXMubWFpblByb2Nlc3MgPSBudWxsO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgaW50ZXJydXB0UHJvbWlzZTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nLndhcm4oYENhbm5vdCAke2ZvcmNlID8gJ3Rlcm1pbmF0ZScgOiAnaW50ZXJydXB0J30gJHtGRk1QRUdfQklOQVJZfS4gYCArXG4gICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgYXN5bmMgZmluaXNoICgpIHtcbiAgICBhd2FpdCB0aGlzLmludGVycnVwdCgpO1xuICAgIHJldHVybiB0aGlzLmF1ZGlvUGF0aDtcbiAgfVxuXG4gIGFzeW5jIGNsZWFudXAgKCkge1xuICAgIGlmIChhd2FpdCBmcy5leGlzdHModGhpcy5hdWRpb1BhdGgpKSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYodGhpcy5hdWRpb1BhdGgpO1xuICAgIH1cbiAgfVxufVxuXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RhcnRSZWNvcmRpbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHshc3RyaW5nfSBhdWRpb0lucHV0IC0gVGhlIG5hbWUgb2YgdGhlIGNvcnJlc3BvbmRpbmcgYXVkaW8gaW5wdXQgZGV2aWNlIHRvIHVzZSBmb3IgdGhlXG4gKiBjYXB0dXJlLiBUaGUgZnVsbCBsaXN0IG9mIGNhcHR1cmUgZGV2aWNlcyBjb3VsZCBiZSBzaG93biB1c2luZyBgZmZtcGVnIC1mIGF2Zm91bmRhdGlvbiAtbGlzdF9kZXZpY2VzIHRydWUgLWkgXCJcImBcbiAqIFRlcm1pbmFsIGNvbW1hbmQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IGF1ZGlvQ29kZWMgW2FhY10gLSBUaGUgbmFtZSBvZiB0aGUgYXVkaW8gY29kZWMuIFRoZSBBZHZhbmNlZCBBdWRpbyBDb2RlYyBpcyB1c2VkIGJ5IGRlZmF1bHQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IGF1ZGlvQml0cmF0ZSBbMTI4a10gLSBUaGUgYml0cmF0ZSBvZiB0aGUgcmVzdWx0aW5nIGF1ZGlvIHN0cmVhbS4gMTI4ayBieSBkZWZhdWx0LlxuICogQHByb3BlcnR5IHs/c3RyaW5nfG51bWJlcn0gYXVkaW9DaGFubmVscyBbMl0gLSBUaGUgY291bnQgb2YgYXVkaW8gY2hhbm5lbHMgaW4gdGhlIHJlc3VsdGluZyBzdHJlYW0uIFNldHRpbmcgaXQgdG8gYDFgXG4gKiB3aWxsIGNyZWF0ZSBhIHNpbmdsZSBjaGFubmVsIChtb25vKSBhdWRpbyBzdHJlYW0uXG4gKiBAcHJvcGVydHkgez9zdHJpbmd8bnVtYmVyfSBhdWRpb1JhdGUgWzQ0MTAwXSAtIFRoZSBzYW1wbGluZyByYXRlIG9mIHRoZSByZXN1bHRpbmcgYXVkaW8gc3RyZWFtLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfG51bWJlcn0gdGltZUxpbWl0IFsxODBdIC0gVGhlIG1heGltdW0gcmVjb3JkaW5nIHRpbWUsIGluIHNlY29uZHMuXG4gKiBUaGUgZGVmYXVsdCB2YWx1ZSBpcyAxODAsIHRoZSBtYXhpbXVtIHZhbHVlIGlzIDQzMjAwICgxMiBob3VycykuXG4gKiBAcHJvcGVydHkgez9ib29sZWFufSBmb3JjZVJlc3RhcnQgW2ZhbHNlXSAtIFdoZXRoZXIgdG8gcmVzdGFydCBhdWRpbyBjYXB0dXJlIHByb2Nlc3MgZm9yY2VmdWxseSB3aGVuXG4gKiBzdGFydFJlY29yZGluZ0F1ZGlvIGlzIGNhbGxlZCAoYHRydWVgKSBvciBpZ25vcmUgdGhlIGNhbGwgdW50aWwgdGhlIGN1cnJlbnQgYXVkaW8gcmVjb3JkaW5nIGlzIGNvbXBsZXRlZC5cbiAqL1xuXG4vKipcbiAqIFJlY29yZHMgdGhlIGdpdmVuIGhhcmR3YXJlIGF1ZGlvIGlucHV0IGludG8gYW4gLm1wNCBmaWxlLlxuICpcbiAqIEBwYXJhbSB7P1N0YXJ0UmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBhdWRpbyByZWNvcmRpbmcgaGFzIGZhaWxlZCB0byBzdGFydC5cbiAqL1xuY29tbWFuZHMuc3RhcnRBdWRpb1JlY29yZGluZyA9IGFzeW5jIGZ1bmN0aW9uIHN0YXJ0QXVkaW9SZWNvcmRpbmcgKG9wdGlvbnMgPSB7fSkge1xuICBpZiAoIXRoaXMuaXNGZWF0dXJlRW5hYmxlZChBVURJT19SRUNPUkRfRkVBVF9OQU1FKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBBdWRpbyBjYXB0dXJlIGZlYXR1cmUgbXVzdCBiZSBlbmFibGVkIG9uIHRoZSBzZXJ2ZXIgc2lkZS4gYCArXG4gICAgICBgUGxlYXNlIHNldCAnLS1yZWxheGVkLXNlY3VyaXR5JyBvciAnLS1hbGxvdy1pbnNlY3VyZScgd2l0aCAnJHtBVURJT19SRUNPUkRfRkVBVF9OQU1FfScgb3B0aW9uLiBgICtcbiAgICAgIGBSZWFkIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2Jsb2IvbWFzdGVyL2RvY3MvZW4vd3JpdGluZy1ydW5uaW5nLWFwcGl1bS9zZWN1cml0eS5tZCBmb3IgbW9yZSBkZXRhaWxzLmApO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIHRpbWVMaW1pdCA9IERFRkFVTFRfUkVDT1JESU5HX1RJTUVfU0VDLFxuICAgIGF1ZGlvSW5wdXQsXG4gICAgLy8gVW5kb2N1bWVudGVkIGZlYXR1cmVcbiAgICBhdWRpb1NvdXJjZSxcbiAgICBhdWRpb0NvZGVjID0gREVGQVVMVF9DT0RFQyxcbiAgICBhdWRpb0JpdHJhdGUgPSBERUZBVUxUX0JJVFJBVEUsXG4gICAgYXVkaW9DaGFubmVscyA9IERFRkFVTFRfQ0hBTk5FTFMsXG4gICAgYXVkaW9SYXRlID0gREVGQVVMVF9SQVRFLFxuICAgIGZvcmNlUmVzdGFydCxcbiAgfSA9IG9wdGlvbnM7XG5cbiAgaWYgKCFhdWRpb0lucHV0KSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSBtYW5kYXRvcnkgYXVkaW9JbnB1dCBvcHRpb24gaXMgbm90IHByb3ZpZGVkLiBQbGVhc2Ugc2V0IGl0IGAgK1xuICAgICAgYHRvIGEgY29ycmVjdCB2YWx1ZSAoZS4gZy4gJzoxJykuIFVzZSAnZmZtcGVnIC1mIGF2Zm91bmRhdGlvbiAtbGlzdF9kZXZpY2VzIHRydWUgLWkgXCJcIicgYCArXG4gICAgICBgY29tbWFuZCB0byBsaXN0IGF2YWlsYWJsZSBpbnB1dCBzb3VyY2VzYCk7XG4gIH1cblxuICBpZiAodGhpcy5fYXVkaW9SZWNvcmRlcj8uaXNSZWNvcmRpbmcoKSkge1xuICAgIGxvZy5pbmZvKGBUaGVyZSBpcyBhbiBhY3RpdmUgYXVkaW8gcmVjb3JkaW5nIHByb2Nlc3NgKTtcbiAgICBpZiAoZm9yY2VSZXN0YXJ0KSB7XG4gICAgICBsb2cuaW5mbyhgU3RvcHBpbmcgaXQgYmVjYXVzZSAnZm9yY2VSZXN0YXJ0JyBvcHRpb24gaXMgc2V0IHRvIHRydWVgKTtcbiAgICAgIGF3YWl0IHRoaXMuX2F1ZGlvUmVjb3JkZXIuaW50ZXJydXB0KHRydWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuaW5mbyhgRG9pbmcgbm90aGluZy4gYCArXG4gICAgICAgIGBTZXQgJ2ZvcmNlUmVzdGFydCcgb3B0aW9uIHRvIHRydWUgaWYgeW91J2QgbGlrZSB0byBzdGFydCBhIG5ldyBhdWRpbyByZWNvcmRpbmcgc2Vzc2lvbmApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfVxuICBpZiAodGhpcy5fYXVkaW9SZWNvcmRlcikge1xuICAgIGF3YWl0IHRoaXMuX2F1ZGlvUmVjb3JkZXIuY2xlYW51cCgpO1xuICAgIHRoaXMuX2F1ZGlvUmVjb3JkZXIgPSBudWxsO1xuICB9XG5cbiAgY29uc3QgYXVkaW9QYXRoID0gYXdhaXQgdGVtcERpci5wYXRoKHtcbiAgICBwcmVmaXg6IGBhcHBpdW1fJHt1dGlsLnV1aWRWNCgpLnN1YnN0cmluZygwLCA4KX1gLFxuICAgIHN1ZmZpeDogREVGQVVMVF9FWFQsXG4gIH0pO1xuXG4gIGNvbnN0IGF1ZGlvUmVjb3JkZXIgPSBuZXcgQXVkaW9SZWNvcmRlcihhdWRpb0lucHV0LCBhdWRpb1BhdGgsIHtcbiAgICBhdWRpb1NvdXJjZSxcbiAgICBhdWRpb0NvZGVjLFxuICAgIGF1ZGlvQml0cmF0ZSxcbiAgICBhdWRpb0NoYW5uZWxzLFxuICAgIGF1ZGlvUmF0ZSxcbiAgfSk7XG5cbiAgY29uc3QgdGltZW91dFNlY29uZHMgPSBwYXJzZUludCh0aW1lTGltaXQsIDEwKTtcbiAgaWYgKGlzTmFOKHRpbWVvdXRTZWNvbmRzKSB8fCB0aW1lb3V0U2Vjb25kcyA+IE1BWF9SRUNPUkRJTkdfVElNRV9TRUMgfHwgdGltZW91dFNlY29uZHMgPD0gMCkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgdGltZUxpbWl0IHZhbHVlIG11c3QgYmUgaW4gcmFuZ2UgWzEsICR7TUFYX1JFQ09SRElOR19USU1FX1NFQ31dIHNlY29uZHMuIGAgK1xuICAgICAgYFRoZSB2YWx1ZSBvZiAnJHt0aW1lTGltaXR9JyBoYXMgYmVlbiBwYXNzZWQgaW5zdGVhZC5gKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgYXdhaXQgYXVkaW9SZWNvcmRlci5zdGFydCh0aW1lb3V0U2Vjb25kcyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBhd2FpdCBhdWRpb1JlY29yZGVyLmludGVycnVwdCh0cnVlKTtcbiAgICBhd2FpdCBhdWRpb1JlY29yZGVyLmNsZWFudXAoKTtcbiAgICB0aHJvdyBlO1xuICB9XG4gIHRoaXMuX2F1ZGlvUmVjb3JkZXIgPSBhdWRpb1JlY29yZGVyO1xufTtcblxuLyoqXG4gKiBTdG9wIHJlY29yZGluZyBvZiB0aGUgYXVkaW8gaW5wdXQuIElmIG5vIGF1ZGlvIHJlY29yZGluZyBwcm9jZXNzIGlzIHJ1bm5pbmcgdGhlblxuICogdGhlIGVuZHBvaW50IHdpbGwgdHJ5IHRvIGdldCB0aGUgcmVjZW50bHkgcmVjb3JkZWQgZmlsZS5cbiAqIElmIG5vIHByZXZpb3VzbHkgcmVjb3JkZWQgZmlsZSBpcyBmb3VuZCBhbmQgbm8gYWN0aXZlIGF1ZGlvIHJlY29yZGluZ1xuICogcHJvY2Vzc2VzIGFyZSBydW5uaW5nIHRoZW4gdGhlIG1ldGhvZCByZXR1cm5zIGFuIGVtcHR5IHN0cmluZy5cbiAqXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBCYXNlNjQtZW5jb2RlZCBjb250ZW50IG9mIHRoZSByZWNvcmRlZCBtZWRpYSBmaWxlIG9yIGFuXG4gKiBlbXB0eSBzdHJpbmcgaWYgbm8gYXVkaW8gcmVjb3JkaW5nIGhhcyBiZWVuIHN0YXJ0ZWQgYmVmb3JlLlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBnZXR0aW5nIHRoZSByZWNvcmRlZCBmaWxlLlxuICovXG5jb21tYW5kcy5zdG9wQXVkaW9SZWNvcmRpbmcgPSBhc3luYyBmdW5jdGlvbiBzdG9wQXVkaW9SZWNvcmRpbmcgKCkge1xuICBpZiAoIXRoaXMuX2F1ZGlvUmVjb3JkZXIpIHtcbiAgICBsb2cuaW5mbygnQXVkaW8gcmVjb3JkaW5nIGhhcyBub3QgYmVlbiBzdGFydGVkLiBUaGVyZSBpcyBub3RoaW5nIHRvIHN0b3AnKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICBsZXQgcmVzdWx0UGF0aDtcbiAgdHJ5IHtcbiAgICByZXN1bHRQYXRoID0gYXdhaXQgdGhpcy5fYXVkaW9SZWNvcmRlci5maW5pc2goKTtcbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhyZXN1bHRQYXRoKSkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYCR7RkZNUEVHX0JJTkFSWX0gaGFzIGZhaWxlZCBgICtcbiAgICAgICAgYHRvIHN0b3JlIHRoZSBhY3R1YWwgYXVkaW8gcmVjb3JkaW5nIGF0ICcke3Jlc3VsdFBhdGh9J2ApO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGF3YWl0IHRoaXMuX2F1ZGlvUmVjb3JkZXIuaW50ZXJydXB0KHRydWUpO1xuICAgIGF3YWl0IHRoaXMuX2F1ZGlvUmVjb3JkZXIuY2xlYW51cCgpO1xuICAgIHRoaXMuX2F1ZGlvUmVjb3JkZXIgPSBudWxsO1xuICAgIHRocm93IGU7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IGVuY29kZUJhc2U2NE9yVXBsb2FkKHJlc3VsdFBhdGgpO1xufTtcblxuXG5leHBvcnQgeyBjb21tYW5kcyB9O1xuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9yZWNvcmQtYXVkaW8uanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
