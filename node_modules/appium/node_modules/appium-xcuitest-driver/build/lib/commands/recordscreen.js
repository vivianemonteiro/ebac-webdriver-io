"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _deviceConnectionsFactory = _interopRequireDefault(require("../device-connections-factory"));

var _appiumWebdriveragent = require("appium-webdriveragent");

var _asyncbox = require("asyncbox");

var _url = _interopRequireDefault(require("url"));

let commands = {};
exports.commands = commands;
const MAX_RECORDING_TIME_SEC = 60 * 30;
const DEFAULT_RECORDING_TIME_SEC = 60 * 3;
const DEFAULT_MJPEG_SERVER_PORT = 9100;
const DEFAULT_FPS = 10;
const DEFAULT_QUALITY = 'medium';
const DEFAULT_VCODEC = 'mjpeg';
const MP4_EXT = '.mp4';
const FFMPEG_BINARY = 'ffmpeg';

const ffmpegLogger = _appiumSupport.logger.getLogger(FFMPEG_BINARY);

const QUALITY_MAPPING = {
  low: 10,
  medium: 25,
  high: 75,
  photo: 100
};

class ScreenRecorder {
  constructor(udid, videoPath, opts = {}) {
    this.videoPath = videoPath;
    this.opts = opts;
    this.udid = udid;
    this.mainProcess = null;
    this.timeoutHandler = null;
  }

  async start(timeoutMs) {
    try {
      await _appiumSupport.fs.which(FFMPEG_BINARY);
    } catch (err) {
      throw new Error(`'${FFMPEG_BINARY}' binary is not found in PATH. Install it using 'brew install ffmpeg'. ` + `Check https://www.ffmpeg.org/download.html for more details.`);
    }

    const {
      remotePort,
      remoteUrl,
      usePortForwarding,
      videoFps,
      videoType,
      videoScale,
      videoFilters,
      pixelFormat
    } = this.opts;

    try {
      await _deviceConnectionsFactory.default.requestConnection(this.udid, remotePort, {
        devicePort: remotePort,
        usePortForwarding
      });
    } catch (err) {
      _logger.default.warn(`Cannot forward the local port ${remotePort} to ${remotePort} ` + `on the device ${this.udid}. Set the custom value to 'mjpegServerPort' ` + `capability if this is an undesired behavior.`);
    }

    const args = ['-f', 'mjpeg'];

    if (videoFps && videoType === 'libx264') {
      args.push('-r', videoFps);
    }

    const {
      protocol,
      hostname
    } = _url.default.parse(remoteUrl);

    args.push('-i', `${protocol}//${hostname}:${remotePort}`);

    if (videoFilters || videoScale) {
      args.push('-vf', videoFilters || `scale=${videoScale}`);
    }

    if (pixelFormat) {
      args.push('-pix_fmt', pixelFormat);
    }

    args.push('-vcodec', videoType, '-y', this.videoPath);
    this.mainProcess = new _teen_process.SubProcess(FFMPEG_BINARY, args);
    let isCaptureStarted = false;
    this.mainProcess.on('output', (stdout, stderr) => {
      if (stderr) {
        if (stderr.trim().startsWith('frame=')) {
          if (!isCaptureStarted) {
            isCaptureStarted = true;
          }
        } else {
          ffmpegLogger.info(`${stderr}`);
        }
      }
    });
    await this.mainProcess.start(0);
    const startupTimeout = 5000;

    try {
      await (0, _asyncbox.waitForCondition)(() => isCaptureStarted, {
        waitMs: startupTimeout,
        intervalMs: 300
      });
    } catch (e) {
      _logger.default.warn(`Screen capture process did not start within ${startupTimeout}ms. Continuing anyway`);
    }

    if (!this.mainProcess.isRunning) {
      throw new Error(`The screen capture process '${FFMPEG_BINARY}' died unexpectedly. ` + `Check server logs for more details`);
    }

    _logger.default.info(`Starting screen capture on the device '${this.udid}' with command: '${FFMPEG_BINARY} ${args.join(' ')}'. ` + `Will timeout in ${timeoutMs}ms`);

    this.timeoutHandler = setTimeout(async () => {
      if (!(await this.interrupt())) {
        _logger.default.warn(`Cannot finish the active screen recording on the device '${this.udid}' after ${timeoutMs}ms timeout`);
      }
    }, timeoutMs);
  }

  async interrupt(force = false) {
    let result = true;

    if (this.timeoutHandler) {
      clearTimeout(this.timeoutHandler);
      this.timeoutHandler = null;
    }

    if (this.mainProcess && this.mainProcess.isRunning) {
      const interruptPromise = this.mainProcess.stop(force ? 'SIGTERM' : 'SIGINT');
      this.mainProcess = null;

      try {
        await interruptPromise;
      } catch (e) {
        _logger.default.warn(`Cannot ${force ? 'terminate' : 'interrupt'} ${FFMPEG_BINARY}. ` + `Original error: ${e.message}`);

        result = false;
      }
    }

    _deviceConnectionsFactory.default.releaseConnection(this.udid, this.opts.remotePort);

    return result;
  }

  async finish() {
    await this.interrupt();
    return this.videoPath;
  }

  async cleanup() {
    if (await _appiumSupport.fs.exists(this.videoPath)) {
      await _appiumSupport.fs.rimraf(this.videoPath);
    }
  }

}

commands.startRecordingScreen = async function startRecordingScreen(options = {}) {
  const {
    videoType = DEFAULT_VCODEC,
    timeLimit = DEFAULT_RECORDING_TIME_SEC,
    videoQuality = DEFAULT_QUALITY,
    videoFps = DEFAULT_FPS,
    videoFilters,
    videoScale,
    forceRestart,
    pixelFormat
  } = options;
  let result = '';

  if (!forceRestart) {
    _logger.default.info(`Checking if there is/was a previous screen recording. ` + `Set 'forceRestart' option to 'true' if you'd like to skip this step.`);

    result = await this.stopRecordingScreen(options);
  }

  const videoPath = await _appiumSupport.tempDir.path({
    prefix: `appium_${Math.random().toString(16).substring(2, 8)}`,
    suffix: MP4_EXT
  });
  const wdaBaseUrl = this.opts.wdaBaseUrl || _appiumWebdriveragent.WDA_BASE_URL;
  const screenRecorder = new ScreenRecorder(this.opts.device.udid, videoPath, {
    remotePort: this.opts.mjpegServerPort || DEFAULT_MJPEG_SERVER_PORT,
    remoteUrl: wdaBaseUrl,
    usePortForwarding: this.isRealDevice() && (0, _utils.isLocalHost)(wdaBaseUrl),
    videoType,
    videoFilters,
    videoScale,
    videoFps,
    pixelFormat
  });

  if (!(await screenRecorder.interrupt(true))) {
    _logger.default.errorAndThrow('Unable to stop screen recording process');
  }

  if (this._recentScreenRecorder) {
    await this._recentScreenRecorder.cleanup();
    this._recentScreenRecorder = null;
  }

  const timeoutSeconds = parseFloat(timeLimit);

  if (isNaN(timeoutSeconds) || timeoutSeconds > MAX_RECORDING_TIME_SEC || timeoutSeconds <= 0) {
    _logger.default.errorAndThrow(`The timeLimit value must be in range [1, ${MAX_RECORDING_TIME_SEC}] seconds. ` + `The value of '${timeLimit}' has been passed instead.`);
  }

  let {
    mjpegServerScreenshotQuality,
    mjpegServerFramerate
  } = await this.proxyCommand('/appium/settings', 'GET');

  if (videoQuality) {
    const quality = _lodash.default.isInteger(videoQuality) ? videoQuality : QUALITY_MAPPING[_lodash.default.toLower(videoQuality)];

    if (!quality) {
      throw new Error(`videoQuality value should be one of ${JSON.stringify(_lodash.default.keys(QUALITY_MAPPING))} or a number in range 1..100. ` + `'${videoQuality}' is given instead`);
    }

    mjpegServerScreenshotQuality = mjpegServerScreenshotQuality !== quality ? quality : undefined;
  } else {
    mjpegServerScreenshotQuality = undefined;
  }

  if (videoFps) {
    const fps = parseInt(videoFps, 10);

    if (isNaN(fps)) {
      throw new Error(`videoFps value should be a valid number in range 1..60. ` + `'${videoFps}' is given instead`);
    }

    mjpegServerFramerate = mjpegServerFramerate !== fps ? fps : undefined;
  } else {
    mjpegServerFramerate = undefined;
  }

  if (_appiumSupport.util.hasValue(mjpegServerScreenshotQuality) || _appiumSupport.util.hasValue(mjpegServerFramerate)) {
    await this.proxyCommand('/appium/settings', 'POST', {
      settings: {
        mjpegServerScreenshotQuality,
        mjpegServerFramerate
      }
    });
  }

  try {
    await screenRecorder.start(timeoutSeconds * 1000);
  } catch (e) {
    await screenRecorder.interrupt(true);
    await screenRecorder.cleanup();
    throw e;
  }

  this._recentScreenRecorder = screenRecorder;
  return result;
};

commands.stopRecordingScreen = async function stopRecordingScreen(options = {}) {
  if (!this._recentScreenRecorder) {
    _logger.default.info('Screen recording is not running. There is nothing to stop.');

    return '';
  }

  try {
    const videoPath = await this._recentScreenRecorder.finish();

    if (!(await _appiumSupport.fs.exists(videoPath))) {
      _logger.default.errorAndThrow(`The screen recorder utility has failed ` + `to store the actual screen recording at '${videoPath}'`);
    }

    return await (0, _utils.encodeBase64OrUpload)(videoPath, options.remotePath, options);
  } finally {
    await this._recentScreenRecorder.interrupt(true);
    await this._recentScreenRecorder.cleanup();
    this._recentScreenRecorder = null;
  }
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9yZWNvcmRzY3JlZW4uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJNQVhfUkVDT1JESU5HX1RJTUVfU0VDIiwiREVGQVVMVF9SRUNPUkRJTkdfVElNRV9TRUMiLCJERUZBVUxUX01KUEVHX1NFUlZFUl9QT1JUIiwiREVGQVVMVF9GUFMiLCJERUZBVUxUX1FVQUxJVFkiLCJERUZBVUxUX1ZDT0RFQyIsIk1QNF9FWFQiLCJGRk1QRUdfQklOQVJZIiwiZmZtcGVnTG9nZ2VyIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiUVVBTElUWV9NQVBQSU5HIiwibG93IiwibWVkaXVtIiwiaGlnaCIsInBob3RvIiwiU2NyZWVuUmVjb3JkZXIiLCJjb25zdHJ1Y3RvciIsInVkaWQiLCJ2aWRlb1BhdGgiLCJvcHRzIiwibWFpblByb2Nlc3MiLCJ0aW1lb3V0SGFuZGxlciIsInN0YXJ0IiwidGltZW91dE1zIiwiZnMiLCJ3aGljaCIsImVyciIsIkVycm9yIiwicmVtb3RlUG9ydCIsInJlbW90ZVVybCIsInVzZVBvcnRGb3J3YXJkaW5nIiwidmlkZW9GcHMiLCJ2aWRlb1R5cGUiLCJ2aWRlb1NjYWxlIiwidmlkZW9GaWx0ZXJzIiwicGl4ZWxGb3JtYXQiLCJERVZJQ0VfQ09OTkVDVElPTlNfRkFDVE9SWSIsInJlcXVlc3RDb25uZWN0aW9uIiwiZGV2aWNlUG9ydCIsImxvZyIsIndhcm4iLCJhcmdzIiwicHVzaCIsInByb3RvY29sIiwiaG9zdG5hbWUiLCJ1cmwiLCJwYXJzZSIsIlN1YlByb2Nlc3MiLCJpc0NhcHR1cmVTdGFydGVkIiwib24iLCJzdGRvdXQiLCJzdGRlcnIiLCJ0cmltIiwic3RhcnRzV2l0aCIsImluZm8iLCJzdGFydHVwVGltZW91dCIsIndhaXRNcyIsImludGVydmFsTXMiLCJlIiwiaXNSdW5uaW5nIiwiam9pbiIsInNldFRpbWVvdXQiLCJpbnRlcnJ1cHQiLCJmb3JjZSIsInJlc3VsdCIsImNsZWFyVGltZW91dCIsImludGVycnVwdFByb21pc2UiLCJzdG9wIiwibWVzc2FnZSIsInJlbGVhc2VDb25uZWN0aW9uIiwiZmluaXNoIiwiY2xlYW51cCIsImV4aXN0cyIsInJpbXJhZiIsInN0YXJ0UmVjb3JkaW5nU2NyZWVuIiwib3B0aW9ucyIsInRpbWVMaW1pdCIsInZpZGVvUXVhbGl0eSIsImZvcmNlUmVzdGFydCIsInN0b3BSZWNvcmRpbmdTY3JlZW4iLCJ0ZW1wRGlyIiwicGF0aCIsInByZWZpeCIsIk1hdGgiLCJyYW5kb20iLCJ0b1N0cmluZyIsInN1YnN0cmluZyIsInN1ZmZpeCIsIndkYUJhc2VVcmwiLCJXREFfQkFTRV9VUkwiLCJzY3JlZW5SZWNvcmRlciIsImRldmljZSIsIm1qcGVnU2VydmVyUG9ydCIsImlzUmVhbERldmljZSIsImVycm9yQW5kVGhyb3ciLCJfcmVjZW50U2NyZWVuUmVjb3JkZXIiLCJ0aW1lb3V0U2Vjb25kcyIsInBhcnNlRmxvYXQiLCJpc05hTiIsIm1qcGVnU2VydmVyU2NyZWVuc2hvdFF1YWxpdHkiLCJtanBlZ1NlcnZlckZyYW1lcmF0ZSIsInByb3h5Q29tbWFuZCIsInF1YWxpdHkiLCJfIiwiaXNJbnRlZ2VyIiwidG9Mb3dlciIsIkpTT04iLCJzdHJpbmdpZnkiLCJrZXlzIiwidW5kZWZpbmVkIiwiZnBzIiwicGFyc2VJbnQiLCJ1dGlsIiwiaGFzVmFsdWUiLCJzZXR0aW5ncyIsInJlbW90ZVBhdGgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsUUFBUSxHQUFHLEVBQWY7O0FBRUEsTUFBTUMsc0JBQXNCLEdBQUcsS0FBSyxFQUFwQztBQUNBLE1BQU1DLDBCQUEwQixHQUFHLEtBQUssQ0FBeEM7QUFDQSxNQUFNQyx5QkFBeUIsR0FBRyxJQUFsQztBQUNBLE1BQU1DLFdBQVcsR0FBRyxFQUFwQjtBQUNBLE1BQU1DLGVBQWUsR0FBRyxRQUF4QjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxPQUF2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R0FGRCxDQUVFLE9BQU90QyxDQUFQLEVBQVU7QUFDVixVQUFNZ0MsY0FBYyxDQUFDNUIsU0FBZixDQUF5QixJQUF6QixDQUFOO0FBQ0EsVUFBTTRCLGNBQWMsQ0FBQ25CLE9BQWYsRUFBTjtBQUNBLFVBQU1iLENBQU47QUFDRDs7QUFDRCxPQUFLcUMscUJBQUwsR0FBNkJMLGNBQTdCO0FBRUEsU0FBTzFCLE1BQVA7QUFDRCxDQTVGRDs7QUE2SEFsRSxRQUFRLENBQUNpRixtQkFBVCxHQUErQixlQUFlQSxtQkFBZixDQUFvQ0osT0FBTyxHQUFHLEVBQTlDLEVBQWtEO0FBQy9FLE1BQUksQ0FBQyxLQUFLb0IscUJBQVYsRUFBaUM7QUFDL0J4RCxvQkFBSWUsSUFBSixDQUFTLDREQUFUOztBQUNBLFdBQU8sRUFBUDtBQUNEOztBQUVELE1BQUk7QUFDRixVQUFNcEMsU0FBUyxHQUFHLE1BQU0sS0FBSzZFLHFCQUFMLENBQTJCekIsTUFBM0IsRUFBeEI7O0FBQ0EsUUFBSSxFQUFDLE1BQU05QyxrQkFBR2dELE1BQUgsQ0FBVXRELFNBQVYsQ0FBUCxDQUFKLEVBQWlDO0FBQy9CcUIsc0JBQUl1RCxhQUFKLENBQW1CLHlDQUFELEdBQ2YsNENBQTJDNUUsU0FBVSxHQUR4RDtBQUVEOztBQUNELFdBQU8sTUFBTSxpQ0FBcUJBLFNBQXJCLEVBQWdDeUQsT0FBTyxDQUFDd0MsVUFBeEMsRUFBb0R4QyxPQUFwRCxDQUFiO0FBQ0QsR0FQRCxTQU9VO0FBQ1IsVUFBTSxLQUFLb0IscUJBQUwsQ0FBMkJqQyxTQUEzQixDQUFxQyxJQUFyQyxDQUFOO0FBQ0EsVUFBTSxLQUFLaUMscUJBQUwsQ0FBMkJ4QixPQUEzQixFQUFOO0FBQ0EsU0FBS3dCLHFCQUFMLEdBQTZCLElBQTdCO0FBQ0Q7QUFDRixDQWxCRDs7ZUFzQmVqRyxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyLCBsb2dnZXIsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBTdWJQcm9jZXNzIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGVuY29kZUJhc2U2NE9yVXBsb2FkLCBpc0xvY2FsSG9zdCB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCBERVZJQ0VfQ09OTkVDVElPTlNfRkFDVE9SWSBmcm9tICcuLi9kZXZpY2UtY29ubmVjdGlvbnMtZmFjdG9yeSc7XG5pbXBvcnQgeyBXREFfQkFTRV9VUkwgfSBmcm9tICdhcHBpdW0td2ViZHJpdmVyYWdlbnQnO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcblxubGV0IGNvbW1hbmRzID0ge307XG5cbmNvbnN0IE1BWF9SRUNPUkRJTkdfVElNRV9TRUMgPSA2MCAqIDMwO1xuY29uc3QgREVGQVVMVF9SRUNPUkRJTkdfVElNRV9TRUMgPSA2MCAqIDM7XG5jb25zdCBERUZBVUxUX01KUEVHX1NFUlZFUl9QT1JUID0gOTEwMDtcbmNvbnN0IERFRkFVTFRfRlBTID0gMTA7XG5jb25zdCBERUZBVUxUX1FVQUxJVFkgPSAnbWVkaXVtJztcbmNvbnN0IERFRkFVTFRfVkNPREVDID0gJ21qcGVnJztcbmNvbnN0IE1QNF9FWFQgPSAnLm1wNCc7XG5jb25zdCBGRk1QRUdfQklOQVJZID0gJ2ZmbXBlZyc7XG5jb25zdCBmZm1wZWdMb2dnZXIgPSBsb2dnZXIuZ2V0TG9nZ2VyKEZGTVBFR19CSU5BUlkpO1xuY29uc3QgUVVBTElUWV9NQVBQSU5HID0ge1xuICBsb3c6IDEwLFxuICBtZWRpdW06IDI1LFxuICBoaWdoOiA3NSxcbiAgcGhvdG86IDEwMCxcbn07XG5cblxuY2xhc3MgU2NyZWVuUmVjb3JkZXIge1xuICBjb25zdHJ1Y3RvciAodWRpZCwgdmlkZW9QYXRoLCBvcHRzID0ge30pIHtcbiAgICB0aGlzLnZpZGVvUGF0aCA9IHZpZGVvUGF0aDtcbiAgICB0aGlzLm9wdHMgPSBvcHRzO1xuICAgIHRoaXMudWRpZCA9IHVkaWQ7XG4gICAgdGhpcy5tYWluUHJvY2VzcyA9IG51bGw7XG4gICAgdGhpcy50aW1lb3V0SGFuZGxlciA9IG51bGw7XG4gIH1cblxuICBhc3luYyBzdGFydCAodGltZW91dE1zKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGZzLndoaWNoKEZGTVBFR19CSU5BUlkpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAnJHtGRk1QRUdfQklOQVJZfScgYmluYXJ5IGlzIG5vdCBmb3VuZCBpbiBQQVRILiBJbnN0YWxsIGl0IHVzaW5nICdicmV3IGluc3RhbGwgZmZtcGVnJy4gYCArXG4gICAgICAgIGBDaGVjayBodHRwczovL3d3dy5mZm1wZWcub3JnL2Rvd25sb2FkLmh0bWwgZm9yIG1vcmUgZGV0YWlscy5gKTtcbiAgICB9XG5cbiAgICBjb25zdCB7XG4gICAgICByZW1vdGVQb3J0LFxuICAgICAgcmVtb3RlVXJsLFxuICAgICAgdXNlUG9ydEZvcndhcmRpbmcsXG4gICAgICB2aWRlb0ZwcyxcbiAgICAgIHZpZGVvVHlwZSxcbiAgICAgIHZpZGVvU2NhbGUsXG4gICAgICB2aWRlb0ZpbHRlcnMsXG4gICAgICBwaXhlbEZvcm1hdCxcbiAgICB9ID0gdGhpcy5vcHRzO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IERFVklDRV9DT05ORUNUSU9OU19GQUNUT1JZLnJlcXVlc3RDb25uZWN0aW9uKHRoaXMudWRpZCwgcmVtb3RlUG9ydCwge1xuICAgICAgICBkZXZpY2VQb3J0OiByZW1vdGVQb3J0LFxuICAgICAgICB1c2VQb3J0Rm9yd2FyZGluZyxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYENhbm5vdCBmb3J3YXJkIHRoZSBsb2NhbCBwb3J0ICR7cmVtb3RlUG9ydH0gdG8gJHtyZW1vdGVQb3J0fSBgICtcbiAgICAgICAgYG9uIHRoZSBkZXZpY2UgJHt0aGlzLnVkaWR9LiBTZXQgdGhlIGN1c3RvbSB2YWx1ZSB0byAnbWpwZWdTZXJ2ZXJQb3J0JyBgICtcbiAgICAgICAgYGNhcGFiaWxpdHkgaWYgdGhpcyBpcyBhbiB1bmRlc2lyZWQgYmVoYXZpb3IuYCk7XG4gICAgfVxuXG4gICAgY29uc3QgYXJncyA9IFtcbiAgICAgICctZicsICdtanBlZycsXG4gICAgXTtcbiAgICAvL1BhcmFtZXRlciBgLXJgIGlzIG9wdGlvbmFsLiBTZWUgZGV0YWlsczogaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vaXNzdWVzLzEyMDY3XG4gICAgaWYgKHZpZGVvRnBzICYmIHZpZGVvVHlwZSA9PT0gJ2xpYngyNjQnKSB7XG4gICAgICBhcmdzLnB1c2goJy1yJywgdmlkZW9GcHMpO1xuICAgIH1cbiAgICBjb25zdCB7cHJvdG9jb2wsIGhvc3RuYW1lfSA9IHVybC5wYXJzZShyZW1vdGVVcmwpO1xuICAgIGFyZ3MucHVzaCgnLWknLCBgJHtwcm90b2NvbH0vLyR7aG9zdG5hbWV9OiR7cmVtb3RlUG9ydH1gKTtcbiAgICBpZiAodmlkZW9GaWx0ZXJzIHx8IHZpZGVvU2NhbGUpIHtcbiAgICAgIGFyZ3MucHVzaCgnLXZmJywgdmlkZW9GaWx0ZXJzIHx8IGBzY2FsZT0ke3ZpZGVvU2NhbGV9YCk7XG4gICAgfVxuICAgIC8vIFF1aWNrdGltZSBjb21wYXRpYmlsaXR5IHZpYSBwaXhlbEZvcm1hdDogJ3l1djQyMHAnXG4gICAgaWYgKHBpeGVsRm9ybWF0KSB7XG4gICAgICBhcmdzLnB1c2goJy1waXhfZm10JywgcGl4ZWxGb3JtYXQpO1xuICAgIH1cbiAgICBhcmdzLnB1c2goXG4gICAgICAnLXZjb2RlYycsIHZpZGVvVHlwZSxcbiAgICAgICcteScsIHRoaXMudmlkZW9QYXRoXG4gICAgKTtcblxuICAgIHRoaXMubWFpblByb2Nlc3MgPSBuZXcgU3ViUHJvY2VzcyhGRk1QRUdfQklOQVJZLCBhcmdzKTtcbiAgICBsZXQgaXNDYXB0dXJlU3RhcnRlZCA9IGZhbHNlO1xuICAgIHRoaXMubWFpblByb2Nlc3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgaWYgKHN0ZGVycikge1xuICAgICAgICBpZiAoc3RkZXJyLnRyaW0oKS5zdGFydHNXaXRoKCdmcmFtZT0nKSkge1xuICAgICAgICAgIGlmICghaXNDYXB0dXJlU3RhcnRlZCkge1xuICAgICAgICAgICAgaXNDYXB0dXJlU3RhcnRlZCA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGZmbXBlZ0xvZ2dlci5pbmZvKGAke3N0ZGVycn1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMubWFpblByb2Nlc3Muc3RhcnQoMCk7XG4gICAgY29uc3Qgc3RhcnR1cFRpbWVvdXQgPSA1MDAwO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKCgpID0+IGlzQ2FwdHVyZVN0YXJ0ZWQsIHtcbiAgICAgICAgd2FpdE1zOiBzdGFydHVwVGltZW91dCxcbiAgICAgICAgaW50ZXJ2YWxNczogMzAwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLndhcm4oYFNjcmVlbiBjYXB0dXJlIHByb2Nlc3MgZGlkIG5vdCBzdGFydCB3aXRoaW4gJHtzdGFydHVwVGltZW91dH1tcy4gQ29udGludWluZyBhbnl3YXlgKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLm1haW5Qcm9jZXNzLmlzUnVubmluZykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgc2NyZWVuIGNhcHR1cmUgcHJvY2VzcyAnJHtGRk1QRUdfQklOQVJZfScgZGllZCB1bmV4cGVjdGVkbHkuIGAgK1xuICAgICAgICBgQ2hlY2sgc2VydmVyIGxvZ3MgZm9yIG1vcmUgZGV0YWlsc2ApO1xuICAgIH1cbiAgICBsb2cuaW5mbyhgU3RhcnRpbmcgc2NyZWVuIGNhcHR1cmUgb24gdGhlIGRldmljZSAnJHt0aGlzLnVkaWR9JyB3aXRoIGNvbW1hbmQ6ICcke0ZGTVBFR19CSU5BUll9ICR7YXJncy5qb2luKCcgJyl9Jy4gYCArXG4gICAgICBgV2lsbCB0aW1lb3V0IGluICR7dGltZW91dE1zfW1zYCk7XG5cbiAgICB0aGlzLnRpbWVvdXRIYW5kbGVyID0gc2V0VGltZW91dChhc3luYyAoKSA9PiB7XG4gICAgICBpZiAoIWF3YWl0IHRoaXMuaW50ZXJydXB0KCkpIHtcbiAgICAgICAgbG9nLndhcm4oYENhbm5vdCBmaW5pc2ggdGhlIGFjdGl2ZSBzY3JlZW4gcmVjb3JkaW5nIG9uIHRoZSBkZXZpY2UgJyR7dGhpcy51ZGlkfScgYWZ0ZXIgJHt0aW1lb3V0TXN9bXMgdGltZW91dGApO1xuICAgICAgfVxuICAgIH0sIHRpbWVvdXRNcyk7XG4gIH1cblxuICBhc3luYyBpbnRlcnJ1cHQgKGZvcmNlID0gZmFsc2UpIHtcbiAgICBsZXQgcmVzdWx0ID0gdHJ1ZTtcblxuICAgIGlmICh0aGlzLnRpbWVvdXRIYW5kbGVyKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0SGFuZGxlcik7XG4gICAgICB0aGlzLnRpbWVvdXRIYW5kbGVyID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5tYWluUHJvY2VzcyAmJiB0aGlzLm1haW5Qcm9jZXNzLmlzUnVubmluZykge1xuICAgICAgY29uc3QgaW50ZXJydXB0UHJvbWlzZSA9IHRoaXMubWFpblByb2Nlc3Muc3RvcChmb3JjZSA/ICdTSUdURVJNJyA6ICdTSUdJTlQnKTtcbiAgICAgIHRoaXMubWFpblByb2Nlc3MgPSBudWxsO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgaW50ZXJydXB0UHJvbWlzZTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nLndhcm4oYENhbm5vdCAke2ZvcmNlID8gJ3Rlcm1pbmF0ZScgOiAnaW50ZXJydXB0J30gJHtGRk1QRUdfQklOQVJZfS4gYCArXG4gICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICAgICAgcmVzdWx0ID0gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgREVWSUNFX0NPTk5FQ1RJT05TX0ZBQ1RPUlkucmVsZWFzZUNvbm5lY3Rpb24odGhpcy51ZGlkLCB0aGlzLm9wdHMucmVtb3RlUG9ydCk7XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgYXN5bmMgZmluaXNoICgpIHtcbiAgICBhd2FpdCB0aGlzLmludGVycnVwdCgpO1xuICAgIHJldHVybiB0aGlzLnZpZGVvUGF0aDtcbiAgfVxuXG4gIGFzeW5jIGNsZWFudXAgKCkge1xuICAgIGlmIChhd2FpdCBmcy5leGlzdHModGhpcy52aWRlb1BhdGgpKSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYodGhpcy52aWRlb1BhdGgpO1xuICAgIH1cbiAgfVxufVxuXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RhcnRSZWNvcmRpbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gdGhlIHJlbW90ZSBsb2NhdGlvbiwgd2hlcmUgdGhlIHJlc3VsdGluZyB2aWRlbyBzaG91bGQgYmUgdXBsb2FkZWQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZm9sbG93aW5nIHByb3RvY29scyBhcmUgc3VwcG9ydGVkOiBodHRwL2h0dHBzLCBmdHAuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOdWxsIG9yIGVtcHR5IHN0cmluZyB2YWx1ZSAodGhlIGRlZmF1bHQgc2V0dGluZykgbWVhbnMgdGhlIGNvbnRlbnQgb2YgcmVzdWx0aW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlIHNob3VsZCBiZSBlbmNvZGVkIGFzIEJhc2U2NCBhbmQgcGFzc2VkIGFzIHRoZSBlbmRwb2ludCByZXNwb25zZSB2YWx1ZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBpZiB0aGUgZ2VuZXJhdGVkIG1lZGlhIGZpbGUgaXMgdG9vIGJpZyB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZml0IGludG8gdGhlIGF2YWlsYWJsZSBwcm9jZXNzIG1lbW9yeS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb3B0aW9uIG9ubHkgaGFzIGFuIGVmZmVjdCBpZiB0aGVyZSBpcyBzY3JlZW4gcmVjb3JkaW5nIHByb2Nlc3MgaW4gcHJvZ3Jlc3NcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZCBgZm9yY2VSZXN0YXJ0YCBwYXJhbWV0ZXIgaXMgbm90IHNldCB0byBgdHJ1ZWAuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHVzZXIgLSBUaGUgbmFtZSBvZiB0aGUgdXNlciBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBhc3MgLSBUaGUgcGFzc3dvcmQgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBtZXRob2QgLSBUaGUgaHR0cCBtdWx0aXBhcnQgdXBsb2FkIG1ldGhvZCBuYW1lLiBUaGUgJ1BVVCcgb25lIGlzIHVzZWQgYnkgZGVmYXVsdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHZpZGVvVHlwZSAtIFRoZSB2aWRlbyBjb2RlYyB0eXBlIHVzZWQgZm9yIGVuY29kaW5nIG9mIHRoZSBiZSByZWNvcmRlZCBzY3JlZW4gY2FwdHVyZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRXhlY3V0ZSBgZmZtcGVnIC1jb2RlY3NgIGluIHRoZSB0ZXJtaW5hbCB0byBzZWUgdGhlIGxpc3Qgb2Ygc3VwcG9ydGVkIHZpZGVvIGNvZGVjcy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ21qcGVnJyBieSBkZWZhdWx0LlxuICogQHByb3BlcnR5IHs/c3RyaW5nfG51bWJlcn0gdmlkZW9RdWFsaXR5IC0gVGhlIHZpZGVvIGVuY29kaW5nIHF1YWxpdHkgKGxvdywgbWVkaXVtLCBoaWdoLCBwaG90byAtIGRlZmF1bHRzIHRvIG1lZGl1bSkuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd8bnVtYmVyfSB2aWRlb0ZwcyAtIFRoZSBGcmFtZXMgUGVyIFNlY29uZCByYXRlIG9mIHRoZSByZWNvcmRlZCB2aWRlby4gQ2hhbmdlIHRoaXMgdmFsdWUgaWYgdGhlIHJlc3VsdGluZyB2aWRlb1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzIHRvbyBzbG93IG9yIHRvbyBmYXN0LiBEZWZhdWx0cyB0byAxMC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdmlkZW9GaWx0ZXJzIC0gVGhlIEZGTVBFRyB2aWRlbyBmaWx0ZXJzIHRvIGFwcGx5LiBUaGVzZSBmaWx0ZXJzIGFsbG93IHRvIHNjYWxlLCBmbGlwLCByb3RhdGUgYW5kIGRvIG1hbnlcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3RoZXIgdXNlZnVsIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGUgc291cmNlIHZpZGVvIHN0cmVhbS4gVGhlIGZvcm1hdCBvZiB0aGUgcHJvcGVydHlcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXVzdCBjb21wbHkgd2l0aCBodHRwczovL2ZmbXBlZy5vcmcvZmZtcGVnLWZpbHRlcnMuaHRtbFxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2aWRlb1NjYWxlIC0gVGhlIHNjYWxpbmcgdmFsdWUgdG8gYXBwbHkuIFJlYWQgaHR0cHM6Ly90cmFjLmZmbXBlZy5vcmcvd2lraS9TY2FsaW5nIGZvciBwb3NzaWJsZSB2YWx1ZXMuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBObyBzY2FsZSBpcyBhcHBsaWVkIGJ5IGRlZmF1bHQuIElmIGJvdGggYHZpZGVvRmlsdGVyc2AgYW5kIGB2aWRlb1NjYWxlYCBhcmUgc2V0IHRoZW5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ubHkgYHZpZGVvRmlsdGVyc2AgdmFsdWUgd2lsbCBiZSByZXNwZWN0ZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBpeGVsRm9ybWF0IC0gT3V0cHV0IHBpeGVsIGZvcm1hdC4gUnVuIGBmZm1wZWcgLXBpeF9mbXRzYCB0byBsaXN0IHBvc3NpYmxlIHZhbHVlcy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGb3IgUXVpY2t0aW1lIGNvbXBhdGliaWxpdHksIHNldCB0byBcInl1djQyMHBcIiBhbG9uZyB3aXRoIHZpZGVvVHlwZTogXCJsaWJ4MjY0XCIuXG4gKiBAcHJvcGVydHkgez9ib29sZWFufSBmb3JjZVJlc3RhcnQgLSBXaGV0aGVyIHRvIHRyeSB0byBjYXRjaCBhbmQgdXBsb2FkL3JldHVybiB0aGUgY3VycmVudGx5IHJ1bm5pbmcgc2NyZWVuIHJlY29yZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGBmYWxzZWAsIHRoZSBkZWZhdWx0IHNldHRpbmcpIG9yIGlnbm9yZSB0aGUgcmVzdWx0IG9mIGl0IGFuZCBzdGFydCBhIG5ldyByZWNvcmRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltbWVkaWF0ZWx5LlxuICogQHByb3BlcnR5IHs/c3RyaW5nfG51bWJlcn0gdGltZUxpbWl0IC0gVGhlIG1heGltdW0gcmVjb3JkaW5nIHRpbWUsIGluIHNlY29uZHMuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZGVmYXVsdCB2YWx1ZSBpcyAxODAsIHRoZSBtYXhpbXVtIHZhbHVlIGlzIDYwMCAoMTAgbWludXRlcykuXG4gKi9cblxuLyoqXG4gKiBSZWNvcmQgdGhlIGRpc3BsYXkgb2YgZGV2aWNlcyBydW5uaW5nIGlPUyBTaW11bGF0b3Igc2luY2UgWGNvZGUgOSBvciByZWFsIGRldmljZXMgc2luY2UgaU9TIDExXG4gKiAoZmZtcGVnIHV0aWxpdHkgaXMgcmVxdWlyZWQ6ICdicmV3IGluc3RhbGwgZmZtcGVnJykuXG4gKiBJdCByZWNvcmRzIHNjcmVlbiBhY3Rpdml0eSB0byBhIE1QRUctNCBmaWxlLiBBdWRpbyBpcyBub3QgcmVjb3JkZWQgd2l0aCB0aGUgdmlkZW8gZmlsZS5cbiAqIElmIHNjcmVlbiByZWNvcmRpbmcgaGFzIGJlZW4gYWxyZWFkeSBzdGFydGVkIHRoZW4gdGhlIGNvbW1hbmQgd2lsbCBzdG9wIGl0IGZvcmNlZnVsbHkgYW5kIHN0YXJ0IGEgbmV3IG9uZS5cbiAqIFRoZSBwcmV2aW91c2x5IHJlY29yZGVkIHZpZGVvIGZpbGUgd2lsbCBiZSBkZWxldGVkLlxuICpcbiAqIEBwYXJhbSB7P1N0YXJ0UmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHJlY29yZGVkIG1lZGlhIGZpbGUgaWZcbiAqICAgICAgICAgICAgICAgICAgIGFueSBzY3JlZW4gcmVjb3JkaW5nIGlzIGN1cnJlbnRseSBydW5uaW5nIG9yIGFuIGVtcHR5IHN0cmluZy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzY3JlZW4gcmVjb3JkaW5nIGhhcyBmYWlsZWQgdG8gc3RhcnQuXG4gKi9cbmNvbW1hbmRzLnN0YXJ0UmVjb3JkaW5nU2NyZWVuID0gYXN5bmMgZnVuY3Rpb24gc3RhcnRSZWNvcmRpbmdTY3JlZW4gKG9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgdmlkZW9UeXBlID0gREVGQVVMVF9WQ09ERUMsXG4gICAgdGltZUxpbWl0ID0gREVGQVVMVF9SRUNPUkRJTkdfVElNRV9TRUMsXG4gICAgdmlkZW9RdWFsaXR5ID0gREVGQVVMVF9RVUFMSVRZLFxuICAgIHZpZGVvRnBzID0gREVGQVVMVF9GUFMsXG4gICAgdmlkZW9GaWx0ZXJzLFxuICAgIHZpZGVvU2NhbGUsXG4gICAgZm9yY2VSZXN0YXJ0LFxuICAgIHBpeGVsRm9ybWF0XG4gIH0gPSBvcHRpb25zO1xuXG4gIGxldCByZXN1bHQgPSAnJztcbiAgaWYgKCFmb3JjZVJlc3RhcnQpIHtcbiAgICBsb2cuaW5mbyhgQ2hlY2tpbmcgaWYgdGhlcmUgaXMvd2FzIGEgcHJldmlvdXMgc2NyZWVuIHJlY29yZGluZy4gYCArXG4gICAgICBgU2V0ICdmb3JjZVJlc3RhcnQnIG9wdGlvbiB0byAndHJ1ZScgaWYgeW91J2QgbGlrZSB0byBza2lwIHRoaXMgc3RlcC5gKTtcbiAgICByZXN1bHQgPSBhd2FpdCB0aGlzLnN0b3BSZWNvcmRpbmdTY3JlZW4ob3B0aW9ucyk7XG4gIH1cblxuICBjb25zdCB2aWRlb1BhdGggPSBhd2FpdCB0ZW1wRGlyLnBhdGgoe1xuICAgIHByZWZpeDogYGFwcGl1bV8ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMTYpLnN1YnN0cmluZygyLCA4KX1gLFxuICAgIHN1ZmZpeDogTVA0X0VYVCxcbiAgfSk7XG5cbiAgY29uc3Qgd2RhQmFzZVVybCA9IHRoaXMub3B0cy53ZGFCYXNlVXJsIHx8IFdEQV9CQVNFX1VSTDtcbiAgY29uc3Qgc2NyZWVuUmVjb3JkZXIgPSBuZXcgU2NyZWVuUmVjb3JkZXIodGhpcy5vcHRzLmRldmljZS51ZGlkLCB2aWRlb1BhdGgsIHtcbiAgICByZW1vdGVQb3J0OiB0aGlzLm9wdHMubWpwZWdTZXJ2ZXJQb3J0IHx8IERFRkFVTFRfTUpQRUdfU0VSVkVSX1BPUlQsXG4gICAgcmVtb3RlVXJsOiB3ZGFCYXNlVXJsLFxuICAgIHVzZVBvcnRGb3J3YXJkaW5nOiB0aGlzLmlzUmVhbERldmljZSgpICYmIGlzTG9jYWxIb3N0KHdkYUJhc2VVcmwpLFxuICAgIHZpZGVvVHlwZSxcbiAgICB2aWRlb0ZpbHRlcnMsXG4gICAgdmlkZW9TY2FsZSxcbiAgICB2aWRlb0ZwcyxcbiAgICBwaXhlbEZvcm1hdFxuICB9KTtcbiAgaWYgKCFhd2FpdCBzY3JlZW5SZWNvcmRlci5pbnRlcnJ1cHQodHJ1ZSkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdygnVW5hYmxlIHRvIHN0b3Agc2NyZWVuIHJlY29yZGluZyBwcm9jZXNzJyk7XG4gIH1cbiAgaWYgKHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyKSB7XG4gICAgYXdhaXQgdGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIuY2xlYW51cCgpO1xuICAgIHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyID0gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IHRpbWVvdXRTZWNvbmRzID0gcGFyc2VGbG9hdCh0aW1lTGltaXQpO1xuICBpZiAoaXNOYU4odGltZW91dFNlY29uZHMpIHx8IHRpbWVvdXRTZWNvbmRzID4gTUFYX1JFQ09SRElOR19USU1FX1NFQyB8fCB0aW1lb3V0U2Vjb25kcyA8PSAwKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSB0aW1lTGltaXQgdmFsdWUgbXVzdCBiZSBpbiByYW5nZSBbMSwgJHtNQVhfUkVDT1JESU5HX1RJTUVfU0VDfV0gc2Vjb25kcy4gYCArXG4gICAgICBgVGhlIHZhbHVlIG9mICcke3RpbWVMaW1pdH0nIGhhcyBiZWVuIHBhc3NlZCBpbnN0ZWFkLmApO1xuICB9XG5cbiAgbGV0IHtcbiAgICBtanBlZ1NlcnZlclNjcmVlbnNob3RRdWFsaXR5LFxuICAgIG1qcGVnU2VydmVyRnJhbWVyYXRlLFxuICB9ID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9hcHBpdW0vc2V0dGluZ3MnLCAnR0VUJyk7XG4gIGlmICh2aWRlb1F1YWxpdHkpIHtcbiAgICBjb25zdCBxdWFsaXR5ID0gXy5pc0ludGVnZXIodmlkZW9RdWFsaXR5KSA/IHZpZGVvUXVhbGl0eSA6IFFVQUxJVFlfTUFQUElOR1tfLnRvTG93ZXIodmlkZW9RdWFsaXR5KV07XG4gICAgaWYgKCFxdWFsaXR5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHZpZGVvUXVhbGl0eSB2YWx1ZSBzaG91bGQgYmUgb25lIG9mICR7SlNPTi5zdHJpbmdpZnkoXy5rZXlzKFFVQUxJVFlfTUFQUElORykpfSBvciBhIG51bWJlciBpbiByYW5nZSAxLi4xMDAuIGAgK1xuICAgICAgICBgJyR7dmlkZW9RdWFsaXR5fScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICAgIH1cbiAgICBtanBlZ1NlcnZlclNjcmVlbnNob3RRdWFsaXR5ID0gbWpwZWdTZXJ2ZXJTY3JlZW5zaG90UXVhbGl0eSAhPT0gcXVhbGl0eSA/IHF1YWxpdHkgOiB1bmRlZmluZWQ7XG4gIH0gZWxzZSB7XG4gICAgbWpwZWdTZXJ2ZXJTY3JlZW5zaG90UXVhbGl0eSA9IHVuZGVmaW5lZDtcbiAgfVxuICBpZiAodmlkZW9GcHMpIHtcbiAgICBjb25zdCBmcHMgPSBwYXJzZUludCh2aWRlb0ZwcywgMTApO1xuICAgIGlmIChpc05hTihmcHMpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHZpZGVvRnBzIHZhbHVlIHNob3VsZCBiZSBhIHZhbGlkIG51bWJlciBpbiByYW5nZSAxLi42MC4gYCArXG4gICAgICAgIGAnJHt2aWRlb0Zwc30nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgICB9XG4gICAgbWpwZWdTZXJ2ZXJGcmFtZXJhdGUgPSBtanBlZ1NlcnZlckZyYW1lcmF0ZSAhPT0gZnBzID8gZnBzIDogdW5kZWZpbmVkO1xuICB9IGVsc2Uge1xuICAgIG1qcGVnU2VydmVyRnJhbWVyYXRlID0gdW5kZWZpbmVkO1xuICB9XG4gIGlmICh1dGlsLmhhc1ZhbHVlKG1qcGVnU2VydmVyU2NyZWVuc2hvdFF1YWxpdHkpIHx8IHV0aWwuaGFzVmFsdWUobWpwZWdTZXJ2ZXJGcmFtZXJhdGUpKSB7XG4gICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9hcHBpdW0vc2V0dGluZ3MnLCAnUE9TVCcsIHtcbiAgICAgIHNldHRpbmdzOiB7XG4gICAgICAgIG1qcGVnU2VydmVyU2NyZWVuc2hvdFF1YWxpdHksXG4gICAgICAgIG1qcGVnU2VydmVyRnJhbWVyYXRlLFxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCBzY3JlZW5SZWNvcmRlci5zdGFydCh0aW1lb3V0U2Vjb25kcyAqIDEwMDApO1xuICB9IGNhdGNoIChlKSB7XG4gICAgYXdhaXQgc2NyZWVuUmVjb3JkZXIuaW50ZXJydXB0KHRydWUpO1xuICAgIGF3YWl0IHNjcmVlblJlY29yZGVyLmNsZWFudXAoKTtcbiAgICB0aHJvdyBlO1xuICB9XG4gIHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyID0gc2NyZWVuUmVjb3JkZXI7XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RvcFJlY29yZGluZ09wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcGF0aCB0byB0aGUgcmVtb3RlIGxvY2F0aW9uLCB3aGVyZSB0aGUgcmVzdWx0aW5nIHZpZGVvIHNob3VsZCBiZSB1cGxvYWRlZC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBmb2xsb3dpbmcgcHJvdG9jb2xzIGFyZSBzdXBwb3J0ZWQ6IGh0dHAvaHR0cHMsIGZ0cC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE51bGwgb3IgZW1wdHkgc3RyaW5nIHZhbHVlICh0aGUgZGVmYXVsdCBzZXR0aW5nKSBtZWFucyB0aGUgY29udGVudCBvZiByZXN1bHRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUgc2hvdWxkIGJlIGVuY29kZWQgYXMgQmFzZTY0IGFuZCBwYXNzZWQgYXMgdGhlIGVuZHBvaW50IHJlc3BvbnNlIHZhbHVlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQW4gZXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duIGlmIHRoZSBnZW5lcmF0ZWQgbWVkaWEgZmlsZSBpcyB0b28gYmlnIHRvXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXQgaW50byB0aGUgYXZhaWxhYmxlIHByb2Nlc3MgbWVtb3J5LlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB1c2VyIC0gVGhlIG5hbWUgb2YgdGhlIHVzZXIgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBwYXNzIC0gVGhlIHBhc3N3b3JkIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gbWV0aG9kIC0gVGhlIGh0dHAgbXVsdGlwYXJ0IHVwbG9hZCBtZXRob2QgbmFtZS4gVGhlICdQVVQnIG9uZSBpcyB1c2VkIGJ5IGRlZmF1bHQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/T2JqZWN0fSBoZWFkZXJzIC0gQWRkaXRpb25hbCBoZWFkZXJzIG1hcHBpbmcgZm9yIG11bHRpcGFydCBodHRwKHMpIHVwbG9hZHNcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gZmlsZUZpZWxkTmFtZSBbZmlsZV0gLSBUaGUgbmFtZSBvZiB0aGUgZm9ybSBmaWVsZCwgd2hlcmUgdGhlIGZpbGUgY29udGVudCBCTE9CIHNob3VsZCBiZSBzdG9yZWQgZm9yXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cChzKSB1cGxvYWRzXG4gKiBAcHJvcGVydHkgez9PYmplY3R8QXJyYXk8UGFpcj59IGZvcm1GaWVsZHMgLSBBZGRpdGlvbmFsIGZvcm0gZmllbGRzIGZvciBtdWx0aXBhcnQgaHR0cChzKSB1cGxvYWRzXG4gKi9cblxuLyoqXG4gKiBTdG9wIHJlY29yZGluZyB0aGUgc2NyZWVuLiBJZiBubyBzY3JlZW4gcmVjb3JkaW5nIHByb2Nlc3MgaXMgcnVubmluZyB0aGVuXG4gKiB0aGUgZW5kcG9pbnQgd2lsbCB0cnkgdG8gZ2V0IHRoZSByZWNlbnRseSByZWNvcmRlZCBmaWxlLlxuICogSWYgbm8gcHJldmlvdXNseSByZWNvcmRlZCBmaWxlIGlzIGZvdW5kIGFuZCBubyBhY3RpdmUgc2NyZWVuIHJlY29yZGluZ1xuICogcHJvY2Vzc2VzIGFyZSBydW5uaW5nIHRoZW4gdGhlIG1ldGhvZCByZXR1cm5zIGFuIGVtcHR5IHN0cmluZy5cbiAqXG4gKiBAcGFyYW0gez9TdG9wUmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHJlY29yZGVkIG1lZGlhIGZpbGUgaWYgJ3JlbW90ZVBhdGgnXG4gKiAgICAgICAgICAgICAgICAgICBwYXJhbWV0ZXIgaXMgZW1wdHkgb3IgbnVsbCBvciBhbiBlbXB0eSBzdHJpbmcuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGdldHRpbmcgdGhlIG5hbWUgb2YgYSBtZWRpYSBmaWxlXG4gKiAgICAgICAgICAgICAgICAgb3IgdGhlIGZpbGUgY29udGVudCBjYW5ub3QgYmUgdXBsb2FkZWQgdG8gdGhlIHJlbW90ZSBsb2NhdGlvbi5cbiAqL1xuY29tbWFuZHMuc3RvcFJlY29yZGluZ1NjcmVlbiA9IGFzeW5jIGZ1bmN0aW9uIHN0b3BSZWNvcmRpbmdTY3JlZW4gKG9wdGlvbnMgPSB7fSkge1xuICBpZiAoIXRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyKSB7XG4gICAgbG9nLmluZm8oJ1NjcmVlbiByZWNvcmRpbmcgaXMgbm90IHJ1bm5pbmcuIFRoZXJlIGlzIG5vdGhpbmcgdG8gc3RvcC4nKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyLmZpbmlzaCgpO1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHZpZGVvUGF0aCkpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgc2NyZWVuIHJlY29yZGVyIHV0aWxpdHkgaGFzIGZhaWxlZCBgICtcbiAgICAgICAgYHRvIHN0b3JlIHRoZSBhY3R1YWwgc2NyZWVuIHJlY29yZGluZyBhdCAnJHt2aWRlb1BhdGh9J2ApO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgZW5jb2RlQmFzZTY0T3JVcGxvYWQodmlkZW9QYXRoLCBvcHRpb25zLnJlbW90ZVBhdGgsIG9wdGlvbnMpO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IHRoaXMuX3JlY2VudFNjcmVlblJlY29yZGVyLmludGVycnVwdCh0cnVlKTtcbiAgICBhd2FpdCB0aGlzLl9yZWNlbnRTY3JlZW5SZWNvcmRlci5jbGVhbnVwKCk7XG4gICAgdGhpcy5fcmVjZW50U2NyZWVuUmVjb3JkZXIgPSBudWxsO1xuICB9XG59O1xuXG5cbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3JlY29yZHNjcmVlbi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
