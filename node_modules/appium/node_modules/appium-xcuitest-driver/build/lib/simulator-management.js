"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createSim = createSim;
exports.getExistingSim = getExistingSim;
exports.installToSimulator = installToSimulator;
exports.runSimulatorReset = runSimulatorReset;
exports.setLocale = setLocale;
exports.setLocaleAndPreferences = setLocaleAndPreferences;
exports.setPreferences = setPreferences;
exports.shutdownOtherSimulators = shutdownOtherSimulators;
exports.shutdownSimulator = shutdownSimulator;

require("source-map-support/register");

var _appiumIosSimulator = require("appium-ios-simulator");

var _nodeSimctl = _interopRequireDefault(require("node-simctl"));

var _appiumWebdriveragent = require("appium-webdriveragent");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _appiumSupport = require("appium-support");

var _desiredCaps = require("./desired-caps");

const APPIUM_SIM_PREFIX = 'appiumTest';
const SETTINGS_CAPS = ['locationServicesEnabled', 'locationServicesAuthorized'];
const SAFARI_SETTINGS_CAPS = ['safariAllowPopups', 'safariIgnoreFraudWarning', 'safariOpenLinksInBackground'];

async function createSim(caps, platform = _desiredCaps.PLATFORM_NAME_IOS) {
  const devicesSetPath = caps.simulatorDevicesSetPath;
  const udid = await new _nodeSimctl.default({
    devicesSetPath
  }).createDevice(`${APPIUM_SIM_PREFIX}-${_appiumSupport.util.uuidV4().toUpperCase()}-${caps.deviceName}`, caps.deviceName, caps.platformVersion, {
    platform
  });
  return await (0, _appiumIosSimulator.getSimulator)(udid, {
    platform,
    checkExistence: false,
    devicesSetPath
  });
}

async function getExistingSim(opts = {}) {
  const {
    platformVersion,
    deviceName,
    simulatorDevicesSetPath: devicesSetPath
  } = opts;
  let appiumTestDevice;
  const simctl = new _nodeSimctl.default({
    devicesSetPath
  });

  for (const device of _lodash.default.values(await simctl.getDevices(platformVersion))) {
    if (device.name === deviceName) {
      return await (0, _appiumIosSimulator.getSimulator)(device.udid, {
        platform: device.platform,
        checkExistence: false,
        devicesSetPath
      });
    }

    if (device.name.startsWith(APPIUM_SIM_PREFIX) && device.name.endsWith(deviceName)) {
      appiumTestDevice = device;

      if (device.state === 'Booted') {
        break;
      }
    }
  }

  if (appiumTestDevice) {
    _logger.default.warn(`Unable to find device '${deviceName}'. ` + `Found '${appiumTestDevice.name}' (udid: '${appiumTestDevice.udid}') instead`);

    return await (0, _appiumIosSimulator.getSimulator)(appiumTestDevice.udid, {
      platform: appiumTestDevice.platform,
      checkExistence: false,
      devicesSetPath
    });
  }

  return null;
}

async function shutdownSimulator(device) {
  await (0, _appiumWebdriveragent.resetTestProcesses)(device.udid, true);
  await device.shutdown();
}

async function runSimulatorReset(device, opts) {
  if (opts.noReset && !opts.fullReset) {
    _logger.default.debug('Reset: noReset is on. Leaving simulator as is');

    return;
  }

  if (!device) {
    _logger.default.debug('Reset: no device available. Skipping');

    return;
  }

  if (opts.fullReset) {
    _logger.default.debug('Reset: fullReset is on. Cleaning simulator');

    await shutdownSimulator(device);
    let isKeychainsBackupSuccessful = false;

    if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      isKeychainsBackupSuccessful = await device.backupKeychains();
    }

    await device.clean();

    if (isKeychainsBackupSuccessful) {
      await device.restoreKeychains(opts.keychainsExcludePatterns || []);

      _logger.default.info(`Successfully restored keychains after full reset`);
    } else if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      _logger.default.warn('Cannot restore keychains after full reset, because ' + 'the backup operation did not succeed');
    }
  } else if (opts.bundleId) {
    if (await device.isRunning()) {
      if (opts.enforceSimulatorShutdown) {
        await shutdownSimulator(device);
      } else {
        try {
          await device.simctl.terminateApp(opts.bundleId);
        } catch (err) {
          _logger.default.warn(`Reset: failed to terminate Simulator application with id "${opts.bundleId}"`);
        }
      }
    }

    if (opts.app) {
      _logger.default.info('Not scrubbing third party app in anticipation of uninstall');

      return;
    }

    const isSafari = (opts.browserName || '').toLowerCase() === 'safari';

    try {
      if (isSafari) {
        await device.cleanSafari();
      } else {
        await device.scrubCustomApp('', opts.bundleId);
      }
    } catch (err) {
      _logger.default.warn(err.message);

      _logger.default.warn(`Reset: could not scrub ${isSafari ? 'Safari browser' : 'application with id "' + opts.bundleId + '"'}. Leaving as is.`);
    }
  }
}

async function installToSimulator(device, app, bundleId, opts = {}) {
  if (!app) {
    _logger.default.debug('No app path is given. Nothing to install.');

    return;
  }

  const {
    noReset = true,
    newSimulator = false
  } = opts;

  if (!newSimulator && bundleId && (await device.isAppInstalled(bundleId))) {
    if (noReset) {
      _logger.default.debug(`App '${bundleId}' is already installed. No need to reinstall.`);

      return;
    }

    _logger.default.debug(`Reset requested. Removing app with id '${bundleId}' from the device`);

    await device.removeApp(bundleId);
  }

  _logger.default.debug(`Installing '${app}' on Simulator with UUID '${device.udid}'...`);

  try {
    await device.installApp(app);
  } catch (e) {
    _logger.default.info(`Got an error on '${app}' install: ${e.message}`);

    _logger.default.info('Retrying application install');

    await device.installApp(app);
  }

  _logger.default.debug('The app has been installed successfully.');
}

async function shutdownOtherSimulators(currentDevice) {
  const simctl = new _nodeSimctl.default({
    devicesSetPath: currentDevice.devicesSetPath
  });

  const allDevices = _lodash.default.flatMap(_lodash.default.values(await simctl.getDevices()));

  const otherBootedDevices = allDevices.filter(device => device.udid !== currentDevice.udid && device.state === 'Booted');

  if (_lodash.default.isEmpty(otherBootedDevices)) {
    _logger.default.info('No other running simulators have been detected');

    return;
  }

  _logger.default.info(`Detected ${otherBootedDevices.length} other running ${_appiumSupport.util.pluralize('Simulator', otherBootedDevices.length)}.` + `Shutting them down...`);

  for (const {
    udid
  } of otherBootedDevices) {
    await (0, _appiumWebdriveragent.resetTestProcesses)(udid, true);
    simctl.udid = udid;
    await simctl.shutdownDevice();
  }
}

async function launchAndQuitSimulator(sim, opts = {}) {
  _logger.default.debug('No simulator directories found.');

  const {
    safari,
    timeout
  } = opts;
  return timeout ? await sim.launchAndQuit(safari, timeout) : await sim.launchAndQuit(safari);
}

function checkPreferences(settings, opts = {}) {
  for (let setting of settings) {
    if (_lodash.default.has(opts, setting)) {
      return true;
    }
  }

  return false;
}

async function setLocaleAndPreferences(sim, opts, safari = false, shutdownFn = _lodash.default.noop) {
  const localConfig = await setLocale(sim, opts, {}, safari);
  const prefsUpdated = await setPreferences(sim, opts, safari);

  if (localConfig._updated || prefsUpdated) {
    _logger.default.debug('Updated settings. Rebooting the simulator if it is already open');

    await shutdownFn(sim);
  } else {
    _logger.default.debug('Setting did not need to be updated');
  }

  delete localConfig._updated;
  return localConfig;
}

async function setLocale(sim, opts, localeConfig = {}, safari = false) {
  if (!opts.language && !opts.locale && !opts.calendarFormat) {
    _logger.default.debug('No reason to set locale');

    return {
      _updated: false
    };
  }

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, {
      safari,
      timeout: opts.simulatorStartupTimeout
    });
  }

  _logger.default.debug('Setting locale information');

  localeConfig = {
    language: opts.language || localeConfig.language,
    locale: opts.locale || localeConfig.locale,
    calendarFormat: opts.calendarFormat || localeConfig.calendarFormat,
    _updated: false
  };

  try {
    let updated = await sim.updateLocale(opts.language, opts.locale, opts.calendarFormat);

    if (updated) {
      localeConfig._updated = true;
    }
  } catch (e) {
    _logger.default.errorAndThrow(`Appium was unable to set locale info: ${e}`);
  }

  return localeConfig;
}

async function setPreferences(sim, opts, safari = false) {
  let needToSetPrefs = checkPreferences(SETTINGS_CAPS, opts);
  let needToSetSafariPrefs = checkPreferences(SAFARI_SETTINGS_CAPS, opts);

  if (!needToSetPrefs && !needToSetSafariPrefs) {
    _logger.default.debug('No iOS / app preferences to set');

    return false;
  }

  _logger.default.debug('Setting iOS and app preferences');

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, {
      safari,
      timeout: opts.simulatorStartupTimeout
    });
  }

  let updated = false;

  try {
    if (needToSetPrefs) {
      updated = await setLocServicesPrefs(sim, opts);
    }
  } catch (e) {
    _logger.default.error('Error setting location services preferences, prefs will not work');

    _logger.default.error(e);
  }

  try {
    if (needToSetSafariPrefs) {
      updated = (await setSafariPrefs(sim, opts)) || updated;
    }
  } catch (e) {
    _logger.default.error('Error setting safari preferences, prefs will not work');

    _logger.default.error(e);
  }

  return updated;
}

async function setLocServicesPrefs(sim, opts = {}) {
  let locServ = _lodash.default.find([opts.locationServicesEnabled, opts.locationServicesAuthorized], c => !_lodash.default.isUndefined(c));

  if (!_lodash.default.isUndefined(locServ)) {
    locServ = locServ ? 1 : 0;

    _logger.default.debug(`Setting location services to ${locServ}`);

    await sim.updateSettings('locationServices', {
      LocationServicesEnabled: locServ,
      'LocationServicesEnabledIn7.0': locServ,
      'LocationServicesEnabledIn8.0': locServ
    });
  }

  if (!_lodash.default.isUndefined(opts.locationServicesAuthorized)) {
    if (!opts.bundleId) {
      let msg = "Can't set location services for app without bundle ID";

      _logger.default.errorAndThrow(msg);
    }

    let locAuth = !!opts.locationServicesAuthorized;

    if (locAuth) {
      _logger.default.debug('Authorizing location services for app');
    } else {
      _logger.default.debug('De-authorizing location services for app');
    }

    await sim.updateLocationSettings(opts.bundleId, locAuth);
  }
}

async function setSafariPrefs(sim, opts = {}) {
  let safariSettings = {};

  if (_lodash.default.has(opts, 'safariAllowPopups')) {
    const val = !!opts.safariAllowPopups;

    _logger.default.debug(`Setting javascript window opening to '${val}'`);

    safariSettings.WebKitJavaScriptCanOpenWindowsAutomatically = val;
    safariSettings.JavaScriptCanOpenWindowsAutomatically = val;
  }

  if (_lodash.default.has(opts, 'safariIgnoreFraudWarning')) {
    const val = !opts.safariIgnoreFraudWarning;

    _logger.default.debug(`Setting fraudulent website warning to '${val}'`);

    safariSettings.WarnAboutFraudulentWebsites = val;
  }

  if (_lodash.default.has(opts, 'safariOpenLinksInBackground')) {
    const val = opts.safariOpenLinksInBackground ? 1 : 0;

    _logger.default.debug(`Setting opening links in background to '${!!val}'`);

    safariSettings.OpenLinksInBackground = val;
  }

  return _lodash.default.size(safariSettings) > 0 ? await sim.updateSafariSettings(safariSettings) : false;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3ItbWFuYWdlbWVudC5qcyJdLCJuYW1lcyI6WyJBUFBJVU1fU0lNX1BSRUZJWCIsIlNFVFRJTkdTX0NBUFMiLCJTQUZBUklfU0VUVElOR1NfQ0FQUyIsImNyZWF0ZVNpbSIsImNhcHMiLCJwbGF0Zm9ybSIsIlBMQVRGT1JNX05BTUVfSU9TIiwiZGV2aWNlc1NldFBhdGgiLCJzaW11bGF0b3JEZXZpY2VzU2V0UGF0aCIsInVkaWQiLCJTaW1jdGwiLCJjcmVhdGVEZXZpY2UiLCJ1dGlsIiwidXVpZFY0IiwidG9VcHBlckNhc2UiLCJkZXZpY2VOYW1lIiwicGxhdGZvcm1WZXJzaW9uIiwiY2hlY2tFeGlzdGVuY2UiLCJnZXRFeGlzdGluZ1NpbSIsIm9wdHMiLCJhcHBpdW1UZXN0RGV2aWNlIiwic2ltY3RsIiwiZGV2aWNlIiwiXyIsInZhbHVlcyIsImdldERldmljZXMiLCJuYW1lIiwic3RhcnRzV2l0aCIsImVuZHNXaXRoIiwic3RhdGUiLCJsb2ciLCJ3YXJuIiwic2h1dGRvd25TaW11bGF0b3IiLCJzaHV0ZG93biIsInJ1blNpbXVsYXRvclJlc2V0Iiwibm9SZXNldCIsImZ1bGxSZXNldCIsImRlYnVnIiwiaXNLZXljaGFpbnNCYWNrdXBTdWNjZXNzZnVsIiwia2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIiwia2VlcEtleUNoYWlucyIsImJhY2t1cEtleWNoYWlucyIsImNsZWFuIiwicmVzdG9yZUtleWNoYWlucyIsImluZm8iLCJidW5kbGVJZCIsImlzUnVubmluZyIsImVuZm9yY2VTaW11bGF0b3JTaHV0ZG93biIsInRlcm1pbmF0ZUFwcCIsImVyciIsImFwcCIsImlzU2FmYXJpIiwiYnJvd3Nlck5hbWUiLCJ0b0xvd2VyQ2FzZSIsImNsZWFuU2FmYXJpIiwic2NydWJDdXN0b21BcHAiLCJtZXNzYWdlIiwiaW5zdGFsbFRvU2ltdWxhdG9yIiwibmV3U2ltdWxhdG9yIiwiaXNBcHBJbnN0YWxsZWQiLCJyZW1vdmVBcHAiLCJpbnN0YWxsQXBwIiwiZSIsInNodXRkb3duT3RoZXJTaW11bGF0b3JzIiwiY3VycmVudERldmljZSIsImFsbERldmljZXMiLCJmbGF0TWFwIiwib3RoZXJCb290ZWREZXZpY2VzIiwiZmlsdGVyIiwiaXNFbXB0eSIsImxlbmd0aCIsInBsdXJhbGl6ZSIsInNodXRkb3duRGV2aWNlIiwibGF1bmNoQW5kUXVpdFNpbXVsYXRvciIsInNpbSIsInNhZmFyaSIsInRpbWVvdXQiLCJsYXVuY2hBbmRRdWl0IiwiY2hlY2tQcmVmZXJlbmNlcyIsInNldHRpbmdzIiwic2V0dGluZyIsImhhcyIsInNldExvY2FsZUFuZFByZWZlcmVuY2VzIiwic2h1dGRvd25GbiIsIm5vb3AiLCJsb2NhbENvbmZpZyIsInNldExvY2FsZSIsInByZWZzVXBkYXRlZCIsInNldFByZWZlcmVuY2VzIiwiX3VwZGF0ZWQiLCJsb2NhbGVDb25maWciLCJsYW5ndWFnZSIsImxvY2FsZSIsImNhbGVuZGFyRm9ybWF0IiwiaXNGcmVzaCIsInNpbXVsYXRvclN0YXJ0dXBUaW1lb3V0IiwidXBkYXRlZCIsInVwZGF0ZUxvY2FsZSIsImVycm9yQW5kVGhyb3ciLCJuZWVkVG9TZXRQcmVmcyIsIm5lZWRUb1NldFNhZmFyaVByZWZzIiwic2V0TG9jU2VydmljZXNQcmVmcyIsImVycm9yIiwic2V0U2FmYXJpUHJlZnMiLCJsb2NTZXJ2IiwiZmluZCIsImxvY2F0aW9uU2VydmljZXNFbmFibGVkIiwibG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQiLCJjIiwiaXNVbmRlZmluZWQiLCJ1cGRhdGVTZXR0aW5ncyIsIkxvY2F0aW9uU2VydmljZXNFbmFibGVkIiwibXNnIiwibG9jQXV0aCIsInVwZGF0ZUxvY2F0aW9uU2V0dGluZ3MiLCJzYWZhcmlTZXR0aW5ncyIsInZhbCIsInNhZmFyaUFsbG93UG9wdXBzIiwiV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSIsIkphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkiLCJzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmciLCJXYXJuQWJvdXRGcmF1ZHVsZW50V2Vic2l0ZXMiLCJzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQiLCJPcGVuTGlua3NJbkJhY2tncm91bmQiLCJzaXplIiwidXBkYXRlU2FmYXJpU2V0dGluZ3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxpQkFBaUIsR0FBRyxZQUExQjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxDQUNwQix5QkFEb0IsRUFFcEIsNEJBRm9CLENBQXRCO0FBSUEsTUFBTUMsb0JBQW9CLEdBQUcsQ0FDM0IsbUJBRDJCLEVBRTNCLDBCQUYyQixFQUczQiw2QkFIMkIsQ0FBN0I7O0FBbUJBLGVBQWVDLFNBQWYsQ0FBMEJDLElBQTFCLEVBQWdDQyxRQUFRLEdBQUdDLDhCQUEzQyxFQUE4RDtBQUM1RCxRQUFNQyxjQUFjLEdBQUdILElBQUksQ0FBQ0ksdUJBQTVCO0FBQ0EsUUFBTUMsSUFBSSxHQUFHLE1BQU0sSUFBSUMsbUJBQUosQ0FBVztBQUFDSCxJQUFBQTtBQUFELEdBQVgsRUFBNkJJLFlBQTdCLENBQ2hCLEdBQUVYLGlCQUFrQixJQUFHWSxvQkFBS0MsTUFBTCxHQUFjQyxXQUFkLEVBQTRCLElBQUdWLElBQUksQ0FBQ1csVUFBVyxFQUR0RCxFQUVqQlgsSUFBSSxDQUFDVyxVQUZZLEVBR2pCWCxJQUFJLENBQUNZLGVBSFksRUFJakI7QUFBQ1gsSUFBQUE7QUFBRCxHQUppQixDQUFuQjtBQU1BLFNBQU8sTUFBTSxzQ0FBYUksSUFBYixFQUFtQjtBQUM5QkosSUFBQUEsUUFEOEI7QUFFOUJZLElBQUFBLGNBQWMsRUFBRSxLQUZjO0FBRzlCVixJQUFBQTtBQUg4QixHQUFuQixDQUFiO0FBS0Q7O0FBZUQsZUFBZVcsY0FBZixDQUErQkMsSUFBSSxHQUFHLEVBQXRDLEVBQTBDO0FBQ3hDLFFBQU07QUFDSkgsSUFBQUEsZUFESTtBQUVK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cUcsSUFBRixDQUFPVCxjQUFQLElBQXlCLENBQTFCLEdBQ0gsTUFBTXpDLEdBQUcsQ0FBQ21ELG9CQUFKLENBQXlCVixjQUF6QixDQURILEdBRUgsS0FGSjtBQUdEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0U2ltdWxhdG9yIH0gZnJvbSAnYXBwaXVtLWlvcy1zaW11bGF0b3InO1xuaW1wb3J0IFNpbWN0bCBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyByZXNldFRlc3RQcm9jZXNzZXMgfSBmcm9tICdhcHBpdW0td2ViZHJpdmVyYWdlbnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IFBMQVRGT1JNX05BTUVfSU9TIH0gZnJvbSAnLi9kZXNpcmVkLWNhcHMnO1xuXG5cbmNvbnN0IEFQUElVTV9TSU1fUFJFRklYID0gJ2FwcGl1bVRlc3QnO1xuY29uc3QgU0VUVElOR1NfQ0FQUyA9IFtcbiAgJ2xvY2F0aW9uU2VydmljZXNFbmFibGVkJyxcbiAgJ2xvY2F0aW9uU2VydmljZXNBdXRob3JpemVkJyxcbl07XG5jb25zdCBTQUZBUklfU0VUVElOR1NfQ0FQUyA9IFtcbiAgJ3NhZmFyaUFsbG93UG9wdXBzJyxcbiAgJ3NhZmFyaUlnbm9yZUZyYXVkV2FybmluZycsXG4gICdzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQnLFxuXTtcblxuLyoqXG4gKiBDYXBhYmlsaXR5IHNldCBieSBhIHVzZXJcbiAqXG4gKiBAcHJvcGVydHkge3N0cmluZ30gZGV2aWNlTmFtZSAtIEEgbmFtZSBmb3IgdGhlIGRldmljZVxuICogQHByb3BlcnR5IHtzdHJpbmd9IHBsYXRmb3JtVmVyc2lvbiAtIFRoZSB2ZXJzaW9uIG9mIGlPUyB0byB1c2VcbiAqL1xuLyoqXG4gKiBDcmVhdGUgYSBuZXcgc2ltdWxhdG9yIHdpdGggYGFwcGl1bVRlc3QtYCBwcmVmaXggYW5kIHJldHVybiB0aGUgb2JqZWN0LlxuICpcbiAqIEBwYXJhbSB7b2JqZWN0fSBTaW1DcmVhdGlvbkNhcHMgLSBDYXBhYmlsaXR5IHNldCBieSBhIHVzZXIuIFRoZSBvcHRpb25zIGF2YWlsYWJsZSBhcmU6XG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGxhdGZvcm0gW2lPU10gLSBQbGF0Zm9ybSBuYW1lIGluIG9yZGVyIHRvIHNwZWNpZnkgcnVudGltZSBzdWNoIGFzICdpT1MnLCAndHZPUycsICd3YXRjaE9TJ1xuICogQHJldHVybnMge29iamVjdH0gU2ltdWxhdG9yIG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhlIHVkaWQgcGFzc2VkIGluLlxuICovXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVTaW0gKGNhcHMsIHBsYXRmb3JtID0gUExBVEZPUk1fTkFNRV9JT1MpIHtcbiAgY29uc3QgZGV2aWNlc1NldFBhdGggPSBjYXBzLnNpbXVsYXRvckRldmljZXNTZXRQYXRoO1xuICBjb25zdCB1ZGlkID0gYXdhaXQgbmV3IFNpbWN0bCh7ZGV2aWNlc1NldFBhdGh9KS5jcmVhdGVEZXZpY2UoXG4gICAgYCR7QVBQSVVNX1NJTV9QUkVGSVh9LSR7dXRpbC51dWlkVjQoKS50b1VwcGVyQ2FzZSgpfS0ke2NhcHMuZGV2aWNlTmFtZX1gLFxuICAgIGNhcHMuZGV2aWNlTmFtZSxcbiAgICBjYXBzLnBsYXRmb3JtVmVyc2lvbixcbiAgICB7cGxhdGZvcm19LFxuICApO1xuICByZXR1cm4gYXdhaXQgZ2V0U2ltdWxhdG9yKHVkaWQsIHtcbiAgICBwbGF0Zm9ybSxcbiAgICBjaGVja0V4aXN0ZW5jZTogZmFsc2UsXG4gICAgZGV2aWNlc1NldFBhdGgsXG4gIH0pO1xufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFNpbXVsYXRvckxvb2t1cE9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7IXN0cmluZ30gZGV2aWNlTmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBkZXZpY2UgdG8gbG9va3VwXG4gKiBAcHJvcGVydHkgeyFzdHJpbmd9IHBsYXRmb3JtVmVyc2lvbiAtIFRoZSBwbGF0Zm9ybSB2ZXJzaW9uIHN0cmluZ1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSBzaW11bGF0b3JEZXZpY2VzU2V0UGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIHNpbXVsYXRvciBkZXZpY2VzIHNldFxuICovXG5cbi8qKlxuICogR2V0IGEgc2ltdWxhdG9yIHdoaWNoIGlzIGFscmVhZHkgcnVubmluZy5cbiAqXG4gKiBAcGFyYW0gez9TaW11bGF0b3JMb29rdXBPcHRpb25zfSBvcHRzXG4gKiBAcmV0dXJucyB7P1NpbXVsYXRvcn0gVGhlIG1hdGNoZWQgU2ltdWxhdG9yIGluc3RhbmNlIG9yIGBudWxsYCBpZiBubyBtYXRjaGluZyAgZGV2aWNlIGlzIGZvdW5kLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRFeGlzdGluZ1NpbSAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBwbGF0Zm9ybVZlcnNpb24sXG4gICAgZGV2aWNlTmFtZSxcbiAgICBzaW11bGF0b3JEZXZpY2VzU2V0UGF0aDogZGV2aWNlc1NldFBhdGgsXG4gIH0gPSBvcHRzO1xuXG4gIGxldCBhcHBpdW1UZXN0RGV2aWNlO1xuICBjb25zdCBzaW1jdGwgPSBuZXcgU2ltY3RsKHtkZXZpY2VzU2V0UGF0aH0pO1xuICBmb3IgKGNvbnN0IGRldmljZSBvZiBfLnZhbHVlcyhhd2FpdCBzaW1jdGwuZ2V0RGV2aWNlcyhwbGF0Zm9ybVZlcnNpb24pKSkge1xuICAgIGlmIChkZXZpY2UubmFtZSA9PT0gZGV2aWNlTmFtZSkge1xuICAgICAgcmV0dXJuIGF3YWl0IGdldFNpbXVsYXRvcihkZXZpY2UudWRpZCwge1xuICAgICAgICBwbGF0Zm9ybTogZGV2aWNlLnBsYXRmb3JtLFxuICAgICAgICBjaGVja0V4aXN0ZW5jZTogZmFsc2UsXG4gICAgICAgIGRldmljZXNTZXRQYXRoLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKGRldmljZS5uYW1lLnN0YXJ0c1dpdGgoQVBQSVVNX1NJTV9QUkVGSVgpICYmIGRldmljZS5uYW1lLmVuZHNXaXRoKGRldmljZU5hbWUpKSB7XG4gICAgICBhcHBpdW1UZXN0RGV2aWNlID0gZGV2aWNlO1xuICAgICAgLy8gY2hvb3NlIHRoZSBmaXJzdCBib290ZWQgc2ltdWxhdG9yXG4gICAgICBpZiAoZGV2aWNlLnN0YXRlID09PSAnQm9vdGVkJykge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpZiAoYXBwaXVtVGVzdERldmljZSkge1xuICAgIGxvZy53YXJuKGBVbmFibGUgdG8gZmluZCBkZXZpY2UgJyR7ZGV2aWNlTmFtZX0nLiBgICtcbiAgICAgIGBGb3VuZCAnJHthcHBpdW1UZXN0RGV2aWNlLm5hbWV9JyAodWRpZDogJyR7YXBwaXVtVGVzdERldmljZS51ZGlkfScpIGluc3RlYWRgKTtcbiAgICByZXR1cm4gYXdhaXQgZ2V0U2ltdWxhdG9yKGFwcGl1bVRlc3REZXZpY2UudWRpZCwge1xuICAgICAgcGxhdGZvcm06IGFwcGl1bVRlc3REZXZpY2UucGxhdGZvcm0sXG4gICAgICBjaGVja0V4aXN0ZW5jZTogZmFsc2UsXG4gICAgICBkZXZpY2VzU2V0UGF0aCxcbiAgICB9KTtcbiAgfVxuICByZXR1cm4gbnVsbDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2h1dGRvd25TaW11bGF0b3IgKGRldmljZSkge1xuICAvLyBzdG9wIFhDVGVzdCBwcm9jZXNzZXMgaWYgcnVubmluZyB0byBhdm9pZCB1bmV4cGVjdGVkIHNpZGUgZWZmZWN0c1xuICBhd2FpdCByZXNldFRlc3RQcm9jZXNzZXMoZGV2aWNlLnVkaWQsIHRydWUpO1xuICBhd2FpdCBkZXZpY2Uuc2h1dGRvd24oKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcnVuU2ltdWxhdG9yUmVzZXQgKGRldmljZSwgb3B0cykge1xuICBpZiAob3B0cy5ub1Jlc2V0ICYmICFvcHRzLmZ1bGxSZXNldCkge1xuICAgIC8vIG5vUmVzZXQgPT09IHRydWUgJiYgZnVsbFJlc2V0ID09PSBmYWxzZVxuICAgIGxvZy5kZWJ1ZygnUmVzZXQ6IG5vUmVzZXQgaXMgb24uIExlYXZpbmcgc2ltdWxhdG9yIGFzIGlzJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKCFkZXZpY2UpIHtcbiAgICBsb2cuZGVidWcoJ1Jlc2V0OiBubyBkZXZpY2UgYXZhaWxhYmxlLiBTa2lwcGluZycpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmIChvcHRzLmZ1bGxSZXNldCkge1xuICAgIGxvZy5kZWJ1ZygnUmVzZXQ6IGZ1bGxSZXNldCBpcyBvbi4gQ2xlYW5pbmcgc2ltdWxhdG9yJyk7XG4gICAgYXdhaXQgc2h1dGRvd25TaW11bGF0b3IoZGV2aWNlKTtcbiAgICBsZXQgaXNLZXljaGFpbnNCYWNrdXBTdWNjZXNzZnVsID0gZmFsc2U7XG4gICAgaWYgKG9wdHMua2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIHx8IG9wdHMua2VlcEtleUNoYWlucykge1xuICAgICAgaXNLZXljaGFpbnNCYWNrdXBTdWNjZXNzZnVsID0gYXdhaXQgZGV2aWNlLmJhY2t1cEtleWNoYWlucygpO1xuICAgIH1cbiAgICBhd2FpdCBkZXZpY2UuY2xlYW4oKTtcbiAgICBpZiAoaXNLZXljaGFpbnNCYWNrdXBTdWNjZXNzZnVsKSB7XG4gICAgICBhd2FpdCBkZXZpY2UucmVzdG9yZUtleWNoYWlucyhvcHRzLmtleWNoYWluc0V4Y2x1ZGVQYXR0ZXJucyB8fCBbXSk7XG4gICAgICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IHJlc3RvcmVkIGtleWNoYWlucyBhZnRlciBmdWxsIHJlc2V0YCk7XG4gICAgfSBlbHNlIGlmIChvcHRzLmtleWNoYWluc0V4Y2x1ZGVQYXR0ZXJucyB8fCBvcHRzLmtlZXBLZXlDaGFpbnMpIHtcbiAgICAgIGxvZy53YXJuKCdDYW5ub3QgcmVzdG9yZSBrZXljaGFpbnMgYWZ0ZXIgZnVsbCByZXNldCwgYmVjYXVzZSAnICtcbiAgICAgICAgICAgICAgICd0aGUgYmFja3VwIG9wZXJhdGlvbiBkaWQgbm90IHN1Y2NlZWQnKTtcbiAgICB9XG4gIH0gZWxzZSBpZiAob3B0cy5idW5kbGVJZCkge1xuICAgIC8vIGZhc3RSZXNldCBvciBub1Jlc2V0XG5cbiAgICAvLyBUZXJtaW5hdGUgdGhlIGFwcCB1bmRlciB0ZXN0IGlmIGl0IGlzIHN0aWxsIHJ1bm5pbmcgb24gU2ltdWxhdG9yXG4gICAgLy8gVGVybWluYXRpb24gaXMgbm90IG5lZWRlZCBpZiBTaW11bGF0b3IgaXMgbm90IHJ1bm5pbmdcbiAgICBpZiAoYXdhaXQgZGV2aWNlLmlzUnVubmluZygpKSB7XG4gICAgICBpZiAob3B0cy5lbmZvcmNlU2ltdWxhdG9yU2h1dGRvd24pIHtcbiAgICAgICAgYXdhaXQgc2h1dGRvd25TaW11bGF0b3IoZGV2aWNlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgZGV2aWNlLnNpbWN0bC50ZXJtaW5hdGVBcHAob3B0cy5idW5kbGVJZCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGxvZy53YXJuKGBSZXNldDogZmFpbGVkIHRvIHRlcm1pbmF0ZSBTaW11bGF0b3IgYXBwbGljYXRpb24gd2l0aCBpZCBcIiR7b3B0cy5idW5kbGVJZH1cImApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChvcHRzLmFwcCkge1xuICAgICAgbG9nLmluZm8oJ05vdCBzY3J1YmJpbmcgdGhpcmQgcGFydHkgYXBwIGluIGFudGljaXBhdGlvbiBvZiB1bmluc3RhbGwnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgaXNTYWZhcmkgPSAob3B0cy5icm93c2VyTmFtZSB8fCAnJykudG9Mb3dlckNhc2UoKSA9PT0gJ3NhZmFyaSc7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChpc1NhZmFyaSkge1xuICAgICAgICBhd2FpdCBkZXZpY2UuY2xlYW5TYWZhcmkoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGlPUyA4KyBkb2VzIG5vdCBuZWVkIGJhc2VuYW1lXG4gICAgICAgIGF3YWl0IGRldmljZS5zY3J1YkN1c3RvbUFwcCgnJywgb3B0cy5idW5kbGVJZCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihlcnIubWVzc2FnZSk7XG4gICAgICBsb2cud2FybihgUmVzZXQ6IGNvdWxkIG5vdCBzY3J1YiAke2lzU2FmYXJpID8gJ1NhZmFyaSBicm93c2VyJyA6ICdhcHBsaWNhdGlvbiB3aXRoIGlkIFwiJyArIG9wdHMuYnVuZGxlSWQgKyAnXCInfS4gTGVhdmluZyBhcyBpcy5gKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBJbnN0YWxsT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IG5vUmVzZXQgW2ZhbHNlXSBXaGV0aGVyIHRvIGRpc2FibGUgcmVzZXRcbiAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IG5ld1NpbXVsYXRvciBbZmFsc2VdIFdoZXRoZXIgdGhlIHNpbXVsYXRvciBpcyBicmFuZCBuZXdcbiAqL1xuXG4vKipcbiAqIEBwYXJhbSB7b2JqZWN0fSBkZXZpY2UgVGhlIHNpbXVsYXRvciBkZXZpY2Ugb2JqZWN0XG4gKiBAcGFyYW0gez9zdHJpbmd9IGFwcCBUaGUgYXBwIHRvIHRoZSBwYXRoXG4gKiBAcGFyYW0ge3N0cmluZ30gYnVuZGxlSWQgVGhlIGJ1bmRsZSBpZCB0byBlbnN1cmUgaXQgaXMgYWxyZWFkeSBpbnN0YWxsZWQgYW5kIHVuaW5zdGFsbCBpdFxuICogQHBhcmFtIHs/SW5zdGFsbE9wdGlvbnN9IG9wdHNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbFRvU2ltdWxhdG9yIChkZXZpY2UsIGFwcCwgYnVuZGxlSWQsIG9wdHMgPSB7fSkge1xuICBpZiAoIWFwcCkge1xuICAgIGxvZy5kZWJ1ZygnTm8gYXBwIHBhdGggaXMgZ2l2ZW4uIE5vdGhpbmcgdG8gaW5zdGFsbC4nKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCB7XG4gICAgbm9SZXNldCA9IHRydWUsXG4gICAgbmV3U2ltdWxhdG9yID0gZmFsc2UsXG4gIH0gPSBvcHRzO1xuXG4gIGlmICghbmV3U2ltdWxhdG9yICYmIGJ1bmRsZUlkICYmIGF3YWl0IGRldmljZS5pc0FwcEluc3RhbGxlZChidW5kbGVJZCkpIHtcbiAgICBpZiAobm9SZXNldCkge1xuICAgICAgbG9nLmRlYnVnKGBBcHAgJyR7YnVuZGxlSWR9JyBpcyBhbHJlYWR5IGluc3RhbGxlZC4gTm8gbmVlZCB0byByZWluc3RhbGwuYCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgUmVzZXQgcmVxdWVzdGVkLiBSZW1vdmluZyBhcHAgd2l0aCBpZCAnJHtidW5kbGVJZH0nIGZyb20gdGhlIGRldmljZWApO1xuICAgIGF3YWl0IGRldmljZS5yZW1vdmVBcHAoYnVuZGxlSWQpO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBJbnN0YWxsaW5nICcke2FwcH0nIG9uIFNpbXVsYXRvciB3aXRoIFVVSUQgJyR7ZGV2aWNlLnVkaWR9Jy4uLmApO1xuICB0cnkge1xuICAgIGF3YWl0IGRldmljZS5pbnN0YWxsQXBwKGFwcCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyBpdCBzb21ldGltZXMgZmFpbHMgb24gWGNvZGUgMTAgYmVjYXVzZSBvZiBhIHJhY2UgY29uZGl0aW9uXG4gICAgbG9nLmluZm8oYEdvdCBhbiBlcnJvciBvbiAnJHthcHB9JyBpbnN0YWxsOiAke2UubWVzc2FnZX1gKTtcbiAgICBsb2cuaW5mbygnUmV0cnlpbmcgYXBwbGljYXRpb24gaW5zdGFsbCcpO1xuICAgIGF3YWl0IGRldmljZS5pbnN0YWxsQXBwKGFwcCk7XG4gIH1cbiAgbG9nLmRlYnVnKCdUaGUgYXBwIGhhcyBiZWVuIGluc3RhbGxlZCBzdWNjZXNzZnVsbHkuJyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNodXRkb3duT3RoZXJTaW11bGF0b3JzIChjdXJyZW50RGV2aWNlKSB7XG4gIGNvbnN0IHNpbWN0bCA9IG5ldyBTaW1jdGwoe1xuICAgIGRldmljZXNTZXRQYXRoOiBjdXJyZW50RGV2aWNlLmRldmljZXNTZXRQYXRoXG4gIH0pO1xuICBjb25zdCBhbGxEZXZpY2VzID0gXy5mbGF0TWFwKF8udmFsdWVzKGF3YWl0IHNpbWN0bC5nZXREZXZpY2VzKCkpKTtcbiAgY29uc3Qgb3RoZXJCb290ZWREZXZpY2VzID0gYWxsRGV2aWNlcy5maWx0ZXIoKGRldmljZSkgPT4gZGV2aWNlLnVkaWQgIT09IGN1cnJlbnREZXZpY2UudWRpZCAmJiBkZXZpY2Uuc3RhdGUgPT09ICdCb290ZWQnKTtcbiAgaWYgKF8uaXNFbXB0eShvdGhlckJvb3RlZERldmljZXMpKSB7XG4gICAgbG9nLmluZm8oJ05vIG90aGVyIHJ1bm5pbmcgc2ltdWxhdG9ycyBoYXZlIGJlZW4gZGV0ZWN0ZWQnKTtcbiAgICByZXR1cm47XG4gIH1cbiAgbG9nLmluZm8oYERldGVjdGVkICR7b3RoZXJCb290ZWREZXZpY2VzLmxlbmd0aH0gb3RoZXIgcnVubmluZyAke3V0aWwucGx1cmFsaXplKCdTaW11bGF0b3InLCBvdGhlckJvb3RlZERldmljZXMubGVuZ3RoKX0uYCArXG4gICAgYFNodXR0aW5nIHRoZW0gZG93bi4uLmApO1xuICBmb3IgKGNvbnN0IHt1ZGlkfSBvZiBvdGhlckJvb3RlZERldmljZXMpIHtcbiAgICAvLyBJdCBpcyBuZWNlc3NhcnkgdG8gc3RvcCB0aGUgY29ycmVzcG9uZGluZyB4Y29kZWJ1aWxkIHByb2Nlc3MgYmVmb3JlIGtpbGxpbmdcbiAgICAvLyB0aGUgc2ltdWxhdG9yLCBvdGhlcndpc2UgaXQgd2lsbCBiZSBhdXRvbWF0aWNhbGx5IHJlc3RhcnRlZFxuICAgIGF3YWl0IHJlc2V0VGVzdFByb2Nlc3Nlcyh1ZGlkLCB0cnVlKTtcbiAgICBzaW1jdGwudWRpZCA9IHVkaWQ7XG4gICAgYXdhaXQgc2ltY3RsLnNodXRkb3duRGV2aWNlKCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gbGF1bmNoQW5kUXVpdFNpbXVsYXRvciAoc2ltLCBvcHRzID0ge30pIHtcbiAgbG9nLmRlYnVnKCdObyBzaW11bGF0b3IgZGlyZWN0b3JpZXMgZm91bmQuJyk7XG4gIGNvbnN0IHsgc2FmYXJpLCB0aW1lb3V0IH0gPSBvcHRzO1xuICByZXR1cm4gdGltZW91dFxuICAgID8gYXdhaXQgc2ltLmxhdW5jaEFuZFF1aXQoc2FmYXJpLCB0aW1lb3V0KVxuICAgIDogYXdhaXQgc2ltLmxhdW5jaEFuZFF1aXQoc2FmYXJpKTtcbn1cblxuZnVuY3Rpb24gY2hlY2tQcmVmZXJlbmNlcyAoc2V0dGluZ3MsIG9wdHMgPSB7fSkge1xuICBmb3IgKGxldCBzZXR0aW5nIG9mIHNldHRpbmdzKSB7XG4gICAgaWYgKF8uaGFzKG9wdHMsIHNldHRpbmcpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRMb2NhbGVBbmRQcmVmZXJlbmNlcyAoc2ltLCBvcHRzLCBzYWZhcmkgPSBmYWxzZSwgc2h1dGRvd25GbiA9IF8ubm9vcCkge1xuICBjb25zdCBsb2NhbENvbmZpZyA9IGF3YWl0IHNldExvY2FsZShzaW0sIG9wdHMsIHt9LCBzYWZhcmkpO1xuICBjb25zdCBwcmVmc1VwZGF0ZWQgPSBhd2FpdCBzZXRQcmVmZXJlbmNlcyhzaW0sIG9wdHMsIHNhZmFyaSk7XG4gIGlmIChsb2NhbENvbmZpZy5fdXBkYXRlZCB8fCBwcmVmc1VwZGF0ZWQpIHtcbiAgICBsb2cuZGVidWcoJ1VwZGF0ZWQgc2V0dGluZ3MuIFJlYm9vdGluZyB0aGUgc2ltdWxhdG9yIGlmIGl0IGlzIGFscmVhZHkgb3BlbicpO1xuICAgIGF3YWl0IHNodXRkb3duRm4oc2ltKTtcbiAgfSBlbHNlIHtcbiAgICBsb2cuZGVidWcoJ1NldHRpbmcgZGlkIG5vdCBuZWVkIHRvIGJlIHVwZGF0ZWQnKTtcbiAgfVxuICBkZWxldGUgbG9jYWxDb25maWcuX3VwZGF0ZWQ7XG4gIHJldHVybiBsb2NhbENvbmZpZztcbn1cblxuLy8gcGFzcyBpbiB0aGUgc2ltdWxhdG9yIHNvIHRoYXQgb3RoZXIgc3lzdGVtcyB0aGF0IHVzZSB0aGUgZnVuY3Rpb24gY2FuIHN1cHBseVxuLy8gd2hhdGV2ZXIgdGhleSBoYXZlXG5hc3luYyBmdW5jdGlvbiBzZXRMb2NhbGUgKHNpbSwgb3B0cywgbG9jYWxlQ29uZmlnID0ge30sIHNhZmFyaSA9IGZhbHNlKSB7XG4gIGlmICghb3B0cy5sYW5ndWFnZSAmJiAhb3B0cy5sb2NhbGUgJiYgIW9wdHMuY2FsZW5kYXJGb3JtYXQpIHtcbiAgICBsb2cuZGVidWcoJ05vIHJlYXNvbiB0byBzZXQgbG9jYWxlJyk7XG4gICAgcmV0dXJuIHtcbiAgICAgIF91cGRhdGVkOiBmYWxzZSxcbiAgICB9O1xuICB9XG5cbiAgLy8gd2UgbmVlZCB0aGUgc2ltdWxhdG9yIHRvIGhhdmUgaXRzIGRpcmVjdG9yaWVzIGluIHBsYWNlXG4gIGlmIChhd2FpdCBzaW0uaXNGcmVzaCgpKSB7XG4gICAgYXdhaXQgbGF1bmNoQW5kUXVpdFNpbXVsYXRvcihzaW0sIHtcbiAgICAgIHNhZmFyaSxcbiAgICAgIHRpbWVvdXQ6IG9wdHMuc2ltdWxhdG9yU3RhcnR1cFRpbWVvdXQsXG4gICAgfSk7XG4gIH1cblxuICBsb2cuZGVidWcoJ1NldHRpbmcgbG9jYWxlIGluZm9ybWF0aW9uJyk7XG4gIGxvY2FsZUNvbmZpZyA9IHtcbiAgICBsYW5ndWFnZTogb3B0cy5sYW5ndWFnZSB8fCBsb2NhbGVDb25maWcubGFuZ3VhZ2UsXG4gICAgbG9jYWxlOiBvcHRzLmxvY2FsZSB8fCBsb2NhbGVDb25maWcubG9jYWxlLFxuICAgIGNhbGVuZGFyRm9ybWF0OiBvcHRzLmNhbGVuZGFyRm9ybWF0IHx8IGxvY2FsZUNvbmZpZy5jYWxlbmRhckZvcm1hdCxcbiAgICBfdXBkYXRlZDogZmFsc2UsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBsZXQgdXBkYXRlZCA9IGF3YWl0IHNpbS51cGRhdGVMb2NhbGUob3B0cy5sYW5ndWFnZSwgb3B0cy5sb2NhbGUsIG9wdHMuY2FsZW5kYXJGb3JtYXQpO1xuICAgIGlmICh1cGRhdGVkKSB7XG4gICAgICBsb2NhbGVDb25maWcuX3VwZGF0ZWQgPSB0cnVlO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBBcHBpdW0gd2FzIHVuYWJsZSB0byBzZXQgbG9jYWxlIGluZm86ICR7ZX1gKTtcbiAgfVxuXG4gIHJldHVybiBsb2NhbGVDb25maWc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFByZWZlcmVuY2VzIChzaW0sIG9wdHMsIHNhZmFyaSA9IGZhbHNlKSB7XG4gIGxldCBuZWVkVG9TZXRQcmVmcyA9IGNoZWNrUHJlZmVyZW5jZXMoU0VUVElOR1NfQ0FQUywgb3B0cyk7XG4gIGxldCBuZWVkVG9TZXRTYWZhcmlQcmVmcyA9IGNoZWNrUHJlZmVyZW5jZXMoU0FGQVJJX1NFVFRJTkdTX0NBUFMsIG9wdHMpO1xuICBpZiAoIW5lZWRUb1NldFByZWZzICYmICFuZWVkVG9TZXRTYWZhcmlQcmVmcykge1xuICAgIGxvZy5kZWJ1ZygnTm8gaU9TIC8gYXBwIHByZWZlcmVuY2VzIHRvIHNldCcpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZygnU2V0dGluZyBpT1MgYW5kIGFwcCBwcmVmZXJlbmNlcycpO1xuXG4gIGlmIChhd2FpdCBzaW0uaXNGcmVzaCgpKSB7XG4gICAgYXdhaXQgbGF1bmNoQW5kUXVpdFNpbXVsYXRvcihzaW0sIHtcbiAgICAgIHNhZmFyaSxcbiAgICAgIHRpbWVvdXQ6IG9wdHMuc2ltdWxhdG9yU3RhcnR1cFRpbWVvdXQsXG4gICAgfSk7XG4gIH1cblxuICBsZXQgdXBkYXRlZCA9IGZhbHNlO1xuICB0cnkge1xuICAgIGlmIChuZWVkVG9TZXRQcmVmcykge1xuICAgICAgdXBkYXRlZCA9IGF3YWl0IHNldExvY1NlcnZpY2VzUHJlZnMoc2ltLCBvcHRzKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZXJyb3IoJ0Vycm9yIHNldHRpbmcgbG9jYXRpb24gc2VydmljZXMgcHJlZmVyZW5jZXMsIHByZWZzIHdpbGwgbm90IHdvcmsnKTtcbiAgICBsb2cuZXJyb3IoZSk7XG4gIH1cblxuICB0cnkge1xuICAgIGlmIChuZWVkVG9TZXRTYWZhcmlQcmVmcykge1xuICAgICAgdXBkYXRlZCA9IGF3YWl0IHNldFNhZmFyaVByZWZzKHNpbSwgb3B0cykgfHwgdXBkYXRlZDtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZXJyb3IoJ0Vycm9yIHNldHRpbmcgc2FmYXJpIHByZWZlcmVuY2VzLCBwcmVmcyB3aWxsIG5vdCB3b3JrJyk7XG4gICAgbG9nLmVycm9yKGUpO1xuICB9XG5cbiAgcmV0dXJuIHVwZGF0ZWQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldExvY1NlcnZpY2VzUHJlZnMgKHNpbSwgb3B0cyA9IHt9KSB7XG4gIGxldCBsb2NTZXJ2ID0gXy5maW5kKFtvcHRzLmxvY2F0aW9uU2VydmljZXNFbmFibGVkLCBvcHRzLmxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkXSwgKGMpID0+ICFfLmlzVW5kZWZpbmVkKGMpKTtcbiAgaWYgKCFfLmlzVW5kZWZpbmVkKGxvY1NlcnYpKSB7XG4gICAgbG9jU2VydiA9IGxvY1NlcnYgPyAxIDogMDtcbiAgICBsb2cuZGVidWcoYFNldHRpbmcgbG9jYXRpb24gc2VydmljZXMgdG8gJHtsb2NTZXJ2fWApO1xuICAgIGF3YWl0IHNpbS51cGRhdGVTZXR0aW5ncygnbG9jYXRpb25TZXJ2aWNlcycsIHtcbiAgICAgIExvY2F0aW9uU2VydmljZXNFbmFibGVkOiBsb2NTZXJ2LFxuICAgICAgJ0xvY2F0aW9uU2VydmljZXNFbmFibGVkSW43LjAnOiBsb2NTZXJ2LFxuICAgICAgJ0xvY2F0aW9uU2VydmljZXNFbmFibGVkSW44LjAnOiBsb2NTZXJ2XG4gICAgfSk7XG4gIH1cbiAgaWYgKCFfLmlzVW5kZWZpbmVkKG9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQpKSB7XG4gICAgaWYgKCFvcHRzLmJ1bmRsZUlkKSB7XG4gICAgICBsZXQgbXNnID0gXCJDYW4ndCBzZXQgbG9jYXRpb24gc2VydmljZXMgZm9yIGFwcCB3aXRob3V0IGJ1bmRsZSBJRFwiO1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICB9XG4gICAgbGV0IGxvY0F1dGggPSAhIW9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQ7XG4gICAgaWYgKGxvY0F1dGgpIHtcbiAgICAgIGxvZy5kZWJ1ZygnQXV0aG9yaXppbmcgbG9jYXRpb24gc2VydmljZXMgZm9yIGFwcCcpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoJ0RlLWF1dGhvcml6aW5nIGxvY2F0aW9uIHNlcnZpY2VzIGZvciBhcHAnKTtcbiAgICB9XG4gICAgYXdhaXQgc2ltLnVwZGF0ZUxvY2F0aW9uU2V0dGluZ3Mob3B0cy5idW5kbGVJZCwgbG9jQXV0aCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0U2FmYXJpUHJlZnMgKHNpbSwgb3B0cyA9IHt9KSB7XG4gIGxldCBzYWZhcmlTZXR0aW5ncyA9IHt9O1xuXG4gIGlmIChfLmhhcyhvcHRzLCAnc2FmYXJpQWxsb3dQb3B1cHMnKSkge1xuICAgIGNvbnN0IHZhbCA9ICEhb3B0cy5zYWZhcmlBbGxvd1BvcHVwcztcbiAgICBsb2cuZGVidWcoYFNldHRpbmcgamF2YXNjcmlwdCB3aW5kb3cgb3BlbmluZyB0byAnJHt2YWx9J2ApO1xuICAgIHNhZmFyaVNldHRpbmdzLldlYktpdEphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkgPSB2YWw7XG4gICAgc2FmYXJpU2V0dGluZ3MuSmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSA9IHZhbDtcbiAgfVxuICBpZiAoXy5oYXMob3B0cywgJ3NhZmFyaUlnbm9yZUZyYXVkV2FybmluZycpKSB7XG4gICAgY29uc3QgdmFsID0gIW9wdHMuc2FmYXJpSWdub3JlRnJhdWRXYXJuaW5nO1xuICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBmcmF1ZHVsZW50IHdlYnNpdGUgd2FybmluZyB0byAnJHt2YWx9J2ApO1xuICAgIHNhZmFyaVNldHRpbmdzLldhcm5BYm91dEZyYXVkdWxlbnRXZWJzaXRlcyA9IHZhbDtcbiAgfVxuICBpZiAoXy5oYXMob3B0cywgJ3NhZmFyaU9wZW5MaW5rc0luQmFja2dyb3VuZCcpKSB7XG4gICAgY29uc3QgdmFsID0gb3B0cy5zYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQgPyAxIDogMDtcbiAgICBsb2cuZGVidWcoYFNldHRpbmcgb3BlbmluZyBsaW5rcyBpbiBiYWNrZ3JvdW5kIHRvICckeyEhdmFsfSdgKTtcbiAgICBzYWZhcmlTZXR0aW5ncy5PcGVuTGlua3NJbkJhY2tncm91bmQgPSB2YWw7XG4gIH1cbiAgcmV0dXJuIChfLnNpemUoc2FmYXJpU2V0dGluZ3MpID4gMClcbiAgICA/IGF3YWl0IHNpbS51cGRhdGVTYWZhcmlTZXR0aW5ncyhzYWZhcmlTZXR0aW5ncylcbiAgICA6IGZhbHNlO1xufVxuXG5leHBvcnQge1xuICBjcmVhdGVTaW0sIGdldEV4aXN0aW5nU2ltLCBydW5TaW11bGF0b3JSZXNldCwgaW5zdGFsbFRvU2ltdWxhdG9yLFxuICBzaHV0ZG93blNpbXVsYXRvciwgc2h1dGRvd25PdGhlclNpbXVsYXRvcnMsXG4gIHNldExvY2FsZSwgc2V0UHJlZmVyZW5jZXMsIHNldExvY2FsZUFuZFByZWZlcmVuY2VzLFxufTtcbiJdLCJmaWxlIjoibGliL3NpbXVsYXRvci1tYW5hZ2VtZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
