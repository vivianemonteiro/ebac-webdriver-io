"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.pullFile = pullFile;
exports.pullFolder = pullFolder;
exports.pushFile = pushFile;
exports.pushFolder = pushFolder;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("./logger"));

const IO_TIMEOUT_MS = 4 * 60 * 1000;
const MAX_IO_CHUNK_SIZE = 8;

async function pullFile(afcService, remotePath) {
  const stream = await afcService.createReadStream(remotePath, {
    autoDestroy: true
  });
  const pullPromise = new _bluebird.default((resolve, reject) => {
    stream.on('close', resolve);
    stream.on('error', reject);
  }).timeout(IO_TIMEOUT_MS);
  const buffers = [];
  stream.on('data', data => buffers.push(data));
  await pullPromise;
  return Buffer.concat(buffers);
}

async function pullFolder(afcService, remoteRootPath) {
  const tmpFolder = await _appiumSupport.tempDir.openDir();

  try {
    const pullPromises = [];
    await afcService.walkDir(remoteRootPath, true, async (itemPath, isDir) => {
      const pathOnServer = _path.default.join(tmpFolder, itemPath);

      if (isDir) {
        await (0, _appiumSupport.mkdirp)(pathOnServer);
        return;
      }

      const readStream = await afcService.createReadStream(itemPath, {
        autoDestroy: true
      });

      const writeStream = _appiumSupport.fs.createWriteStream(pathOnServer, {
        autoClose: true
      });

      pullPromises.push(new _bluebird.default((resolve, reject) => {
        writeStream.on('close', resolve);

        const onStreamingError = e => {
          readStream.unpipe(writeStream);
          reject(e);
        };

        writeStream.on('error', onStreamingError);
        readStream.on('error', onStreamingError);
      }).timeout(IO_TIMEOUT_MS));
      readStream.pipe(writeStream);

      if (pullPromises.length >= MAX_IO_CHUNK_SIZE) {
        await _bluebird.default.any(pullPromises);
      }

      _lodash.default.remove(pullPromises, p => p.isFulfilled());
    });
    await _bluebird.default.all(pullPromises);
    return await _appiumSupport.zip.toInMemoryZip(tmpFolder, {
      encodeToBase64: true
    });
  } finally {
    await _appiumSupport.fs.rimraf(tmpFolder);
  }
}

async function remoteMkdirp(afcService, remoteRoot) {
  if (remoteRoot === '.' || remoteRoot === '/') {
    return;
  }

  try {
    await afcService.listDirectory(remoteRoot);
    return;
  } catch (e) {
    await remoteMkdirp(afcService, _path.default.dirname(remoteRoot));
  }

  await afcService.createDirectory(remoteRoot);
}

async function pushFile(afcService, remotePath, base64Data) {
  await remoteMkdirp(afcService, _path.default.dirname(remotePath));
  const stream = await afcService.createWriteStream(remotePath, {
    autoDestroy: true
  });
  let pushError = null;
  const pushPromise = new _bluebird.default((resolve, reject) => {
    stream.on('error', e => {
      pushError = e;
    });
    stream.on('close', () => {
      if (pushError) {
        reject(pushError);
      } else {
        resolve();
      }
    });
  }).timeout(IO_TIMEOUT_MS);
  stream.write(Buffer.from(base64Data, 'base64'));
  stream.end();
  await pushPromise;
}

async function pushFolder(afcService, srcRootPath, dstRootPath, opts = {}) {
  const {
    timeoutMs = IO_TIMEOUT_MS,
    enableParallelPush = false
  } = opts;
  const timer = new _appiumSupport.timing.Timer().start();
  const itemsToPush = await _appiumSupport.fs.glob('**', {
    cwd: srcRootPath,
    nosort: true,
    mark: true
  });

  _logger.default.debug(`Successfully scanned the tree structure of '${srcRootPath}'`);

  const [foldersToPush, filesToPush] = itemsToPush.reduce((acc, x) => {
    acc[_lodash.default.endsWith(x, _path.default.sep) ? 0 : 1].push(x);
    return acc;
  }, [[], []]);

  _logger.default.debug(`Got ${_appiumSupport.util.pluralize('folder', foldersToPush.length, true)} and ` + `${_appiumSupport.util.pluralize('file', filesToPush.length, true)} to push`);

  try {
    await afcService.deleteDirectory(dstRootPath);
  } catch (ign) {}

  await afcService.createDirectory(dstRootPath);
  const foldersToPushByHierarchy = foldersToPush.sort((a, b) => a.split(_path.default.sep).length - b.split(_path.default.sep).length);

  for (const relativeFolderPath of foldersToPushByHierarchy) {
    const absoluteFolderPath = _lodash.default.trimEnd(_path.default.join(dstRootPath, relativeFolderPath), _path.default.sep);

    if (absoluteFolderPath) {
      await afcService.createDirectory(absoluteFolderPath);
    }
  }

  _logger.default.debug(`Successfully created the remote folder structure ` + `(${_appiumSupport.util.pluralize('item', foldersToPush.length + 1, true)})`);

  const pushFile = async relativePath => {
    const absoluteSourcePath = _path.default.join(srcRootPath, relativePath);

    const readStream = _appiumSupport.fs.createReadStream(absoluteSourcePath, {
      autoClose: true
    });

    const absoluteDestinationPath = _path.default.join(dstRootPath, relativePath);

    const writeStream = await afcService.createWriteStream(absoluteDestinationPath, {
      autoDestroy: true
    });
    writeStream.on('finish', writeStream.destroy);
    let pushError = null;
    const filePushPromise = new _bluebird.default((resolve, reject) => {
      writeStream.on('close', () => {
        if (pushError) {
          reject(pushError);
        } else {
          resolve();
        }
      });

      const onStreamError = e => {
        readStream.unpipe(writeStream);

        _logger.default.debug(e);

        pushError = e;
      };

      writeStream.on('error', onStreamError);
      readStream.on('error', onStreamError);
    });
    readStream.pipe(writeStream);
    await filePushPromise.timeout(timeoutMs);
  };

  if (enableParallelPush) {
    _logger.default.debug(`Proceeding to parallel files push (max ${MAX_IO_CHUNK_SIZE} writers)`);

    const pushPromises = [];

    for (const relativeFilePath of _lodash.default.shuffle(filesToPush)) {
      pushPromises.push(_bluebird.default.resolve(pushFile(relativeFilePath)));

      if (pushPromises.length >= MAX_IO_CHUNK_SIZE) {
        await _bluebird.default.any(pushPromises);
      }

      _lodash.default.remove(pushPromises, p => p.isFulfilled());
    }

    if (!_lodash.default.isEmpty(pushPromises)) {
      await _bluebird.default.all(pushPromises);
    }
  } else {
    _logger.default.debug(`Proceeding to serial files push`);

    for (const relativeFilePath of filesToPush) {
      await pushFile(relativeFilePath);
    }
  }

  _logger.default.debug(`Successfully pushed ${_appiumSupport.util.pluralize('folder', foldersToPush.length, true)} ` + `and ${_appiumSupport.util.pluralize('file', filesToPush.length, true)} ` + `within ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pb3MtZnMtaGVscGVycy5qcyJdLCJuYW1lcyI6WyJJT19USU1FT1VUX01TIiwiTUFYX0lPX0NIVU5LX1NJWkUiLCJwdWxsRmlsZSIsImFmY1NlcnZpY2UiLCJyZW1vdGVQYXRoIiwic3RyZWFtIiwiY3JlYXRlUmVhZFN0cmVhbSIsImF1dG9EZXN0cm95IiwicHVsbFByb21pc2UiLCJCIiwicmVzb2x2ZSIsInJlamVjdCIsIm9uIiwidGltZW91dCIsImJ1ZmZlcnMiLCJkYXRhIiwicHVzaCIsIkJ1ZmZlciIsImNvbmNhdCIsInB1bGxGb2xkZXIiLCJyZW1vdGVSb290UGF0aCIsInRtcEZvbGRlciIsInRlbXBEaXIiLCJvcGVuRGlyIiwicHVsbFByb21pc2VzIiwid2Fsa0RpciIsIml0ZW1QYXRoIiwiaXNEaXIiLCJwYXRoT25TZXJ2ZXIiLCJwYXRoIiwiam9pbiIsInJlYWRTdHJlYW0iLCJ3cml0ZVN0cmVhbSIsImZzIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJhdXRvQ2xvc2UiLCJvblN0cmVhbWluZ0Vycm9yIiwiZSIsInVucGlwZSIsInBpcGUiLCJsZW5ndGgiLCJhbnkiLCJfIiwicmVtb3ZlIiwicCIsImlzRnVsZmlsbGVkIiwiYWxsIiwiemlwIiwidG9Jbk1lbW9yeVppcCIsImVuY29kZVRvQmFzZTY0IiwicmltcmFmIiwicmVtb3RlTWtkaXJwIiwicmVtb3RlUm9vdCIsImxpc3REaXJlY3RvcnkiLCJkaXJuYW1lIiwiY3JlYXRlRGlyZWN0b3J5IiwicHVzaEZpbGUiLCJiYXNlNjREYXRhIiwicHVzaEVycm9yIiwicHVzaFByb21pc2UiLCJ3cml0ZSIsImZyb20iLCJlbmQiLCJwdXNoRm9sZGVyIiwic3JjUm9vdFBhdGgiLCJkc3RSb290UGF0aCIsIm9wdHMiLCJ0aW1lb3V0TXMiLCJlbmFibGVQYXJhbGxlbFB1c2giLCJ0aW1lciIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJpdGVtc1RvUHVzaCIsImdsb2IiLCJjd2QiLCJub3NvcnQiLCJtYXJrIiwibG9nIiwiZGVidWciLCJmb2xkZXJzVG9QdXNoIiwiZmlsZXNUb1B1c2giLCJyZWR1Y2UiLCJhY2MiLCJ4IiwiZW5kc1dpdGgiLCJzZXAiLCJ1dGlsIiwicGx1cmFsaXplIiwiZGVsZXRlRGlyZWN0b3J5IiwiaWduIiwiZm9sZGVyc1RvUHVzaEJ5SGllcmFyY2h5Iiwic29ydCIsImEiLCJiIiwic3BsaXQiLCJyZWxhdGl2ZUZvbGRlclBhdGgiLCJhYnNvbHV0ZUZvbGRlclBhdGgiLCJ0cmltRW5kIiwicmVsYXRpdmVQYXRoIiwiYWJzb2x1dGVTb3VyY2VQYXRoIiwiYWJzb2x1dGVEZXN0aW5hdGlvblBhdGgiLCJkZXN0cm95IiwiZmlsZVB1c2hQcm9taXNlIiwib25TdHJlYW1FcnJvciIsInB1c2hQcm9taXNlcyIsInJlbGF0aXZlRmlsZVBhdGgiLCJzaHVmZmxlIiwiaXNFbXB0eSIsImdldER1cmF0aW9uIiwiYXNNaWxsaVNlY29uZHMiLCJ0b0ZpeGVkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGFBQWEsR0FBRyxJQUFJLEVBQUosR0FBUyxJQUEvQjtBQUdBLE1BQU1DLGlCQUFpQixHQUFHLENBQTFCOztBQVVBLGVBQWVDLFFBQWYsQ0FBeUJDLFVBQXpCLEVBQXFDQyxVQUFyQyxFQUFpRDtBQUMvQyxRQUFNQyxNQUFNLEdBQUcsTUFBTUYsVUFBVSxDQUFDRyxnQkFBWCxDQUE0QkYsVUFBNUIsRUFBd0M7QUFBRUcsSUFBQUEsV0FBVyxFQUFFO0FBQWYsR0FBeEMsQ0FBckI7QUFDQSxRQUFNQyxXQUFXLEdBQUcsSUFBSUMsaUJBQUosQ0FBTSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDN0NOLElBQUFBLE1BQU0sQ0FBQ08sRUFBUCxDQUFVLE9BQVYsRUFBbUJGLE9BQW5CO0FBQ0FMLElBQUFBLE1BQU0sQ0FBQ08sRUFBUCxDQUFVLE9BQVYsRUFBbUJELE1BQW5CO0FBQ0QsR0FIbUIsRUFHakJFLE9B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RDtBQUdEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyLCBta2RpcnAsIHppcCwgdXRpbCwgdGltaW5nIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcblxuY29uc3QgSU9fVElNRU9VVF9NUyA9IDQgKiA2MCAqIDEwMDA7XG4vLyBNb2JpbGUgZGV2aWNlcyB1c2UgTkFORCBtZW1vcnkgbW9kdWxlcyBmb3IgdGhlIHN0b3JhZ2UsXG4vLyBhbmQgdGhlIHBhcmFsbGVsaXNtIHRoZXJlIGlzIG5vdCBhcyBwZXJmb3JtYW50IGFzIG9uIHJlZ3VsYXIgU1NEc1xuY29uc3QgTUFYX0lPX0NIVU5LX1NJWkUgPSA4O1xuXG4vKipcbiAqIFJldHJpZXZlIGEgZmlsZSBmcm9tIGEgcmVhbCBkZXZpY2VcbiAqXG4gKiBAcGFyYW0ge0FmY1NlcnZpY2V9IGFmY1NlcnZpY2UgQXBwbGUgRmlsZSBDbGllbnQgc2VydmljZSBpbnN0YW5jZSBmcm9tXG4gKiAnYXBwaXVtLWlvcy1kZXZpY2UnIG1vZHVsZVxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggUmVsYXRpdmUgcGF0aCB0byB0aGUgZmlsZSBvbiB0aGUgZGV2aWNlXG4gKiBAcmV0dXJucyB7QnVmZmVyfSBUaGUgZmlsZSBjb250ZW50IGFzIGEgYnVmZmVyXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHB1bGxGaWxlIChhZmNTZXJ2aWNlLCByZW1vdGVQYXRoKSB7XG4gIGNvbnN0IHN0cmVhbSA9IGF3YWl0IGFmY1NlcnZpY2UuY3JlYXRlUmVhZFN0cmVhbShyZW1vdGVQYXRoLCB7IGF1dG9EZXN0cm95OiB0cnVlIH0pO1xuICBjb25zdCBwdWxsUHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBzdHJlYW0ub24oJ2Nsb3NlJywgcmVzb2x2ZSk7XG4gICAgc3RyZWFtLm9uKCdlcnJvcicsIHJlamVjdCk7XG4gIH0pLnRpbWVvdXQoSU9fVElNRU9VVF9NUyk7XG4gIGNvbnN0IGJ1ZmZlcnMgPSBbXTtcbiAgc3RyZWFtLm9uKCdkYXRhJywgKGRhdGEpID0+IGJ1ZmZlcnMucHVzaChkYXRhKSk7XG4gIGF3YWl0IHB1bGxQcm9taXNlO1xuICByZXR1cm4gQnVmZmVyLmNvbmNhdChidWZmZXJzKTtcbn1cblxuLyoqXG4gKiBSZXRyaWV2ZSBhIGZvbGRlciBmcm9tIGEgcmVhbCBkZXZpY2VcbiAqXG4gKiBAcGFyYW0ge0FmY1NlcnZpY2V9IGFmY1NlcnZpY2UgQXBwbGUgRmlsZSBDbGllbnQgc2VydmljZSBpbnN0YW5jZSBmcm9tXG4gKiAnYXBwaXVtLWlvcy1kZXZpY2UnIG1vZHVsZVxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVJvb3RQYXRoIFJlbGF0aXZlIHBhdGggdG8gdGhlIGZvbGRlciBvbiB0aGUgZGV2aWNlXG4gKiBAcmV0dXJucyB7QnVmZmVyfSBUaGUgZm9sZGVyIGNvbnRlbnQgYXMgYSB6aXBwZWQgYmFzZTY0LWVuY29kZWQgYnVmZmVyXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHB1bGxGb2xkZXIgKGFmY1NlcnZpY2UsIHJlbW90ZVJvb3RQYXRoKSB7XG4gIGNvbnN0IHRtcEZvbGRlciA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICB0cnkge1xuICAgIGNvbnN0IHB1bGxQcm9taXNlcyA9IFtdO1xuICAgIGF3YWl0IGFmY1NlcnZpY2Uud2Fsa0RpcihyZW1vdGVSb290UGF0aCwgdHJ1ZSwgYXN5bmMgKGl0ZW1QYXRoLCBpc0RpcikgPT4ge1xuICAgICAgY29uc3QgcGF0aE9uU2VydmVyID0gcGF0aC5qb2luKHRtcEZvbGRlciwgaXRlbVBhdGgpO1xuICAgICAgaWYgKGlzRGlyKSB7XG4gICAgICAgIGF3YWl0IG1rZGlycChwYXRoT25TZXJ2ZXIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlYWRTdHJlYW0gPSBhd2FpdCBhZmNTZXJ2aWNlLmNyZWF0ZVJlYWRTdHJlYW0oaXRlbVBhdGgsIHthdXRvRGVzdHJveTogdHJ1ZX0pO1xuICAgICAgY29uc3Qgd3JpdGVTdHJlYW0gPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShwYXRoT25TZXJ2ZXIsIHthdXRvQ2xvc2U6IHRydWV9KTtcbiAgICAgIHB1bGxQcm9taXNlcy5wdXNoKG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgd3JpdGVTdHJlYW0ub24oJ2Nsb3NlJywgcmVzb2x2ZSk7XG4gICAgICAgIGNvbnN0IG9uU3RyZWFtaW5nRXJyb3IgPSAoZSkgPT4ge1xuICAgICAgICAgIHJlYWRTdHJlYW0udW5waXBlKHdyaXRlU3RyZWFtKTtcbiAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgIH07XG4gICAgICAgIHdyaXRlU3RyZWFtLm9uKCdlcnJvcicsIG9uU3RyZWFtaW5nRXJyb3IpO1xuICAgICAgICByZWFkU3RyZWFtLm9uKCdlcnJvcicsIG9uU3RyZWFtaW5nRXJyb3IpO1xuICAgICAgfSkudGltZW91dChJT19USU1FT1VUX01TKSk7XG4gICAgICByZWFkU3RyZWFtLnBpcGUod3JpdGVTdHJlYW0pO1xuICAgICAgaWYgKHB1bGxQcm9taXNlcy5sZW5ndGggPj0gTUFYX0lPX0NIVU5LX1NJWkUpIHtcbiAgICAgICAgYXdhaXQgQi5hbnkocHVsbFByb21pc2VzKTtcbiAgICAgIH1cbiAgICAgIF8ucmVtb3ZlKHB1bGxQcm9taXNlcywgKHApID0+IHAuaXNGdWxmaWxsZWQoKSk7XG4gICAgfSk7XG4gICAgLy8gV2FpdCBmb3IgdGhlIHJlc3Qgb2YgdGhlIGNodW5rc1xuICAgIGF3YWl0IEIuYWxsKHB1bGxQcm9taXNlcyk7XG4gICAgcmV0dXJuIGF3YWl0IHppcC50b0luTWVtb3J5WmlwKHRtcEZvbGRlciwge1xuICAgICAgZW5jb2RlVG9CYXNlNjQ6IHRydWUsXG4gICAgfSk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmltcmFmKHRtcEZvbGRlcik7XG4gIH1cbn1cblxuLyoqXG4gKiBDcmVhdGVzIHJlbW90ZSBmb2xkZXIgcGF0aCByZWN1cnNpdmVseS4gTm9vcCBpZiB0aGUgZ2l2ZW4gcGF0aFxuICogYWxyZWFkeSBleGlzdHNcbiAqXG4gKiBAcGFyYW0ge0FmY1NlcnZpY2V9IGFmY1NlcnZpY2UgQXBwbGUgRmlsZSBDbGllbnQgc2VydmljZSBpbnN0YW5jZSBmcm9tXG4gKiAnYXBwaXVtLWlvcy1kZXZpY2UnIG1vZHVsZVxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVJvb3QgVGhlIHJlbGF0aXZlIHBhdGggdG8gdGhlIHJlbW90ZSBmb2xkZXIgc3RydWN0dXJlXG4gKiB0byBiZSBjcmVhdGVkXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHJlbW90ZU1rZGlycCAoYWZjU2VydmljZSwgcmVtb3RlUm9vdCkge1xuICBpZiAocmVtb3RlUm9vdCA9PT0gJy4nIHx8IHJlbW90ZVJvb3QgPT09ICcvJykge1xuICAgIHJldHVybjtcbiAgfVxuICB0cnkge1xuICAgIGF3YWl0IGFmY1NlcnZpY2UubGlzdERpcmVjdG9yeShyZW1vdGVSb290KTtcbiAgICByZXR1cm47XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyBUaGlzIG1lYW5zIHRoYXQgdGhlIGRpcmVjdG9yeSBpcyBtaXNzaW5nIGFuZCB3ZSBnb3QgYW4gb2JqZWN0IG5vdCBmb3VuZCBlcnJvci5cbiAgICAvLyBUaGVyZWZvcmUsIHdlIGFyZSBnb2luZyB0byB0aGUgcGFyZW50XG4gICAgYXdhaXQgcmVtb3RlTWtkaXJwKGFmY1NlcnZpY2UsIHBhdGguZGlybmFtZShyZW1vdGVSb290KSk7XG4gIH1cbiAgYXdhaXQgYWZjU2VydmljZS5jcmVhdGVEaXJlY3RvcnkocmVtb3RlUm9vdCk7XG59XG5cbi8qKlxuICogUHVzaGVzIGEgZmlsZSB0byBhIHJlYWwgZGV2aWNlXG4gKlxuICogQHBhcmFtIHtBZmNTZXJ2aWNlfSBhZmNTZXJ2aWNlIEFwcGxlIEZpbGUgQ2xpZW50IHNlcnZpY2UgaW5zdGFuY2UgZnJvbVxuICogJ2FwcGl1bS1pb3MtZGV2aWNlJyBtb2R1bGVcbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVQYXRoIFJlbGF0aXZlIHBhdGggdG8gdGhlIGZpbGUgb24gdGhlIGRldmljZS4gVGhlIHJlbW90ZVxuICogZm9sZGVyIHN0cnVjdHVyZSBpcyBjcmVhdGVkIGF1dG9tYXRpY2FsbHkgaWYgbmVjZXNzYXJ5LlxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2U2NERhdGEgQmFzZTY0LWVuY29kZWQgY29udGVudCBvZiB0aGUgZmlsZSB0byBiZSB3cml0dGVuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHB1c2hGaWxlIChhZmNTZXJ2aWNlLCByZW1vdGVQYXRoLCBiYXNlNjREYXRhKSB7XG4gIGF3YWl0IHJlbW90ZU1rZGlycChhZmNTZXJ2aWNlLCBwYXRoLmRpcm5hbWUocmVtb3RlUGF0aCkpO1xuICBjb25zdCBzdHJlYW0gPSBhd2FpdCBhZmNTZXJ2aWNlLmNyZWF0ZVdyaXRlU3RyZWFtKHJlbW90ZVBhdGgsIHthdXRvRGVzdHJveTogdHJ1ZX0pO1xuICBsZXQgcHVzaEVycm9yID0gbnVsbDtcbiAgY29uc3QgcHVzaFByb21pc2UgPSBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgc3RyZWFtLm9uKCdlcnJvcicsIChlKSA9PiB7XG4gICAgICBwdXNoRXJyb3IgPSBlO1xuICAgIH0pO1xuICAgIHN0cmVhbS5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICBpZiAocHVzaEVycm9yKSB7XG4gICAgICAgIHJlamVjdChwdXNoRXJyb3IpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KS50aW1lb3V0KElPX1RJTUVPVVRfTVMpO1xuICBzdHJlYW0ud3JpdGUoQnVmZmVyLmZyb20oYmFzZTY0RGF0YSwgJ2Jhc2U2NCcpKTtcbiAgc3RyZWFtLmVuZCgpO1xuICBhd2FpdCBwdXNoUHJvbWlzZTtcbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBQdXNoRm9sZGVyT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lb3V0TXMgWzI0MDAwMF0gVGhlIG1heGltdW0gdGltZW91dCB0byB3YWl0IHVudGlsIGFcbiAqIHNpbmdsZSBmaWxlIGlzIGNvcGllZFxuICogQHBhcmFtIHtib29sZWFufSBlbmFibGVQYXJhbGxlbFB1c2ggW2ZhbHNlXSBXaGV0aGVyIHRvIHB1c2ggZmlsZXMgaW4gcGFyYWxsZWwuXG4gKiBUaGlzIHVzdWFsbHkgZ2l2ZXMgYmV0dGVyIHBlcmZvcm1hbmNlLCBidXQgbWlnaHQgc29tZXRpbWVzIGJlIGxlc3Mgc3RhYmxlLlxuICovXG5cbi8qKlxuICogUHVzaGVzIGEgZm9sZGVyIHRvIGEgcmVhbCBkZXZpY2VcbiAqXG4gKiBAcGFyYW0ge0FmY1NlcnZpY2V9IGFmY1NlcnZpY2UgQXBwbGUgRmlsZSBDbGllbnQgc2VydmljZSBpbnN0YW5jZSBmcm9tXG4gKiAnYXBwaXVtLWlvcy1kZXZpY2UnIG1vZHVsZVxuICogQHBhcmFtIHtzdHJpbmd9IHNyY1Jvb3RQYXRoIFRoZSBmdWxsIHBhdGggdG8gdGhlIHNvdXJjZSBmb2xkZXJcbiAqIEBwYXJhbSB7c3RyaW5nfSBkc3RSb290UGF0aCBUaGUgcmVsYXRpdmUgcGF0aCB0byB0aGUgZGVzdGluYXRpb24gZm9sZGVyLiBUaGUgZm9sZGVyXG4gKiB3aWxsIGJlIGRlbGV0ZWQgaWYgYWxyZWFkeSBleGlzdHMuXG4gKiBAcGFyYW0ge1B1c2hGb2xkZXJPcHRpb25zfSBvcHRzXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHB1c2hGb2xkZXIgKGFmY1NlcnZpY2UsIHNyY1Jvb3RQYXRoLCBkc3RSb290UGF0aCwgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB0aW1lb3V0TXMgPSBJT19USU1FT1VUX01TLFxuICAgIGVuYWJsZVBhcmFsbGVsUHVzaCA9IGZhbHNlLFxuICB9ID0gb3B0cztcblxuICBjb25zdCB0aW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICBjb25zdCBpdGVtc1RvUHVzaCA9IGF3YWl0IGZzLmdsb2IoJyoqJywge1xuICAgIGN3ZDogc3JjUm9vdFBhdGgsXG4gICAgbm9zb3J0OiB0cnVlLFxuICAgIG1hcms6IHRydWUsXG4gIH0pO1xuICBsb2cuZGVidWcoYFN1Y2Nlc3NmdWxseSBzY2FubmVkIHRoZSB0cmVlIHN0cnVjdHVyZSBvZiAnJHtzcmNSb290UGF0aH0nYCk7XG4gIGNvbnN0IFtmb2xkZXJzVG9QdXNoLCBmaWxlc1RvUHVzaF0gPSBpdGVtc1RvUHVzaC5yZWR1Y2UoKGFjYywgeCkgPT4ge1xuICAgIGFjY1tfLmVuZHNXaXRoKHgsIHBhdGguc2VwKSA/IDAgOiAxXS5wdXNoKHgpO1xuICAgIHJldHVybiBhY2M7XG4gIH0sIFtbXSwgW11dKTtcbiAgbG9nLmRlYnVnKGBHb3QgJHt1dGlsLnBsdXJhbGl6ZSgnZm9sZGVyJywgZm9sZGVyc1RvUHVzaC5sZW5ndGgsIHRydWUpfSBhbmQgYCArXG4gICAgYCR7dXRpbC5wbHVyYWxpemUoJ2ZpbGUnLCBmaWxlc1RvUHVzaC5sZW5ndGgsIHRydWUpfSB0byBwdXNoYCk7XG4gIC8vIGNyZWF0ZSB0aGUgZm9sZGVyIHN0cnVjdHVyZSBmaXJzdFxuICB0cnkge1xuICAgIGF3YWl0IGFmY1NlcnZpY2UuZGVsZXRlRGlyZWN0b3J5KGRzdFJvb3RQYXRoKTtcbiAgfSBjYXRjaCAoaWduKSB7fVxuICBhd2FpdCBhZmNTZXJ2aWNlLmNyZWF0ZURpcmVjdG9yeShkc3RSb290UGF0aCk7XG4gIC8vIHRvcC1sZXZlbCBmb2xkZXJzIG11c3QgZ28gZmlyc3RcbiAgY29uc3QgZm9sZGVyc1RvUHVzaEJ5SGllcmFyY2h5ID0gZm9sZGVyc1RvUHVzaFxuICAgIC5zb3J0KChhLCBiKSA9PiBhLnNwbGl0KHBhdGguc2VwKS5sZW5ndGggLSBiLnNwbGl0KHBhdGguc2VwKS5sZW5ndGgpO1xuICBmb3IgKGNvbnN0IHJlbGF0aXZlRm9sZGVyUGF0aCBvZiBmb2xkZXJzVG9QdXNoQnlIaWVyYXJjaHkpIHtcbiAgICAvLyBjcmVhdGVEaXJlY3RvcnkgZG9lcyBub3QgYWNjZXB0IGZvbGRlciBuYW1lcyBlbmRpbmcgd2l0aCBhIHBhdGggc2VwYXJhdG9yXG4gICAgY29uc3QgYWJzb2x1dGVGb2xkZXJQYXRoID0gXy50cmltRW5kKFxuICAgICAgcGF0aC5qb2luKGRzdFJvb3RQYXRoLCByZWxhdGl2ZUZvbGRlclBhdGgpLCBwYXRoLnNlcFxuICAgICk7XG4gICAgaWYgKGFic29sdXRlRm9sZGVyUGF0aCkge1xuICAgICAgYXdhaXQgYWZjU2VydmljZS5jcmVhdGVEaXJlY3RvcnkoYWJzb2x1dGVGb2xkZXJQYXRoKTtcbiAgICB9XG4gIH1cbiAgLy8gZG8gbm90IGZvcmdldCBhYm91dCB0aGUgcm9vdCBmb2xkZXJcbiAgbG9nLmRlYnVnKGBTdWNjZXNzZnVsbHkgY3JlYXRlZCB0aGUgcmVtb3RlIGZvbGRlciBzdHJ1Y3R1cmUgYCArXG4gICAgYCgke3V0aWwucGx1cmFsaXplKCdpdGVtJywgZm9sZGVyc1RvUHVzaC5sZW5ndGggKyAxLCB0cnVlKX0pYCk7XG5cbiAgY29uc3QgcHVzaEZpbGUgPSBhc3luYyAocmVsYXRpdmVQYXRoKSA9PiB7XG4gICAgY29uc3QgYWJzb2x1dGVTb3VyY2VQYXRoID0gcGF0aC5qb2luKHNyY1Jvb3RQYXRoLCByZWxhdGl2ZVBhdGgpO1xuICAgIGNvbnN0IHJlYWRTdHJlYW0gPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGFic29sdXRlU291cmNlUGF0aCwge2F1dG9DbG9zZTogdHJ1ZX0pO1xuICAgIGNvbnN0IGFic29sdXRlRGVzdGluYXRpb25QYXRoID0gcGF0aC5qb2luKGRzdFJvb3RQYXRoLCByZWxhdGl2ZVBhdGgpO1xuICAgIGNvbnN0IHdyaXRlU3RyZWFtID0gYXdhaXQgYWZjU2VydmljZS5jcmVhdGVXcml0ZVN0cmVhbShhYnNvbHV0ZURlc3RpbmF0aW9uUGF0aCwge1xuICAgICAgYXV0b0Rlc3Ryb3k6IHRydWVcbiAgICB9KTtcbiAgICB3cml0ZVN0cmVhbS5vbignZmluaXNoJywgd3JpdGVTdHJlYW0uZGVzdHJveSk7XG4gICAgbGV0IHB1c2hFcnJvciA9IG51bGw7XG4gICAgY29uc3QgZmlsZVB1c2hQcm9taXNlID0gbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgd3JpdGVTdHJlYW0ub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICBpZiAocHVzaEVycm9yKSB7XG4gICAgICAgICAgcmVqZWN0KHB1c2hFcnJvcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGNvbnN0IG9uU3RyZWFtRXJyb3IgPSAoZSkgPT4ge1xuICAgICAgICByZWFkU3RyZWFtLnVucGlwZSh3cml0ZVN0cmVhbSk7XG4gICAgICAgIGxvZy5kZWJ1ZyhlKTtcbiAgICAgICAgcHVzaEVycm9yID0gZTtcbiAgICAgIH07XG4gICAgICB3cml0ZVN0cmVhbS5vbignZXJyb3InLCBvblN0cmVhbUVycm9yKTtcbiAgICAgIHJlYWRTdHJlYW0ub24oJ2Vycm9yJywgb25TdHJlYW1FcnJvcik7XG4gICAgfSk7XG4gICAgcmVhZFN0cmVhbS5waXBlKHdyaXRlU3RyZWFtKTtcbiAgICBhd2FpdCBmaWxlUHVzaFByb21pc2UudGltZW91dCh0aW1lb3V0TXMpO1xuICB9O1xuXG4gIGlmIChlbmFibGVQYXJhbGxlbFB1c2gpIHtcbiAgICBsb2cuZGVidWcoYFByb2NlZWRpbmcgdG8gcGFyYWxsZWwgZmlsZXMgcHVzaCAobWF4ICR7TUFYX0lPX0NIVU5LX1NJWkV9IHdyaXRlcnMpYCk7XG4gICAgY29uc3QgcHVzaFByb21pc2VzID0gW107XG4gICAgZm9yIChjb25zdCByZWxhdGl2ZUZpbGVQYXRoIG9mIF8uc2h1ZmZsZShmaWxlc1RvUHVzaCkpIHtcbiAgICAgIHB1c2hQcm9taXNlcy5wdXNoKEIucmVzb2x2ZShwdXNoRmlsZShyZWxhdGl2ZUZpbGVQYXRoKSkpO1xuICAgICAgLy8ga2VlcCB0aGUgcHVzaCBxdWV1ZSBmaWxsZWRcbiAgICAgIGlmIChwdXNoUHJvbWlzZXMubGVuZ3RoID49IE1BWF9JT19DSFVOS19TSVpFKSB7XG4gICAgICAgIGF3YWl0IEIuYW55KHB1c2hQcm9taXNlcyk7XG4gICAgICB9XG4gICAgICBfLnJlbW92ZShwdXNoUHJvbWlzZXMsIChwKSA9PiBwLmlzRnVsZmlsbGVkKCkpO1xuICAgIH1cbiAgICBpZiAoIV8uaXNFbXB0eShwdXNoUHJvbWlzZXMpKSB7XG4gICAgICAvLyBoYW5kbGUgdGhlIHJlc3Qgb2YgcHVzaCBwcm9taXNlc1xuICAgICAgYXdhaXQgQi5hbGwocHVzaFByb21pc2VzKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbG9nLmRlYnVnKGBQcm9jZWVkaW5nIHRvIHNlcmlhbCBmaWxlcyBwdXNoYCk7XG4gICAgZm9yIChjb25zdCByZWxhdGl2ZUZpbGVQYXRoIG9mIGZpbGVzVG9QdXNoKSB7XG4gICAgICBhd2FpdCBwdXNoRmlsZShyZWxhdGl2ZUZpbGVQYXRoKTtcbiAgICB9XG4gIH1cblxuICBsb2cuZGVidWcoYFN1Y2Nlc3NmdWxseSBwdXNoZWQgJHt1dGlsLnBsdXJhbGl6ZSgnZm9sZGVyJywgZm9sZGVyc1RvUHVzaC5sZW5ndGgsIHRydWUpfSBgICtcbiAgICBgYW5kICR7dXRpbC5wbHVyYWxpemUoJ2ZpbGUnLCBmaWxlc1RvUHVzaC5sZW5ndGgsIHRydWUpfSBgICtcbiAgICBgd2l0aGluICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zYCk7XG59XG5cblxuZXhwb3J0IHsgcHVsbEZpbGUsIHB1bGxGb2xkZXIsIHB1c2hGaWxlLCBwdXNoRm9sZGVyIH07Il0sImZpbGUiOiJsaWIvaW9zLWZzLWhlbHBlcnMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
