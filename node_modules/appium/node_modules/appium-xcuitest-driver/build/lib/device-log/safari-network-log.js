"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.SafariNetworkLog = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _url = _interopRequireDefault(require("url"));

var _appiumSupport = require("appium-support");

var _rotatingLog = require("./rotating-log");

class SafariNetworkLog extends _rotatingLog.RotatingLog {
  constructor(showLogs) {
    super(showLogs, 'SafariNetwork');
  }

  getEntry(requestId) {
    let outputEntry;

    while (this.logs.length >= _rotatingLog.MAX_LOG_ENTRIES_COUNT) {
      const entry = this.logs.shift();

      if (entry && entry.requestId === requestId) {
        outputEntry = entry;
        this.logs.push(outputEntry);
        continue;
      }

      if (this.logIdxSinceLastRequest > 0) {
        this.logIdxSinceLastRequest--;
      }
    }

    if (!outputEntry) {
      for (let i = this.logs.length - 1; i >= 0; i--) {
        if (this.logs[i].requestId === requestId) {
          outputEntry = this.logs[i];
          this.logs.splice(i, 1);
          break;
        }
      }

      if (!outputEntry) {
        outputEntry = {
          requestId,
          logs: []
        };
      }

      this.logs.push(outputEntry);
    }

    return outputEntry;
  }

  addLogLine(method, out) {
    if (!this.isCapturing && !this.showLogs) {
      return;
    }

    if (['Network.dataReceived'].includes(method)) {
      return;
    }

    const outputEntry = this.getEntry(out.requestId);

    if (this.isCapturing) {
      outputEntry.logs = outputEntry.logs || [];
      outputEntry.logs.push(out);
    }

    if (!this.showLogs) {
      return;
    }

    if (method === 'Network.loadingFinished' || method === 'Network.loadingFailed') {
      this.printLogLine(outputEntry);
    }
  }

  getLogDetails(outputEntry) {
    const record = outputEntry.logs.reduce(function getRecord(record, entry) {
      record.requestId = entry.requestId;

      if (entry.response) {
        const url = _url.default.parse(entry.response.url);

        record.name = `${_lodash.default.last(url.pathname.split('/'))}${url.search ? `?${url.search}` : ''}` || url.host;
        record.status = entry.response.status;

        if (entry.response.timing) {
          record.time = entry.response.timing.receiveHeadersEnd || entry.response.timing.responseStart || 0;
        }

        record.source = entry.response.source;
      }

      if (entry.type) {
        record.type = entry.type;
      }

      if (entry.initiator) {
        record.initiator = entry.initiator;
      }

      if (entry.metrics) {
        record.size = entry.metrics.responseBodyBytesReceived || 0;
      }

      if (entry.errorText) {
        record.errorText = entry.errorText;
        record.cancelled = entry.canceled;
      }

      return record;
    }, {});
    return record;
  }

  printLogLine(outputEntry) {
    const {
      requestId,
      name,
      status,
      type,
      initiator = {},
      size = 0,
      time = 0,
      source,
      errorText,
      cancelled = false
    } = this.getLogDetails(outputEntry);
    this.log.debug(`Network event:`);
    this.log.debug(`  Id: ${requestId}`);
    this.log.debug(`  Name: ${name}`);
    this.log.debug(`  Status: ${status}`);
    this.log.debug(`  Type: ${type}`);
    this.log.debug(`  Initiator: ${initiator.type}`);

    for (const line of initiator.stackTrace || []) {
      const functionName = line.functionName || '(anonymous)';
      const url = !line.url || line.url === '[native code]' ? '' : `@${_lodash.default.last((_url.default.parse(line.url).pathname || '').split('/'))}:${line.lineNumber}`;
      this.log.debug(`    ${_lodash.default.padEnd(_lodash.default.truncate(functionName, {
        length: 20
      }), 21)} ${url}`);
    }

    const sizeStr = source.includes('cache') ? ` (from ${source.replace('-', ' ')})` : `${size}B`;
    this.log.debug(`  Size: ${sizeStr}`);
    this.log.debug(`  Time: ${Math.round(time)}ms`);

    if (errorText) {
      this.log.debug(`  Error: ${errorText}`);
    }

    if (_appiumSupport.util.hasValue(cancelled)) {
      this.log.debug(`  Cancelled: ${cancelled}`);
    }
  }

  async getLogs() {
    const logs = await super.getLogs();
    return logs.map(function adjustEntry(entry) {
      return Object.assign({}, entry, {
        level: 'INFO',
        timestamp: Date.now(),
        message: JSON.stringify(entry)
      });
    });
  }

}

exports.SafariNetworkLog = SafariNetworkLog;
var _default = SafariNetworkLog;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UtbG9nL3NhZmFyaS1uZXR3b3JrLWxvZy5qcyJdLCJuYW1lcyI6WyJTYWZhcmlOZXR3b3JrTG9nIiwiUm90YXRpbmdMb2ciLCJjb25zdHJ1Y3RvciIsInNob3dMb2dzIiwiZ2V0RW50cnkiLCJyZXF1ZXN0SWQiLCJvdXRwdXRFbnRyeSIsImxvZ3MiLCJsZW5ndGgiLCJNQVhfTE9HX0VOVFJJRVNfQ09VTlQiLCJlbnRyeSIsInNoaWZ0IiwicHVzaCIsImxvZ0lkeFNpbmNlTGFzdFJlcXVlc3QiLCJpIiwic3BsaWNlIiwiYWRkTG9nTGluZSIsIm1ldGhvZCIsIm91dCIsImlzQ2FwdHVyaW5nIiwiaW5jbHVkZXMiLCJwcmludExvZ0xpbmUiLCJnZXRMb2dEZXRhaWxzIiwicmVjb3JkIiwicmVkdWNlIiwiZ2V0UmVjb3JkIiwicmVzcG9uc2UiLCJ1cmwiLCJVUkwiLCJwYXJzZSIsIm5hbWUiLCJfIiwibGFzdCIsInBhdGhuYW1lIiwic3BsaXQiLCJzZWFyY2giLCJob3N0Iiwic3RhdHVzIiwidGltaW5nIiwidGltZSIsInJlY2VpdmVIZWFkZXJzRW5kIiwicmVzcG9uc2VTdGFydCIsInNvdXJjZSIsInR5cGUiLCJpbml0aWF0b3IiLCJtZXRyaWNzIiwic2l6ZSIsInJlc3BvbnNlQm9keUJ5dGVzUmVjZWl2ZWQiLCJlcnJvclRleHQiLCJjYW5jZWxsZWQiLCJjYW5jZWxlZCIsImxvZyIsImRlYnVnIiwibGluZSIsInN0YWNrVHJhY2UiLCJmdW5jdGlvbk5hbWUiLCJsaW5lTnVtYmVyIiwicGFkRW5kIiwidHJ1bmNhdGUiLCJzaXplU3RyIiwicmVwbGFjZSIsIk1hdGgiLCJyb3VuZCIsInV0aWwiLCJoYXNWYWx1ZSIsImdldExvZ3MiLCJtYXAiLCJhZGp1c3RFbnRyeSIsIk9iamVjdCIsImFzc2lnbiIsImxldmVsIiwidGltZXN0YW1wIiwiRGF0ZSIsIm5vdyIsIm1lc3NhZ2UiLCJKU09OIiwic3RyaW5naWZ5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7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QUFDZixVQUFNMUQsSUFBSSxHQUFHLE1BQU0sTUFBTTBELE9BQU4sRUFBbkI7QUFJQSxXQUFPMUQsSUFBSSxDQUFDMkQsR0FBTCxDQUFTLFNBQVNDLFdBQVQsQ0FBc0J6RCxLQUF0QixFQUE2QjtBQUMzQyxhQUFPMEQsTUFBTSxDQUFDQyxNQUFQLENBQWMsRUFBZCxFQUFrQjNELEtBQWxCLEVBQXlCO0FBQzlCNEQsUUFBQUEsS0FBSyxFQUFFLE1BRHVCO0FBRTlCQyxRQUFBQSxTQUFTLEVBQUVDLElBQUksQ0FBQ0MsR0FBTCxFQUZtQjtBQUc5QkMsUUFBQUEsT0FBTyxFQUFFQyxJQUFJLENBQUNDLFNBQUwsQ0FBZWxFLEtBQWY7QUFIcUIsT0FBekIsQ0FBUDtBQUtELEtBTk0sQ0FBUDtBQU9EOztBQXRMd0M7OztlQTBMNUJWLGdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBVUkwgZnJvbSAndXJsJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBSb3RhdGluZ0xvZywgTUFYX0xPR19FTlRSSUVTX0NPVU5UIH0gZnJvbSAnLi9yb3RhdGluZy1sb2cnO1xuXG5cbmNsYXNzIFNhZmFyaU5ldHdvcmtMb2cgZXh0ZW5kcyBSb3RhdGluZ0xvZyB7XG4gIGNvbnN0cnVjdG9yIChzaG93TG9ncykge1xuICAgIHN1cGVyKHNob3dMb2dzLCAnU2FmYXJpTmV0d29yaycpO1xuICB9XG5cbiAgZ2V0RW50cnkgKHJlcXVlc3RJZCkge1xuICAgIGxldCBvdXRwdXRFbnRyeTtcbiAgICB3aGlsZSAodGhpcy5sb2dzLmxlbmd0aCA+PSBNQVhfTE9HX0VOVFJJRVNfQ09VTlQpIHtcbiAgICAgIC8vIHB1bGwgdGhlIGZpcnN0IGVudHJ5LCB3aGljaCBpcyB0aGUgb2xkZXN0XG4gICAgICBjb25zdCBlbnRyeSA9IHRoaXMubG9ncy5zaGlmdCgpO1xuICAgICAgaWYgKGVudHJ5ICYmIGVudHJ5LnJlcXVlc3RJZCA9PT0gcmVxdWVzdElkKSB7XG4gICAgICAgIC8vIHdlIGFyZSBhZGRpbmcgdG8gYW4gZXhpc3RpbmcgZW50cnksIGFuZCBpdCB3YXMgYWxtb3N0IHJlbW92ZWRcbiAgICAgICAgLy8gYWRkIHRvIHRoZSBlbmQgb2YgdGhlIGxpc3QgYW5kIHRyeSBhZ2FpblxuICAgICAgICBvdXRwdXRFbnRyeSA9IGVudHJ5O1xuICAgICAgICB0aGlzLmxvZ3MucHVzaChvdXRwdXRFbnRyeSk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgLy8gd2UndmUgcmVtb3ZlZCBhbiBlbGVtZW50LCBzbyB0aGUgY291bnQgaXMgZG93biBvbmVcbiAgICAgIGlmICh0aGlzLmxvZ0lkeFNpbmNlTGFzdFJlcXVlc3QgPiAwKSB7XG4gICAgICAgIHRoaXMubG9nSWR4U2luY2VMYXN0UmVxdWVzdC0tO1xuICAgICAgfVxuICAgIH1cblxuXG4gICAgaWYgKCFvdXRwdXRFbnRyeSkge1xuICAgICAgLy8gd2UgZG8gbm90IHllcyBoYXZlIGFuIGVudHJ5IHRvIGFzc29jaWF0ZSB0aGlzIGJpdCBvZiBvdXRwdXQgd2l0aFxuICAgICAgLy8gbW9zdCBsaWtlbHkgdGhlIGVudHJ5IHdpbGwgYmUgYXQgdGhlIGVuZCBvZiB0aGUgbGlzdCwgc28gc3RhcnQgdGhlcmVcbiAgICAgIGZvciAobGV0IGkgPSB0aGlzLmxvZ3MubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgaWYgKHRoaXMubG9nc1tpXS5yZXF1ZXN0SWQgPT09IHJlcXVlc3RJZCkge1xuICAgICAgICAgIC8vIGZvdW5kIGl0IVxuICAgICAgICAgIG91dHB1dEVudHJ5ID0gdGhpcy5sb2dzW2ldO1xuICAgICAgICAgIC8vIHRoaXMgaXMgbm93IHRoZSBtb3N0IGN1cnJlbnQgZW50cnksIHNvIHJlbW92ZSBpdCBmcm9tIHRoZSBsaXN0XG4gICAgICAgICAgLy8gdG8gYmUgYWRkZWQgdG8gdGhlIGVuZCBiZWxvd1xuICAgICAgICAgIHRoaXMubG9ncy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gbm90aGluZyBoYXMgYmVlbiBmb3VuZCwgc28gY3JlYXRlIGEgbmV3IGVudHJ5XG4gICAgICBpZiAoIW91dHB1dEVudHJ5KSB7XG4gICAgICAgIG91dHB1dEVudHJ5ID0ge1xuICAgICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgICBsb2dzOiBbXSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gZmluYWxseSwgYWRkIHRoZSBlbnRyeSB0byB0aGUgZW5kIG9mIHRoZSBsaXN0XG4gICAgICB0aGlzLmxvZ3MucHVzaChvdXRwdXRFbnRyeSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG91dHB1dEVudHJ5O1xuICB9XG5cbiAgYWRkTG9nTGluZSAobWV0aG9kLCBvdXQpIHtcbiAgICBpZiAoIXRoaXMuaXNDYXB0dXJpbmcgJiYgIXRoaXMuc2hvd0xvZ3MpIHtcbiAgICAgIC8vIG5laXRoZXIgY2FwdHVyaW5nIG5vciBkaXNwbGF5aW5nLCBzbyBkbyBub3RoaW5nXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKFsnTmV0d29yay5kYXRhUmVjZWl2ZWQnXS5pbmNsdWRlcyhtZXRob2QpKSB7XG4gICAgICAvLyBzdGF0dXMgdXBkYXRlLCBubyBuZWVkIHRvIGhhbmRsZVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGV2ZW50cyB3ZSBjYXJlIGFib3V0OlxuICAgIC8vICAgTmV0d29yay5yZXF1ZXN0V2lsbEJlU2VudFxuICAgIC8vICAgTmV0d29yay5yZXNwb25zZVJlY2VpdmVkXG4gICAgLy8gICBOZXR3b3JrLmxvYWRpbmdGaW5pc2hlZFxuICAgIC8vICAgTmV0d29yay5sb2FkaW5nRmFpbGVkXG5cbiAgICBjb25zdCBvdXRwdXRFbnRyeSA9IHRoaXMuZ2V0RW50cnkob3V0LnJlcXVlc3RJZCk7XG4gICAgaWYgKHRoaXMuaXNDYXB0dXJpbmcpIHtcbiAgICAgIC8vIG5vdyBhZGQgdGhlIG91dHB1dCB3ZSBqdXN0IHJlY2VpdmVkIHRvIHRoZSBsb2dzIGZvciB0aGlzIHBhcnRpY3VsYXIgZW50cnlcbiAgICAgIG91dHB1dEVudHJ5LmxvZ3MgPSBvdXRwdXRFbnRyeS5sb2dzIHx8IFtdO1xuXG4gICAgICBvdXRwdXRFbnRyeS5sb2dzLnB1c2gob3V0KTtcbiAgICB9XG5cbiAgICAvLyBpZiB3ZSBhcmUgbm90IGRpc3BsYXlpbmcgdGhlIGxvZ3MsXG4gICAgLy8gb3Igd2UgYXJlIG5vdCBmaW5pc2hlZCBnZXR0aW5nIGV2ZW50cyBmb3IgdGhpcyBuZXR3b3JrIGNhbGwsXG4gICAgLy8gd2UgYXJlIGRvbmVcbiAgICBpZiAoIXRoaXMuc2hvd0xvZ3MpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAobWV0aG9kID09PSAnTmV0d29yay5sb2FkaW5nRmluaXNoZWQnIHx8IG1ldGhvZCA9PT0gJ05ldHdvcmsubG9hZGluZ0ZhaWxlZCcpIHtcbiAgICAgIHRoaXMucHJpbnRMb2dMaW5lKG91dHB1dEVudHJ5KTtcbiAgICB9XG4gIH1cblxuICBnZXRMb2dEZXRhaWxzIChvdXRwdXRFbnRyeSkge1xuICAgIC8vIGV4dHJhY3QgdGhlIGRhdGFcbiAgICBjb25zdCByZWNvcmQgPSBvdXRwdXRFbnRyeS5sb2dzLnJlZHVjZShmdW5jdGlvbiBnZXRSZWNvcmQgKHJlY29yZCwgZW50cnkpIHtcbiAgICAgIHJlY29yZC5yZXF1ZXN0SWQgPSBlbnRyeS5yZXF1ZXN0SWQ7XG4gICAgICBpZiAoZW50cnkucmVzcG9uc2UpIHtcbiAgICAgICAgY29uc3QgdXJsID0gVVJMLnBhcnNlKGVudHJ5LnJlc3BvbnNlLnVybCk7XG4gICAgICAgIC8vIGdldCB0aGUgbGFzdCBwYXJ0IG9mIHRoZSB1cmwsIGFsb25nIHdpdGggdGhlIHF1ZXJ5IHN0cmluZywgaWYgcG9zc2libGVcbiAgICAgICAgcmVjb3JkLm5hbWUgPSBgJHtfLmxhc3QodXJsLnBhdGhuYW1lLnNwbGl0KCcvJykpfSR7dXJsLnNlYXJjaCA/IGA/JHt1cmwuc2VhcmNofWAgOiAnJ31gIHx8IHVybC5ob3N0O1xuICAgICAgICByZWNvcmQuc3RhdHVzID0gZW50cnkucmVzcG9uc2Uuc3RhdHVzO1xuICAgICAgICBpZiAoZW50cnkucmVzcG9uc2UudGltaW5nKSB7XG4gICAgICAgICAgcmVjb3JkLnRpbWUgPSBlbnRyeS5yZXNwb25zZS50aW1pbmcucmVjZWl2ZUhlYWRlcnNFbmRcbiAgICAgICAgICAgIHx8IGVudHJ5LnJlc3BvbnNlLnRpbWluZy5yZXNwb25zZVN0YXJ0XG4gICAgICAgICAgICB8fCAwO1xuICAgICAgICB9XG4gICAgICAgIHJlY29yZC5zb3VyY2UgPSBlbnRyeS5yZXNwb25zZS5zb3VyY2U7XG4gICAgICB9XG4gICAgICBpZiAoZW50cnkudHlwZSkge1xuICAgICAgICByZWNvcmQudHlwZSA9IGVudHJ5LnR5cGU7XG4gICAgICB9XG4gICAgICBpZiAoZW50cnkuaW5pdGlhdG9yKSB7XG4gICAgICAgIHJlY29yZC5pbml0aWF0b3IgPSBlbnRyeS5pbml0aWF0b3I7XG4gICAgICB9XG4gICAgICBpZiAoZW50cnkubWV0cmljcykge1xuICAgICAgICAvLyBTYWZhcmkgaGFzIGEgYG1ldHJpY3NgIG9iamVjdCBvbiBpdCdzIGBOZXR3b3JrLmxvYWRpbmdGaW5pc2hlZGAgZXZlbnRcbiAgICAgICAgcmVjb3JkLnNpemUgPSBlbnRyeS5tZXRyaWNzLnJlc3BvbnNlQm9keUJ5dGVzUmVjZWl2ZWQgfHwgMDtcbiAgICAgIH1cbiAgICAgIGlmIChlbnRyeS5lcnJvclRleHQpIHtcbiAgICAgICAgcmVjb3JkLmVycm9yVGV4dCA9IGVudHJ5LmVycm9yVGV4dDtcbiAgICAgICAgLy8gV2hlbiBhIG5ldHdvcmsgY2FsbCBpcyBjYW5jZWxsZWQsIFNhZmFyaSByZXR1cm5zIGBjYW5jZWxsZWRgIGFzIGVycm9yIHRleHRcbiAgICAgICAgLy8gYnV0IGhhcyBhIGJvb2xlYW4gYGNhbmNlbGVkYC4gTm9ybWFsaXplIHRoZSB0d28gc3BlbGxpbmdzIGluIGZhdm9yIG9mXG4gICAgICAgIC8vIHRoZSB0ZXh0LCB3aGljaCB3aWxsIGFsc28gYmUgZGlzcGxheWVkXG4gICAgICAgIHJlY29yZC5jYW5jZWxsZWQgPSBlbnRyeS5jYW5jZWxlZDtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgfSwge30pO1xuXG4gICAgcmV0dXJuIHJlY29yZDtcbiAgfVxuXG4gIHByaW50TG9nTGluZSAob3V0cHV0RW50cnkpIHtcbiAgICBjb25zdCB7XG4gICAgICByZXF1ZXN0SWQsXG4gICAgICBuYW1lLFxuICAgICAgc3RhdHVzLFxuICAgICAgdHlwZSxcbiAgICAgIGluaXRpYXRvciA9IHt9LFxuICAgICAgc2l6ZSA9IDAsXG4gICAgICB0aW1lID0gMCxcbiAgICAgIHNvdXJjZSxcbiAgICAgIGVycm9yVGV4dCxcbiAgICAgIGNhbmNlbGxlZCA9IGZhbHNlLFxuICAgIH0gPSB0aGlzLmdldExvZ0RldGFpbHMob3V0cHV0RW50cnkpO1xuXG4gICAgLy8gcHJpbnQgb3V0IHRoZSByZWNvcmQsIGZvcm1hdHRlZCBhcHByb3ByaWF0ZWx5XG4gICAgdGhpcy5sb2cuZGVidWcoYE5ldHdvcmsgZXZlbnQ6YCk7XG4gICAgdGhpcy5sb2cuZGVidWcoYCAgSWQ6ICR7cmVxdWVzdElkfWApO1xuICAgIHRoaXMubG9nLmRlYnVnKGAgIE5hbWU6ICR7bmFtZX1gKTtcbiAgICB0aGlzLmxvZy5kZWJ1ZyhgICBTdGF0dXM6ICR7c3RhdHVzfWApO1xuICAgIHRoaXMubG9nLmRlYnVnKGAgIFR5cGU6ICR7dHlwZX1gKTtcbiAgICB0aGlzLmxvZy5kZWJ1ZyhgICBJbml0aWF0b3I6ICR7aW5pdGlhdG9yLnR5cGV9YCk7XG4gICAgZm9yIChjb25zdCBsaW5lIG9mIChpbml0aWF0b3Iuc3RhY2tUcmFjZSB8fCBbXSkpIHtcbiAgICAgIGNvbnN0IGZ1bmN0aW9uTmFtZSA9IGxpbmUuZnVuY3Rpb25OYW1lIHx8ICcoYW5vbnltb3VzKSc7XG5cbiAgICAgIGNvbnN0IHVybCA9ICghbGluZS51cmwgfHwgbGluZS51cmwgPT09ICdbbmF0aXZlIGNvZGVdJylcbiAgICAgICAgPyAnJ1xuICAgICAgICA6IGBAJHtfLmxhc3QoKFVSTC5wYXJzZShsaW5lLnVybCkucGF0aG5hbWUgfHwgJycpLnNwbGl0KCcvJykpfToke2xpbmUubGluZU51bWJlcn1gO1xuICAgICAgdGhpcy5sb2cuZGVidWcoYCAgICAke18ucGFkRW5kKF8udHJ1bmNhdGUoZnVuY3Rpb25OYW1lLCB7bGVuZ3RoOiAyMH0pLCAyMSl9ICR7dXJsfWApO1xuICAgIH1cbiAgICAvLyBnZXQgYG1lbW9yeS1jYWNoZWAgb3IgYGRpc2stY2FjaGVgLCBldGMuLCByaWdodFxuICAgIGNvbnN0IHNpemVTdHIgPSBzb3VyY2UuaW5jbHVkZXMoJ2NhY2hlJykgPyBgIChmcm9tICR7c291cmNlLnJlcGxhY2UoJy0nLCAnICcpfSlgIDogYCR7c2l6ZX1CYDtcbiAgICB0aGlzLmxvZy5kZWJ1ZyhgICBTaXplOiAke3NpemVTdHJ9YCk7XG4gICAgdGhpcy5sb2cuZGVidWcoYCAgVGltZTogJHtNYXRoLnJvdW5kKHRpbWUpfW1zYCk7XG4gICAgaWYgKGVycm9yVGV4dCkge1xuICAgICAgdGhpcy5sb2cuZGVidWcoYCAgRXJyb3I6ICR7ZXJyb3JUZXh0fWApO1xuICAgIH1cbiAgICBpZiAodXRpbC5oYXNWYWx1ZShjYW5jZWxsZWQpKSB7XG4gICAgICB0aGlzLmxvZy5kZWJ1ZyhgICBDYW5jZWxsZWQ6ICR7Y2FuY2VsbGVkfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldExvZ3MgKCkge1xuICAgIGNvbnN0IGxvZ3MgPSBhd2FpdCBzdXBlci5nZXRMb2dzKCk7XG4gICAgLy8gaW4gb3JkZXIgdG8gc2F0aXNmeSBjZXJ0YWluIGNsaWVudHMsIHdlIG5lZWQgdG8gaGF2ZSBhIGJhc2ljIHN0cnVjdHVyZVxuICAgIC8vIHRvIHRoZSByZXN1bHRzLCB3aXRoIGBsZXZlbGAsIGB0aW1lc3RhbXBgLCBhbmQgYG1lc3NhZ2VgLCB3aGljaCBpc1xuICAgIC8vIGFsbCB0aGUgaW5mb3JtYXRpb24gc3RyaW5naWZpZWRcbiAgICByZXR1cm4gbG9ncy5tYXAoZnVuY3Rpb24gYWRqdXN0RW50cnkgKGVudHJ5KSB7XG4gICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgZW50cnksIHtcbiAgICAgICAgbGV2ZWw6ICdJTkZPJyxcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICBtZXNzYWdlOiBKU09OLnN0cmluZ2lmeShlbnRyeSksXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgeyBTYWZhcmlOZXR3b3JrTG9nIH07XG5leHBvcnQgZGVmYXVsdCBTYWZhcmlOZXR3b3JrTG9nO1xuIl0sImZpbGUiOiJsaWIvZGV2aWNlLWxvZy9zYWZhcmktbmV0d29yay1sb2cuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
