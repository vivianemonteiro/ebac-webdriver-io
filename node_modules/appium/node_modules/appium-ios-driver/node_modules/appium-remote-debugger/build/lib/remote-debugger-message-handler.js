"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

const IGNORED_EVENTS = ['Page.defaultAppearanceDidChange', 'Page.domContentEventFired', 'Page.frameStartedLoading', 'Page.frameStoppedLoading', 'Page.frameScheduledNavigation', 'Page.frameClearedScheduledNavigation', 'Console.messagesCleared'];

class RpcMessageHandler {
  constructor(specialHandlers, isTargetBased = false) {
    this.setHandlers();
    this.errorHandlers = {};
    this.specialHandlers = _lodash.default.clone(specialHandlers);
    this.dataHandlers = {};
    this.willNavigateWithoutReload = false;
    this.isTargetBased = isTargetBased;
  }

  setCommunicationProtocol(isTargetBased) {
    this.isTargetBased = isTargetBased;
  }

  setDataMessageHandler(key, errorHandler, handler) {
    this.errorHandlers[key] = errorHandler;
    this.dataHandlers[key] = handler;
  }

  setSpecialMessageHandler(key, errorHandler, handler) {
    this.errorHandlers[key] = errorHandler;
    this.specialHandlers[key] = handler;
  }

  getSpecialMessageHandler(key) {
    return this.specialHandlers[key];
  }

  setTimelineEventHandler(timelineEventHandler) {
    this.timelineEventHandler = timelineEventHandler;
  }

  setConsoleLogEventHandler(consoleLogEventHandler) {
    this.consoleLogEventHandler = consoleLogEventHandler;
  }

  setNetworkEventHandler(networkLogEventHandler) {
    this.networkLogEventHandler = networkLogEventHandler;
  }

  hasErrorHandler(key) {
    return _lodash.default.has(this.errorHandlers, key);
  }

  hasSpecialMessageHandler(key) {
    return _lodash.default.has(this.specialHandlers, key);
  }

  allowNavigationWithoutReload(allow = true) {
    this.willNavigateWithoutReload = allow;
  }

  async handleMessage(plist) {
    const selector = plist.__selector;

    if (!selector) {
      _logger.default.debug('Got an invalid plist');

      return;
    }

    if (_lodash.default.has(this.handlers, selector)) {
      await this.handlers[selector](plist);
    } else {
      _logger.default.debug(`Debugger got a message for '${selector}' and have no ` + `handler, doing nothing.`);
    }
  }

  async handleSpecialMessage(handler, ...args) {
    const fn = this.specialHandlers[handler];

    if (fn) {
      if (handler !== '_rpc_forwardGetListing:' && handler !== '_rpc_applicationDisconnected:' && handler !== '_rpc_applicationConnected:' && handler !== '_rpc_applicationUpdated:' && handler !== '_rpc_reportConnectedDriverList:') {
        this.specialHandlers[handler] = null;
      }

      await fn(...args);
    } else {
      _logger.default.warn(`Tried to access special message handler '${handler}' ` + `but none was found`);
    }
  }

  parseDataKey(plist) {
    try {
      return JSON.parse(plist.__argument.WIRMessageDataKey.toString('utf8'));
    } catch (err) {
      _logger.default.error(`Unparseable message data: ${_lodash.default.truncate(JSON.stringify(plist), {
        length: 100
      })}`);

      throw new Error(`Unable to parse message data: ${err.message}`);
    }
  }

  async dispatchDataMessage(msgId, method, params, result, error) {
    if (!_lodash.default.isEmpty(msgId)) {
      _logger.default.debug(`Handling message (id: '${msgId}')`);
    }

    if (method === 'Profiler.resetProfiles') {
      _logger.default.debug('Device is telling us to reset profiles. Should probably ' + 'do some kind of callback here');
    } else if (method === 'Page.frameNavigated') {
      if (!this.willNavigateWithoutReload && !this.pageLoading) {
        if (_lodash.default.isFunction(this.specialHandlers['Page.frameNavigated'])) {
          await this.specialHandlers['Page.frameNavigated']('remote-debugger');
          this.specialHandlers['Page.frameNavigated'] = null;
        }
      } else {
        _logger.default.debug('Frame navigated but we were warned about it, not ' + 'considering page state unloaded');

        this.willNavigateWithoutReload = false;
      }
    } else if (IGNORED_EVENTS.includes(method)) {} else if (method === 'Page.loadEventFired' && _lodash.default.isFunction(this.specialHandlers.pageLoad)) {
      await this.specialHandlers.pageLoad();
    } else if (method === 'Page.frameDetached' && _lodash.default.isFunction(this.specialHandlers.frameDetached)) {
      await this.specialHandlers.frameDetached();
    } else if (method === 'Timeline.eventRecorded' && _lodash.default.isFunction(this.timelineEventHandler)) {
      this.timelineEventHandler(params || params.record);
    } else if (method === 'Console.messageAdded' && _lodash.default.isFunction(this.consoleLogEventHandler)) {
      this.consoleLogEventHandler(params.message);
    } else if (method && method.startsWith('Network.') && _lodash.default.isFunction(this.networkLogEventHandler)) {
      this.networkLogEventHandler(method, params);
    } else if (_lodash.default.isFunction(this.dataHandlers[msgId])) {
      if (result.result && result.result.value) {
        result = result.result.value;
      }

      this.dataHandlers[msgId](result);
      this.dataHandlers[msgId] = null;
    } else if (this.dataHandlers[msgId] === null) {
      _logger.default.error(`Debugger returned data for message ${msgId} ` + `but we already ran that callback! WTF??`);
    } else {
      if (msgId || result || error) {
        _logger.default.error(`Debugger returned data for message '${msgId}' ` + `but we were not waiting for that message! ` + `result: '${JSON.stringify(result)}'; ` + `error: '${error}'`);
      }
    }
  }

  logFullMessage(plist) {
    const bufferToJSON = Buffer.prototype.toJSON;
    delete Buffer.prototype.toJSON;

    try {
      (0, _logger.default)(JSON.stringify(plist, (k, v) => Buffer.isBuffer(v) ? v.toString('utf8') : v, 2));
    } finally {
      Buffer.prototype.toJSON = bufferToJSON;
    }
  }

  async handleDataMessage(plist) {
    const dataKey = this.parseDataKey(plist);
    let msgId = (dataKey.id || '').toString();
    let result = dataKey.result;
    let method = dataKey.method;
    let params;

    if (this.isTargetBased) {
      if (method === 'Target.targetCreated') {
        const app = plist.__argument.WIRApplicationIdentifierKey;
        const targetInfo = dataKey.params.targetInfo;
        await this.specialHandlers.targetCreated(app, targetInfo);
        return;
      }

      if (method === 'Target.targetDestroyed') {
        const app = plist.__argument.WIRApplicationIdentifierKey;
        const targetInfo = dataKey.params.targetInfo;
        await this.specialHandlers.targetDestroyed(app, targetInfo);
        return;
      } else if (dataKey.method !== 'Target.dispatchMessageFromTarget') {
        return;
      }

      let message;

      try {
        message = JSON.parse(dataKey.params.message);
        msgId = message.id;
        method = message.method;
        result = message.result || message;
        params = result.params;
      } catch (err) {
        _logger.default.error(`Unexpected message format from Web Inspector:`);

        this.logFullMessage(plist);
        throw err;
      }
    } else {
      params = dataKey.params;
    }

    let error = dataKey.error || null;

    if (result && result.wasThrown) {
      const message = result.result && (result.result.value || result.result.description) ? result.result.value || result.result.description : 'Error occurred in handling data message';
      error = new Error(message);
    }

    if (!error) {
      if (!_lodash.default.isEmpty(msgId)) {
        _logger.default.debug(`Received response for message '${msgId}'`);
      }

      return await this.dispatchDataMessage(msgId, method, params, result, error);
    }

    if (this.hasErrorHandler(msgId)) {
      this.errorHandlers[msgId](error);
    } else {
      _logger.default.error(`Error occurred in handling data message: ${error}`);

      _logger.default.error('No error handler present, ignoring');
    }
  }

  setHandlers() {
    this.handlers = {
      '_rpc_reportSetup:': async plist => {
        await this.handleSpecialMessage('_rpc_reportIdentifier:', plist.__argument.WIRSimulatorNameKey, plist.__argument.WIRSimulatorBuildKey, plist.__argument.WIRSimulatorProductVersionKey);
      },
      '_rpc_reportConnectedApplicationList:': async plist => {
        await this.handleSpecialMessage('_rpc_reportConnectedApplicationList:', plist.__argument.WIRApplicationDictionaryKey);
      },
      '_rpc_applicationSentListing:': async plist => {
        await this.handleSpecialMessage('_rpc_forwardGetListing:', plist.__argument.WIRApplicationIdentifierKey, plist.__argument.WIRListingKey);
      },
      '_rpc_applicationConnected:': async plist => {
        await this.handleSpecialMessage('_rpc_applicationConnected:', plist.__argument);
      },
      '_rpc_applicationDisconnected:': async plist => {
        await this.handleSpecialMessage('_rpc_applicationDisconnected:', plist.__argument);
      },
      '_rpc_applicationUpdated:': async plist => {
        await this.handleSpecialMessage('_rpc_applicationUpdated:', plist.__argument);
      },
      '_rpc_reportConnectedDriverList:': async plist => {
        await this.handleSpecialMessage('_rpc_reportConnectedDriverList:', plist.__argument);
      },
      '_rpc_applicationSentData:': async plist => {
        await this.handleDataMessage(plist);
      }
    };
  }

}

exports.default = RpcMessageHandler;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtZGVidWdnZXItbWVzc2FnZS1oYW5kbGVyLmpzIl0sIm5hbWVzIjpbIklHTk9SRURfRVZFTlRTIiwiUnBjTWVzc2FnZUhhbmRsZXIiLCJjb25zdHJ1Y3RvciIsInNwZWNpYWxIYW5kbGVycyIsImlzVGFyZ2V0QmFzZWQiLCJzZXRIYW5kbGVycyIsImVycm9ySGFuZGxlcnMiLCJfIiwiY2xvbmUiLCJkYXRhSGFuZGxlcnMiLCJ3aWxsTmF2aWdhdGVXaXRob3V0UmVsb2FkIiwic2V0Q29tbXVuaWNhdGlvblByb3RvY29sIiwic2V0RGF0YU1lc3NhZ2VIYW5kbGVyIiwia2V5IiwiZXJyb3JIYW5kbGVyIiwiaGFuZGxlciIsInNldFNwZWNpYWxNZXNzYWdlSGFuZGxlciIsImdldFNwZWNpYWxNZXNzYWdlSGFuZGxlciIsInNldFRpbWVsaW5lRXZlbnRIYW5kbGVyIiwidGltZWxpbmVFdmVudEhhbmRsZXIiLCJzZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyIiwiY29uc29sZUxvZ0V2ZW50SGFuZGxlciIsInNldE5ldHdvcmtFdmVudEhhbmRsZXIiLCJuZXR3b3JrTG9nRXZlbnRIYW5kbGVyIiwiaGFzRXJyb3JIYW5kbGVyIiwiaGFzIiwiaGFzU3BlY2lhbE1lc3NhZ2VIYW5kbGVyIiwiYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZCIsImFsbG93IiwiaGFuZGxlTWVzc2FnZSIsInBsaXN0Iiwic2VsZWN0b3IiLCJfX3NlbGVjdG9yIiwibG9nIiwiZGVidWciLCJoYW5kbGVycyIsImhhbmRsZVNwZWNpYWxNZXNzYWdlIiwiYXJncyIsImZuIiwid2FybiIsInBhcnNlRGF0YUtleSIsIkpTT04iLCJwYXJzZSIsIl9fYXJndW1lbnQiLCJXSVJNZXNzYWdlRGF0YUtleSIsInRvU3RyaW5nIiwiZXJyIiwiZXJyb3IiLCJ0cnVuY2F0ZSIsInN0cmluZ2lmeSIsImxlbmd0aCIsIkVycm9yIiwibWVzc2FnZSIsImRpc3BhdGNoRGF0YU1lc3NhZ2UiLCJtc2dJZCIsIm1ldGhvZCIsInBhcmFtcyIsInJlc3VsdCIsImlzRW1wdHkiLCJwYWdlTG9hZGluZyIsImlzRnVuY3Rpb24iLCJpbmNsdWRlcyIsInBhZ2VMb2FkIiwiZnJhbWVEZXRhY2hlZCIsInJlY29yZCIsInN0YXJ0c1dpdGgiLCJ2YWx1ZSIsImxvZ0Z1bGxNZXNzYWdlIiwiYnVmZmVyVG9KU09OIiwiQnVmZmVyIiwicHJvdG90eXBlIiwidG9KU09OIiwiayIsInYiLCJpc0J1ZmZlciIsImhhbmRsZURhdGFNZXNzYWdlIiwiZGF0YUtleSIsImlkIiwiYXBwIiwiV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5IiwidGFyZ2V0SW5mbyIsInRhcmdldENyZWF0ZWQiLCJ0YXJnZXREZXN0cm95ZWQiLCJ3YXNUaHJvd24iLCJkZXNjcmlwdGlvbiIsIldJUlNpbXVsYXRvck5hbWVLZXkiLCJXSVJTaW11bGF0b3JCdWlsZEtleSIsIldJUlNpbXVsYXRvclByb2R1Y3RWZXJzaW9uS2V5IiwiV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5IiwiV0lSTGlzdGluZ0tleSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFLQSxNQUFNQSxjQUFjLEdBQUcsQ0FDckIsaUNBRHFCLEVBRXJCLDJCQUZxQixFQUdyQiwwQkFIcUIsRUFJckIsMEJBSnFCLEVBS3JCLCtCQUxxQixFQU1yQixzQ0FOcUIsRUFPckIseUJBUHFCLENBQXZCOztBQVVlLE1BQU1DLGlCQUFOLENBQXdCO0FBQ3JDQyxFQUFBQSxXQUFXLENBQUVDLGVBQUYsRUFBbUJDLGFBQWEsR0FBRyxLQUFuQyxFQUEwQztBQUNuRCxTQUFLQyxXQUFMO0FBQ0EsU0FBS0MsYUFBTCxHQUFxQixFQUFyQjtBQUNBLFNBQUtILGVBQUwsR0FBdUJJLGdCQUFFQyxLQUFGLENBQVFMLGVBQVIsQ0FBdkI7QUFDQSxTQUFLTSxZQUFMLEdBQW9CLEVBQXBCO0FBQ0EsU0FBS0MseUJBQUwsR0FBaUMsS0FBakM7QUFFQSxTQUFLTixhQUFMLEdBQXFCQSxh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S0FBUCxJQUFpQjtBQUNoRCxjQUFNLEtBQUtNLG9CQUFMLENBQTBCLCtCQUExQixFQUNKTixLQUFLLENBQUNhLFVBREYsQ0FBTjtBQUVELE9BdkJhO0FBd0JkLGtDQUE0QixNQUFPYixLQUFQLElBQWlCO0FBQzNDLGNBQU0sS0FBS00sb0JBQUwsQ0FBMEIsMEJBQTFCLEVBQ0pOLEtBQUssQ0FBQ2EsVUFERixDQUFOO0FBRUQsT0EzQmE7QUE0QmQseUNBQW1DLE1BQU9iLEtBQVAsSUFBaUI7QUFDbEQsY0FBTSxLQUFLTSxvQkFBTCxDQUEwQixpQ0FBMUIsRUFDSk4sS0FBSyxDQUFDYSxVQURGLENBQU47QUFFRCxPQS9CYTtBQWdDZCxtQ0FBNkIsTUFBT2IsS0FBUCxJQUFpQjtBQUM1QyxjQUFNLEtBQUs2QyxpQkFBTCxDQUF1QjdDLEtBQXZCLENBQU47QUFDRDtBQWxDYSxLQUFoQjtBQW9DRDs7QUE5UW9DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5cbi8vIHdlIHdpbGwgcmVjZWl2ZSBldmVudHMgdGhhdCB3ZSBkbyBub3QgbGlzdGVuIHRvLlxuLy8gaWYgd2Ugc3RhcnQgdG8gbGlzdGVuIHRvIG9uZSBvZiB0aGVzZSwgcmVtb3ZlIGl0IGZyb20gdGhlIGxpc3RcbmNvbnN0IElHTk9SRURfRVZFTlRTID0gW1xuICAnUGFnZS5kZWZhdWx0QXBwZWFyYW5jZURpZENoYW5nZScsXG4gICdQYWdlLmRvbUNvbnRlbnRFdmVudEZpcmVkJyxcbiAgJ1BhZ2UuZnJhbWVTdGFydGVkTG9hZGluZycsXG4gICdQYWdlLmZyYW1lU3RvcHBlZExvYWRpbmcnLFxuICAnUGFnZS5mcmFtZVNjaGVkdWxlZE5hdmlnYXRpb24nLFxuICAnUGFnZS5mcmFtZUNsZWFyZWRTY2hlZHVsZWROYXZpZ2F0aW9uJyxcbiAgJ0NvbnNvbGUubWVzc2FnZXNDbGVhcmVkJyxcbl07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJwY01lc3NhZ2VIYW5kbGVyIHtcbiAgY29uc3RydWN0b3IgKHNwZWNpYWxIYW5kbGVycywgaXNUYXJnZXRCYXNlZCA9IGZhbHNlKSB7XG4gICAgdGhpcy5zZXRIYW5kbGVycygpO1xuICAgIHRoaXMuZXJyb3JIYW5kbGVycyA9IHt9O1xuICAgIHRoaXMuc3BlY2lhbEhhbmRsZXJzID0gXy5jbG9uZShzcGVjaWFsSGFuZGxlcnMpO1xuICAgIHRoaXMuZGF0YUhhbmRsZXJzID0ge307XG4gICAgdGhpcy53aWxsTmF2aWdhdGVXaXRob3V0UmVsb2FkID0gZmFsc2U7XG5cbiAgICB0aGlzLmlzVGFyZ2V0QmFzZWQgPSBpc1RhcmdldEJhc2VkO1xuICB9XG5cbiAgc2V0Q29tbXVuaWNhdGlvblByb3RvY29sIChpc1RhcmdldEJhc2VkKSB7XG4gICAgdGhpcy5pc1RhcmdldEJhc2VkID0gaXNUYXJnZXRCYXNlZDtcbiAgfVxuXG4gIHNldERhdGFNZXNzYWdlSGFuZGxlciAoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpIHtcbiAgICB0aGlzLmVycm9ySGFuZGxlcnNba2V5XSA9IGVycm9ySGFuZGxlcjtcbiAgICB0aGlzLmRhdGFIYW5kbGVyc1trZXldID0gaGFuZGxlcjtcbiAgfVxuXG4gIHNldFNwZWNpYWxNZXNzYWdlSGFuZGxlciAoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpIHtcbiAgICB0aGlzLmVycm9ySGFuZGxlcnNba2V5XSA9IGVycm9ySGFuZGxlcjtcbiAgICB0aGlzLnNwZWNpYWxIYW5kbGVyc1trZXldID0gaGFuZGxlcjtcbiAgfVxuXG4gIGdldFNwZWNpYWxNZXNzYWdlSGFuZGxlciAoa2V5KSB7XG4gICAgcmV0dXJuIHRoaXMuc3BlY2lhbEhhbmRsZXJzW2tleV07XG4gIH1cblxuICBzZXRUaW1lbGluZUV2ZW50SGFuZGxlciAodGltZWxpbmVFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyID0gdGltZWxpbmVFdmVudEhhbmRsZXI7XG4gIH1cblxuICBzZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyIChjb25zb2xlTG9nRXZlbnRIYW5kbGVyKSB7XG4gICAgdGhpcy5jb25zb2xlTG9nRXZlbnRIYW5kbGVyID0gY29uc29sZUxvZ0V2ZW50SGFuZGxlcjtcbiAgfVxuXG4gIHNldE5ldHdvcmtFdmVudEhhbmRsZXIgKG5ldHdvcmtMb2dFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLm5ldHdvcmtMb2dFdmVudEhhbmRsZXIgPSBuZXR3b3JrTG9nRXZlbnRIYW5kbGVyO1xuICB9XG5cbiAgaGFzRXJyb3JIYW5kbGVyIChrZXkpIHtcbiAgICByZXR1cm4gXy5oYXModGhpcy5lcnJvckhhbmRsZXJzLCBrZXkpO1xuICB9XG5cbiAgaGFzU3BlY2lhbE1lc3NhZ2VIYW5kbGVyIChrZXkpIHtcbiAgICByZXR1cm4gXy5oYXModGhpcy5zcGVjaWFsSGFuZGxlcnMsIGtleSk7XG4gIH1cblxuICBhbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkIChhbGxvdyA9IHRydWUpIHtcbiAgICB0aGlzLndpbGxOYXZpZ2F0ZVdpdGhvdXRSZWxvYWQgPSBhbGxvdztcbiAgfVxuXG4gIGFzeW5jIGhhbmRsZU1lc3NhZ2UgKHBsaXN0KSB7XG4gICAgY29uc3Qgc2VsZWN0b3IgPSBwbGlzdC5fX3NlbGVjdG9yO1xuICAgIGlmICghc2VsZWN0b3IpIHtcbiAgICAgIGxvZy5kZWJ1ZygnR290IGFuIGludmFsaWQgcGxpc3QnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoXy5oYXModGhpcy5oYW5kbGVycywgc2VsZWN0b3IpKSB7XG4gICAgICBhd2FpdCB0aGlzLmhhbmRsZXJzW3NlbGVjdG9yXShwbGlzdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZyhgRGVidWdnZXIgZ290IGEgbWVzc2FnZSBmb3IgJyR7c2VsZWN0b3J9JyBhbmQgaGF2ZSBubyBgICtcbiAgICAgICAgICAgICAgICBgaGFuZGxlciwgZG9pbmcgbm90aGluZy5gKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBoYW5kbGVTcGVjaWFsTWVzc2FnZSAoaGFuZGxlciwgLi4uYXJncykge1xuICAgIGNvbnN0IGZuID0gdGhpcy5zcGVjaWFsSGFuZGxlcnNbaGFuZGxlcl07XG5cbiAgICBpZiAoZm4pIHtcbiAgICAgIC8vIG1vc3QgcmVzcG9uc2VzIGFyZSBvbmx5IHRvIGJlIGNhbGxlZCBvbmNlLCB0aGVuXG4gICAgICAvLyByZW1vdmVkLiBCdXQgbm90IHRoZSBvbmVzIGJlbG93LCB3aGljaCBoYW5kbGVcbiAgICAgIC8vIHBhZ2UgY2hhbmdlIGFuZCBhcHAgY29ubmVjdC9kaXNjb25uZWN0XG4gICAgICBpZiAoaGFuZGxlciAhPT0gJ19ycGNfZm9yd2FyZEdldExpc3Rpbmc6JyAmJlxuICAgICAgICAgIGhhbmRsZXIgIT09ICdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOicgJiZcbiAgICAgICAgICBoYW5kbGVyICE9PSAnX3JwY19hcHBsaWNhdGlvbkNvbm5lY3RlZDonICYmXG4gICAgICAgICAgaGFuZGxlciAhPT0gJ19ycGNfYXBwbGljYXRpb25VcGRhdGVkOicgJiZcbiAgICAgICAgICBoYW5kbGVyICE9PSAnX3JwY19yZXBvcnRDb25uZWN0ZWREcml2ZXJMaXN0OicpIHtcbiAgICAgICAgdGhpcy5zcGVjaWFsSGFuZGxlcnNbaGFuZGxlcl0gPSBudWxsO1xuICAgICAgfVxuICAgICAgYXdhaXQgZm4oLi4uYXJncyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy53YXJuKGBUcmllZCB0byBhY2Nlc3Mgc3BlY2lhbCBtZXNzYWdlIGhhbmRsZXIgJyR7aGFuZGxlcn0nIGAgK1xuICAgICAgICAgICAgICAgYGJ1dCBub25lIHdhcyBmb3VuZGApO1xuICAgIH1cbiAgfVxuXG4gIHBhcnNlRGF0YUtleSAocGxpc3QpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIEpTT04ucGFyc2UocGxpc3QuX19hcmd1bWVudC5XSVJNZXNzYWdlRGF0YUtleS50b1N0cmluZygndXRmOCcpKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvcihgVW5wYXJzZWFibGUgbWVzc2FnZSBkYXRhOiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkocGxpc3QpLCB7bGVuZ3RoOiAxMDB9KX1gKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIHBhcnNlIG1lc3NhZ2UgZGF0YTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkaXNwYXRjaERhdGFNZXNzYWdlIChtc2dJZCwgbWV0aG9kLCBwYXJhbXMsIHJlc3VsdCwgZXJyb3IpIHtcbiAgICBpZiAoIV8uaXNFbXB0eShtc2dJZCkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgSGFuZGxpbmcgbWVzc2FnZSAoaWQ6ICcke21zZ0lkfScpYCk7XG4gICAgfVxuICAgIGlmIChtZXRob2QgPT09ICdQcm9maWxlci5yZXNldFByb2ZpbGVzJykge1xuICAgICAgbG9nLmRlYnVnKCdEZXZpY2UgaXMgdGVsbGluZyB1cyB0byByZXNldCBwcm9maWxlcy4gU2hvdWxkIHByb2JhYmx5ICcgK1xuICAgICAgICAgICAgICAgICdkbyBzb21lIGtpbmQgb2YgY2FsbGJhY2sgaGVyZScpO1xuICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAnUGFnZS5mcmFtZU5hdmlnYXRlZCcpIHtcbiAgICAgIGlmICghdGhpcy53aWxsTmF2aWdhdGVXaXRob3V0UmVsb2FkICYmICF0aGlzLnBhZ2VMb2FkaW5nKSB7XG4gICAgICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5zcGVjaWFsSGFuZGxlcnNbJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnXSkpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnNwZWNpYWxIYW5kbGVyc1snUGFnZS5mcmFtZU5hdmlnYXRlZCddKCdyZW1vdGUtZGVidWdnZXInKTtcbiAgICAgICAgICB0aGlzLnNwZWNpYWxIYW5kbGVyc1snUGFnZS5mcmFtZU5hdmlnYXRlZCddID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmRlYnVnKCdGcmFtZSBuYXZpZ2F0ZWQgYnV0IHdlIHdlcmUgd2FybmVkIGFib3V0IGl0LCBub3QgJyArXG4gICAgICAgICAgICAgICAgICAnY29uc2lkZXJpbmcgcGFnZSBzdGF0ZSB1bmxvYWRlZCcpO1xuICAgICAgICB0aGlzLndpbGxOYXZpZ2F0ZVdpdGhvdXRSZWxvYWQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKElHTk9SRURfRVZFTlRTLmluY2x1ZGVzKG1ldGhvZCkpIHtcbiAgICAgIC8vIHBhc3NcbiAgICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gJ1BhZ2UubG9hZEV2ZW50RmlyZWQnICYmIF8uaXNGdW5jdGlvbih0aGlzLnNwZWNpYWxIYW5kbGVycy5wYWdlTG9hZCkpIHtcbiAgICAgIGF3YWl0IHRoaXMuc3BlY2lhbEhhbmRsZXJzLnBhZ2VMb2FkKCk7XG4gICAgfSBlbHNlIGlmIChtZXRob2QgPT09ICdQYWdlLmZyYW1lRGV0YWNoZWQnICYmIF8uaXNGdW5jdGlvbih0aGlzLnNwZWNpYWxIYW5kbGVycy5mcmFtZURldGFjaGVkKSkge1xuICAgICAgYXdhaXQgdGhpcy5zcGVjaWFsSGFuZGxlcnMuZnJhbWVEZXRhY2hlZCgpO1xuICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAnVGltZWxpbmUuZXZlbnRSZWNvcmRlZCcgJiYgXy5pc0Z1bmN0aW9uKHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIpKSB7XG4gICAgICB0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyKHBhcmFtcyB8fCBwYXJhbXMucmVjb3JkKTtcbiAgICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gJ0NvbnNvbGUubWVzc2FnZUFkZGVkJyAmJiBfLmlzRnVuY3Rpb24odGhpcy5jb25zb2xlTG9nRXZlbnRIYW5kbGVyKSkge1xuICAgICAgdGhpcy5jb25zb2xlTG9nRXZlbnRIYW5kbGVyKHBhcmFtcy5tZXNzYWdlKTtcbiAgICB9IGVsc2UgaWYgKG1ldGhvZCAmJiBtZXRob2Quc3RhcnRzV2l0aCgnTmV0d29yay4nKSAmJiBfLmlzRnVuY3Rpb24odGhpcy5uZXR3b3JrTG9nRXZlbnRIYW5kbGVyKSkge1xuICAgICAgdGhpcy5uZXR3b3JrTG9nRXZlbnRIYW5kbGVyKG1ldGhvZCwgcGFyYW1zKTtcbiAgICB9IGVsc2UgaWYgKF8uaXNGdW5jdGlvbih0aGlzLmRhdGFIYW5kbGVyc1ttc2dJZF0pKSB7XG4gICAgICAvLyB3ZSB3aWxsIGVpdGhlciBnZXQgYmFjayBhIHJlc3VsdCBvYmplY3QgdGhhdCBoYXMgYSByZXN1bHQudmFsdWVcbiAgICAgIC8vIGluIHdoaWNoIGNhc2UgdGhhdCBpcyB3aGF0IHdlIHdhbnQsXG4gICAgICAvLyBvciBlbHNlIHdlIHJldHVybiB0aGUgd2hvbGUgdGhpbmdcbiAgICAgIGlmIChyZXN1bHQucmVzdWx0ICYmIHJlc3VsdC5yZXN1bHQudmFsdWUpIHtcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LnJlc3VsdC52YWx1ZTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZGF0YUhhbmRsZXJzW21zZ0lkXShyZXN1bHQpO1xuICAgICAgdGhpcy5kYXRhSGFuZGxlcnNbbXNnSWRdID0gbnVsbDtcbiAgICB9IGVsc2UgaWYgKHRoaXMuZGF0YUhhbmRsZXJzW21zZ0lkXSA9PT0gbnVsbCkge1xuICAgICAgbG9nLmVycm9yKGBEZWJ1Z2dlciByZXR1cm5lZCBkYXRhIGZvciBtZXNzYWdlICR7bXNnSWR9IGAgK1xuICAgICAgICAgICAgICAgIGBidXQgd2UgYWxyZWFkeSByYW4gdGhhdCBjYWxsYmFjayEgV1RGPz9gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKG1zZ0lkIHx8IHJlc3VsdCB8fCBlcnJvcikge1xuICAgICAgICBsb2cuZXJyb3IoYERlYnVnZ2VyIHJldHVybmVkIGRhdGEgZm9yIG1lc3NhZ2UgJyR7bXNnSWR9JyBgICtcbiAgICAgICAgICAgICAgICAgIGBidXQgd2Ugd2VyZSBub3Qgd2FpdGluZyBmb3IgdGhhdCBtZXNzYWdlISBgICtcbiAgICAgICAgICAgICAgICAgIGByZXN1bHQ6ICcke0pTT04uc3RyaW5naWZ5KHJlc3VsdCl9JzsgYCArXG4gICAgICAgICAgICAgICAgICBgZXJyb3I6ICcke2Vycm9yfSdgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBsb2dGdWxsTWVzc2FnZSAocGxpc3QpIHtcbiAgICAvLyBCdWZmZXJzIGNhbm5vdCBiZSBzZXJpYWxpemVkIGluIGEgcmVhZGFibGUgd2F5XG4gICAgY29uc3QgYnVmZmVyVG9KU09OID0gQnVmZmVyLnByb3RvdHlwZS50b0pTT047XG4gICAgZGVsZXRlIEJ1ZmZlci5wcm90b3R5cGUudG9KU09OO1xuICAgIHRyeSB7XG4gICAgICBsb2coSlNPTi5zdHJpbmdpZnkocGxpc3QsIChrLCB2KSA9PiBCdWZmZXIuaXNCdWZmZXIodikgPyB2LnRvU3RyaW5nKCd1dGY4JykgOiB2LCAyKSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIC8vIHJlc3RvcmUgdGhlIGZ1bmN0aW9uLCBzbyBhcyB0byBub3QgYnJlYWsgZnVydGhlciBzZXJpYWxpemF0aW9uXG4gICAgICBCdWZmZXIucHJvdG90eXBlLnRvSlNPTiA9IGJ1ZmZlclRvSlNPTjtcbiAgICB9XG4gIH1cblxuICBhc3luYyBoYW5kbGVEYXRhTWVzc2FnZSAocGxpc3QpIHtcbiAgICBjb25zdCBkYXRhS2V5ID0gdGhpcy5wYXJzZURhdGFLZXkocGxpc3QpO1xuICAgIGxldCBtc2dJZCA9IChkYXRhS2V5LmlkIHx8ICcnKS50b1N0cmluZygpO1xuICAgIGxldCByZXN1bHQgPSBkYXRhS2V5LnJlc3VsdDtcblxuICAgIGxldCBtZXRob2QgPSBkYXRhS2V5Lm1ldGhvZDtcbiAgICBsZXQgcGFyYW1zO1xuICAgIGlmICh0aGlzLmlzVGFyZ2V0QmFzZWQpIHtcbiAgICAgIGlmIChtZXRob2QgPT09ICdUYXJnZXQudGFyZ2V0Q3JlYXRlZCcpIHtcbiAgICAgICAgLy8gdGhpcyBpcyBpbiByZXNwb25zZSB0byBhIGBfcnBjX2ZvcndhcmRTb2NrZXRTZXR1cDpgIGNhbGxcbiAgICAgICAgLy8gdGFyZ2V0SW5mbzogeyB0YXJnZXRJZDogJ3BhZ2UtMScsIHR5cGU6ICdwYWdlJyB9XG4gICAgICAgIGNvbnN0IGFwcCA9IHBsaXN0Ll9fYXJndW1lbnQuV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5O1xuICAgICAgICBjb25zdCB0YXJnZXRJbmZvID0gZGF0YUtleS5wYXJhbXMudGFyZ2V0SW5mbztcbiAgICAgICAgYXdhaXQgdGhpcy5zcGVjaWFsSGFuZGxlcnMudGFyZ2V0Q3JlYXRlZChhcHAsIHRhcmdldEluZm8pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9IGlmIChtZXRob2QgPT09ICdUYXJnZXQudGFyZ2V0RGVzdHJveWVkJykge1xuICAgICAgICBjb25zdCBhcHAgPSBwbGlzdC5fX2FyZ3VtZW50LldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTtcbiAgICAgICAgY29uc3QgdGFyZ2V0SW5mbyA9IGRhdGFLZXkucGFyYW1zLnRhcmdldEluZm87XG4gICAgICAgIGF3YWl0IHRoaXMuc3BlY2lhbEhhbmRsZXJzLnRhcmdldERlc3Ryb3llZChhcHAsIHRhcmdldEluZm8pO1xuICAgICAgICByZXR1cm47XG4gICAgICB9IGVsc2UgaWYgKGRhdGFLZXkubWV0aG9kICE9PSAnVGFyZ2V0LmRpc3BhdGNoTWVzc2FnZUZyb21UYXJnZXQnKSB7XG4gICAgICAgIC8vIHRoaXMgc29ydCBvZiBtZXNzYWdlLCBhdCB0aGlzIHBvaW50LCBpcyBqdXN0IGFuIGFja25vd2xlZGdlbWVudFxuICAgICAgICAvLyB0aGF0IHRoZSBvcmlnaW5hbCBtZXNzYWdlIHdhcyByZWNlaXZlZFxuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIHdlIGhhdmUgYSBUYXJnZXQtYmFzZWQgbWVzc2FnZSB3cmFwcGluZyBhIHByb3RvY29sIG1lc3NhZ2VcbiAgICAgIGxldCBtZXNzYWdlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgbWVzc2FnZSA9IEpTT04ucGFyc2UoZGF0YUtleS5wYXJhbXMubWVzc2FnZSk7XG4gICAgICAgIG1zZ0lkID0gbWVzc2FnZS5pZDtcbiAgICAgICAgbWV0aG9kID0gbWVzc2FnZS5tZXRob2Q7XG4gICAgICAgIHJlc3VsdCA9IG1lc3NhZ2UucmVzdWx0IHx8IG1lc3NhZ2U7XG4gICAgICAgIHBhcmFtcyA9IHJlc3VsdC5wYXJhbXM7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLy8gaWYgdGhpcyBoYXBwZW5zIHRoZW4gc29tZSBhc3BlY3Qgb2YgdGhlIHByb3RvY29sIGlzIG1pc3NpbmcgdG8gdXNcbiAgICAgICAgLy8gc28gcHJpbnQgdGhlIGVudGlyZSBtZXNzYWdlIHRvIGdldCB2aXNpYmlpdHkgaW50byB3aGF0IGlzIGdvaW5nIG9uXG4gICAgICAgIGxvZy5lcnJvcihgVW5leHBlY3RlZCBtZXNzYWdlIGZvcm1hdCBmcm9tIFdlYiBJbnNwZWN0b3I6YCk7XG4gICAgICAgIHRoaXMubG9nRnVsbE1lc3NhZ2UocGxpc3QpO1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtcyA9IGRhdGFLZXkucGFyYW1zO1xuICAgIH1cblxuICAgIC8vIHdlIGNhbiBnZXQgYW4gZXJyb3IsIG9yIHdlIGNhbiBnZXQgYSByZXNwb25zZSB0aGF0IGlzIGFuIGVycm9yXG4gICAgbGV0IGVycm9yID0gZGF0YUtleS5lcnJvciB8fCBudWxsO1xuICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0Lndhc1Rocm93bikge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IChyZXN1bHQucmVzdWx0ICYmIChyZXN1bHQucmVzdWx0LnZhbHVlIHx8IHJlc3VsdC5yZXN1bHQuZGVzY3JpcHRpb24pKVxuICAgICAgICA/IChyZXN1bHQucmVzdWx0LnZhbHVlIHx8IHJlc3VsdC5yZXN1bHQuZGVzY3JpcHRpb24pXG4gICAgICAgIDogJ0Vycm9yIG9jY3VycmVkIGluIGhhbmRsaW5nIGRhdGEgbWVzc2FnZSc7XG4gICAgICBlcnJvciA9IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgICB9XG5cbiAgICBpZiAoIWVycm9yKSB7XG4gICAgICBpZiAoIV8uaXNFbXB0eShtc2dJZCkpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCByZXNwb25zZSBmb3IgbWVzc2FnZSAnJHttc2dJZH0nYCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmRpc3BhdGNoRGF0YU1lc3NhZ2UobXNnSWQsIG1ldGhvZCwgcGFyYW1zLCByZXN1bHQsIGVycm9yKTtcbiAgICB9XG5cbiAgICAvLyBoYW5kbGUgdGhlIGVycm9yXG4gICAgaWYgKHRoaXMuaGFzRXJyb3JIYW5kbGVyKG1zZ0lkKSkge1xuICAgICAgdGhpcy5lcnJvckhhbmRsZXJzW21zZ0lkXShlcnJvcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5lcnJvcihgRXJyb3Igb2NjdXJyZWQgaW4gaGFuZGxpbmcgZGF0YSBtZXNzYWdlOiAke2Vycm9yfWApO1xuICAgICAgbG9nLmVycm9yKCdObyBlcnJvciBoYW5kbGVyIHByZXNlbnQsIGlnbm9yaW5nJyk7XG4gICAgfVxuICB9XG5cbiAgc2V0SGFuZGxlcnMgKCkge1xuICAgIHRoaXMuaGFuZGxlcnMgPSB7XG4gICAgICAnX3JwY19yZXBvcnRTZXR1cDonOiBhc3luYyAocGxpc3QpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5oYW5kbGVTcGVjaWFsTWVzc2FnZSgnX3JwY19yZXBvcnRJZGVudGlmaWVyOicsXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJTaW11bGF0b3JOYW1lS2V5LFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQuV0lSU2ltdWxhdG9yQnVpbGRLZXksXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJTaW11bGF0b3JQcm9kdWN0VmVyc2lvbktleSk7XG4gICAgICB9LFxuICAgICAgJ19ycGNfcmVwb3J0Q29ubmVjdGVkQXBwbGljYXRpb25MaXN0Oic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX3JlcG9ydENvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdDonLFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQuV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5KTtcbiAgICAgIH0sXG4gICAgICAnX3JwY19hcHBsaWNhdGlvblNlbnRMaXN0aW5nOic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX2ZvcndhcmRHZXRMaXN0aW5nOicsXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXksXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJMaXN0aW5nS2V5KTtcbiAgICAgIH0sXG4gICAgICAnX3JwY19hcHBsaWNhdGlvbkNvbm5lY3RlZDonOiBhc3luYyAocGxpc3QpID0+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5oYW5kbGVTcGVjaWFsTWVzc2FnZSgnX3JwY19hcHBsaWNhdGlvbkNvbm5lY3RlZDonLFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOicsXG4gICAgICAgICAgcGxpc3QuX19hcmd1bWVudCk7XG4gICAgICB9LFxuICAgICAgJ19ycGNfYXBwbGljYXRpb25VcGRhdGVkOic6IGFzeW5jIChwbGlzdCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX2FwcGxpY2F0aW9uVXBkYXRlZDonLFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX3JlcG9ydENvbm5lY3RlZERyaXZlckxpc3Q6JzogYXN5bmMgKHBsaXN0KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlU3BlY2lhbE1lc3NhZ2UoJ19ycGNfcmVwb3J0Q29ubmVjdGVkRHJpdmVyTGlzdDonLFxuICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX2FwcGxpY2F0aW9uU2VudERhdGE6JzogYXN5bmMgKHBsaXN0KSA9PiB7XG4gICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlRGF0YU1lc3NhZ2UocGxpc3QpO1xuICAgICAgfSxcbiAgICB9O1xuICB9XG59XG4iXSwiZmlsZSI6ImxpYi9yZW1vdGUtZGVidWdnZXItbWVzc2FnZS1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
