"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _remoteDebugger = require("./remote-debugger");

var _helpers = require("./helpers");

var _lodash = _interopRequireDefault(require("lodash"));

function onPageChange(appIdKey, pageDict) {
  if (_lodash.default.isEmpty(pageDict)) {
    return;
  }

  const pageArray = (0, _helpers.pageArrayFromDict)(pageDict);

  if (this.appDict[appIdKey]) {
    if (this.appDict[appIdKey].pageArray) {
      if (this.appDict[appIdKey].pageArray.resolve) {
        this.appDict[appIdKey].pageArray.resolve();
      } else {
        if (_lodash.default.isEqual(this.appDict[appIdKey].pageArray, pageArray)) {
          _logger.default.debug(`Received page change notice for app '${appIdKey}' ` + `but the listing has not changed. Ignoring.`);

          return;
        }
      }
    }

    this.appDict[appIdKey].pageArray = pageArray;
  }

  if (this._navigatingToPage) {
    return;
  }

  this.logApplicationDictionary(this.appDict);

  _logger.default.debug(`Page changed: ${(0, _helpers.simpleStringify)(pageDict, true)}`);

  if (this.appIdKey !== appIdKey) {
    _logger.default.debug(`Received page change notice for app '${appIdKey}' ` + `but listening for '${this.appIdKey}'. Ignoring.`);

    return;
  }

  this.emit(_remoteDebugger.RemoteDebugger.EVENT_PAGE_CHANGE, {
    appIdKey: appIdKey.replace('PID:', ''),
    pageArray
  });
}

function onAppConnect(dict) {
  let appIdKey = dict.WIRApplicationIdentifierKey;

  _logger.default.debug(`Notified that new application '${appIdKey}' has connected`);

  this.updateAppsWithDict(dict);
}

function onAppDisconnect(dict) {
  let appIdKey = dict.WIRApplicationIdentifierKey;

  _logger.default.debug(`Application '${appIdKey}' disconnected. Removing from app dictionary.`);

  _logger.default.debug(`Current app is ${this.appIdKey}`);

  delete this.appDict[appIdKey];

  if (this.appIdKey === appIdKey) {
    _logger.default.debug(`No longer have app id. Attempting to find new one.`);

    this.appIdKey = (0, _helpers.getDebuggerAppKey)(this.bundleId, this.platformVersion, this.appDict);
  }

  if (!this.appDict) {
    _logger.default.debug('Main app disconnected. Disconnecting altogether.');

    this.connected = false;
    this.emit(_remoteDebugger.RemoteDebugger.EVENT_DISCONNECT, true);
  }
}

function onAppUpdate(dict) {
  this.updateAppsWithDict(dict);
}

function onTargetCreated(app, targetInfo) {
  this.rpcClient.addTarget(targetInfo);
}

function onTargetDestroyed(app, targetInfo) {
  this.rpcClient.removeTarget(targetInfo);
}

const messageHandlers = {
  onPageChange,
  onAppConnect,
  onAppDisconnect,
  onAppUpdate,
  onTargetCreated,
  onTargetDestroyed
};
var _default = messageHandlers;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9tZXNzYWdlLWhhbmRsZXJzLmpzIl0sIm5hbWVzIjpbIm9uUGFnZUNoYW5nZSIsImFwcElkS2V5IiwicGFnZURpY3QiLCJfIiwiaXNFbXB0eSIsInBhZ2VBcnJheSIsImFwcERpY3QiLCJyZXNvbHZlIiwiaXNFcXVhbCIsImxvZyIsImRlYnVnIiwiX25hdmlnYXRpbmdUb1BhZ2UiLCJsb2dBcHBsaWNhdGlvbkRpY3Rpb25hcnkiLCJlbWl0IiwiUmVtb3RlRGVidWdnZXIiLCJFVkVOVF9QQUdFX0NIQU5HRSIsInJlcGxhY2UiLCJvbkFwcENvbm5lY3QiLCJkaWN0IiwiV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5IiwidXBkYXRlQXBwc1dpdGhEaWN0Iiwib25BcHBEaXNjb25uZWN0IiwiYnVuZGxlSWQiLCJwbGF0Zm9ybVZlcnNpb24iLCJjb25uZWN0ZWQiLCJFVkVOVF9ESVNDT05ORUNUIiwib25BcHBVcGRhdGUiLCJvblRhcmdldENyZWF0ZWQiLCJhcHAiLCJ0YXJnZXRJbmZvIiwicnBjQ2xpZW50IiwiYWRkVGFyZ2V0Iiwib25UYXJnZXREZXN0cm95ZWQiLCJyZW1vdmVUYXJnZXQiLCJtZXNzYWdlSGFuZGxlcnMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBU0EsU0FBU0EsWUFBVCxDQUF1QkMsUUFBdkIsRUFBaUNDLFFBQWpDLEVBQTJDO0FBQ3pDLE1BQUlDLGdCQUFFQyxPQUFGLENBQVVGLFFBQVYsQ0FBSixFQUF5QjtBQUN2QjtBQUNEOztBQUVELFFBQU1HLFNBQVMsR0FBRyxnQ0FBa0JILFFBQWxCLENBQWxCOztBQUdBLE1BQUksS0FBS0ksT0FBTCxDQUFhTCxRQUFiLENBQUosRUFBNEI7QUFDMUIsUUFBSSxLQUFLSyxPQUFMLENBQWFMLFFBQWIsRUFBdUJJLFNBQTNCLEVBQXNDO0FBQ3BDLFVBQUksS0FBS0MsT0FBTCxDQUFhTCxRQUFiLEVBQXVCSSxTQUF2QixDQUFpQ0UsT0FBckMsRUFB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LCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IFJlbW90ZURlYnVnZ2VyIH0gZnJvbSAnLi9yZW1vdGUtZGVidWdnZXInO1xuaW1wb3J0IHsgcGFnZUFycmF5RnJvbURpY3QsIGdldERlYnVnZ2VyQXBwS2V5LCBzaW1wbGVTdHJpbmdpZnkgfSBmcm9tICcuL2hlbHBlcnMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG4vKlxuICogR2VuZXJpYyBjYWxsYmFja3MgdXNlZCB0aHJvdWdob3V0IHRoZSBsaWZlY3ljbGUgb2YgdGhlIFJlbW90ZSBEZWJ1Z2dlci5cbiAqIFRoZXNlIHdpbGwgYmUgYWRkZWQgdG8gdGhlIHByb3RvdHlwZS5cbiAqL1xuXG5cbmZ1bmN0aW9uIG9uUGFnZUNoYW5nZSAoYXBwSWRLZXksIHBhZ2VEaWN0KSB7XG4gIGlmIChfLmlzRW1wdHkocGFnZURpY3QpKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgcGFnZUFycmF5ID0gcGFnZUFycmF5RnJvbURpY3QocGFnZURpY3QpO1xuXG4gIC8vIHNhdmUgdGhlIHBhZ2UgZGljdCBmb3IgdGhpcyBhcHBcbiAgaWYgKHRoaXMuYXBwRGljdFthcHBJZEtleV0pIHtcbiAgICBpZiAodGhpcy5hcHBEaWN0W2FwcElkS2V5XS5wYWdlQXJyYXkpIHtcbiAgICAgIGlmICh0aGlzLmFwcERpY3RbYXBwSWRLZXldLnBhZ2VBcnJheS5yZXNvbHZlKSB7XG4gICAgICAgIC8vIHBhZ2VEaWN0IGlzIGEgcGVuZGluZyBwcm9taXNlLCBzbyByZXNvbHZlXG4gICAgICAgIHRoaXMuYXBwRGljdFthcHBJZEtleV0ucGFnZUFycmF5LnJlc29sdmUoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHdlIGhhdmUgYSBwcmUtZXhpc3RpbmcgcGFnZURpY3RcbiAgICAgICAgaWYgKF8uaXNFcXVhbCh0aGlzLmFwcERpY3RbYXBwSWRLZXldLnBhZ2VBcnJheSwgcGFnZUFycmF5KSkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgcGFnZSBjaGFuZ2Ugbm90aWNlIGZvciBhcHAgJyR7YXBwSWRLZXl9JyBgICtcbiAgICAgICAgICAgICAgICAgICAgYGJ1dCB0aGUgbGlzdGluZyBoYXMgbm90IGNoYW5nZWQuIElnbm9yaW5nLmApO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICAvLyBrZWVwIHRyYWNrIG9mIHRoZSBwYWdlIGRpY3Rpb25hcnlcbiAgICB0aGlzLmFwcERpY3RbYXBwSWRLZXldLnBhZ2VBcnJheSA9IHBhZ2VBcnJheTtcbiAgfVxuXG4gIGlmICh0aGlzLl9uYXZpZ2F0aW5nVG9QYWdlKSB7XG4gICAgLy8gaW4gdGhlIG1pZGRsZSBvZiBuYXZpZ2F0aW5nLCBzbyByZXBvcnRpbmcgYSBwYWdlIGNoYW5nZSB3aWxsIGNhdXNlIHByb2JsZW1zXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgdGhpcy5sb2dBcHBsaWNhdGlvbkRpY3Rpb25hcnkodGhpcy5hcHBEaWN0KTtcblxuICBsb2cuZGVidWcoYFBhZ2UgY2hhbmdlZDogJHtzaW1wbGVTdHJpbmdpZnkocGFnZURpY3QsIHRydWUpfWApO1xuXG4gIC8vIG9ubHkgYWN0IGlmIHRoaXMgaXMgdGhlIGNvcnJlY3QgYXBwXG4gIGlmICh0aGlzLmFwcElkS2V5ICE9PSBhcHBJZEtleSkge1xuICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgcGFnZSBjaGFuZ2Ugbm90aWNlIGZvciBhcHAgJyR7YXBwSWRLZXl9JyBgICtcbiAgICAgICAgICAgICAgYGJ1dCBsaXN0ZW5pbmcgZm9yICcke3RoaXMuYXBwSWRLZXl9Jy4gSWdub3JpbmcuYCk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgdGhpcy5lbWl0KFJlbW90ZURlYnVnZ2VyLkVWRU5UX1BBR0VfQ0hBTkdFLCB7XG4gICAgYXBwSWRLZXk6IGFwcElkS2V5LnJlcGxhY2UoJ1BJRDonLCAnJyksXG4gICAgcGFnZUFycmF5LFxuICB9KTtcbn1cblxuZnVuY3Rpb24gb25BcHBDb25uZWN0IChkaWN0KSB7XG4gIGxldCBhcHBJZEtleSA9IGRpY3QuV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5O1xuICBsb2cuZGVidWcoYE5vdGlmaWVkIHRoYXQgbmV3IGFwcGxpY2F0aW9uICcke2FwcElkS2V5fScgaGFzIGNvbm5lY3RlZGApO1xuXG4gIHRoaXMudXBkYXRlQXBwc1dpdGhEaWN0KGRpY3QpO1xufVxuXG5mdW5jdGlvbiBvbkFwcERpc2Nvbm5lY3QgKGRpY3QpIHtcbiAgbGV0IGFwcElkS2V5ID0gZGljdC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG4gIGxvZy5kZWJ1ZyhgQXBwbGljYXRpb24gJyR7YXBwSWRLZXl9JyBkaXNjb25uZWN0ZWQuIFJlbW92aW5nIGZyb20gYXBwIGRpY3Rpb25hcnkuYCk7XG4gIGxvZy5kZWJ1ZyhgQ3VycmVudCBhcHAgaXMgJHt0aGlzLmFwcElkS2V5fWApO1xuXG4gIC8vIGdldCByaWQgb2YgdGhlIGVudHJ5IGluIG91ciBhcHAgZGljdGlvbmFyeSxcbiAgLy8gc2luY2UgaXQgaXMgbm8gbG9uZ2VyIGF2YWlsYWJsZVxuICBkZWxldGUgdGhpcy5hcHBEaWN0W2FwcElkS2V5XTtcblxuICAvLyBpZiB0aGUgZGlzY29ubmVjdGVkIGFwcCBpcyB0aGUgb25lIHdlIGFyZSBjb25uZWN0ZWQgdG8sIHRyeSB0byBmaW5kIGFub3RoZXJcbiAgaWYgKHRoaXMuYXBwSWRLZXkgPT09IGFwcElkS2V5KSB7XG4gICAgbG9nLmRlYnVnKGBObyBsb25nZXIgaGF2ZSBhcHAgaWQuIEF0dGVtcHRpbmcgdG8gZmluZCBuZXcgb25lLmApO1xuICAgIHRoaXMuYXBwSWRLZXkgPSBnZXREZWJ1Z2dlckFwcEtleSh0aGlzLmJ1bmRsZUlkLCB0aGlzLnBsYXRmb3JtVmVyc2lvbiwgdGhpcy5hcHBEaWN0KTtcbiAgfVxuXG4gIGlmICghdGhpcy5hcHBEaWN0KSB7XG4gICAgLy8gdGhpcyBtZWFucyB3ZSBubyBsb25nZXIgaGF2ZSBhbnkgYXBwcy4gd2hhdCB0aGUgd2hhdD9cbiAgICBsb2cuZGVidWcoJ01haW4gYXBwIGRpc2Nvbm5lY3RlZC4gRGlzY29ubmVjdGluZyBhbHRvZ2V0aGVyLicpO1xuICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gICAgdGhpcy5lbWl0KFJlbW90ZURlYnVnZ2VyLkVWRU5UX0RJU0NPTk5FQ1QsIHRydWUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIG9uQXBwVXBkYXRlIChkaWN0KSB7XG4gIHRoaXMudXBkYXRlQXBwc1dpdGhEaWN0KGRpY3QpO1xufVxuXG5mdW5jdGlvbiBvblRhcmdldENyZWF0ZWQgKGFwcCwgdGFyZ2V0SW5mbykge1xuICB0aGlzLnJwY0NsaWVudC5hZGRUYXJnZXQodGFyZ2V0SW5mbyk7XG59XG5cbmZ1bmN0aW9uIG9uVGFyZ2V0RGVzdHJveWVkIChhcHAsIHRhcmdldEluZm8pIHtcbiAgdGhpcy5ycGNDbGllbnQucmVtb3ZlVGFyZ2V0KHRhcmdldEluZm8pO1xufVxuXG5jb25zdCBtZXNzYWdlSGFuZGxlcnMgPSB7XG4gIG9uUGFnZUNoYW5nZSxcbiAgb25BcHBDb25uZWN0LFxuICBvbkFwcERpc2Nvbm5lY3QsXG4gIG9uQXBwVXBkYXRlLFxuICBvblRhcmdldENyZWF0ZWQsXG4gIG9uVGFyZ2V0RGVzdHJveWVkLFxufTtcblxuZXhwb3J0IGRlZmF1bHQgbWVzc2FnZUhhbmRsZXJzO1xuIl0sImZpbGUiOiJsaWIvbWVzc2FnZS1oYW5kbGVycy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
