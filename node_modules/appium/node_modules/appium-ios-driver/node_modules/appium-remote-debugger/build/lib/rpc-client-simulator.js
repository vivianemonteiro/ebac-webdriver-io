"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _net = _interopRequireDefault(require("net"));

var _rpcClient = _interopRequireDefault(require("./rpc-client"));

var _appiumIosDevice = require("appium-ios-device");

var _remoteDebugger = require("./remote-debugger");

class RpcClientSimulator extends _rpcClient.default {
  constructor(opts = {}) {
    super(Object.assign({
      shouldCheckForTarget: false
    }, opts));
    const {
      socketPath,
      host = '::1',
      port = _remoteDebugger.REMOTE_DEBUGGER_PORT,
      messageProxy
    } = opts;
    this.host = host;
    this.port = port;
    this.messageProxy = messageProxy;
    this.socket = null;
    this.socketPath = socketPath;
  }

  async connect() {
    if (this.socketPath) {
      if (this.messageProxy) {
        _logger.default.debug(`Connecting to remote debugger via proxy through unix domain socket: '${this.messageProxy}'`);

        this.socket = _net.default.connect(this.messageProxy);
        this.socket.once('connect', () => {
          _logger.default.debug(`Forwarding the actual web inspector socket to the proxy: '${this.socketPath}'`);

          this.socket.write(JSON.stringify({
            socketPath: this.socketPath
          }));
        });
      } else {
        _logger.default.debug(`Connecting to remote debugger through unix domain socket: '${this.socketPath}'`);

        this.socket = _net.default.connect(this.socketPath);
      }
    } else {
      if (this.messageProxy) {
        this.port = this.messageProxy;
      }

      _logger.default.debug(`Connecting to remote debugger ${this.messageProxy ? 'via proxy ' : ''}through TCP: ${this.host}:${this.port}`);

      this.socket = new _net.default.Socket({
        type: 'tcp6'
      });
      this.socket.connect(this.port, this.host);
    }

    this.socket.setNoDelay(true);
    this.socket.on('close', () => {
      if (this.connected) {
        _logger.default.debug('Debugger socket disconnected');
      }

      this.connected = false;
      this.socket = null;
    });
    this.socket.on('end', () => {
      this.connected = false;
    });
    this.service = await _appiumIosDevice.services.startWebInspectorService(this.udid, {
      socket: this.socket,
      osVersion: this.platformVersion
    });
    this.service.listenMessage(this.receive.bind(this));
    return await new _bluebird.default((resolve, reject) => {
      this.socket.on('connect', () => {
        _logger.default.debug(`Debugger socket connected`);

        this.connected = true;
        resolve();
      });
      this.socket.on('error', err => {
        if (this.connected) {
          _logger.default.error(`Socket error: ${err.message}`);

          this.connected = false;
        }

        reject(err);
      });
    });
  }

  async disconnect() {
    if (!this.isConnected()) {
      return;
    }

    _logger.default.debug('Disconnecting from remote debugger');

    this.service.close();
    this.connected = false;
  }

  async sendMessage(cmd) {
    let onSocketError;
    return await new _bluebird.default((resolve, reject) => {
      onSocketError = err => {
        _logger.default.error(`Socket error: ${err.message}`);

        reject(err);
      };

      this.socket.on('error', onSocketError);
      this.service.sendMessage(cmd);
      resolve();
    }).finally(() => {
      try {
        this.socket.removeListener('error', onSocketError);
      } catch (ign) {}
    });
  }

  async receive(data) {
    if (!this.isConnected()) {
      return;
    }

    if (!data) {
      return;
    }

    for (const key of ['WIRMessageDataKey', 'WIRDestinationKey', 'WIRSocketDataKey']) {
      if (!_lodash.default.isUndefined(data[key])) {
        data[key] = data[key].toString('utf8');
      }
    }

    await this.messageHandler.handleMessage(data);
  }

}

exports.default = RpcClientSimulator;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ycGMtY2xpZW50LXNpbXVsYXRvci5qcyJdLCJuYW1lcyI6WyJScGNDbGllbnRTaW11bGF0b3IiLCJScGNDbGllbnQiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJzaG91bGRDaGVja0ZvclRhcmdldCIsInNvY2tldFBhdGgiLCJob3N0IiwicG9ydCIsIlJFTU9URV9ERUJVR0dFUl9QT1JUIiwibWVzc2FnZVByb3h5Iiwic29ja2V0IiwiY29ubmVjdCIsImxvZyIsImRlYnVnIiwibmV0Iiwib25jZSIsIndyaXRlIiwiSlNPTiIsInN0cmluZ2lmeSIsIlNvY2tldCIsInR5cGUiLCJzZXROb0RlbGF5Iiwib24iLCJjb25uZWN0ZWQiLCJzZXJ2aWNlIiwic2VydmljZXMiLCJzdGFydFdlYkluc3BlY3RvclNlcnZpY2UiLCJ1ZGlkIiwib3NWZXJzaW9uIiwicGxhdGZvcm1WZXJzaW9uIiwibGlzdGVuTWVzc2FnZSIsInJlY2VpdmUiLCJiaW5kIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJlcnIiLCJlcnJvciIsIm1lc3NhZ2UiLCJkaXNjb25uZWN0IiwiaXNDb25uZWN0ZWQiLCJjbG9zZSIsInNlbmRNZXNzYWdlIiwiY21kIiwib25Tb2NrZXRFcnJvciIsImZpbmFsbHkiLCJyZW1vdmVMaXN0ZW5lciIsImlnbiIsImRhdGEiLCJrZXkiLCJfIiwiaXNVbmRlZmluZWQiLCJ0b1N0cmluZyIsIm1lc3NhZ2VIYW5kbGVyIiwiaGFuZGxlTWVzc2FnZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHZSxNQUFNQSxrQkFBTixTQUFpQ0Msa0JBQWpDLENBQTJDO0FBQ3hEQyxFQUFBQSxXQUFXLENBQUVDLElBQUksR0FBRyxFQUFULEVBQWE7QUFDdEIsVUFBTUMsTUFBTSxDQUFDQyxNQUFQLENBQWM7QUFDbEJDLE1BQUFBLG9CQUFvQixFQUFFO0FBREosS0FB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O0FBQ0QsT0FGRCxDQUVFLE9BQU9HLEdBQVAsRUFBWSxDQUFFO0FBQ2pCLEtBbEJZLENBQWI7QUFtQkQ7O0FBRUQsUUFBTWhCLE9BQU4sQ0FBZWlCLElBQWYsRUFBcUI7QUFDbkIsUUFBSSxDQUFDLEtBQUtSLFdBQUwsRUFBTCxFQUF5QjtBQUN2QjtBQUNEOztBQUVELFFBQUksQ0FBQ1EsSUFBTCxFQUFXO0FBQ1Q7QUFDRDs7QUFFRCxTQUFLLE1BQU1DLEdBQVgsSUFBa0IsQ0FBQyxtQkFBRCxFQUFzQixtQkFBdEIsRUFBMkMsa0JBQTNDLENBQWxCLEVBQWtGO0FBQ2hGLFVBQUksQ0FBQ0MsZ0JBQUVDLFdBQUYsQ0FBY0gsSUFBSSxDQUFDQyxHQUFELENBQWxCLENBQUwsRUFBK0I7QUFDN0JELFFBQUFBLElBQUksQ0FBQ0MsR0FBRCxDQUFKLEdBQVlELElBQUksQ0FBQ0MsR0FBRCxDQUFKLENBQVVHLFFBQVYsQ0FBbUIsTUFBbkIsQ0FBWjtBQUNEO0FBQ0Y7O0FBQ0QsVUFBTSxLQUFLQyxjQUFMLENBQW9CQyxhQUFwQixDQUFrQ04sSUFBbEMsQ0FBTjtBQUNEOztBQTVJdUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgUnBjQ2xpZW50IGZyb20gJy4vcnBjLWNsaWVudCc7XG5pbXBvcnQgeyBzZXJ2aWNlcyB9IGZyb20gJ2FwcGl1bS1pb3MtZGV2aWNlJztcbmltcG9ydCB7IFJFTU9URV9ERUJVR0dFUl9QT1JUIH0gZnJvbSAnLi9yZW1vdGUtZGVidWdnZXInO1xuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJwY0NsaWVudFNpbXVsYXRvciBleHRlbmRzIFJwY0NsaWVudCB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBzdXBlcihPYmplY3QuYXNzaWduKHtcbiAgICAgIHNob3VsZENoZWNrRm9yVGFyZ2V0OiBmYWxzZSxcbiAgICB9LCBvcHRzKSk7XG5cbiAgICBjb25zdCB7XG4gICAgICBzb2NrZXRQYXRoLFxuICAgICAgaG9zdCA9ICc6OjEnLFxuICAgICAgcG9ydCA9IFJFTU9URV9ERUJVR0dFUl9QT1JULFxuICAgICAgbWVzc2FnZVByb3h5LFxuICAgIH0gPSBvcHRzO1xuXG4gICAgLy8gaG9zdC9wb3J0IGNvbmZpZyBmb3IgVENQIGNvbW11bmljYXRpb24sIHNvY2tldFBhdGggZm9yIHVuaXggZG9tYWluIHNvY2tldHNcbiAgICB0aGlzLmhvc3QgPSBob3N0O1xuICAgIHRoaXMucG9ydCA9IHBvcnQ7XG4gICAgdGhpcy5tZXNzYWdlUHJveHkgPSBtZXNzYWdlUHJveHk7XG5cbiAgICB0aGlzLnNvY2tldCA9IG51bGw7XG4gICAgdGhpcy5zb2NrZXRQYXRoID0gc29ja2V0UGF0aDtcbiAgfVxuXG4gIGFzeW5jIGNvbm5lY3QgKCkge1xuICAgIC8vIGNyZWF0ZSBzb2NrZXQgYW5kIGhhbmRsZSBpdHMgbWVzc2FnZXNcbiAgICBpZiAodGhpcy5zb2NrZXRQYXRoKSB7XG4gICAgICBpZiAodGhpcy5tZXNzYWdlUHJveHkpIHtcbiAgICAgICAgLy8gdW5peCBkb21haW4gc29ja2V0IHZpYSBwcm94eVxuICAgICAgICBsb2cuZGVidWcoYENvbm5lY3RpbmcgdG8gcmVtb3RlIGRlYnVnZ2VyIHZpYSBwcm94eSB0aHJvdWdoIHVuaXggZG9tYWluIHNvY2tldDogJyR7dGhpcy5tZXNzYWdlUHJveHl9J2ApO1xuICAgICAgICB0aGlzLnNvY2tldCA9IG5ldC5jb25uZWN0KHRoaXMubWVzc2FnZVByb3h5KTtcblxuICAgICAgICAvLyBGb3J3YXJkIHRoZSBhY3R1YWwgc29ja2V0UGF0aCB0byB0aGUgcHJveHlcbiAgICAgICAgdGhpcy5zb2NrZXQub25jZSgnY29ubmVjdCcsICgpID0+IHtcbiAgICAgICAgICBsb2cuZGVidWcoYEZvcndhcmRpbmcgdGhlIGFjdHVhbCB3ZWIgaW5zcGVjdG9yIHNvY2tldCB0byB0aGUgcHJveHk6ICcke3RoaXMuc29ja2V0UGF0aH0nYCk7XG4gICAgICAgICAgdGhpcy5zb2NrZXQud3JpdGUoSlNPTi5zdHJpbmdpZnkoe3NvY2tldFBhdGg6IHRoaXMuc29ja2V0UGF0aH0pKTtcbiAgICAgICAgfSk7XG5cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHVuaXggZG9tYWluIHNvY2tldFxuICAgICAgICBsb2cuZGVidWcoYENvbm5lY3RpbmcgdG8gcmVtb3RlIGRlYnVnZ2VyIHRocm91Z2ggdW5peCBkb21haW4gc29ja2V0OiAnJHt0aGlzLnNvY2tldFBhdGh9J2ApO1xuICAgICAgICB0aGlzLnNvY2tldCA9IG5ldC5jb25uZWN0KHRoaXMuc29ja2V0UGF0aCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLm1lc3NhZ2VQcm94eSkge1xuICAgICAgICAvLyBjb25uZWN0IHRvIHRoZSBwcm94eSBpbnN0ZWFkIG9mIHRoZSByZW1vdGUgZGVidWdnZXIgZGlyZWN0bHlcbiAgICAgICAgdGhpcy5wb3J0ID0gdGhpcy5tZXNzYWdlUHJveHk7XG4gICAgICB9XG5cbiAgICAgIC8vIHRjcCBzb2NrZXRcbiAgICAgIGxvZy5kZWJ1ZyhgQ29ubmVjdGluZyB0byByZW1vdGUgZGVidWdnZXIgJHt0aGlzLm1lc3NhZ2VQcm94eSA/ICd2aWEgcHJveHkgJyA6ICcnfXRocm91Z2ggVENQOiAke3RoaXMuaG9zdH06JHt0aGlzLnBvcnR9YCk7XG4gICAgICB0aGlzLnNvY2tldCA9IG5ldyBuZXQuU29ja2V0KHt0eXBlOiAndGNwNid9KTtcbiAgICAgIHRoaXMuc29ja2V0LmNvbm5lY3QodGhpcy5wb3J0LCB0aGlzLmhvc3QpO1xuICAgIH1cblxuICAgIHRoaXMuc29ja2V0LnNldE5vRGVsYXkodHJ1ZSk7XG4gICAgdGhpcy5zb2NrZXQub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnRGVidWdnZXIgc29ja2V0IGRpc2Nvbm5lY3RlZCcpO1xuICAgICAgfVxuICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuc29ja2V0ID0gbnVsbDtcbiAgICB9KTtcbiAgICB0aGlzLnNvY2tldC5vbignZW5kJywgKCkgPT4ge1xuICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICB9KTtcbiAgICB0aGlzLnNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydFdlYkluc3BlY3RvclNlcnZpY2UodGhpcy51ZGlkLCB7XG4gICAgICBzb2NrZXQ6IHRoaXMuc29ja2V0LFxuICAgICAgb3NWZXJzaW9uOiB0aGlzLnBsYXRmb3JtVmVyc2lvbixcbiAgICB9KTtcbiAgICB0aGlzLnNlcnZpY2UubGlzdGVuTWVzc2FnZSh0aGlzLnJlY2VpdmUuYmluZCh0aGlzKSk7XG5cbiAgICAvLyBjb25uZWN0IHRoZSBzb2NrZXRcbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gb25seSByZXNvbHZlIHRoaXMgZnVuY3Rpb24gd2hlbiB3ZSBhcmUgYWN0dWFsbHkgY29ubmVjdGVkXG4gICAgICB0aGlzLnNvY2tldC5vbignY29ubmVjdCcsICgpID0+IHtcbiAgICAgICAgbG9nLmRlYnVnKGBEZWJ1Z2dlciBzb2NrZXQgY29ubmVjdGVkYCk7XG4gICAgICAgIHRoaXMuY29ubmVjdGVkID0gdHJ1ZTtcblxuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAgICAgbG9nLmVycm9yKGBTb2NrZXQgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHRoZSBjb25uZWN0aW9uIHdhcyByZWZ1c2VkLCBzbyByZWplY3QgdGhlIGNvbm5lY3QgcHJvbWlzZVxuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZGlzY29ubmVjdCAoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICAgIGlmICghdGhpcy5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICByZXR1cm47XG5cbiAgICB9XG4gICAgbG9nLmRlYnVnKCdEaXNjb25uZWN0aW5nIGZyb20gcmVtb3RlIGRlYnVnZ2VyJyk7XG4gICAgdGhpcy5zZXJ2aWNlLmNsb3NlKCk7XG4gICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRNZXNzYWdlIChjbWQpIHtcbiAgICBsZXQgb25Tb2NrZXRFcnJvcjtcblxuICAgIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBoYW5kbGUgc29ja2V0IHByb2JsZW1zXG4gICAgICBvblNvY2tldEVycm9yID0gKGVycikgPT4ge1xuICAgICAgICBsb2cuZXJyb3IoYFNvY2tldCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcblxuICAgICAgICAvLyB0aGUgY29ubmVjdGlvbiB3YXMgcmVmdXNlZCwgc28gcmVqZWN0IHRoZSBjb25uZWN0IHByb21pc2VcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9O1xuXG4gICAgICB0aGlzLnNvY2tldC5vbignZXJyb3InLCBvblNvY2tldEVycm9yKTtcbiAgICAgIHRoaXMuc2VydmljZS5zZW5kTWVzc2FnZShjbWQpO1xuICAgICAgcmVzb2x2ZSgpO1xuICAgIH0pXG4gICAgLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgLy8gcmVtb3ZlIHRoaXMgbGlzdGVuZXIsIHNvIHdlIGRvbid0IGV4aGF1c3QgdGhlIHN5c3RlbVxuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy5zb2NrZXQucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgb25Tb2NrZXRFcnJvcik7XG4gICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyByZWNlaXZlIChkYXRhKSB7XG4gICAgaWYgKCF0aGlzLmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIWRhdGEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGtleSBvZiBbJ1dJUk1lc3NhZ2VEYXRhS2V5JywgJ1dJUkRlc3RpbmF0aW9uS2V5JywgJ1dJUlNvY2tldERhdGFLZXknXSkge1xuICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKGRhdGFba2V5XSkpIHtcbiAgICAgICAgZGF0YVtrZXldID0gZGF0YVtrZXldLnRvU3RyaW5nKCd1dGY4Jyk7XG4gICAgICB9XG4gICAgfVxuICAgIGF3YWl0IHRoaXMubWVzc2FnZUhhbmRsZXIuaGFuZGxlTWVzc2FnZShkYXRhKTtcbiAgfVxufVxuIl0sImZpbGUiOiJsaWIvcnBjLWNsaWVudC1zaW11bGF0b3IuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
