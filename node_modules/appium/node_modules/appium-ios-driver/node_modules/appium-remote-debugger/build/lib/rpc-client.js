"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _remoteMessages = _interopRequireDefault(require("./remote-messages"));

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _remoteDebuggerMessageHandler = _interopRequireDefault(require("./remote-debugger-message-handler"));

var _helpers = require("./helpers");

var _appiumSupport = require("appium-support");

const DATA_LOG_LENGTH = {
  length: 200
};
const WAIT_FOR_TARGET_RETRIES = 10;
const WAIT_FOR_TARGET_INTERVAL = 1000;
const GENERIC_TARGET_ID = 'page-6';

class RpcClient {
  constructor(opts = {}) {
    this._targets = [];
    this._shouldCheckForTarget = !!opts.shouldCheckForTarget;
    const {
      bundleId,
      platformVersion = {},
      isSafari = true,
      specialMessageHandlers = {},
      logFullResponse = false
    } = opts;
    this.isSafari = isSafari;
    this.connected = false;
    this.connId = _uuidJs.default.create().toString();
    this.senderId = _uuidJs.default.create().toString();
    this.msgId = 0;
    this.logFullResponse = logFullResponse;
    this.bundleId = bundleId;
    this.platformVersion = platformVersion;
    this.specialMessageHandlers = specialMessageHandlers;
    this.setCommunicationProtocol((0, _helpers.isTargetBased)(isSafari, this.platformVersion));
  }

  setCommunicationProtocol(isTargetBased = false) {
    _logger.default.warn(`Setting communication protocol: using ${isTargetBased ? 'Target-based' : 'full Web Inspector protocol'} communication`);

    this.isTargetBased = isTargetBased;

    if (!this.remoteMessages) {
      this.remoteMessages = new _remoteMessages.default(isTargetBased);
    } else {
      this.remoteMessages.setCommunicationProtocol(isTargetBased);
    }

    if (!this.messageHandler) {
      this.messageHandler = new _remoteDebuggerMessageHandler.default(this.specialMessageHandlers, isTargetBased);
    } else {
      this.messageHandler.setCommunicationProtocol(isTargetBased);
    }
  }

  needsTarget() {
    return this.shouldCheckForTarget && this.isTargetBased;
  }

  async waitForTarget(appIdKey, pageIdKey) {
    if (!this.needsTarget()) {
      return;
    }

    if (_appiumSupport.util.compareVersions(this.platformVersion, '<', '13.0') && _lodash.default.isEmpty(this.getTarget(appIdKey, pageIdKey))) {
      if (this.isSafari) {
        this.addTarget({
          targetId: `page-${pageIdKey}`
        });
      } else {
        const targets = this.targets[appIdKey];

        const targetIds = _lodash.default.values(targets).map(targetId => targetId.replace('page-', '')).sort();

        const lastTargetId = _lodash.default.last(targetIds) || 0;
        this.addTarget({
          targetId: `page-${lastTargetId + 1}`
        });
      }

      return;
    }

    try {
      await (0, _asyncbox.retryInterval)(WAIT_FOR_TARGET_RETRIES, WAIT_FOR_TARGET_INTERVAL, () => {
        if (_lodash.default.isEmpty(this.getTarget(appIdKey, pageIdKey))) {
          throw new Error('No targets found, unable to communicate with device');
        }
      });
    } catch (err) {
      _logger.default.debug(`No target found. Trying '${GENERIC_TARGET_ID}', which seems to work`);

      this.addTarget({
        targetId: GENERIC_TARGET_ID
      });
    }
  }

  async send(command, opts = {}) {
    const startTime = process.hrtime();
    const {
      appIdKey,
      pageIdKey
    } = opts;

    try {
      await this.waitForTarget(appIdKey, pageIdKey);
      return await this.sendToDevice(command, opts);
    } catch (err) {
      if (err.message.includes(`'Target' domain was not found`)) {
        this.setCommunicationProtocol(false);
        return await this.sendToDevice(command, opts);
      } else if (err.message.includes(`domain was not found`)) {
        this.setCommunicationProtocol(true);
        await this.waitForTarget(appIdKey, pageIdKey);
        return await this.sendToDevice(command, opts);
      }

      throw new Error(err);
    } finally {
      _logger.default.debug(`Sending to Web Inspector took ${(0, _helpers.getElapsedTime)(startTime)}ms`);
    }
  }

  getLoggableResponse(res) {
    return _lodash.default.isString(res) ? res : this.logFullResponse ? JSON.stringify(res, null, 2) : _lodash.default.truncate(JSON.stringify(res), DATA_LOG_LENGTH);
  }

  async sendToDevice(command, opts = {}) {
    return await new _bluebird.default(async (resolve, reject) => {
      const msgId = this.msgId++;

      const sendOpts = _lodash.default.defaults({
        connId: this.connId,
        senderId: this.senderId
      }, opts);

      const cmd = this.remoteMessages.getRemoteCommand(command, sendOpts);
      let messageHandled = false;

      if (this.messageHandler.hasSpecialMessageHandler(cmd.__selector)) {
        messageHandled = true;
        const specialMessageHandler = this.getSpecialMessageHandler(cmd.__selector);
        this.setSpecialMessageHandler(cmd.__selector, reject, (...args) => {
          _logger.default.debug(`Received response from send (id: ${msgId}): '${this.getLoggableResponse(args)}'`);

          specialMessageHandler(...args);

          if (this.messageHandler.hasSpecialMessageHandler(cmd.__selector)) {
            this.setSpecialMessageHandler(cmd.__selector, null, specialMessageHandler);
          }

          resolve(args);
        });
      } else if (cmd.__argument && cmd.__argument.WIRSocketDataKey) {
        messageHandled = true;

        const errorHandler = function (err) {
          const msg = `Remote debugger error with code '${err.code}': ${err.message}`;
          reject(new Error(msg));
        };

        this.setDataMessageHandler(msgId.toString(), errorHandler, value => {
          _logger.default.debug(`Received data response from send (id: ${msgId}): '${this.getLoggableResponse(value)}'`);

          resolve(value);
        });

        if (cmd.__argument.WIRSocketDataKey.params) {
          cmd.__argument.WIRSocketDataKey.params.id = msgId;

          if (!cmd.__argument.WIRSocketDataKey.params.targetId && this.needsTarget()) {
            cmd.__argument.WIRSocketDataKey.params.targetId = this.getTarget(sendOpts.appIdKey, sendOpts.pageIdKey);
          }

          if (cmd.__argument.WIRSocketDataKey.params.message) {
            cmd.__argument.WIRSocketDataKey.params.message.id = msgId;
            cmd.__argument.WIRSocketDataKey.params.message = JSON.stringify(cmd.__argument.WIRSocketDataKey.params.message);
          }
        }

        cmd.__argument.WIRSocketDataKey.id = msgId;
        cmd.__argument.WIRSocketDataKey = Buffer.from(JSON.stringify(cmd.__argument.WIRSocketDataKey));
      }

      const msg = `Sending '${cmd.__selector}' message` + (sendOpts.appIdKey ? ` to app '${sendOpts.appIdKey}'` : '') + (sendOpts.pageIdKey ? `, page '${sendOpts.pageIdKey}'` : '') + (this.needsTarget() ? `, target '${this.getTarget(sendOpts.appIdKey, sendOpts.pageIdKey)}'` : '') + ` (id: ${msgId})`;

      _logger.default.debug(msg);

      try {
        const res = await this.sendMessage(cmd);

        if (!messageHandled) {
          resolve(res);
        }
      } catch (err) {
        return reject(err);
      }
    });
  }

  async sendMessage() {
    throw new Error(`Sub-classes need to implement a 'sendMessage' function`);
  }

  addTarget(targetInfo) {
    if (_lodash.default.isUndefined(targetInfo) || _lodash.default.isUndefined(targetInfo.targetId)) {
      _logger.default.warn(`Received 'targetCreated' event with no target. Skipping`);

      return;
    }

    if (_lodash.default.isEmpty(this.pendingTargetNotification)) {
      _logger.default.warn(`Received 'targetCreated' event with no pending request: ${JSON.stringify(targetInfo)}`);

      return;
    }

    const [appIdKey, pageIdKey] = this.pendingTargetNotification || [];
    this.pendingTargetNotification = null;

    _logger.default.debug(`Target created for app '${appIdKey}' and page '${pageIdKey}': ${JSON.stringify(targetInfo)}`);

    this.targets[appIdKey] = this.targets[appIdKey] || {};

    if (_lodash.default.isEmpty(this.targets[appIdKey][pageIdKey])) {
      this.targets[appIdKey][pageIdKey] = targetInfo.targetId;
    }
  }

  removeTarget(targetInfo) {
    if (_lodash.default.isUndefined(targetInfo) || _lodash.default.isUndefined(targetInfo.targetId)) {
      _logger.default.debug(`Received 'targetDestroyed' event with no target. Skipping`);

      return;
    }

    _logger.default.debug(`Target destroyed: ${JSON.stringify(targetInfo)}`);

    _lodash.default.pull(this.targets, targetInfo.targetId);
  }

  get targets() {
    this._targets = this._targets || {};
    return this._targets;
  }

  getTarget(appIdKey, pageIdKey) {
    const target = (this.targets[appIdKey] || {})[pageIdKey];
    return target;
  }

  get shouldCheckForTarget() {
    return this._shouldCheckForTarget;
  }

  set shouldCheckForTarget(shouldCheckForTarget) {
    this._shouldCheckForTarget = !!shouldCheckForTarget;
  }

  async connect() {
    throw new Error(`Sub-classes need to implement a 'connect' function`);
  }

  async disconnect() {
    throw new Error(`Sub-classes need to implement a 'disconnect' function`);
  }

  isConnected() {
    return this.connected;
  }

  setSpecialMessageHandler(key, errorHandler, handler) {
    this.messageHandler.setSpecialMessageHandler(key, errorHandler, handler);
  }

  getSpecialMessageHandler(key) {
    return this.messageHandler.getSpecialMessageHandler(key);
  }

  setDataMessageHandler(key, errorHandler, handler) {
    this.messageHandler.setDataMessageHandler(key, errorHandler, handler);
  }

  allowNavigationWithoutReload(allow = true) {
    this.messageHandler.allowNavigationWithoutReload(allow);
  }

  async selectPage(appIdKey, pageIdKey) {
    this.pendingTargetNotification = [appIdKey, pageIdKey];
    this.shouldCheckForTarget = false;
    await this.send('setSenderKey', {
      appIdKey,
      pageIdKey
    });

    _logger.default.debug('Sender key set');

    this.shouldCheckForTarget = true;
    await this.send('enablePage', {
      appIdKey,
      pageIdKey
    });

    _logger.default.debug('Enabled activity on page');
  }

  async selectApp(appIdKey, applicationConnectedHandler) {
    return await new _bluebird.default((resolve, reject) => {
      const onAppChange = dict => {
        let oldAppIdKey = dict.WIRHostApplicationIdentifierKey;
        let correctAppIdKey = dict.WIRApplicationIdentifierKey;

        if (oldAppIdKey && correctAppIdKey !== oldAppIdKey) {
          _logger.default.debug(`We were notified we might have connected to the wrong app. ` + `Using id ${correctAppIdKey} instead of ${oldAppIdKey}`);
        }

        applicationConnectedHandler(dict);
        reject(new Error('New application has connected'));
      };

      this.setSpecialMessageHandler('_rpc_applicationConnected:', reject, onAppChange);
      return (async () => {
        let pageDict, connectedAppIdKey;

        try {
          [connectedAppIdKey, pageDict] = await this.send('connectToApp', {
            appIdKey
          });
        } catch (err) {
          _logger.default.warn(`Unable to connect to app: ${err.message}`);

          reject(err);
        }

        if (_lodash.default.isEmpty(pageDict)) {
          let msg = 'Empty page dictionary received';

          _logger.default.debug(msg);

          reject(new Error(msg));
        } else {
          resolve([connectedAppIdKey, pageDict]);
        }
      })();
    }).finally(() => {
      this.setSpecialMessageHandler('_rpc_applicationConnected:', null, applicationConnectedHandler);
    });
  }

  async receive() {
    throw new Error(`Sub-classes need to implement a 'receive' function`);
  }

  setTimelineEventHandler(timelineEventHandler) {
    this.timelineEventHandler = timelineEventHandler;
    this.messageHandler.setTimelineEventHandler(timelineEventHandler);
  }

  setConsoleLogEventHandler(consoleEventHandler) {
    this.consoleEventHandler = consoleEventHandler;
    this.messageHandler.setConsoleLogEventHandler(consoleEventHandler);
  }

  setNetworkLogEventHandler(networkEventHandler) {
    this.networkEventHandler = networkEventHandler;
    this.messageHandler.setNetworkEventHandler(networkEventHandler);
  }

}

exports.default = RpcClient;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ycGMtY2xpZW50LmpzIl0sIm5hbWVzIjpbIkRBVEFfTE9HX0xFTkdUSCIsImxlbmd0aCIsIldBSVRfRk9SX1RBUkdFVF9SRVRSSUVTIiwiV0FJVF9GT1JfVEFSR0VUX0lOVEVSVkFMIiwiR0VORVJJQ19UQVJHRVRfSUQiLCJScGNDbGllbnQiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJfdGFyZ2V0cyIsIl9zaG91bGRDaGVja0ZvclRhcmdldCIsInNob3VsZENoZWNrRm9yVGFyZ2V0IiwiYnVuZGxlSWQiLCJwbGF0Zm9ybVZlcnNpb24iLCJpc1NhZmFyaSIsInNwZWNpYWxNZXNzYWdlSGFuZGxlcnMiLCJsb2dGdWxsUmVzcG9uc2UiLCJjb25uZWN0ZWQiLCJjb25uSWQiLCJVVUlEIiwiY3JlYXRlIiwidG9TdHJpbmciLCJzZW5kZXJJZCIsIm1zZ0lkIiwic2V0Q29tbXVuaWNhdGlvblByb3RvY29sIiwiaXNUYXJnZXRCYXNlZCIsImxvZyIsIndhcm4iLCJyZW1vdGVNZXNzYWdlcyIsIlJlbW90ZU1lc3NhZ2VzIiwibWVzc2FnZUhhbmRsZXIiLCJScGNNZXNzYWdlSGFuZGxlciIsIm5lZWRzVGFyZ2V0Iiwid2FpdEZvclRhcmdldCIsImFwcElkS2V5IiwicGFnZUlkS2V5IiwidXRpbCIsImNvbXBhcmVWZXJzaW9ucyIsIl8iLCJpc0VtcHR5IiwiZ2V0VGFyZ2V0IiwiYWRkVGFyZ2V0IiwidGFyZ2V0SWQiLCJ0YXJnZXRzIiwidGFyZ2V0SWRzIiwidmFsdWVzIiwibWFwIiwicmVwbGFjZSIsInNvcnQiLCJsYXN0VGFyZ2V0SWQiLCJsYXN0IiwiRXJyb3IiLCJlcnIiLCJkZWJ1ZyIsInNlbmQiLCJjb21tYW5kIiwic3RhcnRUaW1lIiwicHJvY2VzcyIsImhydGltZSIsInNlbmRUb0RldmljZSIsIm1lc3NhZ2UiLCJpbmNsdWRlcyIsImdldExvZ2dhYmxlUmVzcG9uc2UiLCJyZXMiLCJpc1N0cmluZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJ0cnVuY2F0ZSIsIkIiLCJyZXNvbHZlIiwicmVqZWN0Iiwic2VuZE9wdHMiLCJkZWZhdWx0cyIsImNtZCIsImdldFJlbW90ZUNvbW1hbmQiLCJtZXNzYWdlSGFuZGxlZCIsImhhc1NwZWNpYWxNZXNzYWdlSGFuZGxlciIsIl9fc2VsZWN0b3IiLCJzcGVjaWFsTWVzc2FnZUhhbmRsZXIiLCJnZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIiLCJzZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIiLCJhcmdzIiwiX19hcmd1bWVudCIsIldJUlNvY2tldERhdGFLZXkiLCJlcnJvckhhbmRsZXIiLCJtc2ciLCJjb2RlIiwic2V0RGF0YU1lc3NhZ2VIYW5kbGVyIiwidmFsdWUiLCJwYXJhbXMiLCJpZCIsIkJ1ZmZlciIsImZyb20iLCJzZW5kTWVzc2FnZSIsInRhcmdldEluZm8iLCJpc1VuZGVmaW5lZCIsInBlbmRpbmdUYXJnZXROb3RpZmljYXRpb24iLCJyZW1vdmVUYXJnZXQiLCJwdWxsIiwidGFyZ2V0IiwiY29ubmVjdCIsImRpc2Nvbm5lY3QiLCJpc0Nvbm5lY3RlZCIsImtleSIsImhhbmRsZXIiLCJhbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkIiwiYWxsb3ciLCJzZWxlY3RQYWdlIiwic2VsZWN0QXBwIiwiYXBwbGljYXRpb25Db25uZWN0ZWRIYW5kbGVyIiwib25BcHBDaGFuZ2UiLCJkaWN0Iiwib2xkQXBwSWRLZXkiLCJXSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5IiwiY29ycmVjdEFwcElkS2V5IiwiV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5IiwicGFnZURpY3QiLCJjb25uZWN0ZWRBcHBJZEtleSIsImZpbmFsbHkiLCJyZWNlaXZlIiwic2V0VGltZWxpbmVFdmVudEhhbmRsZXIiLCJ0aW1lbGluZUV2ZW50SGFuZGxlciIsInNldENvbnNvbGVMb2dFdmVudEhhbmRsZXIiLCJjb25zb2xlRXZlbnRIYW5kbGVyIiwic2V0TmV0d29ya0xvZ0V2ZW50SGFuZGxlciIsIm5ldHdvcmtFdmVudEhhbmRsZXIiLCJz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O0FBQ0Q7O0FBSUQsWUFBSWQsZ0JBQUVDLE9BQUYsQ0FBVTZFLFFBQVYsQ0FBSixFQUF5QjtBQUN2QixjQUFJL0IsR0FBRyxHQUFHLGdDQUFWOztBQUNBM0QsMEJBQUkyQixLQUFKLENBQVVnQyxHQUFWOztBQUNBZixVQUFBQSxNQUFNLENBQUMsSUFBSW5CLEtBQUosQ0FBVWtDLEdBQVYsQ0FBRCxDQUFOO0FBQ0QsU0FKRCxNQUlPO0FBQ0xoQixVQUFBQSxPQUFPLENBQUMsQ0FBQ2dELGlCQUFELEVBQW9CRCxRQUFwQixDQUFELENBQVA7QUFDRDtBQUNGLE9BcEJNLEdBQVA7QUFxQkQsS0EzQ1ksRUEyQ1ZFLE9BM0NVLENBMkNGLE1BQU07QUFFZixXQUFLdEMsd0JBQUwsQ0FBOEIsNEJBQTlCLEVBQTRELElBQTVELEVBQWtFNkIsMkJBQWxFO0FBQ0QsS0E5Q1ksQ0FBYjtBQStDRDs7QUFFRCxRQUFNVSxPQUFOLEdBQTJCO0FBQ3pCLFVBQU0sSUFBSXBFLEtBQUosQ0FBVyxvREFBWCxDQUFOO0FBQ0Q7O0FBRURxRSxFQUFBQSx1QkFBdUIsQ0FBRUMsb0JBQUYsRUFBd0I7QUFDN0MsU0FBS0Esb0JBQUwsR0FBNEJBLG9CQUE1QjtBQUNBLFNBQUszRixjQUFMLENBQW9CMEYsdUJBQXBCLENBQTRDQyxvQkFBNUM7QUFDRDs7QUFFREMsRUFBQUEseUJBQXlCLENBQUVDLG1CQUFGLEVBQXVCO0FBQzlDLFNBQUtBLG1CQUFMLEdBQTJCQSxtQkFBM0I7QUFDQSxTQUFLN0YsY0FBTCxDQUFvQjRGLHlCQUFwQixDQUE4Q0MsbUJBQTlDO0FBQ0Q7O0FBRURDLEVBQUFBLHlCQUF5QixDQUFFQyxtQkFBRixFQUF1QjtBQUM5QyxTQUFLQSxtQkFBTCxHQUEyQkEsbUJBQTNCO0FBQ0EsU0FBSy9GLGNBQUwsQ0FBb0JnRyxzQkFBcEIsQ0FBMkNELG1CQUEzQztBQUNEOztBQXhXNEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVtb3RlTWVzc2FnZXMgZnJvbSAnLi9yZW1vdGUtbWVzc2FnZXMnO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBVVUlEIGZyb20gJ3V1aWQtanMnO1xuaW1wb3J0IFJwY01lc3NhZ2VIYW5kbGVyIGZyb20gJy4vcmVtb3RlLWRlYnVnZ2VyLW1lc3NhZ2UtaGFuZGxlcic7XG5pbXBvcnQgeyBpc1RhcmdldEJhc2VkLCBnZXRFbGFwc2VkVGltZSB9IGZyb20gJy4vaGVscGVycyc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuXG5cbmNvbnN0IERBVEFfTE9HX0xFTkdUSCA9IHtsZW5ndGg6IDIwMH07XG5cbmNvbnN0IFdBSVRfRk9SX1RBUkdFVF9SRVRSSUVTID0gMTA7XG5jb25zdCBXQUlUX0ZPUl9UQVJHRVRfSU5URVJWQUwgPSAxMDAwO1xuXG5jb25zdCBHRU5FUklDX1RBUkdFVF9JRCA9ICdwYWdlLTYnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBScGNDbGllbnQge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgdGhpcy5fdGFyZ2V0cyA9IFtdO1xuICAgIHRoaXMuX3Nob3VsZENoZWNrRm9yVGFyZ2V0ID0gISFvcHRzLnNob3VsZENoZWNrRm9yVGFyZ2V0O1xuXG4gICAgY29uc3Qge1xuICAgICAgYnVuZGxlSWQsXG4gICAgICBwbGF0Zm9ybVZlcnNpb24gPSB7fSxcbiAgICAgIGlzU2FmYXJpID0gdHJ1ZSxcbiAgICAgIHNwZWNpYWxNZXNzYWdlSGFuZGxlcnMgPSB7fSxcbiAgICAgIGxvZ0Z1bGxSZXNwb25zZSA9IGZhbHNlLFxuICAgIH0gPSBvcHRzO1xuXG4gICAgdGhpcy5pc1NhZmFyaSA9IGlzU2FmYXJpO1xuXG4gICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICB0aGlzLmNvbm5JZCA9IFVVSUQuY3JlYXRlKCkudG9TdHJpbmcoKTtcbiAgICB0aGlzLnNlbmRlcklkID0gVVVJRC5jcmVhdGUoKS50b1N0cmluZygpO1xuICAgIHRoaXMubXNnSWQgPSAwO1xuICAgIHRoaXMubG9nRnVsbFJlc3BvbnNlID0gbG9nRnVsbFJlc3BvbnNlO1xuXG4gICAgdGhpcy5idW5kbGVJZCA9IGJ1bmRsZUlkO1xuICAgIHRoaXMucGxhdGZvcm1WZXJzaW9uID0gcGxhdGZvcm1WZXJzaW9uO1xuXG4gICAgLy8gbWVzc2FnZSBoYW5kbGVyc1xuICAgIHRoaXMuc3BlY2lhbE1lc3NhZ2VIYW5kbGVycyA9IHNwZWNpYWxNZXNzYWdlSGFuZGxlcnM7XG5cbiAgICAvLyBzdGFydCB3aXRoIGEgYmVzdCBndWVzcyBmb3IgdGhlIHByb3RvY29sXG4gICAgdGhpcy5zZXRDb21tdW5pY2F0aW9uUHJvdG9jb2woaXNUYXJnZXRCYXNlZChpc1NhZmFyaSwgdGhpcy5wbGF0Zm9ybVZlcnNpb24pKTtcbiAgfVxuXG4gIHNldENvbW11bmljYXRpb25Qcm90b2NvbCAoaXNUYXJnZXRCYXNlZCA9IGZhbHNlKSB7XG4gICAgbG9nLndhcm4oYFNldHRpbmcgY29tbXVuaWNhdGlvbiBwcm90b2NvbDogdXNpbmcgJHtpc1RhcmdldEJhc2VkID8gJ1RhcmdldC1iYXNlZCcgOiAnZnVsbCBXZWIgSW5zcGVjdG9yIHByb3RvY29sJ30gY29tbXVuaWNhdGlvbmApO1xuICAgIHRoaXMuaXNUYXJnZXRCYXNlZCA9IGlzVGFyZ2V0QmFzZWQ7XG5cbiAgICBpZiAoIXRoaXMucmVtb3RlTWVzc2FnZXMpIHtcbiAgICAgIHRoaXMucmVtb3RlTWVzc2FnZXMgPSBuZXcgUmVtb3RlTWVzc2FnZXMoaXNUYXJnZXRCYXNlZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucmVtb3RlTWVzc2FnZXMuc2V0Q29tbXVuaWNhdGlvblByb3RvY29sKGlzVGFyZ2V0QmFzZWQpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5tZXNzYWdlSGFuZGxlcikge1xuICAgICAgdGhpcy5tZXNzYWdlSGFuZGxlciA9IG5ldyBScGNNZXNzYWdlSGFuZGxlcih0aGlzLnNwZWNpYWxNZXNzYWdlSGFuZGxlcnMsIGlzVGFyZ2V0QmFzZWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNldENvbW11bmljYXRpb25Qcm90b2NvbChpc1RhcmdldEJhc2VkKTtcbiAgICB9XG4gIH1cblxuICBuZWVkc1RhcmdldCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuc2hvdWxkQ2hlY2tGb3JUYXJnZXQgJiYgdGhpcy5pc1RhcmdldEJhc2VkO1xuICB9XG5cbiAgYXN5bmMgd2FpdEZvclRhcmdldCAoYXBwSWRLZXksIHBhZ2VJZEtleSkge1xuICAgIGlmICghdGhpcy5uZWVkc1RhcmdldCgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gb24gaU9TIGxlc3MgdGhhbiAxMyBoYXZlIHRhcmdldHMgdGhhdCBjYW4gYmUgY29tcHV0ZWQgZWFzaWx5XG4gICAgLy8gYW5kIHNvbWV0aW1lcyBpcyBub3QgcmVwb3J0ZWQgYnkgdGhlIFdlYiBJbnNwZWN0b3JcbiAgICBpZiAodXRpbC5jb21wYXJlVmVyc2lvbnModGhpcy5wbGF0Zm9ybVZlcnNpb24sICc8JywgJzEzLjAnKSAmJiBfLmlzRW1wdHkodGhpcy5nZXRUYXJnZXQoYXBwSWRLZXksIHBhZ2VJZEtleSkpKSB7XG4gICAgICBpZiAodGhpcy5pc1NhZmFyaSkge1xuICAgICAgICB0aGlzLmFkZFRhcmdldCh7dGFyZ2V0SWQ6IGBwYWdlLSR7cGFnZUlkS2V5fWB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHRhcmdldHMgPSB0aGlzLnRhcmdldHNbYXBwSWRLZXldO1xuICAgICAgICBjb25zdCB0YXJnZXRJZHMgPSBfLnZhbHVlcyh0YXJnZXRzKVxuICAgICAgICAgIC5tYXAoKHRhcmdldElkKSA9PiB0YXJnZXRJZC5yZXBsYWNlKCdwYWdlLScsICcnKSlcbiAgICAgICAgICAuc29ydCgpO1xuICAgICAgICBjb25zdCBsYXN0VGFyZ2V0SWQgPSBfLmxhc3QodGFyZ2V0SWRzKSB8fCAwO1xuICAgICAgICB0aGlzLmFkZFRhcmdldCh7dGFyZ2V0SWQ6IGBwYWdlLSR7bGFzdFRhcmdldElkICsgMX1gfSk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gb3RoZXJ3aXNlIHdhaXRpbmcgaXMgbmVjZXNzYXJ5IHRvIHNlZSB3aGF0IHRoZSB0YXJnZXQgaXNcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbChXQUlUX0ZPUl9UQVJHRVRfUkVUUklFUywgV0FJVF9GT1JfVEFSR0VUX0lOVEVSVkFMLCAoKSA9PiB7XG4gICAgICAgIGlmIChfLmlzRW1wdHkodGhpcy5nZXRUYXJnZXQoYXBwSWRLZXksIHBhZ2VJZEtleSkpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyB0YXJnZXRzIGZvdW5kLCB1bmFibGUgdG8gY29tbXVuaWNhdGUgd2l0aCBkZXZpY2UnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBvbiBzb21lIHN5c3RlbXMgc29tZXRpbWVzIHRoZSBXZWIgSW5zcGVjdG9yIG5ldmVyIHNlbmRzIHRoZSB0YXJnZXQgZXZlbnRcbiAgICAgIC8vIHRob3VnaCB0aGUgdGFyZ2V0IGlzIGF2YWlsYWJsZVxuICAgICAgbG9nLmRlYnVnKGBObyB0YXJnZXQgZm91bmQuIFRyeWluZyAnJHtHRU5FUklDX1RBUkdFVF9JRH0nLCB3aGljaCBzZWVtcyB0byB3b3JrYCk7XG4gICAgICB0aGlzLmFkZFRhcmdldCh7dGFyZ2V0SWQ6IEdFTkVSSUNfVEFSR0VUX0lEfSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VuZCAoY29tbWFuZCwgb3B0cyA9IHt9KSB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gcHJvY2Vzcy5ocnRpbWUoKTtcbiAgICBjb25zdCB7XG4gICAgICBhcHBJZEtleSxcbiAgICAgIHBhZ2VJZEtleVxuICAgIH0gPSBvcHRzO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLndhaXRGb3JUYXJnZXQoYXBwSWRLZXksIHBhZ2VJZEtleSk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kVG9EZXZpY2UoY29tbWFuZCwgb3B0cyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5jbHVkZXMoYCdUYXJnZXQnIGRvbWFpbiB3YXMgbm90IGZvdW5kYCkpIHtcbiAgICAgICAgdGhpcy5zZXRDb21tdW5pY2F0aW9uUHJvdG9jb2woZmFsc2UpO1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kVG9EZXZpY2UoY29tbWFuZCwgb3B0cyk7XG4gICAgICB9IGVsc2UgaWYgKGVyci5tZXNzYWdlLmluY2x1ZGVzKGBkb21haW4gd2FzIG5vdCBmb3VuZGApKSB7XG4gICAgICAgIHRoaXMuc2V0Q29tbXVuaWNhdGlvblByb3RvY29sKHRydWUpO1xuICAgICAgICBhd2FpdCB0aGlzLndhaXRGb3JUYXJnZXQoYXBwSWRLZXksIHBhZ2VJZEtleSk7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnNlbmRUb0RldmljZShjb21tYW5kLCBvcHRzKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnIpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBsb2cuZGVidWcoYFNlbmRpbmcgdG8gV2ViIEluc3BlY3RvciB0b29rICR7Z2V0RWxhcHNlZFRpbWUoc3RhcnRUaW1lKX1tc2ApO1xuICAgIH1cbiAgfVxuXG4gIGdldExvZ2dhYmxlUmVzcG9uc2UgKHJlcykge1xuICAgIHJldHVybiBfLmlzU3RyaW5nKHJlcylcbiAgICAgID8gcmVzXG4gICAgICA6IHRoaXMubG9nRnVsbFJlc3BvbnNlXG4gICAgICAgID8gSlNPTi5zdHJpbmdpZnkocmVzLCBudWxsLCAyKVxuICAgICAgICA6IF8udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkocmVzKSwgREFUQV9MT0dfTEVOR1RIKTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRUb0RldmljZSAoY29tbWFuZCwgb3B0cyA9IHt9KSB7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIHByb21pc2UgdG8gYmUgcmVzb2x2ZWQgd2hlbmV2ZXIgcmVtb3RlIGRlYnVnZ2VyXG4gICAgICAvLyByZXBsaWVzIHRvIG91ciByZXF1ZXN0XG5cbiAgICAgIC8vIGtlZXAgdHJhY2sgb2YgdGhlIG1lc3NhZ2VzIGNvbWluZyBhbmQgZ29pbmcgdXNpbmcgYSBzaW1wbGUgc2VxdWVudGlhbCBpZFxuICAgICAgY29uc3QgbXNnSWQgPSB0aGlzLm1zZ0lkKys7XG5cbiAgICAgIC8vIHJldHJpZXZlIHRoZSBjb3JyZWN0IGNvbW1hbmQgdG8gc2VuZFxuICAgICAgY29uc3Qgc2VuZE9wdHMgPSBfLmRlZmF1bHRzKHtjb25uSWQ6IHRoaXMuY29ubklkLCBzZW5kZXJJZDogdGhpcy5zZW5kZXJJZH0sIG9wdHMpO1xuICAgICAgY29uc3QgY21kID0gdGhpcy5yZW1vdGVNZXNzYWdlcy5nZXRSZW1vdGVDb21tYW5kKGNvbW1hbmQsIHNlbmRPcHRzKTtcblxuICAgICAgbGV0IG1lc3NhZ2VIYW5kbGVkID0gZmFsc2U7XG4gICAgICBpZiAodGhpcy5tZXNzYWdlSGFuZGxlci5oYXNTcGVjaWFsTWVzc2FnZUhhbmRsZXIoY21kLl9fc2VsZWN0b3IpKSB7XG4gICAgICAgIG1lc3NhZ2VIYW5kbGVkID0gdHJ1ZTtcblxuICAgICAgICAvLyBzcGVjaWFsIHJlcGxpZXMgd2lsbCByZXR1cm4gYW55IG51bWJlciBvZiBhcmd1bWVudHNcbiAgICAgICAgLy8gdGVtcG9yYXJpbHkgd3JhcCB3aXRoIHByb21pc2UgaGFuZGxpbmdcbiAgICAgICAgY29uc3Qgc3BlY2lhbE1lc3NhZ2VIYW5kbGVyID0gdGhpcy5nZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoY21kLl9fc2VsZWN0b3IpO1xuICAgICAgICB0aGlzLnNldFNwZWNpYWxNZXNzYWdlSGFuZGxlcihjbWQuX19zZWxlY3RvciwgcmVqZWN0LCAoLi4uYXJncykgPT4ge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgcmVzcG9uc2UgZnJvbSBzZW5kIChpZDogJHttc2dJZH0pOiAnJHt0aGlzLmdldExvZ2dhYmxlUmVzcG9uc2UoYXJncyl9J2ApO1xuXG4gICAgICAgICAgLy8gY2FsbCB0aGUgb3JpZ2luYWwgbGlzdGVuZXIsIGFuZCBwdXQgaXQgYmFjaywgaWYgbmVjZXNzYXJ5XG4gICAgICAgICAgc3BlY2lhbE1lc3NhZ2VIYW5kbGVyKC4uLmFyZ3MpO1xuICAgICAgICAgIGlmICh0aGlzLm1lc3NhZ2VIYW5kbGVyLmhhc1NwZWNpYWxNZXNzYWdlSGFuZGxlcihjbWQuX19zZWxlY3RvcikpIHtcbiAgICAgICAgICAgIC8vIHRoaXMgbWVhbnMgdGhhdCB0aGUgc3lzdGVtIGhhcyBub3QgcmVtb3ZlZCB0aGlzIGxpc3RlbmVyXG4gICAgICAgICAgICB0aGlzLnNldFNwZWNpYWxNZXNzYWdlSGFuZGxlcihjbWQuX19zZWxlY3RvciwgbnVsbCwgc3BlY2lhbE1lc3NhZ2VIYW5kbGVyKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXNvbHZlKGFyZ3MpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAoY21kLl9fYXJndW1lbnQgJiYgY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleSkge1xuICAgICAgICBtZXNzYWdlSGFuZGxlZCA9IHRydWU7XG5cbiAgICAgICAgY29uc3QgZXJyb3JIYW5kbGVyID0gZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgIGNvbnN0IG1zZyA9IGBSZW1vdGUgZGVidWdnZXIgZXJyb3Igd2l0aCBjb2RlICcke2Vyci5jb2RlfSc6ICR7ZXJyLm1lc3NhZ2V9YDtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKG1zZykpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuc2V0RGF0YU1lc3NhZ2VIYW5kbGVyKG1zZ0lkLnRvU3RyaW5nKCksIGVycm9ySGFuZGxlciwgKHZhbHVlKSA9PiB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCBkYXRhIHJlc3BvbnNlIGZyb20gc2VuZCAoaWQ6ICR7bXNnSWR9KTogJyR7dGhpcy5nZXRMb2dnYWJsZVJlc3BvbnNlKHZhbHVlKX0nYCk7XG4gICAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIG1ha2Ugc3VyZSB0aGUgbWVzc2FnZSBiZWluZyBzZW50IGhhcyBhbGwgdGhlIGluZm9ybWF0aW9uIHRoYXQgaXMgbmVlZGVkXG4gICAgICAgIGlmIChjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnBhcmFtcykge1xuICAgICAgICAgIGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkucGFyYW1zLmlkID0gbXNnSWQ7XG4gICAgICAgICAgaWYgKCFjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnBhcmFtcy50YXJnZXRJZCAmJiB0aGlzLm5lZWRzVGFyZ2V0KCkpIHtcbiAgICAgICAgICAgIGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkucGFyYW1zLnRhcmdldElkID0gdGhpcy5nZXRUYXJnZXQoc2VuZE9wdHMuYXBwSWRLZXksIHNlbmRPcHRzLnBhZ2VJZEtleSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnBhcmFtcy5tZXNzYWdlKSB7XG4gICAgICAgICAgICBjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnBhcmFtcy5tZXNzYWdlLmlkID0gbXNnSWQ7XG4gICAgICAgICAgICBjbWQuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnBhcmFtcy5tZXNzYWdlID0gSlNPTi5zdHJpbmdpZnkoY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS5wYXJhbXMubWVzc2FnZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNtZC5fX2FyZ3VtZW50LldJUlNvY2tldERhdGFLZXkuaWQgPSBtc2dJZDtcbiAgICAgICAgY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleSA9XG4gICAgICAgICAgQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkoY21kLl9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleSkpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBtc2cgPSBgU2VuZGluZyAnJHtjbWQuX19zZWxlY3Rvcn0nIG1lc3NhZ2VgICtcbiAgICAgICAgKHNlbmRPcHRzLmFwcElkS2V5ID8gYCB0byBhcHAgJyR7c2VuZE9wdHMuYXBwSWRLZXl9J2AgOiAnJykgK1xuICAgICAgICAoc2VuZE9wdHMucGFnZUlkS2V5ID8gYCwgcGFnZSAnJHtzZW5kT3B0cy5wYWdlSWRLZXl9J2AgOiAnJykgK1xuICAgICAgICAodGhpcy5uZWVkc1RhcmdldCgpID8gYCwgdGFyZ2V0ICcke3RoaXMuZ2V0VGFyZ2V0KHNlbmRPcHRzLmFwcElkS2V5LCBzZW5kT3B0cy5wYWdlSWRLZXkpfSdgIDogJycpICtcbiAgICAgICAgYCAoaWQ6ICR7bXNnSWR9KWA7XG4gICAgICBsb2cuZGVidWcobXNnKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuc2VuZE1lc3NhZ2UoY21kKTtcbiAgICAgICAgaWYgKCFtZXNzYWdlSGFuZGxlZCkge1xuICAgICAgICAgIHJlc29sdmUocmVzKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRNZXNzYWdlICgvKiBjb21tYW5kICovKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICAgIHRocm93IG5ldyBFcnJvcihgU3ViLWNsYXNzZXMgbmVlZCB0byBpbXBsZW1lbnQgYSAnc2VuZE1lc3NhZ2UnIGZ1bmN0aW9uYCk7XG4gIH1cblxuICBhZGRUYXJnZXQgKHRhcmdldEluZm8pIHtcbiAgICBpZiAoXy5pc1VuZGVmaW5lZCh0YXJnZXRJbmZvKSB8fCBfLmlzVW5kZWZpbmVkKHRhcmdldEluZm8udGFyZ2V0SWQpKSB7XG4gICAgICBsb2cud2FybihgUmVjZWl2ZWQgJ3RhcmdldENyZWF0ZWQnIGV2ZW50IHdpdGggbm8gdGFyZ2V0LiBTa2lwcGluZ2ApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoXy5pc0VtcHR5KHRoaXMucGVuZGluZ1RhcmdldE5vdGlmaWNhdGlvbikpIHtcbiAgICAgIGxvZy53YXJuKGBSZWNlaXZlZCAndGFyZ2V0Q3JlYXRlZCcgZXZlbnQgd2l0aCBubyBwZW5kaW5nIHJlcXVlc3Q6ICR7SlNPTi5zdHJpbmdpZnkodGFyZ2V0SW5mbyl9YCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgW2FwcElkS2V5LCBwYWdlSWRLZXldID0gdGhpcy5wZW5kaW5nVGFyZ2V0Tm90aWZpY2F0aW9uIHx8IFtdO1xuICAgIHRoaXMucGVuZGluZ1RhcmdldE5vdGlmaWNhdGlvbiA9IG51bGw7XG5cbiAgICBsb2cuZGVidWcoYFRhcmdldCBjcmVhdGVkIGZvciBhcHAgJyR7YXBwSWRLZXl9JyBhbmQgcGFnZSAnJHtwYWdlSWRLZXl9JzogJHtKU09OLnN0cmluZ2lmeSh0YXJnZXRJbmZvKX1gKTtcbiAgICB0aGlzLnRhcmdldHNbYXBwSWRLZXldID0gdGhpcy50YXJnZXRzW2FwcElkS2V5XSB8fCB7fTtcbiAgICBpZiAoXy5pc0VtcHR5KHRoaXMudGFyZ2V0c1thcHBJZEtleV1bcGFnZUlkS2V5XSkpIHtcbiAgICAgIHRoaXMudGFyZ2V0c1thcHBJZEtleV1bcGFnZUlkS2V5XSA9IHRhcmdldEluZm8udGFyZ2V0SWQ7XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlVGFyZ2V0ICh0YXJnZXRJbmZvKSB7XG4gICAgaWYgKF8uaXNVbmRlZmluZWQodGFyZ2V0SW5mbykgfHwgXy5pc1VuZGVmaW5lZCh0YXJnZXRJbmZvLnRhcmdldElkKSkge1xuICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCAndGFyZ2V0RGVzdHJveWVkJyBldmVudCB3aXRoIG5vIHRhcmdldC4gU2tpcHBpbmdgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBUYXJnZXQgZGVzdHJveWVkOiAke0pTT04uc3RyaW5naWZ5KHRhcmdldEluZm8pfWApO1xuICAgIF8ucHVsbCh0aGlzLnRhcmdldHMsIHRhcmdldEluZm8udGFyZ2V0SWQpO1xuICB9XG5cbiAgZ2V0IHRhcmdldHMgKCkge1xuICAgIHRoaXMuX3RhcmdldHMgPSB0aGlzLl90YXJnZXRzIHx8IHt9O1xuICAgIHJldHVybiB0aGlzLl90YXJnZXRzO1xuICB9XG5cbiAgZ2V0VGFyZ2V0IChhcHBJZEtleSwgcGFnZUlkS2V5KSB7XG4gICAgY29uc3QgdGFyZ2V0ID0gKHRoaXMudGFyZ2V0c1thcHBJZEtleV0gfHwge30pW3BhZ2VJZEtleV07XG4gICAgcmV0dXJuIHRhcmdldDtcbiAgfVxuXG4gIGdldCBzaG91bGRDaGVja0ZvclRhcmdldCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3Nob3VsZENoZWNrRm9yVGFyZ2V0O1xuICB9XG5cbiAgc2V0IHNob3VsZENoZWNrRm9yVGFyZ2V0IChzaG91bGRDaGVja0ZvclRhcmdldCkge1xuICAgIHRoaXMuX3Nob3VsZENoZWNrRm9yVGFyZ2V0ID0gISFzaG91bGRDaGVja0ZvclRhcmdldDtcbiAgfVxuXG4gIGFzeW5jIGNvbm5lY3QgKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFN1Yi1jbGFzc2VzIG5lZWQgdG8gaW1wbGVtZW50IGEgJ2Nvbm5lY3QnIGZ1bmN0aW9uYCk7XG4gIH1cblxuICBhc3luYyBkaXNjb25uZWN0ICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gICAgdGhyb3cgbmV3IEVycm9yKGBTdWItY2xhc3NlcyBuZWVkIHRvIGltcGxlbWVudCBhICdkaXNjb25uZWN0JyBmdW5jdGlvbmApO1xuICB9XG5cbiAgaXNDb25uZWN0ZWQgKCkge1xuICAgIHJldHVybiB0aGlzLmNvbm5lY3RlZDtcbiAgfVxuXG4gIHNldFNwZWNpYWxNZXNzYWdlSGFuZGxlciAoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpIHtcbiAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNldFNwZWNpYWxNZXNzYWdlSGFuZGxlcihrZXksIGVycm9ySGFuZGxlciwgaGFuZGxlcik7XG4gIH1cblxuICBnZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIgKGtleSkge1xuICAgIHJldHVybiB0aGlzLm1lc3NhZ2VIYW5kbGVyLmdldFNwZWNpYWxNZXNzYWdlSGFuZGxlcihrZXkpO1xuICB9XG5cbiAgc2V0RGF0YU1lc3NhZ2VIYW5kbGVyIChrZXksIGVycm9ySGFuZGxlciwgaGFuZGxlcikge1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXIuc2V0RGF0YU1lc3NhZ2VIYW5kbGVyKGtleSwgZXJyb3JIYW5kbGVyLCBoYW5kbGVyKTtcbiAgfVxuXG4gIGFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQgKGFsbG93ID0gdHJ1ZSkge1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXIuYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZChhbGxvdyk7XG4gIH1cblxuICBhc3luYyBzZWxlY3RQYWdlIChhcHBJZEtleSwgcGFnZUlkS2V5KSB7XG4gICAgdGhpcy5wZW5kaW5nVGFyZ2V0Tm90aWZpY2F0aW9uID0gW2FwcElkS2V5LCBwYWdlSWRLZXldO1xuICAgIHRoaXMuc2hvdWxkQ2hlY2tGb3JUYXJnZXQgPSBmYWxzZTtcbiAgICBhd2FpdCB0aGlzLnNlbmQoJ3NldFNlbmRlcktleScsIHtcbiAgICAgIGFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5LFxuICAgIH0pO1xuICAgIGxvZy5kZWJ1ZygnU2VuZGVyIGtleSBzZXQnKTtcblxuICAgIHRoaXMuc2hvdWxkQ2hlY2tGb3JUYXJnZXQgPSB0cnVlO1xuICAgIGF3YWl0IHRoaXMuc2VuZCgnZW5hYmxlUGFnZScsIHtcbiAgICAgIGFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5LFxuICAgIH0pO1xuICAgIGxvZy5kZWJ1ZygnRW5hYmxlZCBhY3Rpdml0eSBvbiBwYWdlJyk7XG4gIH1cblxuICBhc3luYyBzZWxlY3RBcHAgKGFwcElkS2V5LCBhcHBsaWNhdGlvbkNvbm5lY3RlZEhhbmRsZXIpIHtcbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gbG9jYWwgY2FsbGJhY2ssIHRlbXBvcmFyaWx5IGFkZGVkIGFzIGNhbGxiYWNrIHRvXG4gICAgICAvLyBgX3JwY19hcHBsaWNhdGlvbkNvbm5lY3RlZDpgIHJlbW90ZSBkZWJ1Z2dlciByZXNwb25zZVxuICAgICAgLy8gdG8gaGFuZGxlIHRoZSBpbml0aWFsIGNvbm5lY3Rpb25cbiAgICAgIGNvbnN0IG9uQXBwQ2hhbmdlID0gKGRpY3QpID0+IHtcbiAgICAgICAgLy8gZnJvbSB0aGUgZGljdGlvbmFyeSByZXR1cm5lZCwgZ2V0IHRoZSBpZHNcbiAgICAgICAgbGV0IG9sZEFwcElkS2V5ID0gZGljdC5XSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5O1xuICAgICAgICBsZXQgY29ycmVjdEFwcElkS2V5ID0gZGljdC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG5cbiAgICAgICAgLy8gaWYgdGhpcyBpcyBhIHJlcG9ydCBvZiBhIHByb3h5IHJlZGlyZWN0IGZyb20gdGhlIHJlbW90ZSBkZWJ1Z2dlclxuICAgICAgICAvLyB3ZSB3YW50IHRvIHVwZGF0ZSBvdXIgZGljdGlvbmFyeSBhbmQgZ2V0IGEgbmV3IGFwcCBpZFxuICAgICAgICBpZiAob2xkQXBwSWRLZXkgJiYgY29ycmVjdEFwcElkS2V5ICE9PSBvbGRBcHBJZEtleSkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgV2Ugd2VyZSBub3RpZmllZCB3ZSBtaWdodCBoYXZlIGNvbm5lY3RlZCB0byB0aGUgd3JvbmcgYXBwLiBgICtcbiAgICAgICAgICAgICAgICAgICAgYFVzaW5nIGlkICR7Y29ycmVjdEFwcElkS2V5fSBpbnN0ZWFkIG9mICR7b2xkQXBwSWRLZXl9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBhcHBsaWNhdGlvbkNvbm5lY3RlZEhhbmRsZXIoZGljdCk7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ05ldyBhcHBsaWNhdGlvbiBoYXMgY29ubmVjdGVkJykpO1xuICAgICAgfTtcbiAgICAgIHRoaXMuc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKCdfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOicsIHJlamVjdCwgb25BcHBDaGFuZ2UpO1xuXG4gICAgICAvLyBkbyB0aGUgYWN0dWFsIGNvbm5lY3RpbmcgdG8gdGhlIGFwcFxuICAgICAgcmV0dXJuIChhc3luYyAoKSA9PiB7XG4gICAgICAgIGxldCBwYWdlRGljdCwgY29ubmVjdGVkQXBwSWRLZXk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgKFtjb25uZWN0ZWRBcHBJZEtleSwgcGFnZURpY3RdID0gYXdhaXQgdGhpcy5zZW5kKCdjb25uZWN0VG9BcHAnLCB7XG4gICAgICAgICAgICBhcHBJZEtleVxuICAgICAgICAgIH0pKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLndhcm4oYFVuYWJsZSB0byBjb25uZWN0IHRvIGFwcDogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHNvbWV0aW1lcyB0aGUgY29ubmVjdCBsb2dpYyBoYXBwZW5zLCBidXQgd2l0aCBhbiBlbXB0eSBkaWN0aW9uYXJ5XG4gICAgICAgIC8vIHdoaWNoIGxlYWRzIHRvIHRoZSByZW1vdGUgZGVidWdnZXIgZ2V0dGluZyBkaXNjb25uZWN0ZWQsIGFuZCBpbnRvIGEgbG9vcFxuICAgICAgICBpZiAoXy5pc0VtcHR5KHBhZ2VEaWN0KSkge1xuICAgICAgICAgIGxldCBtc2cgPSAnRW1wdHkgcGFnZSBkaWN0aW9uYXJ5IHJlY2VpdmVkJztcbiAgICAgICAgICBsb2cuZGVidWcobXNnKTtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKG1zZykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc29sdmUoW2Nvbm5lY3RlZEFwcElkS2V5LCBwYWdlRGljdF0pO1xuICAgICAgICB9XG4gICAgICB9KSgpO1xuICAgIH0pLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgLy8gbm8gbWF0dGVyIHdoYXQsIHdlIHdhbnQgdG8gcmVzdG9yZSB0aGUgaGFuZGxlciB0aGF0IHdhcyBjaGFuZ2VkLlxuICAgICAgdGhpcy5zZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoJ19ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6JywgbnVsbCwgYXBwbGljYXRpb25Db25uZWN0ZWRIYW5kbGVyKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHJlY2VpdmUgKC8qIGRhdGEgKi8pIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gICAgdGhyb3cgbmV3IEVycm9yKGBTdWItY2xhc3NlcyBuZWVkIHRvIGltcGxlbWVudCBhICdyZWNlaXZlJyBmdW5jdGlvbmApO1xuICB9XG5cbiAgc2V0VGltZWxpbmVFdmVudEhhbmRsZXIgKHRpbWVsaW5lRXZlbnRIYW5kbGVyKSB7XG4gICAgdGhpcy50aW1lbGluZUV2ZW50SGFuZGxlciA9IHRpbWVsaW5lRXZlbnRIYW5kbGVyO1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXIuc2V0VGltZWxpbmVFdmVudEhhbmRsZXIodGltZWxpbmVFdmVudEhhbmRsZXIpO1xuICB9XG5cbiAgc2V0Q29uc29sZUxvZ0V2ZW50SGFuZGxlciAoY29uc29sZUV2ZW50SGFuZGxlcikge1xuICAgIHRoaXMuY29uc29sZUV2ZW50SGFuZGxlciA9IGNvbnNvbGVFdmVudEhhbmRsZXI7XG4gICAgdGhpcy5tZXNzYWdlSGFuZGxlci5zZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyKGNvbnNvbGVFdmVudEhhbmRsZXIpO1xuICB9XG5cbiAgc2V0TmV0d29ya0xvZ0V2ZW50SGFuZGxlciAobmV0d29ya0V2ZW50SGFuZGxlcikge1xuICAgIHRoaXMubmV0d29ya0V2ZW50SGFuZGxlciA9IG5ldHdvcmtFdmVudEhhbmRsZXI7XG4gICAgdGhpcy5tZXNzYWdlSGFuZGxlci5zZXROZXR3b3JrRXZlbnRIYW5kbGVyKG5ldHdvcmtFdmVudEhhbmRsZXIpO1xuICB9XG59XG4iXSwiZmlsZSI6ImxpYi9ycGMtY2xpZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
