"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.appInfoFromDict = appInfoFromDict;
exports.pageArrayFromDict = pageArrayFromDict;
exports.getDebuggerAppKey = getDebuggerAppKey;
exports.getPossibleDebuggerAppKeys = getPossibleDebuggerAppKeys;
exports.checkParams = checkParams;
exports.wrapScriptForFrame = wrapScriptForFrame;
exports.getScriptForAtom = getScriptForAtom;
exports.simpleStringify = simpleStringify;
exports.deferredPromise = deferredPromise;
exports.isTargetBased = isTargetBased;
exports.getElapsedTime = getElapsedTime;
exports.convertResult = convertResult;
exports.RESPONSE_LOG_LENGTH = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _atoms = _interopRequireDefault(require("./atoms"));

var _lodash = _interopRequireDefault(require("lodash"));

var _assert = _interopRequireDefault(require("assert"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumSupport = require("appium-support");

var _appiumBaseDriver = require("appium-base-driver");

const WEB_CONTENT_BUNDLE_ID = 'com.apple.WebKit.WebContent';
const MIN_PLATFORM_FOR_TARGET_BASED = '12.2';
const RESPONSE_LOG_LENGTH = 100;
exports.RESPONSE_LOG_LENGTH = RESPONSE_LOG_LENGTH;

function appInfoFromDict(dict) {
  const id = dict.WIRApplicationIdentifierKey;
  const isProxy = _lodash.default.isString(dict.WIRIsApplicationProxyKey) ? dict.WIRIsApplicationProxyKey.toLowerCase() === 'true' : dict.WIRIsApplicationProxyKey;
  const entry = {
    id,
    isProxy,
    name: dict.WIRApplicationNameKey,
    bundleId: dict.WIRApplicationBundleIdentifierKey,
    hostId: dict.WIRHostApplicationIdentifierKey,
    isActive: dict.WIRIsApplicationActiveKey,
    isAutomationEnabled: !!dict.WIRRemoteAutomationEnabledKey
  };
  return [id, entry];
}

function pageArrayFromDict(pageDict) {
  if (pageDict.id) {
    return [pageDict];
  }

  let newPageArray = [];

  for (const dict of _lodash.default.values(pageDict)) {
    if (_lodash.default.isUndefined(dict.WIRTypeKey) || dict.WIRTypeKey === 'WIRTypeWeb') {
      newPageArray.push({
        id: dict.WIRPageIdentifierKey,
        title: dict.WIRTitleKey,
        url: dict.WIRURLKey,
        isKey: !_lodash.default.isUndefined(dict.WIRConnectionIdentifierKey)
      });
    }
  }

  return newPageArray;
}

function getDebuggerAppKey(bundleId, platformVersion, appDict) {
  let appId;

  if (parseFloat(platformVersion) >= 8) {
    for (const [key, data] of _lodash.default.toPairs(appDict)) {
      if (data.bundleId === bundleId) {
        appId = key;
        break;
      }
    }

    if (appId) {
      _logger.default.debug(`Found app id key '${appId}' for bundle '${bundleId}'`);

      let proxiedAppIds = [];

      for (const [key, data] of _lodash.default.toPairs(appDict)) {
        if (data.isProxy && data.hostId === appId) {
          _logger.default.debug(`Found separate bundleId '${data.bundleId}' ` + `acting as proxy for '${bundleId}', with app id '${key}'`);

          proxiedAppIds.push(key);
        }
      }

      if (proxiedAppIds.length) {
        appId = _lodash.default.last(proxiedAppIds);

        _logger.default.debug(`Using proxied app id '${appId}'`);
      }
    }
  } else {
    if (_lodash.default.has(appDict, bundleId)) {
      appId = bundleId;
    }
  }

  return appId;
}

function appIdForBundle(bundleId, appDict) {
  let appId;

  for (const [key, data] of _lodash.default.toPairs(appDict)) {
    if (data.bundleId.endsWith(bundleId)) {
      appId = key;
      break;
    }
  }

  if (!appId && bundleId !== WEB_CONTENT_BUNDLE_ID) {
    return appIdForBundle(WEB_CONTENT_BUNDLE_ID, appDict);
  }

  return appId;
}

function getPossibleDebuggerAppKeys(bundleIds, platformVersion, appDict) {
  let proxiedAppIds = [];

  for (const bundleId of bundleIds) {
    const appId = appIdForBundle(bundleId, appDict);

    if (appId) {
      proxiedAppIds.push(appId);

      _logger.default.debug(`Found app id key '${appId}' for bundle '${bundleId}'`);

      for (const [key, data] of _lodash.default.toPairs(appDict)) {
        if (data.isProxy && data.hostId === appId) {
          _logger.default.debug(`Found separate bundleId '${data.bundleId}' ` + `acting as proxy for '${bundleId}', with app id '${key}'`);

          proxiedAppIds.push(key);
        }
      }
    }
  }

  return proxiedAppIds;
}

function checkParams(params) {
  let errors = [];

  for (const [param, value] of _lodash.default.toPairs(params)) {
    try {
      _assert.default.ok(value);
    } catch (err) {
      errors.push(param);
    }
  }

  if (errors.length) {
    return errors;
  }
}

async function wrapScriptForFrame(script, frame) {
  _logger.default.debug(`Wrapping script for frame '${frame}'`);

  let elFromCache = await (0, _atoms.default)('get_element_from_cache');
  return `(function (window) { var document = window.document; ` + `return (${script}); })((${elFromCache.toString('utf8')})(${JSON.stringify(frame)}))`;
}

async function getScriptForAtom(atom, args, frames, asyncCallBack = null) {
  let atomSrc = await (0, _atoms.default)(atom);
  let script;

  if (frames.length > 0) {
    script = atomSrc;

    for (const frame of frames) {
      script = await wrapScriptForFrame(script, frame);
    }
  } else {
    _logger.default.debug(`Executing '${atom}' atom in default context`);

    script = `(${atomSrc})`;
  }

  args = args.map(JSON.stringify);

  if (asyncCallBack) {
    script += `(${args.join(',')}, ${asyncCallBack}, true )`;
  } else {
    script += `(${args.join(',')})`;
  }

  return script;
}

function simpleStringify(value, multiline = false) {
  if (!value) {
    return JSON.stringify(value);
  }

  let cleanValue = _lodash.default.clone(value);

  for (const property of ['ceil', 'clone', 'floor', 'round', 'scale', 'toString']) {
    delete cleanValue[property];
  }

  return multiline ? JSON.stringify(cleanValue, null, 2) : JSON.stringify(cleanValue);
}

function deferredPromise() {
  let resolve;
  let reject;
  const promise = new _bluebird.default((res, rej) => {
    resolve = res;
    reject = rej;
  });
  return {
    promise,
    resolve,
    reject
  };
}

function isTargetBased(isSafari, platformVersion) {
  const isHighVersion = _appiumSupport.util.compareVersions(platformVersion, '>=', MIN_PLATFORM_FOR_TARGET_BASED);

  _logger.default.debug(`Checking which communication style to use (${isSafari ? '' : 'non-'}Safari on platform version '${platformVersion}')`);

  _logger.default.debug(`Platform version equal or higher than '${MIN_PLATFORM_FOR_TARGET_BASED}': ${isHighVersion}`);

  return isSafari && isHighVersion;
}

function getElapsedTime(startTime) {
  const endTime = process.hrtime(startTime);
  return parseInt((endTime[0] * 1e9 + endTime[1]) / 1e6, 10);
}

function convertResult(res) {
  if (_lodash.default.isUndefined(res)) {
    throw new Error(`Did not get OK result from remote debugger. Result was: ${_lodash.default.truncate(simpleStringify(res), {
      length: RESPONSE_LOG_LENGTH
    })}`);
  } else if (_lodash.default.isString(res)) {
    try {
      res = JSON.parse(res);
    } catch (err) {}
  } else if (!_lodash.default.isObject(res)) {
    throw new Error(`Result has unexpected type: (${typeof res}).`);
  }

  if (res.status && res.status !== 0) {
    throw (0, _appiumBaseDriver.errorFromMJSONWPStatusCode)(res.status, res.value.message || res.value);
  }

  return _lodash.default.has(res, 'value') ? res.value : res;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9oZWxwZXJzLmpzIl0sIm5hbWVzIjpbIldFQl9DT05URU5UX0JVTkRMRV9JRCIsIk1JTl9QTEFURk9STV9GT1JfVEFSR0VUX0JBU0VEIiwiUkVTUE9OU0VfTE9HX0xFTkdUSCIsImFwcEluZm9Gcm9tRGljdCIsImRpY3QiLCJpZCIsIldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleSIsImlzUHJveHkiLCJfIiwiaXNTdHJpbmciLCJXSVJJc0FwcGxpY2F0aW9uUHJveHlLZXkiLCJ0b0xvd2VyQ2FzZSIsImVudHJ5IiwibmFtZSIsIldJUkFwcGxpY2F0aW9uTmFtZUtleSIsImJ1bmRsZUlkIiwiV0lSQXBwbGljYXRpb25CdW5kbGVJZGVudGlmaWVyS2V5IiwiaG9zdElkIiwiV0lSSG9zdEFwcGxpY2F0aW9uSWRlbnRpZmllcktleSIsImlzQWN0aXZlIiwiV0lSSXNBcHBsaWNhdGlvbkFjdGl2ZUtleSIsImlzQXV0b21hdGlvbkVuYWJsZWQiLCJXSVJSZW1vdGVBdXRvbWF0aW9uRW5hYmxlZEtleSIsInBhZ2VBcnJheUZyb21EaWN0IiwicGFnZURpY3QiLCJuZXdQYWdlQXJyYXkiLCJ2YWx1ZXMiLCJpc1VuZGVmaW5lZCIsIldJUlR5cGVLZXkiLCJwdXNoIiwiV0lSUGFnZUlkZW50aWZpZXJLZXkiLCJ0aXRsZSIsIldJUlRpdGxlS2V5IiwidXJsIiwiV0lSVVJMS2V5IiwiaXNLZXkiLCJXSVJDb25uZWN0aW9uSWRlbnRpZmllcktleSIsImdldERlYnVnZ2VyQXBwS2V5IiwicGxhdGZvcm1WZXJzaW9uIiwiYXBwRGljdCIsImFwcElkIiwicGFyc2VGbG9hdCIsImtleSIsImRhdGEiLCJ0b1BhaXJzIiwibG9nIiwiZGVidWciLCJwcm94aWVkQXBwSWRzIiwibGVuZ3RoIiwibGFzdCIsImhhcyIsImFwcElkRm9yQnVuZGxlIiwiZW5kc1dpdGgiLCJnZXRQb3NzaWJsZURlYnVnZ2VyQXBwS2V5cyIsImJ1bmRsZUlkcyIsImNoZWNrUGFyYW1zIiwicGFyYW1zIiwiZXJyb3JzIiwicGFyYW0iLCJ2YWx1ZSIsImFzc2VydCIsIm9rIiwiZXJyIiwid3JhcFNjcmlwdEZvckZyYW1lIiwic2NyaXB0IiwiZnJhbWUiLCJlbEZyb21DYWNoZSIsInRvU3RyaW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsImdldFNjcmlwdEZvckF0b20iLCJhdG9tIiwiYXJncyIsImZyYW1lcyIsImFzeW5jQ2FsbEJhY2siLCJhdG9tU3JjIiwibWFwIiwiam9pbiIsInNpbXBsZVN0cmluZ2lmeSIsIm11bHRpbGluZSIsImNsZWFuVmFsdWUiLCJjbG9uZSIsInByb3BlcnR5IiwiZGVmZXJyZWRQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInByb21pc2UiLCJCIiwicmVzIiwicmVqIiwiaXNUYXJnZXRCYXNlZCIsImlzU2FmYXJpIiwiaXNIaWdoVmVyc2lvbiIsInV0aWwiLCJjb21wYXJlVmVyc2lvbnMiLCJnZXRFbGFwc2VkVGltZSIsInN0YXJ0VGltZSIsImVuZFRpbWUiLCJwcm9jZXNzIiwiaHJ0aW1lIiwicGFyc2VJbnQiLCJjb252ZXJ0UmVzdWx0IiwiRXJyb3IiLCJ0cnVuY2F0ZSIsInBhcnNlIiwiaXNPYmplY3QiLCJzdGF0dXMiLCJtZXNzYWdlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLHFCQUFxQixHQUFHLDZCQUE5QjtBQUNBLE1BQU1DLDZCQUE2QixHQUFHLE1BQXRDO0FBRUEsTUFBTUMsbUJBQW1CLEdBQUcsR0FBNUI7OztBQU1BLFNBQVNDLGVBQVQsQ0FBMEJDLElBQTFCLEVBQWdDO0FBQzlCLFFBQU1DLEVBQUUsR0FBR0QsSUFBSSxDQUFDRSwyQkFBaEI7QUFDQSxRQUFNQyxPQUFPLEdBQUdDLGdCQUFFQyxRQUFGLENBQVdMLElBQUksQ0FBQ00sd0JBQWhCLElBQ1pOLElBQUksQ0FBQ00sd0JBQUwsQ0FBOEJDLFdBQTlCLE9BQWdELE1BRHBDLEdBRVpQLElBQUksQ0FBQ00sd0JBRlQ7QUFHQSxRQUFNRSxLQUFLLEdBQUc7QUFDWlAsSUFBQUEsRUFEWTtBQUVaRSxJQUFBQSxPQUZZO0FBR1pNLElBQUFBLElBQUksRUFBRVQsSUFBSSxDQUFDVSxxQkFIQztBQUlaQyxJQUFBQSxRQUFRLEVBQUVYLElBQUksQ0FBQ1ksaUNBSkg7QUFLWkMsSUFBQUEsTUFBTSxFQUFFYixJQUFJLENBQUNjLCtCQUxEO0FBTVpDLElBQUFBLFFBQVEsRUFBRWYsSUFBSSxDQUFDZ0IseUJBTkg7QUFPWkMsSUFBQUEsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDakIsSUFBSSxDQUFDa0I7QUFQaEIsR0FBZDtBQVVBLFNBQU8sQ0FBQ2pCLEVBQUQsRUFBS08sS0FBTCxDQUFQO0FBQ0Q7O0FBTUQsU0FBU1csaUJBQVQsQ0FBNEJDLFFBQTVCLEVBQXNDO0FBQ3BDLE1BQUlBLFFBQVEsQ0FBQ25CLEVBQWIsRUFBaUI7QUFFZixXQUFPLENBQUNtQixRQUFELENBQVA7QUFDRDs7QUFDRCxNQUFJQyxZQUFZLEdBQUcsRUFBbkI7O0FBQ0EsT0FBSyxNQUFNckIsSUFBWCxJQUFtQkksZ0JBQUVrQixNQUFGLENBQVNGLFFBQVQsQ0FBbkIsRUFBdUM7QUFFckMsUUFBSWhCLGdCQUFFbUIsV0FBRixDQUFjdkIsSUFBSSxDQUFDd0IsVUFBbkIsS0FBa0N4QixJQUFJLENBQUN3QixVQUFMLEtBQW9CLFlBQTFELEVBQXdFO0FBQ3RFSCxNQUFBQSxZQUFZLENBQUNJLElBQWIsQ0FBa0I7QUFDaEJ4QixRQUFBQSxFQUFFLEVBQUVELElBQUksQ0FBQzBCLG9CQURPO0FBRWhCQyxRQUFBQSxLQUFLLEVBQUUzQixJQUFJLENBQUM0QixXQUZJO0FBR2hCQyxRQUFBQSxHQUFHLEVBQUU3QixJQUFJLENBQUM4QixTQUhNO0FBSWhCQyxRQUFBQSxLQUFLLEVBQUUsQ0FBQzNCLGdCQUFFbUIsV0FBRixDQUFjdkIsSUFBSSxDQUFDZ0MsMEJBQW5CO0FBSlEsT0FBbEI7QUFNRDtBQUNGOztBQUNELFNBQU9YLFlBQVA7QUFDRDs7QUFNRCxTQUFTWSxpQkFBVCxDQUE0QnRCLFFBQTVCLEVBQXNDdUIsZUFBdEMsRUFBdURDLE9BQXZELEVBQWdFO0FBQzlELE1BQUlDLEtBQUo7O0FBQ0EsTUFBSUMsVUFBVSxDQUFDSCxlQUFELENBQVYsSUFBK0IsQ0FBbkMsRUFBc0M7QUFDcEMsU0FBSyxNQUFNLENBQUNJLEdBQUQsRUFBTUMsSUFBTixDQUFYLElBQTBCbkMsZ0JBQUVvQyxPQUFGLENBQVVMLE9BQVYsQ0FBMUIsRUFBOEM7QUFDNUMsVUFBSUksSUFBSSxDQUFDNUIsUUFBTCxLQUFrQkEsUUFBdEIsRUFBZ0M7QUFDOUJ5QixRQUFBQSxLQUFLLEdBQUdFLEdBQVI7QUFDQTtBQUNEO0FBQ0Y7O0FBRUQsUUFBSUYsS0FBSixFQUFXO0FBQ1RLLHNCQUFJQyxLQUFKLENBQVcscUJBQW9CTixLQUFNLGlCQUFnQnpCLFFBQVMsR0FBOUQ7O0FBQ0EsVUFBSWdDLGFBQWEsR0FBRyxFQUFwQjs7QUFDQSxXQUFLLE1BQU0sQ0FBQ0wsR0FBRCxFQUFNQyxJQUFOLENBQVgsSUFBMEJuQyxnQkFBRW9DLE9BQUYsQ0FBVUwsT0FBVixDQUExQixFQUE4QztBQUM1QyxZQUFJSSxJQUFJLENBQUNwQyxPQUFMLElBQWdCb0MsSUFBSSxDQUFDMUIsTUFBTCxLQUFnQnVCLEtBQXBDLEVBQTJDO0FBQ3pDSywwQkFBSUMsS0FBSixDQUFXLDRCQUEyQkgsSUFBSSxDQUFDNUIsUUFBUyxJQUExQyxHQUNDLHdCQUF1QkEsUUFBUyxtQkFBa0IyQixHQUFJLEdBRGpFOztBQUVBSyxVQUFBQSxhQUFhLENBQUNsQixJQUFkLENBQW1CYSxHQUFuQjtBQUNEO0FBQ0Y7O0FBQ0QsVUFBSUssYUFBYSxDQUFDQyxNQUFsQixFQUEwQjtBQUV4QlIsUUFBQUEsS0FBSyxHQUFHaEMsZ0JBQUV5QyxJQUFGLENBQU9GLGFBQVAsQ0FBUjs7QUFDQUYsd0JBQUlDLEtBQUosQ0FBVyx5QkFBd0JOLEtBQU0sR0FBekM7QUFDRDtBQUNGO0FBQ0YsR0F4QkQsTUF3Qk87QUFDTCxRQUFJaEMsZ0JBQUUwQyxHQUFGLENBQU1YLE9BQU4sRUFBZXhCLFFBQWYsQ0FBSixFQUE4QjtBQUM1QnlCLE1BQUFBLEtBQUssR0FBR3pCLFFBQVI7QUFDRDtBQUNGOztBQUVELFNBQU95QixLQUFQO0FBQ0Q7O0FBRUQsU0FBU1csY0FBVCxDQUF5QnBDLFFBQXpCLEVBQW1Dd0IsT0FBbkMsRUFBNEM7QUFDMUMsTUFBSUMsS0FBSjs7QUFDQSxPQUFLLE1BQU0sQ0FBQ0UsR0FBRCxFQUFNQyxJQUFOLENBQVgsSUFBMEJuQyxnQkFBRW9DLE9BQUYsQ0FBVUwsT0FBVixDQUExQixFQUE4QztBQUM1QyxRQUFJSSxJQUFJLENBQUM1QixRQUFMLENBQWNxQyxRQUFkLENBQXVCckMsUUFBdkIsQ0FBSixFQUFzQztBQUNwQ3lCLE1BQUFBLEtBQUssR0FBR0UsR0FBUjtBQUNBO0FBQ0Q7QUFDRjs7QUFHRCxNQUFJLENBQUNGLEtBQUQsSUFBVXpCLFFBQVEsS0FBS2YscUJBQTNCLEVBQWtEO0FBQ2hELFdBQU9tRCxjQUFjLENBQUNuRCxxQkFBRCxFQUF3QnVDLE9BQXhCLENBQXJCO0FBQ0Q7O0FBRUQsU0FBT0MsS0FBUDtBQUNEOztBQUVELFNBQVNhLDBCQUFULENBQXFDQyxTQUFyQyxFQUFnRGhCLGVBQWhELEVBQWlFQyxPQUFqRSxFQUEwRTtBQUN4RSxNQUFJUSxhQUFhLEdBQUcsRUFBcEI7O0FBRUEsT0FBSyxNQUFNaEMsUUFBWCxJQUF1QnVDLFNBQXZCLEVBQWtDO0FBQ2hDLFVBQU1kLEtBQUssR0FBR1csY0FBYyxDQUFDcEMsUUFBRCxFQUFXd0IsT0FBWCxDQUE1Qjs7QUFHQSxRQUFJQyxLQUFKLEVBQVc7QUFDVE8sTUFBQUEsYUFBYSxDQUFDbEIsSUFBZCxDQUFtQlcsS0FBbkI7O0FBQ0FLLHNCQUFJQyxLQUFKLENBQVcscUJBQW9CTixLQUFNLGlCQUFnQnpCLFFBQVMsR0FBOUQ7O0FBQ0EsV0FBSyxNQUFNLENBQUMyQixHQUFELEVBQU1DLElBQU4sQ0FBWCxJQUEwQm5DLGdCQUFFb0MsT0FBRixDQUFVTCxPQUFWLENBQTFCLEVBQThDO0FBQzVDLFlBQUlJLElBQUksQ0FBQ3BDLE9BQUwsSUFBZ0JvQyxJQUFJLENBQUMxQixNQUFMLEtBQWdCdUIsS0FBcEMsRUFBMkM7QUFDekNLLDBCQUFJQyxLQUFKLENBQVcsNEJBQTJCSCxJQUFJLENBQUM1QixRQUFTLElBQTFDLEdBQ0Msd0JBQXVCQSxRQUFTLG1CQUFrQjJCLEdBQUksR0FEakU7O0FBRUFLLFVBQUFBLGFBQWEsQ0FBQ2xCLElBQWQsQ0FBbUJhLEdBQW5CO0FBQ0Q7QUFDRjtBQUNGO0FBQ0Y7O0FBRUQsU0FBT0ssYUFBUDtBQUNEOztBQUVELFNBQVNRLFdBQVQsQ0FBc0JDLE1BQXRCLEVBQThCO0FBQzVCLE1BQUlDLE1BQU0sR0FBRyxFQUFiOztBQUNBLE9BQUssTUFBTSxDQUFDQyxLQUFELEVBQVFDLEtBQVIsQ0FBWCxJQUE2Qm5ELGdCQUFFb0MsT0FBRixDQUFVWSxNQUFWLENBQTdCLEVBQWdEO0FBQzlDLFFBQUk7QUFDRkksc0JBQU9DLEVBQVAsQ0FBVUYsS0FBVjtBQUNELEtBRkQsQ0FFRSxPQUFPRyxHQUFQLEVBQVk7QUFDWkwsTUFBQUEsTUFBTSxDQUFDNUIsSUFBUCxDQUFZNkIsS0FBWjtBQUNEO0FBQ0Y7O0FBQ0QsTUFBSUQsTUFBTSxDQUFDVCxNQUFYLEVBQW1CO0FBQ2pCLFdBQU9TLE1BQVA7QUFDRDtBQUNGOztBQUVELGVBQWVNLGtCQUFmLENBQW1DQyxNQUFuQyxFQUEyQ0MsS0FBM0MsRUFBa0Q7QUFDaERwQixrQkFBSUMsS0FBSixDQUFXLDhCQUE2Qm1CLEtBQU0sR0FBOUM7O0FBQ0EsTUFBSUMsV0FBVyxHQUFHLE1BQU0sb0JBQVEsd0JBQVIsQ0FBeEI7QUFDQSxTQUFRLHVEQUFELEdBQ0MsV0FBVUYsTUFBTyxVQUFTRSxXQUFXLENBQUNDLFFBQVosQ0FBcUIsTUFBckIsQ0FBNkIsS0FBSUMsSUFBSSxDQUFDQyxTQUFMLENBQWVKLEtBQWYsQ0FBc0IsSUFEekY7QUFFRDs7QUFFRCxlQUFlSyxnQkFBZixDQUFpQ0MsSUFBakMsRUFBdUNDLElBQXZDLEVBQTZDQyxNQUE3QyxFQUFxREMsYUFBYSxHQUFHLElBQXJFLEVBQTJFO0FBQ3pFLE1BQUlDLE9BQU8sR0FBRyxNQUFNLG9CQUFRSixJQUFSLENBQXBCO0FBQ0EsTUFBSVAsTUFBSjs7QUFDQSxNQUFJUyxNQUFNLENBQUN6QixNQUFQLEdBQWdCLENBQXBCLEVBQXVCO0FBQ3JCZ0IsSUFBQUEsTUFBTSxHQUFHVyxPQUFUOztBQUNBLFNBQUssTUFBTVYsS0FBWCxJQUFvQlEsTUFBcEIsRUFBNEI7QUFDMUJULE1BQUFBLE1BQU0sR0FBRyxNQUFNRCxrQkFBa0IsQ0FBQ0MsTUFBRCxFQUFTQyxLQUFULENBQWpDO0FBQ0Q7QUFDRixHQUxELE1BS087QUFDTHBCLG9CQUFJQyxLQUFKLENBQVcsY0FBYXlCLElBQUssMkJBQTdCOztBQUNBUCxJQUFBQSxNQUFNLEdBQUksSUFBR1csT0FBUSxHQUFyQjtBQUNEOztBQUdESCxFQUFBQSxJQUFJLEdBQUdBLElBQUksQ0FBQ0ksR0FBTCxDQUFTUixJQUFJLENBQUNDLFNBQWQsQ0FBUDs7QUFDQSxNQUFJSyxhQUFKLEVBQW1CO0FBQ2pCVixJQUFBQSxNQUFNLElBQUssSUFBR1EsSUFBSSxDQUFDSyxJQUFMLENBQVUsR0FBVixDQUFlLEtBQUlILGFBQWMsVUFBL0M7QUFDRCxHQUZELE1BRU87QUFDTFYsSUFBQUEsTUFBTSxJQUFLLElBQUdRLElBQUksQ0FBQ0ssSUFBTCxDQUFVLEdBQVYsQ0FBZSxHQUE3QjtBQUNEOztBQUVELFNBQU9iLE1BQVA7QUFDRDs7QUFFRCxTQUFTYyxlQUFULENBQTBCbkIsS0FBMUIsRUFBaUNvQixTQUFTLEdBQUcsS0FBN0MsRUFBb0Q7QUFDbEQsTUFBSSxDQUFDcEIsS0FBTCxFQUFZO0FBQ1YsV0FBT1MsSUFBSSxDQUFDQyxTQUFMLENBQWVWLEtBQWYsQ0FBUDtBQUNEOztBQUlELE1BQUlxQixVQUFVLEdBQUd4RSxnQkFBRXlFLEtBQUYsQ0FBUXRCLEtBQVIsQ0FBakI7O0FBQ0EsT0FBSyxNQUFNdUIsUUFBWCxJQUF1QixDQUFDLE1BQUQsRUFBUyxPQUFULEVBQWtCLE9BQWxCLEVBQTJCLE9BQTNCLEVBQW9DLE9BQXBDLEVBQTZDLFVBQTdDLENBQXZCLEVBQWlGO0FBQy9FLFdBQU9GLFVBQVUsQ0FBQ0UsUUFBRCxDQUFqQjtBQUNEOztBQUNELFNBQU9ILFNBQVMsR0FBR1gsSUFBSSxDQUFDQyxTQUFMLENBQWVXLFVBQWYsRUFBMkIsSUFBM0IsRUFBaUMsQ0FBakMsQ0FBSCxHQUF5Q1osSUFBSSxDQUFDQyxTQUFMLENBQWVXLFVBQWYsQ0FBekQ7QUFDRDs7QUFFRCxTQUFTRyxlQUFULEdBQTRCO0FBRTFCLE1BQUlDLE9BQUo7QUFDQSxNQUFJQyxNQUFKO0FBQ0EsUUFBTUMsT0FBTyxHQUFHLElBQUlDLGlCQUFKLENBQU0sQ0FBQ0MsR0FBRCxFQUFNQyxHQUFOLEtBQWM7QUFDbENMLElBQUFBLE9BQU8sR0FBR0ksR0FBVjtBQUNBSCxJQUFBQSxNQUFNLEdBQUdJLEdBQVQ7QUFDRCxHQUhlLENBQWhCO0FBSUEsU0FBTztBQUNMSCxJQUFBQSxPQURLO0FBRUxGLElBQUFBLE9BRks7QUFHTEMsSUFBQUE7QUFISyxHQUFQO0FBS0Q7O0FBRUQsU0FBU0ssYUFBVCxDQUF3QkMsUUFBeEIsRUFBa0NyRCxlQUFsQyxFQUFtRDtBQUVqRCxRQUFNc0QsYUFBYSxHQUFHQyxvQkFBS0MsZUFBTCxDQUFxQnhELGVBQXJCLEVBQXNDLElBQXRDLEVBQTRDckMsNkJBQTVDLENBQXRCOztBQUNBNEMsa0JBQUlDLEtBQUosQ0FBVyw4Q0FBNkM2QyxRQUFRLEdBQUcsRUFBSCxHQUFRLE1BQU8sK0JBQThCckQsZUFBZ0IsSUFBN0g7O0FBQ0FPLGtCQUFJQyxLQUFKLENBQVcsMENBQXlDN0MsNkJBQThCLE1BQUsyRixhQUFjLEVBQXJHOztBQUNBLFNBQU9ELFFBQVEsSUFBSUMsYUFBbkI7QUFDRDs7QUFFRCxTQUFTRyxjQUFULENBQXlCQyxTQUF6QixFQUFvQztBQUNsQyxRQUFNQyxPQUFPLEdBQUdDLE9BQU8sQ0FBQ0MsTUFBUixDQUFlSCxTQUFmLENBQWhCO0FBQ0EsU0FBT0ksUUFBUSxDQUFDLENBQUNILE9BQU8sQ0FBQyxDQUFELENBQVAsR0FBYSxHQUFiLEdBQW1CQSxPQUFPLENBQUMsQ0FBRCxDQUEzQixJQUFrQyxHQUFuQyxFQUF3QyxFQUF4QyxDQUFmO0FBQ0Q7O0FBRUQsU0FBU0ksYUFBVCxDQUF3QmIsR0FBeEIsRUFBNkI7QUFDM0IsTUFBSWhGLGdCQUFFbUIsV0FBRixDQUFjNkQsR0FBZCxDQUFKLEVBQXdCO0FBQ3RCLFVBQU0sSUFBSWMsS0FBSixDQUFXLDJEQUEwRDlGLGdCQUFFK0YsUUFBRixDQUFXekIsZUFBZSxDQUFDVSxHQUFELENBQTFCLEVBQWlDO0FBQUN4QyxNQUFBQSxNQUFNLEVBQUU5QztBQUFULEtBQWpDLENBQWdFLEVBQXJJLENBQU47QUFDRCxHQUZELE1BRU8sSUFBSU0sZ0JBQUVDLFFBQUYsQ0FBVytFLEdBQVgsQ0FBSixFQUFxQjtBQUMxQixRQUFJO0FBQ0ZBLE1BQUFBLEdBQUcsR0FBR3BCLElBQUksQ0FBQ29DLEtBQUwsQ0FBV2hCLEdBQVgsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPMUIsR0FBUCxFQUFZLENBR2I7QUFDRixHQVBNLE1BT0EsSUFBSSxDQUFDdEQsZ0JBQUVpRyxRQUFGLENBQVdqQixHQUFYLENBQUwsRUFBc0I7QUFDM0IsVUFBTSxJQUFJYyxLQUFKLENBQVcsZ0NBQStCLE9BQU9kLEdBQUksSUFBckQsQ0FBTjtBQUNEOztBQUVELE1BQUlBLEdBQUcsQ0FBQ2tCLE1BQUosSUFBY2xCLEdBQUcsQ0FBQ2tCLE1BQUosS0FBZSxDQUFqQyxFQUFvQztBQUVsQyxVQUFNLGtEQUEyQmxCLEdBQUcsQ0FBQ2tCLE1BQS9CLEVBQXVDbEIsR0FBRyxDQUFDN0IsS0FBSixDQUFVZ0QsT0FBVixJQUFxQm5CLEdBQUcsQ0FBQzdCLEtBQWhFLENBQU47QUFDRDs7QUFJRCxTQUFPbkQsZ0JBQUUwQyxHQUFGLENBQU1zQyxHQUFOLEVBQVcsT0FBWCxJQUFzQkEsR0FBRyxDQUFDN0IsS0FBMUIsR0FBa0M2QixHQUF6QztBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgZ2V0QXRvbSBmcm9tICcuL2F0b21zJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgYXNzZXJ0IGZyb20gJ2Fzc2VydCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgZXJyb3JGcm9tTUpTT05XUFN0YXR1c0NvZGUgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuXG5cbmNvbnN0IFdFQl9DT05URU5UX0JVTkRMRV9JRCA9ICdjb20uYXBwbGUuV2ViS2l0LldlYkNvbnRlbnQnO1xuY29uc3QgTUlOX1BMQVRGT1JNX0ZPUl9UQVJHRVRfQkFTRUQgPSAnMTIuMic7XG5cbmNvbnN0IFJFU1BPTlNFX0xPR19MRU5HVEggPSAxMDA7XG5cbi8qXG4gKiBUYWtlcyBhIGRpY3Rpb25hcnkgZnJvbSB0aGUgcmVtb3RlIGRlYnVnZ2VyIGFuZCBtYWtlcyBhIG1vcmUgbWFuYWdlYWJsZVxuICogZGljdGlvbmFyeSB3aG9zZSBrZXlzIGFyZSB1bmRlcnN0YW5kYWJsZVxuICovXG5mdW5jdGlvbiBhcHBJbmZvRnJvbURpY3QgKGRpY3QpIHtcbiAgY29uc3QgaWQgPSBkaWN0LldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTtcbiAgY29uc3QgaXNQcm94eSA9IF8uaXNTdHJpbmcoZGljdC5XSVJJc0FwcGxpY2F0aW9uUHJveHlLZXkpXG4gICAgPyBkaWN0LldJUklzQXBwbGljYXRpb25Qcm94eUtleS50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSdcbiAgICA6IGRpY3QuV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5O1xuICBjb25zdCBlbnRyeSA9IHtcbiAgICBpZCxcbiAgICBpc1Byb3h5LFxuICAgIG5hbWU6IGRpY3QuV0lSQXBwbGljYXRpb25OYW1lS2V5LFxuICAgIGJ1bmRsZUlkOiBkaWN0LldJUkFwcGxpY2F0aW9uQnVuZGxlSWRlbnRpZmllcktleSxcbiAgICBob3N0SWQ6IGRpY3QuV0lSSG9zdEFwcGxpY2F0aW9uSWRlbnRpZmllcktleSxcbiAgICBpc0FjdGl2ZTogZGljdC5XSVJJc0FwcGxpY2F0aW9uQWN0aXZlS2V5LFxuICAgIGlzQXV0b21hdGlvbkVuYWJsZWQ6ICEhZGljdC5XSVJSZW1vdGVBdXRvbWF0aW9uRW5hYmxlZEtleSxcbiAgfTtcblxuICByZXR1cm4gW2lkLCBlbnRyeV07XG59XG5cbi8qXG4gKiBUYWtlIGEgZGljdGlvbmFyeSBmcm9tIHRoZSByZW1vdGUgZGVidWdnZXIgYW5kIG1ha2VzIGEgbW9yZSBtYW5hZ2VhYmxlXG4gKiBkaWN0aW9uYXJ5IG9mIHBhZ2VzIGF2YWlsYWJsZS5cbiAqL1xuZnVuY3Rpb24gcGFnZUFycmF5RnJvbURpY3QgKHBhZ2VEaWN0KSB7XG4gIGlmIChwYWdlRGljdC5pZCkge1xuICAgIC8vIHRoZSBwYWdlIGlzIGFscmVhZHkgdHJhbnNsYXRlZCwgc28gd3JhcCBpbiBhbiBhcnJheSBhbmQgcGFzcyBiYWNrXG4gICAgcmV0dXJuIFtwYWdlRGljdF07XG4gIH1cbiAgbGV0IG5ld1BhZ2VBcnJheSA9IFtdO1xuICBmb3IgKGNvbnN0IGRpY3Qgb2YgXy52YWx1ZXMocGFnZURpY3QpKSB7XG4gICAgLy8gY291bnQgb25seSBXSVJUeXBlV2ViIHBhZ2VzIGFuZCBpZ25vcmUgYWxsIG90aGVycyAoV0lSVHlwZUphdmFTY3JpcHQgZXRjKVxuICAgIGlmIChfLmlzVW5kZWZpbmVkKGRpY3QuV0lSVHlwZUtleSkgfHwgZGljdC5XSVJUeXBlS2V5ID09PSAnV0lSVHlwZVdlYicpIHtcbiAgICAgIG5ld1BhZ2VBcnJheS5wdXNoKHtcbiAgICAgICAgaWQ6IGRpY3QuV0lSUGFnZUlkZW50aWZpZXJLZXksXG4gICAgICAgIHRpdGxlOiBkaWN0LldJUlRpdGxlS2V5LFxuICAgICAgICB1cmw6IGRpY3QuV0lSVVJMS2V5LFxuICAgICAgICBpc0tleTogIV8uaXNVbmRlZmluZWQoZGljdC5XSVJDb25uZWN0aW9uSWRlbnRpZmllcktleSksXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG5ld1BhZ2VBcnJheTtcbn1cblxuLypcbiAqIEdpdmVuIGEgYnVuZGxlIGlkLCBmaW5kcyB0aGUgY29ycmVjdCByZW1vdGUgZGVidWdnZXIgYXBwIHRoYXQgaXNcbiAqIGNvbm5lY3RlZC5cbiAqL1xuZnVuY3Rpb24gZ2V0RGVidWdnZXJBcHBLZXkgKGJ1bmRsZUlkLCBwbGF0Zm9ybVZlcnNpb24sIGFwcERpY3QpIHtcbiAgbGV0IGFwcElkO1xuICBpZiAocGFyc2VGbG9hdChwbGF0Zm9ybVZlcnNpb24pID49IDgpIHtcbiAgICBmb3IgKGNvbnN0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgICAgaWYgKGRhdGEuYnVuZGxlSWQgPT09IGJ1bmRsZUlkKSB7XG4gICAgICAgIGFwcElkID0ga2V5O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gbm93IHdlIG5lZWQgdG8gZGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBwaWNrIGEgcHJveHkgZm9yIHRoaXMgaW5zdGVhZFxuICAgIGlmIChhcHBJZCkge1xuICAgICAgbG9nLmRlYnVnKGBGb3VuZCBhcHAgaWQga2V5ICcke2FwcElkfScgZm9yIGJ1bmRsZSAnJHtidW5kbGVJZH0nYCk7XG4gICAgICBsZXQgcHJveGllZEFwcElkcyA9IFtdO1xuICAgICAgZm9yIChjb25zdCBba2V5LCBkYXRhXSBvZiBfLnRvUGFpcnMoYXBwRGljdCkpIHtcbiAgICAgICAgaWYgKGRhdGEuaXNQcm94eSAmJiBkYXRhLmhvc3RJZCA9PT0gYXBwSWQpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYEZvdW5kIHNlcGFyYXRlIGJ1bmRsZUlkICcke2RhdGEuYnVuZGxlSWR9JyBgICtcbiAgICAgICAgICAgICAgICAgICAgYGFjdGluZyBhcyBwcm94eSBmb3IgJyR7YnVuZGxlSWR9Jywgd2l0aCBhcHAgaWQgJyR7a2V5fSdgKTtcbiAgICAgICAgICBwcm94aWVkQXBwSWRzLnB1c2goa2V5KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHByb3hpZWRBcHBJZHMubGVuZ3RoKSB7XG4gICAgICAgIC8vIHVzZSB0aGUgbGFzdCBhcHAgYmVpbmcgcHJveGllZFxuICAgICAgICBhcHBJZCA9IF8ubGFzdChwcm94aWVkQXBwSWRzKTtcbiAgICAgICAgbG9nLmRlYnVnKGBVc2luZyBwcm94aWVkIGFwcCBpZCAnJHthcHBJZH0nYCk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGlmIChfLmhhcyhhcHBEaWN0LCBidW5kbGVJZCkpIHtcbiAgICAgIGFwcElkID0gYnVuZGxlSWQ7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGFwcElkO1xufVxuXG5mdW5jdGlvbiBhcHBJZEZvckJ1bmRsZSAoYnVuZGxlSWQsIGFwcERpY3QpIHtcbiAgbGV0IGFwcElkO1xuICBmb3IgKGNvbnN0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgIGlmIChkYXRhLmJ1bmRsZUlkLmVuZHNXaXRoKGJ1bmRsZUlkKSkge1xuICAgICAgYXBwSWQgPSBrZXk7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICAvLyBpZiBub3RoaW5nIGlzIGZvdW5kLCB0cnkgdG8gZ2V0IHRoZSBnZW5lcmljIGFwcFxuICBpZiAoIWFwcElkICYmIGJ1bmRsZUlkICE9PSBXRUJfQ09OVEVOVF9CVU5ETEVfSUQpIHtcbiAgICByZXR1cm4gYXBwSWRGb3JCdW5kbGUoV0VCX0NPTlRFTlRfQlVORExFX0lELCBhcHBEaWN0KTtcbiAgfVxuXG4gIHJldHVybiBhcHBJZDtcbn1cblxuZnVuY3Rpb24gZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXMgKGJ1bmRsZUlkcywgcGxhdGZvcm1WZXJzaW9uLCBhcHBEaWN0KSB7XG4gIGxldCBwcm94aWVkQXBwSWRzID0gW107XG5cbiAgZm9yIChjb25zdCBidW5kbGVJZCBvZiBidW5kbGVJZHMpIHtcbiAgICBjb25zdCBhcHBJZCA9IGFwcElkRm9yQnVuZGxlKGJ1bmRsZUlkLCBhcHBEaWN0KTtcblxuICAgIC8vIG5vdyB3ZSBuZWVkIHRvIGRldGVybWluZSBpZiB3ZSBzaG91bGQgcGljayBhIHByb3h5IGZvciB0aGlzIGluc3RlYWRcbiAgICBpZiAoYXBwSWQpIHtcbiAgICAgIHByb3hpZWRBcHBJZHMucHVzaChhcHBJZCk7XG4gICAgICBsb2cuZGVidWcoYEZvdW5kIGFwcCBpZCBrZXkgJyR7YXBwSWR9JyBmb3IgYnVuZGxlICcke2J1bmRsZUlkfSdgKTtcbiAgICAgIGZvciAoY29uc3QgW2tleSwgZGF0YV0gb2YgXy50b1BhaXJzKGFwcERpY3QpKSB7XG4gICAgICAgIGlmIChkYXRhLmlzUHJveHkgJiYgZGF0YS5ob3N0SWQgPT09IGFwcElkKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBGb3VuZCBzZXBhcmF0ZSBidW5kbGVJZCAnJHtkYXRhLmJ1bmRsZUlkfScgYCArXG4gICAgICAgICAgICAgICAgICAgIGBhY3RpbmcgYXMgcHJveHkgZm9yICcke2J1bmRsZUlkfScsIHdpdGggYXBwIGlkICcke2tleX0nYCk7XG4gICAgICAgICAgcHJveGllZEFwcElkcy5wdXNoKGtleSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gcHJveGllZEFwcElkcztcbn1cblxuZnVuY3Rpb24gY2hlY2tQYXJhbXMgKHBhcmFtcykge1xuICBsZXQgZXJyb3JzID0gW107XG4gIGZvciAoY29uc3QgW3BhcmFtLCB2YWx1ZV0gb2YgXy50b1BhaXJzKHBhcmFtcykpIHtcbiAgICB0cnkge1xuICAgICAgYXNzZXJ0Lm9rKHZhbHVlKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGVycm9ycy5wdXNoKHBhcmFtKTtcbiAgICB9XG4gIH1cbiAgaWYgKGVycm9ycy5sZW5ndGgpIHtcbiAgICByZXR1cm4gZXJyb3JzO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHdyYXBTY3JpcHRGb3JGcmFtZSAoc2NyaXB0LCBmcmFtZSkge1xuICBsb2cuZGVidWcoYFdyYXBwaW5nIHNjcmlwdCBmb3IgZnJhbWUgJyR7ZnJhbWV9J2ApO1xuICBsZXQgZWxGcm9tQ2FjaGUgPSBhd2FpdCBnZXRBdG9tKCdnZXRfZWxlbWVudF9mcm9tX2NhY2hlJyk7XG4gIHJldHVybiBgKGZ1bmN0aW9uICh3aW5kb3cpIHsgdmFyIGRvY3VtZW50ID0gd2luZG93LmRvY3VtZW50OyBgICtcbiAgICAgICAgIGByZXR1cm4gKCR7c2NyaXB0fSk7IH0pKCgke2VsRnJvbUNhY2hlLnRvU3RyaW5nKCd1dGY4Jyl9KSgke0pTT04uc3RyaW5naWZ5KGZyYW1lKX0pKWA7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFNjcmlwdEZvckF0b20gKGF0b20sIGFyZ3MsIGZyYW1lcywgYXN5bmNDYWxsQmFjayA9IG51bGwpIHtcbiAgbGV0IGF0b21TcmMgPSBhd2FpdCBnZXRBdG9tKGF0b20pO1xuICBsZXQgc2NyaXB0O1xuICBpZiAoZnJhbWVzLmxlbmd0aCA+IDApIHtcbiAgICBzY3JpcHQgPSBhdG9tU3JjO1xuICAgIGZvciAoY29uc3QgZnJhbWUgb2YgZnJhbWVzKSB7XG4gICAgICBzY3JpcHQgPSBhd2FpdCB3cmFwU2NyaXB0Rm9yRnJhbWUoc2NyaXB0LCBmcmFtZSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGxvZy5kZWJ1ZyhgRXhlY3V0aW5nICcke2F0b219JyBhdG9tIGluIGRlZmF1bHQgY29udGV4dGApO1xuICAgIHNjcmlwdCA9IGAoJHthdG9tU3JjfSlgO1xuICB9XG5cbiAgLy8gYWRkIHRoZSBhcmd1bWVudHMsIGFzIHN0cmluZ3NcbiAgYXJncyA9IGFyZ3MubWFwKEpTT04uc3RyaW5naWZ5KTtcbiAgaWYgKGFzeW5jQ2FsbEJhY2spIHtcbiAgICBzY3JpcHQgKz0gYCgke2FyZ3Muam9pbignLCcpfSwgJHthc3luY0NhbGxCYWNrfSwgdHJ1ZSApYDtcbiAgfSBlbHNlIHtcbiAgICBzY3JpcHQgKz0gYCgke2FyZ3Muam9pbignLCcpfSlgO1xuICB9XG5cbiAgcmV0dXJuIHNjcmlwdDtcbn1cblxuZnVuY3Rpb24gc2ltcGxlU3RyaW5naWZ5ICh2YWx1ZSwgbXVsdGlsaW5lID0gZmFsc2UpIHtcbiAgaWYgKCF2YWx1ZSkge1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG4gIH1cblxuICAvLyB3ZSBnZXQgYmFjayBvYmplY3RzIHNvbWV0aW1lcyB3aXRoIHN0cmluZyB2ZXJzaW9ucyBvZiBmdW5jdGlvbnNcbiAgLy8gd2hpY2ggbXVkZHkgdGhlIGxvZ3NcbiAgbGV0IGNsZWFuVmFsdWUgPSBfLmNsb25lKHZhbHVlKTtcbiAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBbJ2NlaWwnLCAnY2xvbmUnLCAnZmxvb3InLCAncm91bmQnLCAnc2NhbGUnLCAndG9TdHJpbmcnXSkge1xuICAgIGRlbGV0ZSBjbGVhblZhbHVlW3Byb3BlcnR5XTtcbiAgfVxuICByZXR1cm4gbXVsdGlsaW5lID8gSlNPTi5zdHJpbmdpZnkoY2xlYW5WYWx1ZSwgbnVsbCwgMikgOiBKU09OLnN0cmluZ2lmeShjbGVhblZhbHVlKTtcbn1cblxuZnVuY3Rpb24gZGVmZXJyZWRQcm9taXNlICgpIHtcbiAgLy8gaHR0cDovL2JsdWViaXJkanMuY29tL2RvY3MvYXBpL2RlZmVycmVkLW1pZ3JhdGlvbi5odG1sXG4gIGxldCByZXNvbHZlO1xuICBsZXQgcmVqZWN0O1xuICBjb25zdCBwcm9taXNlID0gbmV3IEIoKHJlcywgcmVqKSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wYXJhbS1uYW1lc1xuICAgIHJlc29sdmUgPSByZXM7XG4gICAgcmVqZWN0ID0gcmVqO1xuICB9KTtcbiAgcmV0dXJuIHtcbiAgICBwcm9taXNlLFxuICAgIHJlc29sdmUsXG4gICAgcmVqZWN0XG4gIH07XG59XG5cbmZ1bmN0aW9uIGlzVGFyZ2V0QmFzZWQgKGlzU2FmYXJpLCBwbGF0Zm9ybVZlcnNpb24pIHtcbiAgLy8gb24gaU9TIDEyLjIgdGhlIG1lc3NhZ2VzIGdldCBzZW50IHRocm91Z2ggdGhlIFRhcmdldCBkb21haW5cbiAgY29uc3QgaXNIaWdoVmVyc2lvbiA9IHV0aWwuY29tcGFyZVZlcnNpb25zKHBsYXRmb3JtVmVyc2lvbiwgJz49JywgTUlOX1BMQVRGT1JNX0ZPUl9UQVJHRVRfQkFTRUQpO1xuICBsb2cuZGVidWcoYENoZWNraW5nIHdoaWNoIGNvbW11bmljYXRpb24gc3R5bGUgdG8gdXNlICgke2lzU2FmYXJpID8gJycgOiAnbm9uLSd9U2FmYXJpIG9uIHBsYXRmb3JtIHZlcnNpb24gJyR7cGxhdGZvcm1WZXJzaW9ufScpYCk7XG4gIGxvZy5kZWJ1ZyhgUGxhdGZvcm0gdmVyc2lvbiBlcXVhbCBvciBoaWdoZXIgdGhhbiAnJHtNSU5fUExBVEZPUk1fRk9SX1RBUkdFVF9CQVNFRH0nOiAke2lzSGlnaFZlcnNpb259YCk7XG4gIHJldHVybiBpc1NhZmFyaSAmJiBpc0hpZ2hWZXJzaW9uO1xufVxuXG5mdW5jdGlvbiBnZXRFbGFwc2VkVGltZSAoc3RhcnRUaW1lKSB7XG4gIGNvbnN0IGVuZFRpbWUgPSBwcm9jZXNzLmhydGltZShzdGFydFRpbWUpO1xuICByZXR1cm4gcGFyc2VJbnQoKGVuZFRpbWVbMF0gKiAxZTkgKyBlbmRUaW1lWzFdKSAvIDFlNiwgMTApO1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0UmVzdWx0IChyZXMpIHtcbiAgaWYgKF8uaXNVbmRlZmluZWQocmVzKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgRGlkIG5vdCBnZXQgT0sgcmVzdWx0IGZyb20gcmVtb3RlIGRlYnVnZ2VyLiBSZXN1bHQgd2FzOiAke18udHJ1bmNhdGUoc2ltcGxlU3RyaW5naWZ5KHJlcyksIHtsZW5ndGg6IFJFU1BPTlNFX0xPR19MRU5HVEh9KX1gKTtcbiAgfSBlbHNlIGlmIChfLmlzU3RyaW5nKHJlcykpIHtcbiAgICB0cnkge1xuICAgICAgcmVzID0gSlNPTi5wYXJzZShyZXMpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gd2UgbWlnaHQgZ2V0IGEgc2VyaWFsaXplZCBvYmplY3QsIGJ1dCB3ZSBtaWdodCBub3RcbiAgICAgIC8vIGlmIHdlIGdldCBoZXJlLCBpdCBpcyBqdXN0IGEgdmFsdWVcbiAgICB9XG4gIH0gZWxzZSBpZiAoIV8uaXNPYmplY3QocmVzKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgUmVzdWx0IGhhcyB1bmV4cGVjdGVkIHR5cGU6ICgke3R5cGVvZiByZXN9KS5gKTtcbiAgfVxuXG4gIGlmIChyZXMuc3RhdHVzICYmIHJlcy5zdGF0dXMgIT09IDApIHtcbiAgICAvLyB3ZSBnb3Qgc29tZSBmb3JtIG9mIGVycm9yLlxuICAgIHRocm93IGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlKHJlcy5zdGF0dXMsIHJlcy52YWx1ZS5tZXNzYWdlIHx8IHJlcy52YWx1ZSk7XG4gIH1cblxuICAvLyB3aXRoIGVpdGhlciBoYXZlIGFuIG9iamVjdCB3aXRoIGEgYHZhbHVlYCBwcm9wZXJ0eSAoZXZlbiBpZiBgbnVsbGApLFxuICAvLyBvciBhIHBsYWluIG9iamVjdFxuICByZXR1cm4gXy5oYXMocmVzLCAndmFsdWUnKSA/IHJlcy52YWx1ZSA6IHJlcztcbn1cblxuZXhwb3J0IHtcbiAgYXBwSW5mb0Zyb21EaWN0LCBwYWdlQXJyYXlGcm9tRGljdCwgZ2V0RGVidWdnZXJBcHBLZXksXG4gIGdldFBvc3NpYmxlRGVidWdnZXJBcHBLZXlzLCBjaGVja1BhcmFtcywgd3JhcFNjcmlwdEZvckZyYW1lLCBnZXRTY3JpcHRGb3JBdG9tLFxuICBzaW1wbGVTdHJpbmdpZnksIGRlZmVycmVkUHJvbWlzZSwgaXNUYXJnZXRCYXNlZCwgZ2V0RWxhcHNlZFRpbWUsXG4gIGNvbnZlcnRSZXN1bHQsIFJFU1BPTlNFX0xPR19MRU5HVEgsXG59O1xuIl0sImZpbGUiOiJsaWIvaGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
