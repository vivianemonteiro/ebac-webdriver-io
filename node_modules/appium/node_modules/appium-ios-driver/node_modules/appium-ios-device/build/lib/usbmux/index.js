"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.Usbmux = void 0;

require("source-map-support/register");

var _net = _interopRequireDefault(require("net"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumSupport = require("appium-support");

var _lengthBasedSplitter = _interopRequireDefault(require("../util/transformer/length-based-splitter"));

var _usbmuxDecoder = _interopRequireDefault(require("./transformer/usbmux-decoder.js"));

var _usbmuxEncoder = _interopRequireDefault(require("./transformer/usbmux-encoder.js"));

var _path = _interopRequireDefault(require("path"));

var _plistService = _interopRequireDefault(require("../plist-service"));

var _lockdown = require("../lockdown");

const USBMUX_RESULT = {
  OK: 0,
  BADCOMMAND: 1,
  BADDEV: 2,
  CONNREFUSED: 3
};
let name, version;

try {
  ({
    name,
    version
  } = require(_path.default.resolve(__dirname, '..', '..', '..', 'package.json')));
} catch (err) {
  ({
    name,
    version
  } = require(_path.default.resolve(__dirname, '..', '..', 'package.json')));
}

const DEFAULT_USBMUXD_SOCKET = '/var/run/usbmuxd';
const PROG_NAME = name;
const CLIENT_VERSION_STRING = `${name}-${version}`;

function swap16(val) {
  return (val & 0xFF) << 8 | val >> 8 & 0xFF;
}

class Usbmux {
  constructor(socketClient = _net.default.createConnection(DEFAULT_USBMUXD_SOCKET)) {
    this._socketClient = socketClient;
    this._decoder = new _usbmuxDecoder.default();
    this._splitter = new _lengthBasedSplitter.default(true, 1000000, 0, 4, 0);

    this._socketClient.pipe(this._splitter).pipe(this._decoder);

    this._encoder = new _usbmuxEncoder.default();

    this._encoder.pipe(this._socketClient);
  }

  async readBUID(timeout = 5000) {
    const receivePromise = this._receivePlistPromise(timeout);

    this._sendPlist({
      MessageType: 'ReadBUID',
      ProgName: PROG_NAME,
      ClientVersionString: CLIENT_VERSION_STRING
    });

    const data = await receivePromise;

    if (data.payload.BUID) {
      return data.payload.BUID;
    } else {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }
  }

  async readPairRecord(udid, timeout = 5000) {
    const receivePromise = this._receivePlistPromise(timeout);

    this._sendPlist({
      MessageType: 'ReadPairRecord',
      PairRecordID: udid,
      ProgName: PROG_NAME,
      ClientVersionString: CLIENT_VERSION_STRING
    });

    const data = await receivePromise;

    if (data.payload.PairRecordData) {
      try {
        return _appiumSupport.plist.parsePlist(data.payload.PairRecordData);
      } catch (err) {
        throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
      }
    } else {
      return null;
    }
  }

  _sendPlist(json) {
    this._encoder.write(json);
  }

  _receivePlistPromise(timeout = 5000) {
    return new _bluebird.default((resolve, reject) => {
      this._decoder.once('data', resolve);

      setTimeout(() => reject(new Error(`Failed to receive any data within the timeout: ${timeout}`)), timeout);
    });
  }

  async listDevices(timeout = 5000) {
    const receivePromise = this._receivePlistPromise(timeout);

    this._sendPlist({
      MessageType: 'ListDevices',
      ProgName: PROG_NAME,
      ClientVersionString: CLIENT_VERSION_STRING
    });

    const data = await receivePromise;

    if (data.payload.DeviceList) {
      return data.payload.DeviceList;
    } else {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }
  }

  async findDevice(udid, timeout = 5000) {
    const devices = await this.listDevices(timeout);
    return _lodash.default.find(devices, device => device.Properties.SerialNumber === udid);
  }

  async connectLockdown(udid, timeout = 5000) {
    const device = await this.findDevice(udid, timeout);

    if (!device) {
      throw new Error(`Could not find the expected device '${udid}'`);
    }

    const plistService = new _plistService.default((await this.connect(device.Properties.DeviceID, _lockdown.LOCKDOWN_PORT, timeout)));
    return new _lockdown.Lockdown(plistService);
  }

  async connect(deviceID, port, timeout = 5000) {
    const receivePromise = this._receivePlistPromise(timeout);

    this._sendPlist({
      MessageType: 'Connect',
      ProgName: PROG_NAME,
      ClientVersionString: CLIENT_VERSION_STRING,
      DeviceID: deviceID,
      PortNumber: swap16(port)
    });

    const data = await receivePromise;

    if (data.payload.MessageType !== 'Result') {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }

    if (data.payload.Number === USBMUX_RESULT.OK) {
      this._socketClient.unpipe(this._splitter);

      this._splitter.unpipe(this._decoder);

      return this._socketClient;
    } else if (data.payload.Number === USBMUX_RESULT.CONNREFUSED) {
      throw new Error(`Connection was refused to port ${port}`);
    } else {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }
  }

  close() {
    this._socketClient.destroy();
  }

}

exports.Usbmux = Usbmux;
var _default = Usbmux;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91c2JtdXgvaW5kZXguanMiXSwibmFtZXMiOlsiVVNCTVVYX1JFU1VMVCIsIk9LIiwiQkFEQ09NTUFORCIsIkJBRERFViIsIkNPTk5SRUZVU0VEIiwibmFtZSIsInZlcnNpb24iLCJyZXF1aXJlIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJlcnIiLCJERUZBVUxUX1VTQk1VWERfU09DS0VUIiwiUFJPR19OQU1FIiwiQ0xJRU5UX1ZFUlNJT05fU1RSSU5HIiwic3dhcDE2IiwidmFsIiwiVXNibXV4IiwiY29uc3RydWN0b3IiLCJzb2NrZXRDbGllbnQiLCJuZXQiLCJjcmVhdGVDb25uZWN0aW9uIiwiX3NvY2tldENsaWVudCIsIl9kZWNvZGVyIiwiVXNibXV4RGVjb2RlciIsIl9zcGxpdHRlciIsIkxlbmd0aEJhc2VkU3BsaXR0ZXIiLCJwaXBlIiwiX2VuY29kZXIiLCJVc2JtdXhFbmNvZGVyIiwicmVhZEJVSUQiLCJ0aW1lb3V0IiwicmVjZWl2ZVByb21pc2UiLCJfcmVjZWl2ZVBsaXN0UHJvbWlzZSIsIl9zZW5kUGxpc3QiLCJNZXNzYWdlVHlwZSIsIlByb2dOYW1lIiwiQ2xpZW50VmVyc2lvblN0cmluZyIsImRhdGEiLCJwYXlsb2FkIiwiQlVJRCIsIkVycm9yIiwiSlNPTiIsInN0cmluZ2lmeSIsInJlYWRQYWlyUmVjb3JkIiwidWRpZCIsIlBhaXJSZWNvcmRJRCIsIlBhaXJSZWNvcmREYXRhIiwicGxpc3QiLCJwYXJzZVBsaXN0IiwianNvbiIsIndyaXRlIiwiQiIsInJlamVjdCIsIm9uY2UiLCJzZXRUaW1lb3V0IiwibGlzdERldmljZXMiLCJEZXZpY2VMaXN0IiwiZmluZERldmljZSIsImRldmljZXMiLCJfIiwiZmluZCIsImRldmljZSIsIlByb3BlcnRpZXMiLCJTZXJpYWxOdW1iZXIiLCJjb25uZWN0TG9ja2Rvd24iLCJwbGlzdFNlcnZpY2UiLCJQbGlzdFNlcnZpY2UiLCJjb25uZWN0IiwiRGV2aWNlSUQiLCJMT0NLRE9XTl9QT1JUIiwiTG9ja2Rvd24iLCJkZXZpY2VJRCIsInBvcnQiLCJQb3J0TnVtYmVyIiwiTnVtYmVyIiwidW5waXBlIiwiY2xvc2UiLCJkZXN0cm95Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGFBQWEsR0FBRztBQUNwQkMsRUFBQUEsRUFBRSxFQUFFLENBRGdCO0FBRXBCQyxFQUFBQSxVQUFVLEVBQUUsQ0FGUTtBQUdwQkMsRUFBQUEsTUFBTSxFQUFFLENBSFk7QUFJcEJDLEVBQUFBLFdBQVcsRUFBRTtBQUpPLENBQXRCO0FBT0EsSUFBSUMsSUFBSixFQUFVQyxPQUFWOztBQUNBLElBQUk7QUFFRixHQUFDO0FBQUVELElBQUFBLElBQUY7QUFBUUMsSUFBQUE7QUFBUixNQUFvQkMsT0FBTyxDQUFDQyxjQUFLQyxPQUFMLENBQWFDLFNBQWIsRUFBd0IsSUFBeEIsRUFBOEIsSUFBOUIsRUFBb0MsSUFBcEMsRUFBMEMsY0FBMUMsQ0FBRCxDQUE1QjtBQUNELENBSEQsQ0FHRSxPQUFPQyxHQUFQLEVBQVk7QUFFWixHQUFDO0FBQUVOLElBQUFBLElBQUY7QUFBUUMsSUFBQUE7QUFBUixNQUFvQkMsT0FBTyxDQUFDQyxjQUFLQyxPQUFMLENBQWFDLFNBQWIsRUFBd0IsSUFBeEIsRUFBOEIsSUFBOUIsRUFBb0MsY0FBcEMsQ0FBRCxDQUE1QjtBQUNEOztBQUVELE1BQU1FLHNCQUFzQixHQUFHLGtCQUEvQjtBQUNBLE1BQU1DLFNBQVMsR0FBR1IsSUFBbEI7QUFDQSxNQUFNUyxxQkFBcUIsR0FBSSxHQUFFVCxJQUFLLElBQUdDLE9BQVEsRUFBakQ7O0FBRUEsU0FBU1MsTUFBVCxDQUFpQkMsR0FBakIsRUFBc0I7QUFDcEIsU0FBUSxDQUFDQSxHQUFHLEdBQUcsSUFBUCxLQUFnQixDQUFqQixHQUF3QkEsR0FBRyxJQUFJLENBQVIsR0FBYSxJQUEzQztBQUNEOztBQUVELE1BQU1DLE1BQU4s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RSxhQUFhLENBQUNJLFdBQTFDLEVBQXVEO0FBQzVELFlBQU0sSUFBSXFDLEtBQUosQ0FBVyxrQ0FBaUNnQyxJQUFLLEVBQWpELENBQU47QUFDRCxLQUZNLE1BRUE7QUFDTCxZQUFNLElBQUloQyxLQUFKLENBQVcsb0JBQW1CQyxJQUFJLENBQUNDLFNBQUwsQ0FBZUwsSUFBZixDQUFxQixFQUFuRCxDQUFOO0FBQ0Q7QUFDRjs7QUFJRHVDLEVBQUFBLEtBQUssR0FBSTtBQUNQLFNBQUt2RCxhQUFMLENBQW1Cd0QsT0FBbkI7QUFDRDs7QUE3SlU7OztlQWlLRTdELE0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgcGxpc3QgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgTGVuZ3RoQmFzZWRTcGxpdHRlciBmcm9tICcuLi91dGlsL3RyYW5zZm9ybWVyL2xlbmd0aC1iYXNlZC1zcGxpdHRlcic7XG5pbXBvcnQgVXNibXV4RGVjb2RlciBmcm9tICcuL3RyYW5zZm9ybWVyL3VzYm11eC1kZWNvZGVyLmpzJztcbmltcG9ydCBVc2JtdXhFbmNvZGVyIGZyb20gJy4vdHJhbnNmb3JtZXIvdXNibXV4LWVuY29kZXIuanMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgUGxpc3RTZXJ2aWNlIGZyb20gJy4uL3BsaXN0LXNlcnZpY2UnO1xuaW1wb3J0IHsgTG9ja2Rvd24sIExPQ0tET1dOX1BPUlQgfSBmcm9tICcuLi9sb2NrZG93bic7XG5cbmNvbnN0IFVTQk1VWF9SRVNVTFQgPSB7XG4gIE9LOiAwLFxuICBCQURDT01NQU5EOiAxLFxuICBCQURERVY6IDIsXG4gIENPTk5SRUZVU0VEOiAzLFxufTtcblxubGV0IG5hbWUsIHZlcnNpb247XG50cnkge1xuICAvLyBmaXJzdCB0cnkgYXNzdW1pbmcgdGhpcyBpcyBpbiB0aGUgYGJ1aWxkYCBmb2xkZXJcbiAgKHsgbmFtZSwgdmVyc2lvbiB9ID0gcmVxdWlyZShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnLi4nLCAncGFja2FnZS5qc29uJykpKTtcbn0gY2F0Y2ggKGVycikge1xuICAvLyB0aGVuIHRyeSBhc3N1bWluZyBpdCBpcyBub3RcbiAgKHsgbmFtZSwgdmVyc2lvbiB9ID0gcmVxdWlyZShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAncGFja2FnZS5qc29uJykpKTtcbn1cblxuY29uc3QgREVGQVVMVF9VU0JNVVhEX1NPQ0tFVCA9ICcvdmFyL3J1bi91c2JtdXhkJztcbmNvbnN0IFBST0dfTkFNRSA9IG5hbWU7XG5jb25zdCBDTElFTlRfVkVSU0lPTl9TVFJJTkcgPSBgJHtuYW1lfS0ke3ZlcnNpb259YDtcblxuZnVuY3Rpb24gc3dhcDE2ICh2YWwpIHtcbiAgcmV0dXJuICgodmFsICYgMHhGRikgPDwgOCkgfCAoKHZhbCA+PiA4KSAmIDB4RkYpO1xufVxuXG5jbGFzcyBVc2JtdXgge1xuXG4gIGNvbnN0cnVjdG9yIChzb2NrZXRDbGllbnQgPSBuZXQuY3JlYXRlQ29ubmVjdGlvbihERUZBVUxUX1VTQk1VWERfU09DS0VUKSkge1xuICAgIHRoaXMuX3NvY2tldENsaWVudCA9IHNvY2tldENsaWVudDtcblxuICAgIHRoaXMuX2RlY29kZXIgPSBuZXcgVXNibXV4RGVjb2RlcigpO1xuICAgIHRoaXMuX3NwbGl0dGVyID0gbmV3IExlbmd0aEJhc2VkU3BsaXR0ZXIodHJ1ZSwgMTAwMDAwMCwgMCwgNCwgMCk7XG4gICAgdGhpcy5fc29ja2V0Q2xpZW50LnBpcGUodGhpcy5fc3BsaXR0ZXIpLnBpcGUodGhpcy5fZGVjb2Rlcik7XG5cbiAgICB0aGlzLl9lbmNvZGVyID0gbmV3IFVzYm11eEVuY29kZXIoKTtcbiAgICB0aGlzLl9lbmNvZGVyLnBpcGUodGhpcy5fc29ja2V0Q2xpZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBCVUlEIG9mIHRoZSBob3N0IGNvbXB1dGVyIGZyb20gdXNibXV4ZFxuICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbWVvdXQ9NTAwMF0gdGhlIHRpbWVvdXQgb2YgcmVjZWl2aW5nIGEgcmVzcG9uc2UgZnJvbSB1c2JtdXhkXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAqL1xuICBhc3luYyByZWFkQlVJRCAodGltZW91dCA9IDUwMDApIHtcbiAgICBjb25zdCByZWNlaXZlUHJvbWlzZSA9IHRoaXMuX3JlY2VpdmVQbGlzdFByb21pc2UodGltZW91dCk7XG5cbiAgICB0aGlzLl9zZW5kUGxpc3Qoe1xuICAgICAgTWVzc2FnZVR5cGU6ICdSZWFkQlVJRCcsXG4gICAgICBQcm9nTmFtZTogUFJPR19OQU1FLFxuICAgICAgQ2xpZW50VmVyc2lvblN0cmluZzogQ0xJRU5UX1ZFUlNJT05fU1RSSU5HXG4gICAgfSk7XG5cbiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVjZWl2ZVByb21pc2U7XG4gICAgaWYgKGRhdGEucGF5bG9hZC5CVUlEKSB7XG4gICAgICByZXR1cm4gZGF0YS5wYXlsb2FkLkJVSUQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZWFkcyB0aGUgcGFpciByZWNvcmQgb2YgYSBkZXZpY2UuIEl0IHdpbGwgcmV0dXJuIG51bGwgaWYgaXQgZG9lc24ndCBleGlzdHNcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVkaWQgdGhlIHVkaWQgb2YgdGhlIGRldmljZVxuICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbWVvdXQ9NTAwMF0gdGhlIHRpbWVvdXQgb2YgcmVjZWl2aW5nIGEgcmVzcG9uc2UgZnJvbSB1c2JtdXhkXG4gICAqIEByZXR1cm5zIHs/T2JqZWN0fVxuICAgKi9cbiAgYXN5bmMgcmVhZFBhaXJSZWNvcmQgKHVkaWQsIHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3QgcmVjZWl2ZVByb21pc2UgPSB0aGlzLl9yZWNlaXZlUGxpc3RQcm9taXNlKHRpbWVvdXQpO1xuXG4gICAgdGhpcy5fc2VuZFBsaXN0KHtcbiAgICAgIE1lc3NhZ2VUeXBlOiAnUmVhZFBhaXJSZWNvcmQnLFxuICAgICAgUGFpclJlY29yZElEOiB1ZGlkLFxuICAgICAgUHJvZ05hbWU6IFBST0dfTkFNRSxcbiAgICAgIENsaWVudFZlcnNpb25TdHJpbmc6IENMSUVOVF9WRVJTSU9OX1NUUklOR1xuICAgIH0pO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZWNlaXZlUHJvbWlzZTtcbiAgICBpZiAoZGF0YS5wYXlsb2FkLlBhaXJSZWNvcmREYXRhKSB7XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gcGxpc3QucGFyc2VQbGlzdChkYXRhLnBheWxvYWQuUGFpclJlY29yZERhdGEpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBfc2VuZFBsaXN0IChqc29uKSB7XG4gICAgdGhpcy5fZW5jb2Rlci53cml0ZShqc29uKTtcbiAgfVxuXG4gIF9yZWNlaXZlUGxpc3RQcm9taXNlICh0aW1lb3V0ID0gNTAwMCkge1xuICAgIHJldHVybiBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLl9kZWNvZGVyLm9uY2UoJ2RhdGEnLCByZXNvbHZlKTtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gcmVqZWN0KG5ldyBFcnJvcihgRmFpbGVkIHRvIHJlY2VpdmUgYW55IGRhdGEgd2l0aGluIHRoZSB0aW1lb3V0OiAke3RpbWVvdXR9YCkpLCB0aW1lb3V0KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaXN0cyBhbGwgZGV2aWNlcyBjb25uZWN0ZWQgdG8gdGhlIGhvc3RcbiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aW1lb3V0PTUwMDBdIHRoZSB0aW1lb3V0IG9mIHJlY2VpdmluZyBhIHJlc3BvbnNlIGZyb20gdXNibXV4ZFxuICAgKiBAcmV0dXJucyB7QXJyYXl9XG4gICAqL1xuICBhc3luYyBsaXN0RGV2aWNlcyAodGltZW91dCA9IDUwMDApIHtcbiAgICBjb25zdCByZWNlaXZlUHJvbWlzZSA9IHRoaXMuX3JlY2VpdmVQbGlzdFByb21pc2UodGltZW91dCk7XG5cbiAgICB0aGlzLl9zZW5kUGxpc3Qoe1xuICAgICAgTWVzc2FnZVR5cGU6ICdMaXN0RGV2aWNlcycsXG4gICAgICBQcm9nTmFtZTogUFJPR19OQU1FLFxuICAgICAgQ2xpZW50VmVyc2lvblN0cmluZzogQ0xJRU5UX1ZFUlNJT05fU1RSSU5HXG4gICAgfSk7XG5cbiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVjZWl2ZVByb21pc2U7XG4gICAgaWYgKGRhdGEucGF5bG9hZC5EZXZpY2VMaXN0KSB7XG4gICAgICByZXR1cm4gZGF0YS5wYXlsb2FkLkRldmljZUxpc3Q7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBMb29rcyBmb3IgYSBkZXZpY2Ugd2l0aCB0aGUgcGFzc2VkIHVkaWQuIEl0IHdpbGwgcmV0dXJuIHVuZGVmaW5lZCBpZiB0aGUgZGV2aWNlIGlzIG5vdCBmb3VuZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gdWRpZCB0aGUgdWRpZCBvZiB0aGUgZGV2aWNlXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIHVzYm11eGRcbiAgICogQHJldHVybnMgez9PYmplY3R9XG4gICAqL1xuICBhc3luYyBmaW5kRGV2aWNlICh1ZGlkLCB0aW1lb3V0ID0gNTAwMCkge1xuICAgIGNvbnN0IGRldmljZXMgPSBhd2FpdCB0aGlzLmxpc3REZXZpY2VzKHRpbWVvdXQpO1xuICAgIHJldHVybiBfLmZpbmQoZGV2aWNlcywgKGRldmljZSkgPT4gZGV2aWNlLlByb3BlcnRpZXMuU2VyaWFsTnVtYmVyID09PSB1ZGlkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25uZWN0cyB0byB0aGUgbG9ja2Rvd25kIG9uIHRoZSBkZXZpY2UgYW5kIHJldHVybnMgYSBMb2NrZG93biBjbGllbnRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVkaWQgdGhlIHVkaWQgb2YgdGhlIGRldmljZVxuICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbWVvdXQ9NTAwMF0gdGhlIHRpbWVvdXQgb2YgcmVjZWl2aW5nIGEgcmVzcG9uc2UgZnJvbSB1c2JtdXhkXG4gICAqIEByZXR1cm5zIHtMb2NrZG93bn1cbiAgICovXG4gIGFzeW5jIGNvbm5lY3RMb2NrZG93biAodWRpZCwgdGltZW91dCA9IDUwMDApIHtcbiAgICBjb25zdCBkZXZpY2UgPSBhd2FpdCB0aGlzLmZpbmREZXZpY2UodWRpZCwgdGltZW91dCk7XG4gICAgaWYgKCFkZXZpY2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgdGhlIGV4cGVjdGVkIGRldmljZSAnJHt1ZGlkfSdgKTtcbiAgICB9XG4gICAgY29uc3QgcGxpc3RTZXJ2aWNlID0gbmV3IFBsaXN0U2VydmljZShhd2FpdCB0aGlzLmNvbm5lY3QoZGV2aWNlLlByb3BlcnRpZXMuRGV2aWNlSUQsIExPQ0tET1dOX1BPUlQsIHRpbWVvdXQpKTtcbiAgICByZXR1cm4gbmV3IExvY2tkb3duKHBsaXN0U2VydmljZSk7XG4gIH1cblxuICAvKipcbiAgICogQ29ubmVjdHMgdG8gYSBjZXJ0YWluIHBvcnQgb24gdGhlIGRldmljZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gZGV2aWNlSUQgdGhlIGRldmljZSBpZCB3aGljaCBjYW4gYmUgcmV0cmlldmVkIGZyb20gdGhlIHByb3BlcnRpZXMgb2YgYSBkZXZpY2VcbiAgICogQHBhcmFtIHtudW1iZXJ9IHBvcnQgdGhlIHBvcnQgbnVtYmVyIHRoYXQgd2FudHMgdG8gYmUgY29ubmVjdGVkXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIHVzYm11eGRcbiAgICovXG4gIGFzeW5jIGNvbm5lY3QgKGRldmljZUlELCBwb3J0LCB0aW1lb3V0ID0gNTAwMCkge1xuICAgIGNvbnN0IHJlY2VpdmVQcm9taXNlID0gdGhpcy5fcmVjZWl2ZVBsaXN0UHJvbWlzZSh0aW1lb3V0KTtcblxuICAgIHRoaXMuX3NlbmRQbGlzdCh7XG4gICAgICBNZXNzYWdlVHlwZTogJ0Nvbm5lY3QnLFxuICAgICAgUHJvZ05hbWU6IFBST0dfTkFNRSxcbiAgICAgIENsaWVudFZlcnNpb25TdHJpbmc6IENMSUVOVF9WRVJTSU9OX1NUUklORyxcbiAgICAgIERldmljZUlEOiBkZXZpY2VJRCxcbiAgICAgIFBvcnROdW1iZXI6IHN3YXAxNihwb3J0KVxuICAgIH0pO1xuXG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlY2VpdmVQcm9taXNlO1xuICAgIGlmIChkYXRhLnBheWxvYWQuTWVzc2FnZVR5cGUgIT09ICdSZXN1bHQnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZGF0YTogJHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKTtcbiAgICB9XG4gICAgaWYgKGRhdGEucGF5bG9hZC5OdW1iZXIgPT09IFVTQk1VWF9SRVNVTFQuT0spIHtcbiAgICAgIHRoaXMuX3NvY2tldENsaWVudC51bnBpcGUodGhpcy5fc3BsaXR0ZXIpO1xuICAgICAgdGhpcy5fc3BsaXR0ZXIudW5waXBlKHRoaXMuX2RlY29kZXIpO1xuICAgICAgcmV0dXJuIHRoaXMuX3NvY2tldENsaWVudDtcbiAgICB9IGVsc2UgaWYgKGRhdGEucGF5bG9hZC5OdW1iZXIgPT09IFVTQk1VWF9SRVNVTFQuQ09OTlJFRlVTRUQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ29ubmVjdGlvbiB3YXMgcmVmdXNlZCB0byBwb3J0ICR7cG9ydH1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiBDbG9zZXMgdGhlIHVuZGVybHlpbmcgc29ja2V0IGNvbW11bmljYXRpbmcgdG8gdGhlIHVzYm11eGRcbiAgICovXG4gIGNsb3NlICgpIHtcbiAgICB0aGlzLl9zb2NrZXRDbGllbnQuZGVzdHJveSgpO1xuICB9XG59XG5cbmV4cG9ydCB7IFVzYm11eCB9O1xuZXhwb3J0IGRlZmF1bHQgVXNibXV4O1xuIl0sImZpbGUiOiJsaWIvdXNibXV4L2luZGV4LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
