"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.INSTALLATION_PROXY_SERVICE_NAME = exports.InstallationProxyService = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

const INSTALLATION_PROXY_SERVICE_NAME = 'com.apple.mobile.installation_proxy';
exports.INSTALLATION_PROXY_SERVICE_NAME = INSTALLATION_PROXY_SERVICE_NAME;

class InstallationProxyService {
  constructor(plistService) {
    this.plistService = plistService;
  }

  async installApplication(path, clientOptions = {}, timeout = 60000) {
    const request = {
      Command: 'Install',
      PackagePath: path,
      ClientOptions: clientOptions
    };
    this.plistService.sendPlist(request);
    return await this._waitMessageCompletion(timeout);
  }

  async listApplications(opts = {}) {
    const request = {
      Command: 'Browse',
      ClientOptions: {}
    };

    if (opts.applicationType) {
      request.ClientOptions.ApplicationType = opts.applicationType;
    }

    if (opts.returnAttributes) {
      request.ClientOptions.ReturnAttributes = opts.returnAttributes;
    }

    this.plistService.sendPlist(request);
    const messages = await this._waitMessageCompletion();
    return messages.reduce((acc, message) => {
      if (!message.CurrentList) {
        return acc;
      }

      message.CurrentList.forEach(app => {
        acc[app.CFBundleIdentifier] = app;
      });
      return acc;
    }, {});
  }

  async lookupApplications(opts = {}) {
    const request = {
      Command: 'Lookup',
      ClientOptions: {}
    };

    if (opts.bundleIds) {
      request.ClientOptions.BundleIDs = _lodash.default.isString(opts.bundleIds) ? [opts.bundleIds] : opts.bundleIds;
    }

    if (opts.applicationType) {
      request.ClientOptions.ApplicationType = opts.applicationType;
    }

    if (opts.returnAttributes) {
      request.ClientOptions.ReturnAttributes = opts.returnAttributes;
    }

    this.plistService.sendPlist(request);
    const messages = await this._waitMessageCompletion();

    for (const message of messages) {
      if (message.LookupResult) {
        return message.LookupResult;
      }
    }

    throw new Error(`Couldn't find LookupResult in the response: Response: ${JSON.stringify(messages)}`);
  }

  async uninstallApplication(bundleId, timeout = 20000) {
    const request = {
      Command: 'Uninstall',
      ApplicationIdentifier: bundleId
    };
    this.plistService.sendPlist(request);
    return await this._waitMessageCompletion(timeout);
  }

  async _waitMessageCompletion(timeout) {
    let messages = [];

    for (let i = 0; i < Number.MAX_SAFE_INTEGER; i++) {
      const data = await this.plistService.receivePlist(timeout);
      messages.push(data);

      if (this._isFinished(data)) {
        return messages;
      }
    }
  }

  _isFinished(response) {
    if (response.Error) {
      throw new Error(`Unexpected data: ${JSON.stringify(response)}`);
    }

    if (!response.Status) {
      return false;
    }

    return response.Status === 'Complete';
  }

  close() {
    this.plistService.close();
  }

}

exports.InstallationProxyService = InstallationProxyService;
var _default = InstallationProxyService;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0YWxsYXRpb24tcHJveHkvaW5kZXguanMiXSwibmFtZXMiOlsiSU5TVEFMTEFUSU9OX1BST1hZX1NFUlZJQ0VfTkFNRSIsIkluc3RhbGxhdGlvblByb3h5U2VydmljZSIsImNvbnN0cnVjdG9yIiwicGxpc3RTZXJ2aWNlIiwiaW5zdGFsbEFwcGxpY2F0aW9uIiwicGF0aCIsImNsaWVudE9wdGlvbnMiLCJ0aW1lb3V0IiwicmVxdWVzdCIsIkNvbW1hbmQiLCJQYWNrYWdlUGF0aCIsIkNsaWVudE9wdGlvbnMiLCJzZW5kUGxpc3QiLCJfd2FpdE1lc3NhZ2VDb21wbGV0aW9uIiwibGlzdEFwcGxpY2F0aW9ucyIsIm9wdHMiLCJhcHBsaWNhdGlvblR5cGUiLCJBcHBsaWNhdGlvblR5cGUiLCJyZXR1cm5BdHRyaWJ1dGVzIiwiUmV0dXJuQXR0cmlidXRlcyIsIm1lc3NhZ2VzIiwicmVkdWNlIiwiYWNjIiwibWVzc2FnZSIsIkN1cnJlbnRMaXN0IiwiZm9yRWFjaCIsImFwcCIsIkNGQnVuZGxlSWRlbnRpZmllciIsImxvb2t1cEFwcGxpY2F0aW9ucyIsImJ1bmRsZUlkcyIsIkJ1bmRsZUlEcyIsIl8iLCJpc1N0cmluZyIsIkxvb2t1cFJlc3VsdCIsIkVycm9yIiwiSlNPTiIsInN0cmluZ2lmeSIsInVuaW5zdGFsbEFwcGxpY2F0aW9uIiwiYnVuZGxlSWQiLCJBcHBsaWNhdGlvbklkZW50aWZpZXIiLCJpIiwiTnVtYmVyIiwiTUFYX1NBRkVfSU5URUdFUiIsImRhdGEiLCJyZWNlaXZlUGxpc3QiLCJwdXNoIiwiX2lzRmluaXNoZWQiLCJyZXNwb25zZSIsIlN0YXR1cyIsImNsb3NlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUVBLE1BQU1BLCtCQUErQixHQUFHLHFDQUF4Qzs7O0FBRUEsTUFBTUMsd0JBQU4sQ0FBK0I7QUFDN0JDLEVBQUFBLFdBQVcsQ0FBRUMsWUFBRixFQUFnQjtBQUN6QixTQUFLQSxZQUFMLEdBQW9CQSxZQUFwQjtB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UCxTQUFLOUMsWUFBTCxDQUFrQjhDLEtBQWxCO0FBQ0Q7O0FBN0k0Qjs7O2VBaUpoQmhELHdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuY29uc3QgSU5TVEFMTEFUSU9OX1BST1hZX1NFUlZJQ0VfTkFNRSA9ICdjb20uYXBwbGUubW9iaWxlLmluc3RhbGxhdGlvbl9wcm94eSc7XG5cbmNsYXNzIEluc3RhbGxhdGlvblByb3h5U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yIChwbGlzdFNlcnZpY2UpIHtcbiAgICB0aGlzLnBsaXN0U2VydmljZSA9IHBsaXN0U2VydmljZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnN0YWxsIHRoZSBhcHBsaWNhdGlvbiBvbiB0aGUgcmVsYXRpdmUgcGF0aCBvbiB0aGUgcGhvbmVcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggVGhlIHBhdGggd2hlcmUgdGhlIC5hcHAgYW5kIC5pcGEgaXMgbG9jYXRlZCBhdCBvbiB0aGUgcGhvbmVcbiAgICogQHBhcmFtIHtPYmplY3R9IGNsaWVudE9wdGlvbnMgVGhlIGV4dHJhIG9wdGlvbnMgdGhhdCB3YW50cyB0byBiZSBwYXNzZWQgdG8gdGhlIGluc3RhbGxkXG4gICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lb3V0IFs2MDAwMF0gVGhlIHRpbWVvdXQgYmV0d2VlbiBtZXNzYWdlcyByZWNlaXZlZCBmcm9tIHRoZSBwaG9uZSBhcyBzdGF0dXMgdXBkYXRlc1xuICAgKi9cbiAgYXN5bmMgaW5zdGFsbEFwcGxpY2F0aW9uIChwYXRoLCBjbGllbnRPcHRpb25zID0ge30sIHRpbWVvdXQgPSA2MDAwMCkge1xuICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICBDb21tYW5kOiAnSW5zdGFsbCcsXG4gICAgICBQYWNrYWdlUGF0aDogcGF0aCxcbiAgICAgIENsaWVudE9wdGlvbnM6IGNsaWVudE9wdGlvbnNcbiAgICB9O1xuXG4gICAgdGhpcy5wbGlzdFNlcnZpY2Uuc2VuZFBsaXN0KHJlcXVlc3QpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLl93YWl0TWVzc2FnZUNvbXBsZXRpb24odGltZW91dCk7XG4gIH1cblxuICAvKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IExpc3RBcHBsaWNhdGlvbk9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkge3N0cmluZ30gYXBwbGljYXRpb25UeXBlIG9mIHRoZSB3aGljaCBncm91cCB5b3Ugd2FudCB0byBsaXN0LiBUaGVzZSBjYW4gYmUgVXNlciwgU3lzdGVtIG9yIGxlYXZlIGl0IGVtcHR5IGZvciBib3RoXG4gKiBAcHJvcGVydHkge0FycmF5fSByZXR1cm5BdHRyaWJ1dGVzIHRoZSBmaWVsZHMgd2hpY2ggc2hvdWxkIGJlIGZpbHRlcmVkIGFuZCByZXR1cm5lZCB0byB0aGUgY2xpZW50LiBMZWF2ZSB0aGlzIHBhcmFtZXRlciBlbXB0eSBpZiB5b3UgZG9uJ3Qgd2FudCB0byBmaWx0ZXJcbiAqL1xuXG4gIC8qKlxuICAgKiBMaXN0cyBhcHBsaWNhdGlvbnMgYWNjb3JkaW5nIHRvIHRoZSBvcHRzIGFuZCByZXR1cm5zIHRoZW0gYXMgYSBtYXBcbiAgICogQHBhcmFtIHtMaXN0QXBwbGljYXRpb25PcHRpb25zfSBvcHRzIHRoZSBsaXN0aW5nIG9wdGlvbnMgdGhhdCB3YW50cyB0byBiZSBwYXNzZWRcbiAgICogQHJldHVybnMgQSBtYXAgb2YgdGhlIGFwcGxpY2F0aW9ucyB3aGljaCB0aGUga2V5IGlzIHRoZSBidW5kbGVJZFxuICAgKi9cbiAgYXN5bmMgbGlzdEFwcGxpY2F0aW9ucyAob3B0cyA9IHt9KSB7XG4gICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgIENvbW1hbmQ6ICdCcm93c2UnLFxuICAgICAgQ2xpZW50T3B0aW9uczoge31cbiAgICB9O1xuXG4gICAgaWYgKG9wdHMuYXBwbGljYXRpb25UeXBlKSB7XG4gICAgICByZXF1ZXN0LkNsaWVudE9wdGlvbnMuQXBwbGljYXRpb25UeXBlID0gb3B0cy5hcHBsaWNhdGlvblR5cGU7XG4gICAgfVxuICAgIGlmIChvcHRzLnJldHVybkF0dHJpYnV0ZXMpIHtcbiAgICAgIHJlcXVlc3QuQ2xpZW50T3B0aW9ucy5SZXR1cm5BdHRyaWJ1dGVzID0gb3B0cy5yZXR1cm5BdHRyaWJ1dGVzO1xuICAgIH1cblxuICAgIHRoaXMucGxpc3RTZXJ2aWNlLnNlbmRQbGlzdChyZXF1ZXN0KTtcbiAgICBjb25zdCBtZXNzYWdlcyA9IGF3YWl0IHRoaXMuX3dhaXRNZXNzYWdlQ29tcGxldGlvbigpO1xuICAgIHJldHVybiBtZXNzYWdlcy5yZWR1Y2UoKGFjYywgbWVzc2FnZSkgPT4ge1xuICAgICAgaWYgKCFtZXNzYWdlLkN1cnJlbnRMaXN0KSB7XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9XG4gICAgICBtZXNzYWdlLkN1cnJlbnRMaXN0LmZvckVhY2goYXBwID0+IHtcbiAgICAgICAgYWNjW2FwcC5DRkJ1bmRsZUlkZW50aWZpZXJdID0gYXBwO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9KTtcbiAgfVxuXG4gIC8qKlxuICogQHR5cGVkZWYge09iamVjdH0gTG9va3VwQXBwbGljYXRpb25PcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGFwcGxpY2F0aW9uVHlwZSBvZiB0aGUgd2hpY2ggZ3JvdXAgeW91IHdhbnQgdG8gbGlzdC4gVGhlc2UgY2FuIGJlIFVzZXIsIFN5c3RlbSBvciBsZWF2ZSBpdCBlbXB0eSBmb3IgYm90aFxuICogQHByb3BlcnR5IHtBcnJheX0gcmV0dXJuQXR0cmlidXRlcyB0aGUgZmllbGRzIHdoaWNoIHNob3VsZCBiZSBmaWx0ZXJlZCBhbmQgcmV0dXJuZWQgdG8gdGhlIGNsaWVudC4gTGVhdmUgdGhpcyBwYXJhbWV0ZXIgZW1wdHkgaWYgeW91IGRvbid0IHdhbnQgdG8gZmlsdGVyXG4gKiBAcHJvcGVydHkge3N0cmluZ3xBcnJheX0gYnVuZGxlSWRzIEJ1bmRsZSBJZHMgb2YgdGhlIGFwcHMgdGhhdCBzaG91bGQgYmUgc2VhcmNoZWRcbiAqL1xuXG4gIC8qKlxuICAgKiBMaXN0cyBhcHBsaWNhdGlvbnMgYWNjb3JkaW5nIHRvIHRoZSBvcHRzIGFuZCByZXR1cm5zIHRoZW0gYXMgYSBtYXBcbiAgICogQHBhcmFtIHtMb29rdXBBcHBsaWNhdGlvbk9wdGlvbnN9IG9wdHMgdGhlIGxvb2t1cCBvcHRpb25zIHRoYXQgd2FudHMgdG8gYmUgcGFzc2VkXG4gICAqIEByZXR1cm5zIEEgbWFwIG9mIHRoZSBhcHBsaWNhdGlvbnMgd2hpY2ggdGhlIGtleSBpcyB0aGUgYnVuZGxlSWRcbiAgICovXG4gIGFzeW5jIGxvb2t1cEFwcGxpY2F0aW9ucyAob3B0cyA9IHt9KSB7XG4gICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgIENvbW1hbmQ6ICdMb29rdXAnLFxuICAgICAgQ2xpZW50T3B0aW9uczoge31cbiAgICB9O1xuICAgIGlmIChvcHRzLmJ1bmRsZUlkcykge1xuICAgICAgcmVxdWVzdC5DbGllbnRPcHRpb25zLkJ1bmRsZUlEcyA9IF8uaXNTdHJpbmcob3B0cy5idW5kbGVJZHMpID8gW29wdHMuYnVuZGxlSWRzXSA6IG9wdHMuYnVuZGxlSWRzO1xuICAgIH1cbiAgICBpZiAob3B0cy5hcHBsaWNhdGlvblR5cGUpIHtcbiAgICAgIHJlcXVlc3QuQ2xpZW50T3B0aW9ucy5BcHBsaWNhdGlvblR5cGUgPSBvcHRzLmFwcGxpY2F0aW9uVHlwZTtcbiAgICB9XG4gICAgaWYgKG9wdHMucmV0dXJuQXR0cmlidXRlcykge1xuICAgICAgcmVxdWVzdC5DbGllbnRPcHRpb25zLlJldHVybkF0dHJpYnV0ZXMgPSBvcHRzLnJldHVybkF0dHJpYnV0ZXM7XG4gICAgfVxuXG4gICAgdGhpcy5wbGlzdFNlcnZpY2Uuc2VuZFBsaXN0KHJlcXVlc3QpO1xuICAgIGNvbnN0IG1lc3NhZ2VzID0gYXdhaXQgdGhpcy5fd2FpdE1lc3NhZ2VDb21wbGV0aW9uKCk7XG4gICAgZm9yIChjb25zdCBtZXNzYWdlIG9mIG1lc3NhZ2VzKSB7XG4gICAgICBpZiAobWVzc2FnZS5Mb29rdXBSZXN1bHQpIHtcbiAgICAgICAgcmV0dXJuIG1lc3NhZ2UuTG9va3VwUmVzdWx0O1xuICAgICAgfVxuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkbid0IGZpbmQgTG9va3VwUmVzdWx0IGluIHRoZSByZXNwb25zZTogUmVzcG9uc2U6ICR7SlNPTi5zdHJpbmdpZnkobWVzc2FnZXMpfWApO1xuICB9XG5cbiAgLyoqXG4gICAqIFVuaW5zdGFsbHMgYW4gYXBwbGljYXRpb24gYWNjb3JkaW5nIHRvIHRoZSBnaXZlbiBidW5kbGVJZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gYnVuZGxlSWQgb2YgdGhlIGFwcCB0aGF0IG5lZWRzIHRvIGJlIHBhc3NlZCBmb3IgdW5pbnN0YWxsYXRpb25cbiAgICogQHBhcmFtIHtudW1iZXJ9IHRpbWVvdXQgVGhlIHRpbWVvdXQgYmV0d2VlbiBtZXNzYWdlcyByZWNlaXZlZCBmcm9tIHRoZSBwaG9uZSBhcyBzdGF0dXMgdXBkYXRlc1xuICAgKi9cbiAgYXN5bmMgdW5pbnN0YWxsQXBwbGljYXRpb24gKGJ1bmRsZUlkLCB0aW1lb3V0ID0gMjAwMDApIHtcbiAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgQ29tbWFuZDogJ1VuaW5zdGFsbCcsXG4gICAgICBBcHBsaWNhdGlvbklkZW50aWZpZXI6IGJ1bmRsZUlkXG4gICAgfTtcblxuICAgIHRoaXMucGxpc3RTZXJ2aWNlLnNlbmRQbGlzdChyZXF1ZXN0KTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5fd2FpdE1lc3NhZ2VDb21wbGV0aW9uKHRpbWVvdXQpO1xuICB9XG5cbiAgYXN5bmMgX3dhaXRNZXNzYWdlQ29tcGxldGlvbiAodGltZW91dCkge1xuICAgIGxldCBtZXNzYWdlcyA9IFtdO1xuICAgIC8vIEp1c3QgYWRkZWQgZm9yIHNhZmV0eS4gVGhpcyBzaG91bGRuJ3QgaGFwcGVuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUjsgaSsrKSB7XG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5wbGlzdFNlcnZpY2UucmVjZWl2ZVBsaXN0KHRpbWVvdXQpO1xuICAgICAgbWVzc2FnZXMucHVzaChkYXRhKTtcbiAgICAgIGlmICh0aGlzLl9pc0ZpbmlzaGVkKGRhdGEpKSB7XG4gICAgICAgIHJldHVybiBtZXNzYWdlcztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBfaXNGaW5pc2hlZCAocmVzcG9uc2UpIHtcbiAgICBpZiAocmVzcG9uc2UuRXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KHJlc3BvbnNlKX1gKTtcbiAgICB9XG5cbiAgICBpZiAoIXJlc3BvbnNlLlN0YXR1cykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gcmVzcG9uc2UuU3RhdHVzID09PSAnQ29tcGxldGUnO1xuICB9XG5cbiAgLyoqXG4gICAqIENsb3NlcyB0aGUgdW5kZXJseWluZyBzb2NrZXQgY29tbXVuaWNhdGluZyB3aXRoIHRoZSBwaG9uZVxuICAgKi9cbiAgY2xvc2UgKCkge1xuICAgIHRoaXMucGxpc3RTZXJ2aWNlLmNsb3NlKCk7XG4gIH1cbn1cblxuZXhwb3J0IHsgSW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlLCBJTlNUQUxMQVRJT05fUFJPWFlfU0VSVklDRV9OQU1FIH07XG5leHBvcnQgZGVmYXVsdCBJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2U7XG5cbiJdLCJmaWxlIjoibGliL2luc3RhbGxhdGlvbi1wcm94eS9pbmRleC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
