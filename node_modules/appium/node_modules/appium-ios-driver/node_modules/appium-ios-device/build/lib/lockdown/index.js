"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.LOCKDOWN_PORT = exports.Lockdown = void 0;

require("source-map-support/register");

const LOCKDOWN_PORT = 62078;
exports.LOCKDOWN_PORT = LOCKDOWN_PORT;
const LABEL = 'usbmuxd';
const PROTOCOL_VERSION = 2;

class Lockdown {
  constructor(plistService) {
    this.plistService = plistService;
  }

  async queryType(timeout = 5000) {
    const data = await this.plistService.sendPlistAndReceive({
      Label: LABEL,
      ProtocolVersion: PROTOCOL_VERSION,
      Request: 'QueryType'
    }, timeout);

    if (data.Request === 'QueryType' && data.Type === 'com.apple.mobile.lockdown') {
      return data;
    } else {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }
  }

  async startSession(hostID, systemBUID, timeout = 5000) {
    const data = await this.plistService.sendPlistAndReceive({
      Label: LABEL,
      ProtocolVersion: PROTOCOL_VERSION,
      Request: 'StartSession',
      HostID: hostID,
      SystemBUID: systemBUID
    }, timeout);

    if (data.Request === 'StartSession' && data.SessionID) {
      return {
        sessionID: data.SessionID,
        enableSessionSSL: data.EnableSessionSSL
      };
    } else {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }
  }

  enableSessionSSL(hostPrivateKey, hostCertificate) {
    this.plistService.enableSessionSSL(hostPrivateKey, hostCertificate);
  }

  async getValue(query = {}, timeout = 5000) {
    let plist = {
      Label: LABEL,
      ProtocolVersion: PROTOCOL_VERSION,
      Request: 'GetValue'
    };
    Object.assign(plist, query);
    const data = await this.plistService.sendPlistAndReceive(plist, timeout);

    if (data.Request === 'GetValue' && data.Value) {
      return data.Value;
    } else {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }
  }

  async startService(serviceName, timeout = 5000) {
    const data = await this.plistService.sendPlistAndReceive({
      Label: LABEL,
      ProtocolVersion: PROTOCOL_VERSION,
      Request: 'StartService',
      Service: serviceName
    }, timeout);

    if (data.Error) {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    } else {
      return data;
    }
  }

  close() {
    this.plistService.close();
  }

}

exports.Lockdown = Lockdown;
var _default = Lockdown;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9sb2NrZG93bi9pbmRleC5qcyJdLCJuYW1lcyI6WyJMT0NLRE9XTl9QT1JUIiwiTEFCRUwiLCJQUk9UT0NPTF9WRVJTSU9OIiwiTG9ja2Rvd24iLCJjb25zdHJ1Y3RvciIsInBsaXN0U2VydmljZSIsInF1ZXJ5VHlwZSIsInRpbWVvdXQiLCJkYXRhIiwic2VuZFBsaXN0QW5kUmVjZWl2ZSIsIkxhYmVsIiwiUHJvdG9jb2xWZXJzaW9uIiwiUmVxdWVzdCIsIlR5cGUiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJzdGFydFNlc3Npb24iLCJob3N0SUQiLCJzeXN0ZW1CVUlEIiwiSG9zdElEIiwiU3lzdGVtQlVJRCIsIlNlc3Npb25JRCIsInNlc3Npb25JRCIsImVuYWJsZVNlc3Npb25TU0wiLCJFbmFibGVTZXNzaW9uU1NMIiwiaG9zdFByaXZhdGVLZXkiLCJob3N0Q2VydGlmaWNhdGUiLCJnZXRWYWx1ZSIsInF1ZXJ5IiwicGxpc3QiLCJPYmplY3QiLCJhc3NpZ24iLCJWYWx1ZSIsInN0YXJ0U2VydmljZSIsInNlcnZpY2VOYW1lIiwiU2VydmljZSIsImNsb3NlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxNQUFNQSxhQUFhLEdBQUcsS0FBdEI7O0FBQ0EsTUFBTUMsS0FBSyxHQUFHLFNBQWQ7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBRyxDQUF6Qjs7QUFFQSxNQUFNQyxRQUFOLENBQWU7QUFFYkMsRUFBQUEsV0FBVyxDQUFFQyxZQUFGLEVBQWdCO0FBQ3pCLFNBQUtBLFlBQUwsR0FBb0JBLFlBQXBCO0FBQ0Q7O0FBT0QsUUFBTUMsU0FBTixDQUFpQkMsT0FBTyxHQUFHLElBQTNCLEVBQWlDO0FBQy9CLFVBQU1DLElBQUksR0FBRyxNQUFNLEtBQUtILFlBQUwsQ0FBa0JJLG1CQUFsQixDQUFzQztBQUN2REMsTUFBQUEsS0FBSyxFQUFFVCxLQURnRDtBQUV2RFUsTUFBQUEsZUFBZSxFQUFFVCxnQkFGc0M7QUFHdkRVLE1BQUFBLE9BQU8sRUFB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U0FBTCxDQUFlUixJQUFmLENBQXFCLEVBQW5ELENBQU47QUFDRCxLQUZELE1BRU87QUFDTCxhQUFPQSxJQUFQO0FBQ0Q7QUFDRjs7QUFJRDZCLEVBQUFBLEtBQUssR0FBSTtBQUNQLFNBQUtoQyxZQUFMLENBQWtCZ0MsS0FBbEI7QUFDRDs7QUE3R1k7OztlQWlIQWxDLFEiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBMT0NLRE9XTl9QT1JUID0gNjIwNzg7XG5jb25zdCBMQUJFTCA9ICd1c2JtdXhkJztcbmNvbnN0IFBST1RPQ09MX1ZFUlNJT04gPSAyO1xuXG5jbGFzcyBMb2NrZG93biB7XG5cbiAgY29uc3RydWN0b3IgKHBsaXN0U2VydmljZSkge1xuICAgIHRoaXMucGxpc3RTZXJ2aWNlID0gcGxpc3RTZXJ2aWNlO1xuICB9XG5cbiAgLyoqXG4gICAqIE1ha2VzIGEgcXVlcnkgdHlwZSByZXF1ZXN0IHRvIGxvY2tkb3duXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIGxvY2tkb3duZFxuICAgKiBAcmV0dXJucyB7T2JqZWN0fVxuICAgKi9cbiAgYXN5bmMgcXVlcnlUeXBlICh0aW1lb3V0ID0gNTAwMCkge1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLnBsaXN0U2VydmljZS5zZW5kUGxpc3RBbmRSZWNlaXZlKHtcbiAgICAgIExhYmVsOiBMQUJFTCxcbiAgICAgIFByb3RvY29sVmVyc2lvbjogUFJPVE9DT0xfVkVSU0lPTixcbiAgICAgIFJlcXVlc3Q6ICdRdWVyeVR5cGUnXG4gICAgfSwgdGltZW91dCk7XG4gICAgaWYgKGRhdGEuUmVxdWVzdCA9PT0gJ1F1ZXJ5VHlwZScgJiYgZGF0YS5UeXBlID09PSAnY29tLmFwcGxlLm1vYmlsZS5sb2NrZG93bicpIHtcbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZGF0YTogJHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU3RhcnRzIGEgbG9ja2Rvd24gc2Vzc2lvbiB3aGljaCBhbGxvd3MgdG8gdXNlIGNlcnRhaW4gYXBpc1xuICAgKiBAcGFyYW0ge3N0cmluZ30gaG9zdElEIHRoZSBob3N0IGlkIHdoaWNoIGNhbiBiZSByZXRyaWV2ZWQgZnJvbSB0aGUgcGFpciByZWNvcmRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN5c3RlbUJVSUQgdGhlIGhvc3QgQlVJRCB3aGljaCBjYW4gYmUgcmV0cmlldmVkIGZyb20gdGhlIHBhaXIgcmVjb3JkXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIGxvY2tkb3duZFxuICAgKiBAcmV0dXJucyB7T2JqZWN0fVxuICAgKi9cbiAgYXN5bmMgc3RhcnRTZXNzaW9uIChob3N0SUQsIHN5c3RlbUJVSUQsIHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMucGxpc3RTZXJ2aWNlLnNlbmRQbGlzdEFuZFJlY2VpdmUoe1xuICAgICAgTGFiZWw6IExBQkVMLFxuICAgICAgUHJvdG9jb2xWZXJzaW9uOiBQUk9UT0NPTF9WRVJTSU9OLFxuICAgICAgUmVxdWVzdDogJ1N0YXJ0U2Vzc2lvbicsXG4gICAgICBIb3N0SUQ6IGhvc3RJRCxcbiAgICAgIFN5c3RlbUJVSUQ6IHN5c3RlbUJVSURcbiAgICB9LCB0aW1lb3V0KTtcblxuICAgIGlmIChkYXRhLlJlcXVlc3QgPT09ICdTdGFydFNlc3Npb24nICYmIGRhdGEuU2Vzc2lvbklEKSB7XG4gICAgICByZXR1cm4geyBzZXNzaW9uSUQ6IGRhdGEuU2Vzc2lvbklELCBlbmFibGVTZXNzaW9uU1NMOiBkYXRhLkVuYWJsZVNlc3Npb25TU0wgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEVuYWJsZXMgc3NsIGluIHRoZSB1bmRlcmx5aW5nIHNvY2tldCBzb2NrZXQgY29ubmVjdGlvblxuICAgKiBAcGFyYW0ge0J1ZmZlcn0gaG9zdFByaXZhdGVLZXkgdGhlIHByaXZhdGUga2V5IHdoaWNoIGNhbiBiZSByZXRyaWV2ZWQgZnJvbSB0aGUgcGFpciByZWNvcmRcbiAgICogQHBhcmFtIHtCdWZmZXJ9IGhvc3RDZXJ0aWZpY2F0ZSB0aGUgY2VydGlmaWNhdGUgd2hpY2ggY2FuIGJlIHJldHJpZXZlZCBmcm9tIHRoZSBwYWlyIHJlY29yZFxuICAgKi9cbiAgZW5hYmxlU2Vzc2lvblNTTCAoaG9zdFByaXZhdGVLZXksIGhvc3RDZXJ0aWZpY2F0ZSkge1xuICAgIHRoaXMucGxpc3RTZXJ2aWNlLmVuYWJsZVNlc3Npb25TU0woaG9zdFByaXZhdGVLZXksIGhvc3RDZXJ0aWZpY2F0ZSk7XG4gIH1cblxuICAvKipcbiAgKiBAdHlwZWRlZiB7T2JqZWN0fSBRdWVyeVxuICAqXG4gICogQHByb3BlcnR5IHs/c3RyaW5nfSBrZXkgVGhlIGtleSB3ZSB3YW50IHRvIGFjY2Vzc1xuICAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gZG9taWFuIFRoZSBkb21haW4gd2hlcmUgd2Ugd2FudCB0byBhY2Nlc3NcbiAgKi9cblxuICAvKipcbiAgICogR2V0cyB2YWx1ZXMgZnJvbSB0aGUgZGV2aWNlIGFjY29yZGluZyB0byB0aGUgcXVlcnkgcGFzc2VkXG4gICAqIEBwYXJhbSB7UXVlcnl9IHF1ZXJ5IHRoZSBxdWVyeSB3ZSB3YW50IHRvIHNlbmQgdG8gbG9ja2Rvd25kXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIGxvY2tkb3duZFxuICAgKiBAcmV0dXJucyB7T2JqZWN0fVxuICAgKi9cbiAgYXN5bmMgZ2V0VmFsdWUgKHF1ZXJ5ID0ge30sIHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgbGV0IHBsaXN0ID0ge1xuICAgICAgTGFiZWw6IExBQkVMLFxuICAgICAgUHJvdG9jb2xWZXJzaW9uOiBQUk9UT0NPTF9WRVJTSU9OLFxuICAgICAgUmVxdWVzdDogJ0dldFZhbHVlJ1xuICAgIH07XG4gICAgT2JqZWN0LmFzc2lnbihwbGlzdCwgcXVlcnkpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLnBsaXN0U2VydmljZS5zZW5kUGxpc3RBbmRSZWNlaXZlKHBsaXN0LCB0aW1lb3V0KTtcbiAgICBpZiAoZGF0YS5SZXF1ZXN0ID09PSAnR2V0VmFsdWUnICYmIGRhdGEuVmFsdWUpIHtcbiAgICAgIHJldHVybiBkYXRhLlZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZGF0YTogJHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU3RhcnRzIGEgc2VydmljZSBvbiB0aGUgcGhvbmUgY29ycmVzcG9uZGluZyB0byB0aGUgbmFtZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gc2VydmljZU5hbWUgdGhlIG5hbWUgb2YgdGhlIHNlcnZpY2Ugd2hpY2ggd2Ugd2FudCB0byBzdGFydFxuICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbWVvdXQ9NTAwMF0gdGhlIHRpbWVvdXQgb2YgcmVjZWl2aW5nIGEgcmVzcG9uc2UgZnJvbSBsb2NrZG93bmRcbiAgICogQHJldHVybnMge09iamVjdH1cbiAgICovXG4gIGFzeW5jIHN0YXJ0U2VydmljZSAoc2VydmljZU5hbWUsIHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMucGxpc3RTZXJ2aWNlLnNlbmRQbGlzdEFuZFJlY2VpdmUoe1xuICAgICAgTGFiZWw6IExBQkVMLFxuICAgICAgUHJvdG9jb2xWZXJzaW9uOiBQUk9UT0NPTF9WRVJTSU9OLFxuICAgICAgUmVxdWVzdDogJ1N0YXJ0U2VydmljZScsXG4gICAgICBTZXJ2aWNlOiBzZXJ2aWNlTmFtZSxcbiAgICB9LCB0aW1lb3V0KTtcblxuICAgIGlmIChkYXRhLkVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZGF0YTogJHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiBDbG9zZXMgdGhlIHVuZGVybHlpbmcgc29ja2V0IGNvbW11bmljYXRpbmcgd2l0aCB0aGUgcGhvbmVcbiAgICovXG4gIGNsb3NlICgpIHtcbiAgICB0aGlzLnBsaXN0U2VydmljZS5jbG9zZSgpO1xuICB9XG59XG5cbmV4cG9ydCB7IExvY2tkb3duLCBMT0NLRE9XTl9QT1JUIH07XG5leHBvcnQgZGVmYXVsdCBMb2NrZG93bjsiXSwiZmlsZSI6ImxpYi9sb2NrZG93bi9pbmRleC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
