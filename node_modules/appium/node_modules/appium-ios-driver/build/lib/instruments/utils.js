"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.killAllInstruments = killAllInstruments;
exports.cleanAllTraces = cleanAllTraces;
exports.getInstrumentsPath = getInstrumentsPath;
exports.getAvailableDevices = getAvailableDevices;
exports.parseLaunchTimeout = parseLaunchTimeout;
exports.getIwdPath = getIwdPath;
exports.quickLaunch = quickLaunch;
exports.quickInstruments = quickInstruments;
exports.rootDir = void 0;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _teen_process = require("teen_process");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("./logger"));

var _appiumXcode = _interopRequireDefault(require("appium-xcode"));

var _lodash = _interopRequireDefault(require("lodash"));

var _instruments = _interopRequireDefault(require("./instruments"));

const rootDir = _path.default.resolve(__dirname, '../..');

exports.rootDir = rootDir;
const INST_STALL_TIMEOUT = 12000;
const SIM_DEVICE_REGEXP = /^.+ \(\d+\.(\d+\.)?\d+( Simulator)?\) \[.+\]( \(Simulator\))?$/;

async function getInstrumentsPath() {
  let instrumentsPath;

  try {
    let {
      stdout
    } = await (0, _teen_process.exec)('xcrun', ['-find', 'instruments']);
    instrumentsPath = (stdout || '').trim().replace('\n$', '');
  } catch (err) {
    if (err) {
      _logger.default.error(err.message);
    }
  }

  if (!instrumentsPath) {
    _logger.default.errorAndThrow('Could not find the instruments binary. Please ensure ' + '`xcrun -find instruments` can locate it.');
  }

  _logger.default.debug(`Instruments is at: ${instrumentsPath}`);

  return instrumentsPath;
}

async function getAvailableDevices(timeout = INST_STALL_TIMEOUT) {
  _logger.default.debug('Getting list of devices instruments supports');

  let instrumentsPath = await getInstrumentsPath();
  let opts = {
    timeout
  };
  let lines;

  try {
    let {
      stdout
    } = await (0, _teen_process.exec)(instrumentsPath, ['-s', 'devices'], opts);
    lines = stdout.split('\n');
  } catch (err) {
    _logger.default.errorAndThrow(`Failed getting devices, err: ${err}.`);
  }

  const devices = lines.filter(line => SIM_DEVICE_REGEXP.test(line));

  _logger.default.debug(`Available devices: ${devices}`);

  return devices;
}

async function killAllInstruments() {
  _logger.default.debug('Killing all instruments');

  try {
    await (0, _teen_process.exec)('pkill', ['-f', 'instruments']);
  } catch (ign) {}
}

async function cleanAllTraces() {
  if (process.env.CLEAN_TRACES) {
    try {
      await _appiumSupport.fs.rimraf('instrumentscli*.trace');
    } catch (ign) {}
  }
}

function parseLaunchTimeout(launchTimeout) {
  if (_lodash.default.isString(launchTimeout)) {
    try {
      launchTimeout = JSON.parse(launchTimeout);
    } catch (err) {
      _logger.default.warn(`Invalid launch timeout: ${launchTimeout}`);
    }
  }

  if (_lodash.default.isNumber(launchTimeout)) {
    launchTimeout = {
      global: launchTimeout
    };
  }

  return launchTimeout;
}

async function getIwdPath(xcodeMajorVersion) {
  let thirdpartyPath = _path.default.resolve(rootDir, '..', 'instruments-iwd');

  let iwdPath = _path.default.resolve(thirdpartyPath, `iwd${xcodeMajorVersion}`);

  if (!(await _appiumSupport.fs.exists(iwdPath))) {
    iwdPath = _path.default.resolve(thirdpartyPath, 'iwd');
  }

  _logger.default.debug(`Found Insruments-Without-Delay: ${iwdPath}`);

  return iwdPath;
}

async function quickLaunch(udid, appPath = _path.default.resolve(__dirname, '..', '..', 'assets', 'TestApp.app')) {
  let traceTemplatePath = await _appiumXcode.default.getAutomationTraceTemplatePath();

  let scriptPath = _path.default.resolve(__dirname, '..', '..', 'assets', 'blank_instruments_test.js');

  let traceDocument = _path.default.resolve('/', 'tmp', 'testTrace.trace');

  let resultsPath = _path.default.resolve('/', 'tmp');

  await _appiumSupport.fs.rimraf(traceDocument);
  let args = ['instruments', '-D', traceDocument, '-t', traceTemplatePath, '-w', udid, appPath, '-e', 'UIASCRIPT', scriptPath, '-e', 'UIARESULTSPATH', resultsPath];

  _logger.default.debug(`Running command: 'xcrun ${args.join(' ')}'`);

  await (0, _teen_process.exec)('xcrun', args);
}

async function quickInstruments(opts = {}) {
  opts = _lodash.default.cloneDeep(opts);
  let xcodeTraceTemplatePath = opts.xcodeTraceTemplatePath || (await _appiumXcode.default.getAutomationTraceTemplatePath());

  _lodash.default.defaults(opts, {
    launchTimeout: 60000,
    template: xcodeTraceTemplatePath,
    withoutDelay: true,
    xcodeVersion: '8.1',
    webSocket: null,
    flakeyRetries: true,
    logNoColors: false
  });

  return new _instruments.default(opts);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0cnVtZW50cy91dGlscy5qcyJdLCJuYW1lcyI6WyJyb290RGlyIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJJTlNUX1NUQUxMX1RJTUVPVVQiLCJTSU1fREVWSUNFX1JFR0VYUCIsImdldEluc3RydW1lbnRzUGF0aCIsImluc3RydW1lbnRzUGF0aCIsInN0ZG91dCIsInRyaW0iLCJyZXBsYWNlIiwiZXJyIiwibG9nIiwiZXJyb3IiLCJtZXNzYWdlIiwiZXJyb3JBbmRUaHJvdyIsImRlYnVnIiwiZ2V0QXZhaWxhYmxlRGV2aWNlcyIsInRpbWVvdXQiLCJvcHRzIiwibGluZXMiLCJzcGxpdCIsImRldmljZXMiLCJmaWx0ZXIiLCJsaW5lIiwidGVzdCIsImtpbGxBbGxJbnN0cnVtZW50cyIsImlnbiIsImNsZWFuQWxsVHJhY2VzIiwicHJvY2VzcyIsImVudiIsIkNMRUFOX1RSQUNFUyIsImZzIiwicmltcmFmIiwicGFyc2VMYXVuY2hUaW1lb3V0IiwibGF1bmNoVGltZW91dCIsIl8iLCJpc1N0cmluZyIsIkpTT04iLCJwYXJzZSIsIndhcm4iLCJpc051bWJlciIsImdsb2JhbCIsImdldEl3ZFBhdGgiLCJ4Y29kZU1ham9yVmVyc2lvbiIsInRoaXJkcGFydHlQYXRoIiwiaXdkUGF0aCIsImV4aXN0cyIsInF1aWNrTGF1bmNoIiwidWRpZCIsImFwcFBhdGgiLCJ0cmFjZVRlbXBsYXRlUGF0aCIsInhjb2RlIiwiZ2V0QXV0b21hdGlvblRyYWNlVGVtcGxhdGVQYXRoIiwic2NyaXB0UGF0aCIsInRyYWNlRG9jdW1lbnQiLCJyZXN1bHRzUGF0aCIsImFyZ3MiLCJqb2luIiwicXVpY2tJbnN0cnVtZW50cyIsImNsb25lRGVlcCIsInhjb2RlVHJhY2VUZW1wbGF0ZVBhdGgiLCJkZWZhdWx0cyIsInRlbXBsYXRlIiwid2l0aG91dERlbGF5IiwieGNvZGVWZXJzaW9uIiwid2ViU29ja2V0IiwiZmxha2V5UmV0cmllcyIsImxvZ05vQ29sb3JzIiwi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cG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHhjb2RlIGZyb20gJ2FwcGl1bS14Y29kZSc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEluc3RydW1lbnRzIGZyb20gJy4vaW5zdHJ1bWVudHMnO1xuXG5cbmNvbnN0IHJvb3REaXIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vLi4nKTtcbmNvbnN0IElOU1RfU1RBTExfVElNRU9VVCA9IDEyMDAwO1xuXG4vLyBodHRwczovL3JlZ2V4MTAxLmNvbS9yL2FFNmFTMy82XG5jb25zdCBTSU1fREVWSUNFX1JFR0VYUCA9IC9eLisgXFwoXFxkK1xcLihcXGQrXFwuKT9cXGQrKCBTaW11bGF0b3IpP1xcKSBcXFsuK1xcXSggXFwoU2ltdWxhdG9yXFwpKT8kLztcblxuYXN5bmMgZnVuY3Rpb24gZ2V0SW5zdHJ1bWVudHNQYXRoICgpIHtcbiAgbGV0IGluc3RydW1lbnRzUGF0aDtcbiAgdHJ5IHtcbiAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKCd4Y3J1bicsIFsnLWZpbmQnLCAnaW5zdHJ1bWVudHMnXSk7XG4gICAgaW5zdHJ1bWVudHNQYXRoID0gKHN0ZG91dCB8fCAnJykudHJpbSgpLnJlcGxhY2UoJ1xcbiQnLCAnJyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvcihlcnIubWVzc2FnZSk7XG4gICAgfVxuICB9XG4gIGlmICghaW5zdHJ1bWVudHNQYXRoKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coJ0NvdWxkIG5vdCBmaW5kIHRoZSBpbnN0cnVtZW50cyBiaW5hcnkuIFBsZWFzZSBlbnN1cmUgJyArXG4gICAgICAgICAgICAgICAgICAgICAgJ2B4Y3J1biAtZmluZCBpbnN0cnVtZW50c2AgY2FuIGxvY2F0ZSBpdC4nKTtcbiAgfVxuICBsb2cuZGVidWcoYEluc3RydW1lbnRzIGlzIGF0OiAke2luc3RydW1lbnRzUGF0aH1gKTtcbiAgcmV0dXJuIGluc3RydW1lbnRzUGF0aDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QXZhaWxhYmxlRGV2aWNlcyAodGltZW91dCA9IElOU1RfU1RBTExfVElNRU9VVCkge1xuICBsb2cuZGVidWcoJ0dldHRpbmcgbGlzdCBvZiBkZXZpY2VzIGluc3RydW1lbnRzIHN1cHBvcnRzJyk7XG4gIGxldCBpbnN0cnVtZW50c1BhdGggPSBhd2FpdCBnZXRJbnN0cnVtZW50c1BhdGgoKTtcbiAgbGV0IG9wdHMgPSB7dGltZW91dH07XG4gIGxldCBsaW5lcztcbiAgdHJ5IHtcbiAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKGluc3RydW1lbnRzUGF0aCwgWyctcycsICdkZXZpY2VzJ10sIG9wdHMpO1xuICAgIGxpbmVzID0gc3Rkb3V0LnNwbGl0KCdcXG4nKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEZhaWxlZCBnZXR0aW5nIGRldmljZXMsIGVycjogJHtlcnJ9LmApO1xuICB9XG4gIGNvbnN0IGRldmljZXMgPSBsaW5lcy5maWx0ZXIoKGxpbmUpID0+IFNJTV9ERVZJQ0VfUkVHRVhQLnRlc3QobGluZSkpO1xuICBsb2cuZGVidWcoYEF2YWlsYWJsZSBkZXZpY2VzOiAke2RldmljZXN9YCk7XG4gIHJldHVybiBkZXZpY2VzO1xufVxuXG5hc3luYyBmdW5jdGlvbiBraWxsQWxsSW5zdHJ1bWVudHMgKCkge1xuICBsb2cuZGVidWcoJ0tpbGxpbmcgYWxsIGluc3RydW1lbnRzJyk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygncGtpbGwnLCBbJy1mJywgJ2luc3RydW1lbnRzJ10pO1xuICB9IGNhdGNoIChpZ24pIHt9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNsZWFuQWxsVHJhY2VzICgpIHtcbiAgaWYgKHByb2Nlc3MuZW52LkNMRUFOX1RSQUNFUykge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYoJ2luc3RydW1lbnRzY2xpKi50cmFjZScpO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZUxhdW5jaFRpbWVvdXQgKGxhdW5jaFRpbWVvdXQpIHtcbiAgLy8gbnVtYmVyIG9yIG9iamVjdCBsaWtlIHsgZ2xvYmFsOiA0MDAwMCwgYWZ0ZXJTaW1MYXVuY2g6IDUwMDAgfVxuICAvLyBtYXkgYWxzbyBwYXJzZSBKU09OIHN0cmluZ3MuXG4gIGlmIChfLmlzU3RyaW5nKGxhdW5jaFRpbWVvdXQpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxhdW5jaFRpbWVvdXQgPSBKU09OLnBhcnNlKGxhdW5jaFRpbWVvdXQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYEludmFsaWQgbGF1bmNoIHRpbWVvdXQ6ICR7bGF1bmNoVGltZW91dH1gKTtcbiAgICB9XG4gIH1cbiAgaWYgKF8uaXNOdW1iZXIobGF1bmNoVGltZW91dCkpIHtcbiAgICBsYXVuY2hUaW1lb3V0ID0ge1xuICAgICAgZ2xvYmFsOiBsYXVuY2hUaW1lb3V0XG4gICAgfTtcbiAgfVxuICByZXR1cm4gbGF1bmNoVGltZW91dDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0SXdkUGF0aCAoeGNvZGVNYWpvclZlcnNpb24pIHtcbiAgbGV0IHRoaXJkcGFydHlQYXRoID0gcGF0aC5yZXNvbHZlKHJvb3REaXIsICcuLicsICdpbnN0cnVtZW50cy1pd2QnKTtcbiAgbGV0IGl3ZFBhdGggPSBwYXRoLnJlc29sdmUodGhpcmRwYXJ0eVBhdGgsIGBpd2Qke3hjb2RlTWFqb3JWZXJzaW9ufWApO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhpd2RQYXRoKSkge1xuICAgIGl3ZFBhdGggPSBwYXRoLnJlc29sdmUodGhpcmRwYXJ0eVBhdGgsICdpd2QnKTtcbiAgfVxuICBsb2cuZGVidWcoYEZvdW5kIEluc3J1bWVudHMtV2l0aG91dC1EZWxheTogJHtpd2RQYXRofWApO1xuICByZXR1cm4gaXdkUGF0aDtcbn1cblxuLy8gdGhpcyBmdW5jdGlvbiBsYXVuY2hlcyBhbiBpbnN0cnVtZW50cyB0ZXN0IHdpdGggYSBkZWZhdWx0IHRlc3Rcbi8vIHRoYXQgaW1tZWRpYXRlbHkgcGFzc2VzLiBJbiB0aGlzIHdheSB3ZSBjYW4gc3RhcnQgYSBzaW11bGF0b3Jcbi8vIGFuZCBiZSBub3RpZmllZCB3aGVuIGl0IGNvbXBsZXRlbHkgbGF1bmNoZXNcbmFzeW5jIGZ1bmN0aW9uIHF1aWNrTGF1bmNoICh1ZGlkLCBhcHBQYXRoID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ2Fzc2V0cycsICdUZXN0QXBwLmFwcCcpKSB7XG4gIGxldCB0cmFjZVRlbXBsYXRlUGF0aCA9IGF3YWl0IHhjb2RlLmdldEF1dG9tYXRpb25UcmFjZVRlbXBsYXRlUGF0aCgpO1xuICBsZXQgc2NyaXB0UGF0aCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdhc3NldHMnLCAnYmxhbmtfaW5zdHJ1bWVudHNfdGVzdC5qcycpO1xuICBsZXQgdHJhY2VEb2N1bWVudCA9IHBhdGgucmVzb2x2ZSgnLycsICd0bXAnLCAndGVzdFRyYWNlLnRyYWNlJyk7XG4gIGxldCByZXN1bHRzUGF0aCA9IHBhdGgucmVzb2x2ZSgnLycsICd0bXAnKTtcblxuICAvLyB0aGUgdHJhY2UgZG9jdW1lbnQgY2FuIGJlIGluIGEgd2VpcmQgc3RhdGVcbiAgLy8gYnV0IHdlIG5ldmVyIGRvIGFueXRoaW5nIHdpdGggaXQsIHNvIGRlbGV0ZVxuICBhd2FpdCBmcy5yaW1yYWYodHJhY2VEb2N1bWVudCk7XG5cbiAgbGV0IGFyZ3MgPSBbXG4gICAgJ2luc3RydW1lbnRzJyxcbiAgICAnLUQnLCB0cmFjZURvY3VtZW50LFxuICAgICctdCcsIHRyYWNlVGVtcGxhdGVQYXRoLFxuICAgICctdycsIHVkaWQsXG4gICAgYXBwUGF0aCxcbiAgICAnLWUnLCAnVUlBU0NSSVBUJywgc2NyaXB0UGF0aCxcbiAgICAnLWUnLCAnVUlBUkVTVUxUU1BBVEgnLCByZXN1bHRzUGF0aF07XG4gIGxvZy5kZWJ1ZyhgUnVubmluZyBjb21tYW5kOiAneGNydW4gJHthcmdzLmpvaW4oJyAnKX0nYCk7XG4gIGF3YWl0IGV4ZWMoJ3hjcnVuJywgYXJncyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHF1aWNrSW5zdHJ1bWVudHMgKG9wdHMgPSB7fSkge1xuICBvcHRzID0gXy5jbG9uZURlZXAob3B0cyk7XG4gIGxldCB4Y29kZVRyYWNlVGVtcGxhdGVQYXRoID0gb3B0cy54Y29kZVRyYWNlVGVtcGxhdGVQYXRoIHx8XG4gICAgICBhd2FpdCB4Y29kZS5nZXRBdXRvbWF0aW9uVHJhY2VUZW1wbGF0ZVBhdGgoKTtcbiAgXy5kZWZhdWx0cyhvcHRzLCB7XG4gICAgbGF1bmNoVGltZW91dDogNjAwMDAsXG4gICAgdGVtcGxhdGU6IHhjb2RlVHJhY2VUZW1wbGF0ZVBhdGgsXG4gICAgd2l0aG91dERlbGF5OiB0cnVlLFxuICAgIHhjb2RlVmVyc2lvbjogJzguMScsXG4gICAgd2ViU29ja2V0OiBudWxsLFxuICAgIGZsYWtleVJldHJpZXM6IHRydWUsXG4gICAgbG9nTm9Db2xvcnM6IGZhbHNlLFxuICB9KTtcbiAgcmV0dXJuIG5ldyBJbnN0cnVtZW50cyhvcHRzKTtcbn1cblxuZXhwb3J0IHtcbiAgcm9vdERpciwga2lsbEFsbEluc3RydW1lbnRzLCBjbGVhbkFsbFRyYWNlcywgZ2V0SW5zdHJ1bWVudHNQYXRoLFxuICBnZXRBdmFpbGFibGVEZXZpY2VzLCBwYXJzZUxhdW5jaFRpbWVvdXQsIGdldEl3ZFBhdGgsIHF1aWNrTGF1bmNoLFxuICBxdWlja0luc3RydW1lbnRzLFxufTtcbiJdLCJmaWxlIjoibGliL2luc3RydW1lbnRzL3V0aWxzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
