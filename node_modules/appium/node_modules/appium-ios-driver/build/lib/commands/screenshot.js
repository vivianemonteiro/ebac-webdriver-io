"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _path = _interopRequireDefault(require("path"));

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _utils = require("../uiauto/utils");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumBaseDriver = require("appium-base-driver");

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

commands.getScreenshot = async function getScreenshot() {
  let guid = _appiumSupport.util.uuidV4();

  let shotFile = `screenshot${guid}`;

  let shotFolder = _path.default.resolve(this.opts.tmpDir, 'appium-instruments/Run 1/');

  if (!(await _appiumSupport.fs.exists(shotFolder))) {
    _logger.default.debug(`Creating folder '${shotFolder}'`);

    await (0, _appiumSupport.mkdirp)(shotFolder);
  }

  let shotPath = _path.default.resolve(shotFolder, `${shotFile}.png`);

  _logger.default.debug(`Taking screenshot: '${shotPath}'`);

  let takeScreenShot = async () => {
    await this.uiAutoClient.sendCommand(`au.capture('${shotFile}')`);
    let screenshotWaitTimeout = (this.opts.screenshotWaitTimeout || 10) * 1000;

    _logger.default.debug(`Waiting ${screenshotWaitTimeout} ms for screenshot to be generated.`);

    let startMs = Date.now();
    let success = false;

    while (Date.now() - startMs < screenshotWaitTimeout) {
      if (await _appiumSupport.fs.hasAccess(shotPath)) {
        success = true;
        break;
      }

      await _bluebird.default.delay(300);
    }

    if (!success) {
      throw new _appiumBaseDriver.errors.UnknownError('Timed out waiting for screenshot file');
    }

    if ((await this.getOrientation()) === 'LANDSCAPE') {
      _logger.default.debug('Rotating landscape screenshot');

      await (0, _utils.rotateImage)(shotPath, -90);
    }

    return await _appiumSupport.fs.readFile(shotPath);
  };

  let data = await (0, _asyncbox.retry)(3, takeScreenShot);
  return Buffer.from(data).toString('base64');
};

commands.getViewportScreenshot = async function getViewportScreenshot() {
  const windowSize = await this.getWindowSize();
  const scale = await this.getDevicePixelRatio();
  const statusBarHeight = (await this.getStatusBarHeight()) * scale;
  const screenshot = await this.getScreenshot();
  let rect = {
    left: 0,
    top: statusBarHeight,
    width: windowSize.width * scale,
    height: windowSize.height * scale - statusBarHeight
  };
  let newScreenshot = await _appiumSupport.imageUtil.cropBase64Image(screenshot, rect);
  return newScreenshot;
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9zY3JlZW5zaG90LmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJnZXRTY3JlZW5zaG90IiwiZ3VpZCIsInV0aWwiLCJ1dWlkVjQiLCJzaG90RmlsZSIsInNob3RGb2xkZXIiLCJwYXRoIiwicmVzb2x2ZSIsIm9wdHMiLCJ0bXBEaXIiLCJmcyIsImV4aXN0cyIsImxvZ2dlciIsImRlYnVnIiwic2hvdFBhdGgiLCJ0YWtlU2NyZWVuU2hvdCIsInVpQXV0b0NsaWVudCIsInNlbmRDb21tYW5kIiwic2NyZWVuc2hvdFdhaXRUaW1lb3V0Iiwic3RhcnRNcyIsIkRhdGUiLCJub3ciLCJzdWNjZXNzIiwiaGFzQWNjZXNzIiwiQiIsImRlbGF5IiwiZXJyb3JzIiwiVW5rbm93bkVycm9yIiwiZ2V0T3JpZW50YXRpb24iLCJyZWFkRmlsZSIsImRhdGEiLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJnZXRWaWV3cG9ydFNjcmVlbnNob3QiLCJ3aW5kb3dTaXplIiwiZ2V0V2luZG93U2l6ZSIsInNjYWxlIiwiZ2V0RGV2aWNlUGl4ZWxSYXRpbyIsInN0YXR1c0JhckhlaWdodCIsImdldFN0YXR1c0JhckhlaWdodCIsInNjcmVlbnNob3QiLCJyZWN0IiwibGVmdCIsInRvcCIsIndpZHRoIiwiaGVpZ2h0IiwibmV3U2NyZWVuc2hvdCIsImltYWdlVXRpbCIsImNyb3BCYXNlNjRJbWFnZSIsIk9iamVjdCIsImFzc2lnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxJQUFJQSxRQUFRLEdBQUcsRUFBZjtBQUFBLElBQW1CQyxPQUFPLEdBQUcsRUFBN0I7QUFBQSxJQUFpQ0MsVUFBVSxHQUFHLEVBQTlDOzs7O0FBRUFGLFFBQVEsQ0FBQ0csYUFBVCxHQUF5QixlQUFlQSxhQUFmLEdBQWdDO0FBQ3ZELE1BQUlDLElBQUksR0FB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RDs7QUFnQkFHLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjcEQsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHJldHJ5IH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgZnMsIG1rZGlycCwgaW1hZ2VVdGlsLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgcm90YXRlSW1hZ2UgfSBmcm9tICcuLi91aWF1dG8vdXRpbHMnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcblxuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbW1hbmRzLmdldFNjcmVlbnNob3QgPSBhc3luYyBmdW5jdGlvbiBnZXRTY3JlZW5zaG90ICgpIHtcbiAgbGV0IGd1aWQgPSB1dGlsLnV1aWRWNCgpO1xuICBsZXQgc2hvdEZpbGUgPSBgc2NyZWVuc2hvdCR7Z3VpZH1gO1xuXG4gIGxldCBzaG90Rm9sZGVyID0gcGF0aC5yZXNvbHZlKHRoaXMub3B0cy50bXBEaXIsICdhcHBpdW0taW5zdHJ1bWVudHMvUnVuIDEvJyk7XG4gIGlmICghKGF3YWl0IGZzLmV4aXN0cyhzaG90Rm9sZGVyKSkpIHtcbiAgICBsb2dnZXIuZGVidWcoYENyZWF0aW5nIGZvbGRlciAnJHtzaG90Rm9sZGVyfSdgKTtcbiAgICBhd2FpdCBta2RpcnAoc2hvdEZvbGRlcik7XG4gIH1cblxuICBsZXQgc2hvdFBhdGggPSBwYXRoLnJlc29sdmUoc2hvdEZvbGRlciwgYCR7c2hvdEZpbGV9LnBuZ2ApO1xuICBsb2dnZXIuZGVidWcoYFRha2luZyBzY3JlZW5zaG90OiAnJHtzaG90UGF0aH0nYCk7XG5cbiAgbGV0IHRha2VTY3JlZW5TaG90ID0gYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGBhdS5jYXB0dXJlKCcke3Nob3RGaWxlfScpYCk7XG5cbiAgICBsZXQgc2NyZWVuc2hvdFdhaXRUaW1lb3V0ID0gKHRoaXMub3B0cy5zY3JlZW5zaG90V2FpdFRpbWVvdXQgfHwgMTApICogMTAwMDtcbiAgICBsb2dnZXIuZGVidWcoYFdhaXRpbmcgJHtzY3JlZW5zaG90V2FpdFRpbWVvdXR9IG1zIGZvciBzY3JlZW5zaG90IHRvIGJlIGdlbmVyYXRlZC5gKTtcbiAgICBsZXQgc3RhcnRNcyA9IERhdGUubm93KCk7XG5cbiAgICBsZXQgc3VjY2VzcyA9IGZhbHNlO1xuICAgIHdoaWxlICgoRGF0ZS5ub3coKSAtIHN0YXJ0TXMpIDwgc2NyZWVuc2hvdFdhaXRUaW1lb3V0KSB7XG4gICAgICBpZiAoYXdhaXQgZnMuaGFzQWNjZXNzKHNob3RQYXRoKSkge1xuICAgICAgICBzdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBhd2FpdCBCLmRlbGF5KDMwMCk7XG4gICAgfVxuICAgIGlmICghc3VjY2Vzcykge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoJ1RpbWVkIG91dCB3YWl0aW5nIGZvciBzY3JlZW5zaG90IGZpbGUnKTtcbiAgICB9XG5cbiAgICAvLyBjaGVjayB0aGUgcm90YXRpb24sIGFuZCByb3RhdGUgaWYgbmVjZXNzYXJ5XG4gICAgaWYgKGF3YWl0IHRoaXMuZ2V0T3JpZW50YXRpb24oKSA9PT0gJ0xBTkRTQ0FQRScpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnUm90YXRpbmcgbGFuZHNjYXBlIHNjcmVlbnNob3QnKTtcbiAgICAgIGF3YWl0IHJvdGF0ZUltYWdlKHNob3RQYXRoLCAtOTApO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgZnMucmVhZEZpbGUoc2hvdFBhdGgpO1xuICB9O1xuXG4gIC8vIFJldHJ5aW5nIHRoZSB3aG9sZSBzY3JlZW5zaG90IHByb2Nlc3MgZm9yIHRocmVlIHRpbWVzLlxuICBsZXQgZGF0YSA9IGF3YWl0IHJldHJ5KDMsIHRha2VTY3JlZW5TaG90KTtcbiAgcmV0dXJuIEJ1ZmZlci5mcm9tKGRhdGEpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbn07XG5cbmNvbW1hbmRzLmdldFZpZXdwb3J0U2NyZWVuc2hvdCA9IGFzeW5jIGZ1bmN0aW9uIGdldFZpZXdwb3J0U2NyZWVuc2hvdCAoKSB7XG4gIGNvbnN0IHdpbmRvd1NpemUgPSBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemUoKTtcbiAgY29uc3Qgc2NhbGUgPSBhd2FpdCB0aGlzLmdldERldmljZVBpeGVsUmF0aW8oKTtcbiAgLy8gc3RhdHVzIGJhciBoZWlnaHQgY29tZXMgaW4gdW5zY2FsZWQsIHNvIHNjYWxlIGl0XG4gIGNvbnN0IHN0YXR1c0JhckhlaWdodCA9IGF3YWl0IHRoaXMuZ2V0U3RhdHVzQmFySGVpZ2h0KCkgKiBzY2FsZTtcbiAgY29uc3Qgc2NyZWVuc2hvdCA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuc2hvdCgpO1xuICBsZXQgcmVjdCA9IHtcbiAgICBsZWZ0OiAwLFxuICAgIHRvcDogc3RhdHVzQmFySGVpZ2h0LFxuICAgIHdpZHRoOiB3aW5kb3dTaXplLndpZHRoICogc2NhbGUsXG4gICAgaGVpZ2h0OiB3aW5kb3dTaXplLmhlaWdodCAqIHNjYWxlIC0gc3RhdHVzQmFySGVpZ2h0XG4gIH07XG4gIGxldCBuZXdTY3JlZW5zaG90ID0gYXdhaXQgaW1hZ2VVdGlsLmNyb3BCYXNlNjRJbWFnZShzY3JlZW5zaG90LCByZWN0KTtcbiAgcmV0dXJuIG5ld1NjcmVlbnNob3Q7XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7Y29tbWFuZHMsIGhlbHBlcnN9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3NjcmVlbnNob3QuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
