"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _lodash = _interopRequireDefault(require("lodash"));

var _js2xmlparser = _interopRequireDefault(require("js2xmlparser2"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var utils = _interopRequireWildcard(require("../utils"));

var _moment = _interopRequireDefault(require("moment"));

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const MOMENT_FORMAT_ISO8601 = 'YYYY-MM-DDTHH:mm:ssZ';

commands.active = async function active() {
  if (this.isWebContext()) {
    return await this.executeAtom('active_element', []);
  } else {
    return await this.uiAutoClient.sendCommand('au.getActiveElement()');
  }
};

commands.getDeviceTime = async function getDeviceTime(format = MOMENT_FORMAT_ISO8601) {
  _logger.default.info('Attempting to capture iOS device date and time');

  let cmd;
  let args;
  let inputFormat;

  if (this.isRealDevice()) {
    try {
      cmd = await _appiumSupport.fs.which('idevicedate');
    } catch (err) {
      _logger.default.errorAndThrow('Could not capture device date and time using libimobiledevice idevicedate. ' + 'Libimobiledevice is probably not installed');
    }

    _logger.default.info(`Found idevicedate: '${cmd}'`);

    args = ['-u', this.opts.udid];
    inputFormat = 'ddd MMM DD HH:mm:ss z YYYY';
  } else {
    _logger.default.warn('On simulator. Assuming device time is the same as host time');

    cmd = 'date';
    args = ['+%Y-%m-%dT%H:%M:%S%z'];
    inputFormat = 'YYYY-MM-DDTHH:mm:ssZZ';
  }

  const stdout = (await (0, _teen_process.exec)(cmd, args)).stdout.trim();

  _logger.default.debug(`Got the following output out of '${cmd} ${args.join(' ')}': ${stdout}`);

  const parsedTimestamp = _moment.default.utc(stdout, inputFormat);

  if (!parsedTimestamp.isValid()) {
    _logger.default.warn(`Cannot parse the timestamp '${stdout}' returned by '${cmd}' command. Returning it as is`);

    return stdout;
  }

  return parsedTimestamp.utcOffset(parsedTimestamp._tzm || 0).format(format);
};

commands.hideKeyboard = async function hideKeyboard(strategy, ...possibleKeys) {
  possibleKeys.pop();
  let cmd;

  let key = _lodash.default.find(possibleKeys, k => k);

  if (key) {
    strategy = strategy || 'pressKey';
    cmd = `au.hideKeyboard('${strategy}', '${key}')`;
  } else {
    strategy = strategy || 'default';
    cmd = `au.hideKeyboard('${strategy}')`;
  }

  await this.uiAutoClient.sendCommand(cmd);
};

commands.getPageSource = async function getPageSource() {
  if (this.isWebContext()) {
    const script = 'return document.documentElement.outerHTML';
    return await this.executeAtom('execute_script', [script, []]);
  } else {
    return await this.getNativePageSource();
  }
};

helpers.getNativePageSource = async function getNativePageSource() {
  let jsonSource = await this.getSourceForElementForXML();

  if (typeof jsonSource === 'string') {
    jsonSource = JSON.parse(jsonSource);
  }

  let xmlSource = (0, _js2xmlparser.default)('AppiumAUT', jsonSource, {
    wrapArray: {
      enabled: false,
      elementName: 'element'
    },
    declaration: {
      include: true
    },
    prettyPrinting: {
      indentString: '    '
    }
  });
  return xmlSource;
};

commands.background = async function background(secs) {
  await this.uiAutoClient.sendCommand(`au.background(${secs})`);
};

commands.lock = async function lock(secs) {
  if (!secs) {
    _logger.default.debug('No seconds parameter. Using 0 seconds');

    secs = 0;
  }

  await this.uiAutoClient.sendCommand(`au.lock(${secs})`);
};

commands.closeApp = async function closeApp() {
  let appName = this.opts.app || this.opts.bundleId;

  try {
    await this.stop();

    _logger.default.info(`Successfully closed the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while closing the '${appName}' app.`);

    throw err;
  }
};

commands.launchApp = async function launchApp() {
  let appName = this.opts.app || this.opts.bundleId;

  try {
    await this.start();

    _logger.default.info(`Successfully launched the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while launching the '${appName}' app.`);

    throw err;
  }
};

commands.removeApp = async function removeApp(bundleId) {
  if (this.isRealDevice()) {
    await this.realDevice.remove(bundleId);
  } else {
    await this.sim.removeApp(bundleId);
  }
};

commands.keys = async function keys(keys) {
  if (this.isWebContext()) {
    let el = await this.active();

    if (_lodash.default.isUndefined(el.ELEMENT)) {
      throw new _appiumBaseDriver.errors.NoSuchElementError();
    }

    await this.setValue(keys, el.ELEMENT);
  } else {
    if (_lodash.default.isArray(keys)) {
      keys = keys.join('');
    }

    if (!_lodash.default.isString(keys)) {
      keys = keys.toString();
    }

    keys = _appiumSupport.util.escapeSpecialChars(keys, "'");
    let command = `au.sendKeysToActiveElement('${keys}')`;
    await this.uiAutoClient.sendCommand(command);
  }
};

commands.setGeoLocation = async function setGeoLocation(location) {
  await this.uiAutoClient.sendCommand(`target.setLocation(${JSON.stringify(location)})`);
};

commands.getWindowSize = async function getWindowSize(windowHandle = 'current') {
  if (windowHandle !== 'current') {
    throw new _appiumBaseDriver.errors.NotYetImplementedError('Currently only getting current window size is supported.');
  }

  if (this.isWebContext()) {
    return await this.executeAtom('get_window_size', []);
  } else {
    return await this.uiAutoClient.sendCommand('au.getWindowSize()');
  }
};

commands.getWindowRect = async function getWindowRect() {
  const {
    width,
    height
  } = await this.getWindowSize();
  return {
    width,
    height,
    x: 0,
    y: 0
  };
};

commands.getStrings = async function getStrings(language, stringFile = null) {
  _logger.default.debug(`Gettings strings for language '${language}' and string file '${stringFile}'`);

  return await utils.parseLocalizableStrings(Object.assign({}, this.opts, {
    language,
    stringFile,
    strictMode: true
  }));
};

commands.setUrl = async function setUrl(url) {
  _logger.default.debug(`Attempting to set url '${url}'`);

  if (this.isWebContext()) {
    this.setCurrentUrl(url);
    this.curWebFrames = [];
    await this.remote.navToUrl(url);
  } else if (this.sim) {
    await this.sim.simctl.openUrl(url);
  } else {
    _logger.default.errorAndThrow('Opening URLs on real devices is not supported');
  }
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJNT01FTlRfRk9STUFUX0lTTzg2MDEiLCJhY3RpdmUiLCJpc1dlYkNvbnRleHQiLCJleGVjdXRlQXRvbSIsInVpQXV0b0NsaWVudCIsInNlbmRDb21tYW5kIiwiZ2V0RGV2aWNlVGltZSIsImZvcm1hdCIsImxvZyIsImluZm8iLCJjbWQiLCJhcmdzIiwiaW5wdXRGb3JtYXQiLCJpc1JlYWxEZXZpY2UiLCJmcyIsIndoaWNoIiwiZXJyIiwiZXJyb3JBbmRUaHJvdyIsIm9wdHMiLCJ1ZGlkIiwid2FybiIsInN0ZG91dCIsInRyaW0iLCJkZWJ1ZyIsImpvaW4iLCJwYXJzZWRUaW1lc3RhbXAiLCJtb21lbnQiLCJ1dGMiLCJpc1ZhbGlkIiwidXRjT2Zmc2V0IiwiX3R6bSIsImhpZGVLZXlib2FyZCIsInN0cmF0ZWd5IiwicG9zc2libGVLZXlzIiwicG9wIiwia2V5IiwiXyIsImZpbmQiLCJrIiwiZ2V0UGFnZVNvdXJjZSIsInNjcmlwdCIsImdldE5hdGl2ZVBhZ2VTb3VyY2UiLCJqc29uU291cmNlIiwiZ2V0U291cmNlRm9yRWxlbWVudEZvclhNTCIsIkpTT04iLCJwYXJzZSIsInhtbFNvdXJjZSIsIndyYXBBcnJheSIsImVuYWJsZWQiLCJlbGVtZW50TmFtZSIsImRlY2xhcmF0aW9uIiwiaW5jbHVkZSIsInByZXR0eVByaW50aW5nIiwiaW5kZW50U3RyaW5nIiwiYmFja2dyb3VuZCIsInNlY3MiLCJsb2NrIiwiY2xvc2VBcHAiLCJhcHBOYW1lIiwiYXBwIiwiYnVuZGxlSWQiLCJzdG9wIiwibGF1bmNoQXBwIiwic3RhcnQiLCJyZW1vdmVBcHAiLCJyZWFsRGV2aWNlIiwicmVtb3ZlIiwic2ltIiwia2V5cyIsImVsIiwiaXNVbmRlZmluZWQiLCJFTEVNRU5UIiwiZXJyb3JzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwic2V0VmFsdWUiLCJpc0FycmF5IiwiaXNTdHJpbmciLCJ0b1N0cmluZyIsInV0aWwiLCJlc2NhcGVTcGVjaWFsQ2hhcnMiLCJjb21tYW5kIiwic2V0R2VvTG9jYXRpb24iLCJsb2NhdGlvbiIsInN0cmluZ2lmeSIsImdldFdpbmRvd1NpemUiLCJ3aW5kb3dIYW5kbGUiLCJOb3RZZXRJbXBsZW1lbnRlZEVycm9yIiwiZ2V0V2luZG93UmVjdCIsIndpZHRoIiwiaGVpZ2h0IiwieCIsInkiLCJnZXRTdHJpbmdzIiwibGFuZ3VhZ2UiLCJzdHJpbmdGaWxlIiwidXRpbHMiLCJwYXJzZUxvY2FsaXphYmxlU3RyaW5ncyIsIk9iamVjdCIsImFzc2lnbiIsInN0cmljdE1vZGUiLCJzZXRVcmwiLCJ1cmwiLCJzZXRDdXJyZW50VXJsIiwiY3VyV2ViRnJhbWVzIiwicmVtb3RlIiwibmF2VG9VcmwiLCJzaW1jdGwiLCJvcGVuVXJsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsUUFBUSxHQUFHLEVBQWY7QUFBQSxJQUFtQkMsT0FBTyxHQUFHLEVBQTdCO0FBQUEsSUFBaUNDLFVBQVUsR0FBRyxFQUE5Qzs7O0FBRUEsTUFBTUMscUJBQXFCLEdBQUcsc0JBQTlCOztBQUVBSCxRQUFRLENBQUNJLE1BQVQsR0FBa0IsZUFBZUEsTUFBZixHQUF5QjtBQUN6QyxNQUFJLEtBQUtDLFlBQUwsRUFBSixFQUF5QjtBQUN2QixXQUFPLE1BQU0sS0FBS0MsV0FBTCxDQUFpQixnQkFBakIsRUFBbUMsRUFBbkMsQ0FBYjtBQUNELEdBRkQsTUFFTztBQUNMLFdBQU8sTUFBTSxLQUFLQyxZQUFMLENBQWtCQyxXQUFsQixDQUE4Qix1QkFBOUIsQ0FBYjtBQUNEO0FBQ0YsQ0FORDs7QUFpQkFSLFFBQVEsQ0FBQ1MsYUFBVCxHQUF5QixlQUFlQSxhQUFmLENBQThCQyxNQUFNLEdBQUdQLHFCQUF2QyxFQUE4RDtBQUNyRlEsa0JBQUlDLElBQUosQ0FBUyxn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Q0EsVUFBTSxLQUFLQyxNQUFMLENBQVlDLFFBQVosQ0FBcUJKLEdBQXJCLENBQU47QUFDRCxHQUxELE1BS08sSUFBSSxLQUFLbEMsR0FBVCxFQUFjO0FBQ25CLFVBQU0sS0FBS0EsR0FBTCxDQUFTdUMsTUFBVCxDQUFnQkMsT0FBaEIsQ0FBd0JOLEdBQXhCLENBQU47QUFDRCxHQUZNLE1BRUE7QUFDTDdGLG9CQUFJUyxhQUFKLENBQWtCLCtDQUFsQjtBQUNEO0FBQ0YsQ0FaRDs7QUFlQWdGLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjbkcsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBqczJ4bWwgZnJvbSAnanMyeG1scGFyc2VyMic7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBmcywgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0ICogYXMgdXRpbHMgZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbnN0IE1PTUVOVF9GT1JNQVRfSVNPODYwMSA9ICdZWVlZLU1NLUREVEhIOm1tOnNzWic7XG5cbmNvbW1hbmRzLmFjdGl2ZSA9IGFzeW5jIGZ1bmN0aW9uIGFjdGl2ZSAoKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2FjdGl2ZV9lbGVtZW50JywgW10pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZCgnYXUuZ2V0QWN0aXZlRWxlbWVudCgpJyk7XG4gIH1cbn07XG5cbi8qKlxuICogUmV0cmlldmVzIHRoZSBjdXJyZW50IGRldmljZSdzIHRpbWVzdGFtcC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gZm9ybWF0IC0gVGhlIHNldCBvZiBmb3JtYXQgc3BlY2lmaWVycy4gUmVhZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHBzOi8vbW9tZW50anMuY29tL2RvY3MvIHRvIGdldCB0aGUgZnVsbCBsaXN0IG9mIHN1cHBvcnRlZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGV0aW1lIGZvcm1hdCBzcGVjaWZpZXJzLiBUaGUgZGVmYXVsdCBmb3JtYXQgaXNcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBgWVlZWS1NTS1ERFRISDptbTpzc1pgLCB3aGljaCBjb21wbGllcyB0byBJU08tODYwMVxuICogQHJldHVybnMgRm9ybWF0dGVkIGRhdGV0aW1lIHN0cmluZyBvciB0aGUgcmF3IGNvbW1hbmQgb3V0cHV0IGlmIGZvcm1hdHRpbmcgZmFpbHNcbiAqL1xuY29tbWFuZHMuZ2V0RGV2aWNlVGltZSA9IGFzeW5jIGZ1bmN0aW9uIGdldERldmljZVRpbWUgKGZvcm1hdCA9IE1PTUVOVF9GT1JNQVRfSVNPODYwMSkge1xuICBsb2cuaW5mbygnQXR0ZW1wdGluZyB0byBjYXB0dXJlIGlPUyBkZXZpY2UgZGF0ZSBhbmQgdGltZScpO1xuICBsZXQgY21kO1xuICBsZXQgYXJncztcbiAgbGV0IGlucHV0Rm9ybWF0O1xuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIHRyeSB7XG4gICAgICBjbWQgPSBhd2FpdCBmcy53aGljaCgnaWRldmljZWRhdGUnKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KCdDb3VsZCBub3QgY2FwdHVyZSBkZXZpY2UgZGF0ZSBhbmQgdGltZSB1c2luZyBsaWJpbW9iaWxlZGV2aWNlIGlkZXZpY2VkYXRlLiAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICdMaWJpbW9iaWxlZGV2aWNlIGlzIHByb2JhYmx5IG5vdCBpbnN0YWxsZWQnKTtcbiAgICB9XG4gICAgbG9nLmluZm8oYEZvdW5kIGlkZXZpY2VkYXRlOiAnJHtjbWR9J2ApO1xuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9saWJpbW9iaWxlZGV2aWNlL2xpYmltb2JpbGVkZXZpY2UvYmxvYi8yNjM3M2IzMzQ4ODlmNWFlMmUyNzM3ZmY0NDdlYjI1YjE3MDBmYTJmL3Rvb2xzL2lkZXZpY2VkYXRlLmMjTDEyOVxuICAgIGFyZ3MgPSBbJy11JywgdGhpcy5vcHRzLnVkaWRdO1xuICAgIGlucHV0Rm9ybWF0ID0gJ2RkZCBNTU0gREQgSEg6bW06c3MgeiBZWVlZJztcbiAgfSBlbHNlIHtcbiAgICBsb2cud2FybignT24gc2ltdWxhdG9yLiBBc3N1bWluZyBkZXZpY2UgdGltZSBpcyB0aGUgc2FtZSBhcyBob3N0IHRpbWUnKTtcbiAgICBjbWQgPSAnZGF0ZSc7XG4gICAgYXJncyA9IFsnKyVZLSVtLSVkVCVIOiVNOiVTJXonXTtcbiAgICBpbnB1dEZvcm1hdCA9ICdZWVlZLU1NLUREVEhIOm1tOnNzWlonO1xuICB9XG4gIGNvbnN0IHN0ZG91dCA9IChhd2FpdCBleGVjKGNtZCwgYXJncykpLnN0ZG91dC50cmltKCk7XG4gIGxvZy5kZWJ1ZyhgR290IHRoZSBmb2xsb3dpbmcgb3V0cHV0IG91dCBvZiAnJHtjbWR9ICR7YXJncy5qb2luKCcgJyl9JzogJHtzdGRvdXR9YCk7XG4gIGNvbnN0IHBhcnNlZFRpbWVzdGFtcCA9IG1vbWVudC51dGMoc3Rkb3V0LCBpbnB1dEZvcm1hdCk7XG4gIGlmICghcGFyc2VkVGltZXN0YW1wLmlzVmFsaWQoKSkge1xuICAgIGxvZy53YXJuKGBDYW5ub3QgcGFyc2UgdGhlIHRpbWVzdGFtcCAnJHtzdGRvdXR9JyByZXR1cm5lZCBieSAnJHtjbWR9JyBjb21tYW5kLiBSZXR1cm5pbmcgaXQgYXMgaXNgKTtcbiAgICByZXR1cm4gc3Rkb3V0O1xuICB9XG4gIHJldHVybiBwYXJzZWRUaW1lc3RhbXAudXRjT2Zmc2V0KHBhcnNlZFRpbWVzdGFtcC5fdHptIHx8IDApLmZvcm1hdChmb3JtYXQpO1xufTtcblxuY29tbWFuZHMuaGlkZUtleWJvYXJkID0gYXN5bmMgZnVuY3Rpb24gaGlkZUtleWJvYXJkIChzdHJhdGVneSwgLi4ucG9zc2libGVLZXlzKSB7XG4gIHBvc3NpYmxlS2V5cy5wb3AoKTsgLy8gbGFzdCBwYXJhbWV0ZXIgaXMgdGhlIHNlc3Npb24gaWRcbiAgbGV0IGNtZDtcbiAgbGV0IGtleSA9IF8uZmluZChwb3NzaWJsZUtleXMsIChrKSA9PiBrKTtcbiAgaWYgKGtleSkge1xuICAgIHN0cmF0ZWd5ID0gc3RyYXRlZ3kgfHwgJ3ByZXNzS2V5JztcbiAgICBjbWQgPSBgYXUuaGlkZUtleWJvYXJkKCcke3N0cmF0ZWd5fScsICcke2tleX0nKWA7XG4gIH0gZWxzZSB7XG4gICAgc3RyYXRlZ3kgPSBzdHJhdGVneSB8fCAnZGVmYXVsdCc7XG4gICAgY21kID0gYGF1LmhpZGVLZXlib2FyZCgnJHtzdHJhdGVneX0nKWA7XG4gIH1cbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY21kKTtcbn07XG5cbmNvbW1hbmRzLmdldFBhZ2VTb3VyY2UgPSBhc3luYyBmdW5jdGlvbiBnZXRQYWdlU291cmNlICgpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBjb25zdCBzY3JpcHQgPSAncmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5vdXRlckhUTUwnO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdleGVjdXRlX3NjcmlwdCcsIFtzY3JpcHQsIFtdXSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0TmF0aXZlUGFnZVNvdXJjZSgpO1xuICB9XG59O1xuXG5oZWxwZXJzLmdldE5hdGl2ZVBhZ2VTb3VyY2UgPSBhc3luYyBmdW5jdGlvbiBnZXROYXRpdmVQYWdlU291cmNlICgpIHtcbiAgbGV0IGpzb25Tb3VyY2UgPSBhd2FpdCB0aGlzLmdldFNvdXJjZUZvckVsZW1lbnRGb3JYTUwoKTtcbiAgaWYgKHR5cGVvZiBqc29uU291cmNlID09PSAnc3RyaW5nJykge1xuICAgIGpzb25Tb3VyY2UgPSBKU09OLnBhcnNlKGpzb25Tb3VyY2UpO1xuICB9XG4gIGxldCB4bWxTb3VyY2UgPSBqczJ4bWwoJ0FwcGl1bUFVVCcsIGpzb25Tb3VyY2UsIHtcbiAgICB3cmFwQXJyYXk6IHtlbmFibGVkOiBmYWxzZSwgZWxlbWVudE5hbWU6ICdlbGVtZW50J30sXG4gICAgZGVjbGFyYXRpb246IHtpbmNsdWRlOiB0cnVlfSxcbiAgICBwcmV0dHlQcmludGluZzoge2luZGVudFN0cmluZzogJyAgICAnfVxuICB9KTtcbiAgcmV0dXJuIHhtbFNvdXJjZTtcbn07XG5cbmNvbW1hbmRzLmJhY2tncm91bmQgPSBhc3luYyBmdW5jdGlvbiBiYWNrZ3JvdW5kIChzZWNzKSB7XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGBhdS5iYWNrZ3JvdW5kKCR7c2Vjc30pYCk7XG59O1xuXG5jb21tYW5kcy5sb2NrID0gYXN5bmMgZnVuY3Rpb24gbG9jayAoc2Vjcykge1xuICBpZiAoIXNlY3MpIHtcbiAgICBsb2cuZGVidWcoJ05vIHNlY29uZHMgcGFyYW1ldGVyLiBVc2luZyAwIHNlY29uZHMnKTtcbiAgICBzZWNzID0gMDtcbiAgfVxuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgYXUubG9jaygke3NlY3N9KWApO1xufTtcblxuY29tbWFuZHMuY2xvc2VBcHAgPSBhc3luYyBmdW5jdGlvbiBjbG9zZUFwcCAoKSB7XG4gIGxldCBhcHBOYW1lID0gdGhpcy5vcHRzLmFwcCB8fCB0aGlzLm9wdHMuYnVuZGxlSWQ7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5zdG9wKCk7XG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBjbG9zZWQgdGhlICcke2FwcE5hbWV9JyBhcHAuYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBTb21ldGhpbmcgd2VudCB3cm9uZyB3aGlsZSBjbG9zaW5nIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuY29tbWFuZHMubGF1bmNoQXBwID0gYXN5bmMgZnVuY3Rpb24gbGF1bmNoQXBwICgpIHtcbiAgbGV0IGFwcE5hbWUgPSB0aGlzLm9wdHMuYXBwIHx8IHRoaXMub3B0cy5idW5kbGVJZDtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLnN0YXJ0KCk7XG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBsYXVuY2hlZCB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFNvbWV0aGluZyB3ZW50IHdyb25nIHdoaWxlIGxhdW5jaGluZyB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIHJlbW92ZUFwcCAoYnVuZGxlSWQpIHtcbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBhd2FpdCB0aGlzLnJlYWxEZXZpY2UucmVtb3ZlKGJ1bmRsZUlkKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCB0aGlzLnNpbS5yZW1vdmVBcHAoYnVuZGxlSWQpO1xuICB9XG59O1xuXG5jb21tYW5kcy5rZXlzID0gYXN5bmMgZnVuY3Rpb24ga2V5cyAoa2V5cykge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBlbCA9IGF3YWl0IHRoaXMuYWN0aXZlKCk7XG4gICAgaWYgKF8uaXNVbmRlZmluZWQoZWwuRUxFTUVOVCkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMuc2V0VmFsdWUoa2V5cywgZWwuRUxFTUVOVCk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKF8uaXNBcnJheShrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMuam9pbignJyk7XG4gICAgfVxuICAgIGlmICghXy5pc1N0cmluZyhrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMudG9TdHJpbmcoKTtcbiAgICB9XG4gICAga2V5cyA9IHV0aWwuZXNjYXBlU3BlY2lhbENoYXJzKGtleXMsIFwiJ1wiKTtcbiAgICBsZXQgY29tbWFuZCA9IGBhdS5zZW5kS2V5c1RvQWN0aXZlRWxlbWVudCgnJHtrZXlzfScpYDtcbiAgICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgfVxufTtcblxuY29tbWFuZHMuc2V0R2VvTG9jYXRpb24gPSBhc3luYyBmdW5jdGlvbiBzZXRHZW9Mb2NhdGlvbiAobG9jYXRpb24pIHtcbiAgLy8gVE9ETzogY2hlY2sgdGhlIGhhc09wdGlvbnMgYml0LCB0aGUgbWV0aG9kIHNpZ25hdHVyZSBzaG91bGQgYmUgbG9jYXRpb24sIG9wdGlvblxuXG4gIC8vIGxldCBoYXNPcHRpb25zID0gYWx0aXR1ZGUgIT09IG51bGwgfHwgaG9yaXpvbnRhbEFjY3VyYWN5ICE9PSBudWxsIHx8IHZlcnRpY2FsQWNjdXJhY3kgIT09IG51bGwgfHwgY291cnNlICE9PSBudWxsIHx8IHNwZWVkICE9PSBudWxsO1xuICAvLyBpZiAoaGFzT3B0aW9ucykge1xuICAvLyAgIGxldCBvcHRpb25zID0ge307XG4gIC8vICAgaWYgKGFsdGl0dWRlICE9PSBudWxsKSB7XG4gIC8vICAgICBvcHRpb25zLmFsdGl0dWRlID0gYWx0aXR1ZGU7XG4gIC8vICAgfVxuICAvLyAgIGlmIChob3Jpem9udGFsQWNjdXJhY3kgIT09IG51bGwpIHtcbiAgLy8gICAgIG9wdGlvbnMuaG9yaXpvbnRhbEFjY3VyYWN5ID0gaG9yaXpvbnRhbEFjY3VyYWN5O1xuICAvLyAgIH1cbiAgLy8gICBpZiAodmVydGljYWxBY2N1cmFjeSAhPT0gbnVsbCkge1xuICAvLyAgICAgb3B0aW9ucy52ZXJ0aWNhbEFjY3VyYWN5ID0gdmVydGljYWxBY2N1cmFjeTtcbiAgLy8gICB9XG4gIC8vICAgaWYgKGNvdXJzZSAhPT0gbnVsbCkge1xuICAvLyAgICAgb3B0aW9ucy5jb3Vyc2UgPSBjb3Vyc2U7XG4gIC8vICAgfVxuICAvLyAgIGlmIChzcGVlZCAhPT0gbnVsbCkge1xuICAvLyAgICAgb3B0aW9ucy5zcGVlZCA9IHNwZWVkO1xuICAvLyAgIH1cbiAgLy8gICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChcbiAgLy8gICAgIGB0YXJnZXQuc2V0TG9jYXRpb25XaXRoT3B0aW9ucygke0pTT04uc3RyaW5naWZ5KGNvb3JkaW5hdGVzKX0sICR7SlNPTi5zdHJpbmdpZnkob3B0aW9ucyl9KWApO1xuICAvLyB9IGVsc2Uge1xuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgdGFyZ2V0LnNldExvY2F0aW9uKCR7SlNPTi5zdHJpbmdpZnkobG9jYXRpb24pfSlgKTtcbiAgLy8gfVxufTtcblxuY29tbWFuZHMuZ2V0V2luZG93U2l6ZSA9IGFzeW5jIGZ1bmN0aW9uIGdldFdpbmRvd1NpemUgKHdpbmRvd0hhbmRsZSA9ICdjdXJyZW50Jykge1xuICBpZiAod2luZG93SGFuZGxlICE9PSAnY3VycmVudCcpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoJ0N1cnJlbnRseSBvbmx5IGdldHRpbmcgY3VycmVudCB3aW5kb3cgc2l6ZSBpcyBzdXBwb3J0ZWQuJyk7XG4gIH1cblxuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfd2luZG93X3NpemUnLCBbXSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKCdhdS5nZXRXaW5kb3dTaXplKCknKTtcbiAgfVxufTtcblxuLy8gRm9yIFczQ1xuY29tbWFuZHMuZ2V0V2luZG93UmVjdCA9IGFzeW5jIGZ1bmN0aW9uIGdldFdpbmRvd1JlY3QgKCkge1xuICBjb25zdCB7d2lkdGgsIGhlaWdodH0gPSBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemUoKTtcbiAgcmV0dXJuIHtcbiAgICB3aWR0aCxcbiAgICBoZWlnaHQsXG4gICAgeDogMCxcbiAgICB5OiAwXG4gIH07XG59O1xuXG5jb21tYW5kcy5nZXRTdHJpbmdzID0gYXN5bmMgZnVuY3Rpb24gZ2V0U3RyaW5ncyAobGFuZ3VhZ2UsIHN0cmluZ0ZpbGUgPSBudWxsKSB7XG4gIGxvZy5kZWJ1ZyhgR2V0dGluZ3Mgc3RyaW5ncyBmb3IgbGFuZ3VhZ2UgJyR7bGFuZ3VhZ2V9JyBhbmQgc3RyaW5nIGZpbGUgJyR7c3RyaW5nRmlsZX0nYCk7XG4gIHJldHVybiBhd2FpdCB1dGlscy5wYXJzZUxvY2FsaXphYmxlU3RyaW5ncyhPYmplY3QuYXNzaWduKHt9LCB0aGlzLm9wdHMsIHtcbiAgICBsYW5ndWFnZSxcbiAgICBzdHJpbmdGaWxlLFxuICAgIHN0cmljdE1vZGU6IHRydWUsXG4gIH0pKTtcbn07XG5cbmNvbW1hbmRzLnNldFVybCA9IGFzeW5jIGZ1bmN0aW9uIHNldFVybCAodXJsKSB7XG4gIGxvZy5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBzZXQgdXJsICcke3VybH0nYCk7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhpcy5zZXRDdXJyZW50VXJsKHVybCk7XG4gICAgLy8gbWFrZSBzdXJlIHRvIGNsZWFyIG91dCBhbnkgbGVmdG92ZXIgd2ViIGZyYW1lc1xuICAgIHRoaXMuY3VyV2ViRnJhbWVzID0gW107XG4gICAgYXdhaXQgdGhpcy5yZW1vdGUubmF2VG9VcmwodXJsKTtcbiAgfSBlbHNlIGlmICh0aGlzLnNpbSkge1xuICAgIGF3YWl0IHRoaXMuc2ltLnNpbWN0bC5vcGVuVXJsKHVybCk7XG4gIH0gZWxzZSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coJ09wZW5pbmcgVVJMcyBvbiByZWFsIGRldmljZXMgaXMgbm90IHN1cHBvcnRlZCcpO1xuICB9XG59O1xuXG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
