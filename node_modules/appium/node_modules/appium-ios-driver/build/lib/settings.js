"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setLocale = setLocale;
exports.setPreferences = setPreferences;
exports.setLocaleAndPreferences = setLocaleAndPreferences;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

const SETTINGS_CAPS = ['locationServicesEnabled', 'locationServicesAuthorized'];
const SAFARI_SETTINGS_CAPS = ['safariAllowPopups', 'safariIgnoreFraudWarning', 'safariOpenLinksInBackground'];

async function launchAndQuitSimulator(sim, opts = {}) {
  _logger.default.debug('No simulator directories found.');

  const {
    safari,
    timeout
  } = opts;
  return timeout ? await sim.launchAndQuit(safari, timeout) : await sim.launchAndQuit(safari);
}

function checkPreferences(settings, opts = {}) {
  for (let setting of settings) {
    if (_lodash.default.has(opts, setting)) {
      return true;
    }
  }

  return false;
}

async function setLocaleAndPreferences(sim, opts, safari = false, shutdownFn = _lodash.default.noop) {
  const localConfig = await setLocale(sim, opts, {}, safari);
  const prefsUpdated = await setPreferences(sim, opts, safari);

  if (localConfig._updated || prefsUpdated) {
    _logger.default.debug('Updated settings. Rebooting the simulator if it is already open');

    await shutdownFn(sim);
  } else {
    _logger.default.debug('Setting did not need to be updated');
  }

  delete localConfig._updated;
  return localConfig;
}

async function setLocale(sim, opts, localeConfig = {}, safari = false) {
  if (!opts.language && !opts.locale && !opts.calendarFormat) {
    _logger.default.debug('No reason to set locale');

    return {
      _updated: false
    };
  }

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, {
      safari,
      timeout: opts.simulatorStartupTimeout
    });
  }

  _logger.default.debug('Setting locale information');

  localeConfig = {
    language: opts.language || localeConfig.language,
    locale: opts.locale || localeConfig.locale,
    calendarFormat: opts.calendarFormat || localeConfig.calendarFormat,
    _updated: false
  };

  try {
    let updated = await sim.updateLocale(opts.language, opts.locale, opts.calendarFormat);

    if (updated) {
      localeConfig._updated = true;
    }
  } catch (e) {
    _logger.default.errorAndThrow(`Appium was unable to set locale info: ${e}`);
  }

  return localeConfig;
}

async function setPreferences(sim, opts, safari = false) {
  let needToSetPrefs = checkPreferences(SETTINGS_CAPS, opts);
  let needToSetSafariPrefs = checkPreferences(SAFARI_SETTINGS_CAPS, opts);

  if (!needToSetPrefs && !needToSetSafariPrefs) {
    _logger.default.debug('No iOS / app preferences to set');

    return false;
  }

  _logger.default.debug('Setting iOS and app preferences');

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, {
      safari,
      timeout: opts.simulatorStartupTimeout
    });
  }

  let updated = false;

  try {
    if (needToSetPrefs) {
      updated = await setLocServicesPrefs(sim, opts);
    }
  } catch (e) {
    _logger.default.error('Error setting location services preferences, prefs will not work');

    _logger.default.error(e);
  }

  try {
    if (needToSetSafariPrefs) {
      updated = (await setSafariPrefs(sim, opts)) || updated;
    }
  } catch (e) {
    _logger.default.error('Error setting safari preferences, prefs will not work');

    _logger.default.error(e);
  }

  return updated;
}

async function setLocServicesPrefs(sim, opts = {}) {
  let locServ = _lodash.default.find([opts.locationServicesEnabled, opts.locationServicesAuthorized], c => !_lodash.default.isUndefined(c));

  if (!_lodash.default.isUndefined(locServ)) {
    locServ = locServ ? 1 : 0;

    _logger.default.debug(`Setting location services to ${locServ}`);

    await sim.updateSettings('locationServices', {
      LocationServicesEnabled: locServ,
      'LocationServicesEnabledIn7.0': locServ,
      'LocationServicesEnabledIn8.0': locServ
    });
  }

  if (!_lodash.default.isUndefined(opts.locationServicesAuthorized)) {
    if (!opts.bundleId) {
      let msg = "Can't set location services for app without bundle ID";

      _logger.default.errorAndThrow(msg);
    }

    let locAuth = !!opts.locationServicesAuthorized;

    if (locAuth) {
      _logger.default.debug('Authorizing location services for app');
    } else {
      _logger.default.debug('De-authorizing location services for app');
    }

    await sim.updateLocationSettings(opts.bundleId, locAuth);
  }
}

async function setSafariPrefs(sim, opts = {}) {
  let safariSettings = {};

  if (_lodash.default.has(opts, 'safariAllowPopups')) {
    const val = !!opts.safariAllowPopups;

    _logger.default.debug(`Setting javascript window opening to '${val}'`);

    safariSettings.WebKitJavaScriptCanOpenWindowsAutomatically = val;
    safariSettings.JavaScriptCanOpenWindowsAutomatically = val;
  }

  if (_lodash.default.has(opts, 'safariIgnoreFraudWarning')) {
    const val = !opts.safariIgnoreFraudWarning;

    _logger.default.debug(`Setting fraudulent website warning to '${val}'`);

    safariSettings.WarnAboutFraudulentWebsites = val;
  }

  if (_lodash.default.has(opts, 'safariOpenLinksInBackground')) {
    const val = opts.safariOpenLinksInBackground ? 1 : 0;

    _logger.default.debug(`Setting opening links in background to '${!!val}'`);

    safariSettings.OpenLinksInBackground = val;
  }

  return _lodash.default.size(safariSettings) > 0 ? await sim.updateSafariSettings(safariSettings) : false;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZXR0aW5ncy5qcyJdLCJuYW1lcyI6WyJTRVRUSU5HU19DQVBTIiwiU0FGQVJJX1NFVFRJTkdTX0NBUFMiLCJsYXVuY2hBbmRRdWl0U2ltdWxhdG9yIiwic2ltIiwib3B0cyIsImxvZ2dlciIsImRlYnVnIiwic2FmYXJpIiwidGltZW91dCIsImxhdW5jaEFuZFF1aXQiLCJjaGVja1ByZWZlcmVuY2VzIiwic2V0dGluZ3MiLCJzZXR0aW5nIiwiXyIsImhhcyIsInNldExvY2FsZUFuZFByZWZlcmVuY2VzIiwic2h1dGRvd25GbiIsIm5vb3AiLCJsb2NhbENvbmZpZyIsInNldExvY2FsZSIsInByZWZzVXBkYXRlZCIsInNldFByZWZlcmVuY2VzIiwiX3VwZGF0ZWQiLCJsb2NhbGVDb25maWciLCJsYW5ndWFnZSIsImxvY2FsZSIsImNhbGVuZGFyRm9ybWF0IiwiaXNGcmVzaCIsInNpbXVsYXRvclN0YXJ0dXBUaW1lb3V0IiwidXBkYXRlZCIsInVwZGF0ZUxvY2FsZSIsImUiLCJlcnJvckFuZFRocm93IiwibmVlZFRvU2V0UHJlZnMiLCJuZWVkVG9TZXRTYWZhcmlQcmVmcyIsInNldExvY1NlcnZpY2VzUHJlZnMiLCJlcnJvciIsInNldFNhZmFyaVByZWZzIiwibG9jU2VydiIsImZpbmQiLCJsb2NhdGlvblNlcnZpY2VzRW5hYmxlZCIsImxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkIiwiYyIsImlzVW5kZWZpbmVkIiwidXBkYXRlU2V0dGluZ3MiLCJMb2NhdGlvblNlcnZpY2VzRW5hYmxlZCIsImJ1bmRsZUlkIiwibXNnIiwibG9jQXV0aCIsInVwZGF0ZUxvY2F0aW9uU2V0dGluZ3MiLCJzYWZhcmlTZXR0aW5ncyIsInZhbCIsInNhZmFyaUFsbG93UG9wdXBzIiwiV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSIsIkphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkiLCJzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmciLCJXYXJuQWJvdXRGcmF1ZHVsZW50V2Vic2l0ZXMiLCJzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQiLCJPcGVuTGlua3NJbkJhY2tncm91bmQiLCJzaXplIiwidXBkYXRlU2FmYXJpU2V0dGluZ3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFHQSxNQUFNQSxhQUFhLEdBQUcsQ0FDcEIseUJBRG9CLEVBRXBCLDRCQUZvQixDQUF0QjtBQUlBLE1BQU1DLG9CQUFvQixHQUFHLENBQzNCLG1CQUQyQixFQUUzQiwwQkFGMkIsRUFHM0IsNkJBSDJCLENBQTdCOztBQU1BLGVBQWVDLHNCQUFmLENBQXVDQyxHQUF2QyxFQUE0Q0MsSUFBSSxHQUFHLEVBQW5ELEVBQXVEO0FBQ3JEQyxrQkFBT0MsS0FBUCxDQUFhLGlDQUFiOztBQUNBLFFBQU07QUFBRUMsSUFBQUEsTUFBRjtBQUFVQyxJQUFBQTtBQUFWLE1BQXNCSixJQUE1QjtBQUNBLFNBQU9JLE9BQU8sR0FDVixNQUFNTCxHQUFHLENBQUNNLGFBQUosQ0FBa0JGLE1BQWxCLEVBQTBCQyxPQUExQixDQURJLEdBRVYsTUFBTUwsR0FBRyxDQUFDTSxhQUFKLENBQWtCRixNQUFsQixDQUZWO0FBR0Q7O0FBRUQsU0FBU0csZ0JBQVQsQ0FBMkJDLFFBQTNCLEVBQXFDUCxJQUFJLEdBQUcsRUFBNUMsRUFBZ0Q7QUFDOUMsT0FBSyxJQUFJUSxPQUFULElBQW9CRCxRQUFwQixFQUE4QjtBQUM1QixRQUFJRSxnQkFBRUMsR0FBRixDQUFNVixJQUFOLEVBQVlRLE9BQVosQ0FBSixFQUEwQjtBQUN4QixhQUFPLElBQVA7QUFDRDtBQUNGOztBQUNELFNBQU8sS0FBUDtBQUNEOztBQUVELGVBQWVHLHVCQUFmLENBQXdDWixHQUF4QyxFQUE2Q0MsSUFBN0MsRUFBbURHLE1BQU0sR0FBRyxLQUE1RCxFQUFtRVMsVUFBVSxHQUFHSCxnQkFBRUksSUFBbEYsRUFBd0Y7QUFDdEYsUUFBTUMsV0FBVyxHQUFHLE1BQU1DLFNBQVMsQ0FBQ2hC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LEVBQVksMEJBQVosQ0FBSixFQUE2QztBQUMzQyxVQUFNK0MsR0FBRyxHQUFHLENBQUMvQyxJQUFJLENBQUNtRCx3QkFBbEI7O0FBQ0FsRCxvQkFBT0MsS0FBUCxDQUFjLDBDQUF5QzZDLEdBQUksR0FBM0Q7O0FBQ0FELElBQUFBLGNBQWMsQ0FBQ00sMkJBQWYsR0FBNkNMLEdBQTdDO0FBQ0Q7O0FBQ0QsTUFBSXRDLGdCQUFFQyxHQUFGLENBQU1WLElBQU4sRUFBWSw2QkFBWixDQUFKLEVBQWdEO0FBQzlDLFVBQU0rQyxHQUFHLEdBQUcvQyxJQUFJLENBQUNxRCwyQkFBTCxHQUFtQyxDQUFuQyxHQUF1QyxDQUFuRDs7QUFDQXBELG9CQUFPQyxLQUFQLENBQWMsMkNBQTBDLENBQUMsQ0FBQzZDLEdBQUksR0FBOUQ7O0FBQ0FELElBQUFBLGNBQWMsQ0FBQ1EscUJBQWYsR0FBdUNQLEdBQXZDO0FBQ0Q7O0FBQ0QsU0FBUXRDLGdCQUFFOEMsSUFBRixDQUFPVCxjQUFQLElBQXlCLENBQTFCLEdBQ0gsTUFBTS9DLEdBQUcsQ0FBQ3lELG9CQUFKLENBQXlCVixjQUF6QixDQURILEdBRUgsS0FGSjtBQUdEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuXG5cbmNvbnN0IFNFVFRJTkdTX0NBUFMgPSBbXG4gICdsb2NhdGlvblNlcnZpY2VzRW5hYmxlZCcsXG4gICdsb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZCcsXG5dO1xuY29uc3QgU0FGQVJJX1NFVFRJTkdTX0NBUFMgPSBbXG4gICdzYWZhcmlBbGxvd1BvcHVwcycsXG4gICdzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmcnLFxuICAnc2FmYXJpT3BlbkxpbmtzSW5CYWNrZ3JvdW5kJyxcbl07XG5cbmFzeW5jIGZ1bmN0aW9uIGxhdW5jaEFuZFF1aXRTaW11bGF0b3IgKHNpbSwgb3B0cyA9IHt9KSB7XG4gIGxvZ2dlci5kZWJ1ZygnTm8gc2ltdWxhdG9yIGRpcmVjdG9yaWVzIGZvdW5kLicpO1xuICBjb25zdCB7IHNhZmFyaSwgdGltZW91dCB9ID0gb3B0cztcbiAgcmV0dXJuIHRpbWVvdXRcbiAgICA/IGF3YWl0IHNpbS5sYXVuY2hBbmRRdWl0KHNhZmFyaSwgdGltZW91dClcbiAgICA6IGF3YWl0IHNpbS5sYXVuY2hBbmRRdWl0KHNhZmFyaSk7XG59XG5cbmZ1bmN0aW9uIGNoZWNrUHJlZmVyZW5jZXMgKHNldHRpbmdzLCBvcHRzID0ge30pIHtcbiAgZm9yIChsZXQgc2V0dGluZyBvZiBzZXR0aW5ncykge1xuICAgIGlmIChfLmhhcyhvcHRzLCBzZXR0aW5nKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0TG9jYWxlQW5kUHJlZmVyZW5jZXMgKHNpbSwgb3B0cywgc2FmYXJpID0gZmFsc2UsIHNodXRkb3duRm4gPSBfLm5vb3ApIHtcbiAgY29uc3QgbG9jYWxDb25maWcgPSBhd2FpdCBzZXRMb2NhbGUoc2ltLCBvcHRzLCB7fSwgc2FmYXJpKTtcbiAgY29uc3QgcHJlZnNVcGRhdGVkID0gYXdhaXQgc2V0UHJlZmVyZW5jZXMoc2ltLCBvcHRzLCBzYWZhcmkpO1xuICBpZiAobG9jYWxDb25maWcuX3VwZGF0ZWQgfHwgcHJlZnNVcGRhdGVkKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdVcGRhdGVkIHNldHRpbmdzLiBSZWJvb3RpbmcgdGhlIHNpbXVsYXRvciBpZiBpdCBpcyBhbHJlYWR5IG9wZW4nKTtcbiAgICBhd2FpdCBzaHV0ZG93bkZuKHNpbSk7XG4gIH0gZWxzZSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdTZXR0aW5nIGRpZCBub3QgbmVlZCB0byBiZSB1cGRhdGVkJyk7XG4gIH1cbiAgZGVsZXRlIGxvY2FsQ29uZmlnLl91cGRhdGVkO1xuICByZXR1cm4gbG9jYWxDb25maWc7XG59XG5cbi8vIHBhc3MgaW4gdGhlIHNpbXVsYXRvciBzbyB0aGF0IG90aGVyIHN5c3RlbXMgdGhhdCB1c2UgdGhlIGZ1bmN0aW9uIGNhbiBzdXBwbHlcbi8vIHdoYXRldmVyIHRoZXkgaGF2ZVxuYXN5bmMgZnVuY3Rpb24gc2V0TG9jYWxlIChzaW0sIG9wdHMsIGxvY2FsZUNvbmZpZyA9IHt9LCBzYWZhcmkgPSBmYWxzZSkge1xuICBpZiAoIW9wdHMubGFuZ3VhZ2UgJiYgIW9wdHMubG9jYWxlICYmICFvcHRzLmNhbGVuZGFyRm9ybWF0KSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdObyByZWFzb24gdG8gc2V0IGxvY2FsZScpO1xuICAgIHJldHVybiB7XG4gICAgICBfdXBkYXRlZDogZmFsc2UsXG4gICAgfTtcbiAgfVxuXG4gIC8vIHdlIG5lZWQgdGhlIHNpbXVsYXRvciB0byBoYXZlIGl0cyBkaXJlY3RvcmllcyBpbiBwbGFjZVxuICBpZiAoYXdhaXQgc2ltLmlzRnJlc2goKSkge1xuICAgIGF3YWl0IGxhdW5jaEFuZFF1aXRTaW11bGF0b3Ioc2ltLCB7XG4gICAgICBzYWZhcmksXG4gICAgICB0aW1lb3V0OiBvcHRzLnNpbXVsYXRvclN0YXJ0dXBUaW1lb3V0LFxuICAgIH0pO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKCdTZXR0aW5nIGxvY2FsZSBpbmZvcm1hdGlvbicpO1xuICBsb2NhbGVDb25maWcgPSB7XG4gICAgbGFuZ3VhZ2U6IG9wdHMubGFuZ3VhZ2UgfHwgbG9jYWxlQ29uZmlnLmxhbmd1YWdlLFxuICAgIGxvY2FsZTogb3B0cy5sb2NhbGUgfHwgbG9jYWxlQ29uZmlnLmxvY2FsZSxcbiAgICBjYWxlbmRhckZvcm1hdDogb3B0cy5jYWxlbmRhckZvcm1hdCB8fCBsb2NhbGVDb25maWcuY2FsZW5kYXJGb3JtYXQsXG4gICAgX3VwZGF0ZWQ6IGZhbHNlLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgbGV0IHVwZGF0ZWQgPSBhd2FpdCBzaW0udXBkYXRlTG9jYWxlKG9wdHMubGFuZ3VhZ2UsIG9wdHMubG9jYWxlLCBvcHRzLmNhbGVuZGFyRm9ybWF0KTtcbiAgICBpZiAodXBkYXRlZCkge1xuICAgICAgbG9jYWxlQ29uZmlnLl91cGRhdGVkID0gdHJ1ZTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgQXBwaXVtIHdhcyB1bmFibGUgdG8gc2V0IGxvY2FsZSBpbmZvOiAke2V9YCk7XG4gIH1cblxuICByZXR1cm4gbG9jYWxlQ29uZmlnO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRQcmVmZXJlbmNlcyAoc2ltLCBvcHRzLCBzYWZhcmkgPSBmYWxzZSkge1xuICBsZXQgbmVlZFRvU2V0UHJlZnMgPSBjaGVja1ByZWZlcmVuY2VzKFNFVFRJTkdTX0NBUFMsIG9wdHMpO1xuICBsZXQgbmVlZFRvU2V0U2FmYXJpUHJlZnMgPSBjaGVja1ByZWZlcmVuY2VzKFNBRkFSSV9TRVRUSU5HU19DQVBTLCBvcHRzKTtcbiAgaWYgKCFuZWVkVG9TZXRQcmVmcyAmJiAhbmVlZFRvU2V0U2FmYXJpUHJlZnMpIHtcbiAgICBsb2dnZXIuZGVidWcoJ05vIGlPUyAvIGFwcCBwcmVmZXJlbmNlcyB0byBzZXQnKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBsb2dnZXIuZGVidWcoJ1NldHRpbmcgaU9TIGFuZCBhcHAgcHJlZmVyZW5jZXMnKTtcblxuICBpZiAoYXdhaXQgc2ltLmlzRnJlc2goKSkge1xuICAgIGF3YWl0IGxhdW5jaEFuZFF1aXRTaW11bGF0b3Ioc2ltLCB7XG4gICAgICBzYWZhcmksXG4gICAgICB0aW1lb3V0OiBvcHRzLnNpbXVsYXRvclN0YXJ0dXBUaW1lb3V0LFxuICAgIH0pO1xuICB9XG5cbiAgbGV0IHVwZGF0ZWQgPSBmYWxzZTtcbiAgdHJ5IHtcbiAgICBpZiAobmVlZFRvU2V0UHJlZnMpIHtcbiAgICAgIHVwZGF0ZWQgPSBhd2FpdCBzZXRMb2NTZXJ2aWNlc1ByZWZzKHNpbSwgb3B0cyk7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nZ2VyLmVycm9yKCdFcnJvciBzZXR0aW5nIGxvY2F0aW9uIHNlcnZpY2VzIHByZWZlcmVuY2VzLCBwcmVmcyB3aWxsIG5vdCB3b3JrJyk7XG4gICAgbG9nZ2VyLmVycm9yKGUpO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBpZiAobmVlZFRvU2V0U2FmYXJpUHJlZnMpIHtcbiAgICAgIHVwZGF0ZWQgPSBhd2FpdCBzZXRTYWZhcmlQcmVmcyhzaW0sIG9wdHMpIHx8IHVwZGF0ZWQ7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nZ2VyLmVycm9yKCdFcnJvciBzZXR0aW5nIHNhZmFyaSBwcmVmZXJlbmNlcywgcHJlZnMgd2lsbCBub3Qgd29yaycpO1xuICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgfVxuXG4gIHJldHVybiB1cGRhdGVkO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRMb2NTZXJ2aWNlc1ByZWZzIChzaW0sIG9wdHMgPSB7fSkge1xuICBsZXQgbG9jU2VydiA9IF8uZmluZChbb3B0cy5sb2NhdGlvblNlcnZpY2VzRW5hYmxlZCwgb3B0cy5sb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZF0sIChjKSA9PiAhXy5pc1VuZGVmaW5lZChjKSk7XG4gIGlmICghXy5pc1VuZGVmaW5lZChsb2NTZXJ2KSkge1xuICAgIGxvY1NlcnYgPSBsb2NTZXJ2ID8gMSA6IDA7XG4gICAgbG9nZ2VyLmRlYnVnKGBTZXR0aW5nIGxvY2F0aW9uIHNlcnZpY2VzIHRvICR7bG9jU2Vydn1gKTtcbiAgICBhd2FpdCBzaW0udXBkYXRlU2V0dGluZ3MoJ2xvY2F0aW9uU2VydmljZXMnLCB7XG4gICAgICBMb2NhdGlvblNlcnZpY2VzRW5hYmxlZDogbG9jU2VydixcbiAgICAgICdMb2NhdGlvblNlcnZpY2VzRW5hYmxlZEluNy4wJzogbG9jU2VydixcbiAgICAgICdMb2NhdGlvblNlcnZpY2VzRW5hYmxlZEluOC4wJzogbG9jU2VydlxuICAgIH0pO1xuICB9XG4gIGlmICghXy5pc1VuZGVmaW5lZChvcHRzLmxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkKSkge1xuICAgIGlmICghb3B0cy5idW5kbGVJZCkge1xuICAgICAgbGV0IG1zZyA9IFwiQ2FuJ3Qgc2V0IGxvY2F0aW9uIHNlcnZpY2VzIGZvciBhcHAgd2l0aG91dCBidW5kbGUgSURcIjtcbiAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgfVxuICAgIGxldCBsb2NBdXRoID0gISFvcHRzLmxvY2F0aW9uU2VydmljZXNBdXRob3JpemVkO1xuICAgIGlmIChsb2NBdXRoKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0F1dGhvcml6aW5nIGxvY2F0aW9uIHNlcnZpY2VzIGZvciBhcHAnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdEZS1hdXRob3JpemluZyBsb2NhdGlvbiBzZXJ2aWNlcyBmb3IgYXBwJyk7XG4gICAgfVxuICAgIGF3YWl0IHNpbS51cGRhdGVMb2NhdGlvblNldHRpbmdzKG9wdHMuYnVuZGxlSWQsIGxvY0F1dGgpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFNhZmFyaVByZWZzIChzaW0sIG9wdHMgPSB7fSkge1xuICBsZXQgc2FmYXJpU2V0dGluZ3MgPSB7fTtcblxuICBpZiAoXy5oYXMob3B0cywgJ3NhZmFyaUFsbG93UG9wdXBzJykpIHtcbiAgICBjb25zdCB2YWwgPSAhIW9wdHMuc2FmYXJpQWxsb3dQb3B1cHM7XG4gICAgbG9nZ2VyLmRlYnVnKGBTZXR0aW5nIGphdmFzY3JpcHQgd2luZG93IG9wZW5pbmcgdG8gJyR7dmFsfSdgKTtcbiAgICBzYWZhcmlTZXR0aW5ncy5XZWJLaXRKYXZhU2NyaXB0Q2FuT3BlbldpbmRvd3NBdXRvbWF0aWNhbGx5ID0gdmFsO1xuICAgIHNhZmFyaVNldHRpbmdzLkphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkgPSB2YWw7XG4gIH1cbiAgaWYgKF8uaGFzKG9wdHMsICdzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmcnKSkge1xuICAgIGNvbnN0IHZhbCA9ICFvcHRzLnNhZmFyaUlnbm9yZUZyYXVkV2FybmluZztcbiAgICBsb2dnZXIuZGVidWcoYFNldHRpbmcgZnJhdWR1bGVudCB3ZWJzaXRlIHdhcm5pbmcgdG8gJyR7dmFsfSdgKTtcbiAgICBzYWZhcmlTZXR0aW5ncy5XYXJuQWJvdXRGcmF1ZHVsZW50V2Vic2l0ZXMgPSB2YWw7XG4gIH1cbiAgaWYgKF8uaGFzKG9wdHMsICdzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQnKSkge1xuICAgIGNvbnN0IHZhbCA9IG9wdHMuc2FmYXJpT3BlbkxpbmtzSW5CYWNrZ3JvdW5kID8gMSA6IDA7XG4gICAgbG9nZ2VyLmRlYnVnKGBTZXR0aW5nIG9wZW5pbmcgbGlua3MgaW4gYmFja2dyb3VuZCB0byAnJHshIXZhbH0nYCk7XG4gICAgc2FmYXJpU2V0dGluZ3MuT3BlbkxpbmtzSW5CYWNrZ3JvdW5kID0gdmFsO1xuICB9XG4gIHJldHVybiAoXy5zaXplKHNhZmFyaVNldHRpbmdzKSA+IDApXG4gICAgPyBhd2FpdCBzaW0udXBkYXRlU2FmYXJpU2V0dGluZ3Moc2FmYXJpU2V0dGluZ3MpXG4gICAgOiBmYWxzZTtcbn1cblxuZXhwb3J0IHsgc2V0TG9jYWxlLCBzZXRQcmVmZXJlbmNlcywgc2V0TG9jYWxlQW5kUHJlZmVyZW5jZXMgfTtcbiJdLCJmaWxlIjoibGliL3NldHRpbmdzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
