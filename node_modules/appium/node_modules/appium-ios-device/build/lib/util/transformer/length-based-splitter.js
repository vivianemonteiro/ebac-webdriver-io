"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.LengthBasedSplitter = void 0;

require("source-map-support/register");

var _stream = _interopRequireDefault(require("stream"));

var _logger = _interopRequireDefault(require("../../logger"));

class LengthBasedSplitter extends _stream.default.Transform {
  constructor(opts) {
    super();
    const {
      readableStream,
      littleEndian,
      maxFrameLength,
      lengthFieldOffset,
      lengthFieldLength,
      lengthAdjustment
    } = opts;
    this.readableStream = readableStream;
    this.littleEndian = littleEndian;
    this.maxFrameLength = maxFrameLength;
    this.lengthFieldOffset = lengthFieldOffset;
    this.lengthFieldLength = lengthFieldLength;
    this.lengthAdjustment = lengthAdjustment;
    this.isShutdown = false;
    this._frameBufferIndex = 0;
    this._frameBuffer = Buffer.allocUnsafeSlow(maxFrameLength);
  }

  _transform(data, encoding, onData) {
    for (let i = 0; i < data.length; i = this._decode(data, i)) {
      if (this.isShutdown) {
        return this._pushBack(i, data.length, data);
      }
    }

    onData();
  }

  _decode(data, pos) {
    let bufferMarker = pos;
    let bytesToRead = Math.max(this.lengthFieldOffset + this.lengthFieldLength - this._frameBufferIndex, 0);
    let nBytesRead = bytesToRead === 0 ? 0 : this._readBytes(data, bufferMarker, this._frameBuffer, this._frameBufferIndex, bytesToRead);
    bufferMarker += nBytesRead;
    this._frameBufferIndex += nBytesRead;

    if (this._frameBufferIndex < this.lengthFieldOffset) {
      return bufferMarker;
    }

    const messageLength = this._readLength(this._frameBuffer, this.lengthFieldOffset, this.littleEndian);

    if (messageLength > this.maxFrameLength) {
      throw new Error(`The frame is bigger than expected. Length: ${messageLength}, max: ${this.maxFrameLength}`);
    }

    const completeMessageLength = messageLength + this.lengthAdjustment + this.lengthFieldOffset;
    bytesToRead = completeMessageLength - this._frameBufferIndex;
    nBytesRead = bytesToRead === 0 ? 0 : this._readBytes(data, bufferMarker, this._frameBuffer, this._frameBufferIndex, bytesToRead);
    bufferMarker += nBytesRead;
    this._frameBufferIndex += nBytesRead;

    if (this._frameBufferIndex < completeMessageLength) {
      return bufferMarker;
    }

    const message = Buffer.allocUnsafe(this._frameBufferIndex);

    this._frameBuffer.copy(message, 0, 0, this._frameBufferIndex);

    this.push(message);

    this._resetBuffers();

    return bufferMarker;
  }

  _readBytes(src, srcIndex, target, targetIndex, nBytesToBeRead) {
    let availableBytes = Math.min(nBytesToBeRead, src.length - srcIndex);
    src.copy(target, targetIndex, srcIndex, srcIndex + availableBytes);
    return availableBytes;
  }

  _resetBuffers() {
    this._frameBufferIndex = 0;
  }

  _pushBack(start, end, data) {
    if (start > end) {
      _logger.default.error('More data was read than the buffer size. This should not happen');
    }

    if (start === end) {
      return;
    }

    const leftover = Buffer.allocUnsafe(end - start);
    data.copy(leftover, 0, start, end);
    process.nextTick(() => this.readableStream.unshift(leftover));
  }

  shutdown() {
    this.isShutdown = true;
  }

  _readLength(data, index, littleEndian) {
    switch (this.lengthFieldLength) {
      case 4:
        return littleEndian ? data.readUInt32LE(index) : data.readUInt32BE(index);

      case 8:
        return littleEndian ? data.readUInt32LE(index) : data.readUInt32BE(index + 4);

      default:
        throw new Error(`${this.lengthFieldLength} is not supported. Only 4 and 8 are supported at the moment`);
    }
  }

}

exports.LengthBasedSplitter = LengthBasedSplitter;
var _default = LengthBasedSplitter;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlsL3RyYW5zZm9ybWVyL2xlbmd0aC1iYXNlZC1zcGxpdHRlci5qcyJdLCJuYW1lcyI6WyJMZW5ndGhCYXNlZFNwbGl0dGVyIiwiU3RyZWFtIiwiVHJhbnNmb3JtIiwiY29uc3RydWN0b3IiLCJvcHRzIiwicmVhZGFibGVTdHJlYW0iLCJsaXR0bGVFbmRpYW4iLCJtYXhGcmFtZUxlbmd0aCIsImxlbmd0aEZpZWxkT2Zmc2V0IiwibGVuZ3RoRmllbGRMZW5ndGgiLCJsZW5ndGhBZGp1c3RtZW50IiwiaXNTaHV0ZG93biIsIl9mcmFtZUJ1ZmZlckluZGV4IiwiX2ZyYW1lQnVmZmVyIiwiQnVmZmVyIiwiYWxsb2NVbnNhZmVTbG93IiwiX3RyYW5zZm9ybSIsImRhdGEiLCJlbmNvZGluZyIsIm9uRGF0YSIsImkiLCJsZW5ndGgiLCJfZGVjb2RlIiwiX3B1c2hCYWNrIiwicG9zIiwiYnVmZmVyTWFya2VyIiwiYnl0ZXNUb1JlYWQiLCJNYXRoIiwibWF4IiwibkJ5dGVzUmVhZCIsIl9yZWFkQnl0ZXMiLCJtZXNzYWdlTGVuZ3RoIiwiX3JlYWRMZW5ndGgiLCJFcnJvciIsImNvbXBsZXRlTWVzc2FnZUxlbmd0aCIsIm1lc3NhZ2UiLCJhbGxvY1Vuc2FmZSIsImNvcHkiLCJwdXNoIiwiX3Jlc2V0QnVmZmVycyIsInNyYyIsInNyY0luZGV4IiwidGFyZ2V0IiwidGFyZ2V0SW5kZXgiLCJuQnl0ZXNUb0JlUmVhZCIsImF2YWlsYWJsZUJ5dGVzIiwibWluIiwic3RhcnQiLCJlbmQiLCJsb2ciLCJlcnJvciIsImxlZnRvdmVyIiwicHJvY2VzcyIsIm5leHRUaWNrIiwidW5zaGlmdCIsInNodXRkb3duIiwiaW5kZXgiLCJyZWFkVUludDMyTEUiLCJyZWFkVUludDMyQkUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUEsTUFBTUEsbUJBQU4sU0FBa0NDLGdCQUFPQyxTQUF6QyxDQUFtRDtBQUNqREMsRUFBQUEsV0FBVyxDQUFFQyxJQUFG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b0IsQ0FBcEIsRUFBdUJKLEtBQXZCLEVBQThCQyxHQUE5QjtBQUNBSSxJQUFBQSxPQUFPLENBQUNDLFFBQVIsQ0FBaUIsTUFBTSxLQUFLaEQsY0FBTCxDQUFvQmlELE9BQXBCLENBQTRCSCxRQUE1QixDQUF2QjtBQUNEOztBQUVESSxFQUFBQSxRQUFRLEdBQUk7QUFDVixTQUFLNUMsVUFBTCxHQUFrQixJQUFsQjtBQUNEOztBQUVEcUIsRUFBQUEsV0FBVyxDQUFFZixJQUFGLEVBQVF1QyxLQUFSLEVBQWVsRCxZQUFmLEVBQTZCO0FBQ3RDLFlBQVEsS0FBS0csaUJBQWI7QUFDRSxXQUFLLENBQUw7QUFDRSxlQUFPSCxZQUFZLEdBQUdXLElBQUksQ0FBQ3dDLFlBQUwsQ0FBa0JELEtBQWxCLENBQUgsR0FBOEJ2QyxJQUFJLENBQUN5QyxZQUFMLENBQWtCRixLQUFsQixDQUFqRDs7QUFDRixXQUFLLENBQUw7QUFDRSxlQUFPbEQsWUFBWSxHQUFHVyxJQUFJLENBQUN3QyxZQUFMLENBQWtCRCxLQUFsQixDQUFILEdBQThCdkMsSUFBSSxDQUFDeUMsWUFBTCxDQUFrQkYsS0FBSyxHQUFHLENBQTFCLENBQWpEOztBQUNGO0FBQ0UsY0FBTSxJQUFJdkIsS0FBSixDQUFXLEdBQUUsS0FBS3hCLGlCQUFrQiw2REFBcEMsQ0FBTjtBQU5KO0FBUUQ7O0FBeEdnRDs7O2VBNEdwQ1QsbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU3RyZWFtIGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgbG9nIGZyb20gJy4uLy4uL2xvZ2dlcic7XG5cbmNsYXNzIExlbmd0aEJhc2VkU3BsaXR0ZXIgZXh0ZW5kcyBTdHJlYW0uVHJhbnNmb3JtIHtcbiAgY29uc3RydWN0b3IgKG9wdHMpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgY29uc3Qge1xuICAgICAgcmVhZGFibGVTdHJlYW0sXG4gICAgICBsaXR0bGVFbmRpYW4sXG4gICAgICBtYXhGcmFtZUxlbmd0aCxcbiAgICAgIGxlbmd0aEZpZWxkT2Zmc2V0LFxuICAgICAgbGVuZ3RoRmllbGRMZW5ndGgsXG4gICAgICBsZW5ndGhBZGp1c3RtZW50LFxuICAgIH0gPSBvcHRzO1xuXG4gICAgdGhpcy5yZWFkYWJsZVN0cmVhbSA9IHJlYWRhYmxlU3RyZWFtO1xuICAgIHRoaXMubGl0dGxlRW5kaWFuID0gbGl0dGxlRW5kaWFuO1xuICAgIHRoaXMubWF4RnJhbWVMZW5ndGggPSBtYXhGcmFtZUxlbmd0aDtcbiAgICB0aGlzLmxlbmd0aEZpZWxkT2Zmc2V0ID0gbGVuZ3RoRmllbGRPZmZzZXQ7XG4gICAgdGhpcy5sZW5ndGhGaWVsZExlbmd0aCA9IGxlbmd0aEZpZWxkTGVuZ3RoO1xuICAgIHRoaXMubGVuZ3RoQWRqdXN0bWVudCA9IGxlbmd0aEFkanVzdG1lbnQ7XG5cbiAgICB0aGlzLmlzU2h1dGRvd24gPSBmYWxzZTtcbiAgICB0aGlzLl9mcmFtZUJ1ZmZlckluZGV4ID0gMDtcbiAgICB0aGlzLl9mcmFtZUJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZVNsb3cobWF4RnJhbWVMZW5ndGgpO1xuICB9XG5cbiAgX3RyYW5zZm9ybSAoZGF0YSwgZW5jb2RpbmcsIG9uRGF0YSkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkgPSB0aGlzLl9kZWNvZGUoZGF0YSwgaSkpIHtcbiAgICAgIGlmICh0aGlzLmlzU2h1dGRvd24pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3B1c2hCYWNrKGksIGRhdGEubGVuZ3RoLCBkYXRhKTtcbiAgICAgIH1cbiAgICB9XG4gICAgb25EYXRhKCk7XG4gIH1cblxuICBfZGVjb2RlIChkYXRhLCBwb3MpIHtcbiAgICBsZXQgYnVmZmVyTWFya2VyID0gcG9zO1xuXG4gICAgbGV0IGJ5dGVzVG9SZWFkID0gTWF0aC5tYXgoKHRoaXMubGVuZ3RoRmllbGRPZmZzZXQgKyB0aGlzLmxlbmd0aEZpZWxkTGVuZ3RoKSAtIHRoaXMuX2ZyYW1lQnVmZmVySW5kZXgsIDApO1xuICAgIGxldCBuQnl0ZXNSZWFkID0gYnl0ZXNUb1JlYWQgPT09IDAgPyAwIDogdGhpcy5fcmVhZEJ5dGVzKGRhdGEsIGJ1ZmZlck1hcmtlciwgdGhpcy5fZnJhbWVCdWZmZXIsIHRoaXMuX2ZyYW1lQnVmZmVySW5kZXgsIGJ5dGVzVG9SZWFkKTtcbiAgICBidWZmZXJNYXJrZXIgKz0gbkJ5dGVzUmVhZDtcbiAgICB0aGlzLl9mcmFtZUJ1ZmZlckluZGV4ICs9IG5CeXRlc1JlYWQ7XG5cbiAgICBpZiAodGhpcy5fZnJhbWVCdWZmZXJJbmRleCA8IHRoaXMubGVuZ3RoRmllbGRPZmZzZXQpIHtcbiAgICAgIHJldHVybiBidWZmZXJNYXJrZXI7XG4gICAgfVxuXG4gICAgY29uc3QgbWVzc2FnZUxlbmd0aCA9IHRoaXMuX3JlYWRMZW5ndGgodGhpcy5fZnJhbWVCdWZmZXIsIHRoaXMubGVuZ3RoRmllbGRPZmZzZXQsIHRoaXMubGl0dGxlRW5kaWFuKTtcbiAgICBpZiAobWVzc2FnZUxlbmd0aCA+IHRoaXMubWF4RnJhbWVMZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGZyYW1lIGlzIGJpZ2dlciB0aGFuIGV4cGVjdGVkLiBMZW5ndGg6ICR7bWVzc2FnZUxlbmd0aH0sIG1heDogJHt0aGlzLm1heEZyYW1lTGVuZ3RofWApO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbXBsZXRlTWVzc2FnZUxlbmd0aCA9IG1lc3NhZ2VMZW5ndGggKyB0aGlzLmxlbmd0aEFkanVzdG1lbnQgKyB0aGlzLmxlbmd0aEZpZWxkT2Zmc2V0O1xuXG4gICAgYnl0ZXNUb1JlYWQgPSBjb21wbGV0ZU1lc3NhZ2VMZW5ndGggLSB0aGlzLl9mcmFtZUJ1ZmZlckluZGV4O1xuICAgIG5CeXRlc1JlYWQgPSBieXRlc1RvUmVhZCA9PT0gMCA/IDAgOiB0aGlzLl9yZWFkQnl0ZXMoZGF0YSwgYnVmZmVyTWFya2VyLCB0aGlzLl9mcmFtZUJ1ZmZlciwgdGhpcy5fZnJhbWVCdWZmZXJJbmRleCwgYnl0ZXNUb1JlYWQpO1xuICAgIGJ1ZmZlck1hcmtlciArPSBuQnl0ZXNSZWFkO1xuICAgIHRoaXMuX2ZyYW1lQnVmZmVySW5kZXggKz0gbkJ5dGVzUmVhZDtcblxuICAgIGlmICh0aGlzLl9mcmFtZUJ1ZmZlckluZGV4IDwgY29tcGxldGVNZXNzYWdlTGVuZ3RoKSB7XG4gICAgICByZXR1cm4gYnVmZmVyTWFya2VyO1xuICAgIH1cblxuICAgIGNvbnN0IG1lc3NhZ2UgPSBCdWZmZXIuYWxsb2NVbnNhZmUodGhpcy5fZnJhbWVCdWZmZXJJbmRleCk7XG4gICAgdGhpcy5fZnJhbWVCdWZmZXIuY29weShtZXNzYWdlLCAwLCAwLCB0aGlzLl9mcmFtZUJ1ZmZlckluZGV4KTtcblxuICAgIHRoaXMucHVzaChtZXNzYWdlKTtcbiAgICB0aGlzLl9yZXNldEJ1ZmZlcnMoKTtcbiAgICByZXR1cm4gYnVmZmVyTWFya2VyO1xuICB9XG5cbiAgX3JlYWRCeXRlcyAoc3JjLCBzcmNJbmRleCwgdGFyZ2V0LCB0YXJnZXRJbmRleCwgbkJ5dGVzVG9CZVJlYWQpIHtcbiAgICBsZXQgYXZhaWxhYmxlQnl0ZXMgPSBNYXRoLm1pbihuQnl0ZXNUb0JlUmVhZCwgc3JjLmxlbmd0aCAtIHNyY0luZGV4KTtcbiAgICBzcmMuY29weSh0YXJnZXQsIHRhcmdldEluZGV4LCBzcmNJbmRleCwgc3JjSW5kZXggKyBhdmFpbGFibGVCeXRlcyk7XG4gICAgcmV0dXJuIGF2YWlsYWJsZUJ5dGVzO1xuICB9XG4gIF9yZXNldEJ1ZmZlcnMgKCkge1xuICAgIHRoaXMuX2ZyYW1lQnVmZmVySW5kZXggPSAwO1xuICB9XG5cbiAgX3B1c2hCYWNrIChzdGFydCwgZW5kLCBkYXRhKSB7XG4gICAgaWYgKHN0YXJ0ID4gZW5kKSB7XG4gICAgICBsb2cuZXJyb3IoJ01vcmUgZGF0YSB3YXMgcmVhZCB0aGFuIHRoZSBidWZmZXIgc2l6ZS4gVGhpcyBzaG91bGQgbm90IGhhcHBlbicpO1xuICAgIH1cbiAgICBpZiAoc3RhcnQgPT09IGVuZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBsZWZ0b3ZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShlbmQgLSBzdGFydCk7XG4gICAgZGF0YS5jb3B5KGxlZnRvdmVyLCAwLCBzdGFydCwgZW5kKTtcbiAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHRoaXMucmVhZGFibGVTdHJlYW0udW5zaGlmdChsZWZ0b3ZlcikpO1xuICB9XG5cbiAgc2h1dGRvd24gKCkge1xuICAgIHRoaXMuaXNTaHV0ZG93biA9IHRydWU7XG4gIH1cblxuICBfcmVhZExlbmd0aCAoZGF0YSwgaW5kZXgsIGxpdHRsZUVuZGlhbikge1xuICAgIHN3aXRjaCAodGhpcy5sZW5ndGhGaWVsZExlbmd0aCkge1xuICAgICAgY2FzZSA0OlxuICAgICAgICByZXR1cm4gbGl0dGxlRW5kaWFuID8gZGF0YS5yZWFkVUludDMyTEUoaW5kZXgpIDogZGF0YS5yZWFkVUludDMyQkUoaW5kZXgpO1xuICAgICAgY2FzZSA4OlxuICAgICAgICByZXR1cm4gbGl0dGxlRW5kaWFuID8gZGF0YS5yZWFkVUludDMyTEUoaW5kZXgpIDogZGF0YS5yZWFkVUludDMyQkUoaW5kZXggKyA0KTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJHt0aGlzLmxlbmd0aEZpZWxkTGVuZ3RofSBpcyBub3Qgc3VwcG9ydGVkLiBPbmx5IDQgYW5kIDggYXJlIHN1cHBvcnRlZCBhdCB0aGUgbW9tZW50YCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB7IExlbmd0aEJhc2VkU3BsaXR0ZXJ9O1xuZXhwb3J0IGRlZmF1bHQgTGVuZ3RoQmFzZWRTcGxpdHRlcjtcbiJdLCJmaWxlIjoibGliL3V0aWwvdHJhbnNmb3JtZXIvbGVuZ3RoLWJhc2VkLXNwbGl0dGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uIn0=
