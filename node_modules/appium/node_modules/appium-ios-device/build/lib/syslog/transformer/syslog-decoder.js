"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.unescape = unescape;
exports.default = exports.SyslogDecoder = void 0;

require("source-map-support/register");

var _stream = _interopRequireDefault(require("stream"));

const NEW_LINE_CODE = 0x0A;
const NULL_DELIMETER_CODE = 0x00;
const BACKSLASH_CODE = '\\'.codePointAt(0);
const SHIFTS_MAPPING = {
  '-': 0x80,
  '^': 0x40
};
const ESCAPE_TOKEN_LEN = 4;
const ESCAPE_TOKEN_PATTERN = /\\M(-|\^)(.)/;

function toUtf8Byte(escapedChar, modifier) {
  const shift = SHIFTS_MAPPING[modifier];
  return isNaN(shift) ? null : escapedChar.codePointAt(0) + shift;
}

function unescape(logBuffer) {
  const parseUtf8Chars = start => {
    let cursor = start;
    const token = new Uint8Array(ESCAPE_TOKEN_LEN);
    const utf8CharsAsBytes = [];

    while (cursor <= logBuffer.length - ESCAPE_TOKEN_LEN) {
      logBuffer.copy(token, 0, cursor, cursor + ESCAPE_TOKEN_LEN);
      const tokenStr = Buffer.from(token).toString('latin1');
      const tokenMatch = ESCAPE_TOKEN_PATTERN.exec(tokenStr);

      if (!tokenMatch) {
        break;
      }

      const byte = toUtf8Byte(tokenMatch[2], tokenMatch[1]);

      if (byte === null) {
        break;
      }

      utf8CharsAsBytes.push(byte);
      cursor += ESCAPE_TOKEN_LEN;
    }

    return utf8CharsAsBytes.length ? [cursor, Buffer.from(utf8CharsAsBytes).toString('utf8')] : [start, null];
  };

  let index = 0;
  let result = '';
  const bytesView = new Uint8Array(logBuffer);

  while (index < bytesView.length) {
    if (bytesView[index] === BACKSLASH_CODE) {
      const [newIndex, chars] = parseUtf8Chars(index);

      if (newIndex > index) {
        result += chars;
        index = newIndex;
        continue;
      }
    }

    result += String.fromCharCode(bytesView[index++]);
  }

  return result;
}

class SyslogDecoder extends _stream.default.Transform {
  constructor(bufferLength) {
    super({
      objectMode: true
    });
    this.bufferIndex = 0;
    this.buffer = Buffer.allocUnsafe(bufferLength);
  }

  _transform(data, encoding, onData) {
    this._decode(data);

    onData();
  }

  _decode(data) {
    for (let i = 0; i < data.length; i++) {
      if (data[i] === NULL_DELIMETER_CODE) {
        continue;
      }

      if (data[i] === NEW_LINE_CODE) {
        if (this.bufferIndex > 0) {
          const stringBuffer = Buffer.allocUnsafe(this.bufferIndex);
          this.buffer.copy(stringBuffer, 0, 0, this.bufferIndex);
          this.push(unescape(stringBuffer), 'utf8');
          this.bufferIndex = 0;
        }

        continue;
      }

      this.buffer[this.bufferIndex] = data[i];
      this.bufferIndex++;
    }
  }

}

exports.SyslogDecoder = SyslogDecoder;
var _default = SyslogDecoder;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zeXNsb2cvdHJhbnNmb3JtZXIvc3lzbG9nLWRlY29kZXIuanMiXSwibmFtZXMiOlsiTkVXX0xJTkVfQ09ERSIsIk5VTExfREVMSU1FVEVSX0NPREUiLCJCQUNLU0xBU0hfQ09ERSIsImNvZGVQb2ludEF0IiwiU0hJRlRTX01BUFBJTkciLCJFU0NBUEVfVE9LRU5fTEVOIiwiRVNDQVBFX1RPS0VOX1BBVFRFUk4iLCJ0b1V0ZjhCeXRlIiwiZXNjYXBlZENoYXIiLCJtb2RpZmllciIsInNoaWZ0IiwiaXNOYU4iLCJ1bmVzY2FwZSIsImxvZ0J1ZmZlciIsInBhcnNlVXRmOENoYXJzIiwic3RhcnQiLCJjdXJzb3IiLCJ0b2tlbiIsIlVpbnQ4QXJyYXkiLCJ1dGY4Q2hhcnNBc0J5dGVzIiwibGVuZ3RoIiwiY29weSIsInRva2VuU3RyIiwiQnVmZmVyIiwiZnJvbSIsInRvU3RyaW5nIiwidG9rZW5NYXRjaCIsImV4ZWMiLCJieXRlIiwicHVzaCIsImluZGV4IiwicmVzdWx0IiwiYnl0ZXNWaWV3IiwibmV3SW5kZXgiLCJjaGFycyIsIlN0cmluZyIsImZyb21DaGFyQ29kZSIsIlN5c2xvZ0RlY29kZXIiLCJTdHJlYW0iLCJUcmFuc2Zvcm0iLCJjb25zdHJ1Y3RvciIsImJ1ZmZlckxlbmd0aCIsIm9iamVjdE1vZGUiLCJidWZmZXJJbmRleCIsImJ1ZmZlciIsImFsbG9jVW5zYWZlIiwiX3RyYW5zZm9ybSIsImRhdGEiLCJlbmNvZGluZyIsIm9uRGF0YSIsIl9kZWNvZGUiLCJpIiwic3RyaW5nQnVmZmVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQTs7QUFFQSxNQUFNQSxhQUFhLEdBQUcsSUFBdEI7QUFDQSxNQUFNQyxtQkFBbUIsR0FBRyxJQUE1QjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxLQUFLQyxXQUFMLENBQWlCLENBQWpCLENBQXZCO0FBQ0EsTUFBTUMsY0FBYyxHQUFHO0FBQ3JCLE9BQUssSUFEZ0I7QUFFckIsT0FBSztBQUZnQixDQUF2QjtB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QW5CLENBQWQ7QUFDRDs7QUFFREssRUFBQUEsVUFBVSxDQUFFQyxJQUFGLEVBQVFDLFFBQVIsRUFBa0JDLE1BQWxCLEVBQTBCO0FBQ2xDLFNBQUtDLE9BQUwsQ0FBYUgsSUFBYjs7QUFDQUUsSUFBQUEsTUFBTTtBQUNQOztBQUVEQyxFQUFBQSxPQUFPLENBQUVILElBQUYsRUFBUTtBQUNiLFNBQUssSUFBSUksQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR0osSUFBSSxDQUFDM0IsTUFBekIsRUFBaUMrQixDQUFDLEVBQWxDLEVBQXNDO0FBRXBDLFVBQUlKLElBQUksQ0FBQ0ksQ0FBRCxDQUFKLEtBQVlsRCxtQkFBaEIsRUFBcUM7QUFDbkM7QUFDRDs7QUFFRCxVQUFJOEMsSUFBSSxDQUFDSSxDQUFELENBQUosS0FBWW5ELGFBQWhCLEVBQStCO0FBQzdCLFlBQUksS0FBSzJDLFdBQUwsR0FBbUIsQ0FBdkIsRUFBMEI7QUFDeEIsZ0JBQU1TLFlBQVksR0FBRzdCLE1BQU0sQ0FBQ3NCLFdBQVAsQ0FBbUIsS0FBS0YsV0FBeEIsQ0FBckI7QUFDQSxlQUFLQyxNQUFMLENBQVl2QixJQUFaLENBQWlCK0IsWUFBakIsRUFBK0IsQ0FBL0IsRUFBa0MsQ0FBbEMsRUFBcUMsS0FBS1QsV0FBMUM7QUFDQSxlQUFLZCxJQUFMLENBQVVqQixRQUFRLENBQUN3QyxZQUFELENBQWxCLEVBQWtDLE1BQWxDO0FBQ0EsZUFBS1QsV0FBTCxHQUFtQixDQUFuQjtBQUNEOztBQUNEO0FBQ0Q7O0FBQ0QsV0FBS0MsTUFBTCxDQUFZLEtBQUtELFdBQWpCLElBQWdDSSxJQUFJLENBQUNJLENBQUQsQ0FBcEM7QUFDQSxXQUFLUixXQUFMO0FBQ0Q7QUFDRjs7QUFoQzBDOzs7ZUFvQzlCTixhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFN0cmVhbSBmcm9tICdzdHJlYW0nO1xuXG5jb25zdCBORVdfTElORV9DT0RFID0gMHgwQTtcbmNvbnN0IE5VTExfREVMSU1FVEVSX0NPREUgPSAweDAwO1xuY29uc3QgQkFDS1NMQVNIX0NPREUgPSAnXFxcXCcuY29kZVBvaW50QXQoMCk7XG5jb25zdCBTSElGVFNfTUFQUElORyA9IHtcbiAgJy0nOiAweDgwLFxuICAnXic6IDB4NDAsXG59O1xuY29uc3QgRVNDQVBFX1RPS0VOX0xFTiA9IDQ7XG5jb25zdCBFU0NBUEVfVE9LRU5fUEFUVEVSTiA9IC9cXFxcTSgtfFxcXikoLikvO1xuXG5cbmZ1bmN0aW9uIHRvVXRmOEJ5dGUgKGVzY2FwZWRDaGFyLCBtb2RpZmllcikge1xuICBjb25zdCBzaGlmdCA9IFNISUZUU19NQVBQSU5HW21vZGlmaWVyXTtcbiAgcmV0dXJuIGlzTmFOKHNoaWZ0KSA/IG51bGwgOiBlc2NhcGVkQ2hhci5jb2RlUG9pbnRBdCgwKSArIHNoaWZ0O1xufVxuXG4vKipcbiAqIFVuZXNjYXBlcyB1dGY4LWVuY29kZWQgY2hhcmFjdGVycywgc28gdGhlIG91dHB1dCBsb29rc1xuICogbGlrZSBhIHZhbGlkIHN0cmluZy4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy8xNDQ3NlxuICogZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBAcGFyYW0ge0J1ZmZlcn0gbG9nQnVmZmVyIEEgc2luZ2xlIGVzY2FwZWQgbG9nIGxpbmVcbiAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSB1bmVzY2FwZWQgc3RyaW5nIG9yIHRoZSBzYW1lIHN0cmluZyBpZiBubyB1bmVzY2FwaW5nXG4gKiBpcyBuZWNlc3NhcnkuXG4gKi9cbmZ1bmN0aW9uIHVuZXNjYXBlIChsb2dCdWZmZXIpIHtcbiAgY29uc3QgcGFyc2VVdGY4Q2hhcnMgPSAoc3RhcnQpID0+IHtcbiAgICBsZXQgY3Vyc29yID0gc3RhcnQ7XG4gICAgY29uc3QgdG9rZW4gPSBuZXcgVWludDhBcnJheShFU0NBUEVfVE9LRU5fTEVOKTtcbiAgICBjb25zdCB1dGY4Q2hhcnNBc0J5dGVzID0gW107XG4gICAgd2hpbGUgKGN1cnNvciA8PSBsb2dCdWZmZXIubGVuZ3RoIC0gRVNDQVBFX1RPS0VOX0xFTikge1xuICAgICAgbG9nQnVmZmVyLmNvcHkodG9rZW4sIDAsIGN1cnNvciwgY3Vyc29yICsgRVNDQVBFX1RPS0VOX0xFTik7XG4gICAgICBjb25zdCB0b2tlblN0ciA9IEJ1ZmZlci5mcm9tKHRva2VuKS50b1N0cmluZygnbGF0aW4xJyk7XG4gICAgICBjb25zdCB0b2tlbk1hdGNoID0gRVNDQVBFX1RPS0VOX1BBVFRFUk4uZXhlYyh0b2tlblN0cik7XG4gICAgICBpZiAoIXRva2VuTWF0Y2gpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjb25zdCBieXRlID0gdG9VdGY4Qnl0ZSh0b2tlbk1hdGNoWzJdLCB0b2tlbk1hdGNoWzFdKTtcbiAgICAgIGlmIChieXRlID09PSBudWxsKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgdXRmOENoYXJzQXNCeXRlcy5wdXNoKGJ5dGUpO1xuICAgICAgY3Vyc29yICs9IEVTQ0FQRV9UT0tFTl9MRU47XG4gICAgfVxuICAgIHJldHVybiB1dGY4Q2hhcnNBc0J5dGVzLmxlbmd0aFxuICAgICAgPyBbY3Vyc29yLCBCdWZmZXIuZnJvbSh1dGY4Q2hhcnNBc0J5dGVzKS50b1N0cmluZygndXRmOCcpXVxuICAgICAgOiBbc3RhcnQsIG51bGxdO1xuICB9O1xuXG4gIGxldCBpbmRleCA9IDA7XG4gIGxldCByZXN1bHQgPSAnJztcbiAgY29uc3QgYnl0ZXNWaWV3ID0gbmV3IFVpbnQ4QXJyYXkobG9nQnVmZmVyKTtcbiAgd2hpbGUgKGluZGV4IDwgYnl0ZXNWaWV3Lmxlbmd0aCkge1xuICAgIGlmIChieXRlc1ZpZXdbaW5kZXhdID09PSBCQUNLU0xBU0hfQ09ERSkge1xuICAgICAgY29uc3QgW25ld0luZGV4LCBjaGFyc10gPSBwYXJzZVV0ZjhDaGFycyhpbmRleCk7XG4gICAgICBpZiAobmV3SW5kZXggPiBpbmRleCkge1xuICAgICAgICByZXN1bHQgKz0gY2hhcnM7XG4gICAgICAgIGluZGV4ID0gbmV3SW5kZXg7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXN1bHQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShieXRlc1ZpZXdbaW5kZXgrK10pO1xuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuXG5jbGFzcyBTeXNsb2dEZWNvZGVyIGV4dGVuZHMgU3RyZWFtLlRyYW5zZm9ybSB7XG5cbiAgY29uc3RydWN0b3IgKGJ1ZmZlckxlbmd0aCkge1xuICAgIHN1cGVyKHsgb2JqZWN0TW9kZTogdHJ1ZSB9KTtcbiAgICB0aGlzLmJ1ZmZlckluZGV4ID0gMDtcbiAgICB0aGlzLmJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShidWZmZXJMZW5ndGgpO1xuICB9XG5cbiAgX3RyYW5zZm9ybSAoZGF0YSwgZW5jb2RpbmcsIG9uRGF0YSkge1xuICAgIHRoaXMuX2RlY29kZShkYXRhKTtcbiAgICBvbkRhdGEoKTtcbiAgfVxuXG4gIF9kZWNvZGUgKGRhdGEpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgIC8vIERvbid0IHN0b3JlIHRoZSBudWxsIGRlbGltZXRlciBtZXNzYWdlc1xuICAgICAgaWYgKGRhdGFbaV0gPT09IE5VTExfREVMSU1FVEVSX0NPREUpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICAvLyBQdXNoIHRoZSBkYXRhIHdoZW4gbmV3IGxpbmUgaXMgc2VudFxuICAgICAgaWYgKGRhdGFbaV0gPT09IE5FV19MSU5FX0NPREUpIHtcbiAgICAgICAgaWYgKHRoaXMuYnVmZmVySW5kZXggPiAwKSB7XG4gICAgICAgICAgY29uc3Qgc3RyaW5nQnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKHRoaXMuYnVmZmVySW5kZXgpO1xuICAgICAgICAgIHRoaXMuYnVmZmVyLmNvcHkoc3RyaW5nQnVmZmVyLCAwLCAwLCB0aGlzLmJ1ZmZlckluZGV4KTtcbiAgICAgICAgICB0aGlzLnB1c2godW5lc2NhcGUoc3RyaW5nQnVmZmVyKSwgJ3V0ZjgnKTtcbiAgICAgICAgICB0aGlzLmJ1ZmZlckluZGV4ID0gMDtcbiAgICAgICAgfVxuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIHRoaXMuYnVmZmVyW3RoaXMuYnVmZmVySW5kZXhdID0gZGF0YVtpXTtcbiAgICAgIHRoaXMuYnVmZmVySW5kZXgrKztcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHsgU3lzbG9nRGVjb2RlciwgdW5lc2NhcGUgfTtcbmV4cG9ydCBkZWZhdWx0IFN5c2xvZ0RlY29kZXI7XG4iXSwiZmlsZSI6ImxpYi9zeXNsb2cvdHJhbnNmb3JtZXIvc3lzbG9nLWRlY29kZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4ifQ==
