"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _teen_process = require("teen_process");

var _portscanner = require("portscanner");

var _http = _interopRequireDefault(require("http"));

var _net = _interopRequireDefault(require("net"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _asyncbox = require("asyncbox");

var _child_process = require("child_process");

var _url = _interopRequireDefault(require("url"));

const commands = {};
const RECORDING_INTERVAL_SEC = 5;
const STREAMING_STARTUP_TIMEOUT_MS = 5000;
const GSTREAMER_BINARY = `gst-launch-1.0${_appiumSupport.system.isWindows() ? '.exe' : ''}`;
const GST_INSPECT_BINARY = `gst-inspect-1.0${_appiumSupport.system.isWindows() ? '.exe' : ''}`;
const REQUIRED_GST_PLUGINS = {
  avdec_h264: 'gst-libav',
  h264parse: 'gst-plugins-bad',
  jpegenc: 'gst-plugins-good',
  tcpserversink: 'gst-plugins-base',
  multipartmux: 'gst-plugins-good'
};
const SCREENRECORD_BINARY = 'screenrecord';
const GST_TUTORIAL_URL = 'https://gstreamer.freedesktop.org/documentation/installing/index.html';
const DEFAULT_HOST = '127.0.0.1';
const TCP_HOST = '127.0.0.1';
const DEFAULT_PORT = 8093;
const DEFAULT_QUALITY = 70;
const DEFAULT_BITRATE = 4000000;
const BOUNDARY_STRING = '--2ae9746887f170b8cf7c271047ce314c';
const ADB_SCREEN_STREAMING_FEATURE = 'adb_screen_streaming';

function createStreamingLogger(streamName, udid) {
  return _appiumSupport.logger.getLogger(`${streamName}@` + _lodash.default.truncate(udid, {
    length: 8,
    omission: ''
  }));
}

async function verifyStreamingRequirements(adb) {
  if (!_lodash.default.trim(await adb.shell(['which', SCREENRECORD_BINARY]))) {
    throw new Error(`The required '${SCREENRECORD_BINARY}' binary is not available on the device under test`);
  }

  const gstreamerCheckPromises = [];

  for (const binaryName of [GSTREAMER_BINARY, GST_INSPECT_BINARY]) {
    gstreamerCheckPromises.push((async () => {
      try {
        await _appiumSupport.fs.which(binaryName);
      } catch (e) {
        throw new Error(`The '${binaryName}' binary is not available in the PATH on the host system. ` + `See ${GST_TUTORIAL_URL} for more details on how to install it.`);
      }
    })());
  }

  await _bluebird.default.all(gstreamerCheckPromises);
  const moduleCheckPromises = [];

  for (const [name, modName] of _lodash.default.toPairs(REQUIRED_GST_PLUGINS)) {
    moduleCheckPromises.push((async () => {
      const {
        stdout
      } = await (0, _teen_process.exec)(GST_INSPECT_BINARY, [name]);

      if (!_lodash.default.includes(stdout, modName)) {
        throw new Error(`The required GStreamer plugin '${name}' from '${modName}' module is not installed. ` + `See ${GST_TUTORIAL_URL} for more details on how to install it.`);
      }
    })());
  }

  await _bluebird.default.all(moduleCheckPromises);
}

async function getDeviceInfo(adb) {
  const output = await adb.shell(['dumpsys', 'display']);
  const result = {};

  for (const [key, pattern] of [['width', /\bdeviceWidth=(\d+)/], ['height', /\bdeviceHeight=(\d+)/], ['fps', /\bfps=(\d+)/]]) {
    const match = pattern.exec(output);

    if (!match) {
      _logger.default.debug(output);

      throw new Error(`Cannot parse the device ${key} from the adb command output. ` + `Check the server log for more details.`);
    }

    result[key] = parseInt(match[1], 10);
  }

  result.udid = adb.curDeviceId;
  return result;
}

async function initDeviceStreamingProc(adb, deviceInfo, opts = {}) {
  const {
    width,
    height,
    bitRate
  } = opts;
  const adjustedWidth = parseInt(width, 10) || deviceInfo.width;
  const adjustedHeight = parseInt(height, 10) || deviceInfo.height;
  const adjustedBitrate = parseInt(bitRate, 10) || DEFAULT_BITRATE;
  let screenRecordCmd = SCREENRECORD_BINARY + ` --output-format=h264` + ` --time-limit=${RECORDING_INTERVAL_SEC}`;

  if (width || height) {
    screenRecordCmd += ` --size=${adjustedWidth}x${adjustedHeight}`;
  }

  if (bitRate) {
    screenRecordCmd += ` --bit-rate=${adjustedBitrate}`;
  }

  const adbArgs = [...adb.executable.defaultArgs, 'exec-out', `while true; do ${screenRecordCmd} -; done`];
  const deviceStreaming = (0, _child_process.spawn)(adb.executable.path, adbArgs);
  deviceStreaming.on('exit', (code, signal) => {
    _logger.default.debug(`Device streaming process exited with code ${code}, signal ${signal}`);
  });
  let isStarted = false;
  const deviceStreamingLogger = createStreamingLogger(SCREENRECORD_BINARY, deviceInfo.udid);

  const errorsListener = chunk => {
    const stderr = chunk.toString();

    if (_lodash.default.trim(stderr)) {
      deviceStreamingLogger.debug(stderr);
    }
  };

  deviceStreaming.stderr.on('data', errorsListener);

  const startupListener = chunk => {
    if (!isStarted) {
      isStarted = !_lodash.default.isEmpty(chunk);
    }
  };

  deviceStreaming.stdout.on('data', startupListener);

  try {
    _logger.default.info(`Starting device streaming: ${_appiumSupport.util.quote([adb.executable.path, ...adbArgs])}`);

    await (0, _asyncbox.waitForCondition)(() => isStarted, {
      waitMs: STREAMING_STARTUP_TIMEOUT_MS,
      intervalMs: 300
    });
  } catch (e) {
    _logger.default.errorAndThrow(`Cannot start the screen streaming process. Original error: ${e.message}`);
  } finally {
    deviceStreaming.stderr.removeListener('data', errorsListener);
    deviceStreaming.stdout.removeListener('data', startupListener);
  }

  return deviceStreaming;
}

async function initGstreamerPipeline(deviceStreamingProc, deviceInfo, opts = {}) {
  const {
    width,
    height,
    quality,
    tcpPort,
    considerRotation,
    logPipelineDetails
  } = opts;
  const adjustedWidth = parseInt(width, 10) || deviceInfo.width;
  const adjustedHeight = parseInt(height, 10) || deviceInfo.height;
  const gstreamerPipeline = new _teen_process.SubProcess(GSTREAMER_BINARY, ['-v', 'fdsrc', 'fd=0', '!', 'video/x-h264,' + `width=${considerRotation ? Math.max(adjustedWidth, adjustedHeight) : adjustedWidth},` + `height=${considerRotation ? Math.max(adjustedWidth, adjustedHeight) : adjustedHeight},` + `framerate=${deviceInfo.fps}/1,` + 'byte-stream=true', '!', 'h264parse', '!', 'queue', 'leaky=downstream', '!', 'avdec_h264', '!', 'queue', 'leaky=downstream', '!', 'jpegenc', `quality=${quality}`, '!', 'multipartmux', `boundary=${BOUNDARY_STRING}`, '!', 'tcpserversink', `host=${TCP_HOST}`, `port=${tcpPort}`], {
    stdio: [deviceStreamingProc.stdout, 'pipe', 'pipe']
  });
  gstreamerPipeline.on('exit', (code, signal) => {
    _logger.default.debug(`Pipeline streaming process exited with code ${code}, signal ${signal}`);
  });
  const gstreamerLogger = createStreamingLogger('gst', deviceInfo.udid);

  const gstOutputListener = (stdout, stderr) => {
    if (_lodash.default.trim(stderr || stdout)) {
      gstreamerLogger.debug(stderr || stdout);
    }
  };

  gstreamerPipeline.on('output', gstOutputListener);
  let didFail = false;

  try {
    _logger.default.info(`Starting GStreamer pipeline: ${gstreamerPipeline.rep}`);

    await gstreamerPipeline.start(0);
    await (0, _asyncbox.waitForCondition)(async () => {
      try {
        return (await (0, _portscanner.checkPortStatus)(tcpPort, TCP_HOST)) === 'open';
      } catch (ign) {
        return false;
      }
    }, {
      waitMs: STREAMING_STARTUP_TIMEOUT_MS,
      intervalMs: 300
    });
  } catch (e) {
    didFail = true;

    _logger.default.errorAndThrow(`Cannot start the screen streaming pipeline. Original error: ${e.message}`);
  } finally {
    if (!logPipelineDetails || didFail) {
      gstreamerPipeline.removeListener('output', gstOutputListener);
    }
  }

  return gstreamerPipeline;
}

function extractRemoteAddress(req) {
  return req.headers['x-forwarded-for'] || req.socket.remoteAddress || req.connection.remoteAddress || req.connection.socket.remoteAddress;
}

commands.mobileStartScreenStreaming = async function mobileStartScreenStreaming(options = {}) {
  this.ensureFeatureEnabled(ADB_SCREEN_STREAMING_FEATURE);
  const {
    width,
    height,
    bitRate,
    host = DEFAULT_HOST,
    port = DEFAULT_PORT,
    pathname,
    tcpPort = DEFAULT_PORT + 1,
    quality = DEFAULT_QUALITY,
    considerRotation = false,
    logPipelineDetails = false
  } = options;

  if (_lodash.default.isUndefined(this._screenStreamingProps)) {
    await verifyStreamingRequirements(this.adb);
  }

  if (!_lodash.default.isEmpty(this._screenStreamingProps)) {
    _logger.default.info(`The screen streaming session is already running. ` + `Stop it first in order to start a new one.`);

    return;
  }

  if ((await (0, _portscanner.checkPortStatus)(port, host)) === 'open') {
    _logger.default.info(`The port #${port} at ${host} is busy. ` + `Assuming the screen streaming is already running`);

    return;
  }

  if ((await (0, _portscanner.checkPortStatus)(tcpPort, TCP_HOST)) === 'open') {
    _logger.default.errorAndThrow(`The port #${tcpPort} at ${TCP_HOST} is busy. ` + `Make sure there are no leftovers from previous sessions.`);
  }

  this._screenStreamingProps = null;
  const deviceInfo = await getDeviceInfo(this.adb);
  const deviceStreamingProc = await initDeviceStreamingProc(this.adb, deviceInfo, {
    width,
    height,
    bitRate
  });
  let gstreamerPipeline;

  try {
    gstreamerPipeline = await initGstreamerPipeline(deviceStreamingProc, deviceInfo, {
      width,
      height,
      quality,
      tcpPort,
      considerRotation,
      logPipelineDetails
    });
  } catch (e) {
    if (deviceStreamingProc.kill(0)) {
      deviceStreamingProc.kill();
    }

    throw e;
  }

  let mjpegSocket;
  let mjpegServer;

  try {
    await new _bluebird.default((resolve, reject) => {
      mjpegSocket = _net.default.createConnection(tcpPort, TCP_HOST, () => {
        _logger.default.info(`Successfully connected to MJPEG stream at tcp://${TCP_HOST}:${tcpPort}`);

        mjpegServer = _http.default.createServer((req, res) => {
          const remoteAddress = extractRemoteAddress(req);

          const currentPathname = _url.default.parse(req.url).pathname;

          _logger.default.info(`Got an incoming screen bradcasting request from ${remoteAddress} ` + `(${req.headers['user-agent'] || 'User Agent unknown'}) at ${currentPathname}`);

          if (pathname && currentPathname !== pathname) {
            _logger.default.info('Rejecting the broadcast request since it does not match the given pathname');

            res.writeHead(404, {
              Connection: 'close',
              'Content-Type': 'text/plain; charset=utf-8'
            });
            res.write(`'${currentPathname}' did not match any known endpoints`);
            res.end();
            return;
          }

          _logger.default.info('Starting MJPEG broadcast');

          res.writeHead(200, {
            'Cache-Control': 'no-store, no-cache, must-revalidate, pre-check=0, post-check=0, max-age=0',
            Pragma: 'no-cache',
            Connection: 'close',
            'Content-Type': `multipart/x-mixed-replace; boundary=${BOUNDARY_STRING}`
          });
          mjpegSocket.pipe(res);
        });
        mjpegServer.on('error', e => {
          _logger.default.warn(e);

          reject(e);
        });
        mjpegServer.on('close', () => {
          _logger.default.debug(`MJPEG server at http://${host}:${port} has been closed`);
        });
        mjpegServer.on('listening', () => {
          _logger.default.info(`Successfully started MJPEG server at http://${host}:${port}`);

          resolve();
        });
        mjpegServer.listen(port, host);
      });
      mjpegSocket.on('error', e => {
        _logger.default.error(e);

        reject(e);
      });
    }).timeout(STREAMING_STARTUP_TIMEOUT_MS, `Cannot connect to the streaming server within ${STREAMING_STARTUP_TIMEOUT_MS}ms`);
  } catch (e) {
    if (deviceStreamingProc.kill(0)) {
      deviceStreamingProc.kill();
    }

    if (gstreamerPipeline.isRunning) {
      await gstreamerPipeline.stop();
    }

    if (mjpegSocket) {
      mjpegSocket.destroy();
    }

    if (mjpegServer && mjpegServer.listening) {
      mjpegServer.close();
    }

    throw e;
  }

  this._screenStreamingProps = {
    deviceStreamingProc,
    gstreamerPipeline,
    mjpegSocket,
    mjpegServer
  };
};

commands.mobileStopScreenStreaming = async function mobileStopScreenStreaming() {
  if (_lodash.default.isEmpty(this._screenStreamingProps)) {
    if (!_lodash.default.isUndefined(this._screenStreamingProps)) {
      _logger.default.debug(`Screen streaming is not running. There is nothing to stop`);
    }

    return;
  }

  const {
    deviceStreamingProc,
    gstreamerPipeline,
    mjpegSocket,
    mjpegServer
  } = this._screenStreamingProps;

  try {
    mjpegSocket.end();

    if (mjpegServer.listening) {
      mjpegServer.close();
    }

    if (deviceStreamingProc.kill(0)) {
      deviceStreamingProc.kill('SIGINT');
    }

    if (gstreamerPipeline.isRunning) {
      try {
        await gstreamerPipeline.stop('SIGINT');
      } catch (e) {
        _logger.default.warn(e);

        try {
          await gstreamerPipeline.stop('SIGKILL');
        } catch (e1) {
          _logger.default.error(e1);
        }
      }
    }

    _logger.default.info(`Successfully terminated the screen streaming MJPEG server`);
  } finally {
    this._screenStreamingProps = null;
  }
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9zdHJlYW1zY3JlZW4uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJSRUNPUkRJTkdfSU5URVJWQUxfU0VDIiwiU1RSRUFNSU5HX1NUQVJUVVBfVElNRU9VVF9NUyIsIkdTVFJFQU1FUl9CSU5BUlkiLCJzeXN0ZW0iLCJpc1dpbmRvd3MiLCJHU1RfSU5TUEVDVF9CSU5BUlkiLCJSRVFVSVJFRF9HU1RfUExVR0lOUyIsImF2ZGVjX2gyNjQiLCJoMjY0cGFyc2UiLCJqcGVnZW5jIiwidGNwc2VydmVyc2luayIsIm11bHRpcGFydG11eCIsIlNDUkVFTlJFQ09SRF9CSU5BUlkiLCJHU1RfVFVUT1JJQUxfVVJMIiwiREVGQVVMVF9IT1NUIiwiVENQX0hPU1QiLCJERUZBVUxUX1BPUlQiLCJERUZBVUxUX1FVQUxJVFkiLCJERUZBVUxUX0JJVFJBVEUiLCJCT1VOREFSWV9TVFJJTkciLCJBREJfU0NSRUVOX1NUUkVBTUlOR19GRUFUVVJFIiwiY3JlYXRlU3RyZWFtaW5nTG9nZ2VyIiwic3RyZWFtTmFtZSIsInVkaWQiLCJsb2dnZXIiLCJnZXRMb2dnZXIiLCJfIiwidHJ1bmNhdGUiLCJsZW5ndGgiLCJvbWlzc2lvbiIsInZlcmlmeVN0cmVhbWluZ1JlcXVpcmVtZW50cyIsImFkYiIsInRyaW0iLCJzaGVsbCIsIkVycm9yIiwiZ3N0cmVhbWVyQ2hlY2tQcm9taXNlcyIsImJpbmFyeU5hbWUiLCJwdXNoIiwiZnMiLCJ3aGljaCIsImUiLCJCIiwiYWxsIiwibW9kdWxlQ2hlY2tQcm9taXNlcyIsIm5hbWUiLCJtb2ROYW1lIiwidG9QYWlycyIsInN0ZG91dCIsImluY2x1ZGVzIiwiZ2V0RGV2aWNlSW5mbyIsIm91dHB1dCIsInJlc3VsdCIsImtleSIsInBhdHRlcm4iLCJtYXRjaCIsImV4ZWMiLCJsb2ciLCJkZWJ1ZyIsInBhcnNlSW50IiwiY3VyRGV2aWNlSWQiLCJpbml0RGV2aWNlU3RyZWFtaW5nUHJvYyIsImRldmljZUluZm8iLCJvcHRzIiwid2lkdGgiLCJoZWlnaHQiLCJiaXRSYXRlIiwiYWRqdXN0ZWRXaWR0aCIsImFkanVzdGVkSGVpZ2h0IiwiYWRqdXN0ZWRCaXRyYXRlIiwic2NyZWVuUmVjb3JkQ21kIiwiYWRiQXJncyIsImV4ZWN1dGFibGUiLCJkZWZhdWx0QXJncyIsImRldmljZVN0cmVhbWluZyIsInBhdGgiLCJvbiIsImNvZGUiLCJzaWduYWwiLCJpc1N0YXJ0ZWQiLCJkZXZpY2VTdHJlYW1pbmdMb2dnZXIiLCJlcnJvcnNMaXN0ZW5lciIsImNodW5rIiwic3RkZXJyIiwidG9TdHJpbmciLCJzdGFydHVwTGlzdGVuZXIiLCJpc0VtcHR5IiwiaW5mbyIsInV0aWwiLCJxdW90ZSIsIndhaXRNcyIsImludGVydmFsTXMiLCJlcnJvckFuZFRocm93IiwibWVzc2FnZSIsInJlbW92ZUxpc3RlbmVyIiwiaW5pdEdzdHJlYW1lclBpcGVsaW5lIiwiZGV2aWNlU3RyZWFtaW5nUHJvYyIsInF1YWxpdHkiLCJ0Y3BQb3J0IiwiY29uc2lkZXJSb3RhdGlvbiIsImxvZ1BpcGVsaW5lRGV0YWlscyIsImdzdHJlYW1lclBpcGVsaW5lIiwiU3ViUHJvY2VzcyIsIk1hdGgiLCJtYXgiLCJmcHMiLCJzdGRpbyIsImdzdHJlYW1lckxvZ2dlciIsImdzdE91dHB1dExpc3RlbmVyIiwiZGlkRmFpbCIsInJlcCIsInN0YXJ0IiwiaWduIiwiZXh0cmFjdFJlbW90ZUFkZHJlc3MiLCJyZXEiLCJoZWFkZXJzIiwic29ja2V0IiwicmVtb3RlQWRkcmVzcyIsImNvbm5lY3Rpb24iLCJtb2JpbGVTdGFydFNjcmVlblN0cmVhbWluZyIsIm9wdGlvbnMiLCJlbnN1cmVGZWF0dXJlRW5hYmxlZCIsImhvc3QiLCJwb3J0IiwicGF0aG5hbWUiLCJpc1VuZGVmaW5lZCIsIl9zY3JlZW5TdHJlYW1pbmdQcm9wcyIsImtpbGwiLCJtanBlZ1NvY2tldCIsIm1qcGVnU2VydmVyIiwicmVzb2x2ZSIsInJlamVjdCIsIm5ldCIsImNyZWF0ZUNvbm5lY3Rpb24iLCJodHRwIiwiY3JlYXRlU2VydmVyIiwicmVzIiwiY3VycmVudFBhdGhuYW1lIiwidXJsIiwicGFyc2UiLCJ3cml0ZUhlYWQiLCJDb25uZWN0aW9uIiwid3JpdGUiLCJlbmQiLCJQcmFnbWEiLCJwaXBlIiwid2FybiIsImxpc3RlbiIsImVycm9yIiwidGltZW91dCIsImlzUnVubmluZyIsInN0b3AiLCJkZXN0cm95IiwibGlzdGVuaW5nIiwiY2xvc2UiLCJtb2JpbGVTdG9wU2NyZWVuU3RyZWFtaW5nIiwiZTEiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsUUFBUSxHQUFHLEVBQWpCO0FBRUEsTUFBTUMsc0JBQXNCLEdBQUcsQ0FBL0I7QUFDQSxNQUFNQyw0QkFBNEIsR0FBRyxJQUFyQztBQUNBLE1BQU1DLGdCQUFnQixHQUFJLGlCQUFnQkMsc0JBQU9DLFNBQVAsS0FBcUIsTUFBckIsR0FBOEIsRUFBRyxFQUEzRTtBQUNBLE1BQU1DLGtCQUFrQixHQUFJLGtCQUFpQkYsc0JBQU9DLFNBQVAsS0FBcUIsTUFBckIsR0FBOEIsRUFBRyxFQUE5RTtBQUNBLE1BQU1FLG9CQUFvQixHQUFHO0FBQzNCQyxFQUFBQSxVQUFVLEVBQUUsV0FEZTtBQUUzQkMsRUFBQUEsU0FBUyxFQUFFLGlCQUZnQjtBQUczQkMsRUFBQUEsT0FBTyxFQUFFLGtCQUhrQjtBQUkzQkMsRUFBQUEsYUFBYSxFQUFFLGtCQUpZO0FBSzNCQyxFQUFBQSxZQUFZLEVBQUU7QUFMYSxDQUE3QjtBQU9BLE1BQU1DLG1CQUFtQixHQUFHLGNBQTVCO0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsdUVBQXpCO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLFdBQXJCO0FBQ0EsTUFBTUMsUUFBUSxHQUFHLFdBQWpCO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLElBQXJCO0FBQ0EsTUFBTUMsZUFBZSxHQUFHLEVBQXhCO0FBQ0EsTUFBTUMsZUFBZSxHQUFH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QUFNNEQsaUJBQWlCLENBQUNrRCxJQUFsQixDQUF1QixTQUF2QixDQUFOO0FBQ0QsU0FGRCxDQUVFLE9BQU9LLEVBQVAsRUFBVztBQUNYbkcsMEJBQUkyRixLQUFKLENBQVVRLEVBQVY7QUFDRDtBQUNGO0FBQ0Y7O0FBQ0RuRyxvQkFBSThCLElBQUosQ0FBVSwyREFBVjtBQUNELEdBckJELFNBcUJVO0FBQ1IsU0FBS3VDLHFCQUFMLEdBQTZCLElBQTdCO0FBQ0Q7QUFDRixDQXZDRDs7ZUEwQ2U5SCxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGZzLCBzeXN0ZW0sIGxvZ2dlciwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGV4ZWMsIFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgY2hlY2tQb3J0U3RhdHVzIH0gZnJvbSAncG9ydHNjYW5uZXInO1xuaW1wb3J0IGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgc3Bhd24gfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcblxuY29uc3QgY29tbWFuZHMgPSB7fTtcblxuY29uc3QgUkVDT1JESU5HX0lOVEVSVkFMX1NFQyA9IDU7XG5jb25zdCBTVFJFQU1JTkdfU1RBUlRVUF9USU1FT1VUX01TID0gNTAwMDtcbmNvbnN0IEdTVFJFQU1FUl9CSU5BUlkgPSBgZ3N0LWxhdW5jaC0xLjAke3N5c3RlbS5pc1dpbmRvd3MoKSA/ICcuZXhlJyA6ICcnfWA7XG5jb25zdCBHU1RfSU5TUEVDVF9CSU5BUlkgPSBgZ3N0LWluc3BlY3QtMS4wJHtzeXN0ZW0uaXNXaW5kb3dzKCkgPyAnLmV4ZScgOiAnJ31gO1xuY29uc3QgUkVRVUlSRURfR1NUX1BMVUdJTlMgPSB7XG4gIGF2ZGVjX2gyNjQ6ICdnc3QtbGliYXYnLFxuICBoMjY0cGFyc2U6ICdnc3QtcGx1Z2lucy1iYWQnLFxuICBqcGVnZW5jOiAnZ3N0LXBsdWdpbnMtZ29vZCcsXG4gIHRjcHNlcnZlcnNpbms6ICdnc3QtcGx1Z2lucy1iYXNlJyxcbiAgbXVsdGlwYXJ0bXV4OiAnZ3N0LXBsdWdpbnMtZ29vZCcsXG59O1xuY29uc3QgU0NSRUVOUkVDT1JEX0JJTkFSWSA9ICdzY3JlZW5yZWNvcmQnO1xuY29uc3QgR1NUX1RVVE9SSUFMX1VSTCA9ICdodHRwczovL2dzdHJlYW1lci5mcmVlZGVza3RvcC5vcmcvZG9jdW1lbnRhdGlvbi9pbnN0YWxsaW5nL2luZGV4Lmh0bWwnO1xuY29uc3QgREVGQVVMVF9IT1NUID0gJzEyNy4wLjAuMSc7XG5jb25zdCBUQ1BfSE9TVCA9ICcxMjcuMC4wLjEnO1xuY29uc3QgREVGQVVMVF9QT1JUID0gODA5MztcbmNvbnN0IERFRkFVTFRfUVVBTElUWSA9IDcwO1xuY29uc3QgREVGQVVMVF9CSVRSQVRFID0gNDAwMDAwMDsgLy8gNCBNYnBzXG5jb25zdCBCT1VOREFSWV9TVFJJTkcgPSAnLS0yYWU5NzQ2ODg3ZjE3MGI4Y2Y3YzI3MTA0N2NlMzE0Yyc7XG5cbmNvbnN0IEFEQl9TQ1JFRU5fU1RSRUFNSU5HX0ZFQVRVUkUgPSAnYWRiX3NjcmVlbl9zdHJlYW1pbmcnO1xuXG5mdW5jdGlvbiBjcmVhdGVTdHJlYW1pbmdMb2dnZXIgKHN0cmVhbU5hbWUsIHVkaWQpIHtcbiAgcmV0dXJuIGxvZ2dlci5nZXRMb2dnZXIoYCR7c3RyZWFtTmFtZX1AYCArIF8udHJ1bmNhdGUodWRpZCwge1xuICAgIGxlbmd0aDogOCxcbiAgICBvbWlzc2lvbjogJycsXG4gIH0pKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdmVyaWZ5U3RyZWFtaW5nUmVxdWlyZW1lbnRzIChhZGIpIHtcbiAgaWYgKCFfLnRyaW0oYXdhaXQgYWRiLnNoZWxsKFsnd2hpY2gnLCBTQ1JFRU5SRUNPUkRfQklOQVJZXSkpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYFRoZSByZXF1aXJlZCAnJHtTQ1JFRU5SRUNPUkRfQklOQVJZfScgYmluYXJ5IGlzIG5vdCBhdmFpbGFibGUgb24gdGhlIGRldmljZSB1bmRlciB0ZXN0YCk7XG4gIH1cblxuICBjb25zdCBnc3RyZWFtZXJDaGVja1Byb21pc2VzID0gW107XG4gIGZvciAoY29uc3QgYmluYXJ5TmFtZSBvZiBbR1NUUkVBTUVSX0JJTkFSWSwgR1NUX0lOU1BFQ1RfQklOQVJZXSkge1xuICAgIGdzdHJlYW1lckNoZWNrUHJvbWlzZXMucHVzaCgoYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgZnMud2hpY2goYmluYXJ5TmFtZSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlICcke2JpbmFyeU5hbWV9JyBiaW5hcnkgaXMgbm90IGF2YWlsYWJsZSBpbiB0aGUgUEFUSCBvbiB0aGUgaG9zdCBzeXN0ZW0uIGAgK1xuICAgICAgICAgIGBTZWUgJHtHU1RfVFVUT1JJQUxfVVJMfSBmb3IgbW9yZSBkZXRhaWxzIG9uIGhvdyB0byBpbnN0YWxsIGl0LmApO1xuICAgICAgfVxuICAgIH0pKCkpO1xuICB9XG4gIGF3YWl0IEIuYWxsKGdzdHJlYW1lckNoZWNrUHJvbWlzZXMpO1xuXG4gIGNvbnN0IG1vZHVsZUNoZWNrUHJvbWlzZXMgPSBbXTtcbiAgZm9yIChjb25zdCBbbmFtZSwgbW9kTmFtZV0gb2YgXy50b1BhaXJzKFJFUVVJUkVEX0dTVF9QTFVHSU5TKSkge1xuICAgIG1vZHVsZUNoZWNrUHJvbWlzZXMucHVzaCgoYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKEdTVF9JTlNQRUNUX0JJTkFSWSwgW25hbWVdKTtcbiAgICAgIGlmICghXy5pbmNsdWRlcyhzdGRvdXQsIG1vZE5hbWUpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVGhlIHJlcXVpcmVkIEdTdHJlYW1lciBwbHVnaW4gJyR7bmFtZX0nIGZyb20gJyR7bW9kTmFtZX0nIG1vZHVsZSBpcyBub3QgaW5zdGFsbGVkLiBgICtcbiAgICAgICAgICBgU2VlICR7R1NUX1RVVE9SSUFMX1VSTH0gZm9yIG1vcmUgZGV0YWlscyBvbiBob3cgdG8gaW5zdGFsbCBpdC5gKTtcbiAgICAgIH1cbiAgICB9KSgpKTtcbiAgfVxuICBhd2FpdCBCLmFsbChtb2R1bGVDaGVja1Byb21pc2VzKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RGV2aWNlSW5mbyAoYWRiKSB7XG4gIGNvbnN0IG91dHB1dCA9IGF3YWl0IGFkYi5zaGVsbChbJ2R1bXBzeXMnLCAnZGlzcGxheSddKTtcbiAgY29uc3QgcmVzdWx0ID0ge307XG4gIGZvciAoY29uc3QgW2tleSwgcGF0dGVybl0gb2YgW1xuICAgIFsnd2lkdGgnLCAvXFxiZGV2aWNlV2lkdGg9KFxcZCspL10sXG4gICAgWydoZWlnaHQnLCAvXFxiZGV2aWNlSGVpZ2h0PShcXGQrKS9dLFxuICAgIFsnZnBzJywgL1xcYmZwcz0oXFxkKykvXSxcbiAgXSkge1xuICAgIGNvbnN0IG1hdGNoID0gcGF0dGVybi5leGVjKG91dHB1dCk7XG4gICAgaWYgKCFtYXRjaCkge1xuICAgICAgbG9nLmRlYnVnKG91dHB1dCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBwYXJzZSB0aGUgZGV2aWNlICR7a2V5fSBmcm9tIHRoZSBhZGIgY29tbWFuZCBvdXRwdXQuIGAgK1xuICAgICAgICBgQ2hlY2sgdGhlIHNlcnZlciBsb2cgZm9yIG1vcmUgZGV0YWlscy5gKTtcbiAgICB9XG4gICAgcmVzdWx0W2tleV0gPSBwYXJzZUludChtYXRjaFsxXSwgMTApO1xuICB9XG4gIHJlc3VsdC51ZGlkID0gYWRiLmN1ckRldmljZUlkO1xuICByZXR1cm4gcmVzdWx0O1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbml0RGV2aWNlU3RyZWFtaW5nUHJvYyAoYWRiLCBkZXZpY2VJbmZvLCBvcHRzID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHdpZHRoLFxuICAgIGhlaWdodCxcbiAgICBiaXRSYXRlLFxuICB9ID0gb3B0cztcbiAgY29uc3QgYWRqdXN0ZWRXaWR0aCA9IHBhcnNlSW50KHdpZHRoLCAxMCkgfHwgZGV2aWNlSW5mby53aWR0aDtcbiAgY29uc3QgYWRqdXN0ZWRIZWlnaHQgPSBwYXJzZUludChoZWlnaHQsIDEwKSB8fCBkZXZpY2VJbmZvLmhlaWdodDtcbiAgY29uc3QgYWRqdXN0ZWRCaXRyYXRlID0gcGFyc2VJbnQoYml0UmF0ZSwgMTApIHx8IERFRkFVTFRfQklUUkFURTtcbiAgbGV0IHNjcmVlblJlY29yZENtZCA9IFNDUkVFTlJFQ09SRF9CSU5BUlkgK1xuICAgIGAgLS1vdXRwdXQtZm9ybWF0PWgyNjRgICtcbiAgICAvLyA1IHNlY29uZHMgaXMgZmluZSB0byBkZXRlY3Qgcm90YXRpb24gY2hhbmdlc1xuICAgIGAgLS10aW1lLWxpbWl0PSR7UkVDT1JESU5HX0lOVEVSVkFMX1NFQ31gO1xuICBpZiAod2lkdGggfHwgaGVpZ2h0KSB7XG4gICAgc2NyZWVuUmVjb3JkQ21kICs9IGAgLS1zaXplPSR7YWRqdXN0ZWRXaWR0aH14JHthZGp1c3RlZEhlaWdodH1gO1xuICB9XG4gIGlmIChiaXRSYXRlKSB7XG4gICAgc2NyZWVuUmVjb3JkQ21kICs9IGAgLS1iaXQtcmF0ZT0ke2FkanVzdGVkQml0cmF0ZX1gO1xuICB9XG4gIGNvbnN0IGFkYkFyZ3MgPSBbXG4gICAgLi4uYWRiLmV4ZWN1dGFibGUuZGVmYXVsdEFyZ3MsXG4gICAgJ2V4ZWMtb3V0JyxcbiAgICAvLyBUaGUgbG9vcCBpcyByZXF1aXJlZCwgYmVjYXVzZSBieSBkZWZhdWx0IHRoZSBtYXhpbXVtIHJlY29yZCBkdXJhdGlvblxuICAgIC8vIGZvciBzY3JlZW5yZWNvcmQgaXMgYWx3YXlzIGxpbWl0ZWRcbiAgICBgd2hpbGUgdHJ1ZTsgZG8gJHtzY3JlZW5SZWNvcmRDbWR9IC07IGRvbmVgLFxuICBdO1xuICBjb25zdCBkZXZpY2VTdHJlYW1pbmcgPSBzcGF3bihhZGIuZXhlY3V0YWJsZS5wYXRoLCBhZGJBcmdzKTtcbiAgZGV2aWNlU3RyZWFtaW5nLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgIGxvZy5kZWJ1ZyhgRGV2aWNlIHN0cmVhbWluZyBwcm9jZXNzIGV4aXRlZCB3aXRoIGNvZGUgJHtjb2RlfSwgc2lnbmFsICR7c2lnbmFsfWApO1xuICB9KTtcblxuICBsZXQgaXNTdGFydGVkID0gZmFsc2U7XG4gIGNvbnN0IGRldmljZVN0cmVhbWluZ0xvZ2dlciA9IGNyZWF0ZVN0cmVhbWluZ0xvZ2dlcihTQ1JFRU5SRUNPUkRfQklOQVJZLCBkZXZpY2VJbmZvLnVkaWQpO1xuICBjb25zdCBlcnJvcnNMaXN0ZW5lciA9IChjaHVuaykgPT4ge1xuICAgIGNvbnN0IHN0ZGVyciA9IGNodW5rLnRvU3RyaW5nKCk7XG4gICAgaWYgKF8udHJpbShzdGRlcnIpKSB7XG4gICAgICBkZXZpY2VTdHJlYW1pbmdMb2dnZXIuZGVidWcoc3RkZXJyKTtcbiAgICB9XG4gIH07XG4gIGRldmljZVN0cmVhbWluZy5zdGRlcnIub24oJ2RhdGEnLCBlcnJvcnNMaXN0ZW5lcik7XG5cbiAgY29uc3Qgc3RhcnR1cExpc3RlbmVyID0gKGNodW5rKSA9PiB7XG4gICAgaWYgKCFpc1N0YXJ0ZWQpIHtcbiAgICAgIGlzU3RhcnRlZCA9ICFfLmlzRW1wdHkoY2h1bmspO1xuICAgIH1cbiAgfTtcbiAgZGV2aWNlU3RyZWFtaW5nLnN0ZG91dC5vbignZGF0YScsIHN0YXJ0dXBMaXN0ZW5lcik7XG5cbiAgdHJ5IHtcbiAgICBsb2cuaW5mbyhgU3RhcnRpbmcgZGV2aWNlIHN0cmVhbWluZzogJHt1dGlsLnF1b3RlKFthZGIuZXhlY3V0YWJsZS5wYXRoLCAuLi5hZGJBcmdzXSl9YCk7XG4gICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbigoKSA9PiBpc1N0YXJ0ZWQsIHtcbiAgICAgIHdhaXRNczogU1RSRUFNSU5HX1NUQVJUVVBfVElNRU9VVF9NUyxcbiAgICAgIGludGVydmFsTXM6IDMwMCxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KFxuICAgICAgYENhbm5vdCBzdGFydCB0aGUgc2NyZWVuIHN0cmVhbWluZyBwcm9jZXNzLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gIH0gZmluYWxseSB7XG4gICAgZGV2aWNlU3RyZWFtaW5nLnN0ZGVyci5yZW1vdmVMaXN0ZW5lcignZGF0YScsIGVycm9yc0xpc3RlbmVyKTtcbiAgICBkZXZpY2VTdHJlYW1pbmcuc3Rkb3V0LnJlbW92ZUxpc3RlbmVyKCdkYXRhJywgc3RhcnR1cExpc3RlbmVyKTtcbiAgfVxuICByZXR1cm4gZGV2aWNlU3RyZWFtaW5nO1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbml0R3N0cmVhbWVyUGlwZWxpbmUgKGRldmljZVN0cmVhbWluZ1Byb2MsIGRldmljZUluZm8sIG9wdHMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgd2lkdGgsXG4gICAgaGVpZ2h0LFxuICAgIHF1YWxpdHksXG4gICAgdGNwUG9ydCxcbiAgICBjb25zaWRlclJvdGF0aW9uLFxuICAgIGxvZ1BpcGVsaW5lRGV0YWlscyxcbiAgfSA9IG9wdHM7XG4gIGNvbnN0IGFkanVzdGVkV2lkdGggPSBwYXJzZUludCh3aWR0aCwgMTApIHx8IGRldmljZUluZm8ud2lkdGg7XG4gIGNvbnN0IGFkanVzdGVkSGVpZ2h0ID0gcGFyc2VJbnQoaGVpZ2h0LCAxMCkgfHwgZGV2aWNlSW5mby5oZWlnaHQ7XG4gIGNvbnN0IGdzdHJlYW1lclBpcGVsaW5lID0gbmV3IFN1YlByb2Nlc3MoR1NUUkVBTUVSX0JJTkFSWSwgW1xuICAgICctdicsXG4gICAgJ2Zkc3JjJywgJ2ZkPTAnLFxuICAgICchJywgJ3ZpZGVvL3gtaDI2NCwnICtcbiAgICAgIGB3aWR0aD0ke2NvbnNpZGVyUm90YXRpb24gPyBNYXRoLm1heChhZGp1c3RlZFdpZHRoLCBhZGp1c3RlZEhlaWdodCkgOiBhZGp1c3RlZFdpZHRofSxgICtcbiAgICAgIGBoZWlnaHQ9JHtjb25zaWRlclJvdGF0aW9uID8gTWF0aC5tYXgoYWRqdXN0ZWRXaWR0aCwgYWRqdXN0ZWRIZWlnaHQpIDogYWRqdXN0ZWRIZWlnaHR9LGAgK1xuICAgICAgYGZyYW1lcmF0ZT0ke2RldmljZUluZm8uZnBzfS8xLGAgK1xuICAgICAgJ2J5dGUtc3RyZWFtPXRydWUnLFxuICAgICchJywgJ2gyNjRwYXJzZScsXG4gICAgJyEnLCAncXVldWUnLCAnbGVha3k9ZG93bnN0cmVhbScsXG4gICAgJyEnLCAnYXZkZWNfaDI2NCcsXG4gICAgJyEnLCAncXVldWUnLCAnbGVha3k9ZG93bnN0cmVhbScsXG4gICAgJyEnLCAnanBlZ2VuYycsIGBxdWFsaXR5PSR7cXVhbGl0eX1gLFxuICAgICchJywgJ211bHRpcGFydG11eCcsIGBib3VuZGFyeT0ke0JPVU5EQVJZX1NUUklOR31gLFxuICAgICchJywgJ3RjcHNlcnZlcnNpbmsnLCBgaG9zdD0ke1RDUF9IT1NUfWAsIGBwb3J0PSR7dGNwUG9ydH1gLFxuICBdLCB7XG4gICAgc3RkaW86IFtkZXZpY2VTdHJlYW1pbmdQcm9jLnN0ZG91dCwgJ3BpcGUnLCAncGlwZSddXG4gIH0pO1xuICBnc3RyZWFtZXJQaXBlbGluZS5vbignZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICBsb2cuZGVidWcoYFBpcGVsaW5lIHN0cmVhbWluZyBwcm9jZXNzIGV4aXRlZCB3aXRoIGNvZGUgJHtjb2RlfSwgc2lnbmFsICR7c2lnbmFsfWApO1xuICB9KTtcbiAgY29uc3QgZ3N0cmVhbWVyTG9nZ2VyID0gY3JlYXRlU3RyZWFtaW5nTG9nZ2VyKCdnc3QnLCBkZXZpY2VJbmZvLnVkaWQpO1xuICBjb25zdCBnc3RPdXRwdXRMaXN0ZW5lciA9IChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgIGlmIChfLnRyaW0oc3RkZXJyIHx8IHN0ZG91dCkpIHtcbiAgICAgIGdzdHJlYW1lckxvZ2dlci5kZWJ1ZyhzdGRlcnIgfHwgc3Rkb3V0KTtcbiAgICB9XG4gIH07XG4gIGdzdHJlYW1lclBpcGVsaW5lLm9uKCdvdXRwdXQnLCBnc3RPdXRwdXRMaXN0ZW5lcik7XG4gIGxldCBkaWRGYWlsID0gZmFsc2U7XG4gIHRyeSB7XG4gICAgbG9nLmluZm8oYFN0YXJ0aW5nIEdTdHJlYW1lciBwaXBlbGluZTogJHtnc3RyZWFtZXJQaXBlbGluZS5yZXB9YCk7XG4gICAgYXdhaXQgZ3N0cmVhbWVyUGlwZWxpbmUuc3RhcnQoMCk7XG4gICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gKGF3YWl0IGNoZWNrUG9ydFN0YXR1cyh0Y3BQb3J0LCBUQ1BfSE9TVCkpID09PSAnb3Blbic7XG4gICAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0sIHtcbiAgICAgIHdhaXRNczogU1RSRUFNSU5HX1NUQVJUVVBfVElNRU9VVF9NUyxcbiAgICAgIGludGVydmFsTXM6IDMwMCxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGRpZEZhaWwgPSB0cnVlO1xuICAgIGxvZy5lcnJvckFuZFRocm93KFxuICAgICAgYENhbm5vdCBzdGFydCB0aGUgc2NyZWVuIHN0cmVhbWluZyBwaXBlbGluZS4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICB9IGZpbmFsbHkge1xuICAgIGlmICghbG9nUGlwZWxpbmVEZXRhaWxzIHx8IGRpZEZhaWwpIHtcbiAgICAgIGdzdHJlYW1lclBpcGVsaW5lLnJlbW92ZUxpc3RlbmVyKCdvdXRwdXQnLCBnc3RPdXRwdXRMaXN0ZW5lcik7XG4gICAgfVxuICB9XG4gIHJldHVybiBnc3RyZWFtZXJQaXBlbGluZTtcbn1cblxuZnVuY3Rpb24gZXh0cmFjdFJlbW90ZUFkZHJlc3MgKHJlcSkge1xuICByZXR1cm4gcmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWZvciddXG4gICAgfHwgcmVxLnNvY2tldC5yZW1vdGVBZGRyZXNzXG4gICAgfHwgcmVxLmNvbm5lY3Rpb24ucmVtb3RlQWRkcmVzc1xuICAgIHx8IHJlcS5jb25uZWN0aW9uLnNvY2tldC5yZW1vdGVBZGRyZXNzO1xufVxuXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RhcnRTY3JlZW5TdHJlYW1pbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/bnVtYmVyfSB3aWR0aCAtIFRoZSBzY2FsZWQgd2lkdGggb2YgdGhlIGRldmljZSdzIHNjcmVlbi4gSWYgdW5zZXQgdGhlbiB0aGUgc2NyaXB0IHdpbGwgYXNzaWduIGl0XG4gKiB0byB0aGUgYWN0dWFsIHNjcmVlbiB3aWR0aCBtZWFzdXJlZCBpbiBwaXhlbHMuXG4gKiBAcHJvcGVydHkgez9udW1iZXJ9IGhlaWdodCAtIFRoZSBzY2FsZWQgaGVpZ2h0IG9mIHRoZSBkZXZpY2UncyBzY3JlZW4uIElmIHVuc2V0IHRoZW4gdGhlIHNjcmlwdCB3aWxsIGFzc2lnbiBpdFxuICogdG8gdGhlIGFjdHVhbCBzY3JlZW4gaGVpZ2h0IG1lYXN1cmVkIGluIHBpeGVscy5cbiAqIEBwcm9wZXJ0eSB7P251bWJlcn0gYml0UmF0ZSAtIFRoZSB2aWRlbyBiaXQgcmF0ZSBmb3IgdGhlIHZpZGVvLCBpbiBiaXRzIHBlciBzZWNvbmQuXG4gKiBUaGUgZGVmYXVsdCB2YWx1ZSBpcyA0MDAwMDAwICg0IE1iL3MpLiBZb3UgY2FuIGluY3JlYXNlIHRoZSBiaXQgcmF0ZSB0byBpbXByb3ZlIHZpZGVvIHF1YWxpdHksXG4gKiBidXQgZG9pbmcgc28gcmVzdWx0cyBpbiBsYXJnZXIgbW92aWUgZmlsZXMuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IGhvc3QgWzEyNy4wLjAuMV0gLSBUaGUgSVAgYWRkcmVzcy9ob3N0IG5hbWUgdG8gc3RhcnQgdGhlIE1KUEVHIHNlcnZlciBvbi5cbiAqIFlvdSBjYW4gc2V0IGl0IHRvIGAwLjAuMC4wYCB0byB0cmlnZ2VyIHRoZSBicm9hZGNhc3Qgb24gYWxsIGF2YWlsYWJsZSBuZXR3b3JrIGludGVyZmFjZXMuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBhdGhuYW1lIC0gVGhlIEhUVFAgcmVxdWVzdCBwYXRoIHRoZSBNSlBFRyBzZXJ2ZXIgc2hvdWxkIGJlIGF2YWlsYWJsZSBvbi5cbiAqIElmIHVuc2V0IHRoZW4gYW55IHBhdGhuYW1lIG9uIHRoZSBnaXZlbiBgaG9zdGAvYHBvcnRgIGNvbWJpbmF0aW9uIHdpbGwgd29yay4gTm90ZSB0aGF0IHRoZSB2YWx1ZVxuICogc2hvdWxkIGFsd2F5cyBzdGFydCB3aXRoIGEgc2luZ2xlIHNsYXNoOiBgL2BcbiAqIEBwcm9wZXJ0eSB7P251bWJlcn0gdGNwUG9ydCBbODA5NF0gLSBUaGUgcG9ydCBudW1iZXIgdG8gc3RhcnQgdGhlIGludGVybmFsIFRDUCBNSlBFRyBicm9hZGNhc3Qgb24uXG4gKiBUaGlzIHR5cGUgb2YgYnJvYWRjYXN0IGFsd2F5cyBzdGFydHMgb24gdGhlIGxvb3BiYWNrIGludGVyZmFjZSAoYDEyNy4wLjAuMWApLlxuICogQHByb3BlcnR5IHs/bnVtYmVyfSBwb3J0IFs4MDkzXSAtIFRoZSBwb3J0IG51bWJlciB0byBzdGFydCB0aGUgTUpQRUcgc2VydmVyIG9uLlxuICogQHByb3BlcnR5IHs/bnVtYmVyfSBxdWFsaXR5IFs3MF0gLSBUaGUgcXVhbGl0eSB2YWx1ZSBmb3IgdGhlIHN0cmVhbWVkIEpQRUcgaW1hZ2VzLlxuICogVGhpcyBudW1iZXIgc2hvdWxkIGJlIGluIHJhbmdlIFsxLCAxMDBdLCB3aGVyZSAxMDAgaXMgdGhlIGJlc3QgcXVhbGl0eS5cbiAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IGNvbnNpZGVyUm90YXRpb24gW2ZhbHNlXSAtIElmIHNldCB0byBgdHJ1ZWAgdGhlbiBHU3RyZWFtZXIgcGlwZWxpbmUgd2lsbFxuICogaW5jcmVhc2UgdGhlIGRpbWVuc2lvbnMgb2YgdGhlIHJlc3VsdGluZyBpbWFnZXMgdG8gcHJvcGVybHkgZml0IGltYWdlcyBpbiBib3RoIGxhbmRzY2FwZSBhbmRcbiAqIHBvcnRyYWl0IG9yaWVudGF0aW9ucy4gU2V0IGl0IHRvIGB0cnVlYCBpZiB0aGUgZGV2aWNlIHJvdGF0aW9uIGlzIG5vdCBnb2luZyB0byBiZSB0aGUgc2FtZSBkdXJpbmcgdGhlXG4gKiBicm9hZGNhc3Rpbmcgc2Vzc2lvbi5cbiAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IGxvZ1BpcGVsaW5lRGV0YWlscyBbZmFsc2VdIC0gV2hldGhlciB0byBsb2cgR1N0cmVhbWVyIHBpcGVsaW5lIGV2ZW50cyBpbnRvXG4gKiB0aGUgc3RhbmRhcmQgbG9nIG91dHB1dC4gTWlnaHQgYmUgdXNlZnVsIGZvciBkZWJ1Z2dpbmcgcHVycG9zZXMuXG4gKi9cblxuLyoqXG4gKiBTdGFydHMgZGV2aWNlIHNjcmVlbiBicm9hZGNhc3QgYnkgY3JlYXRpbmcgTUpQRUcgc2VydmVyLlxuICogTXVsdGlwbGUgY2FsbHMgdG8gdGhpcyBtZXRob2QgaGF2ZSBubyBlZmZlY3QgdW5sZXNzIHRoZSBwcmV2aW91cyBzdHJlYW1pbmdcbiAqIHNlc3Npb24gaXMgc3RvcHBlZC5cbiAqIFRoaXMgbWV0aG9kIG9ubHkgd29ya3MgaWYgdGhlIGBhZGJfc2NyZWVuX3N0cmVhbWluZ2AgZmVhdHVyZSBpc1xuICogZW5hYmxlZCBvbiB0aGUgc2VydmVyIHNpZGUuXG4gKlxuICogQHBhcmFtIHs/U3RhcnRTY3JlZW5TdHJlYW1pbmdPcHRpb25zfSBvcHRpb25zIC0gVGhlIGF2YWlsYWJsZSBvcHRpb25zLlxuICogQHRocm93cyB7RXJyb3J9IElmIHNjcmVlbiBzdHJlYW1pbmcgaGFzIGZhaWxlZCB0byBzdGFydCBvclxuICogaXMgbm90IHN1cHBvcnRlZCBvbiB0aGUgaG9zdCBzeXN0ZW0gb3JcbiAqIHRoZSBjb3JyZXNwb25kaW5nIHNlcnZlciBmZWF0dXJlIGlzIG5vdCBlbmFibGVkLlxuICovXG5jb21tYW5kcy5tb2JpbGVTdGFydFNjcmVlblN0cmVhbWluZyA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVN0YXJ0U2NyZWVuU3RyZWFtaW5nIChvcHRpb25zID0ge30pIHtcbiAgdGhpcy5lbnN1cmVGZWF0dXJlRW5hYmxlZChBREJfU0NSRUVOX1NUUkVBTUlOR19GRUFUVVJFKTtcblxuICBjb25zdCB7XG4gICAgd2lkdGgsXG4gICAgaGVpZ2h0LFxuICAgIGJpdFJhdGUsXG4gICAgaG9zdCA9IERFRkFVTFRfSE9TVCxcbiAgICBwb3J0ID0gREVGQVVMVF9QT1JULFxuICAgIHBhdGhuYW1lLFxuICAgIHRjcFBvcnQgPSBERUZBVUxUX1BPUlQgKyAxLFxuICAgIHF1YWxpdHkgPSBERUZBVUxUX1FVQUxJVFksXG4gICAgY29uc2lkZXJSb3RhdGlvbiA9IGZhbHNlLFxuICAgIGxvZ1BpcGVsaW5lRGV0YWlscyA9IGZhbHNlLFxuICB9ID0gb3B0aW9ucztcblxuICBpZiAoXy5pc1VuZGVmaW5lZCh0aGlzLl9zY3JlZW5TdHJlYW1pbmdQcm9wcykpIHtcbiAgICBhd2FpdCB2ZXJpZnlTdHJlYW1pbmdSZXF1aXJlbWVudHModGhpcy5hZGIpO1xuICB9XG4gIGlmICghXy5pc0VtcHR5KHRoaXMuX3NjcmVlblN0cmVhbWluZ1Byb3BzKSkge1xuICAgIGxvZy5pbmZvKGBUaGUgc2NyZWVuIHN0cmVhbWluZyBzZXNzaW9uIGlzIGFscmVhZHkgcnVubmluZy4gYCArXG4gICAgICBgU3RvcCBpdCBmaXJzdCBpbiBvcmRlciB0byBzdGFydCBhIG5ldyBvbmUuYCk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGlmICgoYXdhaXQgY2hlY2tQb3J0U3RhdHVzKHBvcnQsIGhvc3QpKSA9PT0gJ29wZW4nKSB7XG4gICAgbG9nLmluZm8oYFRoZSBwb3J0ICMke3BvcnR9IGF0ICR7aG9zdH0gaXMgYnVzeS4gYCArXG4gICAgICBgQXNzdW1pbmcgdGhlIHNjcmVlbiBzdHJlYW1pbmcgaXMgYWxyZWFkeSBydW5uaW5nYCk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGlmICgoYXdhaXQgY2hlY2tQb3J0U3RhdHVzKHRjcFBvcnQsIFRDUF9IT1NUKSkgPT09ICdvcGVuJykge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgcG9ydCAjJHt0Y3BQb3J0fSBhdCAke1RDUF9IT1NUfSBpcyBidXN5LiBgICtcbiAgICAgIGBNYWtlIHN1cmUgdGhlcmUgYXJlIG5vIGxlZnRvdmVycyBmcm9tIHByZXZpb3VzIHNlc3Npb25zLmApO1xuICB9XG4gIHRoaXMuX3NjcmVlblN0cmVhbWluZ1Byb3BzID0gbnVsbDtcblxuICBjb25zdCBkZXZpY2VJbmZvID0gYXdhaXQgZ2V0RGV2aWNlSW5mbyh0aGlzLmFkYik7XG4gIGNvbnN0IGRldmljZVN0cmVhbWluZ1Byb2MgPSBhd2FpdCBpbml0RGV2aWNlU3RyZWFtaW5nUHJvYyh0aGlzLmFkYiwgZGV2aWNlSW5mbywge1xuICAgIHdpZHRoLFxuICAgIGhlaWdodCxcbiAgICBiaXRSYXRlLFxuICB9KTtcbiAgbGV0IGdzdHJlYW1lclBpcGVsaW5lO1xuICB0cnkge1xuICAgIGdzdHJlYW1lclBpcGVsaW5lID0gYXdhaXQgaW5pdEdzdHJlYW1lclBpcGVsaW5lKGRldmljZVN0cmVhbWluZ1Byb2MsIGRldmljZUluZm8sIHtcbiAgICAgIHdpZHRoLFxuICAgICAgaGVpZ2h0LFxuICAgICAgcXVhbGl0eSxcbiAgICAgIHRjcFBvcnQsXG4gICAgICBjb25zaWRlclJvdGF0aW9uLFxuICAgICAgbG9nUGlwZWxpbmVEZXRhaWxzLFxuICAgIH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGRldmljZVN0cmVhbWluZ1Byb2Mua2lsbCgwKSkge1xuICAgICAgZGV2aWNlU3RyZWFtaW5nUHJvYy5raWxsKCk7XG4gICAgfVxuICAgIHRocm93IGU7XG4gIH1cblxuICBsZXQgbWpwZWdTb2NrZXQ7XG4gIGxldCBtanBlZ1NlcnZlcjtcbiAgdHJ5IHtcbiAgICBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBtanBlZ1NvY2tldCA9IG5ldC5jcmVhdGVDb25uZWN0aW9uKHRjcFBvcnQsIFRDUF9IT1NULCAoKSA9PiB7XG4gICAgICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgY29ubmVjdGVkIHRvIE1KUEVHIHN0cmVhbSBhdCB0Y3A6Ly8ke1RDUF9IT1NUfToke3RjcFBvcnR9YCk7XG4gICAgICAgIG1qcGVnU2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoKHJlcSwgcmVzKSA9PiB7XG4gICAgICAgICAgY29uc3QgcmVtb3RlQWRkcmVzcyA9IGV4dHJhY3RSZW1vdGVBZGRyZXNzKHJlcSk7XG4gICAgICAgICAgY29uc3QgY3VycmVudFBhdGhuYW1lID0gdXJsLnBhcnNlKHJlcS51cmwpLnBhdGhuYW1lO1xuICAgICAgICAgIGxvZy5pbmZvKGBHb3QgYW4gaW5jb21pbmcgc2NyZWVuIGJyYWRjYXN0aW5nIHJlcXVlc3QgZnJvbSAke3JlbW90ZUFkZHJlc3N9IGAgK1xuICAgICAgICAgICAgYCgke3JlcS5oZWFkZXJzWyd1c2VyLWFnZW50J10gfHwgJ1VzZXIgQWdlbnQgdW5rbm93bid9KSBhdCAke2N1cnJlbnRQYXRobmFtZX1gKTtcblxuICAgICAgICAgIGlmIChwYXRobmFtZSAmJiBjdXJyZW50UGF0aG5hbWUgIT09IHBhdGhuYW1lKSB7XG4gICAgICAgICAgICBsb2cuaW5mbygnUmVqZWN0aW5nIHRoZSBicm9hZGNhc3QgcmVxdWVzdCBzaW5jZSBpdCBkb2VzIG5vdCBtYXRjaCB0aGUgZ2l2ZW4gcGF0aG5hbWUnKTtcbiAgICAgICAgICAgIHJlcy53cml0ZUhlYWQoNDA0LCB7XG4gICAgICAgICAgICAgIENvbm5lY3Rpb246ICdjbG9zZScsXG4gICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAndGV4dC9wbGFpbjsgY2hhcnNldD11dGYtOCcsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJlcy53cml0ZShgJyR7Y3VycmVudFBhdGhuYW1lfScgZGlkIG5vdCBtYXRjaCBhbnkga25vd24gZW5kcG9pbnRzYCk7XG4gICAgICAgICAgICByZXMuZW5kKCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgbG9nLmluZm8oJ1N0YXJ0aW5nIE1KUEVHIGJyb2FkY2FzdCcpO1xuICAgICAgICAgIHJlcy53cml0ZUhlYWQoMjAwLCB7XG4gICAgICAgICAgICAnQ2FjaGUtQ29udHJvbCc6ICduby1zdG9yZSwgbm8tY2FjaGUsIG11c3QtcmV2YWxpZGF0ZSwgcHJlLWNoZWNrPTAsIHBvc3QtY2hlY2s9MCwgbWF4LWFnZT0wJyxcbiAgICAgICAgICAgIFByYWdtYTogJ25vLWNhY2hlJyxcbiAgICAgICAgICAgIENvbm5lY3Rpb246ICdjbG9zZScsXG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogYG11bHRpcGFydC94LW1peGVkLXJlcGxhY2U7IGJvdW5kYXJ5PSR7Qk9VTkRBUllfU1RSSU5HfWBcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIG1qcGVnU29ja2V0LnBpcGUocmVzKTtcbiAgICAgICAgfSk7XG4gICAgICAgIG1qcGVnU2VydmVyLm9uKCdlcnJvcicsIChlKSA9PiB7XG4gICAgICAgICAgbG9nLndhcm4oZSk7XG4gICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICB9KTtcbiAgICAgICAgbWpwZWdTZXJ2ZXIub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgTUpQRUcgc2VydmVyIGF0IGh0dHA6Ly8ke2hvc3R9OiR7cG9ydH0gaGFzIGJlZW4gY2xvc2VkYCk7XG4gICAgICAgIH0pO1xuICAgICAgICBtanBlZ1NlcnZlci5vbignbGlzdGVuaW5nJywgKCkgPT4ge1xuICAgICAgICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgc3RhcnRlZCBNSlBFRyBzZXJ2ZXIgYXQgaHR0cDovLyR7aG9zdH06JHtwb3J0fWApO1xuICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIG1qcGVnU2VydmVyLmxpc3Rlbihwb3J0LCBob3N0KTtcbiAgICAgIH0pO1xuICAgICAgbWpwZWdTb2NrZXQub24oJ2Vycm9yJywgKGUpID0+IHtcbiAgICAgICAgbG9nLmVycm9yKGUpO1xuICAgICAgICByZWplY3QoZSk7XG4gICAgICB9KTtcbiAgICB9KS50aW1lb3V0KFNUUkVBTUlOR19TVEFSVFVQX1RJTUVPVVRfTVMsXG4gICAgICBgQ2Fubm90IGNvbm5lY3QgdG8gdGhlIHN0cmVhbWluZyBzZXJ2ZXIgd2l0aGluICR7U1RSRUFNSU5HX1NUQVJUVVBfVElNRU9VVF9NU31tc2ApO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGRldmljZVN0cmVhbWluZ1Byb2Mua2lsbCgwKSkge1xuICAgICAgZGV2aWNlU3RyZWFtaW5nUHJvYy5raWxsKCk7XG4gICAgfVxuICAgIGlmIChnc3RyZWFtZXJQaXBlbGluZS5pc1J1bm5pbmcpIHtcbiAgICAgIGF3YWl0IGdzdHJlYW1lclBpcGVsaW5lLnN0b3AoKTtcbiAgICB9XG4gICAgaWYgKG1qcGVnU29ja2V0KSB7XG4gICAgICBtanBlZ1NvY2tldC5kZXN0cm95KCk7XG4gICAgfVxuICAgIGlmIChtanBlZ1NlcnZlciAmJiBtanBlZ1NlcnZlci5saXN0ZW5pbmcpIHtcbiAgICAgIG1qcGVnU2VydmVyLmNsb3NlKCk7XG4gICAgfVxuICAgIHRocm93IGU7XG4gIH1cblxuICB0aGlzLl9zY3JlZW5TdHJlYW1pbmdQcm9wcyA9IHtcbiAgICBkZXZpY2VTdHJlYW1pbmdQcm9jLFxuICAgIGdzdHJlYW1lclBpcGVsaW5lLFxuICAgIG1qcGVnU29ja2V0LFxuICAgIG1qcGVnU2VydmVyLFxuICB9O1xufTtcblxuLyoqXG4gKiBTdG9wIHNjcmVlbiBzdHJlYW1pbmcuXG4gKiBJZiBubyBzY3JlZW4gc3RyZWFtaW5nIHNlcnZlciBoYXMgYmVlbiBzdGFydGVkIHRoZW4gbm90aGluZyBpcyBkb25lLlxuICovXG5jb21tYW5kcy5tb2JpbGVTdG9wU2NyZWVuU3RyZWFtaW5nID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlU3RvcFNjcmVlblN0cmVhbWluZyAoLyogb3B0aW9ucyA9IHt9ICovKSB7XG4gIGlmIChfLmlzRW1wdHkodGhpcy5fc2NyZWVuU3RyZWFtaW5nUHJvcHMpKSB7XG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKHRoaXMuX3NjcmVlblN0cmVhbWluZ1Byb3BzKSkge1xuICAgICAgbG9nLmRlYnVnKGBTY3JlZW4gc3RyZWFtaW5nIGlzIG5vdCBydW5uaW5nLiBUaGVyZSBpcyBub3RoaW5nIHRvIHN0b3BgKTtcbiAgICB9XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIGRldmljZVN0cmVhbWluZ1Byb2MsXG4gICAgZ3N0cmVhbWVyUGlwZWxpbmUsXG4gICAgbWpwZWdTb2NrZXQsXG4gICAgbWpwZWdTZXJ2ZXIsXG4gIH0gPSB0aGlzLl9zY3JlZW5TdHJlYW1pbmdQcm9wcztcblxuICB0cnkge1xuICAgIG1qcGVnU29ja2V0LmVuZCgpO1xuICAgIGlmIChtanBlZ1NlcnZlci5saXN0ZW5pbmcpIHtcbiAgICAgIG1qcGVnU2VydmVyLmNsb3NlKCk7XG4gICAgfVxuICAgIGlmIChkZXZpY2VTdHJlYW1pbmdQcm9jLmtpbGwoMCkpIHtcbiAgICAgIGRldmljZVN0cmVhbWluZ1Byb2Mua2lsbCgnU0lHSU5UJyk7XG4gICAgfVxuICAgIGlmIChnc3RyZWFtZXJQaXBlbGluZS5pc1J1bm5pbmcpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGdzdHJlYW1lclBpcGVsaW5lLnN0b3AoJ1NJR0lOVCcpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cud2FybihlKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBnc3RyZWFtZXJQaXBlbGluZS5zdG9wKCdTSUdLSUxMJyk7XG4gICAgICAgIH0gY2F0Y2ggKGUxKSB7XG4gICAgICAgICAgbG9nLmVycm9yKGUxKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IHRlcm1pbmF0ZWQgdGhlIHNjcmVlbiBzdHJlYW1pbmcgTUpQRUcgc2VydmVyYCk7XG4gIH0gZmluYWxseSB7XG4gICAgdGhpcy5fc2NyZWVuU3RyZWFtaW5nUHJvcHMgPSBudWxsO1xuICB9XG59O1xuXG5cbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvc3RyZWFtc2NyZWVuLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
