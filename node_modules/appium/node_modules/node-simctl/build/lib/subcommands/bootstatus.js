"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _asyncbox = require("asyncbox");

const commands = {};

commands.startBootMonitor = async function startBootMonitor(opts = {}) {
  const {
    timeout = 240000,
    onWaitingDataMigration,
    onWaitingSystemApp,
    onFinished,
    onError
  } = opts;
  const udid = this.requireUdid('bootstatus');
  let status = '';
  let isBootingFinished = false;
  let error = null;
  let timeoutHandler = null;
  const bootMonitor = await this.exec('bootstatus', {
    args: [udid],
    asynchronous: true
  });
  bootMonitor.on('output', (stdout, stderr) => {
    status += stdout || stderr;

    if (stdout) {
      if (stdout.includes('Waiting on Data Migration') && onWaitingDataMigration) {
        onWaitingDataMigration();
      } else if (stdout.includes('Waiting on System App') && onWaitingSystemApp) {
        onWaitingSystemApp();
      }
    }
  });
  bootMonitor.on('exit', (code, signal) => {
    if (timeoutHandler) {
      clearTimeout(timeoutHandler);
    }

    if (code === 0) {
      if (onFinished) {
        onFinished();
      }

      isBootingFinished = true;
    } else {
      status = status || signal;
      error = new Error(status);

      if (onError) {
        onError(error);
      }
    }
  });
  await bootMonitor.start(0);

  const stopMonitor = async () => {
    if (bootMonitor.isRunning) {
      try {
        await bootMonitor.stop();
      } catch (e) {
        _logger.default.warn(e.message);
      }
    }
  };

  const start = process.hrtime();

  if (onFinished) {
    timeoutHandler = setTimeout(stopMonitor, timeout);
  } else {
    try {
      await (0, _asyncbox.waitForCondition)(() => {
        if (error) {
          throw error;
        }

        return isBootingFinished;
      }, {
        waitMs: timeout,
        intervalMs: 500
      });
    } catch (err) {
      await stopMonitor();
      const [seconds] = process.hrtime(start);
      throw new Error(`The simulator ${udid} has failed to finish booting after ${seconds}s. ` + `Original status: ${status}`);
    }
  }

  return bootMonitor;
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zdWJjb21tYW5kcy9ib290c3RhdHVzLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwic3RhcnRCb290TW9uaXRvciIsIm9wdHMiLCJ0aW1lb3V0Iiwib25XYWl0aW5nRGF0YU1pZ3JhdGlvbiIsIm9uV2FpdGluZ1N5c3RlbUFwcCIsIm9uRmluaXNoZWQiLCJvbkVycm9yIiwidWRpZCIsInJlcXVpcmVVZGlkIiwic3RhdHVzIiwiaXNCb290aW5nRmluaXNoZWQiLCJlcnJvciIsInRpbWVvdXRIYW5kbGVyIiwiYm9vdE1vbml0b3IiLCJleGVjIiwiYXJncyIsImFzeW5jaHJvbm91cyIsIm9uIiwic3Rkb3V0Iiwic3RkZXJyIiwiaW5jbHVkZXMiLCJjb2RlIiwic2lnbmFsIiwiY2xlYXJUaW1lb3V0IiwiRXJyb3IiLCJzdGFydCIsInN0b3BNb25pdG9yIiwiaXNSdW5uaW5nIiwic3RvcCIsImUiLCJsb2ciLCJ3YXJuIiwibWVzc2FnZSIsInByb2Nlc3MiLCJocnRpbWUiLCJzZXRUaW1lb3V0Iiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImVyciIsInNlY29uZHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBR0EsTUFBTUEsUUFBUSxHQUFHLEVBQWpCOztBQXdCQUEsUUFBUSxDQUFDQyxnQkFBVCxHQUE0QixlQUFlQSxnQkFBZixDQUFpQ0MsSUFBSSxHQUFHLEVBQXhDLEVBQTRDO0FBQ3RFLFFBQU07QUFDSkMsSUFBQUEsT0FBTyxHQUFHLE1BRE47QUFFSkMsSUFBQUEsc0JBRkk7QUFHSkMsSUFBQUEsa0JBSEk7QUFJSkMsSUFBQUEsVUFKSTtBQUtKQyxJQUFBQTtBQUxJLE1BTUZMLElBTko7QUFPQSxRQUFNTSxJQUFJLEdBQUcsS0FBS0MsV0FBTCxDQUFpQixZQUFqQixDQUFiO0FBRUEsTUFBSUMsTUFBTSxHQUFHLEVBQWI7QUFDQSxNQUFJQyxpQkFBaUIsR0FBRyxLQUF4QjtBQUNBLE1BQUlDLEtBQUssR0FBRyxJQUFaO0FBQ0EsTUFBSUMsY0FBYyxHQUFHLElBQXJCO0FBQ0EsUUFBTUMsV0FBVyxHQUFHLE1BQU0sS0FBS0MsSUFBTCxDQUFVLFlBQVYsRUFBd0I7QUFDaERDLElBQUFBLElBQUksRUFBRSxDQUFDUixJQUFELENBRDBDO0FBRWhEUyxJQUFBQSxZQUFZLEVBQUU7QUFGa0MsR0FBeEIsQ0FBMUI7QUFJQUgsRUFBQUEsV0FBVyxDQUFDSSxFQUFaLENBQWUsUUFBZixFQUF5QixDQUFDQyxNQUFELEVBQVNDLE1BQVQsS0FBb0I7QUFDM0NWLElBQUFBLE1BQU0sSUFBSVMsTUFBTSxJQUFJQyxNQUFwQjs7QUFDQSxRQUFJRCxNQUFKLEVBQVk7QUFDVixVQUFJQSxNQUFNLENBQUNFLFFBQVAsQ0FBZ0IsMkJBQWhCLEtBQWdEakIsc0JBQXBELEVBQTRFO0FBQzFFQSxRQUFBQSxzQkFBc0I7QUFDdkIsT0FGRCxNQUVPLElBQUllLE1BQU0sQ0FBQ0UsUUFBUCxDQUFnQix1QkFBaEIsS0FBNENoQixrQkFBaEQsRUFBb0U7QUFDekVBLFFBQUFBLGtCQUFrQjtBQUNuQjtBQUNGO0FBQ0YsR0FURDtBQVVBUyxFQUFBQSxXQUFXLENBQUNJLEVBQVosQ0FBZSxNQUFmLEVBQXVCLENBQUNJLElBQUQsRUFBT0MsTUFBUCxLQUFrQjtBQUN2QyxRQUFJVixjQUFKLEVBQW9CO0FBQ2xCVyxNQUFBQSxZQUFZLENBQUNYLGNBQUQsQ0FBWjtBQUNEOztBQUNELFFBQUlTLElBQUksS0FBSyxDQUFiLEVBQWdCO0FBQ2QsVUFBSWhCLFVBQUosRUFBZ0I7QUFDZEEsUUFBQUEsVUFBVTtBQUNYOztBQUNESyxNQUFBQSxpQkFBaUIsR0FBRyxJQUFwQjtBQUNELEtBTEQsTUFLTztBQUNMRCxNQUFBQSxNQUFNLEdBQUdBLE1BQU0sSUFBSWEsTUFBbkI7QUFDQVgsTUFBQUEsS0FBSyxHQUFHLElBQUlhLEtBQUosQ0FBVWYsTUFBVixDQUFSOztBQUNBLFVBQUlILE9BQUosRUFBYTtBQUNYQSxRQUFBQSxPQUFPLENBQUNLLEtBQUQsQ0FBUDtBQUNEO0FBQ0Y7QUFDRixHQWhCRDtBQWlCQSxRQUFNRSxXQUFXLENBQUNZLEtBQVosQ0FBa0IsQ0FBbEIsQ0FBTjs7QUFDQSxRQUFNQyxXQUFXLEdBQUcsWUFBWTtBQUM5QixRQUFJYixXQUFXLENBQUNjLFNBQWhCLEVBQTJCO0FBQ3pCLFVBQUk7QUFDRixjQUFNZCxXQUFXLENBQUNlLElBQVosRUFBTjtBQUNELE9BRkQsQ0FFRSxPQUFPQyxDQUFQLEVBQVU7QUFDVkMsd0JBQUlDLElBQUosQ0FBU0YsQ0FBQyxDQUFDRyxPQUFYO0FBQ0Q7QUFDRjtBQUNGLEdBUkQ7O0FBU0EsUUFBTVAsS0FBSyxHQUFHUSxPQUFPLENBQUNDLE1BQVIsRUFBZDs7QUFDQSxNQUFJN0IsVUFBSixFQUFnQjtBQUNkTyxJQUFBQSxjQUFjLEdBQUd1QixVQUFVLENBQUNULFdBQUQsRUFBY3hCLE9BQWQsQ0FBM0I7QUFDRCxHQUZELE1BRU87QUFDTCxRQUFJO0FBQ0YsWUFBTSxnQ0FBaUIsTUFBTTtBQUMzQixZQUFJUyxLQUFKLEVBQVc7QUFDVCxnQkFBTUEsS0FBTjtBQUNEOztBQUNELGVBQU9ELGlCQUFQO0FBQ0QsT0FMSyxFQUtIO0FBQUMwQixRQUFBQSxNQUFNLEVBQUVsQyxPQUFUO0FBQWtCbUMsUUFBQUEsVUFBVSxFQUFFO0FBQTlCLE9BTEcsQ0FBTjtBQU1ELEtBUEQsQ0FPRSxPQUFPQyxHQUFQLEVBQVk7QUFDWixZQUFNWixXQUFXLEVBQWpCO0FBQ0EsWUFBTSxDQUFDYSxPQUFELElBQVlOLE9BQU8sQ0FBQ0MsTUFBUixDQUFlVCxLQUFmLENBQWxCO0FBQ0EsWUFBTSxJQUFJRCxLQUFKLENBQ0gsaUJBQWdCakIsSUFBSyx1Q0FBc0NnQyxPQUFRLEtBQXBFLEdBQ0Msb0JBQW1COUIsTUFBTyxFQUZ2QixDQUFOO0FBR0Q7QUFDRjs7QUFDRCxTQUFPSSxXQUFQO0FBQ0QsQ0EzRUQ7O2VBNkVlZCxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcblxuXG5jb25zdCBjb21tYW5kcyA9IHt9O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEJvb3RNb25pdG9yT3B0aW9uc1xuICogQHByb3BlcnR5IHs/bnVtYmVyfSB0aW1lb3V0IFsyNDAwMDBdIC0gU2ltdWxhdG9yIGJvb3RpbmcgdGltZW91dCBpbiBtcy5cbiAqIEBwcm9wZXJ0eSB7P0Z1bmN0aW9ufSBvbldhaXRpbmdEYXRhTWlncmF0aW9uIC0gVGhpcyBldmVudCBpcyBmaXJlZCB3aGVuIGRhdGEgbWlncmF0aW9uIHN0YWdlIHN0YXJ0cy5cbiAqIEBwcm9wZXJ0eSB7P0Z1bmN0aW9ufSBvbldhaXRpbmdTeXN0ZW1BcHAgLSBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gc3lzdGVtIGFwcCB3YWl0IHN0YWdlIHN0YXJ0cy5cbiAqIEBwcm9wZXJ0eSB7P0Z1bmN0aW9ufSBvbkZpbmlzaGVkIC0gVGhpcyBldmVudCBpcyBmaXJlZCB3aGVuIFNpbXVsYXRvciBpcyBmdWxseSBib290ZWQuXG4gKiBAcHJvcGVydHkgez9GdW5jdGlvbn0gb25FcnJvciAtIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgbW9uaXRvcmluZyB0aGUgYm9vdGluZyBwcm9jZXNzXG4gKiBvciB3aGVuIHRoZSB0aW1lb3V0IGhhcyBleHBpcmVkLlxuICovXG5cbi8qKlxuICogU3RhcnQgbW9uaXRvcmluZyBmb3IgYm9vdCBzdGF0dXMgb2YgdGhlIHBhcnRpY3VsYXIgU2ltdWxhdG9yLlxuICogSWYgb25GaW5pc2hlZCBwcm9wZXJ0eSBpcyBub3Qgc2V0IHRoZW4gdGhlIG1ldGhvZCB3aWxsIGJsb2NrXG4gKiB1bnRpbCBTaW11bGF0b3IgYm9vdGluZyBpcyBjb21wbGV0ZWQuXG4gKiBUaGUgbWV0aG9kIGlzIG9ubHkgYXZhaWxhYmxlIHNpbmNlIFhjb2RlOC5cbiAqXG4gKiBAcGFyYW0gez9Cb290TW9uaXRvck9wdGlvbnN9IG9wdHMgLSBNb25pdG9yaW5nIG9wdGlvbnMuXG4gKiBAcmV0dXJucyB7U3ViUHJvY2Vzc30gVGhlIGluc3RhbmNlIG9mIHRoZSBjb3JyZXNwb25kaW5nIG1vbml0b3JpbmcgcHJvY2Vzcy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgU2ltdWxhdG9yIGZhaWxzIHRvIGZpbmlzaCBib290aW5nIHdpdGhpbiB0aGUgZ2l2ZW4gdGltZW91dCBhbmQgb25GaW5pc2hlZFxuICogcHJvcGVydHkgaXMgbm90IHNldC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgYHVkaWRgIGluc3RhbmNlIHByb3BlcnR5IGlzIHVuc2V0XG4gKi9cbmNvbW1hbmRzLnN0YXJ0Qm9vdE1vbml0b3IgPSBhc3luYyBmdW5jdGlvbiBzdGFydEJvb3RNb25pdG9yIChvcHRzID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHRpbWVvdXQgPSAyNDAwMDAsXG4gICAgb25XYWl0aW5nRGF0YU1pZ3JhdGlvbixcbiAgICBvbldhaXRpbmdTeXN0ZW1BcHAsXG4gICAgb25GaW5pc2hlZCxcbiAgICBvbkVycm9yLFxuICB9ID0gb3B0cztcbiAgY29uc3QgdWRpZCA9IHRoaXMucmVxdWlyZVVkaWQoJ2Jvb3RzdGF0dXMnKTtcblxuICBsZXQgc3RhdHVzID0gJyc7XG4gIGxldCBpc0Jvb3RpbmdGaW5pc2hlZCA9IGZhbHNlO1xuICBsZXQgZXJyb3IgPSBudWxsO1xuICBsZXQgdGltZW91dEhhbmRsZXIgPSBudWxsO1xuICBjb25zdCBib290TW9uaXRvciA9IGF3YWl0IHRoaXMuZXhlYygnYm9vdHN0YXR1cycsIHtcbiAgICBhcmdzOiBbdWRpZF0sXG4gICAgYXN5bmNocm9ub3VzOiB0cnVlLFxuICB9KTtcbiAgYm9vdE1vbml0b3Iub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgIHN0YXR1cyArPSBzdGRvdXQgfHwgc3RkZXJyO1xuICAgIGlmIChzdGRvdXQpIHtcbiAgICAgIGlmIChzdGRvdXQuaW5jbHVkZXMoJ1dhaXRpbmcgb24gRGF0YSBNaWdyYXRpb24nKSAmJiBvbldhaXRpbmdEYXRhTWlncmF0aW9uKSB7XG4gICAgICAgIG9uV2FpdGluZ0RhdGFNaWdyYXRpb24oKTtcbiAgICAgIH0gZWxzZSBpZiAoc3Rkb3V0LmluY2x1ZGVzKCdXYWl0aW5nIG9uIFN5c3RlbSBBcHAnKSAmJiBvbldhaXRpbmdTeXN0ZW1BcHApIHtcbiAgICAgICAgb25XYWl0aW5nU3lzdGVtQXBwKCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbiAgYm9vdE1vbml0b3Iub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgaWYgKHRpbWVvdXRIYW5kbGVyKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGltZW91dEhhbmRsZXIpO1xuICAgIH1cbiAgICBpZiAoY29kZSA9PT0gMCkge1xuICAgICAgaWYgKG9uRmluaXNoZWQpIHtcbiAgICAgICAgb25GaW5pc2hlZCgpO1xuICAgICAgfVxuICAgICAgaXNCb290aW5nRmluaXNoZWQgPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdGF0dXMgPSBzdGF0dXMgfHwgc2lnbmFsO1xuICAgICAgZXJyb3IgPSBuZXcgRXJyb3Ioc3RhdHVzKTtcbiAgICAgIGlmIChvbkVycm9yKSB7XG4gICAgICAgIG9uRXJyb3IoZXJyb3IpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIGF3YWl0IGJvb3RNb25pdG9yLnN0YXJ0KDApO1xuICBjb25zdCBzdG9wTW9uaXRvciA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAoYm9vdE1vbml0b3IuaXNSdW5uaW5nKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBib290TW9uaXRvci5zdG9wKCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGUubWVzc2FnZSk7XG4gICAgICB9XG4gICAgfVxuICB9O1xuICBjb25zdCBzdGFydCA9IHByb2Nlc3MuaHJ0aW1lKCk7XG4gIGlmIChvbkZpbmlzaGVkKSB7XG4gICAgdGltZW91dEhhbmRsZXIgPSBzZXRUaW1lb3V0KHN0b3BNb25pdG9yLCB0aW1lb3V0KTtcbiAgfSBlbHNlIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbigoKSA9PiB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpc0Jvb3RpbmdGaW5pc2hlZDtcbiAgICAgIH0sIHt3YWl0TXM6IHRpbWVvdXQsIGludGVydmFsTXM6IDUwMH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgYXdhaXQgc3RvcE1vbml0b3IoKTtcbiAgICAgIGNvbnN0IFtzZWNvbmRzXSA9IHByb2Nlc3MuaHJ0aW1lKHN0YXJ0KTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRoZSBzaW11bGF0b3IgJHt1ZGlkfSBoYXMgZmFpbGVkIHRvIGZpbmlzaCBib290aW5nIGFmdGVyICR7c2Vjb25kc31zLiBgICtcbiAgICAgICAgYE9yaWdpbmFsIHN0YXR1czogJHtzdGF0dXN9YCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBib290TW9uaXRvcjtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sImZpbGUiOiJsaWIvc3ViY29tbWFuZHMvYm9vdHN0YXR1cy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
