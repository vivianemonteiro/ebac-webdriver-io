"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _os = _interopRequireDefault(require("os"));

var _fs = _interopRequireDefault(require("fs"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _uuid = require("uuid");

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _rimraf = _interopRequireDefault(require("rimraf"));

const commands = {};

const rimrafAsync = _bluebird.default.promisify(_rimraf.default);

const writeFileAsync = _bluebird.default.promisify(_fs.default.writeFile);

async function handleRawPayload(payload, onPayloadStored) {
  const filePath = _path.default.resolve(_os.default.tmpdir(), `${(0, _uuid.v4)()}.pem`);

  try {
    if (_lodash.default.isBuffer(payload)) {
      await writeFileAsync(filePath, payload);
    } else {
      await writeFileAsync(filePath, payload, 'utf8');
    }

    await onPayloadStored(filePath);
  } finally {
    await rimrafAsync(filePath);
  }
}

commands.addRootCertificate = async function addRootCertificate(cert, opts = {}) {
  const {
    raw = false
  } = opts;

  const execMethod = async certPath => await this.exec('keychain', {
    args: [this.requireUdid('keychain add-root-cert'), 'add-root-cert', certPath]
  });

  if (raw) {
    await handleRawPayload(cert, execMethod);
  } else {
    await execMethod(cert);
  }
};

commands.addCertificate = async function addCertificate(cert, opts = {}) {
  const {
    raw = false
  } = opts;

  const execMethod = async certPath => await this.exec('keychain', {
    args: [this.requireUdid('keychain add-cert'), 'add-cert', certPath]
  });

  if (raw) {
    await handleRawPayload(cert, execMethod);
  } else {
    await execMethod(cert);
  }
};

commands.resetKeychain = async function resetKeychain() {
  await this.exec('keychain', {
    args: [this.requireUdid('keychain reset'), 'reset']
  });
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zdWJjb21tYW5kcy9rZXljaGFpbi5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsInJpbXJhZkFzeW5jIiwiQiIsInByb21pc2lmeSIsInJpbXJhZiIsIndyaXRlRmlsZUFzeW5jIiwiZnMiLCJ3cml0ZUZpbGUiLCJoYW5kbGVSYXdQYXlsb2FkIiwicGF5bG9hZCIsIm9uUGF5bG9hZFN0b3JlZCIsImZpbGVQYXRoIiwicGF0aCIsInJlc29sdmUiLCJvcyIsInRtcGRpciIsIl8iLCJpc0J1ZmZlciIsImFkZFJvb3RDZXJ0aWZpY2F0ZSIsImNlcnQiLCJvcHRzIiwicmF3IiwiZXhlY01ldGhvZCIsImNlcnRQYXRoIiwiZXhlYyIsImFyZ3MiLCJyZXF1aXJlVWRpZCIsImFkZENlcnRpZmljYXRlIiwicmVzZXRLZXljaGFpbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxRQUFRLEdBQUcsRUFBakI7O0FBQ0EsTUFBTUMsV0FBVyxHQUFHQyxrQkFBRUMsU0FBRixDQUFZQyxlQUFaLENBQXBCOztBQUNBLE1BQU1DLGNBQWMsR0FBR0gsa0JBQUVDLFNBQUYsQ0FBWUcsWUFBR0MsU0FBZixDQUF2Qjs7QUFFQSxlQUFlQyxnQkFBZixDQUFpQ0MsT0FBakMsRUFBMENDLGVBQTFDLEVBQTJEO0FBQ3pELFFBQU1DLFFBQVEsR0FBR0MsY0FBS0MsT0FBTCxDQUFhQyxZQUFHQyxNQUFILEVBQWIsRUFBMkIsR0FBRSxlQUFTLE1BQXRDLENBQWpCOztBQUNBLE1BQUk7QUFDRixRQUFJQyxnQkFBRUMsUUFBRixDQUFXUixPQUFYLENBQUosRUFBeUI7QUFDdkIsWUFBTUosY0FBYyxDQUFDTSxRQUFELEVBQVdGLE9BQVgsQ0FBcEI7QUFDRCxLQUZELE1BRU87QUFDTCxZQUFNSixjQUFjLENBQUNNLFFBQUQsRUFBV0YsT0FBWCxFQUFvQixNQUFwQixDQUFwQjtBQUNEOztBQUNELFVBQU1DLGVBQWUsQ0FBQ0MsUUFBRCxDQUFyQjtBQUNELEdBUEQsU0FPVTtBQUNSLFVBQU1WLFdBQVcsQ0FBQ1UsUUFBRCxDQUFqQjtBQUNEO0FBQ0Y7O0FBc0JEWCxRQUFRLENBQUNrQixrQkFBVCxHQUE4QixlQUFlQSxrQkFBZixDQUFtQ0MsSUFBbkMsRUFBeUNDLElBQUksR0FBRyxFQUFoRCxFQUFvRDtBQUNoRixRQUFNO0FBQ0pDLElBQUFBLEdBQUcsR0FBRztBQURGLE1BRUZELElBRko7O0FBR0EsUUFBTUUsVUFBVSxHQUFHLE1BQU9DLFFBQVAsSUFBb0IsTUFBTSxLQUFLQyxJQUFMLENBQVUsVUFBVixFQUFzQjtBQUNqRUMsSUFBQUEsSUFBSSxFQUFFLENBQUMsS0FBS0MsV0FBTCxDQUFpQix3QkFBakIsQ0FBRCxFQUE2QyxlQUE3QyxFQUE4REgsUUFBOUQ7QUFEMkQsR0FBdEIsQ0FBN0M7O0FBR0EsTUFBSUYsR0FBSixFQUFTO0FBQ1AsVUFBTWIsZ0JBQWdCLENBQUNXLElBQUQsRUFBT0csVUFBUCxDQUF0QjtBQUNELEdBRkQsTUFFTztBQUNMLFVBQU1BLFVBQVUsQ0FBQ0gsSUFBRCxDQUFoQjtBQUNEO0FBQ0YsQ0FaRDs7QUEwQkFuQixRQUFRLENBQUMyQixjQUFULEdBQTBCLGVBQWVBLGNBQWYsQ0FBK0JSLElBQS9CLEVBQXFDQyxJQUFJLEdBQUcsRUFBNUMsRUFBZ0Q7QUFDeEUsUUFBTTtBQUNKQyxJQUFBQSxHQUFHLEdBQUc7QUFERixNQUVGRCxJQUZKOztBQUdBLFFBQU1FLFVBQVUsR0FBRyxNQUFPQyxRQUFQLElBQW9CLE1BQU0sS0FBS0MsSUFBTCxDQUFVLFVBQVYsRUFBc0I7QUFDakVDLElBQUFBLElBQUksRUFBRSxDQUFDLEtBQUtDLFdBQUwsQ0FBaUIsbUJBQWpCLENBQUQsRUFBd0MsVUFBeEMsRUFBb0RILFFBQXBEO0FBRDJELEdBQXRCLENBQTdDOztBQUdBLE1BQUlGLEdBQUosRUFBUztBQUNQLFVBQU1iLGdCQUFnQixDQUFDVyxJQUFELEVBQU9HLFVBQVAsQ0FBdEI7QUFDRCxHQUZELE1BRU87QUFDTCxVQUFNQSxVQUFVLENBQUNILElBQUQsQ0FBaEI7QUFDRDtBQUNGLENBWkQ7O0FBc0JBbkIsUUFBUSxDQUFDNEIsYUFBVCxHQUF5QixlQUFlQSxhQUFmLEdBQWdDO0FBQ3ZELFFBQU0sS0FBS0osSUFBTCxDQUFVLFVBQVYsRUFBc0I7QUFDMUJDLElBQUFBLElBQUksRUFBRSxDQUFDLEtBQUtDLFdBQUwsQ0FBaUIsZ0JBQWpCLENBQUQsRUFBcUMsT0FBckM7QUFEb0IsR0FBdEIsQ0FBTjtBQUdELENBSkQ7O2VBTWUxQixRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyB2NCBhcyB1dWlkVjQgfSBmcm9tICd1dWlkJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCByaW1yYWYgZnJvbSAncmltcmFmJztcblxuY29uc3QgY29tbWFuZHMgPSB7fTtcbmNvbnN0IHJpbXJhZkFzeW5jID0gQi5wcm9taXNpZnkocmltcmFmKTtcbmNvbnN0IHdyaXRlRmlsZUFzeW5jID0gQi5wcm9taXNpZnkoZnMud3JpdGVGaWxlKTtcblxuYXN5bmMgZnVuY3Rpb24gaGFuZGxlUmF3UGF5bG9hZCAocGF5bG9hZCwgb25QYXlsb2FkU3RvcmVkKSB7XG4gIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKG9zLnRtcGRpcigpLCBgJHt1dWlkVjQoKX0ucGVtYCk7XG4gIHRyeSB7XG4gICAgaWYgKF8uaXNCdWZmZXIocGF5bG9hZCkpIHtcbiAgICAgIGF3YWl0IHdyaXRlRmlsZUFzeW5jKGZpbGVQYXRoLCBwYXlsb2FkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgd3JpdGVGaWxlQXN5bmMoZmlsZVBhdGgsIHBheWxvYWQsICd1dGY4Jyk7XG4gICAgfVxuICAgIGF3YWl0IG9uUGF5bG9hZFN0b3JlZChmaWxlUGF0aCk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgcmltcmFmQXN5bmMoZmlsZVBhdGgpO1xuICB9XG59XG5cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBDZXJ0T3B0aW9uc1xuICogQHByb3BlcnR5IHtib29sZWFufSByYXcgW2ZhbHNlXSAtIHdoZXRoZXIgdGhlIGBjZXJ0YCBhcmd1bWVudFxuICogaXMgdGhlIHBhdGggdG8gdGhlIGNlcnRpZmljYXRlIG9uIHRoZSBsb2NhbCBmaWxlIHN5c3RlbSBvclxuICogYSByYXcgY2VydGlmaWNhdGUgY29udGVudFxuICovXG5cbi8qKlxuICogQWRkcyB0aGUgZ2l2ZW4gY2VydGlmaWNhdGUgdG8gdGhlIFRydXN0ZWQgUm9vdCBTdG9yZSBvbiB0aGUgc2ltdWxhdG9yXG4gKlxuICogQHNpbmNlIFhjb2RlIDExLjQgU0RLXG4gKiBAcGFyYW0ge3N0cmluZ30gY2VydCB0aGUgZnVsbCBwYXRoIHRvIGEgdmFsaWQgLmNlcnQgZmlsZSBjb250YWluaW5nXG4gKiB0aGUgY2VydGlmaWNhdGUgY29udGVudCBvciB0aGUgY2VydGlmaWNhdGUgY29udGVudCBpdHNlbGYsIGRlcGVuZGluZyBvblxuICogb3B0aW9uc1xuICogQHBhcmFtIHtDZXJ0T3B0aW9uc30gb3B0c1xuICogQHRocm93cyB7RXJyb3J9IGlmIHRoZSBjdXJyZW50IFNESyB2ZXJzaW9uIGRvZXMgbm90IHN1cHBvcnQgdGhlIGNvbW1hbmRcbiAqIG9yIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBhZGRpbmcgdGhlIGNlcnRpZmljYXRlXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGB1ZGlkYCBpbnN0YW5jZSBwcm9wZXJ0eSBpcyB1bnNldFxuICovXG5jb21tYW5kcy5hZGRSb290Q2VydGlmaWNhdGUgPSBhc3luYyBmdW5jdGlvbiBhZGRSb290Q2VydGlmaWNhdGUgKGNlcnQsIG9wdHMgPSB7fSkge1xuICBjb25zdCB7XG4gICAgcmF3ID0gZmFsc2UsXG4gIH0gPSBvcHRzO1xuICBjb25zdCBleGVjTWV0aG9kID0gYXN5bmMgKGNlcnRQYXRoKSA9PiBhd2FpdCB0aGlzLmV4ZWMoJ2tleWNoYWluJywge1xuICAgIGFyZ3M6IFt0aGlzLnJlcXVpcmVVZGlkKCdrZXljaGFpbiBhZGQtcm9vdC1jZXJ0JyksICdhZGQtcm9vdC1jZXJ0JywgY2VydFBhdGhdLFxuICB9KTtcbiAgaWYgKHJhdykge1xuICAgIGF3YWl0IGhhbmRsZVJhd1BheWxvYWQoY2VydCwgZXhlY01ldGhvZCk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgZXhlY01ldGhvZChjZXJ0KTtcbiAgfVxufTtcblxuLyoqXG4gKiBBZGRzIHRoZSBnaXZlbiBjZXJ0aWZpY2F0ZSB0byB0aGUgS2V5Y2hhaW4gU3RvcmUgb24gdGhlIHNpbXVsYXRvclxuICpcbiAqIEBzaW5jZSBYY29kZSAxMS40IFNES1xuICogQHBhcmFtIHtzdHJpbmd9IGNlcnQgdGhlIGZ1bGwgcGF0aCB0byBhIHZhbGlkIC5jZXJ0IGZpbGUgY29udGFpbmluZ1xuICogdGhlIGNlcnRpZmljYXRlIGNvbnRlbnQgb3IgdGhlIGNlcnRpZmljYXRlIGNvbnRlbnQgaXRzZWxmLCBkZXBlbmRpbmcgb25cbiAqIG9wdGlvbnNcbiAqIEBwYXJhbSB7Q2VydE9wdGlvbnN9IG9wdHNcbiAqIEB0aHJvd3Mge0Vycm9yfSBpZiB0aGUgY3VycmVudCBTREsgdmVyc2lvbiBkb2VzIG5vdCBzdXBwb3J0IHRoZSBjb21tYW5kXG4gKiBvciB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgYWRkaW5nIHRoZSBjZXJ0aWZpY2F0ZVxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBgdWRpZGAgaW5zdGFuY2UgcHJvcGVydHkgaXMgdW5zZXRcbiAqL1xuY29tbWFuZHMuYWRkQ2VydGlmaWNhdGUgPSBhc3luYyBmdW5jdGlvbiBhZGRDZXJ0aWZpY2F0ZSAoY2VydCwgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICByYXcgPSBmYWxzZSxcbiAgfSA9IG9wdHM7XG4gIGNvbnN0IGV4ZWNNZXRob2QgPSBhc3luYyAoY2VydFBhdGgpID0+IGF3YWl0IHRoaXMuZXhlYygna2V5Y2hhaW4nLCB7XG4gICAgYXJnczogW3RoaXMucmVxdWlyZVVkaWQoJ2tleWNoYWluIGFkZC1jZXJ0JyksICdhZGQtY2VydCcsIGNlcnRQYXRoXSxcbiAgfSk7XG4gIGlmIChyYXcpIHtcbiAgICBhd2FpdCBoYW5kbGVSYXdQYXlsb2FkKGNlcnQsIGV4ZWNNZXRob2QpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IGV4ZWNNZXRob2QoY2VydCk7XG4gIH1cbn07XG5cbi8qKlxuICogUmVzZXRzIHRoZSBzaW11bGF0b3Iga2V5Y2hhaW5cbiAqXG4gKiBAc2luY2UgWGNvZGUgMTEuNCBTREtcbiAqIEB0aHJvd3Mge0Vycm9yfSBpZiB0aGUgY3VycmVudCBTREsgdmVyc2lvbiBkb2VzIG5vdCBzdXBwb3J0IHRoZSBjb21tYW5kXG4gKiBvciB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgcmVzZXR0aW5nIHRoZSBrZXljaGFpblxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBgdWRpZGAgaW5zdGFuY2UgcHJvcGVydHkgaXMgdW5zZXRcbiAqL1xuY29tbWFuZHMucmVzZXRLZXljaGFpbiA9IGFzeW5jIGZ1bmN0aW9uIHJlc2V0S2V5Y2hhaW4gKCkge1xuICBhd2FpdCB0aGlzLmV4ZWMoJ2tleWNoYWluJywge1xuICAgIGFyZ3M6IFt0aGlzLnJlcXVpcmVVZGlkKCdrZXljaGFpbiByZXNldCcpLCAncmVzZXQnXSxcbiAgfSk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL3N1YmNvbW1hbmRzL2tleWNoYWluLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
