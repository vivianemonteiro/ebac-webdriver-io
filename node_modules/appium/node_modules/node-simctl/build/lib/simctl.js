"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Simctl = exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _index = _interopRequireDefault(require("./subcommands/index.js"));

var _which = _interopRequireDefault(require("which"));

var _logger = _interopRequireWildcard(require("./logger"));

var _helpers = require("./helpers");

var _teen_process = require("teen_process");

const SIMCTL_ENV_PREFIX = 'SIMCTL_CHILD_';
const DEFAULT_OPTS = {
  xcrun: {
    path: null
  },
  execTimeout: _helpers.DEFAULT_EXEC_TIMEOUT,
  logErrors: true
};

class Simctl {
  constructor(opts = {}) {
    opts = _lodash.default.cloneDeep(opts);

    _lodash.default.defaultsDeep(opts, DEFAULT_OPTS);

    for (const key of _lodash.default.keys(DEFAULT_OPTS)) {
      this[key] = opts[key];
    }

    this._udid = _lodash.default.isNil(opts.udid) ? null : opts.udid;
    this._devicesSetPath = _lodash.default.isNil(opts.devicesSetPath) ? null : opts.devicesSetPath;
  }

  set udid(value) {
    this._udid = value;
  }

  get udid() {
    return this._udid;
  }

  set devicesSetPath(value) {
    this._devicesSetPath = value;
  }

  get devicesSetPath() {
    return this._devicesSetPath;
  }

  requireUdid(commandName = null) {
    if (!this.udid) {
      throw new Error(`udid is required to be set for ` + (commandName ? `the '${commandName}' command` : 'this simctl command'));
    }

    return this.udid;
  }

  async requireXcrun() {
    if (!this.xcrun.path) {
      try {
        this.xcrun.path = await (0, _which.default)(_helpers.XCRUN_BINARY);
      } catch (e) {
        throw new Error(`${_helpers.XCRUN_BINARY} tool has not been found in PATH. ` + `Are Xcode developers tools installed?`);
      }
    }

    return this.xcrun.path;
  }

  async exec(subcommand, opts = {}) {
    let {
      args = [],
      env = {},
      asynchronous = false,
      encoding,
      logErrors = true
    } = opts;
    args = ['simctl', ...(this.devicesSetPath ? ['--set', this.devicesSetPath] : []), subcommand, ...args];
    env = _lodash.default.defaults(_lodash.default.mapKeys(env, (value, key) => _lodash.default.startsWith(key, SIMCTL_ENV_PREFIX) ? key : `${SIMCTL_ENV_PREFIX}${key}`), process.env);
    const execOpts = {
      env,
      encoding
    };

    if (!asynchronous) {
      execOpts.timeout = this.execTimeout;
    }

    const xcrun = await this.requireXcrun();

    try {
      return asynchronous ? new _teen_process.SubProcess(xcrun, args, execOpts) : await (0, _teen_process.exec)(xcrun, args, execOpts);
    } catch (e) {
      if (!this.logErrors || !logErrors) {} else if (e.stderr) {
        const msg = `Error running '${subcommand}': ${e.stderr.trim()}`;

        _logger.default.debug(_logger.LOG_PREFIX, msg);

        e.message = msg;
      } else {
        _logger.default.debug(_logger.LOG_PREFIX, e.message);
      }

      throw e;
    }
  }

}

exports.Simctl = Simctl;

for (const [fnName, fn] of _lodash.default.toPairs(_index.default)) {
  Simctl.prototype[fnName] = fn;
}

var _default = Simctl;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW1jdGwuanMiXSwibmFtZXMiOlsiU0lNQ1RMX0VOVl9QUkVGSVgiLCJERUZBVUxUX09QVFMiLCJ4Y3J1biIsInBhdGgiLCJleGVjVGltZW91dCIsIkRFRkFVTFRfRVhFQ19USU1FT1VUIiwibG9nRXJyb3JzIiwiU2ltY3RsIiwiY29uc3RydWN0b3IiLCJvcHRzIiwiXyIsImNsb25lRGVlcCIsImRlZmF1bHRzRGVlcCIsImtleSIsImtleXMiLCJfdWRpZCIsImlzTmlsIiwidWRpZCIsIl9kZXZpY2VzU2V0UGF0aCIsImRldmljZXNTZXRQYXRoIiwidmFsdWUiLCJyZXF1aXJlVWRpZCIsImNvbW1hbmROYW1lIiwiRXJyb3IiLCJyZXF1aXJlWGNydW4iLCJYQ1JVTl9CSU5BUlkiLCJlIiwiZXhlYyIsInN1YmNvbW1hbmQiLCJhcmdzIiwiZW52IiwiYXN5bmNocm9ub3VzIiwiZW5jb2RpbmciLCJkZWZhdWx0cyIsIm1hcEtleXMiLCJzdGFydHNXaXRoIiwicHJvY2VzcyIsImV4ZWNPcHRzIiwidGltZW91dCIsIlN1YlByb2Nlc3MiLCJzdGRlcnIiLCJtc2ciLCJ0cmltIiwibG9nIiwiZGVidWciLCJMT0dfUFJFRklYIiwibWVzc2FnZSIsImZuTmFtZSIsImZuIiwidG9QYWlycyIsInN1YmNvbW1hbmRzIiwicHJvdG90eXBlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBRUEsTUFBTUEsaUJBQWlCLEdBQUcsZUFBMUI7QUFDQSxNQUFNQyxZQUFZLEdBQUc7QUFDbkJDLEVBQUFBLEtBQUssRUFBRTtBQUNMQyxJQUFBQSxJQUFJLEVBQUU7QUFERCxHQURZO0FBSW5CQyxFQUFBQSxXQUFXLEVBQUVDLDZCQUpNO0FBS25CQyxFQUFBQSxTQUFTLEVBQUU7QUFMUSxDQUFyQjs7QUEyQ0EsTUFBTUMsTUFBTixDQUFhO0FBSVhDLEVBQUFBLFdBQVcsQ0FBRUMsSUFBSSxHQUFHLEVBQVQsRUFBYTtBQUN0QkEsSUFBQUEsSUFBSSxHQUFHQyxnQkFBRUMsU0FBRixDQUFZRixJQUFaLENBQVA7O0FBQ0FDLG9CQUFFRSxZQUFGLENBQWVILElBQWYsRUFBcUJSLFlBQXJCOztBQUNBLFNBQUssTUFBTVksR0FBWCxJQUFrQkgsZ0JBQUVJLElBQUYsQ0FBT2IsWUFBUCxDQUFsQixFQUF3QztBQUN0QyxXQUFLWSxHQUFMLElBQVlKLElBQUksQ0FBQ0ksR0FBRCxDQUFoQjtBQUNEOztBQUNELFNBQUtFLEtBQUwsR0FBYUwsZ0JBQUVNLEtBQUYsQ0FBUVAsSUFBSSxDQUFDUSxJQUFiLElBQXFCLElBQXJCLEdBQTRCUixJQUFJLENBQUNRLElBQTlDO0FBQ0EsU0FBS0MsZUFBTCxHQUF1QlIsZ0JBQUVNLEtBQUYsQ0FBUVAsSUFBSSxDQUFDVSxjQUFiLElBQStCLElBQS9CLEdBQXNDVixJQUFJLENBQUNVLGNBQWxFO0FBQ0Q7O0FBRUQsTUFBSUYsSUFBSixDQUFVRyxLQUFWLEVBQWlCO0FBQ2YsU0FBS0wsS0FBTCxHQUFhSyxLQUFiO0FBQ0Q7O0FBRUQsTUFBSUgsSUFBSixHQUFZO0FBQ1YsV0FBTyxLQUFLRixLQUFaO0FBQ0Q7O0FBRUQsTUFBSUksY0FBSixDQUFvQkMsS0FBcEIsRUFBMkI7QUFDekIsU0FBS0YsZUFBTCxHQUF1QkUsS0FBdkI7QUFDRDs7QUFFRCxNQUFJRCxjQUFKLEdBQXNCO0FBQ3BCLFdBQU8sS0FBS0QsZUFBWjtBQUNEOztBQUVERyxFQUFBQSxXQUFXLENBQUVDLFdBQVcsR0FBRyxJQUFoQixFQUFzQjtBQUMvQixRQUFJLENBQUMsS0FBS0wsSUFBVixFQUFnQjtBQUNkLFlBQU0sSUFBSU0sS0FBSixDQUFXLGlDQUFELElBQ2JELFdBQVcsR0FBSSxRQUFPQSxXQUFZLFdBQXZCLEdBQW9DLHFCQURsQyxDQUFWLENBQU47QUFFRDs7QUFDRCxXQUFPLEtBQUtMLElBQVo7QUFDRDs7QUFFRCxRQUFNTyxZQUFOLEdBQXNCO0FBQ3BCLFFBQUksQ0FBQyxLQUFLdEIsS0FBTCxDQUFXQyxJQUFoQixFQUFzQjtBQUNwQixVQUFJO0FBQ0YsYUFBS0QsS0FBTCxDQUFXQyxJQUFYLEdBQWtCLE1BQU0sb0JBQU1zQixxQkFBTixDQUF4QjtBQUNELE9BRkQsQ0FFRSxPQUFPQyxDQUFQLEVBQVU7QUFDVixjQUFNLElBQUlILEtBQUosQ0FBVyxHQUFFRSxxQkFBYSxvQ0FBaEIsR0FDYix1Q0FERyxDQUFOO0FBRUQ7QUFDRjs7QUFDRCxXQUFPLEtBQUt2QixLQUFMLENBQVdDLElBQWxCO0FBQ0Q7O0FBYUQsUUFBTXdCLElBQU4sQ0FBWUMsVUFBWixFQUF3Qm5CLElBQUksR0FBRyxFQUEvQixFQUFtQztBQUNqQyxRQUFJO0FBQ0ZvQixNQUFBQSxJQUFJLEdBQUcsRUFETDtBQUVGQyxNQUFBQSxHQUFHLEdBQUcsRUFGSjtBQUdGQyxNQUFBQSxZQUFZLEdBQUcsS0FIYjtBQUlGQyxNQUFBQSxRQUpFO0FBS0YxQixNQUFBQSxTQUFTLEdBQUc7QUFMVixRQU1BRyxJQU5KO0FBUUFvQixJQUFBQSxJQUFJLEdBQUcsQ0FBQyxRQUFELEVBQ0wsSUFBSSxLQUFLVixjQUFMLEdBQXNCLENBQUMsT0FBRCxFQUFVLEtBQUtBLGNBQWYsQ0FBdEIsR0FBdUQsRUFBM0QsQ0FESyxFQUVMUyxVQUZLLEVBR0wsR0FBR0MsSUFIRSxDQUFQO0FBT0FDLElBQUFBLEdBQUcsR0FBR3BCLGdCQUFFdUIsUUFBRixDQUNKdkIsZ0JBQUV3QixPQUFGLENBQVVKLEdBQVYsRUFDRSxDQUFDVixLQUFELEVBQVFQLEdBQVIsS0FBZ0JILGdCQUFFeUIsVUFBRixDQUFhdEIsR0FBYixFQUFrQmIsaUJBQWxCLElBQXVDYSxHQUF2QyxHQUE4QyxHQUFFYixpQkFBa0IsR0FBRWEsR0FBSSxFQUQxRixDQURJLEVBR0p1QixPQUFPLENBQUNOLEdBSEosQ0FBTjtBQUtBLFVBQU1PLFFBQVEsR0FBRztBQUNmUCxNQUFBQSxHQURlO0FBRWZFLE1BQUFBO0FBRmUsS0FBakI7O0FBSUEsUUFBSSxDQUFDRCxZQUFMLEVBQW1CO0FBQ2pCTSxNQUFBQSxRQUFRLENBQUNDLE9BQVQsR0FBbUIsS0FBS2xDLFdBQXhCO0FBQ0Q7O0FBQ0QsVUFBTUYsS0FBSyxHQUFHLE1BQU0sS0FBS3NCLFlBQUwsRUFBcEI7O0FBQ0EsUUFBSTtBQUNGLGFBQU9PLFlBQVksR0FBRyxJQUFJUSx3QkFBSixDQUFlckMsS0FBZixFQUFzQjJCLElBQXRCLEVBQTRCUSxRQUE1QixDQUFILEdBQTJDLE1BQU0sd0JBQU9uQyxLQUFQLEVBQWMyQixJQUFkLEVBQW9CUSxRQUFwQixDQUFwRTtBQUNELEtBRkQsQ0FFRSxPQUFPWCxDQUFQLEVBQVU7QUFDVixVQUFJLENBQUMsS0FBS3BCLFNBQU4sSUFBbUIsQ0FBQ0EsU0FBeEIsRUFBbUMsQ0FHbEMsQ0FIRCxNQUdPLElBQUlvQixDQUFDLENBQUNjLE1BQU4sRUFBYztBQUNuQixjQUFNQyxHQUFHLEdBQUksa0JBQWlCYixVQUFXLE1BQUtGLENBQUMsQ0FBQ2MsTUFBRixDQUFTRSxJQUFULEVBQWdCLEVBQTlEOztBQUNBQyx3QkFBSUMsS0FBSixDQUFVQyxrQkFBVixFQUFzQkosR0FBdEI7O0FBQ0FmLFFBQUFBLENBQUMsQ0FBQ29CLE9BQUYsR0FBWUwsR0FBWjtBQUNELE9BSk0sTUFJQTtBQUNMRSx3QkFBSUMsS0FBSixDQUFVQyxrQkFBVixFQUFzQm5CLENBQUMsQ0FBQ29CLE9BQXhCO0FBQ0Q7O0FBQ0QsWUFBTXBCLENBQU47QUFDRDtBQUNGOztBQXpHVTs7OztBQThHYixLQUFLLE1BQU0sQ0FBQ3FCLE1BQUQsRUFBU0MsRUFBVCxDQUFYLElBQTJCdEMsZ0JBQUV1QyxPQUFGLENBQVVDLGNBQVYsQ0FBM0IsRUFBbUQ7QUFDakQzQyxFQUFBQSxNQUFNLENBQUM0QyxTQUFQLENBQWlCSixNQUFqQixJQUEyQkMsRUFBM0I7QUFDRDs7ZUFFY3pDLE0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHN1YmNvbW1hbmRzIGZyb20gJy4vc3ViY29tbWFuZHMvaW5kZXguanMnO1xuaW1wb3J0IHdoaWNoIGZyb20gJ3doaWNoJztcbmltcG9ydCBsb2csIHsgTE9HX1BSRUZJWCB9IGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7XG4gIERFRkFVTFRfRVhFQ19USU1FT1VULCBYQ1JVTl9CSU5BUlksXG59IGZyb20gJy4vaGVscGVycyc7XG5pbXBvcnQgeyBleGVjIGFzIHRwRXhlYywgU3ViUHJvY2VzcyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5cbmNvbnN0IFNJTUNUTF9FTlZfUFJFRklYID0gJ1NJTUNUTF9DSElMRF8nO1xuY29uc3QgREVGQVVMVF9PUFRTID0ge1xuICB4Y3J1bjoge1xuICAgIHBhdGg6IG51bGwsXG4gIH0sXG4gIGV4ZWNUaW1lb3V0OiBERUZBVUxUX0VYRUNfVElNRU9VVCxcbiAgbG9nRXJyb3JzOiB0cnVlLFxufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBFeGVjT3B0c1xuICogQHByb3BlcnR5IHtBcnJheS48c3RyaW5nPn0gYXJncyBbW11dIC0gVGhlIGxpc3Qgb2YgYWRkaXRpb25hbCBzdWJjb21tYW5kIGFyZ3VtZW50cy5cbiAqIEl0J3MgZW1wdHkgYnkgZGVmYXVsdC5cbiAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBlbnYgW3t9XSAtIEVudmlyb25tZW50IHZhcmlhYmxlcyBtYXBwaW5nLiBBbGwgdGhlc2UgdmFyaWFibGVzXG4gKiB3aWxsIGJlIHBhc3NlZCBTaW11bGF0b3IgYW5kIHVzZWQgaW4gdGhlIGV4ZWN1dGluZyBmdW5jdGlvbi5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbG9nRXJyb3JzIFt0cnVlXSAtIFNldCBpdCB0byBfZmFsc2VfIHRvIHRocm93IGV4ZWN1dGlvbiBlcnJvcnNcbiAqIGltbWVkaWF0ZWx5IHdpdGhvdXQgbG9nZ2luZyBhbnkgYWRkaXRpb25hbCBpbmZvcm1hdGlvbi5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYXN5bmNocm9ub3VzIFtmYWxzZV0gLSBXaGV0aGVyIHRvIGV4ZWN1dGUgdGhlIGdpdmVuIGNvbW1hbmRcbiAqICdzeW5jaHJvbm91c2x5JyBvciAnYXN5bmNocm9ub3VzbHknLiBBZmZlY3RzIHRoZSByZXR1cm5lZCByZXN1bHQgb2YgdGhlIGZ1bmN0aW9uLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBlbmNvZGluZyAtIEV4cGxpY2l0bHkgc2V0cyBzdHJlYW1zIGVuY29kaW5nIGZvciB0aGUgZXhlY3V0ZWRcbiAqIGNvbW1hbmQgaW5wdXQgYW5kIG91dHB1dHMuXG4gKi9cblxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFNpbWN0bE9wdHNcbiAqIEBwcm9wZXJ0eSB7P09iamVjdH0geGNydW4gLSBUaGUgeGNydW4gcHJvcGVydGllcy4gQ3VycmVudGx5IG9ubHkgb25lIHByb3BlcnR5XG4gKiBpcyBzdXBwb3J0ZWQsIHdoaWNoIGlzIGBwYXRoYCBhbmQgaXQgYnkgZGVmYXVsdCBjb250YWlucyBgbnVsbGAsIHdoaWNoIGVuZm9yY2VzXG4gKiB0aGUgaW5zdGFuY2UgdG8gYXV0b21hdGljYWxseSBkZXRlY3QgdGhlIGZ1bGwgcGF0aCB0byBgeGNydW5gIHRvb2wgYW5kIHRvIHRocm93XG4gKiBhbiBleGNlcHRpb24gaWYgaXQgY2Fubm90IGJlIGRldGVjdGVkLiBJZiB0aGUgcGF0aCBpcyBzZXQgdXBvbiBpbnN0YW5jZSBjcmVhdGlvblxuICogdGhlbiBpdCBpcyBnb2luZyB0byBiZSB1c2VkIGJ5IGBleGVjYCBhbmQgbm8gYXV0b2RldGVjdGlvbiB3aWxsIGhhcHBlbi5cbiAqIEBwcm9wZXJ0eSB7P251bWJlcn0gZXhlY1RpbWVvdXQgWzYwMDAwMF0gLSBUaGUgbWF4aW11bSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzXG4gKiB0byB3YWl0IGZvciBzaW5nbGUgc3luY2hyb25vdXMgeGNydW4gY29tbWFuZC5cbiAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IGxvZ0Vycm9ycyBbdHJ1ZV0gLSBXaGV0aGVyIHRvIHdpcmUgeGNydW4gZXJyb3IgbWVzc2FnZXNcbiAqIGludG8gZGVidWcgbG9nIGJlZm9yZSB0aHJvd2luZyB0aGVtLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB1ZGlkIFtudWxsXSAtIFRoZSB1bmlxdWUgaWRlbnRpZmllciBvZiB0aGUgY3VycmVudCBkZXZpY2UsIHdoaWNoIGlzXG4gKiBnb2luZyB0byBiZSBpbXBsaWNpdGx5IHBhc3NlZCB0byBhbGwgbWV0aG9kcywgd2hpY2ggcmVxdWlyZSBpdC4gSXQgY2FuIGVpdGhlciBiZSBzZXRcbiAqIHVwb24gaW5zdGFuY2UgY3JlYXRpb24gaWYgaXQgaXMgYWxyZWFkeSBrbm93biBpbiBhZHZhbmNlIG9yIGxhdGVyIHdoZW4vaWYgbmVlZGVkIHZpYSB0aGVcbiAqIGNvcnJlc3BvbmRpbmcgaW5zdGFuY2Ugc2V0dGVyLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBkZXZpY2VzU2V0UGF0aCAtIEZ1bGwgcGF0aCB0byB0aGUgc2V0IG9mIGRldmljZXMgdGhhdCB5b3Ugd2FudCB0byBtYW5hZ2UuXG4gKiBCeSBkZWZhdWx0IHRoaXMgcGF0aCB1c3VhbGx5IGVxdWFscyB0byB+L0xpYnJhcnkvRGV2ZWxvcGVyL0NvcmVTaW11bGF0b3IvRGV2aWNlc1xuICovXG5cblxuY2xhc3MgU2ltY3RsIHtcbiAgLyoqXG4gICAqIEBwYXJhbSB7P1NpbWN0bE9wdHN9IG9wdHNcbiAgICovXG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBvcHRzID0gXy5jbG9uZURlZXAob3B0cyk7XG4gICAgXy5kZWZhdWx0c0RlZXAob3B0cywgREVGQVVMVF9PUFRTKTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBfLmtleXMoREVGQVVMVF9PUFRTKSkge1xuICAgICAgdGhpc1trZXldID0gb3B0c1trZXldO1xuICAgIH1cbiAgICB0aGlzLl91ZGlkID0gXy5pc05pbChvcHRzLnVkaWQpID8gbnVsbCA6IG9wdHMudWRpZDtcbiAgICB0aGlzLl9kZXZpY2VzU2V0UGF0aCA9IF8uaXNOaWwob3B0cy5kZXZpY2VzU2V0UGF0aCkgPyBudWxsIDogb3B0cy5kZXZpY2VzU2V0UGF0aDtcbiAgfVxuXG4gIHNldCB1ZGlkICh2YWx1ZSkge1xuICAgIHRoaXMuX3VkaWQgPSB2YWx1ZTtcbiAgfVxuXG4gIGdldCB1ZGlkICgpIHtcbiAgICByZXR1cm4gdGhpcy5fdWRpZDtcbiAgfVxuXG4gIHNldCBkZXZpY2VzU2V0UGF0aCAodmFsdWUpIHtcbiAgICB0aGlzLl9kZXZpY2VzU2V0UGF0aCA9IHZhbHVlO1xuICB9XG5cbiAgZ2V0IGRldmljZXNTZXRQYXRoICgpIHtcbiAgICByZXR1cm4gdGhpcy5fZGV2aWNlc1NldFBhdGg7XG4gIH1cblxuICByZXF1aXJlVWRpZCAoY29tbWFuZE5hbWUgPSBudWxsKSB7XG4gICAgaWYgKCF0aGlzLnVkaWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgdWRpZCBpcyByZXF1aXJlZCB0byBiZSBzZXQgZm9yIGAgK1xuICAgICAgICAoY29tbWFuZE5hbWUgPyBgdGhlICcke2NvbW1hbmROYW1lfScgY29tbWFuZGAgOiAndGhpcyBzaW1jdGwgY29tbWFuZCcpKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudWRpZDtcbiAgfVxuXG4gIGFzeW5jIHJlcXVpcmVYY3J1biAoKSB7XG4gICAgaWYgKCF0aGlzLnhjcnVuLnBhdGgpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHRoaXMueGNydW4ucGF0aCA9IGF3YWl0IHdoaWNoKFhDUlVOX0JJTkFSWSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJHtYQ1JVTl9CSU5BUll9IHRvb2wgaGFzIG5vdCBiZWVuIGZvdW5kIGluIFBBVEguIGAgK1xuICAgICAgICAgIGBBcmUgWGNvZGUgZGV2ZWxvcGVycyB0b29scyBpbnN0YWxsZWQ/YCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnhjcnVuLnBhdGg7XG4gIH1cblxuICAvKipcbiAgICogRXhlY3V0ZSB0aGUgcGFydGljdWxhciBzaW1jdGwgY29tbWFuZC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN1YmNvbW1hbmQgLSBPbmUgb2YgYXZhaWxhYmxlIHNpbWN0bCBzdWJjb21tYW5kcy5cbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICBFeGVjdXRlIGB4Y3J1biBzaW1jdGxgIGluIFRlcm1pbmFsIHRvIHNlZSB0aGUgZnVsbCBsaXN0XG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgb2YgYXZhaWxhYmxlIHN1YmNvbW1hbmRzLlxuICAgKiBAcGFyYW0gez9FeGVjT3B0c30gb3B0c1xuICAgKiBAcmV0dXJuIHtFeGVjUmVzdWx0fFN1YlByb2Nlc3N9IEVpdGhlciB0aGUgcmVzdWx0IG9mIHRlZW4gcHJvY2VzcydzIGBleGVjYCBvclxuICAgKiBgU3ViUHJvY2Vzc2AgaW5zdGFuY2UgZGVwZW5kaW5nIG9mIGBvcHRzLmFzeW5jaHJvbm91c2AgdmFsdWUuXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgc2ltY3RsIHN1YmNvbW1hbmQgY29tbWFuZCByZXR1cm5zIG5vbi16ZXJvIHJldHVybiBjb2RlLlxuICAgKi9cbiAgYXN5bmMgZXhlYyAoc3ViY29tbWFuZCwgb3B0cyA9IHt9KSB7XG4gICAgbGV0IHtcbiAgICAgIGFyZ3MgPSBbXSxcbiAgICAgIGVudiA9IHt9LFxuICAgICAgYXN5bmNocm9ub3VzID0gZmFsc2UsXG4gICAgICBlbmNvZGluZyxcbiAgICAgIGxvZ0Vycm9ycyA9IHRydWUsXG4gICAgfSA9IG9wdHM7XG4gICAgLy8gcnVuIGEgcGFydGljdWxhciBzaW1jdGwgY29tbWFuZFxuICAgIGFyZ3MgPSBbJ3NpbWN0bCcsXG4gICAgICAuLi4odGhpcy5kZXZpY2VzU2V0UGF0aCA/IFsnLS1zZXQnLCB0aGlzLmRldmljZXNTZXRQYXRoXSA6IFtdKSxcbiAgICAgIHN1YmNvbW1hbmQsXG4gICAgICAuLi5hcmdzXG4gICAgXTtcbiAgICAvLyBQcmVmaXggYWxsIHBhc3NlZCBpbiBlbnZpcm9ubWVudCB2YXJpYWJsZXMgd2l0aCAnU0lNQ1RMX0NISUxEXycsIHNpbWN0bFxuICAgIC8vIHdpbGwgdGhlbiBwYXNzIHRoZXNlIHRvIHRoZSBjaGlsZCAoc3Bhd25lZCkgcHJvY2Vzcy5cbiAgICBlbnYgPSBfLmRlZmF1bHRzKFxuICAgICAgXy5tYXBLZXlzKGVudixcbiAgICAgICAgKHZhbHVlLCBrZXkpID0+IF8uc3RhcnRzV2l0aChrZXksIFNJTUNUTF9FTlZfUFJFRklYKSA/IGtleSA6IGAke1NJTUNUTF9FTlZfUFJFRklYfSR7a2V5fWApLFxuICAgICAgcHJvY2Vzcy5lbnYpO1xuXG4gICAgY29uc3QgZXhlY09wdHMgPSB7XG4gICAgICBlbnYsXG4gICAgICBlbmNvZGluZyxcbiAgICB9O1xuICAgIGlmICghYXN5bmNocm9ub3VzKSB7XG4gICAgICBleGVjT3B0cy50aW1lb3V0ID0gdGhpcy5leGVjVGltZW91dDtcbiAgICB9XG4gICAgY29uc3QgeGNydW4gPSBhd2FpdCB0aGlzLnJlcXVpcmVYY3J1bigpO1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXN5bmNocm9ub3VzID8gbmV3IFN1YlByb2Nlc3MoeGNydW4sIGFyZ3MsIGV4ZWNPcHRzKSA6IGF3YWl0IHRwRXhlYyh4Y3J1biwgYXJncywgZXhlY09wdHMpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmICghdGhpcy5sb2dFcnJvcnMgfHwgIWxvZ0Vycm9ycykge1xuICAgICAgICAvLyBpZiB3ZSBkb24ndCB3YW50IHRvIHNlZSB0aGUgZXJyb3JzLCBqdXN0IHRocm93IGFuZCBhbGxvdyB0aGUgY2FsbGluZ1xuICAgICAgICAvLyBjb2RlIGRvIHdoYXQgaXQgd2FudHNcbiAgICAgIH0gZWxzZSBpZiAoZS5zdGRlcnIpIHtcbiAgICAgICAgY29uc3QgbXNnID0gYEVycm9yIHJ1bm5pbmcgJyR7c3ViY29tbWFuZH0nOiAke2Uuc3RkZXJyLnRyaW0oKX1gO1xuICAgICAgICBsb2cuZGVidWcoTE9HX1BSRUZJWCwgbXNnKTtcbiAgICAgICAgZS5tZXNzYWdlID0gbXNnO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmRlYnVnKExPR19QUkVGSVgsIGUubWVzc2FnZSk7XG4gICAgICB9XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxufVxuXG5cbi8vIGFkZCBhbGwgdGhlIHN1YmNvbW1hbmRzIHRvIHRoZSBTaW1jdGwgcHJvdG90eXBlXG5mb3IgKGNvbnN0IFtmbk5hbWUsIGZuXSBvZiBfLnRvUGFpcnMoc3ViY29tbWFuZHMpKSB7XG4gIFNpbWN0bC5wcm90b3R5cGVbZm5OYW1lXSA9IGZuO1xufVxuXG5leHBvcnQgZGVmYXVsdCBTaW1jdGw7XG5leHBvcnQgeyBTaW1jdGwgfTsiXSwiZmlsZSI6ImxpYi9zaW1jdGwuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
