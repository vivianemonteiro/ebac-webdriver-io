"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumBaseDriver = require("appium-base-driver");

var _utils = require("../utils");

var _atoms = require("../atoms");

var _appiumSupport = require("appium-support");

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

const RPC_RESPONSE_TIMEOUT_MS = 5000;

async function executeAtom(atom, args, frames) {
  if (!this.rpcClient.isConnected) {
    throw new Error('Remote debugger is not connected');
  }

  _logger.default.debug(`Executing atom '${atom}' with 'args=${JSON.stringify(args)}; frames=${frames}'`);

  const script = await (0, _atoms.getScriptForAtom)(atom, args, frames);
  const value = await this.execute(script, true);

  _logger.default.debug(`Received result for atom '${atom}' execution: ${_lodash.default.truncate((0, _utils.simpleStringify)(value), {
    length: _utils.RESPONSE_LOG_LENGTH
  })}`);

  return value;
}

async function executeAtomAsync(atom, args, frames) {
  const evaluate = async (method, opts) => await this.rpcClient.send(method, Object.assign({
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey,
    returnByValue: false
  }, opts));

  const promiseName = `appiumAsyncExecutePromise${_appiumSupport.util.uuidV4().replace(/-/g, '')}`;
  const script = `var res, rej;
    window.${promiseName} = new Promise(function (resolve, reject) {
      res = resolve;
      rej = reject;
    });
    window.${promiseName}.resolve = res;
    window.${promiseName}.reject = rej;
    window.${promiseName};`;
  const obj = await evaluate('Runtime.evaluate', {
    expression: script
  });
  const promiseObjectId = obj.result.objectId;
  const asyncCallBack = `function (res) {
      window.${promiseName}.resolve(res);
      window.${promiseName}Value = res;
    }`;
  await this.execute(await (0, _atoms.getScriptForAtom)(atom, args, frames, asyncCallBack));
  let res;
  const subcommandTimeout = 1000;

  try {
    res = await evaluate('Runtime.awaitPromise', {
      promiseObjectId,
      returnByValue: true,
      generatePreview: true,
      saveResult: true
    });
  } catch (err) {
    if (!err.message.includes(`'Runtime.awaitPromise' was not found`)) {
      throw err;
    }

    const retryWait = 100;
    const timeout = args.length >= 3 ? args[2] : RPC_RESPONSE_TIMEOUT_MS;
    const retries = parseInt(timeout / retryWait, 10) || 1;
    const timer = new _appiumSupport.timing.Timer().start();

    _logger.default.debug(`Waiting up to ${timeout}ms for async execute to finish`);

    res = await (0, _asyncbox.retryInterval)(retries, retryWait, async () => {
      const hasValue = await evaluate('Runtime.evaluate', {
        expression: `window.hasOwnProperty('${promiseName}Value');`,
        returnByValue: true
      });

      if (hasValue) {
        return await evaluate('Runtime.evaluate', {
          expression: `window.${promiseName}Value;`,
          returnByValue: true
        });
      }

      throw new _appiumBaseDriver.errors.TimeoutError(`Timed out waiting for asynchronous script ` + `result after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms'));`);
    });
  } finally {
    try {
      await this.executeAtom('execute_script', [`delete window.${promiseName};`, [null, null], subcommandTimeout], frames);
    } catch (ign) {}
  }

  return (0, _utils.convertResult)(res);
}

async function execute(command, override) {
  if (this.pageLoading && !override) {
    _logger.default.debug('Trying to execute but page is not loaded.');

    await this.waitForDom();
  }

  (0, _utils.checkParams)({
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });

  if (this.garbageCollectOnExecute) {
    await this.garbageCollect();
  }

  _logger.default.debug(`Sending javascript command: '${_lodash.default.truncate(command, {
    length: 50
  })}'`);

  const res = await this.rpcClient.send('Runtime.evaluate', {
    expression: command,
    returnByValue: true,
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });
  return (0, _utils.convertResult)(res);
}

async function callFunction(objectId, fn, args) {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });

  if (this.garbageCollectOnExecute) {
    await this.garbageCollect();
  }

  _logger.default.debug('Calling javascript function');

  const res = await this.rpcClient.send('Runtime.callFunctionOn', {
    objectId,
    functionDeclaration: fn,
    arguments: args,
    returnByValue: true,
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });
  return (0, _utils.convertResult)(res);
}

var _default = {
  executeAtom,
  executeAtomAsync,
  execute,
  callFunction
};
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9taXhpbnMvZXhlY3V0ZS5qcyJdLCJuYW1lcyI6WyJSUENfUkVTUE9OU0VfVElNRU9VVF9NUyIsImV4ZWN1dGVBdG9tIiwiYXRvbSIsImFyZ3MiLCJmcmFtZXMiLCJycGNDbGllbnQiLCJpc0Nvbm5lY3RlZCIsIkVycm9yIiwibG9nIiwiZGVidWciLCJKU09OIiwic3RyaW5naWZ5Iiwic2NyaXB0IiwidmFsdWUiLCJleGVjdXRlIiwiXyIsInRydW5jYXRlIiwibGVuZ3RoIiwiUkVTUE9OU0VfTE9HX0xFTkdUSCIsImV4ZWN1dGVBdG9tQXN5bmMiLCJldmFsdWF0ZSIsIm1ldGhvZCIsIm9wdHMiLCJzZW5kIiwiT2JqZWN0IiwiYXNzaWduIiwiYXBwSWRLZXkiLCJwYWdlSWRLZXkiLCJyZXR1cm5CeVZhbHVlIiwicHJvbWlzZU5hbWUiLCJ1dGlsIiwidXVpZFY0IiwicmVwbGFjZSIsIm9iaiIsImV4cHJlc3Npb24iLCJwcm9taXNlT2JqZWN0SWQiLCJyZXN1bHQiLCJvYmplY3RJZCIsImFzeW5jQ2FsbEJhY2siLCJyZXMiLCJzdWJjb21tYW5kVGltZW91dCIsImdlbmVyYXRlUHJldmlldyIsInNhdmVSZXN1bHQiLCJlcnIiLCJtZXNzYWdlIiwiaW5jbHVkZXMiLCJyZXRyeVdhaXQiLCJ0aW1lb3V0IiwicmV0cmllcyIsInBhcnNlSW50IiwidGltZXIiLCJ0aW1pbmciLCJUaW1lciIsInN0YXJ0IiwiaGFzVmFsdWUiLCJlcnJvcnMiLCJUaW1lb3V0RXJyb3IiLCJnZXREdXJhdGlvbiIsImFzTWlsbGlTZWNvbmRzIiwidG9GaXhlZCIsImlnbiIsImNvbW1hbmQiLCJvdmVycmlkZSIsInBhZ2VMb2FkaW5nIiwid2FpdEZvckRvbSIsImdhcmJhZ2VDb2xsZWN0T25FeGVjdXRlIiwiZ2FyYmFnZUNvbGxlY3QiLCJjYWxsRnVuY3Rpb24iLCJmbiIsImZ1bmN0aW9uRGVjbGFyYXRpb24iLCJhcmd1bWVudHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7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S0E7QUFBMUMsR0FBWjs7QUFFQSxNQUFJLEtBQUtzQyx1QkFBVCxFQUFrQztBQUNoQyxVQUFNLEtBQUtDLGNBQUwsRUFBTjtBQUNEOztBQUVEMUQsa0JBQUlDLEtBQUosQ0FBVSw2QkFBVjs7QUFDQSxRQUFNOEIsR0FBRyxHQUFHLE1BQU0sS0FBS2xDLFNBQUwsQ0FBZWtCLElBQWYsQ0FBb0Isd0JBQXBCLEVBQThDO0FBQzlEYyxJQUFBQSxRQUQ4RDtBQUU5RGdDLElBQUFBLG1CQUFtQixFQUFFRCxFQUZ5QztBQUc5REUsSUFBQUEsU0FBUyxFQUFFbkUsSUFIbUQ7QUFJOUR5QixJQUFBQSxhQUFhLEVBQUUsSUFKK0M7QUFLOURGLElBQUFBLFFBQVEsRUFBRSxLQUFLQSxRQUwrQztBQU05REMsSUFBQUEsU0FBUyxFQUFFLEtBQUtBO0FBTjhDLEdBQTlDLENBQWxCO0FBU0EsU0FBTywwQkFBY1ksR0FBZCxDQUFQO0FBQ0Q7O2VBR2M7QUFBRXRDLEVBQUFBLFdBQUY7QUFBZWtCLEVBQUFBLGdCQUFmO0FBQWlDTCxFQUFBQSxPQUFqQztBQUEwQ3FELEVBQUFBO0FBQTFDLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgY2hlY2tQYXJhbXMsIHNpbXBsZVN0cmluZ2lmeSwgY29udmVydFJlc3VsdCwgUkVTUE9OU0VfTE9HX0xFTkdUSCB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IGdldFNjcmlwdEZvckF0b20gfSBmcm9tICcuLi9hdG9tcyc7XG5pbXBvcnQgeyB1dGlsLCB0aW1pbmcgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG4vKiBIb3cgbWFueSBtaWxsaXNlY29uZHMgdG8gd2FpdCBmb3Igd2Via2l0IHRvIHJldHVybiBhIHJlc3BvbnNlIGJlZm9yZSB0aW1pbmcgb3V0ICovXG5jb25zdCBSUENfUkVTUE9OU0VfVElNRU9VVF9NUyA9IDUwMDA7XG5cbi8qKlxuICogRXhlY3V0ZSBhIFNlbGVuaXVtIGF0b20gaW4gU2FmYXJpXG4gKiBAcGFyYW0ge3N0cmluZ30gYXRvbSBOYW1lIG9mIFNlbGVuaXVtIGF0b20gKHNlZSBhdG9tcy8gZGlyZWN0b3J5KVxuICogQHBhcmFtIHtBcnJheTwqPn0gYXJncyBBcmd1bWVudHMgcGFzc2VkIHRvIHRoZSBhdG9tXG4gKiBAcGFyYW0ge0FycmF5PHN0cmluZz59IGZyYW1lc1xuICogQHJldHVybnMge3N0cmluZ30gVGhlIHJlc3VsdCByZWNlaXZlZCBmcm9tIHRoZSBhdG9tXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGVBdG9tIChhdG9tLCBhcmdzLCBmcmFtZXMpIHtcbiAgaWYgKCF0aGlzLnJwY0NsaWVudC5pc0Nvbm5lY3RlZCkge1xuICAgIHRocm93IG5ldyBFcnJvcignUmVtb3RlIGRlYnVnZ2VyIGlzIG5vdCBjb25uZWN0ZWQnKTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZyhgRXhlY3V0aW5nIGF0b20gJyR7YXRvbX0nIHdpdGggJ2FyZ3M9JHtKU09OLnN0cmluZ2lmeShhcmdzKX07IGZyYW1lcz0ke2ZyYW1lc30nYCk7XG4gIGNvbnN0IHNjcmlwdCA9IGF3YWl0IGdldFNjcmlwdEZvckF0b20oYXRvbSwgYXJncywgZnJhbWVzKTtcbiAgY29uc3QgdmFsdWUgPSBhd2FpdCB0aGlzLmV4ZWN1dGUoc2NyaXB0LCB0cnVlKTtcbiAgbG9nLmRlYnVnKGBSZWNlaXZlZCByZXN1bHQgZm9yIGF0b20gJyR7YXRvbX0nIGV4ZWN1dGlvbjogJHtfLnRydW5jYXRlKHNpbXBsZVN0cmluZ2lmeSh2YWx1ZSksIHtsZW5ndGg6IFJFU1BPTlNFX0xPR19MRU5HVEh9KX1gKTtcbiAgcmV0dXJuIHZhbHVlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBleGVjdXRlQXRvbUFzeW5jIChhdG9tLCBhcmdzLCBmcmFtZXMpIHtcbiAgLy8gaGVscGVyIHRvIHNlbmQgZGlyZWN0bHkgdG8gdGhlIHdlYiBpbnNwZWN0b3JcbiAgY29uc3QgZXZhbHVhdGUgPSBhc3luYyAobWV0aG9kLCBvcHRzKSA9PiBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKG1ldGhvZCwgT2JqZWN0LmFzc2lnbih7XG4gICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICByZXR1cm5CeVZhbHVlOiBmYWxzZSxcbiAgfSwgb3B0cykpO1xuXG4gIC8vIGZpcnN0IGNyZWF0ZSBhIFByb21pc2Ugb24gdGhlIHBhZ2UsIHNhdmluZyB0aGUgcmVzb2x2ZS9yZWplY3QgZnVuY3Rpb25zXG4gIC8vIGFzIHByb3BlcnRpZXNcbiAgY29uc3QgcHJvbWlzZU5hbWUgPSBgYXBwaXVtQXN5bmNFeGVjdXRlUHJvbWlzZSR7dXRpbC51dWlkVjQoKS5yZXBsYWNlKC8tL2csICcnKX1gO1xuICBjb25zdCBzY3JpcHQgPVxuICAgIGB2YXIgcmVzLCByZWo7XG4gICAgd2luZG93LiR7cHJvbWlzZU5hbWV9ID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgcmVzID0gcmVzb2x2ZTtcbiAgICAgIHJlaiA9IHJlamVjdDtcbiAgICB9KTtcbiAgICB3aW5kb3cuJHtwcm9taXNlTmFtZX0ucmVzb2x2ZSA9IHJlcztcbiAgICB3aW5kb3cuJHtwcm9taXNlTmFtZX0ucmVqZWN0ID0gcmVqO1xuICAgIHdpbmRvdy4ke3Byb21pc2VOYW1lfTtgO1xuICBjb25zdCBvYmogPSBhd2FpdCBldmFsdWF0ZSgnUnVudGltZS5ldmFsdWF0ZScsIHtcbiAgICBleHByZXNzaW9uOiBzY3JpcHQsXG4gIH0pO1xuICBjb25zdCBwcm9taXNlT2JqZWN0SWQgPSBvYmoucmVzdWx0Lm9iamVjdElkO1xuXG4gIC8vIGV4ZWN1dGUgdGhlIGF0b20sIGNhbGxpbmcgYmFjayB0byB0aGUgcmVzb2x2ZSBmdW5jdGlvblxuICBjb25zdCBhc3luY0NhbGxCYWNrID1cbiAgICBgZnVuY3Rpb24gKHJlcykge1xuICAgICAgd2luZG93LiR7cHJvbWlzZU5hbWV9LnJlc29sdmUocmVzKTtcbiAgICAgIHdpbmRvdy4ke3Byb21pc2VOYW1lfVZhbHVlID0gcmVzO1xuICAgIH1gO1xuICBhd2FpdCB0aGlzLmV4ZWN1dGUoYXdhaXQgZ2V0U2NyaXB0Rm9yQXRvbShhdG9tLCBhcmdzLCBmcmFtZXMsIGFzeW5jQ2FsbEJhY2spKTtcblxuICAvLyB3YWl0IGZvciB0aGUgcHJvbWlzZSB0byBiZSByZXNvbHZlZFxuICBsZXQgcmVzO1xuICBjb25zdCBzdWJjb21tYW5kVGltZW91dCA9IDEwMDA7IC8vIHRpbWVvdXQgb24gaW5kaXZpZHVhbCBjb21tYW5kc1xuICB0cnkge1xuICAgIHJlcyA9IGF3YWl0IGV2YWx1YXRlKCdSdW50aW1lLmF3YWl0UHJvbWlzZScsIHtcbiAgICAgIHByb21pc2VPYmplY3RJZCxcbiAgICAgIHJldHVybkJ5VmFsdWU6IHRydWUsXG4gICAgICBnZW5lcmF0ZVByZXZpZXc6IHRydWUsXG4gICAgICBzYXZlUmVzdWx0OiB0cnVlLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoIWVyci5tZXNzYWdlLmluY2x1ZGVzKGAnUnVudGltZS5hd2FpdFByb21pc2UnIHdhcyBub3QgZm91bmRgKSkge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgICAvLyBhd2FpdFByb21pc2UgaXMgbm90IGFsd2F5cyBhdmFpbGFibGUsIHNvIHNpbXVsYXRlIGl0IHdpdGggcG9sbFxuICAgIGNvbnN0IHJldHJ5V2FpdCA9IDEwMDtcbiAgICBjb25zdCB0aW1lb3V0ID0gKGFyZ3MubGVuZ3RoID49IDMpID8gYXJnc1syXSA6IFJQQ19SRVNQT05TRV9USU1FT1VUX01TO1xuICAgIC8vIGlmIHRoZSB0aW1lb3V0IG1hdGggdHVybnMgdXAgMCByZXRyaWVzLCBtYWtlIHN1cmUgaXQgaGFwcGVucyBvbmNlXG4gICAgY29uc3QgcmV0cmllcyA9IHBhcnNlSW50KHRpbWVvdXQgLyByZXRyeVdhaXQsIDEwKSB8fCAxO1xuICAgIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gICAgbG9nLmRlYnVnKGBXYWl0aW5nIHVwIHRvICR7dGltZW91dH1tcyBmb3IgYXN5bmMgZXhlY3V0ZSB0byBmaW5pc2hgKTtcbiAgICByZXMgPSBhd2FpdCByZXRyeUludGVydmFsKHJldHJpZXMsIHJldHJ5V2FpdCwgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gdGhlIGF0b20gX3dpbGxfIHJldHVybiwgZWl0aGVyIGJlY2F1c2UgaXQgZmluaXNoZWQgb3IgYW4gZXJyb3JcbiAgICAgIC8vIGluY2x1ZGluZyBhIHRpbWVvdXQgZXJyb3JcbiAgICAgIGNvbnN0IGhhc1ZhbHVlID0gYXdhaXQgZXZhbHVhdGUoJ1J1bnRpbWUuZXZhbHVhdGUnLCB7XG4gICAgICAgIGV4cHJlc3Npb246IGB3aW5kb3cuaGFzT3duUHJvcGVydHkoJyR7cHJvbWlzZU5hbWV9VmFsdWUnKTtgLFxuICAgICAgICByZXR1cm5CeVZhbHVlOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICBpZiAoaGFzVmFsdWUpIHtcbiAgICAgICAgLy8gd2Ugb25seSBwdXQgdGhlIHByb3BlcnR5IG9uIGB3aW5kb3dgIHdoZW4gdGhlIGNhbGxiYWNrIGlzIGNhbGxlZCxcbiAgICAgICAgLy8gc28gaWYgaXQgaXMgdGhlcmUsIGV2ZXJ5dGhpbmcgaXMgZG9uZVxuICAgICAgICByZXR1cm4gYXdhaXQgZXZhbHVhdGUoJ1J1bnRpbWUuZXZhbHVhdGUnLCB7XG4gICAgICAgICAgZXhwcmVzc2lvbjogYHdpbmRvdy4ke3Byb21pc2VOYW1lfVZhbHVlO2AsXG4gICAgICAgICAgcmV0dXJuQnlWYWx1ZTogdHJ1ZSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICAvLyB0aHJvdyBhIFRpbWVvdXRFcnJvciwgb3IgZWxzZSBpdCBuZWVkcyB0byBiZSBjYXVnaHQgYW5kIHJlLXRocm93blxuICAgICAgdGhyb3cgbmV3IGVycm9ycy5UaW1lb3V0RXJyb3IoYFRpbWVkIG91dCB3YWl0aW5nIGZvciBhc3luY2hyb25vdXMgc2NyaXB0IGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYHJlc3VsdCBhZnRlciAke3RpbWVyLmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMudG9GaXhlZCgwKX1tcycpKTtgKTtcbiAgICB9KTtcbiAgfSBmaW5hbGx5IHtcbiAgICB0cnkge1xuICAgICAgLy8gdHJ5IHRvIGdldCByaWQgb2YgdGhlIHByb21pc2VcbiAgICAgIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2V4ZWN1dGVfc2NyaXB0JywgW2BkZWxldGUgd2luZG93LiR7cHJvbWlzZU5hbWV9O2AsIFtudWxsLCBudWxsXSwgc3ViY29tbWFuZFRpbWVvdXRdLCBmcmFtZXMpO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgfVxuICByZXR1cm4gY29udmVydFJlc3VsdChyZXMpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBleGVjdXRlIChjb21tYW5kLCBvdmVycmlkZSkge1xuICAvLyBpZiB0aGUgcGFnZSBpcyBub3QgbG9hZGVkIHlldCwgd2FpdCBmb3IgaXRcbiAgaWYgKHRoaXMucGFnZUxvYWRpbmcgJiYgIW92ZXJyaWRlKSB7XG4gICAgbG9nLmRlYnVnKCdUcnlpbmcgdG8gZXhlY3V0ZSBidXQgcGFnZSBpcyBub3QgbG9hZGVkLicpO1xuICAgIGF3YWl0IHRoaXMud2FpdEZvckRvbSgpO1xuICB9XG5cbiAgY2hlY2tQYXJhbXMoe2FwcElkS2V5OiB0aGlzLmFwcElkS2V5LCBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5fSk7XG5cbiAgaWYgKHRoaXMuZ2FyYmFnZUNvbGxlY3RPbkV4ZWN1dGUpIHtcbiAgICBhd2FpdCB0aGlzLmdhcmJhZ2VDb2xsZWN0KCk7XG4gIH1cblxuICBsb2cuZGVidWcoYFNlbmRpbmcgamF2YXNjcmlwdCBjb21tYW5kOiAnJHtfLnRydW5jYXRlKGNvbW1hbmQsIHtsZW5ndGg6IDUwfSl9J2ApO1xuICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdSdW50aW1lLmV2YWx1YXRlJywge1xuICAgIGV4cHJlc3Npb246IGNvbW1hbmQsXG4gICAgcmV0dXJuQnlWYWx1ZTogdHJ1ZSxcbiAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICB9KTtcblxuICByZXR1cm4gY29udmVydFJlc3VsdChyZXMpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjYWxsRnVuY3Rpb24gKG9iamVjdElkLCBmbiwgYXJncykge1xuICBjaGVja1BhcmFtcyh7YXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXl9KTtcblxuICBpZiAodGhpcy5nYXJiYWdlQ29sbGVjdE9uRXhlY3V0ZSkge1xuICAgIGF3YWl0IHRoaXMuZ2FyYmFnZUNvbGxlY3QoKTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZygnQ2FsbGluZyBqYXZhc2NyaXB0IGZ1bmN0aW9uJyk7XG4gIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ1J1bnRpbWUuY2FsbEZ1bmN0aW9uT24nLCB7XG4gICAgb2JqZWN0SWQsXG4gICAgZnVuY3Rpb25EZWNsYXJhdGlvbjogZm4sXG4gICAgYXJndW1lbnRzOiBhcmdzLFxuICAgIHJldHVybkJ5VmFsdWU6IHRydWUsXG4gICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgfSk7XG5cbiAgcmV0dXJuIGNvbnZlcnRSZXN1bHQocmVzKTtcbn1cblxuXG5leHBvcnQgZGVmYXVsdCB7IGV4ZWN1dGVBdG9tLCBleGVjdXRlQXRvbUFzeW5jLCBleGVjdXRlLCBjYWxsRnVuY3Rpb24gfTtcbiJdLCJmaWxlIjoibGliL21peGlucy9leGVjdXRlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
