"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _events = _interopRequireDefault(require("./events"));

var _utils = require("../utils");

var _lodash = _interopRequireDefault(require("lodash"));

async function onPageChange(err, appIdKey, pageDict) {
  if (_lodash.default.isEmpty(pageDict)) {
    return;
  }

  const pageArray = (0, _utils.pageArrayFromDict)(pageDict);
  await this.useAppDictLock(done => {
    try {
      if (this.appDict[appIdKey]) {
        if (this.appDict[appIdKey].pageArray) {
          if (this.appDict[appIdKey].pageArray.resolve) {
            this.appDict[appIdKey].pageArray.resolve();
          } else {
            if (_lodash.default.isEqual(this.appDict[appIdKey].pageArray, pageArray)) {
              _logger.default.debug(`Received page change notice for app '${appIdKey}' ` + `but the listing has not changed. Ignoring.`);

              return done();
            }
          }
        }

        this.appDict[appIdKey].pageArray = pageArray;
      }
    } finally {
      done();
    }
  });

  if (this._navigatingToPage) {
    return;
  }

  _logger.default.debug(`Page changed: ${(0, _utils.simpleStringify)(pageDict, true)}`);

  this.emit(_events.default.EVENT_PAGE_CHANGE, {
    appIdKey: appIdKey.replace('PID:', ''),
    pageArray
  });
}

async function onAppConnect(err, dict) {
  const appIdKey = dict.WIRApplicationIdentifierKey;

  _logger.default.debug(`Notified that new application '${appIdKey}' has connected`);

  await this.useAppDictLock(done => {
    try {
      this.updateAppsWithDict(dict);
    } finally {
      done();
    }
  });
}

function onAppDisconnect(err, dict) {
  const appIdKey = dict.WIRApplicationIdentifierKey;

  _logger.default.debug(`Application '${appIdKey}' disconnected. Removing from app dictionary.`);

  _logger.default.debug(`Current app is '${this.appIdKey}'`);

  delete this.appDict[appIdKey];

  if (this.appIdKey === appIdKey) {
    _logger.default.debug(`No longer have app id. Attempting to find new one.`);

    this.appIdKey = (0, _utils.getDebuggerAppKey)(this.bundleId, this.appDict);
  }

  if (!this.appDict) {
    _logger.default.debug('Main app disconnected. Disconnecting altogether.');

    this.connected = false;
    this.emit(_events.default.EVENT_DISCONNECT, true);
  }
}

async function onAppUpdate(err, dict) {
  await this.useAppDictLock(done => {
    try {
      this.updateAppsWithDict(dict);
    } finally {
      done();
    }
  });
}

function onConnectedDriverList(err, drivers) {
  this.connectedDrivers = drivers.WIRDriverDictionaryKey;

  _logger.default.debug(`Received connected driver list: ${JSON.stringify(this.connectedDrivers)}`);
}

function onCurrentState(err, state) {
  this.currentState = state.WIRAutomationAvailabilityKey;

  _logger.default.debug(`Received connected automation availability state: ${JSON.stringify(this.currentState)}`);
}

async function onConnectedApplicationList(err, apps) {
  _logger.default.debug(`Received connected applications list: ${_lodash.default.keys(apps).join(', ')}`);

  let newDict = {};

  for (const dict of _lodash.default.values(apps)) {
    const [id, entry] = (0, _utils.appInfoFromDict)(dict);

    if (this.skippedApps.includes(entry.name)) {
      continue;
    }

    newDict[id] = entry;
  }

  await this.useAppDictLock(done => {
    try {
      _lodash.default.defaults(this.appDict, newDict);
    } finally {
      done();
    }
  });
}

const messageHandlers = {
  onPageChange,
  onAppConnect,
  onAppDisconnect,
  onAppUpdate,
  onConnectedDriverList,
  onCurrentState,
  onConnectedApplicationList
};
var _default = messageHandlers;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9taXhpbnMvbWVzc2FnZS1oYW5kbGVycy5qcyJdLCJuYW1lcyI6WyJvblBhZ2VDaGFuZ2UiLCJlcnIiLCJhcHBJZEtleSIsInBhZ2VEaWN0IiwiXyIsImlzRW1wdHkiLCJwYWdlQXJyYXkiLCJ1c2VBcHBEaWN0TG9jayIsImRvbmUiLCJhcHBEaWN0IiwicmVzb2x2ZSIsImlzRXF1YWwiLCJsb2ciLCJkZWJ1ZyIsIl9uYXZpZ2F0aW5nVG9QYWdlIiwiZW1pdCIsImV2ZW50cyIsIkVWRU5UX1BBR0VfQ0hBTkdFIiwicmVwbGFjZSIsIm9uQXBwQ29ubmVjdCIsImRpY3QiLCJXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXkiLCJ1cGRhdGVBcHBzV2l0aERpY3QiLCJvbkFwcERpc2Nvbm5lY3QiLCJidW5kbGVJZCIsImNvbm5lY3RlZCIsIkVWRU5UX0RJU0NPTk5FQ1QiLCJvbkFwcFVwZGF0ZSIsIm9uQ29ubmVjdGVkRHJpdmVyTGlzdCIsImRyaXZlcnMiLCJjb25uZWN0ZWREcml2ZXJzIiwiV0lSRHJpdmVyRGljdGlvbmFyeUtleSIsIkpTT04iLCJzdHJpbmdpZnkiLCJvbkN1cnJlbnRTdGF0ZSIsInN0YXRlIiwiY3VycmVudFN0YXRlIiwiV0lSQXV0b21hdGlvbkF2YWlsYWJpbGl0eUtleSIsIm9uQ29ubmVjdGVkQXBwbGljYXRpb25MaXN0IiwiYXBwcyIsImtleXMiLCJqb2luIiwibmV3RGljdCIsInZhbHVlcyIsImlkIiwiZW50cnkiLCJza2lwcGVkQXBwcyIsImluY2x1ZGVzIiwibmFtZSIsImRlZmF1bHRzIiwibWVzc2FnZUhhbmRsZXJzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQVFBLGVBQWVBLFlBQWYsQ0FBNkJDLEdBQTdCLEVBQWtDQyxRQUFsQyxFQUE0Q0MsUUFBNUMsRUFBc0Q7QUFDcEQsTUFBSUMsZ0JBQUVDLE9BQUYsQ0FBVUYsUUFBVixDQUFKLEVBQXlCO0FBQ3ZCO0FBQ0Q7O0FBRUQs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QUFXLEtBQUt4QyxPQUFoQixFQUF5QmlDLE9BQXpCO0FBQ0QsS0FGRCxTQUVVO0FBQ1JsQyxNQUFBQSxJQUFJO0FBQ0w7QUFDRixHQU5LLENBQU47QUFPRDs7QUFFRCxNQUFNMEMsZUFBZSxHQUFHO0FBQ3RCbEQsRUFBQUEsWUFEc0I7QUFFdEJtQixFQUFBQSxZQUZzQjtBQUd0QkksRUFBQUEsZUFIc0I7QUFJdEJJLEVBQUFBLFdBSnNCO0FBS3RCQyxFQUFBQSxxQkFMc0I7QUFNdEJNLEVBQUFBLGNBTnNCO0FBT3RCSSxFQUFBQTtBQVBzQixDQUF4QjtlQVVlWSxlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IGV2ZW50cyBmcm9tICcuL2V2ZW50cyc7XG5pbXBvcnQgeyBwYWdlQXJyYXlGcm9tRGljdCwgZ2V0RGVidWdnZXJBcHBLZXksIHNpbXBsZVN0cmluZ2lmeSwgYXBwSW5mb0Zyb21EaWN0IH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG4vKlxuICogR2VuZXJpYyBjYWxsYmFja3MgdXNlZCB0aHJvdWdob3V0IHRoZSBsaWZlY3ljbGUgb2YgdGhlIFJlbW90ZSBEZWJ1Z2dlci5cbiAqIFRoZXNlIHdpbGwgYmUgYWRkZWQgdG8gdGhlIHByb3RvdHlwZS5cbiAqL1xuXG5hc3luYyBmdW5jdGlvbiBvblBhZ2VDaGFuZ2UgKGVyciwgYXBwSWRLZXksIHBhZ2VEaWN0KSB7XG4gIGlmIChfLmlzRW1wdHkocGFnZURpY3QpKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgcGFnZUFycmF5ID0gcGFnZUFycmF5RnJvbURpY3QocGFnZURpY3QpO1xuXG4gIGF3YWl0IHRoaXMudXNlQXBwRGljdExvY2soKGRvbmUpID0+IHtcbiAgICB0cnkge1xuICAgICAgLy8gc2F2ZSB0aGUgcGFnZSBkaWN0IGZvciB0aGlzIGFwcFxuICAgICAgaWYgKHRoaXMuYXBwRGljdFthcHBJZEtleV0pIHtcbiAgICAgICAgaWYgKHRoaXMuYXBwRGljdFthcHBJZEtleV0ucGFnZUFycmF5KSB7XG4gICAgICAgICAgaWYgKHRoaXMuYXBwRGljdFthcHBJZEtleV0ucGFnZUFycmF5LnJlc29sdmUpIHtcbiAgICAgICAgICAgIC8vIHBhZ2VEaWN0IGlzIGEgcGVuZGluZyBwcm9taXNlLCBzbyByZXNvbHZlXG4gICAgICAgICAgICB0aGlzLmFwcERpY3RbYXBwSWRLZXldLnBhZ2VBcnJheS5yZXNvbHZlKCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIHdlIGhhdmUgYSBwcmUtZXhpc3RpbmcgcGFnZURpY3RcbiAgICAgICAgICAgIGlmIChfLmlzRXF1YWwodGhpcy5hcHBEaWN0W2FwcElkS2V5XS5wYWdlQXJyYXksIHBhZ2VBcnJheSkpIHtcbiAgICAgICAgICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCBwYWdlIGNoYW5nZSBub3RpY2UgZm9yIGFwcCAnJHthcHBJZEtleX0nIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgYGJ1dCB0aGUgbGlzdGluZyBoYXMgbm90IGNoYW5nZWQuIElnbm9yaW5nLmApO1xuICAgICAgICAgICAgICByZXR1cm4gZG9uZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBrZWVwIHRyYWNrIG9mIHRoZSBwYWdlIGRpY3Rpb25hcnlcbiAgICAgICAgdGhpcy5hcHBEaWN0W2FwcElkS2V5XS5wYWdlQXJyYXkgPSBwYWdlQXJyYXk7XG4gICAgICB9XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGRvbmUoKTtcbiAgICB9XG4gIH0pO1xuXG4gIGlmICh0aGlzLl9uYXZpZ2F0aW5nVG9QYWdlKSB7XG4gICAgLy8gaW4gdGhlIG1pZGRsZSBvZiBuYXZpZ2F0aW5nLCBzbyByZXBvcnRpbmcgYSBwYWdlIGNoYW5nZSB3aWxsIGNhdXNlIHByb2JsZW1zXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBQYWdlIGNoYW5nZWQ6ICR7c2ltcGxlU3RyaW5naWZ5KHBhZ2VEaWN0LCB0cnVlKX1gKTtcblxuICB0aGlzLmVtaXQoZXZlbnRzLkVWRU5UX1BBR0VfQ0hBTkdFLCB7XG4gICAgYXBwSWRLZXk6IGFwcElkS2V5LnJlcGxhY2UoJ1BJRDonLCAnJyksXG4gICAgcGFnZUFycmF5LFxuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gb25BcHBDb25uZWN0IChlcnIsIGRpY3QpIHtcbiAgY29uc3QgYXBwSWRLZXkgPSBkaWN0LldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTtcbiAgbG9nLmRlYnVnKGBOb3RpZmllZCB0aGF0IG5ldyBhcHBsaWNhdGlvbiAnJHthcHBJZEtleX0nIGhhcyBjb25uZWN0ZWRgKTtcbiAgYXdhaXQgdGhpcy51c2VBcHBEaWN0TG9jaygoZG9uZSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLnVwZGF0ZUFwcHNXaXRoRGljdChkaWN0KTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgZG9uZSgpO1xuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIG9uQXBwRGlzY29ubmVjdCAoZXJyLCBkaWN0KSB7XG4gIGNvbnN0IGFwcElkS2V5ID0gZGljdC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG4gIGxvZy5kZWJ1ZyhgQXBwbGljYXRpb24gJyR7YXBwSWRLZXl9JyBkaXNjb25uZWN0ZWQuIFJlbW92aW5nIGZyb20gYXBwIGRpY3Rpb25hcnkuYCk7XG4gIGxvZy5kZWJ1ZyhgQ3VycmVudCBhcHAgaXMgJyR7dGhpcy5hcHBJZEtleX0nYCk7XG5cbiAgLy8gZ2V0IHJpZCBvZiB0aGUgZW50cnkgaW4gb3VyIGFwcCBkaWN0aW9uYXJ5LFxuICAvLyBzaW5jZSBpdCBpcyBubyBsb25nZXIgYXZhaWxhYmxlXG4gIGRlbGV0ZSB0aGlzLmFwcERpY3RbYXBwSWRLZXldO1xuXG4gIC8vIGlmIHRoZSBkaXNjb25uZWN0ZWQgYXBwIGlzIHRoZSBvbmUgd2UgYXJlIGNvbm5lY3RlZCB0bywgdHJ5IHRvIGZpbmQgYW5vdGhlclxuICBpZiAodGhpcy5hcHBJZEtleSA9PT0gYXBwSWRLZXkpIHtcbiAgICBsb2cuZGVidWcoYE5vIGxvbmdlciBoYXZlIGFwcCBpZC4gQXR0ZW1wdGluZyB0byBmaW5kIG5ldyBvbmUuYCk7XG4gICAgdGhpcy5hcHBJZEtleSA9IGdldERlYnVnZ2VyQXBwS2V5KHRoaXMuYnVuZGxlSWQsIHRoaXMuYXBwRGljdCk7XG4gIH1cblxuICBpZiAoIXRoaXMuYXBwRGljdCkge1xuICAgIC8vIHRoaXMgbWVhbnMgd2Ugbm8gbG9uZ2VyIGhhdmUgYW55IGFwcHMuIHdoYXQgdGhlIHdoYXQ/XG4gICAgbG9nLmRlYnVnKCdNYWluIGFwcCBkaXNjb25uZWN0ZWQuIERpc2Nvbm5lY3RpbmcgYWx0b2dldGhlci4nKTtcbiAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgIHRoaXMuZW1pdChldmVudHMuRVZFTlRfRElTQ09OTkVDVCwgdHJ1ZSk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gb25BcHBVcGRhdGUgKGVyciwgZGljdCkge1xuICBhd2FpdCB0aGlzLnVzZUFwcERpY3RMb2NrKChkb25lKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMudXBkYXRlQXBwc1dpdGhEaWN0KGRpY3QpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBkb25lKCk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gb25Db25uZWN0ZWREcml2ZXJMaXN0IChlcnIsIGRyaXZlcnMpIHtcbiAgdGhpcy5jb25uZWN0ZWREcml2ZXJzID0gZHJpdmVycy5XSVJEcml2ZXJEaWN0aW9uYXJ5S2V5O1xuICBsb2cuZGVidWcoYFJlY2VpdmVkIGNvbm5lY3RlZCBkcml2ZXIgbGlzdDogJHtKU09OLnN0cmluZ2lmeSh0aGlzLmNvbm5lY3RlZERyaXZlcnMpfWApO1xufVxuXG5mdW5jdGlvbiBvbkN1cnJlbnRTdGF0ZSAoZXJyLCBzdGF0ZSkge1xuICB0aGlzLmN1cnJlbnRTdGF0ZSA9IHN0YXRlLldJUkF1dG9tYXRpb25BdmFpbGFiaWxpdHlLZXk7XG4gIC8vIFRoaXMgc3RhdGUgY2hhbmdlcyB3aGVuICdSZW1vdGUgQXV0b21hdGlvbicgaW4gJ1NldHRpbmdzIGFwcCcgPiAnU2FmYXJpJyA+ICdBZHZhbmNlZCcgPiAnUmVtb3RlIEF1dG9tYXRpb24nIGNoYW5nZXNcbiAgLy8gV0lSQXV0b21hdGlvbkF2YWlsYWJpbGl0eUF2YWlsYWJsZSBvciBXSVJBdXRvbWF0aW9uQXZhaWxhYmlsaXR5Tm90QXZhaWxhYmxlXG4gIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgY29ubmVjdGVkIGF1dG9tYXRpb24gYXZhaWxhYmlsaXR5IHN0YXRlOiAke0pTT04uc3RyaW5naWZ5KHRoaXMuY3VycmVudFN0YXRlKX1gKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gb25Db25uZWN0ZWRBcHBsaWNhdGlvbkxpc3QgKGVyciwgYXBwcykge1xuICBsb2cuZGVidWcoYFJlY2VpdmVkIGNvbm5lY3RlZCBhcHBsaWNhdGlvbnMgbGlzdDogJHtfLmtleXMoYXBwcykuam9pbignLCAnKX1gKTtcblxuICAvLyB0cmFuc2xhdGUgdGhlIHJlY2VpdmVkIGluZm9ybWF0aW9uIGludG8gYW4gZWFzaWVyLXRvLW1hbmFnZVxuICAvLyBoYXNoIHdpdGggYXBwIGlkIGFzIGtleSwgYW5kIGFwcCBpbmZvIGFzIHZhbHVlXG4gIGxldCBuZXdEaWN0ID0ge307XG4gIGZvciAoY29uc3QgZGljdCBvZiBfLnZhbHVlcyhhcHBzKSkge1xuICAgIGNvbnN0IFtpZCwgZW50cnldID0gYXBwSW5mb0Zyb21EaWN0KGRpY3QpO1xuICAgIGlmICh0aGlzLnNraXBwZWRBcHBzLmluY2x1ZGVzKGVudHJ5Lm5hbWUpKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgbmV3RGljdFtpZF0gPSBlbnRyeTtcbiAgfVxuICAvLyB1cGRhdGUgdGhlIG9iamVjdCdzIGxpc3Qgb2YgYXBwc1xuICBhd2FpdCB0aGlzLnVzZUFwcERpY3RMb2NrKChkb25lKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIF8uZGVmYXVsdHModGhpcy5hcHBEaWN0LCBuZXdEaWN0KTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgZG9uZSgpO1xuICAgIH1cbiAgfSk7XG59XG5cbmNvbnN0IG1lc3NhZ2VIYW5kbGVycyA9IHtcbiAgb25QYWdlQ2hhbmdlLFxuICBvbkFwcENvbm5lY3QsXG4gIG9uQXBwRGlzY29ubmVjdCxcbiAgb25BcHBVcGRhdGUsXG4gIG9uQ29ubmVjdGVkRHJpdmVyTGlzdCxcbiAgb25DdXJyZW50U3RhdGUsXG4gIG9uQ29ubmVjdGVkQXBwbGljYXRpb25MaXN0LFxufTtcblxuZXhwb3J0IGRlZmF1bHQgbWVzc2FnZUhhbmRsZXJzO1xuIl0sImZpbGUiOiJsaWIvbWl4aW5zL21lc3NhZ2UtaGFuZGxlcnMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
