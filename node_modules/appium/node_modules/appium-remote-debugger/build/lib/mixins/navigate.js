"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _events = _interopRequireDefault(require("./events"));

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

function frameDetached() {
  this.emit(_events.default.EVENT_FRAMES_DETACHED);
}

async function pageLoad(startPageLoadTimer, pageLoadVerifyHook = _lodash.default.noop) {
  var _startPageLoadTimer;

  const timeoutMs = 500;

  if (!_lodash.default.isFunction((_startPageLoadTimer = startPageLoadTimer) === null || _startPageLoadTimer === void 0 ? void 0 : _startPageLoadTimer.getDuration)) {
    _logger.default.debug(`Page load timer not a timer. Creating new timer`);

    startPageLoadTimer = new _appiumSupport.timing.Timer().start();
  }

  _logger.default.debug('Page loaded, verifying whether ready');

  this.pageLoading = true;

  const verify = async () => {
    this.pageLoadDelay = _appiumSupport.util.cancellableDelay(timeoutMs);

    try {
      await this.pageLoadDelay;
    } catch (err) {
      if (err instanceof _bluebird.default.CancellationError) {
        return;
      }
    }

    if (!this.appIdKey) {
      _logger.default.debug('Not connected to an application. Ignoring page load');

      return;
    }

    if (_lodash.default.isFunction(pageLoadVerifyHook)) {
      await pageLoadVerifyHook();
    }

    const elapsedMs = startPageLoadTimer.getDuration().asMilliSeconds;

    if ((await this.checkPageIsReady()) || this.pageLoadMs > 0 && elapsedMs > this.pageLoadMs) {
      _logger.default.debug('Page is ready');

      this.pageLoading = false;
    } else {
      _logger.default.debug('Page was not ready, retrying');

      await verify();
    }
  };

  try {
    await verify();
  } finally {
    _logger.default.debug(`Page load completed in ${startPageLoadTimer.getDuration().asMilliSeconds.toFixed(0)}ms`);

    this.pageLoading = false;
  }
}

function cancelPageLoad() {
  _logger.default.debug('Unregistering from page readiness notifications');

  this.pageLoading = false;

  if (this.pageLoadDelay) {
    this.pageLoadDelay.cancel();
  }
}

async function pageUnload() {
  _logger.default.debug('Page unloading');

  await this.waitForDom();
}

async function waitForDom(startPageLoadTimer, pageLoadVerifyHook) {
  _logger.default.debug('Waiting for dom...');

  await this.pageLoad(startPageLoadTimer, pageLoadVerifyHook);
}

async function checkPageIsReady() {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey
  });

  _logger.default.debug('Checking document readyState');

  const readyCmd = 'document.readyState;';
  let readyState = 'loading';

  try {
    readyState = await _bluebird.default.resolve(this.execute(readyCmd, true)).timeout(this.pageReadyTimeout);
  } catch (err) {
    if (!(err instanceof _bluebird.default.TimeoutError)) {
      throw err;
    }

    _logger.default.debug(`Page readiness check timed out after ${this.pageReadyTimeout}ms`);

    return false;
  }

  _logger.default.debug(`Document readyState is '${readyState}'`);

  return readyState === 'complete';
}

async function navToUrl(url, pageLoadVerifyHook) {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });
  this._navigatingToPage = true;

  try {
    _logger.default.debug(`Navigating to new URL: '${url}'`);

    const waitForFramePromise = this.waitForFrameNavigated();
    await this.rpcClient.send('Page.navigate', {
      url,
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });

    if (!this.useNewSafari) {
      await _bluebird.default.delay(1000);
    }

    await waitForFramePromise;
    await this.waitForDom(new _appiumSupport.timing.Timer().start(), pageLoadVerifyHook);
    await this.rpcClient.send('Console.enable', {
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });
  } finally {
    this._navigatingToPage = false;
  }
}

async function waitForFrameNavigated() {
  let navEventListener;
  return await new _bluebird.default(async resolve => {
    _logger.default.debug('Waiting for frame navigated message...');

    const start = new _appiumSupport.timing.Timer().start();

    navEventListener = (err, value) => {
      _logger.default.debug(`Frame navigated in ${start.getDuration().asMilliSeconds.toFixed(0)}ms from: ${value}`);

      if (!this.allowNavigationWithoutReload && !this.pageLoading) {
        resolve(value);
      } else {
        _logger.default.debug('Frame navigated but we were warned about it, not ' + 'considering page state unloaded');

        this.allowNavigationWithoutReload = false;
      }

      if (this.navigationDelay) {
        this.navigationDelay.cancel();
      }
    };

    this.rpcClient.once('Page.frameNavigated', navEventListener);

    if (!this.useNewSafari || this.pageLoadMs >= 0) {
      const timeout = this.useNewSafari ? this.pageLoadMs : 500;
      this.navigationDelay = _appiumSupport.util.cancellableDelay(timeout);

      try {
        await this.navigationDelay;
        navEventListener(null, `${timeout}ms timeout`);
      } catch (err) {}
    }
  }).finally(() => {
    if (navEventListener) {
      this.rpcClient.off('Page.frameNavigated', navEventListener);
    }
  });
}

var _default = {
  frameDetached,
  pageLoad,
  cancelPageLoad,
  pageUnload,
  waitForDom,
  checkPageIsReady,
  navToUrl,
  waitForFrameNavigated
};
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9taXhpbnMvbmF2aWdhdGUuanMiXSwibmFtZXMiOlsiZnJhbWVEZXRhY2hlZCIsImVtaXQiLCJldmVudHMiLCJFVkVOVF9GUkFNRVNfREVUQUNIRUQiLCJwYWdlTG9hZCIsInN0YXJ0UGFnZUxvYWRUaW1lciIsInBhZ2VMb2FkVmVyaWZ5SG9vayIsIl8iLCJub29wIiwidGltZW91dE1zIiwiaXNGdW5jdGlvbiIsImdldER1cmF0aW9uIiwibG9nIiwiZGVidWciLCJ0aW1pbmciLCJUaW1lciIsInN0YXJ0IiwicGFnZUxvYWRpbmciLCJ2ZXJpZnkiLCJwYWdlTG9hZERlbGF5IiwidXRpbCIsImNhbmNlbGxhYmxlRGVsYXkiLCJlcnIiLCJCIiwiQ2FuY2VsbGF0aW9uRXJyb3IiLCJhcHBJZEtleSIsImVsYXBzZWRNcyIsImFzTWlsbGlTZWNvbmRzIiwiY2hlY2tQYWdlSXNSZWFkeSIsInBhZ2VMb2FkTXMiLCJ0b0ZpeGVkIiwiY2FuY2VsUGFnZUxvYWQiLCJjYW5jZWwiLCJwYWdlVW5sb2FkIiwid2FpdEZvckRvbSIsInJlYWR5Q21kIiwicmVhZHlTdGF0ZSIsInJlc29sdmUiLCJleGVjdXRlIiwidGltZW91dCIsInBhZ2VSZWFkeVRpbWVvdXQiLCJUaW1lb3V0RXJyb3IiLCJuYXZUb1VybCIsInVybCIsInBhZ2VJZEtleSIsIl9uYXZpZ2F0aW5nVG9QYWdlIiwid2FpdEZvckZyYW1lUHJvbWlzZSIsIndhaXRGb3JGcmFtZU5hdmlnYXRlZCIsInJwY0NsaWVudCIsInNlbmQiLCJ1c2VOZXdTYWZhcmkiLCJkZWxheSIsIm5hdkV2ZW50TGlzdGVuZXIiLCJ2YWx1ZSIsImFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQiLCJuYXZpZ2F0aW9uRGVsYXkiLCJvbmNlIiwiZmluYWxseSIsIm9mZiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxTQUFTQSxhQUFULEdBQTBCO0FBQ3hCLE9B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QyxLQUFLRixZQUFOLElBQXNCLEtBQUtyQixVQUFMLElBQW1CLENBQTdDLEVBQWdEO0FBRTlDLFlBQU1VLE9BQU8sR0FBRyxLQUFLVyxZQUFMLEdBQW9CLEtBQUtyQixVQUF6QixHQUFzQyxHQUF0RDtBQUNBLFdBQUswQixlQUFMLEdBQXVCbkMsb0JBQUtDLGdCQUFMLENBQXNCa0IsT0FBdEIsQ0FBdkI7O0FBQ0EsVUFBSTtBQUNGLGNBQU0sS0FBS2dCLGVBQVg7QUFDQUgsUUFBQUEsZ0JBQWdCLENBQUMsSUFBRCxFQUFRLEdBQUViLE9BQVEsWUFBbEIsQ0FBaEI7QUFDRCxPQUhELENBR0UsT0FBT2pCLEdBQVAsRUFBWSxDQUliO0FBQ0Y7QUFDRixHQXJDWSxFQXFDVm1DLE9BckNVLENBcUNGLE1BQU07QUFDZixRQUFJTCxnQkFBSixFQUFzQjtBQUNwQixXQUFLSixTQUFMLENBQWVVLEdBQWYsQ0FBbUIscUJBQW5CLEVBQTBDTixnQkFBMUM7QUFDRDtBQUNGLEdBekNZLENBQWI7QUEwQ0Q7O2VBR2M7QUFBRXBELEVBQUFBLGFBQUY7QUFBaUJJLEVBQUFBLFFBQWpCO0FBQTJCMkIsRUFBQUEsY0FBM0I7QUFBMkNFLEVBQUFBLFVBQTNDO0FBQXVEQyxFQUFBQSxVQUF2RDtBQUFtRU4sRUFBQUEsZ0JBQW5FO0FBQXFGYyxFQUFBQSxRQUFyRjtBQUErRkssRUFBQUE7QUFBL0YsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGNoZWNrUGFyYW1zIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IGV2ZW50cyBmcm9tICcuL2V2ZW50cyc7XG5pbXBvcnQgeyB0aW1pbmcsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5cbmZ1bmN0aW9uIGZyYW1lRGV0YWNoZWQgKCkge1xuICB0aGlzLmVtaXQoZXZlbnRzLkVWRU5UX0ZSQU1FU19ERVRBQ0hFRCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhZ2VMb2FkIChzdGFydFBhZ2VMb2FkVGltZXIsIHBhZ2VMb2FkVmVyaWZ5SG9vayA9IF8ubm9vcCkge1xuICBjb25zdCB0aW1lb3V0TXMgPSA1MDA7XG4gIGlmICghXy5pc0Z1bmN0aW9uKHN0YXJ0UGFnZUxvYWRUaW1lcj8uZ2V0RHVyYXRpb24pKSB7XG4gICAgbG9nLmRlYnVnKGBQYWdlIGxvYWQgdGltZXIgbm90IGEgdGltZXIuIENyZWF0aW5nIG5ldyB0aW1lcmApO1xuICAgIHN0YXJ0UGFnZUxvYWRUaW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICB9XG5cbiAgbG9nLmRlYnVnKCdQYWdlIGxvYWRlZCwgdmVyaWZ5aW5nIHdoZXRoZXIgcmVhZHknKTtcbiAgdGhpcy5wYWdlTG9hZGluZyA9IHRydWU7XG5cbiAgY29uc3QgdmVyaWZ5ID0gYXN5bmMgKCkgPT4ge1xuICAgIHRoaXMucGFnZUxvYWREZWxheSA9IHV0aWwuY2FuY2VsbGFibGVEZWxheSh0aW1lb3V0TXMpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnBhZ2VMb2FkRGVsYXk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyIGluc3RhbmNlb2YgQi5DYW5jZWxsYXRpb25FcnJvcikge1xuICAgICAgICAvLyBpZiB0aGUgcHJvbWlzZSBoYXMgYmVlbiBjYW5jZWxsZWRcbiAgICAgICAgLy8gd2Ugd2FudCB0byBza2lwIGNoZWNraW5nIHRoZSByZWFkaW5lc3NcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIHdlIGNhbiBnZXQgdGhpcyBjYWxsZWQgaW4gdGhlIG1pZGRsZSBvZiB0cnlpbmcgdG8gZmluZCBhIG5ldyBhcHBcbiAgICBpZiAoIXRoaXMuYXBwSWRLZXkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnTm90IGNvbm5lY3RlZCB0byBhbiBhcHBsaWNhdGlvbi4gSWdub3JpbmcgcGFnZSBsb2FkJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKF8uaXNGdW5jdGlvbihwYWdlTG9hZFZlcmlmeUhvb2spKSB7XG4gICAgICBhd2FpdCBwYWdlTG9hZFZlcmlmeUhvb2soKTtcbiAgICB9XG5cbiAgICAvLyBpZiB3ZSBhcmUgcmVhZHksIG9yIHdlJ3ZlIHNwZW5kIHRvbyBtdWNoIHRpbWUgb24gdGhpc1xuICAgIGNvbnN0IGVsYXBzZWRNcyA9IHN0YXJ0UGFnZUxvYWRUaW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzO1xuICAgIGlmIChhd2FpdCB0aGlzLmNoZWNrUGFnZUlzUmVhZHkoKSB8fCAodGhpcy5wYWdlTG9hZE1zID4gMCAmJiBlbGFwc2VkTXMgPiB0aGlzLnBhZ2VMb2FkTXMpKSB7XG4gICAgICBsb2cuZGVidWcoJ1BhZ2UgaXMgcmVhZHknKTtcbiAgICAgIHRoaXMucGFnZUxvYWRpbmcgPSBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKCdQYWdlIHdhcyBub3QgcmVhZHksIHJldHJ5aW5nJyk7XG4gICAgICBhd2FpdCB2ZXJpZnkoKTtcbiAgICB9XG4gIH07XG4gIHRyeSB7XG4gICAgYXdhaXQgdmVyaWZ5KCk7XG4gIH0gZmluYWxseSB7XG4gICAgbG9nLmRlYnVnKGBQYWdlIGxvYWQgY29tcGxldGVkIGluICR7c3RhcnRQYWdlTG9hZFRpbWVyLmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMudG9GaXhlZCgwKX1tc2ApO1xuICAgIHRoaXMucGFnZUxvYWRpbmcgPSBmYWxzZTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjYW5jZWxQYWdlTG9hZCAoKSB7XG4gIGxvZy5kZWJ1ZygnVW5yZWdpc3RlcmluZyBmcm9tIHBhZ2UgcmVhZGluZXNzIG5vdGlmaWNhdGlvbnMnKTtcbiAgdGhpcy5wYWdlTG9hZGluZyA9IGZhbHNlO1xuICBpZiAodGhpcy5wYWdlTG9hZERlbGF5KSB7XG4gICAgdGhpcy5wYWdlTG9hZERlbGF5LmNhbmNlbCgpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhZ2VVbmxvYWQgKCkge1xuICBsb2cuZGVidWcoJ1BhZ2UgdW5sb2FkaW5nJyk7XG4gIGF3YWl0IHRoaXMud2FpdEZvckRvbSgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB3YWl0Rm9yRG9tIChzdGFydFBhZ2VMb2FkVGltZXIsIHBhZ2VMb2FkVmVyaWZ5SG9vaykge1xuICBsb2cuZGVidWcoJ1dhaXRpbmcgZm9yIGRvbS4uLicpO1xuICBhd2FpdCB0aGlzLnBhZ2VMb2FkKHN0YXJ0UGFnZUxvYWRUaW1lciwgcGFnZUxvYWRWZXJpZnlIb29rKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tQYWdlSXNSZWFkeSAoKSB7XG4gIGNoZWNrUGFyYW1zKHthcHBJZEtleTogdGhpcy5hcHBJZEtleX0pO1xuXG4gIGxvZy5kZWJ1ZygnQ2hlY2tpbmcgZG9jdW1lbnQgcmVhZHlTdGF0ZScpO1xuICBjb25zdCByZWFkeUNtZCA9ICdkb2N1bWVudC5yZWFkeVN0YXRlOyc7XG4gIGxldCByZWFkeVN0YXRlID0gJ2xvYWRpbmcnO1xuICB0cnkge1xuICAgIHJlYWR5U3RhdGUgPSBhd2FpdCBCLnJlc29sdmUodGhpcy5leGVjdXRlKHJlYWR5Q21kLCB0cnVlKSkudGltZW91dCh0aGlzLnBhZ2VSZWFkeVRpbWVvdXQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoIShlcnIgaW5zdGFuY2VvZiBCLlRpbWVvdXRFcnJvcikpIHtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBQYWdlIHJlYWRpbmVzcyBjaGVjayB0aW1lZCBvdXQgYWZ0ZXIgJHt0aGlzLnBhZ2VSZWFkeVRpbWVvdXR9bXNgKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgbG9nLmRlYnVnKGBEb2N1bWVudCByZWFkeVN0YXRlIGlzICcke3JlYWR5U3RhdGV9J2ApO1xuXG4gIHJldHVybiByZWFkeVN0YXRlID09PSAnY29tcGxldGUnO1xufVxuXG5hc3luYyBmdW5jdGlvbiBuYXZUb1VybCAodXJsLCBwYWdlTG9hZFZlcmlmeUhvb2spIHtcbiAgY2hlY2tQYXJhbXMoe2FwcElkS2V5OiB0aGlzLmFwcElkS2V5LCBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5fSk7XG5cbiAgdGhpcy5fbmF2aWdhdGluZ1RvUGFnZSA9IHRydWU7XG5cbiAgdHJ5IHtcbiAgICBsb2cuZGVidWcoYE5hdmlnYXRpbmcgdG8gbmV3IFVSTDogJyR7dXJsfSdgKTtcblxuICAgIC8vIGJlZ2luIGxpc3RlbmluZyBmb3IgZnJhbWUgbmF2aWdhdGlvbiBldmVudCwgd2hpY2ggd2lsbCBiZSB3YWl0ZWQgZm9yIGxhdGVyXG4gICAgY29uc3Qgd2FpdEZvckZyYW1lUHJvbWlzZSA9IHRoaXMud2FpdEZvckZyYW1lTmF2aWdhdGVkKCk7XG5cbiAgICBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdQYWdlLm5hdmlnYXRlJywge1xuICAgICAgdXJsLFxuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgIH0pO1xuXG4gICAgaWYgKCF0aGlzLnVzZU5ld1NhZmFyaSkge1xuICAgICAgLy8gYSBzbWFsbCBwYXVzZSBmb3IgdGhlIGJyb3dzZXIgdG8gY2F0Y2ggdXBcbiAgICAgIGF3YWl0IEIuZGVsYXkoMTAwMCk7XG4gICAgfVxuXG4gICAgLy8gd2FpdCB1bnRpbCB0aGUgcGFnZSBoYXMgYmVlbiBuYXZpZ2F0ZWRcbiAgICBhd2FpdCB3YWl0Rm9yRnJhbWVQcm9taXNlO1xuXG4gICAgYXdhaXQgdGhpcy53YWl0Rm9yRG9tKG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpLCBwYWdlTG9hZFZlcmlmeUhvb2spO1xuXG4gICAgLy8gZW5hYmxlIGNvbnNvbGUgbG9nZ2luZywgc28gd2UgZ2V0IHRoZSBldmVudHMgKG90aGVyd2lzZSB3ZSBvbmx5XG4gICAgLy8gZ2V0IG5vdGlmaWVkIHdoZW4gbmF2aWdhdGluZyB0byBhIGxvY2FsIHBhZ2VcbiAgICBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdDb25zb2xlLmVuYWJsZScsIHtcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICB9KTtcbiAgfSBmaW5hbGx5IHtcbiAgICB0aGlzLl9uYXZpZ2F0aW5nVG9QYWdlID0gZmFsc2U7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gd2FpdEZvckZyYW1lTmF2aWdhdGVkICgpIHtcbiAgbGV0IG5hdkV2ZW50TGlzdGVuZXI7XG4gIHJldHVybiBhd2FpdCBuZXcgQihhc3luYyAocmVzb2x2ZSkgPT4ge1xuICAgIGxvZy5kZWJ1ZygnV2FpdGluZyBmb3IgZnJhbWUgbmF2aWdhdGVkIG1lc3NhZ2UuLi4nKTtcbiAgICBjb25zdCBzdGFydCA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuXG4gICAgLy8gYWRkIGEgaGFuZGxlciBmb3IgdGhlIGBQYWdlLmZyYW1lTmF2aWdhdGVkYCBtZXNzYWdlXG4gICAgLy8gZnJvbSB0aGUgcmVtb3RlIGRlYnVnZ2VyXG4gICAgbmF2RXZlbnRMaXN0ZW5lciA9IChlcnIsIHZhbHVlKSA9PiB7XG4gICAgICBsb2cuZGVidWcoYEZyYW1lIG5hdmlnYXRlZCBpbiAke3N0YXJ0LmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMudG9GaXhlZCgwKX1tcyBmcm9tOiAke3ZhbHVlfWApO1xuICAgICAgaWYgKCF0aGlzLmFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQgJiYgIXRoaXMucGFnZUxvYWRpbmcpIHtcbiAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoJ0ZyYW1lIG5hdmlnYXRlZCBidXQgd2Ugd2VyZSB3YXJuZWQgYWJvdXQgaXQsIG5vdCAnICtcbiAgICAgICAgICAgICAgICAgICdjb25zaWRlcmluZyBwYWdlIHN0YXRlIHVubG9hZGVkJyk7XG4gICAgICAgIHRoaXMuYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZCA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMubmF2aWdhdGlvbkRlbGF5KSB7XG4gICAgICAgIHRoaXMubmF2aWdhdGlvbkRlbGF5LmNhbmNlbCgpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLnJwY0NsaWVudC5vbmNlKCdQYWdlLmZyYW1lTmF2aWdhdGVkJywgbmF2RXZlbnRMaXN0ZW5lcik7XG5cbiAgICAvLyB0aW1lb3V0LCBpbiBjYXNlIHJlbW90ZSBkZWJ1Z2dlciBkb2Vzbid0IHJlc3BvbmQsXG4gICAgLy8gb3IgdGFrZXMgYSBsb25nIHRpbWVcbiAgICBpZiAoIXRoaXMudXNlTmV3U2FmYXJpIHx8IHRoaXMucGFnZUxvYWRNcyA+PSAwKSB7XG4gICAgICAvLyB1c2UgcGFnZUxvYWRNcywgb3IgYSBzbWFsbCBhbW91bnQgb2YgdGltZVxuICAgICAgY29uc3QgdGltZW91dCA9IHRoaXMudXNlTmV3U2FmYXJpID8gdGhpcy5wYWdlTG9hZE1zIDogNTAwO1xuICAgICAgdGhpcy5uYXZpZ2F0aW9uRGVsYXkgPSB1dGlsLmNhbmNlbGxhYmxlRGVsYXkodGltZW91dCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLm5hdmlnYXRpb25EZWxheTtcbiAgICAgICAgbmF2RXZlbnRMaXN0ZW5lcihudWxsLCBgJHt0aW1lb3V0fW1zIHRpbWVvdXRgKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyBub3RoaW5nIHRvIGRvOiB3ZSBvbmx5IGdldCBoZXJlIGlmIHRoZSByZW1vdGUgZGVidWdnZXJcbiAgICAgICAgLy8gYWxyZWFkeSBub3RpZmllZCBvZiBmcmFtZSBuYXZpZ2F0aW9uLCBhbmQgdGhlIGRlbGF5XG4gICAgICAgIC8vIHdhcyBjYW5jZWxsZWRcbiAgICAgIH1cbiAgICB9XG4gIH0pLmZpbmFsbHkoKCkgPT4ge1xuICAgIGlmIChuYXZFdmVudExpc3RlbmVyKSB7XG4gICAgICB0aGlzLnJwY0NsaWVudC5vZmYoJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnLCBuYXZFdmVudExpc3RlbmVyKTtcbiAgICB9XG4gIH0pO1xufVxuXG5cbmV4cG9ydCBkZWZhdWx0IHsgZnJhbWVEZXRhY2hlZCwgcGFnZUxvYWQsIGNhbmNlbFBhZ2VMb2FkLCBwYWdlVW5sb2FkLCB3YWl0Rm9yRG9tLCBjaGVja1BhZ2VJc1JlYWR5LCBuYXZUb1VybCwgd2FpdEZvckZyYW1lTmF2aWdhdGVkIH07XG4iXSwiZmlsZSI6ImxpYi9taXhpbnMvbmF2aWdhdGUuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
