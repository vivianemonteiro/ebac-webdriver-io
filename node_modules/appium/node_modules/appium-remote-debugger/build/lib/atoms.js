"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getAtom = getAtom;
exports.getScriptForAtom = getScriptForAtom;
exports.default = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

const atomsCache = {};

const inBuildDir = __filename.includes('build/lib/atoms');

function getAtomFileName(atomName) {
  return inBuildDir ? _path.default.resolve(__dirname, '..', '..', 'atoms', `${atomName}.js`) : _path.default.resolve(__dirname, '..', 'atoms', `${atomName}.js`);
}

async function getAtom(atomName) {
  if (!_lodash.default.has(atomsCache, atomName)) {
    const atomFileName = getAtomFileName(atomName);

    try {
      atomsCache[atomName] = await _appiumSupport.fs.readFile(atomFileName);
    } catch (e) {
      throw new Error(`Unable to load Atom '${atomName}' from file '${atomFileName}'`);
    }
  }

  return atomsCache[atomName];
}

async function wrapScriptForFrame(script, frame) {
  _logger.default.debug(`Wrapping script for frame '${frame}'`);

  const elFromCache = await getAtom('get_element_from_cache');
  return `(function (window) { var document = window.document; ` + `return (${script}); })((${elFromCache.toString('utf8')})(${JSON.stringify(frame)}))`;
}

async function getScriptForAtom(atom, args, frames = [], asyncCallBack = null) {
  const atomSrc = await getAtom(atom);
  let script;

  if (frames.length > 0) {
    script = atomSrc;

    for (const frame of frames) {
      script = await wrapScriptForFrame(script, frame);
    }
  } else {
    _logger.default.debug(`Executing '${atom}' atom in default context`);

    script = `(${atomSrc})`;
  }

  args = args.map(JSON.stringify);

  if (asyncCallBack) {
    script += `(${args.join(',')}, ${asyncCallBack}, true)`;
  } else {
    script += `(${args.join(',')})`;
  }

  return script;
}

var _default = getAtom;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hdG9tcy5qcyJdLCJuYW1lcyI6WyJhdG9tc0NhY2hlIiwiaW5CdWlsZERpciIsIl9fZmlsZW5hbWUiLCJpbmNsdWRlcyIsImdldEF0b21GaWxlTmFtZSIsImF0b21OYW1lIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJnZXRBdG9tIiwiXyIsImhhcyIsImF0b21GaWxlTmFtZSIsImZzIiwicmVhZEZpbGUiLCJlIiwiRXJyb3IiLCJ3cmFwU2NyaXB0Rm9yRnJhbWUiLCJzY3JpcHQiLCJmcmFtZSIsImxvZyIsImRlYnVnIiwiZWxGcm9tQ2FjaGUiLCJ0b1N0cmluZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJnZXRTY3JpcHRGb3JBdG9tIiwiYXRvbSIsImFyZ3MiLCJmcmFtZXMiLCJhc3luY0NhbGxCYWNrIiwiYXRvbVNyYyIsImxlbmd0aCIsIm1hcCIsImpvaW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxVQUFVLEdBQUcsRUFBbkI7O0FBRUEsTUFBTUMsVUFBVSxHQUFHQyxVQUFVLENBQUNDLFFBQVgsQ0FBb0IsaUJBQXBCLENBQW5COztBQUVBLFNBQVNDLGVBQVQsQ0FBMEJDLFFBQTFCLEVBQW9DO0FBQ2xDLFNBQU9KLFVBQVUsR0FDYkssY0FBS0MsT0FBTCxDQUFhQyxTQUFiLEVBQXdCLElBQXhCLEVBQThCLElBQTlCLEVBQW9DLE9BQXBDLEVBQThDLEdBQUVILFFBQVMsS0FBekQsQ0FEYSxHQUViQyxjQUFLQyxPQUFMLENBQWFDLFNBQWIsRUFBd0IsSUFBeEIsRUFBOEIsT0FBOUIsRUFBd0MsR0FBRUgsUUFBUyxLQUFuRCxDQUZKO0FBR0Q7O0FBRUQsZUFBZUksT0FBZixDQUF3QkosUUFBeEIsRUFBa0M7QUFFaEMsTUFBSSxDQUFDSyxnQkFBRUMsR0FBRixDQUFNWCxVQUFOLEVBQWtCSyxRQUFsQixDQUFMLEVBQWtDO0FBQ2hDLFVBQU1PLFlBQVksR0FBR1IsZUFBZSxDQUFDQyxRQUFELENBQXBDOztBQUNBLFFBQUk7QUFDRkwsTUFBQUEsVUFBVSxDQUFDSyxRQUFELENBQVYsR0FBdUIsTUFBTVEsa0JBQUdDLFFBQUgsQ0FBWUYsWUFBWixDQUE3QjtBQUNELEtBRkQsQ0FFRSxPQUFPRyxDQUFQLEVBQVU7QUFDVixZQUFNLElBQUlDLEtBQUosQ0FBVyx3QkFBdUJYLFFBQVMsZ0JBQWVPLFlBQWEsR0FBdkUsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQsU0FBT1osVUFBVSxDQUFDSyxRQUFELENBQWpCO0FBQ0Q7O0FBRUQsZUFBZVksa0JBQWYsQ0FBbUNDLE1BQW5DLEVBQTJDQyxLQUEzQyxFQUFrRDtBQUNoREMsa0JBQUlDLEtBQUosQ0FBVyw4QkFBNkJGLEtBQU0sR0FBOUM7O0FBQ0EsUUFBTUcsV0FBVyxHQUFHLE1BQU1iLE9BQU8sQ0FBQyx3QkFBRCxDQUFqQztBQUNBLFNBQVEsdURBQUQsR0FDQyxXQUFVUyxNQUFPLFVBQVNJLFdBQVcsQ0FBQ0MsUUFBWixDQUFxQixNQUFyQixDQUE2QixLQUFJQyxJQUFJLENBQUNDLFNBQUwsQ0FBZU4sS0FBZixDQUFzQixJQUR6RjtBQUVEOztBQUVELGVBQWVPLGdCQUFmLENBQWlDQyxJQUFqQyxFQUF1Q0MsSUFBdkMsRUFBNkNDLE1BQU0sR0FBRyxFQUF0RCxFQUEwREMsYUFBYSxHQUFHLElBQTFFLEVBQWdGO0FBQzlFLFFBQU1DLE9BQU8sR0FBRyxNQUFNdEIsT0FBTyxDQUFDa0IsSUFBRCxDQUE3QjtBQUNBLE1BQUlULE1BQUo7O0FBQ0EsTUFBSVcsTUFBTSxDQUFDRyxNQUFQLEdBQWdCLENBQXBCLEVBQXVCO0FBQ3JCZCxJQUFBQSxNQUFNLEdBQUdhLE9BQVQ7O0FBQ0EsU0FBSyxNQUFNWixLQUFYLElBQW9CVSxNQUFwQixFQUE0QjtBQUMxQlgsTUFBQUEsTUFBTSxHQUFHLE1BQU1ELGtCQUFrQixDQUFDQyxNQUFELEVBQVNDLEtBQVQsQ0FBakM7QUFDRDtBQUNGLEdBTEQsTUFLTztBQUNMQyxvQkFBSUMsS0FBSixDQUFXLGNBQWFNLElBQUssMkJBQTdCOztBQUNBVCxJQUFBQSxNQUFNLEdBQUksSUFBR2EsT0FBUSxHQUFyQjtBQUNEOztBQUdESCxFQUFBQSxJQUFJLEdBQUdBLElBQUksQ0FBQ0ssR0FBTCxDQUFTVCxJQUFJLENBQUNDLFNBQWQsQ0FBUDs7QUFDQSxNQUFJSyxhQUFKLEVBQW1CO0FBQ2pCWixJQUFBQSxNQUFNLElBQUssSUFBR1UsSUFBSSxDQUFDTSxJQUFMLENBQVUsR0FBVixDQUFlLEtBQUlKLGFBQWMsU0FBL0M7QUFDRCxHQUZELE1BRU87QUFDTFosSUFBQUEsTUFBTSxJQUFLLElBQUdVLElBQUksQ0FBQ00sSUFBTCxDQUFVLEdBQVYsQ0FBZSxHQUE3QjtBQUNEOztBQUVELFNBQU9oQixNQUFQO0FBQ0Q7O2VBR2NULE8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuXG5cbmNvbnN0IGF0b21zQ2FjaGUgPSB7fTtcblxuY29uc3QgaW5CdWlsZERpciA9IF9fZmlsZW5hbWUuaW5jbHVkZXMoJ2J1aWxkL2xpYi9hdG9tcycpO1xuXG5mdW5jdGlvbiBnZXRBdG9tRmlsZU5hbWUgKGF0b21OYW1lKSB7XG4gIHJldHVybiBpbkJ1aWxkRGlyXG4gICAgPyBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnYXRvbXMnLCBgJHthdG9tTmFtZX0uanNgKVxuICAgIDogcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJ2F0b21zJywgYCR7YXRvbU5hbWV9LmpzYCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEF0b20gKGF0b21OYW1lKSB7XG4gIC8vIGNoZWNrIGlmIHdlIGhhdmUgYWxyZWFkeSBsb2FkZWQgYW4gY2FjaGVkIHRoaXMgYXRvbVxuICBpZiAoIV8uaGFzKGF0b21zQ2FjaGUsIGF0b21OYW1lKSkge1xuICAgIGNvbnN0IGF0b21GaWxlTmFtZSA9IGdldEF0b21GaWxlTmFtZShhdG9tTmFtZSk7XG4gICAgdHJ5IHtcbiAgICAgIGF0b21zQ2FjaGVbYXRvbU5hbWVdID0gYXdhaXQgZnMucmVhZEZpbGUoYXRvbUZpbGVOYW1lKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBsb2FkIEF0b20gJyR7YXRvbU5hbWV9JyBmcm9tIGZpbGUgJyR7YXRvbUZpbGVOYW1lfSdgKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gYXRvbXNDYWNoZVthdG9tTmFtZV07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHdyYXBTY3JpcHRGb3JGcmFtZSAoc2NyaXB0LCBmcmFtZSkge1xuICBsb2cuZGVidWcoYFdyYXBwaW5nIHNjcmlwdCBmb3IgZnJhbWUgJyR7ZnJhbWV9J2ApO1xuICBjb25zdCBlbEZyb21DYWNoZSA9IGF3YWl0IGdldEF0b20oJ2dldF9lbGVtZW50X2Zyb21fY2FjaGUnKTtcbiAgcmV0dXJuIGAoZnVuY3Rpb24gKHdpbmRvdykgeyB2YXIgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7IGAgK1xuICAgICAgICAgYHJldHVybiAoJHtzY3JpcHR9KTsgfSkoKCR7ZWxGcm9tQ2FjaGUudG9TdHJpbmcoJ3V0ZjgnKX0pKCR7SlNPTi5zdHJpbmdpZnkoZnJhbWUpfSkpYDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0U2NyaXB0Rm9yQXRvbSAoYXRvbSwgYXJncywgZnJhbWVzID0gW10sIGFzeW5jQ2FsbEJhY2sgPSBudWxsKSB7XG4gIGNvbnN0IGF0b21TcmMgPSBhd2FpdCBnZXRBdG9tKGF0b20pO1xuICBsZXQgc2NyaXB0O1xuICBpZiAoZnJhbWVzLmxlbmd0aCA+IDApIHtcbiAgICBzY3JpcHQgPSBhdG9tU3JjO1xuICAgIGZvciAoY29uc3QgZnJhbWUgb2YgZnJhbWVzKSB7XG4gICAgICBzY3JpcHQgPSBhd2FpdCB3cmFwU2NyaXB0Rm9yRnJhbWUoc2NyaXB0LCBmcmFtZSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGxvZy5kZWJ1ZyhgRXhlY3V0aW5nICcke2F0b219JyBhdG9tIGluIGRlZmF1bHQgY29udGV4dGApO1xuICAgIHNjcmlwdCA9IGAoJHthdG9tU3JjfSlgO1xuICB9XG5cbiAgLy8gYWRkIHRoZSBhcmd1bWVudHMsIGFzIHN0cmluZ3NcbiAgYXJncyA9IGFyZ3MubWFwKEpTT04uc3RyaW5naWZ5KTtcbiAgaWYgKGFzeW5jQ2FsbEJhY2spIHtcbiAgICBzY3JpcHQgKz0gYCgke2FyZ3Muam9pbignLCcpfSwgJHthc3luY0NhbGxCYWNrfSwgdHJ1ZSlgO1xuICB9IGVsc2Uge1xuICAgIHNjcmlwdCArPSBgKCR7YXJncy5qb2luKCcsJyl9KWA7XG4gIH1cblxuICByZXR1cm4gc2NyaXB0O1xufVxuXG5leHBvcnQgeyBnZXRBdG9tLCBnZXRTY3JpcHRGb3JBdG9tIH07XG5leHBvcnQgZGVmYXVsdCBnZXRBdG9tO1xuIl0sImZpbGUiOiJsaWIvYXRvbXMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
