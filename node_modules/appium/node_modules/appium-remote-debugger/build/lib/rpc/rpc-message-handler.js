"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _events = _interopRequireDefault(require("events"));

class RpcMessageHandler extends _events.default {
  constructor(isTargetBased = false) {
    super();
    this.isTargetBased = isTargetBased;
  }

  get isTargetBased() {
    return this._isTargetBased;
  }

  set isTargetBased(isTargetBased) {
    this._isTargetBased = !!isTargetBased;
  }

  async handleMessage(plist) {
    const selector = plist.__selector;

    if (!selector) {
      _logger.default.debug('Got an invalid plist');

      return;
    }

    const argument = plist.__argument;

    switch (selector) {
      case '_rpc_reportSetup:':
        this.emit('_rpc_reportSetup:', null, argument.WIRSimulatorNameKey, argument.WIRSimulatorBuildKey, argument.WIRSimulatorProductVersionKey);
        break;

      case '_rpc_reportConnectedApplicationList:':
        this.emit('_rpc_reportConnectedApplicationList:', null, argument.WIRApplicationDictionaryKey);
        break;

      case '_rpc_applicationSentListing:':
        this.emit('_rpc_forwardGetListing:', null, argument.WIRApplicationIdentifierKey, argument.WIRListingKey);
        break;

      case '_rpc_applicationConnected:':
        this.emit('_rpc_applicationConnected:', null, argument);
        break;

      case '_rpc_applicationDisconnected:':
        this.emit('_rpc_applicationDisconnected:', null, argument);
        break;

      case '_rpc_applicationUpdated:':
        this.emit('_rpc_applicationUpdated:', null, argument);
        break;

      case '_rpc_reportConnectedDriverList:':
        this.emit('_rpc_reportConnectedDriverList:', null, argument);
        break;

      case '_rpc_reportCurrentState:':
        this.emit('_rpc_reportCurrentState:', null, argument);
        break;

      case '_rpc_applicationSentData:':
        await this.handleDataMessage(plist);
        break;

      default:
        _logger.default.debug(`Debugger got a message for '${selector}' and have no ` + `handler, doing nothing.`);

    }
  }

  parseDataKey(plist) {
    try {
      return JSON.parse(plist.__argument.WIRMessageDataKey.toString('utf8'));
    } catch (err) {
      _logger.default.error(`Unparseable message data: ${_lodash.default.truncate(JSON.stringify(plist), {
        length: 100
      })}`);

      throw new Error(`Unable to parse message data: ${err.message}`);
    }
  }

  async dispatchDataMessage(msgId, method, params, result, error) {
    if (!_lodash.default.isEmpty(msgId)) {
      _logger.default.debug(`Handling message (id: '${msgId}')`);
    }

    if (msgId) {
      if (this.listenerCount(msgId)) {
        var _result;

        if (_lodash.default.has((_result = result) === null || _result === void 0 ? void 0 : _result.result, 'value')) {
          result = result.result.value;
        }

        this.emit(msgId, error, result);
      } else {
        _logger.default.error(`Web Inspector returned data for message '${msgId}' ` + `but we were not waiting for that message! ` + `result: '${JSON.stringify(result)}'; ` + `error: '${JSON.stringify(error)}'`);
      }

      return;
    }

    let eventNames = [method];
    let args = [params];

    switch (method) {
      case 'Page.frameStoppedLoading':
        eventNames.push('Page.frameNavigated');

      case 'Page.frameNavigated':
        args = [`'${method}' event`];
        break;

      case 'Timeline.eventRecorded':
        args = [params || params.record];
        break;

      case 'Console.messageAdded':
        args = [params.message];
        break;

      case 'Runtime.executionContextCreated':
        args = [params.context];
        break;

      default:
        break;
    }

    if (_lodash.default.startsWith(method, 'Network.')) {
      eventNames.push('NetworkEvent');
      args.push(method);
    }

    if (_lodash.default.startsWith(method, 'Console.')) {
      eventNames.push('ConsoleEvent');
      args.push(method);
    }

    for (const name of eventNames) {
      this.emit(name, error, ...args);
    }
  }

  async handleDataMessage(plist) {
    var _result2;

    const dataKey = this.parseDataKey(plist);
    let msgId = (dataKey.id || '').toString();
    let result = dataKey.result;
    let method = dataKey.method;
    let params;

    if (method === 'Target.targetCreated') {
      const app = plist.__argument.WIRApplicationIdentifierKey;
      const targetInfo = dataKey.params.targetInfo;
      this.emit('Target.targetCreated', null, app, targetInfo);
      return;
    } else if (method === 'Target.didCommitProvisionalTarget') {
      const app = plist.__argument.WIRApplicationIdentifierKey;
      const oldTargetId = dataKey.params.oldTargetId;
      const newTargetId = dataKey.params.newTargetId;
      this.emit('Target.didCommitProvisionalTarget', null, app, oldTargetId, newTargetId);
      return;
    } else if (method === 'Target.targetDestroyed') {
      const app = plist.__argument.WIRApplicationIdentifierKey;
      const targetInfo = dataKey.params.targetInfo || {
        targetId: dataKey.params.targetId
      };
      this.emit('Target.targetDestroyed', null, app, targetInfo);
      return;
    }

    if (!dataKey.error && this.isTargetBased) {
      if (dataKey.method !== 'Target.dispatchMessageFromTarget') {
        return;
      }

      let message;

      try {
        message = JSON.parse(dataKey.params.message);
        msgId = message.id;
        method = message.method;
        result = message.result || message;
        params = result.params;
      } catch (err) {
        _logger.default.error(`Unexpected message format from Web Inspector:`);

        this.warn(_appiumSupport.util.jsonStringify(plist));
        throw err;
      }
    } else {
      params = dataKey.params;
    }

    let error = dataKey.error || null;

    if ((_result2 = result) === null || _result2 === void 0 ? void 0 : _result2.wasThrown) {
      var _result3, _result3$result, _result4, _result4$result, _result5, _result5$result, _result6, _result6$result;

      const message = ((_result3 = result) === null || _result3 === void 0 ? void 0 : (_result3$result = _result3.result) === null || _result3$result === void 0 ? void 0 : _result3$result.value) || ((_result4 = result) === null || _result4 === void 0 ? void 0 : (_result4$result = _result4.result) === null || _result4$result === void 0 ? void 0 : _result4$result.description) ? ((_result5 = result) === null || _result5 === void 0 ? void 0 : (_result5$result = _result5.result) === null || _result5$result === void 0 ? void 0 : _result5$result.value) || ((_result6 = result) === null || _result6 === void 0 ? void 0 : (_result6$result = _result6.result) === null || _result6$result === void 0 ? void 0 : _result6$result.description) : 'Error occurred in handling data message';
      error = new Error(message);
    }

    await this.dispatchDataMessage(msgId, method, params, result, error);
  }

}

exports.default = RpcMessageHandler;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ycGMvcnBjLW1lc3NhZ2UtaGFuZGxlci5qcyJdLCJuYW1lcyI6WyJScGNNZXNzYWdlSGFuZGxlciIsIkV2ZW50RW1pdHRlcnMiLCJjb25zdHJ1Y3RvciIsImlzVGFyZ2V0QmFzZWQiLCJfaXNUYXJnZXRCYXNlZCIsImhhbmRsZU1lc3NhZ2UiLCJwbGlzdCIsInNlbGVjdG9yIiwiX19zZWxlY3RvciIsImxvZyIsImRlYnVnIiwiYXJndW1lbnQiLCJfX2FyZ3VtZW50IiwiZW1pdCIsIldJUlNpbXVsYXRvck5hbWVLZXkiLCJXSVJTaW11bGF0b3JCdWlsZEtleSIsIldJUlNpbXVsYXRvclByb2R1Y3RWZXJzaW9uS2V5IiwiV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5IiwiV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5IiwiV0lSTGlzdGluZ0tleSIsImhhbmRsZURhdGFNZXNzYWdlIiwicGFyc2VEYXRhS2V5IiwiSlNPTiIsInBhcnNlIiwiV0lSTWVzc2FnZURhdGFLZXkiLCJ0b1N0cmluZyIsImVyciIsImVycm9yIiwiXyIsInRydW5jYXRlIiwic3RyaW5naWZ5IiwibGVuZ3RoIiwiRXJyb3IiLCJtZXNzYWdlIiwiZGlzcGF0Y2hEYXRhTWVzc2FnZSIsIm1zZ0lkIiwibWV0aG9kIiwicGFyYW1zIiwicmVzdWx0IiwiaXNFbXB0eSIsImxpc3RlbmVyQ291bnQiLCJoYXMiLCJ2YWx1ZSIsImV2ZW50TmFtZXMiLCJhcmdzIiwicHVzaCIsInJlY29yZCIsImNvbnRleHQiLCJzdGFydHNXaXRoIiwibmFtZSIsImRhdGFLZXkiLCJpZCIsImFwcCIsInRhcmdldEluZm8iLCJvbGRUYXJnZXRJZCIsIm5ld1RhcmdldElkIiwidGFyZ2V0SWQiLCJ3YXJuIiwidXRpbCIsImpzb25TdHJpbmdpZnkiLCJ3YXNUaHJvd24iLCJkZXNjcmlwdGlvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHZSxNQUFNQSxpQkFB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LE1BQWpCO0FBQ0FFLFFBQUFBLE1BQU0sR0FBR0wsT0FBTyxDQUFDSyxNQUFSLElBQWtCTCxPQUEzQjtBQUNBSSxRQUFBQSxNQUFNLEdBQUdDLE1BQU0sQ0FBQ0QsTUFBaEI7QUFDRCxPQU5ELENBTUUsT0FBT1gsR0FBUCxFQUFZO0FBR1pqQix3QkFBSWtCLEtBQUosQ0FBVywrQ0FBWDs7QUFDQSxhQUFLOEIsSUFBTCxDQUFVQyxvQkFBS0MsYUFBTCxDQUFtQnJELEtBQW5CLENBQVY7QUFDQSxjQUFNb0IsR0FBTjtBQUNEO0FBQ0YsS0F0QkQsTUFzQk87QUFDTFcsTUFBQUEsTUFBTSxHQUFHYSxPQUFPLENBQUNiLE1BQWpCO0FBQ0Q7O0FBR0QsUUFBSVYsS0FBSyxHQUFHdUIsT0FBTyxDQUFDdkIsS0FBUixJQUFpQixJQUE3Qjs7QUFDQSxvQkFBSVcsTUFBSiw2Q0FBSSxTQUFRc0IsU0FBWixFQUF1QjtBQUFBOztBQUNyQixZQUFNM0IsT0FBTyxHQUFJLGFBQUFLLE1BQU0sVUFBTiwrREFBUUEsTUFBUixvRUFBZ0JJLEtBQWhCLGtCQUF5QkosTUFBekIsZ0VBQXlCLFNBQVFBLE1BQWpDLG9EQUF5QixnQkFBZ0J1QixXQUF6QyxDQUFELEdBQ1gsYUFBQXZCLE1BQU0sVUFBTiwrREFBUUEsTUFBUixvRUFBZ0JJLEtBQWhCLGtCQUF5QkosTUFBekIsZ0VBQXlCLFNBQVFBLE1BQWpDLG9EQUF5QixnQkFBZ0J1QixXQUF6QyxDQURXLEdBRVoseUNBRko7QUFHQWxDLE1BQUFBLEtBQUssR0FBRyxJQUFJSyxLQUFKLENBQVVDLE9BQVYsQ0FBUjtBQUNEOztBQUVELFVBQU0sS0FBS0MsbUJBQUwsQ0FBeUJDLEtBQXpCLEVBQWdDQyxNQUFoQyxFQUF3Q0MsTUFBeEMsRUFBZ0RDLE1BQWhELEVBQXdEWCxLQUF4RCxDQUFOO0FBQ0Q7O0FBNU0wRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IEV2ZW50RW1pdHRlcnMgZnJvbSAnZXZlbnRzJztcblxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBScGNNZXNzYWdlSGFuZGxlciBleHRlbmRzIEV2ZW50RW1pdHRlcnMge1xuICBjb25zdHJ1Y3RvciAoaXNUYXJnZXRCYXNlZCA9IGZhbHNlKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIHRoaXMuaXNUYXJnZXRCYXNlZCA9IGlzVGFyZ2V0QmFzZWQ7XG4gIH1cblxuICBnZXQgaXNUYXJnZXRCYXNlZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2lzVGFyZ2V0QmFzZWQ7XG4gIH1cblxuICBzZXQgaXNUYXJnZXRCYXNlZCAoaXNUYXJnZXRCYXNlZCkge1xuICAgIHRoaXMuX2lzVGFyZ2V0QmFzZWQgPSAhIWlzVGFyZ2V0QmFzZWQ7XG4gIH1cblxuICBhc3luYyBoYW5kbGVNZXNzYWdlIChwbGlzdCkge1xuICAgIGNvbnN0IHNlbGVjdG9yID0gcGxpc3QuX19zZWxlY3RvcjtcbiAgICBpZiAoIXNlbGVjdG9yKSB7XG4gICAgICBsb2cuZGVidWcoJ0dvdCBhbiBpbnZhbGlkIHBsaXN0Jyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgYXJndW1lbnQgPSBwbGlzdC5fX2FyZ3VtZW50O1xuICAgIHN3aXRjaCAoc2VsZWN0b3IpIHtcbiAgICAgIGNhc2UgJ19ycGNfcmVwb3J0U2V0dXA6JzpcbiAgICAgICAgdGhpcy5lbWl0KCdfcnBjX3JlcG9ydFNldHVwOicsXG4gICAgICAgICAgbnVsbCxcbiAgICAgICAgICBhcmd1bWVudC5XSVJTaW11bGF0b3JOYW1lS2V5LFxuICAgICAgICAgIGFyZ3VtZW50LldJUlNpbXVsYXRvckJ1aWxkS2V5LFxuICAgICAgICAgIGFyZ3VtZW50LldJUlNpbXVsYXRvclByb2R1Y3RWZXJzaW9uS2V5XG4gICAgICAgICk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnX3JwY19yZXBvcnRDb25uZWN0ZWRBcHBsaWNhdGlvbkxpc3Q6JzpcbiAgICAgICAgdGhpcy5lbWl0KCdfcnBjX3JlcG9ydENvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdDonLFxuICAgICAgICAgIG51bGwsXG4gICAgICAgICAgYXJndW1lbnQuV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5XG4gICAgICAgICk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnX3JwY19hcHBsaWNhdGlvblNlbnRMaXN0aW5nOic6XG4gICAgICAgIHRoaXMuZW1pdCgnX3JwY19mb3J3YXJkR2V0TGlzdGluZzonLFxuICAgICAgICAgIG51bGwsXG4gICAgICAgICAgYXJndW1lbnQuV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5LFxuICAgICAgICAgIGFyZ3VtZW50LldJUkxpc3RpbmdLZXlcbiAgICAgICAgKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOic6XG4gICAgICAgIHRoaXMuZW1pdCgnX3JwY19hcHBsaWNhdGlvbkNvbm5lY3RlZDonLCBudWxsLCBhcmd1bWVudCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnX3JwY19hcHBsaWNhdGlvbkRpc2Nvbm5lY3RlZDonOlxuICAgICAgICB0aGlzLmVtaXQoJ19ycGNfYXBwbGljYXRpb25EaXNjb25uZWN0ZWQ6JywgbnVsbCwgYXJndW1lbnQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ19ycGNfYXBwbGljYXRpb25VcGRhdGVkOic6XG4gICAgICAgIHRoaXMuZW1pdCgnX3JwY19hcHBsaWNhdGlvblVwZGF0ZWQ6JywgbnVsbCwgYXJndW1lbnQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ19ycGNfcmVwb3J0Q29ubmVjdGVkRHJpdmVyTGlzdDonOlxuICAgICAgICB0aGlzLmVtaXQoJ19ycGNfcmVwb3J0Q29ubmVjdGVkRHJpdmVyTGlzdDonLCBudWxsLCBhcmd1bWVudCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnX3JwY19yZXBvcnRDdXJyZW50U3RhdGU6JzpcbiAgICAgICAgdGhpcy5lbWl0KCdfcnBjX3JlcG9ydEN1cnJlbnRTdGF0ZTonLCBudWxsLCBhcmd1bWVudCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnX3JwY19hcHBsaWNhdGlvblNlbnREYXRhOic6XG4gICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlRGF0YU1lc3NhZ2UocGxpc3QpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGxvZy5kZWJ1ZyhgRGVidWdnZXIgZ290IGEgbWVzc2FnZSBmb3IgJyR7c2VsZWN0b3J9JyBhbmQgaGF2ZSBubyBgICtcbiAgICAgICAgICBgaGFuZGxlciwgZG9pbmcgbm90aGluZy5gKTtcbiAgICB9XG4gIH1cblxuICBwYXJzZURhdGFLZXkgKHBsaXN0KSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBKU09OLnBhcnNlKHBsaXN0Ll9fYXJndW1lbnQuV0lSTWVzc2FnZURhdGFLZXkudG9TdHJpbmcoJ3V0ZjgnKSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3IoYFVucGFyc2VhYmxlIG1lc3NhZ2UgZGF0YTogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KHBsaXN0KSwge2xlbmd0aDogMTAwfSl9YCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBwYXJzZSBtZXNzYWdlIGRhdGE6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGlzcGF0Y2hEYXRhTWVzc2FnZSAobXNnSWQsIG1ldGhvZCwgcGFyYW1zLCByZXN1bHQsIGVycm9yKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICAgIGlmICghXy5pc0VtcHR5KG1zZ0lkKSkge1xuICAgICAgbG9nLmRlYnVnKGBIYW5kbGluZyBtZXNzYWdlIChpZDogJyR7bXNnSWR9JylgKTtcbiAgICB9XG5cbiAgICBpZiAobXNnSWQpIHtcbiAgICAgIGlmICh0aGlzLmxpc3RlbmVyQ291bnQobXNnSWQpKSB7XG4gICAgICAgIGlmIChfLmhhcyhyZXN1bHQ/LnJlc3VsdCwgJ3ZhbHVlJykpIHtcbiAgICAgICAgICByZXN1bHQgPSByZXN1bHQucmVzdWx0LnZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZW1pdChtc2dJZCwgZXJyb3IsIHJlc3VsdCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZXJyb3IoYFdlYiBJbnNwZWN0b3IgcmV0dXJuZWQgZGF0YSBmb3IgbWVzc2FnZSAnJHttc2dJZH0nIGAgK1xuICAgICAgICAgIGBidXQgd2Ugd2VyZSBub3Qgd2FpdGluZyBmb3IgdGhhdCBtZXNzYWdlISBgICtcbiAgICAgICAgICBgcmVzdWx0OiAnJHtKU09OLnN0cmluZ2lmeShyZXN1bHQpfSc7IGAgK1xuICAgICAgICAgIGBlcnJvcjogJyR7SlNPTi5zdHJpbmdpZnkoZXJyb3IpfSdgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgZXZlbnROYW1lcyA9IFttZXRob2RdO1xuICAgIGxldCBhcmdzID0gW3BhcmFtc107XG5cbiAgICAvLyBzb21lIGV2ZW50cyBoYXZlIGRpZmZlcmVudCBuYW1lcywgb3IgdGhlIGFyZ3VtZW50cyBhcmUgbWFwcGVkIGZyb20gdGhlXG4gICAgLy8gcGFyYW1ldGVycyByZWNlaXZlZFxuICAgIHN3aXRjaCAobWV0aG9kKSB7XG4gICAgICBjYXNlICdQYWdlLmZyYW1lU3RvcHBlZExvYWRpbmcnOlxuICAgICAgICBldmVudE5hbWVzLnB1c2goJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnKTtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1mYWxsdGhyb3VnaFxuICAgICAgY2FzZSAnUGFnZS5mcmFtZU5hdmlnYXRlZCc6XG4gICAgICAgIGFyZ3MgPSBbYCcke21ldGhvZH0nIGV2ZW50YF07XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnVGltZWxpbmUuZXZlbnRSZWNvcmRlZCc6XG4gICAgICAgIGFyZ3MgPSBbcGFyYW1zIHx8IHBhcmFtcy5yZWNvcmRdO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0NvbnNvbGUubWVzc2FnZUFkZGVkJzpcbiAgICAgICAgYXJncyA9IFtwYXJhbXMubWVzc2FnZV07XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnUnVudGltZS5leGVjdXRpb25Db250ZXh0Q3JlYXRlZCc6XG4gICAgICAgIGFyZ3MgPSBbcGFyYW1zLmNvbnRleHRdO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIC8vIHBhc3NcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgaWYgKF8uc3RhcnRzV2l0aChtZXRob2QsICdOZXR3b3JrLicpKSB7XG4gICAgICAvLyBhZ2dyZWdhdGUgTmV0d29yayBldmVudHMsIGFuZCBhZGQgb3JpZ2luYWwgbWV0aG9kIG5hbWUgdG8gdGhlIGFyZ3VtZW50c1xuICAgICAgZXZlbnROYW1lcy5wdXNoKCdOZXR3b3JrRXZlbnQnKTtcbiAgICAgIGFyZ3MucHVzaChtZXRob2QpO1xuICAgIH1cbiAgICBpZiAoXy5zdGFydHNXaXRoKG1ldGhvZCwgJ0NvbnNvbGUuJykpIHtcbiAgICAgIC8vIGFnZ3JlZ2F0ZSBOZXR3b3JrIGV2ZW50cywgYW5kIGFkZCBvcmlnaW5hbCBtZXRob2QgbmFtZSB0byB0aGUgYXJndW1lbnRzXG4gICAgICBldmVudE5hbWVzLnB1c2goJ0NvbnNvbGVFdmVudCcpO1xuICAgICAgYXJncy5wdXNoKG1ldGhvZCk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBuYW1lIG9mIGV2ZW50TmFtZXMpIHtcbiAgICAgIHRoaXMuZW1pdChuYW1lLCBlcnJvciwgLi4uYXJncyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaGFuZGxlRGF0YU1lc3NhZ2UgKHBsaXN0KSB7XG4gICAgY29uc3QgZGF0YUtleSA9IHRoaXMucGFyc2VEYXRhS2V5KHBsaXN0KTtcbiAgICBsZXQgbXNnSWQgPSAoZGF0YUtleS5pZCB8fCAnJykudG9TdHJpbmcoKTtcbiAgICBsZXQgcmVzdWx0ID0gZGF0YUtleS5yZXN1bHQ7XG5cbiAgICBsZXQgbWV0aG9kID0gZGF0YUtleS5tZXRob2Q7XG4gICAgbGV0IHBhcmFtcztcblxuICAgIGlmIChtZXRob2QgPT09ICdUYXJnZXQudGFyZ2V0Q3JlYXRlZCcpIHtcbiAgICAgIC8vIHRoaXMgaXMgaW4gcmVzcG9uc2UgdG8gYSBgX3JwY19mb3J3YXJkU29ja2V0U2V0dXA6YCBjYWxsXG4gICAgICAvLyB0YXJnZXRJbmZvOiB7IHRhcmdldElkOiAncGFnZS0xJywgdHlwZTogJ3BhZ2UnIH1cbiAgICAgIGNvbnN0IGFwcCA9IHBsaXN0Ll9fYXJndW1lbnQuV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5O1xuICAgICAgY29uc3QgdGFyZ2V0SW5mbyA9IGRhdGFLZXkucGFyYW1zLnRhcmdldEluZm87XG4gICAgICB0aGlzLmVtaXQoJ1RhcmdldC50YXJnZXRDcmVhdGVkJywgbnVsbCwgYXBwLCB0YXJnZXRJbmZvKTtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gJ1RhcmdldC5kaWRDb21taXRQcm92aXNpb25hbFRhcmdldCcpIHtcbiAgICAgIGNvbnN0IGFwcCA9IHBsaXN0Ll9fYXJndW1lbnQuV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5O1xuICAgICAgY29uc3Qgb2xkVGFyZ2V0SWQgPSBkYXRhS2V5LnBhcmFtcy5vbGRUYXJnZXRJZDtcbiAgICAgIGNvbnN0IG5ld1RhcmdldElkID0gZGF0YUtleS5wYXJhbXMubmV3VGFyZ2V0SWQ7XG4gICAgICB0aGlzLmVtaXQoJ1RhcmdldC5kaWRDb21taXRQcm92aXNpb25hbFRhcmdldCcsIG51bGwsIGFwcCwgb2xkVGFyZ2V0SWQsIG5ld1RhcmdldElkKTtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKG1ldGhvZCA9PT0gJ1RhcmdldC50YXJnZXREZXN0cm95ZWQnKSB7XG4gICAgICBjb25zdCBhcHAgPSBwbGlzdC5fX2FyZ3VtZW50LldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTtcbiAgICAgIGNvbnN0IHRhcmdldEluZm8gPSBkYXRhS2V5LnBhcmFtcy50YXJnZXRJbmZvIHx8IHt0YXJnZXRJZDogZGF0YUtleS5wYXJhbXMudGFyZ2V0SWR9O1xuICAgICAgdGhpcy5lbWl0KCdUYXJnZXQudGFyZ2V0RGVzdHJveWVkJywgbnVsbCwgYXBwLCB0YXJnZXRJbmZvKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIWRhdGFLZXkuZXJyb3IgJiYgdGhpcy5pc1RhcmdldEJhc2VkKSB7XG4gICAgICBpZiAoZGF0YUtleS5tZXRob2QgIT09ICdUYXJnZXQuZGlzcGF0Y2hNZXNzYWdlRnJvbVRhcmdldCcpIHtcbiAgICAgICAgLy8gdGhpcyBzb3J0IG9mIG1lc3NhZ2UsIGF0IHRoaXMgcG9pbnQsIGlzIGp1c3QgYW4gYWNrbm93bGVkZ2VtZW50XG4gICAgICAgIC8vIHRoYXQgdGhlIG9yaWdpbmFsIG1lc3NhZ2Ugd2FzIHJlY2VpdmVkXG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gYXQgdGhpcyBwb2ludCwgd2UgaGF2ZSBhIFRhcmdldC1iYXNlZCBtZXNzYWdlIHdyYXBwaW5nIGEgcHJvdG9jb2wgbWVzc2FnZVxuICAgICAgbGV0IG1lc3NhZ2U7XG4gICAgICB0cnkge1xuICAgICAgICBtZXNzYWdlID0gSlNPTi5wYXJzZShkYXRhS2V5LnBhcmFtcy5tZXNzYWdlKTtcbiAgICAgICAgbXNnSWQgPSBtZXNzYWdlLmlkO1xuICAgICAgICBtZXRob2QgPSBtZXNzYWdlLm1ldGhvZDtcbiAgICAgICAgcmVzdWx0ID0gbWVzc2FnZS5yZXN1bHQgfHwgbWVzc2FnZTtcbiAgICAgICAgcGFyYW1zID0gcmVzdWx0LnBhcmFtcztcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyBpZiB0aGlzIGhhcHBlbnMgdGhlbiBzb21lIGFzcGVjdCBvZiB0aGUgcHJvdG9jb2wgaXMgbWlzc2luZyB0byB1c1xuICAgICAgICAvLyBzbyBwcmludCB0aGUgZW50aXJlIG1lc3NhZ2UgdG8gZ2V0IHZpc2liaWl0eSBpbnRvIHdoYXQgaXMgZ29pbmcgb25cbiAgICAgICAgbG9nLmVycm9yKGBVbmV4cGVjdGVkIG1lc3NhZ2UgZm9ybWF0IGZyb20gV2ViIEluc3BlY3RvcjpgKTtcbiAgICAgICAgdGhpcy53YXJuKHV0aWwuanNvblN0cmluZ2lmeShwbGlzdCkpO1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtcyA9IGRhdGFLZXkucGFyYW1zO1xuICAgIH1cblxuICAgIC8vIHdlIGNhbiBnZXQgYW4gZXJyb3IsIG9yIHdlIGNhbiBnZXQgYSByZXNwb25zZSB0aGF0IGlzIGFuIGVycm9yXG4gICAgbGV0IGVycm9yID0gZGF0YUtleS5lcnJvciB8fCBudWxsO1xuICAgIGlmIChyZXN1bHQ/Lndhc1Rocm93bikge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IChyZXN1bHQ/LnJlc3VsdD8udmFsdWUgfHwgcmVzdWx0Py5yZXN1bHQ/LmRlc2NyaXB0aW9uKVxuICAgICAgICA/IChyZXN1bHQ/LnJlc3VsdD8udmFsdWUgfHwgcmVzdWx0Py5yZXN1bHQ/LmRlc2NyaXB0aW9uKVxuICAgICAgICA6ICdFcnJvciBvY2N1cnJlZCBpbiBoYW5kbGluZyBkYXRhIG1lc3NhZ2UnO1xuICAgICAgZXJyb3IgPSBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5kaXNwYXRjaERhdGFNZXNzYWdlKG1zZ0lkLCBtZXRob2QsIHBhcmFtcywgcmVzdWx0LCBlcnJvcik7XG4gIH1cbn1cbiJdLCJmaWxlIjoibGliL3JwYy9ycGMtbWVzc2FnZS1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
