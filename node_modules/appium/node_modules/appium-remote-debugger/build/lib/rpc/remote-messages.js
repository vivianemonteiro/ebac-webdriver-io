"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.RemoteMessages = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _protocol = _interopRequireDefault(require("../protocol"));

const OBJECT_GROUP = 'console';
const MINIMAL_COMMAND = 'getMinimalCommand';
const FULL_COMMAND = 'getFullCommand';
const DIRECT_COMMAND = 'getDirectCommand';
const COMMANDS = {
  'Page.getCookies': FULL_COMMAND,
  'Page.navigate': FULL_COMMAND,
  'Runtime.awaitPromise': FULL_COMMAND,
  'Runtime.callFunctionOn': FULL_COMMAND,
  'Runtime.evaluate': FULL_COMMAND,
  'Target.exists': DIRECT_COMMAND,
  'Timeline.start': FULL_COMMAND,
  'Timeline.stop': FULL_COMMAND
};

class RemoteMessages {
  constructor(isTargetBased = false) {
    this.isTargetBased = isTargetBased;
  }

  set isTargetBased(isTargetBased) {
    this._isTargetBased = isTargetBased;
  }

  get isTargetBased() {
    return this._isTargetBased;
  }

  setConnectionKey(connId) {
    return {
      __argument: {
        WIRConnectionIdentifierKey: connId
      },
      __selector: '_rpc_reportIdentifier:'
    };
  }

  connectToApp(connId, appIdKey) {
    return {
      __argument: {
        WIRConnectionIdentifierKey: connId,
        WIRApplicationIdentifierKey: appIdKey
      },
      __selector: '_rpc_forwardGetListing:'
    };
  }

  setSenderKey(connId, senderId, appIdKey, pageIdKey) {
    return {
      __argument: {
        WIRApplicationIdentifierKey: appIdKey,
        WIRConnectionIdentifierKey: connId,
        WIRSenderKey: senderId,
        WIRPageIdentifierKey: pageIdKey,
        WIRAutomaticallyPause: false
      },
      __selector: '_rpc_forwardSocketSetup:'
    };
  }

  indicateWebView(connId, appIdKey, pageIdKey, enabled) {
    return {
      __argument: {
        WIRApplicationIdentifierKey: appIdKey,
        WIRIndicateEnabledKey: _lodash.default.isNil(enabled) ? true : enabled,
        WIRConnectionIdentifierKey: connId,
        WIRPageIdentifierKey: pageIdKey
      },
      __selector: '_rpc_forwardIndicateWebView:'
    };
  }

  launchApplication(bundleId) {
    return {
      __argument: {
        WIRApplicationBundleIdentifierKey: bundleId
      },
      __selector: '_rpc_requestApplicationLaunch:'
    };
  }

  getFullCommand(opts = {}) {
    const {
      method,
      params,
      connId,
      senderId,
      appIdKey,
      pageIdKey,
      targetId,
      id
    } = opts;
    let realMethod;
    let realParams;

    if (this.isTargetBased) {
      realMethod = 'Target.sendMessageToTarget';
      realParams = {
        targetId,
        message: JSON.stringify({
          id,
          method,
          params: Object.assign({
            objectGroup: OBJECT_GROUP,
            includeCommandLineAPI: true,
            doNotPauseOnExceptionsAndMuteConsole: false,
            emulateUserGesture: false,
            generatePreview: false,
            saveResult: false
          }, params)
        })
      };
    } else {
      realMethod = method;
      realParams = Object.assign({
        objectGroup: OBJECT_GROUP,
        includeCommandLineAPI: true,
        doNotPauseOnExceptionsAndMuteConsole: false,
        emulateUserGesture: false
      }, params);
    }

    const plist = {
      __argument: {
        WIRSocketDataKey: {
          method: realMethod,
          params: realParams
        },
        WIRConnectionIdentifierKey: connId,
        WIRSenderKey: senderId,
        WIRApplicationIdentifierKey: appIdKey,
        WIRPageIdentifierKey: pageIdKey
      },
      __selector: '_rpc_forwardSocketData:'
    };
    return _lodash.default.omitBy(plist, _lodash.default.isNil);
  }

  getMinimalCommand(opts = {}) {
    const {
      method,
      params,
      connId,
      senderId,
      appIdKey,
      pageIdKey,
      targetId,
      id
    } = opts;
    let realMethod = method;
    let realParams = params;

    if (this.isTargetBased) {
      realMethod = 'Target.sendMessageToTarget';
      realParams = {
        targetId,
        message: JSON.stringify({
          id,
          method,
          params
        })
      };
    }

    const plist = {
      __argument: {
        WIRSocketDataKey: {
          method: realMethod,
          params: realParams
        },
        WIRConnectionIdentifierKey: connId,
        WIRSenderKey: senderId,
        WIRApplicationIdentifierKey: appIdKey,
        WIRPageIdentifierKey: pageIdKey
      },
      __selector: '_rpc_forwardSocketData:'
    };
    return _lodash.default.omitBy(plist, _lodash.default.isNil);
  }

  getDirectCommand(opts = {}) {
    const {
      method,
      params,
      connId,
      senderId,
      appIdKey,
      pageIdKey,
      id
    } = opts;
    const plist = {
      __argument: {
        WIRSocketDataKey: {
          id,
          method,
          params
        },
        WIRConnectionIdentifierKey: connId,
        WIRSenderKey: senderId,
        WIRApplicationIdentifierKey: appIdKey,
        WIRPageIdentifierKey: pageIdKey
      },
      __selector: '_rpc_forwardSocketData:'
    };
    return _lodash.default.omitBy(plist, _lodash.default.isNil);
  }

  getRemoteCommand(command, opts) {
    const {
      id,
      connId,
      appIdKey,
      senderId,
      pageIdKey,
      targetId
    } = opts;

    switch (command) {
      case 'setConnectionKey':
        return this.setConnectionKey(connId);

      case 'indicateWebView':
        return this.indicateWebView(connId, appIdKey, pageIdKey, opts.enabled);

      case 'connectToApp':
        return this.connectToApp(connId, appIdKey);

      case 'setSenderKey':
        return this.setSenderKey(connId, senderId, appIdKey, pageIdKey);

      case 'launchApplication':
        return this.launchApplication(opts.bundleId);
    }

    const builderFunction = COMMANDS[command] || MINIMAL_COMMAND;
    return this[builderFunction]({ ...(0, _protocol.default)(id, command, opts),
      connId,
      appIdKey,
      senderId,
      pageIdKey,
      targetId
    });
  }

}

exports.RemoteMessages = RemoteMessages;
var _default = RemoteMessages;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ycGMvcmVtb3RlLW1lc3NhZ2VzLmpzIl0sIm5hbWVzIjpbIk9CSkVDVF9HUk9VUCIsIk1JTklNQUxfQ09NTUFORCIsIkZVTExfQ09NTUFORCIsIkRJUkVDVF9DT01NQU5EIiwiQ09NTUFORFMiLCJSZW1vdGVNZXNzYWdlcyIsImNvbnN0cnVjdG9yIiwiaXNUYXJnZXRCYXNlZCIsIl9pc1RhcmdldEJhc2VkIiwic2V0Q29ubmVjdGlvbktleSIsImNvbm5JZCIsIl9fYXJndW1lbnQiLCJXSVJDb25uZWN0aW9uSWRlbnRpZmllcktleSIsIl9fc2VsZWN0b3IiLCJjb25uZWN0VG9BcHAiLCJhcHBJZEtleSIsIldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleSIsInNldFNlbmRlcktleSIsInNlbmRlcklkIiwicGFnZUlkS2V5IiwiV0lSU2VuZGVyS2V5IiwiV0lSUGFnZUlkZW50aWZpZXJLZXkiLCJXSVJBdXRvbWF0aWNhbGx5UGF1c2UiLCJpbmRpY2F0ZVdlYlZpZXciLCJlbmFibGVkIiwiV0lSSW5kaWNhdGVFbmFibGVkS2V5IiwiXyIsImlzTmlsIiwibGF1bmNoQXBwbGljYXRpb24iLCJidW5kbGVJZCIsIldJUkFwcGxpY2F0aW9uQnVuZGxlSWRlbnRpZmllcktleSIsImdldEZ1bGxDb21tYW5kIiwib3B0cyIsIm1ldGhvZCIsInBhcmFtcyIsInRhcmdldElkIiwiaWQiLCJyZWFsTWV0aG9kIiwicmVhbFBhcmFtcyIsIm1lc3NhZ2UiLCJKU09OIiwic3RyaW5naWZ5IiwiT2JqZWN0IiwiYXNzaWduIiwib2JqZWN0R3JvdXAiLCJpbmNsdWRlQ29tbWFuZExpbmVBUEkiLCJkb05vdFBhdXNlT25FeGNlcHRpb25zQW5kTXV0ZUNvbnNvbGUiLCJlbXVsYXRlVXNlckdlc3R1cmUiLCJnZW5lcmF0ZVByZXZpZXciLCJzYXZlUmVzdWx0IiwicGxpc3QiLCJXSVJTb2NrZXREYXRhS2V5Iiwib21pdEJ5IiwiZ2V0TWluaW1hbENvbW1hbmQiLCJnZXREaXJlY3RD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QUFBQSxTQUxJO0FBTUpnQixNQUFBQTtBQU5JLFFBT0ZILElBUEo7O0FBVUEsWUFBUXdCLE9BQVI7QUFDRSxXQUFLLGtCQUFMO0FBQ0UsZUFBTyxLQUFLL0MsZ0JBQUwsQ0FBc0JDLE1BQXRCLENBQVA7O0FBQ0YsV0FBSyxpQkFBTDtBQUNFLGVBQU8sS0FBS2EsZUFBTCxDQUFxQmIsTUFBckIsRUFBNkJLLFFBQTdCLEVBQXVDSSxTQUF2QyxFQUFrRGEsSUFBSSxDQUFDUixPQUF2RCxDQUFQOztBQUNGLFdBQUssY0FBTDtBQUNFLGVBQU8sS0FBS1YsWUFBTCxDQUFrQkosTUFBbEIsRUFBMEJLLFFBQTFCLENBQVA7O0FBQ0YsV0FBSyxjQUFMO0FBQ0UsZUFBTyxLQUFLRSxZQUFMLENBQWtCUCxNQUFsQixFQUEwQlEsUUFBMUIsRUFBb0NILFFBQXBDLEVBQThDSSxTQUE5QyxDQUFQOztBQUNGLFdBQUssbUJBQUw7QUFDRSxlQUFPLEtBQUtTLGlCQUFMLENBQXVCSSxJQUFJLENBQUNILFFBQTVCLENBQVA7QUFWSjs7QUFjQSxVQUFNNEIsZUFBZSxHQUFHckQsUUFBUSxDQUFDb0QsT0FBRCxDQUFSLElBQXFCdkQsZUFBN0M7QUFDQSxXQUFPLEtBQUt3RCxlQUFMLEVBQXNCLEVBQzNCLEdBQUcsdUJBQW1CckIsRUFBbkIsRUFBdUJvQixPQUF2QixFQUFnQ3hCLElBQWhDLENBRHdCO0FBRTNCdEIsTUFBQUEsTUFGMkI7QUFHM0JLLE1BQUFBLFFBSDJCO0FBSTNCRyxNQUFBQSxRQUoyQjtBQUszQkMsTUFBQUEsU0FMMkI7QUFNM0JnQixNQUFBQTtBQU4yQixLQUF0QixDQUFQO0FBUUQ7O0FBOU5rQjs7O2VBa09OOUIsYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgZ2V0UHJvdG9jb2xDb21tYW5kIGZyb20gJy4uL3Byb3RvY29sJztcblxuXG5jb25zdCBPQkpFQ1RfR1JPVVAgPSAnY29uc29sZSc7XG5cbmNvbnN0IE1JTklNQUxfQ09NTUFORCA9ICdnZXRNaW5pbWFsQ29tbWFuZCc7XG5jb25zdCBGVUxMX0NPTU1BTkQgPSAnZ2V0RnVsbENvbW1hbmQnO1xuY29uc3QgRElSRUNUX0NPTU1BTkQgPSAnZ2V0RGlyZWN0Q29tbWFuZCc7XG5cbi8vIG1hcHBpbmcgb2YgY29tbWFuZHMgdG8gdGhlIGZ1bmN0aW9uIGZvciBnZXR0aW5nIHRoZSBjb21tYW5kXG4vLyBkZWZhdWx0cyB0byBgZ2V0TWluaW1hbENvbW1hbmRgLCBzbyBubyBuZWVkIHRvIGhhdmUgdGhvc2UgbGlzdGVkIGhlcmVcbmNvbnN0IENPTU1BTkRTID0ge1xuICAnUGFnZS5nZXRDb29raWVzJzogRlVMTF9DT01NQU5ELFxuICAnUGFnZS5uYXZpZ2F0ZSc6IEZVTExfQ09NTUFORCxcblxuICAnUnVudGltZS5hd2FpdFByb21pc2UnOiBGVUxMX0NPTU1BTkQsXG4gICdSdW50aW1lLmNhbGxGdW5jdGlvbk9uJzogRlVMTF9DT01NQU5ELFxuICAnUnVudGltZS5ldmFsdWF0ZSc6IEZVTExfQ09NTUFORCxcblxuICAnVGFyZ2V0LmV4aXN0cyc6IERJUkVDVF9DT01NQU5ELFxuXG4gICdUaW1lbGluZS5zdGFydCc6IEZVTExfQ09NTUFORCxcbiAgJ1RpbWVsaW5lLnN0b3AnOiBGVUxMX0NPTU1BTkQsXG59O1xuXG5jbGFzcyBSZW1vdGVNZXNzYWdlcyB7XG4gIGNvbnN0cnVjdG9yIChpc1RhcmdldEJhc2VkID0gZmFsc2UpIHtcbiAgICB0aGlzLmlzVGFyZ2V0QmFzZWQgPSBpc1RhcmdldEJhc2VkO1xuICB9XG5cbiAgc2V0IGlzVGFyZ2V0QmFzZWQgKGlzVGFyZ2V0QmFzZWQpIHtcbiAgICB0aGlzLl9pc1RhcmdldEJhc2VkID0gaXNUYXJnZXRCYXNlZDtcbiAgfVxuXG4gIGdldCBpc1RhcmdldEJhc2VkICgpIHtcbiAgICByZXR1cm4gdGhpcy5faXNUYXJnZXRCYXNlZDtcbiAgfVxuXG4gIC8qXG4gICAqIENvbm5lY3Rpb24gZnVuY3Rpb25zXG4gICAqL1xuXG4gIHNldENvbm5lY3Rpb25LZXkgKGNvbm5JZCkge1xuICAgIHJldHVybiB7XG4gICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgIFdJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5OiBjb25uSWRcbiAgICAgIH0sXG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19yZXBvcnRJZGVudGlmaWVyOidcbiAgICB9O1xuICB9XG5cbiAgY29ubmVjdFRvQXBwIChjb25uSWQsIGFwcElkS2V5KSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSQ29ubmVjdGlvbklkZW50aWZpZXJLZXk6IGNvbm5JZCxcbiAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBhcHBJZEtleVxuICAgICAgfSxcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX2ZvcndhcmRHZXRMaXN0aW5nOidcbiAgICB9O1xuICB9XG5cbiAgc2V0U2VuZGVyS2V5IChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5KSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBhcHBJZEtleSxcbiAgICAgICAgV0lSQ29ubmVjdGlvbklkZW50aWZpZXJLZXk6IGNvbm5JZCxcbiAgICAgICAgV0lSU2VuZGVyS2V5OiBzZW5kZXJJZCxcbiAgICAgICAgV0lSUGFnZUlkZW50aWZpZXJLZXk6IHBhZ2VJZEtleSxcbiAgICAgICAgV0lSQXV0b21hdGljYWxseVBhdXNlOiBmYWxzZVxuICAgICAgfSxcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX2ZvcndhcmRTb2NrZXRTZXR1cDonXG4gICAgfTtcbiAgfVxuXG4gIGluZGljYXRlV2ViVmlldyAoY29ubklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBlbmFibGVkKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBhcHBJZEtleSxcbiAgICAgICAgV0lSSW5kaWNhdGVFbmFibGVkS2V5OiBfLmlzTmlsKGVuYWJsZWQpID8gdHJ1ZSA6IGVuYWJsZWQsXG4gICAgICAgIFdJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5OiBjb25uSWQsXG4gICAgICAgIFdJUlBhZ2VJZGVudGlmaWVyS2V5OiBwYWdlSWRLZXlcbiAgICAgIH0sXG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19mb3J3YXJkSW5kaWNhdGVXZWJWaWV3OidcbiAgICB9O1xuICB9XG5cbiAgbGF1bmNoQXBwbGljYXRpb24gKGJ1bmRsZUlkKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSQXBwbGljYXRpb25CdW5kbGVJZGVudGlmaWVyS2V5OiBidW5kbGVJZFxuICAgICAgfSxcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX3JlcXVlc3RBcHBsaWNhdGlvbkxhdW5jaDonXG4gICAgfTtcbiAgfVxuXG4gIGdldEZ1bGxDb21tYW5kIChvcHRzID0ge30pIHtcbiAgICBjb25zdCB7XG4gICAgICBtZXRob2QsXG4gICAgICBwYXJhbXMsXG4gICAgICBjb25uSWQsXG4gICAgICBzZW5kZXJJZCxcbiAgICAgIGFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5LFxuICAgICAgdGFyZ2V0SWQsXG4gICAgICBpZCxcbiAgICB9ID0gb3B0cztcblxuICAgIC8qIFRoZSBXZWIgSW5zcGVjdG9yIGhhcyBhIG51bWJlciBvZiBwYXJhbWV0ZXJzIHRoYXQgY2FuIGJlIHBhc3NlZCBpbiwgYXNcbiAgICAgKiBzZWVuIHdoZW4gZHVtcGluZyB3aGF0IFNhZmFyaSBpcyBkb2luZyB3aGVuIGNvbW11bmljYXRpbmcgd2l0aCBpdC4gTW9zdFxuICAgICAqIGFyZSBrZXB0IGFzIHRoZXkgYXJlIHNldCBmb3IgU2FmYXJpLiBUaGUgZXhjZXB0aW9uIGlzIGBlbXVsYXRlVXNlckdlc3R1cmVgXG4gICAgICogd2hpY2gsIG9uIGlPUyAxMyssIGJyZWFrcyBwb3B1cCBibG9ja2luZyAoaS5lLiwgZXZlbiB3aXRoIHRoZSBwb3B1cFxuICAgICAqIGJsb2NraW5nIHNldHRpbmcgb24sIG5ldyB3aW5kb3dzIGFyZSBvcGVuYWJsZSBib3RoIGZyb20gbGlua3MgYW5kIGZyb21cbiAgICAgKiBKYXZhU2NyaXB0KS5cbiAgICAgKi9cblxuICAgIGxldCByZWFsTWV0aG9kO1xuICAgIGxldCByZWFsUGFyYW1zO1xuICAgIGlmICh0aGlzLmlzVGFyZ2V0QmFzZWQpIHtcbiAgICAgIHJlYWxNZXRob2QgPSAnVGFyZ2V0LnNlbmRNZXNzYWdlVG9UYXJnZXQnO1xuICAgICAgcmVhbFBhcmFtcyA9IHtcbiAgICAgICAgdGFyZ2V0SWQsXG4gICAgICAgIG1lc3NhZ2U6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBpZCxcbiAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgcGFyYW1zOiBPYmplY3QuYXNzaWduKHtcbiAgICAgICAgICAgIG9iamVjdEdyb3VwOiBPQkpFQ1RfR1JPVVAsXG4gICAgICAgICAgICBpbmNsdWRlQ29tbWFuZExpbmVBUEk6IHRydWUsXG4gICAgICAgICAgICBkb05vdFBhdXNlT25FeGNlcHRpb25zQW5kTXV0ZUNvbnNvbGU6IGZhbHNlLFxuICAgICAgICAgICAgZW11bGF0ZVVzZXJHZXN0dXJlOiBmYWxzZSxcbiAgICAgICAgICAgIGdlbmVyYXRlUHJldmlldzogZmFsc2UsXG4gICAgICAgICAgICBzYXZlUmVzdWx0OiBmYWxzZSxcbiAgICAgICAgICB9LCBwYXJhbXMpXG4gICAgICAgIH0pLFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVhbE1ldGhvZCA9IG1ldGhvZDtcbiAgICAgIHJlYWxQYXJhbXMgPSBPYmplY3QuYXNzaWduKHtcbiAgICAgICAgb2JqZWN0R3JvdXA6IE9CSkVDVF9HUk9VUCxcbiAgICAgICAgaW5jbHVkZUNvbW1hbmRMaW5lQVBJOiB0cnVlLFxuICAgICAgICBkb05vdFBhdXNlT25FeGNlcHRpb25zQW5kTXV0ZUNvbnNvbGU6IGZhbHNlLFxuICAgICAgICBlbXVsYXRlVXNlckdlc3R1cmU6IGZhbHNlLFxuICAgICAgfSwgcGFyYW1zKTtcbiAgICB9XG5cbiAgICBjb25zdCBwbGlzdCA9IHtcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSU29ja2V0RGF0YUtleToge1xuICAgICAgICAgIG1ldGhvZDogcmVhbE1ldGhvZCxcbiAgICAgICAgICBwYXJhbXM6IHJlYWxQYXJhbXMsXG4gICAgICAgIH0sXG4gICAgICAgIFdJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5OiBjb25uSWQsXG4gICAgICAgIFdJUlNlbmRlcktleTogc2VuZGVySWQsXG4gICAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogYXBwSWRLZXksXG4gICAgICAgIFdJUlBhZ2VJZGVudGlmaWVyS2V5OiBwYWdlSWRLZXksXG4gICAgICB9LFxuICAgICAgX19zZWxlY3RvcjogJ19ycGNfZm9yd2FyZFNvY2tldERhdGE6JyxcbiAgICB9O1xuICAgIHJldHVybiBfLm9taXRCeShwbGlzdCwgXy5pc05pbCk7XG4gIH1cblxuICBnZXRNaW5pbWFsQ29tbWFuZCAob3B0cyA9IHt9KSB7XG4gICAgY29uc3Qge21ldGhvZCwgcGFyYW1zLCBjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCB0YXJnZXRJZCwgaWR9ID0gb3B0cztcblxuICAgIGxldCByZWFsTWV0aG9kID0gbWV0aG9kO1xuICAgIGxldCByZWFsUGFyYW1zID0gcGFyYW1zO1xuICAgIGlmICh0aGlzLmlzVGFyZ2V0QmFzZWQpIHtcbiAgICAgIHJlYWxNZXRob2QgPSAnVGFyZ2V0LnNlbmRNZXNzYWdlVG9UYXJnZXQnO1xuICAgICAgcmVhbFBhcmFtcyA9IHtcbiAgICAgICAgdGFyZ2V0SWQsXG4gICAgICAgIG1lc3NhZ2U6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBpZCxcbiAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgcGFyYW1zLFxuICAgICAgICB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgcGxpc3QgPSB7XG4gICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgIFdJUlNvY2tldERhdGFLZXk6IHtcbiAgICAgICAgICBtZXRob2Q6IHJlYWxNZXRob2QsXG4gICAgICAgICAgcGFyYW1zOiByZWFsUGFyYW1zLFxuICAgICAgICB9LFxuICAgICAgICBXSVJDb25uZWN0aW9uSWRlbnRpZmllcktleTogY29ubklkLFxuICAgICAgICBXSVJTZW5kZXJLZXk6IHNlbmRlcklkLFxuICAgICAgICBXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk6IGFwcElkS2V5LFxuICAgICAgICBXSVJQYWdlSWRlbnRpZmllcktleTogcGFnZUlkS2V5LFxuICAgICAgfSxcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX2ZvcndhcmRTb2NrZXREYXRhOidcbiAgICB9O1xuICAgIHJldHVybiBfLm9taXRCeShwbGlzdCwgXy5pc05pbCk7XG4gIH1cblxuICBnZXREaXJlY3RDb21tYW5kIChvcHRzID0ge30pIHtcbiAgICBjb25zdCB7bWV0aG9kLCBwYXJhbXMsIGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIGlkfSA9IG9wdHM7XG5cbiAgICBjb25zdCBwbGlzdCA9IHtcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSU29ja2V0RGF0YUtleToge1xuICAgICAgICAgIGlkLFxuICAgICAgICAgIG1ldGhvZCxcbiAgICAgICAgICBwYXJhbXMsXG4gICAgICAgIH0sXG4gICAgICAgIFdJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5OiBjb25uSWQsXG4gICAgICAgIFdJUlNlbmRlcktleTogc2VuZGVySWQsXG4gICAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogYXBwSWRLZXksXG4gICAgICAgIFdJUlBhZ2VJZGVudGlmaWVyS2V5OiBwYWdlSWRLZXksXG4gICAgICB9LFxuICAgICAgX19zZWxlY3RvcjogJ19ycGNfZm9yd2FyZFNvY2tldERhdGE6J1xuICAgIH07XG4gICAgcmV0dXJuIF8ub21pdEJ5KHBsaXN0LCBfLmlzTmlsKTtcbiAgfVxuXG4gIGdldFJlbW90ZUNvbW1hbmQgKGNvbW1hbmQsIG9wdHMpIHtcbiAgICBjb25zdCB7XG4gICAgICBpZCxcbiAgICAgIGNvbm5JZCxcbiAgICAgIGFwcElkS2V5LFxuICAgICAgc2VuZGVySWQsXG4gICAgICBwYWdlSWRLZXksXG4gICAgICB0YXJnZXRJZCxcbiAgICB9ID0gb3B0cztcblxuICAgIC8vIGRlYWwgd2l0aCBTYWZhcmkgV2ViIEluc3BlY3RvciBjb21tYW5kc1xuICAgIHN3aXRjaCAoY29tbWFuZCkge1xuICAgICAgY2FzZSAnc2V0Q29ubmVjdGlvbktleSc6XG4gICAgICAgIHJldHVybiB0aGlzLnNldENvbm5lY3Rpb25LZXkoY29ubklkKTtcbiAgICAgIGNhc2UgJ2luZGljYXRlV2ViVmlldyc6XG4gICAgICAgIHJldHVybiB0aGlzLmluZGljYXRlV2ViVmlldyhjb25uSWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIG9wdHMuZW5hYmxlZCk7XG4gICAgICBjYXNlICdjb25uZWN0VG9BcHAnOlxuICAgICAgICByZXR1cm4gdGhpcy5jb25uZWN0VG9BcHAoY29ubklkLCBhcHBJZEtleSk7XG4gICAgICBjYXNlICdzZXRTZW5kZXJLZXknOlxuICAgICAgICByZXR1cm4gdGhpcy5zZXRTZW5kZXJLZXkoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSk7XG4gICAgICBjYXNlICdsYXVuY2hBcHBsaWNhdGlvbic6XG4gICAgICAgIHJldHVybiB0aGlzLmxhdW5jaEFwcGxpY2F0aW9uKG9wdHMuYnVuZGxlSWQpO1xuICAgIH1cblxuICAgIC8vIGRlYWwgd2l0aCBXZWJLaXQgY29tbWFuZHNcbiAgICBjb25zdCBidWlsZGVyRnVuY3Rpb24gPSBDT01NQU5EU1tjb21tYW5kXSB8fCBNSU5JTUFMX0NPTU1BTkQ7XG4gICAgcmV0dXJuIHRoaXNbYnVpbGRlckZ1bmN0aW9uXSh7XG4gICAgICAuLi5nZXRQcm90b2NvbENvbW1hbmQoaWQsIGNvbW1hbmQsIG9wdHMpLFxuICAgICAgY29ubklkLFxuICAgICAgYXBwSWRLZXksXG4gICAgICBzZW5kZXJJZCxcbiAgICAgIHBhZ2VJZEtleSxcbiAgICAgIHRhcmdldElkLFxuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCB7IFJlbW90ZU1lc3NhZ2VzIH07XG5leHBvcnQgZGVmYXVsdCBSZW1vdGVNZXNzYWdlcztcbiJdLCJmaWxlIjoibGliL3JwYy9yZW1vdGUtbWVzc2FnZXMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
