"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _child_process = _interopRequireDefault(require("child_process"));

var _logger = _interopRequireDefault(require("../logger"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const FEAT_FLAG = 'execute_driver_script';
const DEFAULT_SCRIPT_TIMEOUT = 1000 * 60 * 60;
const SCRIPT_TYPE_WDIO = 'webdriverio';
let commands = {};

commands.executeDriverScript = async function (script, scriptType = 'webdriverio', timeout = DEFAULT_SCRIPT_TIMEOUT) {
  if (!this.isFeatureEnabled(FEAT_FLAG)) {
    throw new Error(`Execute driver script functionality is not available ` + `unless server is started with --allow-insecure including ` + `the '${FEAT_FLAG}' flag, e.g., --allow-insecure=${FEAT_FLAG}`);
  }

  if (scriptType !== SCRIPT_TYPE_WDIO) {
    throw new Error(`Only the '${SCRIPT_TYPE_WDIO}' script type is currently supported`);
  }

  if (!this.opts.address || !this.opts.port) {
    throw new Error('Address or port of running server were not defined; this ' + 'is required. This is probably a programming error in the driver');
  }

  if (!_lodash.default.isNumber(timeout)) {
    throw new Error('Timeout parameter must be a number');
  }

  const driverOpts = {
    sessionId: this.sessionId,
    protocol: 'http',
    hostname: this.opts.address,
    port: this.opts.port,
    path: this.basePath,
    isW3C: this.isW3CProtocol(),
    isMobile: true,
    capabilities: this.caps
  };

  _logger.default.info(`Constructed webdriverio driver options; W3C mode is ${driverOpts.isW3C ? 'on' : 'off'}`);

  const childScript = _path.default.join(__dirname, 'execute-child.js');

  _logger.default.info(`Forking process to run webdriver script as child using ${childScript}`);

  const scriptProc = _child_process.default.fork(childScript);

  let timeoutCanceled = false;

  try {
    const timeoutStart = Date.now();

    const waitForResult = async function () {
      const resPromise = new _bluebird.default(res => {
        scriptProc.on('message', res);
      });
      const res = await resPromise;

      _logger.default.info('Received execute driver script result from child process, shutting it down');

      if (res.error) {
        throw new Error(res.error.message);
      }

      return res.success;
    };

    const waitForTimeout = async function () {
      while (!timeoutCanceled && Date.now() - timeoutStart < timeout) {
        await _bluebird.default.delay(500);
      }

      if (timeoutCanceled) {
        return;
      }

      throw new Error(`Execute driver script timed out after ${timeout}ms. ` + `You can adjust this with the 'timeout' parameter.`);
    };

    _logger.default.info('Sending driver and script data to child');

    scriptProc.send({
      driverOpts,
      script,
      timeout
    });
    return await _bluebird.default.race([waitForResult(), waitForTimeout()]);
  } catch (err) {
    throw new Error(`Could not execute driver script. Original error was: ${err}`);
  } finally {
    timeoutCanceled = true;

    _logger.default.info('Disconnecting from and killing driver script child proc');

    scriptProc.disconnect();
    scriptProc.kill();
  }
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL2V4ZWN1dGUuanMiXSwibmFtZXMiOlsiRkVBVF9GTEFHIiwiREVGQVVMVF9TQ1JJUFRfVElNRU9VVCIsIlNDUklQVF9UWVBFX1dESU8iLCJjb21tYW5kcyIsImV4ZWN1dGVEcml2ZXJTY3JpcHQiLCJzY3JpcHQiLCJzY3JpcHRUeXBlIiwidGltZW91dCIsImlzRmVhdHVyZUVuYWJsZWQiLCJFcnJvciIsIm9wdHMiLCJhZGRyZXNzIiwicG9ydCIsIl8iLCJpc051bWJlciIsImRyaXZlck9wdHMiLCJzZXNzaW9uSWQiLCJwcm90b2NvbCIsImhvc3RuYW1lIiwicGF0aCIsImJhc2VQYXRoIiwiaXNXM0MiLCJpc1czQ1Byb3RvY29sIiwiaXNNb2JpbGUiLCJjYXBhYmlsaXRpZXMiLCJjYXBzIiwibG9nIiwiaW5mbyIsImNoaWxkU2NyaXB0Iiwiam9pbiIsIl9fZGlybmFtZSIsInNjcmlwdFByb2MiLCJjcCIsImZvcmsiLCJ0aW1lb3V0Q2FuY2VsZWQiLCJ0aW1lb3V0U3RhcnQiLCJEYXRlIiwibm93Iiwid2FpdEZvclJlc3VsdCIsInJlc1Byb21pc2UiLCJCIiwicmVzIiwib24iLCJlcnJvciIsIm1lc3NhZ2UiLCJzdWNjZXNzIiwid2FpdEZvclRpbWVvdXQiLCJkZWxheSIsInNlbmQiLCJyYWNlIiwiZXJyIiwiZGlzY29ubmVjdCIsImtpbGwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsU0FBUyxHQUFHLHVCQUFsQjtBQUNBLE1BQU1DLHNCQUFzQixHQUFHLE9BQU8sRUFBUCxHQUFZLEVBQTNDO0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsYUFBekI7QUFHQSxJQUFJQyxRQUFRLEdBQUcsRUFBZjs7QUFjQUEsUUFBUSxDQUFDQyxtQkFBVCxHQUErQixnQkFBZ0JDLE1BQWhCLEVBQXdCQyxVQUFVLEdBQUcsYUFBckMsRUFDN0JDLE9BQU8sR0FBR04s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QUFBQSxNQUFiO0FBQXFCRSxNQUFBQTtBQUFyQixLQUFoQjtBQUdBLFdBQU8sTUFBTWlDLGtCQUFFUyxJQUFGLENBQU8sQ0FBQ1gsYUFBYSxFQUFkLEVBQWtCUSxjQUFjLEVBQWhDLENBQVAsQ0FBYjtBQUNELEdBMUNELENBMENFLE9BQU9JLEdBQVAsRUFBWTtBQUNaLFVBQU0sSUFBSXpDLEtBQUosQ0FBVyx3REFBdUR5QyxHQUFJLEVBQXRFLENBQU47QUFDRCxHQTVDRCxTQTRDVTtBQUdSaEIsSUFBQUEsZUFBZSxHQUFHLElBQWxCOztBQUVBUixvQkFBSUMsSUFBSixDQUFTLHlEQUFUOztBQUNBSSxJQUFBQSxVQUFVLENBQUNvQixVQUFYO0FBQ0FwQixJQUFBQSxVQUFVLENBQUNxQixJQUFYO0FBQ0Q7QUFDRixDQWpHRDs7ZUFvR2VqRCxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGNwIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5jb25zdCBGRUFUX0ZMQUcgPSAnZXhlY3V0ZV9kcml2ZXJfc2NyaXB0JztcbmNvbnN0IERFRkFVTFRfU0NSSVBUX1RJTUVPVVQgPSAxMDAwICogNjAgKiA2MDsgLy8gZGVmYXVsdCB0byAxIGhvdXIgdGltZW91dFxuY29uc3QgU0NSSVBUX1RZUEVfV0RJTyA9ICd3ZWJkcml2ZXJpbyc7XG4vLyBUT0RPIGFkZCB3ZCBzY3JpcHQgdHlwZSBhdCBzb21lIHBvaW50XG5cbmxldCBjb21tYW5kcyA9IHt9O1xuXG4vKipcbiAqIFRoaXMgbWV0aG9kIHRha2VzIGEgc3RyaW5nIHdoaWNoIGlzIGV4ZWN1dGVkIGFzIGphdmFzY3JpcHQgaW4gdGhlIGNvbnRleHQgb2ZcbiAqIGEgbmV3IG5vZGVqcyBWTSwgYW5kIHdoaWNoIGhhcyBhdmFpbGFibGUgYSB3ZWJkcml2ZXJpbyBkcml2ZXIgb2JqZWN0LCBoYXZpbmdcbiAqIGFscmVhZHkgYmVlbiBhdHRhY2hlZCB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgc2Vzc2lvbi5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gc2NyaXB0IC0gdGhlIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIGRyaXZlciBzY3JpcHQgdG8gcnVuXG4gKiBAcGFyYW0ge3N0cmluZ30gW3NjcmlwdFR5cGU9J3dlYmRyaXZlcmlvJ10gLSB0aGUgbmFtZSBvZiB0aGUgZHJpdmVyIHNjcmlwdFxuICogbGlicmFyeSAoY3VycmVudGx5IG9ubHkgd2ViZHJpdmVyaW8gaXMgc3VwcG9ydGVkKVxuICpcbiAqIEByZXR1cm5zIHtPYmplY3R9IC0gYSBKU09OaWZpYWJsZSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByZXR1cm4gdmFsdWUgb2ZcbiAqIHRoZSBzY3JpcHRcbiAqL1xuY29tbWFuZHMuZXhlY3V0ZURyaXZlclNjcmlwdCA9IGFzeW5jIGZ1bmN0aW9uIChzY3JpcHQsIHNjcmlwdFR5cGUgPSAnd2ViZHJpdmVyaW8nLFxuICB0aW1lb3V0ID0gREVGQVVMVF9TQ1JJUFRfVElNRU9VVCkge1xuXG4gIGlmICghdGhpcy5pc0ZlYXR1cmVFbmFibGVkKEZFQVRfRkxBRykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEV4ZWN1dGUgZHJpdmVyIHNjcmlwdCBmdW5jdGlvbmFsaXR5IGlzIG5vdCBhdmFpbGFibGUgYCArXG4gICAgICAgICAgICAgICAgICAgIGB1bmxlc3Mgc2VydmVyIGlzIHN0YXJ0ZWQgd2l0aCAtLWFsbG93LWluc2VjdXJlIGluY2x1ZGluZyBgICtcbiAgICAgICAgICAgICAgICAgICAgYHRoZSAnJHtGRUFUX0ZMQUd9JyBmbGFnLCBlLmcuLCAtLWFsbG93LWluc2VjdXJlPSR7RkVBVF9GTEFHfWApO1xuICB9XG5cbiAgaWYgKHNjcmlwdFR5cGUgIT09IFNDUklQVF9UWVBFX1dESU8pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYE9ubHkgdGhlICcke1NDUklQVF9UWVBFX1dESU99JyBzY3JpcHQgdHlwZSBpcyBjdXJyZW50bHkgc3VwcG9ydGVkYCk7XG4gIH1cblxuICBpZiAoIXRoaXMub3B0cy5hZGRyZXNzIHx8ICF0aGlzLm9wdHMucG9ydCkge1xuICAgIHRocm93IG5ldyBFcnJvcignQWRkcmVzcyBvciBwb3J0IG9mIHJ1bm5pbmcgc2VydmVyIHdlcmUgbm90IGRlZmluZWQ7IHRoaXMgJyArXG4gICAgICAgICAgICAgICAgICAgICdpcyByZXF1aXJlZC4gVGhpcyBpcyBwcm9iYWJseSBhIHByb2dyYW1taW5nIGVycm9yIGluIHRoZSBkcml2ZXInKTtcbiAgfVxuXG4gIGlmICghXy5pc051bWJlcih0aW1lb3V0KSkge1xuICAgIHRocm93IG5ldyBFcnJvcignVGltZW91dCBwYXJhbWV0ZXIgbXVzdCBiZSBhIG51bWJlcicpO1xuICB9XG5cbiAgY29uc3QgZHJpdmVyT3B0cyA9IHtcbiAgICBzZXNzaW9uSWQ6IHRoaXMuc2Vzc2lvbklkLFxuICAgIHByb3RvY29sOiAnaHR0cCcsIC8vIEFwcGl1bSB3b24ndCBldmVyIGJlIGJlaGluZCBzc2wgbG9jYWxseVxuICAgIGhvc3RuYW1lOiB0aGlzLm9wdHMuYWRkcmVzcyxcbiAgICBwb3J0OiB0aGlzLm9wdHMucG9ydCxcbiAgICBwYXRoOiB0aGlzLmJhc2VQYXRoLFxuICAgIGlzVzNDOiB0aGlzLmlzVzNDUHJvdG9jb2woKSxcbiAgICBpc01vYmlsZTogdHJ1ZSxcbiAgICBjYXBhYmlsaXRpZXM6IHRoaXMuY2Fwc1xuICB9O1xuICBsb2cuaW5mbyhgQ29uc3RydWN0ZWQgd2ViZHJpdmVyaW8gZHJpdmVyIG9wdGlvbnM7IFczQyBtb2RlIGlzICR7ZHJpdmVyT3B0cy5pc1czQyA/ICdvbicgOiAnb2ZmJ31gKTtcblxuXG4gIC8vIGZvcmsgdGhlIGV4ZWN1dGlvbiBzY3JpcHQgYXMgYSBjaGlsZCBwcm9jZXNzXG4gIGNvbnN0IGNoaWxkU2NyaXB0ID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ2V4ZWN1dGUtY2hpbGQuanMnKTtcbiAgbG9nLmluZm8oYEZvcmtpbmcgcHJvY2VzcyB0byBydW4gd2ViZHJpdmVyIHNjcmlwdCBhcyBjaGlsZCB1c2luZyAke2NoaWxkU2NyaXB0fWApO1xuICBjb25zdCBzY3JpcHRQcm9jID0gY3AuZm9yayhjaGlsZFNjcmlwdCk7XG5cbiAgLy8ga2VlcCB0cmFjayBvZiB3aGV0aGVyIHdlIGhhdmUgY2FuY2VsZWQgdGhlIHNjcmlwdCB0aW1lb3V0LCBzbyB3ZSBjYW4gc3RvcFxuICAvLyB3YWl0aW5nIGZvciBpdCBhbmQgYWxsb3cgdGhpcyBwcm9jZXNzIHRvIGZpbmlzaCBncmFjZWZ1bGx5XG4gIGxldCB0aW1lb3V0Q2FuY2VsZWQgPSBmYWxzZTtcblxuICB0cnkge1xuICAgIGNvbnN0IHRpbWVvdXRTdGFydCA9IERhdGUubm93KCk7XG5cbiAgICAvLyBwcm9taXNlIHRoYXQgZGVhbHMgd2l0aCB0aGUgcmVzdWx0IGZyb20gdGhlIGNoaWxkIHByb2Nlc3NcbiAgICBjb25zdCB3YWl0Rm9yUmVzdWx0ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3QgcmVzUHJvbWlzZSA9IG5ldyBCKChyZXMpID0+IHtcbiAgICAgICAgc2NyaXB0UHJvYy5vbignbWVzc2FnZScsIHJlcyk7IC8vIHRoaXMgaXMgbm9kZSBJUENcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXMgPSBhd2FpdCByZXNQcm9taXNlO1xuICAgICAgbG9nLmluZm8oJ1JlY2VpdmVkIGV4ZWN1dGUgZHJpdmVyIHNjcmlwdCByZXN1bHQgZnJvbSBjaGlsZCBwcm9jZXNzLCBzaHV0dGluZyBpdCBkb3duJyk7XG5cbiAgICAgIGlmIChyZXMuZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlcy5lcnJvci5tZXNzYWdlKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlcy5zdWNjZXNzO1xuICAgIH07XG5cbiAgICAvLyBwcm9taXNlIHRoYXQgd2FpdHMgdXAgdG8gdGhlIHRpbWVvdXQgYW5kIHRocm93cyBhbiBlcnJvciBpZiBzbywgb3IgZG9lc1xuICAgIC8vIG5vdGhpbmcgaWYgdGhlIHRpbWVvdXQgaXMgY2FuY2VsZWQgYmVjYXVzZSB3ZSBnb3QgYSByZXN1bHQgZnJvbSB0aGVcbiAgICAvLyBjaGlsZCBzY3JpcHRcbiAgICBjb25zdCB3YWl0Rm9yVGltZW91dCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIHdoaWxlICghdGltZW91dENhbmNlbGVkICYmIChEYXRlLm5vdygpIC0gdGltZW91dFN0YXJ0KSA8IHRpbWVvdXQpIHtcbiAgICAgICAgYXdhaXQgQi5kZWxheSg1MDApO1xuICAgICAgfVxuXG4gICAgICBpZiAodGltZW91dENhbmNlbGVkKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBFeGVjdXRlIGRyaXZlciBzY3JpcHQgdGltZWQgb3V0IGFmdGVyICR7dGltZW91dH1tcy4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgYFlvdSBjYW4gYWRqdXN0IHRoaXMgd2l0aCB0aGUgJ3RpbWVvdXQnIHBhcmFtZXRlci5gKTtcbiAgICB9O1xuXG4gICAgLy8gbm93IHRoYXQgdGhlIGNoaWxkIHNjcmlwdCBpcyBhbGl2ZSwgc2VuZCBpdCB0aGUgZGF0YSBpdCBuZWVkcyB0byBzdGFydFxuICAgIC8vIHJ1bm5pbmcgdGhlIGRyaXZlciBzY3JpcHRcbiAgICBsb2cuaW5mbygnU2VuZGluZyBkcml2ZXIgYW5kIHNjcmlwdCBkYXRhIHRvIGNoaWxkJyk7XG4gICAgc2NyaXB0UHJvYy5zZW5kKHtkcml2ZXJPcHRzLCBzY3JpcHQsIHRpbWVvdXR9KTtcblxuICAgIC8vIGFuZCBzZXQgdXAgYSByYWNlIGJldHdlZW4gdGhlIHJlc3BvbnNlIGZyb20gdGhlIGNoaWxkIGFuZCB0aGUgdGltZW91dFxuICAgIHJldHVybiBhd2FpdCBCLnJhY2UoW3dhaXRGb3JSZXN1bHQoKSwgd2FpdEZvclRpbWVvdXQoKV0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBleGVjdXRlIGRyaXZlciBzY3JpcHQuIE9yaWdpbmFsIGVycm9yIHdhczogJHtlcnJ9YCk7XG4gIH0gZmluYWxseSB7XG4gICAgLy8gZW5zdXJlIHdlIGFsd2F5cyBjYW5jZWwgdGhlIHRpbWVvdXQgc28gdGhhdCB0aGUgdGltZW91dCBwcm9taXNlIHN0b3BzXG4gICAgLy8gc3Bpbm5pbmcgYW5kIGFsbG93cyB0aGlzIHByb2Nlc3MgdG8gZGllIGdyYWNlZnVsbHlcbiAgICB0aW1lb3V0Q2FuY2VsZWQgPSB0cnVlO1xuXG4gICAgbG9nLmluZm8oJ0Rpc2Nvbm5lY3RpbmcgZnJvbSBhbmQga2lsbGluZyBkcml2ZXIgc2NyaXB0IGNoaWxkIHByb2MnKTtcbiAgICBzY3JpcHRQcm9jLmRpc2Nvbm5lY3QoKTtcbiAgICBzY3JpcHRQcm9jLmtpbGwoKTtcbiAgfVxufTtcblxuXG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2Jhc2Vkcml2ZXIvY29tbWFuZHMvZXhlY3V0ZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLiJ9
