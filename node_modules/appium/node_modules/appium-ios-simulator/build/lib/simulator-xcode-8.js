"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _simulatorXcode = require("./simulator-xcode-6");

var _simulatorXcode2 = _interopRequireDefault(require("./simulator-xcode-7"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

var _teen_process = require("teen_process");

var _geolocation = require("./geolocation");

var _appiumSupport = require("appium-support");

var _utils = require("./utils");

const STARTUP_TIMEOUT = 120 * 1000;

const PROCESS_LAUNCH_OK_PATTERN = bundleId => new RegExp(`${bundleId.replace('.', '\\.')}:\\s+\\d+`);

class SimulatorXcode8 extends _simulatorXcode2.default {
  constructor(udid, xcodeVersion) {
    super(udid, xcodeVersion);
    this.isFreshFiles = ['Library/Cookies', 'Library/Preferences/.GlobalPreferences.plist', 'Library/Preferences/com.apple.springboard.plist', 'var/run/syslog.pid'];
    this._idb = null;
    this._locationMenu = 'Debug';
  }

  set idb(value) {
    this._idb = value;
  }

  get idb() {
    return this._idb;
  }

  async killUIClient(opts = {}) {
    let {
      pid,
      signal = 2
    } = opts;
    pid = pid || (await this.getUIClientPid());

    if (!pid) {
      return false;
    }

    _logger.default.debug(`Sending ${signal} kill signal to Simulator UI client with PID ${pid}`);

    try {
      await (0, _teen_process.exec)('kill', [`-${signal}`, pid]);
      return true;
    } catch (e) {
      if (e.code === 1) {
        return false;
      }

      throw new Error(`Cannot kill the Simulator UI client. Original error: ${e.message}`);
    }
  }

  async isAppInstalled(bundleId) {
    try {
      const appContainer = await this.simctl.getAppContainer(bundleId);
      return appContainer.endsWith('.app');
    } catch (err) {
      try {
        const info = await this.simctl.appInfo(bundleId);
        return info.includes('ApplicationType');
      } catch (e) {
        return false;
      }
    }
  }

  get startupTimeout() {
    return STARTUP_TIMEOUT;
  }

  async waitForBoot(startupTimeout) {
    await this.simctl.startBootMonitor({
      timeout: startupTimeout
    });
    this.emit(_simulatorXcode.BOOT_COMPLETED_EVENT);
  }

  async openUrl(url) {
    if (!(await this.isRunning())) {
      throw new Error(`Tried to open '${url}', but Simulator is not in Booted state`);
    }

    const timer = new _appiumSupport.timing.Timer().start();
    let lastError = null;

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        try {
          const stdout = await this.simctl.launchApp(_utils.MOBILE_SAFARI_BUNDLE_ID);

          if (PROCESS_LAUNCH_OK_PATTERN(_utils.MOBILE_SAFARI_BUNDLE_ID).test(stdout)) {
            await this.simctl.openUrl(url);
            return true;
          }
        } catch (err) {
          _logger.default.warn(`Failed to open '${url}' in Safari. Retrying...`);

          lastError = err.stderr || err.message;
        }

        return false;
      }, {
        waitMs: _utils.SAFARI_STARTUP_TIMEOUT,
        intervalMs: 500
      });
    } catch (err) {
      throw new Error(`Safari cannot open '${url}' after ${timer.getDuration().asSeconds.toFixed(3)}s ` + `because of: ${lastError || 'an unknown error'}`);
    }

    _logger.default.debug(`Safari successfully opened '${url}' in ${timer.getDuration().asSeconds.toFixed(3)}s`);
  }

  async cleanSafari(keepPrefs = true) {
    try {
      if (await this.isRunning()) {
        await this.simctl.terminateApp(_utils.MOBILE_SAFARI_BUNDLE_ID);
      }
    } catch (ign) {}

    await super.cleanSafari(keepPrefs);
  }

  async cleanCustomApp(appFile, appBundleId, scrub = false) {
    try {
      await this.simctl.terminateApp(appBundleId);
    } catch (ign) {}

    await super.cleanCustomApp(appFile, appBundleId, scrub);
  }

  async shake() {
    _logger.default.info(`Performing shake gesture on ${this.udid} Simulator`);

    await this.simctl.spawnProcess(['notifyutil', '-p', 'com.apple.UIKit.SimulatorShake']);
  }

  async isBiometricEnrolled() {
    const output = await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "Toggle Enrolled State" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"
        end tell
      end tell
    `);

    _logger.default.debug(`Touch ID enrolled state: ${output}`);

    return _lodash.default.isString(output) && output.trim() === 'true';
  }

  async enrollBiometric(isEnabled = true) {
    await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "Toggle Enrolled State" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"
          if ${isEnabled ? 'not ' : ''}isChecked then
            click dstMenuItem
          end if
        end tell
      end tell
    `);
  }

  async sendBiometricMatch(shouldMatch = true) {
    await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "${shouldMatch ? 'Matching Touch' : 'Non-matching Touch'}" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          click dstMenuItem
        end tell
      end tell
    `);
  }

  async setGeolocation(latitude, longitude) {
    const locationSetters = [async () => await (0, _geolocation.setLocationWithLyft)(this.udid, latitude, longitude), async () => await (0, _geolocation.setLocationWithIdb)(this.idb, latitude, longitude), async () => await (0, _geolocation.setLocationWithAppleScript)(this, latitude, longitude, this._locationMenu)];
    let lastError;

    for (const setter of locationSetters) {
      try {
        await setter();
        return true;
      } catch (e) {
        _logger.default.info(e.message);

        lastError = e;
      }
    }

    throw lastError;
  }

}

var _default = SimulatorXcode8;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOC5qcyJdLCJuYW1lcyI6WyJTVEFSVFVQX1RJTUVPVVQiLCJQUk9DRVNTX0xBVU5DSF9PS19QQVRURVJOIiwiYnVuZGxlSWQiLCJSZWdFeHAiLCJyZXBsYWNlIiwiU2ltdWxhdG9yWGNvZGU4IiwiU2ltdWxhdG9yWGNvZGU3IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwieGNvZGVWZXJzaW9uIiwiaXNGcmVzaEZpbGVzIiwiX2lkYiIsIl9sb2NhdGlvbk1lbnUiLCJpZGIiLCJ2YWx1ZSIsImtpbGxVSUNsaWVudCIsIm9wdHMiLCJwaWQiLCJzaWduYWwiLCJnZXRVSUNsaWVudFBpZCIsImxvZyIsImRlYnVnIiwiZSIsImNvZGUiLCJFcnJvciIsIm1lc3NhZ2UiLCJpc0FwcEluc3RhbGxlZCIsImFwcENvbnRhaW5lciIsInNpbWN0bCIsImdldEFwcENvbnRhaW5lciIsImVuZHNXaXRoIiwiZXJyIiwiaW5mbyIsImFwcEluZm8iLCJpbmNsdWRlcyIsInN0YXJ0dXBUaW1lb3V0Iiwid2FpdEZvckJvb3QiLCJzdGFydEJvb3RNb25pdG9yIiwidGltZW91dCIsImVtaXQiLCJCT09UX0NPTVBMRVRFRF9FVkVOVCIsIm9wZW5VcmwiLCJ1cmwiLCJpc1J1bm5pbmciLCJ0aW1lciIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJsYXN0RXJyb3IiLCJzdGRvdXQiLCJsYXVuY2hBcHAiLCJNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRCIsInRlc3QiLCJ3YXJuIiwic3RkZXJyIiwid2FpdE1zIiwiU0FGQVJJX1NUQVJUVVBfVElNRU9VVCIsImludGVydmFsTXMiLCJnZXREdXJhdGlvbiIsImFzU2Vjb25kcyIsInRvRml4ZWQiLCJjbGVhblNhZmFyaSIsImtlZXBQcmVmcyIsInRlcm1pbmF0ZUFwcCIsImlnbiIsImNsZWFuQ3VzdG9tQXBwIiwiYXBwRmlsZSIsImFwcEJ1bmRsZUlkIiwic2NydWIiLCJzaGFrZSIsInNwYXduUHJvY2VzcyIsImlzQmlvbWV0cmljRW5yb2xsZWQiLCJvdXRwdXQiLCJleGVjdXRlVUlDbGllbnRTY3JpcHQiLCJfIiwiaXNTdHJpbmciLCJ0cmltIiwiZW5yb2xsQmlvbWV0cmljIiwiaXNFbmFibGVkIiwic2VuZEJpb21ldHJpY01hdGNoIiwic2hvdWxkTWF0Y2giLCJzZXRHZW9sb2NhdGlvbiIsImxhdGl0dWRlIiwibG9uZ2l0dWRlIiwibG9jYXRpb25TZXR0ZXJzIiwic2V0dGVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUlBOztBQUNBOztBQUlBLE1BQU1BLGVBQWUsR0FBRyxNQUFNLElBQTlCOztBQUNBLE1BQU1DLHlCQUF5QixHQUFJQyxRQUFELElBQWMsSUFBSUMsTUFBSixDQUFZLEdBQUVELFFBQVEsQ0FBQ0UsT0FBVCxDQUFpQixHQUFqQixFQUFzQixLQUF0QixDQUE2QixXQUEzQyxDQUFoRDs7QUFFQSxNQUFNQyxlQUFOLFNBQThCQyx3QkFBOUIsQ0FBOEM7QUFDNUNDLEVBQUFBLFdBQVcsQ0FBRUMsSUFBRixFQUFRQyxZQUFSLEVBQXNCO0FBQy9CLFVBQU1ELElBQU4sRUFBWUMsWUFBWjtBQUtBLFNBQUtDLFlBQUwsR0FBb0IsQ0FDbEIsaUJBRGtCLEVBRWxCLDhDQUZrQixFQUdsQixpREFIa0IsRUFJbEIsb0JBSmtCLENBQXBCO0FBTUEsU0FBS0MsSUFBTCxHQUFZLElBQVo7QUFJQSxTQUFLQyxhQUFMLEdBQXFCLE9BQXJCO0FBQ0Q7O0FBT00sTUFBSEMsR0FBRyxDQUFFQyxLQUFGLEVBQVM7QUFDZCxTQUFLSCxJQUFMLEdBQVlHLEtBQVo7QUFDRDs7QUFLTSxNQUFIRCxHQUFHLEdBQUk7QUFDVCxXQUFPLEtBQUtGLElBQVo7QUFDRDs7QUFpQmlCLFFBQVpJLFlBQVksQ0FBRUMsSUFBSSxHQUFHLEVBQVQsRUFBYTtBQUM3QixRQUFJO0FBQ0ZDLE1BQUFBLEdBREU7QUFFRkMsTUFBQUEsTUFBTSxHQUFHO0FBRlAsUUFHQUYs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cEMsVUFBSTtBQUNGLGNBQU1DLE1BQU0sRUFBWjtBQUNBLGVBQU8sSUFBUDtBQUNELE9BSEQsQ0FHRSxPQUFPL0QsQ0FBUCxFQUFVO0FBQ1ZGLHdCQUFJWSxJQUFKLENBQVNWLENBQUMsQ0FBQ0csT0FBWDs7QUFDQXVCLFFBQUFBLFNBQVMsR0FBRzFCLENBQVo7QUFDRDtBQUNGOztBQUNELFVBQU0wQixTQUFOO0FBQ0Q7O0FBclIyQzs7ZUF3Ui9CM0MsZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJPT1RfQ09NUExFVEVEX0VWRU5UIH0gZnJvbSAnLi9zaW11bGF0b3IteGNvZGUtNic7XG5pbXBvcnQgU2ltdWxhdG9yWGNvZGU3IGZyb20gJy4vc2ltdWxhdG9yLXhjb2RlLTcnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHtcbiAgc2V0TG9jYXRpb25XaXRoTHlmdCxcbiAgc2V0TG9jYXRpb25XaXRoSWRiLFxuICBzZXRMb2NhdGlvbldpdGhBcHBsZVNjcmlwdCB9IGZyb20gJy4vZ2VvbG9jYXRpb24nO1xuaW1wb3J0IHsgdGltaW5nIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQsIFNBRkFSSV9TVEFSVFVQX1RJTUVPVVQgfSBmcm9tICcuL3V0aWxzJztcblxuXG4vLyB0aGVzZSBzaW1zIGFyZSBzbG9vb29vb29vd1xuY29uc3QgU1RBUlRVUF9USU1FT1VUID0gMTIwICogMTAwMDtcbmNvbnN0IFBST0NFU1NfTEFVTkNIX09LX1BBVFRFUk4gPSAoYnVuZGxlSWQpID0+IG5ldyBSZWdFeHAoYCR7YnVuZGxlSWQucmVwbGFjZSgnLicsICdcXFxcLicpfTpcXFxccytcXFxcZCtgKTtcblxuY2xhc3MgU2ltdWxhdG9yWGNvZGU4IGV4dGVuZHMgU2ltdWxhdG9yWGNvZGU3IHtcbiAgY29uc3RydWN0b3IgKHVkaWQsIHhjb2RlVmVyc2lvbikge1xuICAgIHN1cGVyKHVkaWQsIHhjb2RlVmVyc2lvbik7XG5cbiAgICAvLyBsaXN0IG9mIGZpbGVzIHRvIGNoZWNrIGZvciB3aGVuIHNlZWluZyBpZiBhIHNpbXVsYXRvciBpcyBcImZyZXNoXCJcbiAgICAvLyAobWVhbmluZyBpdCBoYXMgbmV2ZXIgYmVlbiBib290ZWQpLlxuICAgIC8vIElmIHRoZXNlIGZpbGVzIGFyZSBwcmVzZW50LCB3ZSBhc3N1bWUgaXQncyBiZWVuIHN1Y2Nlc3NmdWxseSBib290ZWRcbiAgICB0aGlzLmlzRnJlc2hGaWxlcyA9IFtcbiAgICAgICdMaWJyYXJ5L0Nvb2tpZXMnLFxuICAgICAgJ0xpYnJhcnkvUHJlZmVyZW5jZXMvLkdsb2JhbFByZWZlcmVuY2VzLnBsaXN0JyxcbiAgICAgICdMaWJyYXJ5L1ByZWZlcmVuY2VzL2NvbS5hcHBsZS5zcHJpbmdib2FyZC5wbGlzdCcsXG4gICAgICAndmFyL3J1bi9zeXNsb2cucGlkJ1xuICAgIF07XG4gICAgdGhpcy5faWRiID0gbnVsbDtcblxuICAgIC8vIGZvciBzZXR0aW5nIHRoZSBsb2NhdGlvbiB1c2luZyBBcHBsZVNjcmlwdCwgdGhlIHRvcC1sZXZlbCBtZW51IHRocm91Z2ggd2hpY2hcbiAgICAvLyB0aGUgJ0xvY2F0aW9uJyBvcHRpb24gaXMgZm91bmRcbiAgICB0aGlzLl9sb2NhdGlvbk1lbnUgPSAnRGVidWcnO1xuICB9XG5cbiAgLyoqXG4gICAqIElEQiBpbnN0YW5jZSBzZXR0ZXJcbiAgICpcbiAgICogQHBhcmFtIHtJREJ9IHZhbHVlXG4gICAqL1xuICBzZXQgaWRiICh2YWx1ZSkge1xuICAgIHRoaXMuX2lkYiA9IHZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm4ge0lEQn0gaWRiIGluc3RhbmNlXG4gICAqL1xuICBnZXQgaWRiICgpIHtcbiAgICByZXR1cm4gdGhpcy5faWRiO1xuICB9XG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IGtpbGxPcHRzXG4gICAqIEBwcm9wZXJ0eSB7P251bWJlcnxzdHJpbmd9IHBpZCAtIFByb2Nlc3MgaWQgb2YgdGhlIFVJIFNpbXVsYXRvciB3aW5kb3dcbiAgICogQHByb3BlcnR5IHtudW1iZXJ8c3RyaW5nfSBzaWduYWwgWzJdIC0gVGhlIHNpZ25hbCBudW1iZXIgdG8gc2VuZCB0byB0aGVcbiAgICogYGtpbGxgIGNvbW1hbmRcbiAgICovXG5cbiAgLyoqXG4gICAqIEtpbGwgdGhlIFVJIGNsaWVudCBpZiBpdCBpcyBydW5uaW5nLlxuICAgKlxuICAgKiBAcGFyYW0gez9raWxsT3B0c30gb3B0c1xuICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBVSSBjbGllbnQgd2FzIHN1Y2Nlc3NmdWxseSBraWxsZWQgb3IgZmFsc2VcbiAgICogICAgICAgICAgICAgICAgICAgaWYgaXQgaXMgbm90IHJ1bm5pbmcuXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzZW5kaW5nIHRoZSBzaWduYWwgdG8gdGhlIGNsaWVudCBwcm9jZXNzIGZhaWxzXG4gICAqL1xuICBhc3luYyBraWxsVUlDbGllbnQgKG9wdHMgPSB7fSkge1xuICAgIGxldCB7XG4gICAgICBwaWQsXG4gICAgICBzaWduYWwgPSAyLFxuICAgIH0gPSBvcHRzO1xuICAgIHBpZCA9IHBpZCB8fCBhd2FpdCB0aGlzLmdldFVJQ2xpZW50UGlkKCk7XG4gICAgaWYgKCFwaWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYFNlbmRpbmcgJHtzaWduYWx9IGtpbGwgc2lnbmFsIHRvIFNpbXVsYXRvciBVSSBjbGllbnQgd2l0aCBQSUQgJHtwaWR9YCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWMoJ2tpbGwnLCBbYC0ke3NpZ25hbH1gLCBwaWRdKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlLmNvZGUgPT09IDEpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3Qga2lsbCB0aGUgU2ltdWxhdG9yIFVJIGNsaWVudC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZnkgd2hldGhlciB0aGUgcGFydGljdWxhciBhcHBsaWNhdGlvbiBpcyBpbnN0YWxsZWQgb24gU2ltdWxhdG9yLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZUlkIC0gVGhlIGJ1bmRsZSBpZCBvZiB0aGUgYXBwbGljYXRpb24gdG8gYmUgY2hlY2tlZC5cbiAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gYXBwbGljYXRpb24gaXMgaW5zdGFsbGVkLlxuICAgKi9cbiAgYXN5bmMgaXNBcHBJbnN0YWxsZWQgKGJ1bmRsZUlkKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGFwcENvbnRhaW5lciA9IGF3YWl0IHRoaXMuc2ltY3RsLmdldEFwcENvbnRhaW5lcihidW5kbGVJZCk7XG4gICAgICByZXR1cm4gYXBwQ29udGFpbmVyLmVuZHNXaXRoKCcuYXBwJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBnZXRfYXBwX2NvbnRhaW5lciBzdWJjb21tYW5kIGZhaWxzIGZvciBzeXN0ZW0gYXBwbGljYXRpb25zLFxuICAgICAgLy8gc28gd2UgdHJ5IHRoZSBoaWRkZW4gYXBwaW5mbyBzdWJjb21tYW5kLCB3aGljaCBwcmludHMgY29ycmVjdCBpbmZvIGZvclxuICAgICAgLy8gc3lzdGVtL2hpZGRlbiBhcHBzXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBpbmZvID0gYXdhaXQgdGhpcy5zaW1jdGwuYXBwSW5mbyhidW5kbGVJZCk7XG4gICAgICAgIHJldHVybiBpbmZvLmluY2x1ZGVzKCdBcHBsaWNhdGlvblR5cGUnKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBtYXggbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IHVudGlsIFNpbXVsYXRvciBib290aW5nIGlzIGNvbXBsZXRlZC5cbiAgICovXG4gIGdldCBzdGFydHVwVGltZW91dCAoKSB7XG4gICAgcmV0dXJuIFNUQVJUVVBfVElNRU9VVDtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZnkgd2hldGhlciB0aGUgU2ltdWxhdG9yIGJvb3RpbmcgaXMgY29tcGxldGVkIGFuZC9vciB3YWl0IGZvciBpdFxuICAgKiB1bnRpbCB0aGUgdGltZW91dCBleHBpcmVzLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0dXBUaW1lb3V0IC0gdGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbCBib290aW5nIGlzIGNvbXBsZXRlZC5cbiAgICogQGVtaXRzIEJPT1RfQ09NUExFVEVEX0VWRU5UIGlmIHRoZSBjdXJyZW50IFNpbXVsYXRvciBpcyByZWFkeSB0byBhY2NlcHQgc2ltY3RsIGNvbW1hbmRzLCBsaWtlICdpbnN0YWxsJy5cbiAgICovXG4gIGFzeW5jIHdhaXRGb3JCb290IChzdGFydHVwVGltZW91dCkge1xuICAgIGF3YWl0IHRoaXMuc2ltY3RsLnN0YXJ0Qm9vdE1vbml0b3Ioe3RpbWVvdXQ6IHN0YXJ0dXBUaW1lb3V0fSk7XG4gICAgdGhpcy5lbWl0KEJPT1RfQ09NUExFVEVEX0VWRU5UKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVuIHRoZSBnaXZlbiBVUkwgaW4gbW9iaWxlIFNhZmFyaSBicm93c2VyLlxuICAgKiBUaGUgYnJvd3NlciB3aWxsIGJlIHN0YXJ0ZWQgYXV0b21hdGljYWxseSBpZiBpdCBpcyBub3QgcnVubmluZy5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBUaGUgVVJMIHRvIGJlIG9wZW5lZC5cbiAgICovXG4gIGFzeW5jIG9wZW5VcmwgKHVybCkge1xuICAgIGlmICghYXdhaXQgdGhpcy5pc1J1bm5pbmcoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcmllZCB0byBvcGVuICcke3VybH0nLCBidXQgU2ltdWxhdG9yIGlzIG5vdCBpbiBCb290ZWQgc3RhdGVgKTtcbiAgICB9XG4gICAgY29uc3QgdGltZXIgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcbiAgICBsZXQgbGFzdEVycm9yID0gbnVsbDtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgLy8gVGhpcyBpcyB0byBtYWtlIHN1cmUgU2FmYXJpIGlzIGFscmVhZHkgcnVubmluZ1xuICAgICAgICAgIGNvbnN0IHN0ZG91dCA9IGF3YWl0IHRoaXMuc2ltY3RsLmxhdW5jaEFwcChNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRCk7XG4gICAgICAgICAgaWYgKFBST0NFU1NfTEFVTkNIX09LX1BBVFRFUk4oTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQpLnRlc3Qoc3Rkb3V0KSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5zaW1jdGwub3BlblVybCh1cmwpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBsb2cud2FybihgRmFpbGVkIHRvIG9wZW4gJyR7dXJsfScgaW4gU2FmYXJpLiBSZXRyeWluZy4uLmApO1xuICAgICAgICAgIGxhc3RFcnJvciA9IGVyci5zdGRlcnIgfHwgZXJyLm1lc3NhZ2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSwge3dhaXRNczogU0FGQVJJX1NUQVJUVVBfVElNRU9VVCwgaW50ZXJ2YWxNczogNTAwfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFNhZmFyaSBjYW5ub3Qgb3BlbiAnJHt1cmx9JyBhZnRlciAke3RpbWVyLmdldER1cmF0aW9uKCkuYXNTZWNvbmRzLnRvRml4ZWQoMyl9cyBgICtcbiAgICAgICAgYGJlY2F1c2Ugb2Y6ICR7bGFzdEVycm9yIHx8ICdhbiB1bmtub3duIGVycm9yJ31gKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBTYWZhcmkgc3VjY2Vzc2Z1bGx5IG9wZW5lZCAnJHt1cmx9JyBpbiAke3RpbWVyLmdldER1cmF0aW9uKCkuYXNTZWNvbmRzLnRvRml4ZWQoMyl9c2ApO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFuIHVwIHRoZSBkaXJlY3RvcmllcyBmb3IgbW9iaWxlIFNhZmFyaS5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0ga2VlcFByZWZzIC0gV2hldGhlciB0byBrZWVwIFNhZmFyaSBwcmVmZXJlbmNlcyBmcm9tIGJlaW5nIGRlbGV0ZWQuXG4gICAqL1xuICBhc3luYyBjbGVhblNhZmFyaSAoa2VlcFByZWZzID0gdHJ1ZSkge1xuICAgIHRyeSB7XG4gICAgICBpZiAoYXdhaXQgdGhpcy5pc1J1bm5pbmcoKSkge1xuICAgICAgICBhd2FpdCB0aGlzLnNpbWN0bC50ZXJtaW5hdGVBcHAoTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGlnbikge1xuICAgICAgLy8gaWdub3JlIGVycm9yXG4gICAgfVxuICAgIGF3YWl0IHN1cGVyLmNsZWFuU2FmYXJpKGtlZXBQcmVmcyk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW4vc2NydWIgdGhlIHBhcnRpY3VsYXIgYXBwbGljYXRpb24gb24gU2ltdWxhdG9yLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEZpbGUgLSBBcHBsaWNhdGlvbiBuYW1lIG1pbnVzIFwiLmFwcFwiLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gYXBwQnVuZGxlSWQgLSBCdW5kbGUgaWRlbnRpZmllciBvZiB0aGUgYXBwbGljYXRpb24uXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gc2NydWIgLSBJZiBgc2NydWJgIGlzIGZhbHNlLCB3ZSB3YW50IHRvIGNsZWFuIGJ5IGRlbGV0aW5nIHRoZSBhcHAgYW5kIGFsbFxuICAgKiAgIGZpbGVzIGFzc29jaWF0ZWQgd2l0aCBpdC4gSWYgYHNjcnViYCBpcyB0cnVlLCB3ZSBqdXN0IHdhbnQgdG8gZGVsZXRlIHRoZSBwcmVmZXJlbmNlcyBhbmRcbiAgICogICBjaGFuZ2VkIGZpbGVzLlxuICAgKi9cbiAgYXN5bmMgY2xlYW5DdXN0b21BcHAgKGFwcEZpbGUsIGFwcEJ1bmRsZUlkLCBzY3J1YiA9IGZhbHNlKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuc2ltY3RsLnRlcm1pbmF0ZUFwcChhcHBCdW5kbGVJZCk7XG4gICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAvLyBpZ25vcmUgZXJyb3JcbiAgICB9XG4gICAgYXdhaXQgc3VwZXIuY2xlYW5DdXN0b21BcHAoYXBwRmlsZSwgYXBwQnVuZGxlSWQsIHNjcnViKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIFNoYWtlIGdlc3R1cmUgb24gU2ltdWxhdG9yIHdpbmRvdy5cbiAgICovXG4gIGFzeW5jIHNoYWtlICgpIHtcbiAgICBsb2cuaW5mbyhgUGVyZm9ybWluZyBzaGFrZSBnZXN0dXJlIG9uICR7dGhpcy51ZGlkfSBTaW11bGF0b3JgKTtcbiAgICBhd2FpdCB0aGlzLnNpbWN0bC5zcGF3blByb2Nlc3MoW1xuICAgICAgJ25vdGlmeXV0aWwnLFxuICAgICAgJy1wJywgJ2NvbS5hcHBsZS5VSUtpdC5TaW11bGF0b3JTaGFrZSdcbiAgICBdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKiBAb3ZlcnJpZGVcbiAgICovXG4gIGFzeW5jIGlzQmlvbWV0cmljRW5yb2xsZWQgKCkge1xuICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHRoaXMuZXhlY3V0ZVVJQ2xpZW50U2NyaXB0KGBcbiAgICAgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCJcbiAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICBzZXQgZHN0TWVudUl0ZW0gdG8gbWVudSBpdGVtIFwiVG9nZ2xlIEVucm9sbGVkIFN0YXRlXCIgb2YgbWVudSAxIG9mIG1lbnUgaXRlbSBcIlRvdWNoIElEXCIgb2YgbWVudSAxIG9mIG1lbnUgYmFyIGl0ZW0gXCJIYXJkd2FyZVwiIG9mIG1lbnUgYmFyIDFcbiAgICAgICAgICBzZXQgaXNDaGVja2VkIHRvICh2YWx1ZSBvZiBhdHRyaWJ1dGUgXCJBWE1lbnVJdGVtTWFya0NoYXJcIiBvZiBkc3RNZW51SXRlbSkgaXMgXCLinJNcIlxuICAgICAgICBlbmQgdGVsbFxuICAgICAgZW5kIHRlbGxcbiAgICBgKTtcbiAgICBsb2cuZGVidWcoYFRvdWNoIElEIGVucm9sbGVkIHN0YXRlOiAke291dHB1dH1gKTtcbiAgICByZXR1cm4gXy5pc1N0cmluZyhvdXRwdXQpICYmIG91dHB1dC50cmltKCkgPT09ICd0cnVlJztcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKiBAb3ZlcnJpZGVcbiAgICovXG4gIGFzeW5jIGVucm9sbEJpb21ldHJpYyAoaXNFbmFibGVkID0gdHJ1ZSkge1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZVVJQ2xpZW50U2NyaXB0KGBcbiAgICAgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCJcbiAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICBzZXQgZHN0TWVudUl0ZW0gdG8gbWVudSBpdGVtIFwiVG9nZ2xlIEVucm9sbGVkIFN0YXRlXCIgb2YgbWVudSAxIG9mIG1lbnUgaXRlbSBcIlRvdWNoIElEXCIgb2YgbWVudSAxIG9mIG1lbnUgYmFyIGl0ZW0gXCJIYXJkd2FyZVwiIG9mIG1lbnUgYmFyIDFcbiAgICAgICAgICBzZXQgaXNDaGVja2VkIHRvICh2YWx1ZSBvZiBhdHRyaWJ1dGUgXCJBWE1lbnVJdGVtTWFya0NoYXJcIiBvZiBkc3RNZW51SXRlbSkgaXMgXCLinJNcIlxuICAgICAgICAgIGlmICR7aXNFbmFibGVkID8gJ25vdCAnIDogJyd9aXNDaGVja2VkIHRoZW5cbiAgICAgICAgICAgIGNsaWNrIGRzdE1lbnVJdGVtXG4gICAgICAgICAgZW5kIGlmXG4gICAgICAgIGVuZCB0ZWxsXG4gICAgICBlbmQgdGVsbFxuICAgIGApO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgc2VuZEJpb21ldHJpY01hdGNoIChzaG91bGRNYXRjaCA9IHRydWUpIHtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVVSUNsaWVudFNjcmlwdChgXG4gICAgICB0ZWxsIGFwcGxpY2F0aW9uIFwiU3lzdGVtIEV2ZW50c1wiXG4gICAgICAgIHRlbGwgcHJvY2VzcyBcIlNpbXVsYXRvclwiXG4gICAgICAgICAgc2V0IGRzdE1lbnVJdGVtIHRvIG1lbnUgaXRlbSBcIiR7c2hvdWxkTWF0Y2ggPyAnTWF0Y2hpbmcgVG91Y2gnIDogJ05vbi1tYXRjaGluZyBUb3VjaCd9XCIgb2YgbWVudSAxIG9mIG1lbnUgaXRlbSBcIlRvdWNoIElEXCIgb2YgbWVudSAxIG9mIG1lbnUgYmFyIGl0ZW0gXCJIYXJkd2FyZVwiIG9mIG1lbnUgYmFyIDFcbiAgICAgICAgICBjbGljayBkc3RNZW51SXRlbVxuICAgICAgICBlbmQgdGVsbFxuICAgICAgZW5kIHRlbGxcbiAgICBgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgY3VzdG9tIGdlb2xvY2F0aW9uIHBhcmFtZXRlcnMgZm9yIHRoZSBnaXZlbiBTaW11bGF0b3IgdXNpbmcgQXBwbGVTY3JpcHQuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gbGF0aXR1ZGUgLSBUaGUgbGF0aXR1ZGUgdmFsdWUsIHdoaWNoIGlzIGdvaW5nIHRvIGJlIGVudGVyZWRcbiAgICogICBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIGVkaXQgZmllbGQsIGZvciBleGFtcGxlICczOSwwMDA2Jy5cbiAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBsb25naXR1ZGUgLSBUaGUgbG9uZ2l0dWRlIHZhbHVlLCB3aGljaCBpcyBnb2luZyB0byBiZSBlbnRlcmVkXG4gICAqICAgaW50byB0aGUgY29ycmVzcG9uZGluZyBlZGl0IGZpZWxkLCBmb3IgZXhhbXBsZSAnMTksMDA2OCcuXG4gICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIHRoZSBnaXZlbiBwYXJhbWV0ZXJzIGhhdmUgY29ycmVjdCBmb3JtYXQgYW5kIHdlcmUgc3VjY2Vzc2Z1bGx5IGFjY2VwdGVkLlxuICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIHNldHRpbmcgdGhlIGxvY2F0aW9uXG4gICAqL1xuICBhc3luYyBzZXRHZW9sb2NhdGlvbiAobGF0aXR1ZGUsIGxvbmdpdHVkZSkge1xuICAgIGNvbnN0IGxvY2F0aW9uU2V0dGVycyA9IFtcbiAgICAgIGFzeW5jICgpID0+IGF3YWl0IHNldExvY2F0aW9uV2l0aEx5ZnQodGhpcy51ZGlkLCBsYXRpdHVkZSwgbG9uZ2l0dWRlKSxcbiAgICAgIGFzeW5jICgpID0+IGF3YWl0IHNldExvY2F0aW9uV2l0aElkYih0aGlzLmlkYiwgbGF0aXR1ZGUsIGxvbmdpdHVkZSksXG4gICAgICBhc3luYyAoKSA9PiBhd2FpdCBzZXRMb2NhdGlvbldpdGhBcHBsZVNjcmlwdCh0aGlzLCBsYXRpdHVkZSwgbG9uZ2l0dWRlLCB0aGlzLl9sb2NhdGlvbk1lbnUpLFxuICAgIF07XG5cbiAgICBsZXQgbGFzdEVycm9yO1xuICAgIGZvciAoY29uc3Qgc2V0dGVyIG9mIGxvY2F0aW9uU2V0dGVycykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgc2V0dGVyKCk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cuaW5mbyhlLm1lc3NhZ2UpO1xuICAgICAgICBsYXN0RXJyb3IgPSBlO1xuICAgICAgfVxuICAgIH1cbiAgICB0aHJvdyBsYXN0RXJyb3I7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgU2ltdWxhdG9yWGNvZGU4O1xuIl0sImZpbGUiOiJsaWIvc2ltdWxhdG9yLXhjb2RlLTguanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
