"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.NSUserDefaults = void 0;
exports.generateDefaultsCommandArgs = generateDefaultsCommandArgs;
exports.toXmlArg = toXmlArg;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _xmldom = require("@xmldom/xmldom");

var _teen_process = require("teen_process");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _logger = _interopRequireDefault(require("./logger"));

function toXmlArg(value, serialize = true) {
  let xmlDoc = null;

  if (_lodash.default.isPlainObject(value)) {
    xmlDoc = new _xmldom.DOMParser().parseFromString('<dict></dict>', 'text/xml');

    for (const [subKey, subValue] of _lodash.default.toPairs(value)) {
      const keyEl = xmlDoc.createElement('key');
      const keyTextEl = xmlDoc.createTextNode(subKey);
      keyEl.appendChild(keyTextEl);
      xmlDoc.documentElement.appendChild(keyEl);
      const subValueEl = xmlDoc.importNode(toXmlArg(subValue, false), true);
      xmlDoc.documentElement.appendChild(subValueEl);
    }
  } else if (_lodash.default.isArray(value)) {
    xmlDoc = new _xmldom.DOMParser().parseFromString('<array></array>', 'text/xml');

    for (const subValue of value) {
      const subValueEl = xmlDoc.importNode(toXmlArg(subValue, false), true);
      xmlDoc.documentElement.appendChild(subValueEl);
    }
  } else if (_lodash.default.isBoolean(value)) {
    xmlDoc = new _xmldom.DOMParser().parseFromString(value ? '<true/>' : '<false/>', 'text/xml');
  } else if (_lodash.default.isInteger(value)) {
    xmlDoc = new _xmldom.DOMParser().parseFromString(`<integer>${value}</integer>`, 'text/xml');
  } else if (_lodash.default.isNumber(value)) {
    xmlDoc = new _xmldom.DOMParser().parseFromString(`<real>${value}</real>`, 'text/xml');
  } else if (_lodash.default.isString(value)) {
    xmlDoc = new _xmldom.DOMParser().parseFromString(`<string></string>`, 'text/xml');
    const valueTextEl = xmlDoc.createTextNode(value);
    xmlDoc.documentElement.appendChild(valueTextEl);
  }

  if (!xmlDoc) {
    throw new TypeError(`The defaults value ${JSON.stringify(value)} cannot be written, ` + `because it is not known how to handle its type`);
  }

  return serialize ? new _xmldom.XMLSerializer().serializeToString(xmlDoc.documentElement) : xmlDoc.documentElement;
}

function generateDefaultsCommandArgs(valuesMap, replace = false) {
  const resultArgs = [];

  for (const [key, value] of _lodash.default.toPairs(valuesMap)) {
    try {
      if (!replace && _lodash.default.isPlainObject(value)) {
        const dictArgs = [key, '-dict-add'];

        for (const [subKey, subValue] of _lodash.default.toPairs(value)) {
          dictArgs.push(subKey, toXmlArg(subValue));
        }

        resultArgs.push(dictArgs);
      } else if (!replace && _lodash.default.isArray(value)) {
        const arrayArgs = [key, '-array-add'];

        for (const subValue of value) {
          arrayArgs.push(toXmlArg(subValue));
        }

        resultArgs.push(arrayArgs);
      } else {
        resultArgs.push([key, toXmlArg(value)]);
      }
    } catch (e) {
      if (e instanceof TypeError) {
        _logger.default.warn(e.message);
      } else {
        throw e;
      }
    }
  }

  return resultArgs;
}

class NSUserDefaults {
  constructor(plist) {
    this.plist = plist;
  }

  async asJson() {
    try {
      const {
        stdout
      } = await (0, _teen_process.exec)('plutil', ['-convert', 'json', '-o', '-', this.plist]);
      return JSON.parse(stdout);
    } catch (e) {
      throw new Error(`'${this.plist}' cannot be converted to JSON. Original error: ${e.stderr || e.message}`);
    }
  }

  async update(valuesMap) {
    if (!_lodash.default.isPlainObject(valuesMap)) {
      throw new TypeError(`plist values must be a map. '${valuesMap}' is given instead`);
    }

    if (_lodash.default.isEmpty(valuesMap)) {
      return;
    }

    const commandArgs = generateDefaultsCommandArgs(valuesMap);

    try {
      await _bluebird.default.all(commandArgs.map(args => (0, _teen_process.exec)('defaults', ['write', this.plist, ...args])));
    } catch (e) {
      throw new Error(`Could not write defaults into '${this.plist}'. Original error: ${e.stderr || e.message}`);
    }
  }

}

exports.NSUserDefaults = NSUserDefaults;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZWZhdWx0cy11dGlscy5qcyJdLCJuYW1lcyI6WyJ0b1htbEFyZyIsInZhbHVlIiwic2VyaWFsaXplIiwieG1sRG9jIiwiXyIsImlzUGxhaW5PYmplY3QiLCJET01QYXJzZXIiLCJwYXJzZUZyb21TdHJpbmciLCJzdWJLZXkiLCJzdWJWYWx1ZSIsInRvUGFpcnMiLCJrZXlFbCIsImNyZWF0ZUVsZW1lbnQiLCJrZXlUZXh0RWwiLCJjcmVhdGVUZXh0Tm9kZSIsImFwcGVuZENoaWxkIiwiZG9jdW1lbnRFbGVtZW50Iiwic3ViVmFsdWVFbCIsImltcG9ydE5vZGUiLCJpc0FycmF5IiwiaXNCb29sZWFuIiwiaXNJbnRlZ2VyIiwiaXNOdW1iZXIiLCJpc1N0cmluZyIsInZhbHVlVGV4dEVsIiwiVHlwZUVycm9yIiwiSlNPTiIsInN0cmluZ2lmeSIsIlhNTFNlcmlhbGl6ZXIiLCJzZXJpYWxpemVUb1N0cmluZyIsImdlbmVyYXRlRGVmYXVsdHNDb21tYW5kQXJncyIsInZhbHVlc01hcCIsInJlcGxhY2UiLCJyZXN1bHRBcmdzIiwia2V5IiwiZGljdEFyZ3MiLCJwdXNoIiwiYXJyYXlBcmdzIiwiZSIsImxvZyIsIndhcm4iLCJtZXNzYWdlIiwiTlNVc2VyRGVmYXVsdHMiLCJjb25zdHJ1Y3RvciIsInBsaXN0IiwiYXNKc29uIiwic3Rkb3V0IiwicGFyc2UiLCJFcnJvciIsInN0ZGVyciIsInVwZGF0ZSIsImlzRW1wdHkiLCJjb21tYW5kQXJncyIsIkIiLCJhbGwiLCJtYXAiLCJhcmdzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBY0EsU0FBU0EsUUFBVCxDQUFtQkMsS0FBbkIsRUFBMEJDLFNBQVMsR0FBRyxJQUF0QyxFQUE0QztBQUMxQyxNQUFJQyxNQUFNLEdBQUcsSUFBYjs7QUFFQSxNQUFJQyxnQkFBRUMsYUFBRixDQUFnQkosS0FBaEIsQ0FBSixFQUE0QjtBQUMxQkUsSUFBQUEsTUFBTSxH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QixDQUFDLE9BQUQsRUFBVSxLQUFLWixLQUFmLEVBQXNCLEdBQUdZLElBQXpCLENBQWpCLENBQTFCLENBQU4sQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPbEIsQ0FBUCxFQUFVO0FBQ1YsWUFBTSxJQUFJVSxLQUFKLENBQVcsa0NBQWlDLEtBQUtKLEtBQU0sc0JBQXFCTixDQUFDLENBQUNXLE1BQUYsSUFBWVgsQ0FBQyxDQUFDRyxPQUFRLEVBQWxHLENBQU47QUFDRDtBQUNGOztBQTlDa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgRE9NUGFyc2VyLCBYTUxTZXJpYWxpemVyIH0gZnJvbSAnQHhtbGRvbS94bWxkb20nO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcblxuLyoqXG4gKiBTZXJpYWxpemVzIHRoZSBnaXZlbiB2YWx1ZSB0byBwbGlzdC1jb21wYXRpYmxlXG4gKiBYTUwgcmVwcmVzZW50YXRpb24sIHdoaWNoIGlzIHJlYWR5IGZvciBmdXJ0aGVyIHVzYWdlXG4gKiB3aXRoIGBkZWZhdWx0c2AgY29tbWFuZCBsaW5lIHRvb2wgYXJndW1lbnRzXG4gKlxuICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gYmUgc2VyaWFsaXplZFxuICogQHBhcmFtIHtib29sZWFufSBzZXJpYWxpemUgW3RydWVdIFdoZXRoZXIgdG8gc2VyaWFsaXplIHRoZSByZXN1bHRpbmdcbiAqIFhNTCB0byBzdHJpbmcgb3IgdG8gcmV0dXJuIHJhdyBIVE1MRWxlbWVudCBpbnN0YW5jZVxuICogQHJldHVybnMge0hUTUxFbGVtZW50fHN0cmluZ30gRWl0aGVyIHN0cmluZyBvciByYXcgbm9kZSByZXByZXNlbnRhdGlvbiBvZlxuICogdGhlIGdpdmVuIHZhbHVlXG4gKiBAdGhyb3dzIHtUeXBlRXJyb3J9IElmIGl0IGlzIG5vdCBrbm93biBob3cgdG8gc2VyaWFsaXplIHRoZSBnaXZlbiB2YWx1ZVxuICovXG5mdW5jdGlvbiB0b1htbEFyZyAodmFsdWUsIHNlcmlhbGl6ZSA9IHRydWUpIHtcbiAgbGV0IHhtbERvYyA9IG51bGw7XG5cbiAgaWYgKF8uaXNQbGFpbk9iamVjdCh2YWx1ZSkpIHtcbiAgICB4bWxEb2MgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKCc8ZGljdD48L2RpY3Q+JywgJ3RleHQveG1sJyk7XG4gICAgZm9yIChjb25zdCBbc3ViS2V5LCBzdWJWYWx1ZV0gb2YgXy50b1BhaXJzKHZhbHVlKSkge1xuICAgICAgY29uc3Qga2V5RWwgPSB4bWxEb2MuY3JlYXRlRWxlbWVudCgna2V5Jyk7XG4gICAgICBjb25zdCBrZXlUZXh0RWwgPSB4bWxEb2MuY3JlYXRlVGV4dE5vZGUoc3ViS2V5KTtcbiAgICAgIGtleUVsLmFwcGVuZENoaWxkKGtleVRleHRFbCk7XG4gICAgICB4bWxEb2MuZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKGtleUVsKTtcbiAgICAgIGNvbnN0IHN1YlZhbHVlRWwgPSB4bWxEb2MuaW1wb3J0Tm9kZSh0b1htbEFyZyhzdWJWYWx1ZSwgZmFsc2UpLCB0cnVlKTtcbiAgICAgIHhtbERvYy5kb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoc3ViVmFsdWVFbCk7XG4gICAgfVxuICB9IGVsc2UgaWYgKF8uaXNBcnJheSh2YWx1ZSkpIHtcbiAgICB4bWxEb2MgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKCc8YXJyYXk+PC9hcnJheT4nLCAndGV4dC94bWwnKTtcbiAgICBmb3IgKGNvbnN0IHN1YlZhbHVlIG9mIHZhbHVlKSB7XG4gICAgICBjb25zdCBzdWJWYWx1ZUVsID0geG1sRG9jLmltcG9ydE5vZGUodG9YbWxBcmcoc3ViVmFsdWUsIGZhbHNlKSwgdHJ1ZSk7XG4gICAgICB4bWxEb2MuZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKHN1YlZhbHVlRWwpO1xuICAgIH1cbiAgfSBlbHNlIGlmIChfLmlzQm9vbGVhbih2YWx1ZSkpIHtcbiAgICB4bWxEb2MgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKHZhbHVlID8gJzx0cnVlLz4nIDogJzxmYWxzZS8+JywgJ3RleHQveG1sJyk7XG4gIH0gZWxzZSBpZiAoXy5pc0ludGVnZXIodmFsdWUpKSB7XG4gICAgeG1sRG9jID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhgPGludGVnZXI+JHt2YWx1ZX08L2ludGVnZXI+YCwgJ3RleHQveG1sJyk7XG4gIH0gZWxzZSBpZiAoXy5pc051bWJlcih2YWx1ZSkpIHtcbiAgICB4bWxEb2MgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKGA8cmVhbD4ke3ZhbHVlfTwvcmVhbD5gLCAndGV4dC94bWwnKTtcbiAgfSBlbHNlIGlmIChfLmlzU3RyaW5nKHZhbHVlKSkge1xuICAgIHhtbERvYyA9IG5ldyBET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcoYDxzdHJpbmc+PC9zdHJpbmc+YCwgJ3RleHQveG1sJyk7XG4gICAgY29uc3QgdmFsdWVUZXh0RWwgPSB4bWxEb2MuY3JlYXRlVGV4dE5vZGUodmFsdWUpO1xuICAgIHhtbERvYy5kb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQodmFsdWVUZXh0RWwpO1xuICB9XG5cbiAgaWYgKCF4bWxEb2MpIHtcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBUaGUgZGVmYXVsdHMgdmFsdWUgJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9IGNhbm5vdCBiZSB3cml0dGVuLCBgICtcbiAgICAgIGBiZWNhdXNlIGl0IGlzIG5vdCBrbm93biBob3cgdG8gaGFuZGxlIGl0cyB0eXBlYCk7XG4gIH1cblxuICByZXR1cm4gc2VyaWFsaXplXG4gICAgPyBuZXcgWE1MU2VyaWFsaXplcigpLnNlcmlhbGl6ZVRvU3RyaW5nKHhtbERvYy5kb2N1bWVudEVsZW1lbnQpXG4gICAgOiB4bWxEb2MuZG9jdW1lbnRFbGVtZW50O1xufVxuXG4vKipcbiAqIEdlbmVyYXRlcyBjb21tYW5kIGxpbmUgYXJncyBmb3IgdGhlIGBkZWZhdWx0c2BcbiAqIGNvbW1hbmQgbGluZSB1dGlsaXR5IGJhc2VkIG9uIHRoZSBnaXZlbiBwcmVmZXJlbmNlIHZhbHVlcyBtYXBwaW5nLlxuICogU2VlIGh0dHBzOi8vc2hhZG93ZmlsZS5pbm9kZS5saW5rL2Jsb2cvMjAxOC8wNi9hZHZhbmNlZC1kZWZhdWx0czEtdXNhZ2UvXG4gKiBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZXNNYXAgUHJlZmVyZW5jZXMgbWFwcGluZ1xuICogQHBhcmFtIHtCb29sZWFufSByZXBsYWNlIFtmYWxzZV0gV2hldGhlciB0byBnZW5lcmF0ZSBhcmd1bWVudHMgdGhhdCByZXBsYWNlXG4gKiBjb21wbGV4IHR5cGVkIHZhbHVlcyBsaWtlIGFycmF5cyBvciBkaWN0aW9uYXJpZXMgaW4gdGhlIGN1cnJlbnQgcGxpc3Qgb3JcbiAqIHVwZGF0ZSB0aGVtICh0aGUgZGVmYXVsdCBzZXR0aW5ncylcbiAqIEByZXR1cm5zIHtBcnJheTxBcnJheTxzdHJpbmc+Pn0gRWFjaCBpdGVtIGluIHRoZSBhcnJheVxuICogaXMgdGhlIGBkZWZhdWx0cyB3cml0ZSA8cGxpc3Q+YCBjb21tYW5kIHN1ZmZpeFxuICovXG5mdW5jdGlvbiBnZW5lcmF0ZURlZmF1bHRzQ29tbWFuZEFyZ3MgKHZhbHVlc01hcCwgcmVwbGFjZSA9IGZhbHNlKSB7XG4gIGNvbnN0IHJlc3VsdEFyZ3MgPSBbXTtcbiAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgXy50b1BhaXJzKHZhbHVlc01hcCkpIHtcbiAgICB0cnkge1xuICAgICAgaWYgKCFyZXBsYWNlICYmIF8uaXNQbGFpbk9iamVjdCh2YWx1ZSkpIHtcbiAgICAgICAgY29uc3QgZGljdEFyZ3MgPSBba2V5LCAnLWRpY3QtYWRkJ107XG4gICAgICAgIGZvciAoY29uc3QgW3N1YktleSwgc3ViVmFsdWVdIG9mIF8udG9QYWlycyh2YWx1ZSkpIHtcbiAgICAgICAgICBkaWN0QXJncy5wdXNoKHN1YktleSwgdG9YbWxBcmcoc3ViVmFsdWUpKTtcbiAgICAgICAgfVxuICAgICAgICByZXN1bHRBcmdzLnB1c2goZGljdEFyZ3MpO1xuICAgICAgfSBlbHNlIGlmICghcmVwbGFjZSAmJiBfLmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgIGNvbnN0IGFycmF5QXJncyA9IFtrZXksICctYXJyYXktYWRkJ107XG4gICAgICAgIGZvciAoY29uc3Qgc3ViVmFsdWUgb2YgdmFsdWUpIHtcbiAgICAgICAgICBhcnJheUFyZ3MucHVzaCh0b1htbEFyZyhzdWJWYWx1ZSkpO1xuICAgICAgICB9XG4gICAgICAgIHJlc3VsdEFyZ3MucHVzaChhcnJheUFyZ3MpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzdWx0QXJncy5wdXNoKFtrZXksIHRvWG1sQXJnKHZhbHVlKV0pO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlIGluc3RhbmNlb2YgVHlwZUVycm9yKSB7XG4gICAgICAgIGxvZy53YXJuKGUubWVzc2FnZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gcmVzdWx0QXJncztcbn1cblxuXG5jbGFzcyBOU1VzZXJEZWZhdWx0cyB7XG4gIGNvbnN0cnVjdG9yIChwbGlzdCkge1xuICAgIHRoaXMucGxpc3QgPSBwbGlzdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWFkcyB0aGUgY29udGVudCBvZiB0aGUgZ2l2ZW4gcGxpc3QgZmlsZSB1c2luZyBwbHV0aWwgY29tbWFuZCBsaW5lIHRvb2xcbiAgICogYW5kIHNlcmlhbGl6ZXMgaXQgdG8gYSBKU09OIHJlcHJlc2VudGF0aW9uXG4gICAqXG4gICAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBzZXJpYWxpemVkIHBsaXN0IGNvbnRlbnRcbiAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciBkdXJpbmcgc2VyaWFsaXphdGlvblxuICAgKi9cbiAgYXN5bmMgYXNKc29uICgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKCdwbHV0aWwnLCBbJy1jb252ZXJ0JywgJ2pzb24nLCAnLW8nLCAnLScsIHRoaXMucGxpc3RdKTtcbiAgICAgIHJldHVybiBKU09OLnBhcnNlKHN0ZG91dCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAnJHt0aGlzLnBsaXN0fScgY2Fubm90IGJlIGNvbnZlcnRlZCB0byBKU09OLiBPcmlnaW5hbCBlcnJvcjogJHtlLnN0ZGVyciB8fCBlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgdGhlIGNvbnRlbnQgb2YgdGhlIGdpdmVuIHBsaXN0IGZpbGUuXG4gICAqIElmIHRoZSBwbGlzdCBkb2VzIG5vdCBleGlzdCB5ZXQgdGhlbiBpdCBpcyBnb2luZyB0byBiZSBjcmVhdGVkLlxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gdmFsdWVzTWFwIE1hcHBpbmcgb2YgcHJlZmVyZW5jZSB2YWx1ZXMgdG8gdXBkYXRlLlxuICAgKiBJZiBhbnkgb2YgaXRlbSB2YWx1ZXMgYXJlIG9mIGRpY3Rpb25hcnkgdHlwZSB0aGVuIG9ubHkgdGhlIGZpcnN0IGxldmVsIGRpY3Rpb25hcnkgZ2V0c1xuICAgKiB1cGRhdGVkLiBFdmVyeXRoaW5nIGJlbG93IHRoaXMgbGV2ZWwgd2lsbCBiZSByZXBsYWNlZC4gVGhpcyBpcyB0aGUga25vd24gbGltaXRhdGlvblxuICAgKiBvZiB0aGUgYGRlZmF1bHRzYCBjb21tYW5kIGxpbmUgdG9vbC4gQSB3b3JrYXJvdW5kIGZvciBpdCB3b3VsZCBiZSB0byByZWFkIHRoZSBjdXJyZW50XG4gICAqIHByZWZlcmVuY2VzIG1hcHBpbmcgZmlyc3QgYW5kIG1lcmdlIGl0IHdpdGggdGhpcyB2YWx1ZS5cbiAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSB1cGRhdGluZyB0aGUgcGxpc3RcbiAgICovXG4gIGFzeW5jIHVwZGF0ZSAodmFsdWVzTWFwKSB7XG4gICAgaWYgKCFfLmlzUGxhaW5PYmplY3QodmFsdWVzTWFwKSkge1xuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgcGxpc3QgdmFsdWVzIG11c3QgYmUgYSBtYXAuICcke3ZhbHVlc01hcH0nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgICB9XG4gICAgaWYgKF8uaXNFbXB0eSh2YWx1ZXNNYXApKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgY29tbWFuZEFyZ3MgPSBnZW5lcmF0ZURlZmF1bHRzQ29tbWFuZEFyZ3ModmFsdWVzTWFwKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgQi5hbGwoY29tbWFuZEFyZ3MubWFwKChhcmdzKSA9PiBleGVjKCdkZWZhdWx0cycsIFsnd3JpdGUnLCB0aGlzLnBsaXN0LCAuLi5hcmdzXSkpKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCB3cml0ZSBkZWZhdWx0cyBpbnRvICcke3RoaXMucGxpc3R9Jy4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5zdGRlcnIgfHwgZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxufVxuXG5cbmV4cG9ydCB7XG4gIE5TVXNlckRlZmF1bHRzLFxuICB0b1htbEFyZywgZ2VuZXJhdGVEZWZhdWx0c0NvbW1hbmRBcmdzLFxufTtcbiJdLCJmaWxlIjoibGliL2RlZmF1bHRzLXV0aWxzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
