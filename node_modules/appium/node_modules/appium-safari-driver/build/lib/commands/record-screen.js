"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("../logger"));

var _nodeSimctl = _interopRequireDefault(require("node-simctl"));

const commands = {};
const STARTUP_INTERVAL_MS = 300;
const STARTUP_TIMEOUT_MS = 10 * 1000;
const DEFAULT_TIME_LIMIT_MS = 60 * 10 * 1000;
const PROCESS_SHUTDOWN_TIMEOUT_MS = 10 * 1000;
const DEFAULT_EXT = '.mp4';

async function uploadRecordedMedia(localFile, remotePath = null, uploadOptions = {}) {
  if (_lodash.default.isEmpty(remotePath)) {
    const {
      size
    } = await _appiumSupport.fs.stat(localFile);

    _logger.default.debug(`The size of the resulting screen recording is ${_appiumSupport.util.toReadableSizeString(size)}`);

    return (await _appiumSupport.util.toInMemoryBase64(localFile)).toString();
  }

  const {
    user,
    pass,
    method,
    headers,
    fileFieldName,
    formFields
  } = uploadOptions;
  const options = {
    method: method || 'PUT',
    headers,
    fileFieldName,
    formFields
  };

  if (user && pass) {
    options.auth = {
      user,
      pass
    };
  }

  await _appiumSupport.net.uploadFile(localFile, remotePath, options);
  return '';
}

const VIDEO_FILES = new Set();
process.on('exit', () => {
  for (const videoFile of VIDEO_FILES) {
    try {
      _appiumSupport.fs.rimrafSync(videoFile);
    } catch (ign) {}
  }
});

class ScreenRecorder {
  constructor(udid, videoPath, opts = {}) {
    this._process = null;
    this._udid = udid;
    this._videoPath = videoPath;
    this._codec = opts.codec;
    this._display = opts.display;
    this._mask = opts.mask;
    this._timeLimitMs = opts.timeLimit > 0 ? opts.timeLimit * 1000 : DEFAULT_TIME_LIMIT_MS;
    this._timer = null;
  }

  async getVideoPath() {
    if (await _appiumSupport.fs.exists(this._videoPath)) {
      VIDEO_FILES.add(this._videoPath);
      return this._videoPath;
    }

    return '';
  }

  get isRunning() {
    var _this$_process;

    return !!((_this$_process = this._process) === null || _this$_process === void 0 ? void 0 : _this$_process.isRunning);
  }

  async _enforceTermination() {
    if (this.isRunning) {
      _logger.default.debug('Force-stopping the currently running video recording');

      try {
        await this._process.stop('SIGKILL');
      } catch (ign) {}
    }

    this._process = null;
    const videoPath = await this.getVideoPath();

    if (videoPath) {
      await _appiumSupport.fs.rimraf(videoPath);
      VIDEO_FILES.delete(videoPath);
    }

    return '';
  }

  async start() {
    const args = [this._udid, 'recordVideo'];

    if (this._display) {
      args.push('--display', this._display);
    }

    if (this._codec) {
      args.push('--codec', this._codec);
    }

    if (this._mask) {
      args.push('--mask', this._mask);
    }

    args.push('--force', this._videoPath);
    this._process = await new _nodeSimctl.default().exec('io', {
      args,
      asynchronous: true
    });

    _logger.default.debug(`Starting video recording with arguments: ${_appiumSupport.util.quote(args)}`);

    this._process.on('output', (stdout, stderr) => {
      const line = _lodash.default.trim(stdout || stderr);

      if (line) {
        _logger.default.debug(`[recordVideo@${this._udid.substring(0, 8)}] ${line}`);
      }
    });

    this._process.once('exit', async (code, signal) => {
      this._process = null;

      if (code === 0) {
        _logger.default.debug('Screen recording exited without errors');
      } else {
        await this._enforceTermination();

        _logger.default.warn(`Screen recording exited with error code ${code}, signal ${signal}`);
      }
    });

    await this._process.start(0);

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        if (!this.isRunning) {
          throw new Error();
        }

        return !!(await this.getVideoPath());
      }, {
        waitMs: STARTUP_TIMEOUT_MS,
        intervalMs: STARTUP_INTERVAL_MS
      });
    } catch (e) {
      await this._enforceTermination();

      _logger.default.errorAndThrow(`The expected screen record file '${this._videoPath}' does not exist after ${STARTUP_TIMEOUT_MS}ms. ` + `Check the server log for more details`);
    }

    this._timer = setTimeout(async () => {
      if (this.isRunning) {
        try {
          await this.stop();
        } catch (e) {
          _logger.default.error(e);
        }
      }
    }, this._timeLimitMs);

    _logger.default.info(`The video recording has started. Will timeout in ${this._timeLimitMs}ms`);
  }

  async stop(force = false) {
    if (this._timer) {
      clearTimeout(this._timer);
      this._timer = null;
    }

    if (force) {
      return await this._enforceTermination();
    }

    if (!this.isRunning) {
      _logger.default.debug('Screen recording is not running. Returning the recently recorded video');

      return await this.getVideoPath();
    }

    try {
      await this._process.stop('SIGINT', PROCESS_SHUTDOWN_TIMEOUT_MS);
    } catch (e) {
      await this._enforceTermination();
      throw new Error(`Screen recording has failed to stop after ${PROCESS_SHUTDOWN_TIMEOUT_MS}ms`);
    }

    return await this.getVideoPath();
  }

}

async function extractSimulatorUdid(caps) {
  if (caps['safari:useSimulator'] === false) {
    return null;
  }

  const allDevices = _lodash.default.flatMap(_lodash.default.values(await new _nodeSimctl.default().getDevices(null, 'iOS')));

  for (const {
    name,
    udid,
    state,
    sdk
  } of allDevices) {
    if (state !== 'Booted') {
      continue;
    }

    if (_lodash.default.toLower(caps['safari:deviceUDID']) === _lodash.default.toLower(udid)) {
      return udid;
    }

    if (_lodash.default.toLower(caps['safari:deviceName']) === _lodash.default.toLower(name) && (caps['safari:platformVersion'] && caps['safari:platformVersion'] === sdk || !caps['safari:platformVersion'])) {
      return udid;
    }
  }

  return null;
}

commands.startRecordingScreen = async function startRecordingScreen(options = {}) {
  var _this$_screenRecorder;

  const {
    timeLimit,
    codec,
    display,
    mask,
    forceRestart = true
  } = options;

  if ((_this$_screenRecorder = this._screenRecorder) === null || _this$_screenRecorder === void 0 ? void 0 : _this$_screenRecorder.isRunning) {
    _logger.default.info('The screen recording is already running');

    if (!forceRestart) {
      _logger.default.info('Doing nothing');

      return;
    }

    _logger.default.info('Forcing the active screen recording to stop');

    await this._screenRecorder.stop(true);
  }

  this._screenRecorder = null;
  const udid = await extractSimulatorUdid(this.caps);

  if (!udid) {
    throw new Error('Cannot determine Simulator UDID to record the video from. ' + 'Double check your session capabilities');
  }

  const videoPath = await _appiumSupport.tempDir.path({
    prefix: _appiumSupport.util.uuidV4().substring(0, 8),
    suffix: DEFAULT_EXT
  });
  this._screenRecorder = new ScreenRecorder(udid, videoPath, {
    timeLimit: parseInt(timeLimit, 10),
    codec,
    display,
    mask
  });

  try {
    await this._screenRecorder.start();
  } catch (e) {
    this._screenRecorder = null;
    throw e;
  }
};

commands.stopRecordingScreen = async function stopRecordingScreen(options = {}) {
  if (!this._screenRecorder) {
    _logger.default.info('No screen recording has been started. Doing nothing');

    return '';
  }

  _logger.default.debug('Retrieving the resulting video data');

  const videoPath = await this._screenRecorder.stop();

  if (!videoPath) {
    _logger.default.info('No video data is found. Returning an empty string');

    return '';
  }

  return await uploadRecordedMedia(videoPath, options.remotePath, options);
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9yZWNvcmQtc2NyZWVuLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiU1RBUlRVUF9JTlRFUlZBTF9NUyIsIlNUQVJUVVBfVElNRU9VVF9NUyIsIkRFRkFVTFRfVElNRV9MSU1JVF9NUyIsIlBST0NFU1NfU0hVVERPV05fVElNRU9VVF9NUyIsIkRFRkFVTFRfRVhUIiwidXBsb2FkUmVjb3JkZWRNZWRpYSIsImxvY2FsRmlsZSIsInJlbW90ZVBhdGgiLCJ1cGxvYWRPcHRpb25zIiwiXyIsImlzRW1wdHkiLCJzaXplIiwiZnMiLCJzdGF0IiwibG9nIiwiZGVidWciLCJ1dGlsIiwidG9SZWFkYWJsZVNpemVTdHJpbmciLCJ0b0luTWVtb3J5QmFzZTY0IiwidG9TdHJpbmciLCJ1c2VyIiwicGFzcyIsIm1ldGhvZCIsImhlYWRlcnMiLCJmaWxlRmllbGROYW1lIiwiZm9ybUZpZWxkcyIsIm9wdGlvbnMiLCJhdXRoIiwibmV0IiwidXBsb2FkRmlsZSIsIlZJREVPX0ZJTEVTIiwiU2V0IiwicHJvY2VzcyIsIm9uIiwidmlkZW9GaWxlIiwicmltcmFmU3luYyIsImlnbiIsIlNjcmVlblJlY29yZGVyIiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwidmlkZW9QYXRoIiwib3B0cyIsIl9wcm9jZXNzIiwiX3VkaWQiLCJfdmlkZW9QYXRoIiwiX2NvZGVjIiwiY29kZWMiLCJfZGlzcGxheSIsImRpc3BsYXkiLCJfbWFzayIsIm1hc2siLCJfdGltZUxpbWl0TXMiLCJ0aW1lTGltaXQiLCJfdGltZXIiLCJnZXRWaWRlb1BhdGgiLCJleGlzdHMiLCJhZGQiLCJpc1J1bm5pbmciLCJfZW5mb3JjZVRlcm1pbmF0aW9uIiwic3RvcCIsInJpbXJhZiIsImRlbGV0ZSIsInN0YXJ0IiwiYXJncyIsInB1c2giLCJTaW1jdGwiLCJleGVjIiwiYXN5bmNocm9ub3VzIiwicXVvdGUiLCJzdGRvdXQiLCJzdGRlcnIiLCJsaW5lIiwidHJpbSIsInN1YnN0cmluZyIsIm9uY2UiLCJjb2RlIiwic2lnbmFsIiwid2FybiIsIkVycm9yIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImUiLCJlcnJvckFuZFRocm93Iiwic2V0VGltZW91dCIsImVycm9yIiwiaW5mbyIsImZvcmNlIiwiY2xlYXJUaW1lb3V0IiwiZXh0cmFjdFNpbXVsYXRvclVkaWQiLCJjYXBzIiwiYWxsRGV2aWNlcyIsImZsYXRNYXAiLCJ2YWx1ZXMiLCJnZXREZXZpY2VzIiwibmFtZSIsInN0YXRlIiwic2RrIiwidG9Mb3dlciIsInN0YXJ0UmVjb3JkaW5nU2NyZWVuIiwiZm9yY2VSZXN0YXJ0IiwiX3NjcmVlblJlY29yZGVyIiwidGVtcERpciIsInBhdGgiLCJwcmVmaXgiLCJ1dWlkVjQiLCJzdWZmaXgiLCJwYXJzZUludCIsInN0b3BSZWNvcmRpbmdTY3JlZW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsUUFBUSxHQUFHLEVBQWpCO0FBRUEsTUFBTUMsbUJBQW1CLEdBQUcsR0FBNUI7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxLQUFLLElBQWhDO0FBQ0EsTUFBTUMscUJBQXFCLEdBQUcsS0FBSyxFQUFMLEdBQVUsSUFBeEM7QUFDQSxNQUFNQywyQkFBMkIsR0FBRyxLQUFLLElBQXpDO0FBQ0EsTUFBTUMsV0FBVyxHQUFHLE1BQXBCOztBQUdBLGVBQWVDLG1CQUFmLENBQW9DQyxTQUFwQyxFQUErQ0MsVUFBVSxHQUFHLElBQTVELEVBQWtFQyxhQUFhLEdBQUcsRUFBbEYsRUFBc0Y7QUFDcEYsTUFBSUMsZ0JBQUVDLE9BQUYsQ0FBVUgsVUFBVixDQUFKLEVBQTJCO0FBQ3pCLFVBQU07QUFBQ0ksTUFBQUE7QUFBRCxRQUFTLE1BQU1DLGtCQUFHQyxJQUFILENBQVFQLFNBQVIsQ0FBckI7O0FBQ0FRLG9CQUFJQyxLQUFKLENBQVcsaURBQWdEQyxvQkFBS0Msb0JBQUwsQ0FBMEJOLElBQTFCLENBQWdDLEVBQTNGOztBQUNBLFdBQU8sQ0FBQyxNQUFN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Q0FBVSxxQ0FBVjs7QUFDQSxRQUFNeUIsU0FBUyxHQUFHLE1BQU0sS0FBSzRELGVBQUwsQ0FBcUJ6QyxJQUFyQixFQUF4Qjs7QUFDQSxNQUFJLENBQUNuQixTQUFMLEVBQWdCO0FBQ2QxQixvQkFBSXVFLElBQUosQ0FBUyxtREFBVDs7QUFDQSxXQUFPLEVBQVA7QUFDRDs7QUFDRCxTQUFPLE1BQU1oRixtQkFBbUIsQ0FBQ21DLFNBQUQsRUFBWWQsT0FBTyxDQUFDbkIsVUFBcEIsRUFBZ0NtQixPQUFoQyxDQUFoQztBQUNELENBYkQ7O2VBZWUzQixRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHV0aWwsIGZzLCBuZXQsIHRlbXBEaXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IFNpbWN0bCBmcm9tICdub2RlLXNpbWN0bCc7XG5cblxuY29uc3QgY29tbWFuZHMgPSB7fTtcblxuY29uc3QgU1RBUlRVUF9JTlRFUlZBTF9NUyA9IDMwMDtcbmNvbnN0IFNUQVJUVVBfVElNRU9VVF9NUyA9IDEwICogMTAwMDtcbmNvbnN0IERFRkFVTFRfVElNRV9MSU1JVF9NUyA9IDYwICogMTAgKiAxMDAwOyAvLyAxMCBtaW51dGVzXG5jb25zdCBQUk9DRVNTX1NIVVRET1dOX1RJTUVPVVRfTVMgPSAxMCAqIDEwMDA7XG5jb25zdCBERUZBVUxUX0VYVCA9ICcubXA0JztcblxuXG5hc3luYyBmdW5jdGlvbiB1cGxvYWRSZWNvcmRlZE1lZGlhIChsb2NhbEZpbGUsIHJlbW90ZVBhdGggPSBudWxsLCB1cGxvYWRPcHRpb25zID0ge30pIHtcbiAgaWYgKF8uaXNFbXB0eShyZW1vdGVQYXRoKSkge1xuICAgIGNvbnN0IHtzaXplfSA9IGF3YWl0IGZzLnN0YXQobG9jYWxGaWxlKTtcbiAgICBsb2cuZGVidWcoYFRoZSBzaXplIG9mIHRoZSByZXN1bHRpbmcgc2NyZWVuIHJlY29yZGluZyBpcyAke3V0aWwudG9SZWFkYWJsZVNpemVTdHJpbmcoc2l6ZSl9YCk7XG4gICAgcmV0dXJuIChhd2FpdCB1dGlsLnRvSW5NZW1vcnlCYXNlNjQobG9jYWxGaWxlKSkudG9TdHJpbmcoKTtcbiAgfVxuXG4gIGNvbnN0IHt1c2VyLCBwYXNzLCBtZXRob2QsIGhlYWRlcnMsIGZpbGVGaWVsZE5hbWUsIGZvcm1GaWVsZHN9ID0gdXBsb2FkT3B0aW9ucztcbiAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICBtZXRob2Q6IG1ldGhvZCB8fCAnUFVUJyxcbiAgICBoZWFkZXJzLFxuICAgIGZpbGVGaWVsZE5hbWUsXG4gICAgZm9ybUZpZWxkcyxcbiAgfTtcbiAgaWYgKHVzZXIgJiYgcGFzcykge1xuICAgIG9wdGlvbnMuYXV0aCA9IHt1c2VyLCBwYXNzfTtcbiAgfVxuICBhd2FpdCBuZXQudXBsb2FkRmlsZShsb2NhbEZpbGUsIHJlbW90ZVBhdGgsIG9wdGlvbnMpO1xuICByZXR1cm4gJyc7XG59XG5cbmNvbnN0IFZJREVPX0ZJTEVTID0gbmV3IFNldCgpO1xucHJvY2Vzcy5vbignZXhpdCcsICgpID0+IHtcbiAgZm9yIChjb25zdCB2aWRlb0ZpbGUgb2YgVklERU9fRklMRVMpIHtcbiAgICB0cnkge1xuICAgICAgZnMucmltcmFmU3luYyh2aWRlb0ZpbGUpO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgfVxufSk7XG5cbmNsYXNzIFNjcmVlblJlY29yZGVyIHtcbiAgY29uc3RydWN0b3IgKHVkaWQsIHZpZGVvUGF0aCwgb3B0cyA9IHt9KSB7XG4gICAgdGhpcy5fcHJvY2VzcyA9IG51bGw7XG4gICAgdGhpcy5fdWRpZCA9IHVkaWQ7XG4gICAgdGhpcy5fdmlkZW9QYXRoID0gdmlkZW9QYXRoO1xuICAgIHRoaXMuX2NvZGVjID0gb3B0cy5jb2RlYztcbiAgICB0aGlzLl9kaXNwbGF5ID0gb3B0cy5kaXNwbGF5O1xuICAgIHRoaXMuX21hc2sgPSBvcHRzLm1hc2s7XG4gICAgdGhpcy5fdGltZUxpbWl0TXMgPSBvcHRzLnRpbWVMaW1pdCA+IDAgPyBvcHRzLnRpbWVMaW1pdCAqIDEwMDAgOiBERUZBVUxUX1RJTUVfTElNSVRfTVM7XG4gICAgdGhpcy5fdGltZXIgPSBudWxsO1xuICB9XG5cbiAgYXN5bmMgZ2V0VmlkZW9QYXRoICgpIHtcbiAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKHRoaXMuX3ZpZGVvUGF0aCkpIHtcbiAgICAgIFZJREVPX0ZJTEVTLmFkZCh0aGlzLl92aWRlb1BhdGgpO1xuICAgICAgcmV0dXJuIHRoaXMuX3ZpZGVvUGF0aDtcbiAgICB9XG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgZ2V0IGlzUnVubmluZyAoKSB7XG4gICAgcmV0dXJuICEhKHRoaXMuX3Byb2Nlc3M/LmlzUnVubmluZyk7XG4gIH1cblxuICBhc3luYyBfZW5mb3JjZVRlcm1pbmF0aW9uICgpIHtcbiAgICBpZiAodGhpcy5pc1J1bm5pbmcpIHtcbiAgICAgIGxvZy5kZWJ1ZygnRm9yY2Utc3RvcHBpbmcgdGhlIGN1cnJlbnRseSBydW5uaW5nIHZpZGVvIHJlY29yZGluZycpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5fcHJvY2Vzcy5zdG9wKCdTSUdLSUxMJyk7XG4gICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgfVxuICAgIHRoaXMuX3Byb2Nlc3MgPSBudWxsO1xuICAgIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRoaXMuZ2V0VmlkZW9QYXRoKCk7XG4gICAgaWYgKHZpZGVvUGF0aCkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKHZpZGVvUGF0aCk7XG4gICAgICBWSURFT19GSUxFUy5kZWxldGUodmlkZW9QYXRoKTtcbiAgICB9XG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKCkge1xuICAgIGNvbnN0IGFyZ3MgPSBbXG4gICAgICB0aGlzLl91ZGlkLCAncmVjb3JkVmlkZW8nXG4gICAgXTtcbiAgICBpZiAodGhpcy5fZGlzcGxheSkge1xuICAgICAgYXJncy5wdXNoKCctLWRpc3BsYXknLCB0aGlzLl9kaXNwbGF5KTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2NvZGVjKSB7XG4gICAgICBhcmdzLnB1c2goJy0tY29kZWMnLCB0aGlzLl9jb2RlYyk7XG4gICAgfVxuICAgIGlmICh0aGlzLl9tYXNrKSB7XG4gICAgICBhcmdzLnB1c2goJy0tbWFzaycsIHRoaXMuX21hc2spO1xuICAgIH1cbiAgICBhcmdzLnB1c2goJy0tZm9yY2UnLCB0aGlzLl92aWRlb1BhdGgpO1xuICAgIHRoaXMuX3Byb2Nlc3MgPSBhd2FpdCBuZXcgU2ltY3RsKCkuZXhlYygnaW8nLCB7XG4gICAgICBhcmdzLFxuICAgICAgYXN5bmNocm9ub3VzOiB0cnVlLFxuICAgIH0pO1xuICAgIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgdmlkZW8gcmVjb3JkaW5nIHdpdGggYXJndW1lbnRzOiAke3V0aWwucXVvdGUoYXJncyl9YCk7XG4gICAgdGhpcy5fcHJvY2Vzcy5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICBjb25zdCBsaW5lID0gXy50cmltKHN0ZG91dCB8fCBzdGRlcnIpO1xuICAgICAgaWYgKGxpbmUpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBbcmVjb3JkVmlkZW9AJHt0aGlzLl91ZGlkLnN1YnN0cmluZygwLCA4KX1dICR7bGluZX1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLl9wcm9jZXNzLm9uY2UoJ2V4aXQnLCBhc3luYyAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICB0aGlzLl9wcm9jZXNzID0gbnVsbDtcbiAgICAgIGlmIChjb2RlID09PSAwKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnU2NyZWVuIHJlY29yZGluZyBleGl0ZWQgd2l0aG91dCBlcnJvcnMnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX2VuZm9yY2VUZXJtaW5hdGlvbigpO1xuICAgICAgICBsb2cud2FybihgU2NyZWVuIHJlY29yZGluZyBleGl0ZWQgd2l0aCBlcnJvciBjb2RlICR7Y29kZX0sIHNpZ25hbCAke3NpZ25hbH1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLl9wcm9jZXNzLnN0YXJ0KDApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLmlzUnVubmluZykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAhIShhd2FpdCB0aGlzLmdldFZpZGVvUGF0aCgpKTtcbiAgICAgIH0sIHtcbiAgICAgICAgd2FpdE1zOiBTVEFSVFVQX1RJTUVPVVRfTVMsXG4gICAgICAgIGludGVydmFsTXM6IFNUQVJUVVBfSU5URVJWQUxfTVMsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBhd2FpdCB0aGlzLl9lbmZvcmNlVGVybWluYXRpb24oKTtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgZXhwZWN0ZWQgc2NyZWVuIHJlY29yZCBmaWxlICcke3RoaXMuX3ZpZGVvUGF0aH0nIGRvZXMgbm90IGV4aXN0IGFmdGVyICR7U1RBUlRVUF9USU1FT1VUX01TfW1zLiBgICtcbiAgICAgICAgYENoZWNrIHRoZSBzZXJ2ZXIgbG9nIGZvciBtb3JlIGRldGFpbHNgKTtcbiAgICB9XG4gICAgdGhpcy5fdGltZXIgPSBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHtcbiAgICAgIGlmICh0aGlzLmlzUnVubmluZykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuc3RvcCgpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgbG9nLmVycm9yKGUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSwgdGhpcy5fdGltZUxpbWl0TXMpO1xuICAgIGxvZy5pbmZvKGBUaGUgdmlkZW8gcmVjb3JkaW5nIGhhcyBzdGFydGVkLiBXaWxsIHRpbWVvdXQgaW4gJHt0aGlzLl90aW1lTGltaXRNc31tc2ApO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoZm9yY2UgPSBmYWxzZSkge1xuICAgIGlmICh0aGlzLl90aW1lcikge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVyKTtcbiAgICAgIHRoaXMuX3RpbWVyID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAoZm9yY2UpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9lbmZvcmNlVGVybWluYXRpb24oKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaXNSdW5uaW5nKSB7XG4gICAgICBsb2cuZGVidWcoJ1NjcmVlbiByZWNvcmRpbmcgaXMgbm90IHJ1bm5pbmcuIFJldHVybmluZyB0aGUgcmVjZW50bHkgcmVjb3JkZWQgdmlkZW8nKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFZpZGVvUGF0aCgpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLl9wcm9jZXNzLnN0b3AoJ1NJR0lOVCcsIFBST0NFU1NfU0hVVERPV05fVElNRU9VVF9NUyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgYXdhaXQgdGhpcy5fZW5mb3JjZVRlcm1pbmF0aW9uKCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFNjcmVlbiByZWNvcmRpbmcgaGFzIGZhaWxlZCB0byBzdG9wIGFmdGVyICR7UFJPQ0VTU19TSFVURE9XTl9USU1FT1VUX01TfW1zYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0VmlkZW9QYXRoKCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZXh0cmFjdFNpbXVsYXRvclVkaWQgKGNhcHMpIHtcbiAgaWYgKGNhcHNbJ3NhZmFyaTp1c2VTaW11bGF0b3InXSA9PT0gZmFsc2UpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IGFsbERldmljZXMgPSBfLmZsYXRNYXAoXy52YWx1ZXMoYXdhaXQgbmV3IFNpbWN0bCgpLmdldERldmljZXMobnVsbCwgJ2lPUycpKSk7XG4gIGZvciAoY29uc3Qge25hbWUsIHVkaWQsIHN0YXRlLCBzZGt9IG9mIGFsbERldmljZXMpIHtcbiAgICBpZiAoc3RhdGUgIT09ICdCb290ZWQnKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAoXy50b0xvd2VyKGNhcHNbJ3NhZmFyaTpkZXZpY2VVRElEJ10pID09PSBfLnRvTG93ZXIodWRpZCkpIHtcbiAgICAgIHJldHVybiB1ZGlkO1xuICAgIH1cbiAgICBpZiAoXy50b0xvd2VyKGNhcHNbJ3NhZmFyaTpkZXZpY2VOYW1lJ10pID09PSBfLnRvTG93ZXIobmFtZSkgJiZcbiAgICAgIChjYXBzWydzYWZhcmk6cGxhdGZvcm1WZXJzaW9uJ10gJiYgY2Fwc1snc2FmYXJpOnBsYXRmb3JtVmVyc2lvbiddID09PSBzZGtcbiAgICAgICAgfHwgIWNhcHNbJ3NhZmFyaTpwbGF0Zm9ybVZlcnNpb24nXSkpIHtcbiAgICAgIHJldHVybiB1ZGlkO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBudWxsO1xufVxuXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RhcnRSZWNvcmRpbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBjb2RlYyBbaGV2Y10gLSBTcGVjaWZpZXMgdGhlIGNvZGVjIHR5cGU6IFwiaDI2NFwiIG9yIFwiaGV2Y1wiXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IGRpc3BsYXkgW2ludGVybmFsXSAtIFN1cHBvcnRzIFwiaW50ZXJuYWxcIiBvciBcImV4dGVybmFsXCIuIERlZmF1bHQgaXMgXCJpbnRlcm5hbFwiXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG1hc2sgLSBGb3Igbm9uLXJlY3Rhbmd1bGFyIGRpc3BsYXlzLCBoYW5kbGUgdGhlIG1hc2sgYnkgcG9saWN5OlxuICogLSBpZ25vcmVkOiBUaGUgbWFzayBpcyBpZ25vcmVkIGFuZCB0aGUgdW5tYXNrZWQgZnJhbWVidWZmZXIgaXMgc2F2ZWQuXG4gKiAtIGFscGhhOiBOb3Qgc3VwcG9ydGVkLCBidXQgcmV0YWluZWQgZm9yIGNvbXBhdGliaWxpdHk7IHRoZSBtYXNrIGlzIHJlbmRlcmVkIGJsYWNrLlxuICogLSBibGFjazogVGhlIG1hc2sgaXMgcmVuZGVyZWQgYmxhY2suXG4gKiBAcHJvcGVydHkge3N0cmluZ3xudW1iZXJ9IHRpbWVMaW1pdCBbNjAwXSAtIFRoZSBtYXhpbXVtIHJlY29yZGluZyB0aW1lLCBpbiBzZWNvbmRzLiBUaGUgZGVmYXVsdFxuICogdmFsdWUgaXMgNjAwIHNlY29uZHMgKDEwIG1pbnV0ZXMpLlxuICogQHByb3BlcnR5IHtib29sZWFufSBmb3JjZVJlc3RhcnQgW3RydWVdIC0gV2hldGhlciB0byBpZ25vcmUgdGhlIGNhbGwgaWYgYSBzY3JlZW4gcmVjb3JkaW5nIGlzIGN1cnJlbnRseSBydW5uaW5nXG4gKiAoYGZhbHNlYCkgb3IgdG8gc3RhcnQgYSBuZXcgcmVjb3JkaW5nIGltbWVkaWF0ZWx5IGFuZCB0ZXJtaW5hdGUgdGhlIGV4aXN0aW5nIG9uZSBpZiBydW5uaW5nIChgdHJ1ZWApLlxuICovXG5cbi8qKlxuICogUmVjb3JkIHRoZSBTaW11bGF0b3IncyBkaXNwbGF5IGluIGJhY2tncm91bmQgd2hpbGUgdGhlIGF1dG9tYXRlZCB0ZXN0IGlzIHJ1bm5pbmcuXG4gKiBUaGlzIG1ldGhvZCB1c2VzIGB4Y3J1biBzaW1jdGwgaW8gcmVjb3JkVmlkZW9gIGhlbHBlciB1bmRlciB0aGUgaG9vZC5cbiAqIENoZWNrIHRoZSBvdXRwdXQgb2YgYHhjcnVuIHNpbWN0bCBpb2AgY29tbWFuZCBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIEBwYXJhbSB7P1N0YXJ0UmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzY3JlZW4gcmVjb3JkaW5nIGhhcyBmYWlsZWQgdG8gc3RhcnQgb3IgaXMgbm90IHN1cHBvcnRlZCBmb3IgdGhlIGRlc3RpbmF0aW9uIGRldmljZS5cbiAqL1xuY29tbWFuZHMuc3RhcnRSZWNvcmRpbmdTY3JlZW4gPSBhc3luYyBmdW5jdGlvbiBzdGFydFJlY29yZGluZ1NjcmVlbiAob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB0aW1lTGltaXQsXG4gICAgY29kZWMsXG4gICAgZGlzcGxheSxcbiAgICBtYXNrLFxuICAgIGZvcmNlUmVzdGFydCA9IHRydWUsXG4gIH0gPSBvcHRpb25zO1xuICBpZiAodGhpcy5fc2NyZWVuUmVjb3JkZXI/LmlzUnVubmluZykge1xuICAgIGxvZy5pbmZvKCdUaGUgc2NyZWVuIHJlY29yZGluZyBpcyBhbHJlYWR5IHJ1bm5pbmcnKTtcbiAgICBpZiAoIWZvcmNlUmVzdGFydCkge1xuICAgICAgbG9nLmluZm8oJ0RvaW5nIG5vdGhpbmcnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbG9nLmluZm8oJ0ZvcmNpbmcgdGhlIGFjdGl2ZSBzY3JlZW4gcmVjb3JkaW5nIHRvIHN0b3AnKTtcbiAgICBhd2FpdCB0aGlzLl9zY3JlZW5SZWNvcmRlci5zdG9wKHRydWUpO1xuICB9XG4gIHRoaXMuX3NjcmVlblJlY29yZGVyID0gbnVsbDtcblxuICBjb25zdCB1ZGlkID0gYXdhaXQgZXh0cmFjdFNpbXVsYXRvclVkaWQodGhpcy5jYXBzKTtcbiAgaWYgKCF1ZGlkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZGV0ZXJtaW5lIFNpbXVsYXRvciBVRElEIHRvIHJlY29yZCB0aGUgdmlkZW8gZnJvbS4gJyArXG4gICAgICAnRG91YmxlIGNoZWNrIHlvdXIgc2Vzc2lvbiBjYXBhYmlsaXRpZXMnKTtcbiAgfVxuXG4gIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCh7XG4gICAgcHJlZml4OiB1dGlsLnV1aWRWNCgpLnN1YnN0cmluZygwLCA4KSxcbiAgICBzdWZmaXg6IERFRkFVTFRfRVhULFxuICB9KTtcbiAgdGhpcy5fc2NyZWVuUmVjb3JkZXIgPSBuZXcgU2NyZWVuUmVjb3JkZXIodWRpZCwgdmlkZW9QYXRoLCB7XG4gICAgdGltZUxpbWl0OiBwYXJzZUludCh0aW1lTGltaXQsIDEwKSxcbiAgICBjb2RlYyxcbiAgICBkaXNwbGF5LFxuICAgIG1hc2ssXG4gIH0pO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuX3NjcmVlblJlY29yZGVyLnN0YXJ0KCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aGlzLl9zY3JlZW5SZWNvcmRlciA9IG51bGw7XG4gICAgdGhyb3cgZTtcbiAgfVxufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTdG9wUmVjb3JkaW5nT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIHRoZSByZW1vdGUgbG9jYXRpb24sIHdoZXJlIHRoZSByZXN1bHRpbmcgdmlkZW8gc2hvdWxkIGJlIHVwbG9hZGVkLlxuICogVGhlIGZvbGxvd2luZyBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZDogaHR0cC9odHRwcywgZnRwLlxuICogTnVsbCBvciBlbXB0eSBzdHJpbmcgdmFsdWUgKHRoZSBkZWZhdWx0IHNldHRpbmcpIG1lYW5zIHRoZSBjb250ZW50IG9mIHJlc3VsdGluZ1xuICogZmlsZSBzaG91bGQgYmUgZW5jb2RlZCBhcyBCYXNlNjQgYW5kIHBhc3NlZCBhcyB0aGUgZW5kcG9pbnQgcmVzcG9uc2UgdmFsdWUuXG4gKiBBbiBleGNlcHRpb24gd2lsbCBiZSB0aHJvd24gaWYgdGhlIGdlbmVyYXRlZCBtZWRpYSBmaWxlIGlzIHRvbyBiaWcgdG9cbiAqIGZpdCBpbnRvIHRoZSBhdmFpbGFibGUgcHJvY2VzcyBtZW1vcnkuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHVzZXIgLSBUaGUgbmFtZSBvZiB0aGUgdXNlciBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGFzcyAtIFRoZSBwYXNzd29yZCBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gbWV0aG9kIC0gVGhlIGh0dHAgbXVsdGlwYXJ0IHVwbG9hZCBtZXRob2QgbmFtZS4gVGhlICdQVVQnIG9uZSBpcyB1c2VkIGJ5IGRlZmF1bHQuXG4gKiBAcHJvcGVydHkgez9PYmplY3R9IGhlYWRlcnMgLSBBZGRpdGlvbmFsIGhlYWRlcnMgbWFwcGluZyBmb3IgbXVsdGlwYXJ0IGh0dHAocykgdXBsb2Fkc1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSBmaWxlRmllbGROYW1lIFtmaWxlXSAtIFRoZSBuYW1lIG9mIHRoZSBmb3JtIGZpZWxkLCB3aGVyZSB0aGUgZmlsZSBjb250ZW50IEJMT0Igc2hvdWxkIGJlIHN0b3JlZCBmb3JcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwKHMpIHVwbG9hZHNcbiAqIEBwcm9wZXJ0eSB7P09iamVjdHxBcnJheTxQYWlyPn0gZm9ybUZpZWxkcyAtIEFkZGl0aW9uYWwgZm9ybSBmaWVsZHMgZm9yIG11bHRpcGFydCBodHRwKHMpIHVwbG9hZHNcbiAqL1xuXG4vKipcbiAqIFN0b3AgcmVjb3JkaW5nIHRoZSBzY3JlZW4uXG4gKiBJZiBubyBzY3JlZW4gcmVjb3JkaW5nIGhhcyBiZWVuIHN0YXJ0ZWQgYmVmb3JlIHRoZW4gdGhlIG1ldGhvZCByZXR1cm5zIGFuIGVtcHR5IHN0cmluZy5cbiAqXG4gKiBAcGFyYW0gez9TdG9wUmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHJlY29yZGVkIG1lZGlhIGZpbGUgaWYgJ3JlbW90ZVBhdGgnXG4gKiBwYXJhbWV0ZXIgaXMgZmFsc3kgb3IgYW4gZW1wdHkgc3RyaW5nLlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBnZXR0aW5nIHRoZSBuYW1lIG9mIGEgbWVkaWEgZmlsZVxuICogb3IgdGhlIGZpbGUgY29udGVudCBjYW5ub3QgYmUgdXBsb2FkZWQgdG8gdGhlIHJlbW90ZSBsb2NhdGlvblxuICogb3Igc2NyZWVuIHJlY29yZGluZyBpcyBub3Qgc3VwcG9ydGVkIG9uIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqL1xuY29tbWFuZHMuc3RvcFJlY29yZGluZ1NjcmVlbiA9IGFzeW5jIGZ1bmN0aW9uIHN0b3BSZWNvcmRpbmdTY3JlZW4gKG9wdGlvbnMgPSB7fSkge1xuICBpZiAoIXRoaXMuX3NjcmVlblJlY29yZGVyKSB7XG4gICAgbG9nLmluZm8oJ05vIHNjcmVlbiByZWNvcmRpbmcgaGFzIGJlZW4gc3RhcnRlZC4gRG9pbmcgbm90aGluZycpO1xuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIGxvZy5kZWJ1ZygnUmV0cmlldmluZyB0aGUgcmVzdWx0aW5nIHZpZGVvIGRhdGEnKTtcbiAgY29uc3QgdmlkZW9QYXRoID0gYXdhaXQgdGhpcy5fc2NyZWVuUmVjb3JkZXIuc3RvcCgpO1xuICBpZiAoIXZpZGVvUGF0aCkge1xuICAgIGxvZy5pbmZvKCdObyB2aWRlbyBkYXRhIGlzIGZvdW5kLiBSZXR1cm5pbmcgYW4gZW1wdHkgc3RyaW5nJyk7XG4gICAgcmV0dXJuICcnO1xuICB9XG4gIHJldHVybiBhd2FpdCB1cGxvYWRSZWNvcmRlZE1lZGlhKHZpZGVvUGF0aCwgb3B0aW9ucy5yZW1vdGVQYXRoLCBvcHRpb25zKTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvcmVjb3JkLXNjcmVlbi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
