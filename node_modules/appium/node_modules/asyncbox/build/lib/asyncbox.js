"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.sleep = sleep;
exports.retry = retry;
exports.nodeify = nodeify;
exports.nodeifyAll = nodeifyAll;
exports.retryInterval = retryInterval;
exports.asyncify = asyncify;
exports.parallel = parallel;
exports.asyncmap = asyncmap;
exports.asyncfilter = asyncfilter;
exports.waitForCondition = waitForCondition;
exports.longSleep = longSleep;

require("source-map-support/register");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _es6Mapify = require("es6-mapify");

var _lodash = _interopRequireDefault(require("lodash"));

const LONG_SLEEP_THRESHOLD = 5000;

async function sleep(ms) {
  return await _bluebird.default.delay(ms);
}

async function longSleep(ms, {
  thresholdMs = LONG_SLEEP_THRESHOLD,
  intervalMs = 1000,
  progressCb = null
} = {}) {
  if (ms < thresholdMs) {
    return await sleep(ms);
  }

  const endAt = Date.now() + ms;
  let timeLeft;
  let elapsedMs = 0;

  do {
    const pre = Date.now();
    await sleep(intervalMs);
    const post = Date.now();
    timeLeft = endAt - post;
    elapsedMs = elapsedMs + (post - pre);

    if (_lodash.default.isFunction(progressCb)) {
      progressCb({
        elapsedMs,
        timeLeft,
        progress: elapsedMs / ms
      });
    }
  } while (timeLeft > 0);
}

async function retry(times, fn, ...args) {
  let tries = 0;
  let done = false;
  let res = null;

  while (!done && tries < times) {
    tries++;

    try {
      res = await fn(...args);
      done = true;
    } catch (err) {
      if (tries >= times) {
        throw err;
      }
    }
  }

  return res;
}

async function retryInterval(times, sleepMs, fn, ...args) {
  let count = 0;

  let wrapped = async () => {
    count++;
    let res;

    try {
      res = await fn(...args);
    } catch (e) {
      if (count !== times) {
        await sleep(sleepMs);
      }

      throw e;
    }

    return res;
  };

  return await retry(times, wrapped);
}

async function parallel(promises) {
  return await _bluebird.default.all(promises);
}

function nodeify(promisey, cb) {
  return _bluebird.default.resolve(promisey).nodeify(cb);
}

function nodeifyAll(promiseyMap) {
  let cbMap = {};

  for (const [name, fn] of (0, _es6Mapify.mapify)(promiseyMap)) {
    cbMap[name] = function (...args) {
      const _cb = args.slice(-1)[0];
      args = args.slice(0, -1);
      nodeify(fn(...args), _cb);
    };
  }

  return cbMap;
}

function asyncify(fn, ...args) {
  _bluebird.default.resolve(fn(...args)).done();
}

async function asyncmap(coll, mapper, runInParallel = true) {
  if (runInParallel) {
    return parallel(coll.map(mapper));
  }

  let newColl = [];

  for (let item of coll) {
    newColl.push(await mapper(item));
  }

  return newColl;
}

async function asyncfilter(coll, filter, runInParallel = true) {
  let newColl = [];

  if (runInParallel) {
    let bools = await parallel(coll.map(filter));

    for (let i = 0; i < coll.length; i++) {
      if (bools[i]) {
        newColl.push(coll[i]);
      }
    }
  } else {
    for (let item of coll) {
      if (await filter(item)) {
        newColl.push(item);
      }
    }
  }

  return newColl;
}

async function waitForCondition(condFn, opts = {}) {
  _lodash.default.defaults(opts, {
    waitMs: 5000,
    intervalMs: 500
  });

  const debug = opts.logger ? opts.logger.debug.bind(opts.logger) : _lodash.default.noop;
  const error = opts.error;
  const begunAt = Date.now();
  const endAt = begunAt + opts.waitMs;

  const spin = async function spin() {
    const result = await condFn();

    if (result) {
      return result;
    }

    const now = Date.now();
    const waited = now - begunAt;
    const remainingTime = endAt - now;

    if (now < endAt) {
      debug(`Waited for ${waited} ms so far`);
      await _bluebird.default.delay(Math.min(opts.intervalMs, remainingTime));
      return await spin();
    }

    throw error ? _lodash.default.isString(error) ? new Error(error) : error : new Error(`Condition unmet after ${waited} ms. Timing out.`);
  };

  return await spin();
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hc3luY2JveC5qcyJdLCJuYW1lcyI6WyJMT05HX1NMRUVQX1RIUkVTSE9MRCIsInNsZWVwIiwibXMiLCJCIiwiZGVsYXkiLCJsb25nU2xlZXAiLCJ0aHJlc2hvbGRNcyIsImludGVydmFsTXMiLCJwcm9ncmVzc0NiIiwiZW5kQXQiLCJEYXRlIiwibm93IiwidGltZUxlZnQiLCJlbGFwc2VkTXMiLCJwcmUiLCJwb3N0IiwiXyIsImlzRnVuY3Rpb24iLCJwcm9ncmVzcyIsInJldHJ5IiwidGltZXMiLCJmbiIsImFyZ3MiLCJ0cmllcyIsImRvbmUiLCJyZXMiLCJlcnIiLCJyZXRyeUludGVydmFsIiwic2xlZXBNcyIsImNvdW50Iiwid3JhcHBlZCIsImUiLCJwYXJhbGxlbCIsInByb21pc2VzIiwiYWxsIiwibm9kZWlmeSIsInByb21pc2V5IiwiY2IiLCJyZXNvbHZlIiwibm9kZWlmeUFsbCIsInByb21pc2V5TWFwIiwiY2JNYXAiLCJuYW1lIiwiX2NiIiwic2xpY2UiLCJhc3luY2lmeSIsImFzeW5jbWFwIiwiY29sbCIsIm1hcHBlciIsInJ1bkluUGFyYWxsZWwiLCJtYXAiLCJuZXdDb2xsIiwiaXRlbSIsInB1c2giLCJhc3luY2ZpbHRlciIsImZpbHRlciIsImJvb2xzIiwiaSIsImxlbmd0aCIsIndhaXRGb3JDb25kaXRpb24iLCJjb25kRm4iLCJvcHRzIiwiZGVmYXVsdHMiLCJ3YWl0TXMiLCJkZWJ1ZyIsImxvZ2dlciIsImJpbmQiLCJub29wIiwiZXJyb3IiLCJiZWd1bkF0Iiwic3BpbiIsInJlc3VsdCIsIndhaXRlZCIsInJlbWFpbmluZ1RpbWUiLCJNYXRoIiwibWluIiwiaXNTdHJpbmciLCJFcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsb0JBQW9CLEdBQUcsSUFBN0I7O0FBRUEsZUFBZUMsS0FBZixDQUFzQkMsRUFBdEIsRUFBMEI7QUFDeEIsU0FBTyxNQUFNQyxr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Q0EsUUFBTUMsS0FBSyxHQUFHUCxJQUFJLENBQUNPLEtBQW5CO0FBQ0EsUUFBTUMsT0FBTyxHQUFHM0QsSUFBSSxDQUFDQyxHQUFMLEVBQWhCO0FBQ0EsUUFBTUYsS0FBSyxHQUFHNEQsT0FBTyxHQUFHUixJQUFJLENBQUNFLE1BQTdCOztBQUNBLFFBQU1PLElBQUksR0FBRyxlQUFlQSxJQUFmLEdBQXVCO0FBQ2xDLFVBQU1DLE1BQU0sR0FBRyxNQUFNWCxNQUFNLEVBQTNCOztBQUNBLFFBQUlXLE1BQUosRUFBWTtBQUNWLGFBQU9BLE1BQVA7QUFDRDs7QUFDRCxVQUFNNUQsR0FBRyxHQUFHRCxJQUFJLENBQUNDLEdBQUwsRUFBWjtBQUNBLFVBQU02RCxNQUFNLEdBQUc3RCxHQUFHLEdBQUcwRCxPQUFyQjtBQUNBLFVBQU1JLGFBQWEsR0FBR2hFLEtBQUssR0FBR0UsR0FBOUI7O0FBQ0EsUUFBSUEsR0FBRyxHQUFHRixLQUFWLEVBQWlCO0FBQ2Z1RCxNQUFBQSxLQUFLLENBQUUsY0FBYVEsTUFBTyxZQUF0QixDQUFMO0FBQ0EsWUFBTXJFLGtCQUFFQyxLQUFGLENBQVFzRSxJQUFJLENBQUNDLEdBQUwsQ0FBU2QsSUFBSSxDQUFDdEQsVUFBZCxFQUEwQmtFLGFBQTFCLENBQVIsQ0FBTjtBQUNBLGFBQU8sTUFBTUgsSUFBSSxFQUFqQjtBQUNEOztBQUVELFVBQU1GLEtBQUssR0FDTnBELGdCQUFFNEQsUUFBRixDQUFXUixLQUFYLElBQW9CLElBQUlTLEtBQUosQ0FBVVQsS0FBVixDQUFwQixHQUF1Q0EsS0FEakMsR0FFUCxJQUFJUyxLQUFKLENBQVcseUJBQXdCTCxNQUFPLGtCQUExQyxDQUZKO0FBR0QsR0FqQkQ7O0FBa0JBLFNBQU8sTUFBTUYsSUFBSSxFQUFqQjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHJhbnNwaWxlOm1haW5cblxuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgbWFwaWZ5IH0gZnJvbSAnZXM2LW1hcGlmeSc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5jb25zdCBMT05HX1NMRUVQX1RIUkVTSE9MRCA9IDUwMDA7IC8vIGFueXRoaW5nIG92ZXIgNTAwMG1zIHdpbGwgdHVybiBpbnRvIGEgc3BpblxuXG5hc3luYyBmdW5jdGlvbiBzbGVlcCAobXMpIHtcbiAgcmV0dXJuIGF3YWl0IEIuZGVsYXkobXMpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBsb25nU2xlZXAgKG1zLCB7XG4gIHRocmVzaG9sZE1zID0gTE9OR19TTEVFUF9USFJFU0hPTEQsXG4gIGludGVydmFsTXMgPSAxMDAwLFxuICBwcm9ncmVzc0NiID0gbnVsbCxcbn0gPSB7fSkge1xuICBpZiAobXMgPCB0aHJlc2hvbGRNcykge1xuICAgIHJldHVybiBhd2FpdCBzbGVlcChtcyk7XG4gIH1cbiAgY29uc3QgZW5kQXQgPSBEYXRlLm5vdygpICsgbXM7XG4gIGxldCB0aW1lTGVmdDtcbiAgbGV0IGVsYXBzZWRNcyA9IDA7XG4gIGRvIHtcbiAgICBjb25zdCBwcmUgPSBEYXRlLm5vdygpO1xuICAgIGF3YWl0IHNsZWVwKGludGVydmFsTXMpO1xuICAgIGNvbnN0IHBvc3QgPSBEYXRlLm5vdygpO1xuICAgIHRpbWVMZWZ0ID0gZW5kQXQgLSBwb3N0O1xuICAgIGVsYXBzZWRNcyA9IGVsYXBzZWRNcyArIChwb3N0IC0gcHJlKTtcbiAgICBpZiAoXy5pc0Z1bmN0aW9uKHByb2dyZXNzQ2IpKSB7XG4gICAgICBwcm9ncmVzc0NiKHtlbGFwc2VkTXMsIHRpbWVMZWZ0LCBwcm9ncmVzczogZWxhcHNlZE1zIC8gbXN9KTtcbiAgICB9XG4gIH0gd2hpbGUgKHRpbWVMZWZ0ID4gMCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJldHJ5ICh0aW1lcywgZm4sIC4uLmFyZ3MpIHtcbiAgbGV0IHRyaWVzID0gMDtcbiAgbGV0IGRvbmUgPSBmYWxzZTtcbiAgbGV0IHJlcyA9IG51bGw7XG4gIHdoaWxlICghZG9uZSAmJiB0cmllcyA8IHRpbWVzKSB7XG4gICAgdHJpZXMrKztcbiAgICB0cnkge1xuICAgICAgcmVzID0gYXdhaXQgZm4oLi4uYXJncyk7XG4gICAgICBkb25lID0gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmICh0cmllcyA+PSB0aW1lcykge1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiByZXM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJldHJ5SW50ZXJ2YWwgKHRpbWVzLCBzbGVlcE1zLCBmbiwgLi4uYXJncykge1xuICBsZXQgY291bnQgPSAwO1xuICBsZXQgd3JhcHBlZCA9IGFzeW5jICgpID0+IHtcbiAgICBjb3VudCsrO1xuICAgIGxldCByZXM7XG4gICAgdHJ5IHtcbiAgICAgIHJlcyA9IGF3YWl0IGZuKC4uLmFyZ3MpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIGRvIG5vdCBwYXVzZSB3aGVuIGZpbmlzaGVkIHRoZSBsYXN0IHJldHJ5XG4gICAgICBpZiAoY291bnQgIT09IHRpbWVzKSB7XG4gICAgICAgIGF3YWl0IHNsZWVwKHNsZWVwTXMpO1xuICAgICAgfVxuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gICAgcmV0dXJuIHJlcztcbiAgfTtcbiAgcmV0dXJuIGF3YWl0IHJldHJ5KHRpbWVzLCB3cmFwcGVkKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcGFyYWxsZWwgKHByb21pc2VzKSB7XG4gIHJldHVybiBhd2FpdCBCLmFsbChwcm9taXNlcyk7XG59XG5cbmZ1bmN0aW9uIG5vZGVpZnkgKHByb21pc2V5LCBjYikgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLWNhbGxiYWNrc1xuICByZXR1cm4gQi5yZXNvbHZlKHByb21pc2V5KS5ub2RlaWZ5KGNiKTtcbn1cblxuZnVuY3Rpb24gbm9kZWlmeUFsbCAocHJvbWlzZXlNYXApIHtcbiAgbGV0IGNiTWFwID0ge307XG4gIGZvciAoY29uc3QgW25hbWUsIGZuXSBvZiBtYXBpZnkocHJvbWlzZXlNYXApKSB7XG4gICAgY2JNYXBbbmFtZV0gPSBmdW5jdGlvbiAoLi4uYXJncykge1xuICAgICAgY29uc3QgX2NiID0gYXJncy5zbGljZSgtMSlbMF07XG4gICAgICBhcmdzID0gYXJncy5zbGljZSgwLCAtMSk7XG4gICAgICBub2RlaWZ5KGZuKC4uLmFyZ3MpLCBfY2IpO1xuICAgIH07XG4gIH1cbiAgcmV0dXJuIGNiTWFwO1xufVxuXG5mdW5jdGlvbiBhc3luY2lmeSAoZm4sIC4uLmFyZ3MpIHtcbiAgQi5yZXNvbHZlKGZuKC4uLmFyZ3MpKS5kb25lKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGFzeW5jbWFwIChjb2xsLCBtYXBwZXIsIHJ1bkluUGFyYWxsZWwgPSB0cnVlKSB7XG4gIGlmIChydW5JblBhcmFsbGVsKSB7XG4gICAgcmV0dXJuIHBhcmFsbGVsKGNvbGwubWFwKG1hcHBlcikpO1xuICB9XG5cbiAgbGV0IG5ld0NvbGwgPSBbXTtcbiAgZm9yIChsZXQgaXRlbSBvZiBjb2xsKSB7XG4gICAgbmV3Q29sbC5wdXNoKGF3YWl0IG1hcHBlcihpdGVtKSk7XG4gIH1cbiAgcmV0dXJuIG5ld0NvbGw7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGFzeW5jZmlsdGVyIChjb2xsLCBmaWx0ZXIsIHJ1bkluUGFyYWxsZWwgPSB0cnVlKSB7XG4gIGxldCBuZXdDb2xsID0gW107XG4gIGlmIChydW5JblBhcmFsbGVsKSB7XG4gICAgbGV0IGJvb2xzID0gYXdhaXQgcGFyYWxsZWwoY29sbC5tYXAoZmlsdGVyKSk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb2xsLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoYm9vbHNbaV0pIHtcbiAgICAgICAgbmV3Q29sbC5wdXNoKGNvbGxbaV0pO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBmb3IgKGxldCBpdGVtIG9mIGNvbGwpIHtcbiAgICAgIGlmIChhd2FpdCBmaWx0ZXIoaXRlbSkpIHtcbiAgICAgICAgbmV3Q29sbC5wdXNoKGl0ZW0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gbmV3Q29sbDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gd2FpdEZvckNvbmRpdGlvbiAoY29uZEZuLCBvcHRzID0ge30pIHtcbiAgXy5kZWZhdWx0cyhvcHRzLCB7XG4gICAgd2FpdE1zOiA1MDAwLFxuICAgIGludGVydmFsTXM6IDUwMCxcbiAgfSk7XG4gIGNvbnN0IGRlYnVnID0gb3B0cy5sb2dnZXIgPyBvcHRzLmxvZ2dlci5kZWJ1Zy5iaW5kKG9wdHMubG9nZ2VyKSA6IF8ubm9vcDtcbiAgY29uc3QgZXJyb3IgPSBvcHRzLmVycm9yO1xuICBjb25zdCBiZWd1bkF0ID0gRGF0ZS5ub3coKTtcbiAgY29uc3QgZW5kQXQgPSBiZWd1bkF0ICsgb3B0cy53YWl0TXM7XG4gIGNvbnN0IHNwaW4gPSBhc3luYyBmdW5jdGlvbiBzcGluICgpIHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb25kRm4oKTtcbiAgICBpZiAocmVzdWx0KSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IHdhaXRlZCA9IG5vdyAtIGJlZ3VuQXQ7XG4gICAgY29uc3QgcmVtYWluaW5nVGltZSA9IGVuZEF0IC0gbm93O1xuICAgIGlmIChub3cgPCBlbmRBdCkge1xuICAgICAgZGVidWcoYFdhaXRlZCBmb3IgJHt3YWl0ZWR9IG1zIHNvIGZhcmApO1xuICAgICAgYXdhaXQgQi5kZWxheShNYXRoLm1pbihvcHRzLmludGVydmFsTXMsIHJlbWFpbmluZ1RpbWUpKTtcbiAgICAgIHJldHVybiBhd2FpdCBzcGluKCk7XG4gICAgfVxuICAgIC8vIGlmIHRoZXJlIGlzIGFuIGVycm9yIG9wdGlvbiwgaXQgaXMgZWl0aGVyIGEgc3RyaW5nIG1lc3NhZ2Ugb3IgYW4gZXJyb3IgaXRzZWxmXG4gICAgdGhyb3cgZXJyb3JcbiAgICAgID8gKF8uaXNTdHJpbmcoZXJyb3IpID8gbmV3IEVycm9yKGVycm9yKSA6IGVycm9yKVxuICAgICAgOiBuZXcgRXJyb3IoYENvbmRpdGlvbiB1bm1ldCBhZnRlciAke3dhaXRlZH0gbXMuIFRpbWluZyBvdXQuYCk7XG4gIH07XG4gIHJldHVybiBhd2FpdCBzcGluKCk7XG59XG5cbmV4cG9ydCB7XG4gIHNsZWVwLCByZXRyeSwgbm9kZWlmeSwgbm9kZWlmeUFsbCwgcmV0cnlJbnRlcnZhbCwgYXN5bmNpZnksIHBhcmFsbGVsLFxuICBhc3luY21hcCwgYXN5bmNmaWx0ZXIsIHdhaXRGb3JDb25kaXRpb24sIGxvbmdTbGVlcCxcbn07XG4iXSwiZmlsZSI6ImxpYi9hc3luY2JveC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
