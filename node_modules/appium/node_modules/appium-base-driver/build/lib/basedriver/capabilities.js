"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parseCaps = parseCaps;
exports.processCapabilities = processCapabilities;
exports.validateCaps = validateCaps;
exports.mergeCaps = mergeCaps;
exports.findNonPrefixedCaps = findNonPrefixedCaps;
exports.isStandardCap = isStandardCap;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _desiredCaps = require("./desired-caps");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("./logger"));

var _errors = require("../protocol/errors");

function mergeCaps(primary = {}, secondary = {}) {
  let result = Object.assign({}, primary);

  for (let [name, value] of _lodash.default.toPairs(secondary)) {
    if (!_lodash.default.isUndefined(primary[name])) {
      throw new _errors.errors.InvalidArgumentError(`property '${name}' should not exist on both primary (${JSON.stringify(primary)}) and secondary (${JSON.stringify(secondary)}) object`);
    }

    result[name] = value;
  }

  return result;
}

function validateCaps(caps, constraints = {}, opts = {}) {
  let {
    skipPresenceConstraint
  } = opts;

  if (!_lodash.default.isPlainObject(caps)) {
    throw new _errors.errors.InvalidArgumentError(`must be a JSON object`);
  }

  constraints = _lodash.default.cloneDeep(constraints);

  if (skipPresenceConstraint) {
    for (let key of _lodash.default.keys(constraints)) {
      delete constraints[key].presence;
    }
  }

  let validationErrors = _desiredCaps.validator.validate(_lodash.default.pickBy(caps, _appiumSupport.util.hasValue), constraints, {
    fullMessages: false
  });

  if (validationErrors) {
    let message = [];

    for (let [attribute, reasons] of _lodash.default.toPairs(validationErrors)) {
      for (let reason of reasons) {
        message.push(`'${attribute}' ${reason}`);
      }
    }

    throw new _errors.errors.InvalidArgumentError(message.join('; '));
  }

  return caps;
}

const STANDARD_CAPS = ['browserName', 'browserVersion', 'platformName', 'acceptInsecureCerts', 'pageLoadStrategy', 'proxy', 'setWindowRect', 'timeouts', 'unhandledPromptBehavior'];

function isStandardCap(cap) {
  return !!_lodash.default.find(STANDARD_CAPS, standardCap => standardCap.toLowerCase() === `${cap}`.toLowerCase());
}

function stripAppiumPrefixes(caps) {
  const prefix = 'appium:';

  const prefixedCaps = _lodash.default.filter(_lodash.default.keys(caps), cap => `${cap}`.startsWith(prefix));

  const badPrefixedCaps = [];

  for (let prefixedCap of prefixedCaps) {
    const strippedCapName = prefixedCap.substr(prefix.length);

    if (isStandardCap(strippedCapName)) {
      badPrefixedCaps.push(strippedCapName);

      if (_lodash.default.isNil(caps[strippedCapName])) {
        caps[strippedCapName] = caps[prefixedCap];
      } else {
        _logger.default.warn(`Ignoring capability '${prefixedCap}=${caps[prefixedCap]}' and ` + `using capability '${strippedCapName}=${caps[strippedCapName]}'`);
      }
    } else {
      caps[strippedCapName] = caps[prefixedCap];
    }

    delete caps[prefixedCap];
  }

  if (badPrefixedCaps.length > 0) {
    _logger.default.warn(`The capabilities ${JSON.stringify(badPrefixedCaps)} are standard capabilities and do not require "appium:" prefix`);
  }
}

function findNonPrefixedCaps({
  alwaysMatch = {},
  firstMatch = []
}) {
  return _lodash.default.chain([alwaysMatch, ...firstMatch]).reduce((unprefixedCaps, caps) => [...unprefixedCaps, ...(0, _lodash.default)(caps).keys().filter(cap => !cap.includes(':') && !isStandardCap(cap))], []).uniq().value();
}

function parseCaps(caps, constraints = {}, shouldValidateCaps = true) {
  if (!_lodash.default.isPlainObject(caps)) {
    throw new _errors.errors.InvalidArgumentError('The capabilities argument was not valid for the following reason(s): "capabilities" must be a JSON object.');
  }

  let {
    alwaysMatch: requiredCaps = {},
    firstMatch: allFirstMatchCaps = [{}]
  } = caps;

  if (!_lodash.default.isArray(allFirstMatchCaps)) {
    throw new _errors.errors.InvalidArgumentError('The capabilities.firstMatch argument was not valid for the following reason(s): "capabilities.firstMatch" must be a JSON array or undefined');
  }

  if (allFirstMatchCaps.length === 0) {
    allFirstMatchCaps.push({});
  }

  let nonPrefixedCaps = findNonPrefixedCaps(caps);

  if (!_lodash.default.isEmpty(nonPrefixedCaps)) {
    _logger.default.warn(`The following capabilities are not standard capabilities and should have an extension prefix:`);

    for (const cap of nonPrefixedCaps) {
      _logger.default.warn(`  ${cap}`);
    }
  }

  stripAppiumPrefixes(requiredCaps);

  for (let firstMatchCaps of allFirstMatchCaps) {
    stripAppiumPrefixes(firstMatchCaps);
  }

  if (shouldValidateCaps) {
    requiredCaps = validateCaps(requiredCaps, constraints, {
      skipPresenceConstraint: true
    });
  }

  let filteredConstraints = { ...constraints
  };

  let requiredCapsKeys = _lodash.default.keys(requiredCaps);

  for (let key of _lodash.default.keys(filteredConstraints)) {
    if (requiredCapsKeys.includes(key)) {
      delete filteredConstraints[key];
    }
  }

  let validationErrors = [];
  let validatedFirstMatchCaps = allFirstMatchCaps.map(firstMatchCaps => {
    try {
      return shouldValidateCaps ? validateCaps(firstMatchCaps, filteredConstraints) : firstMatchCaps;
    } catch (e) {
      validationErrors.push(e.message);
      return null;
    }
  }).filter(caps => !_lodash.default.isNull(caps));
  let matchedCaps = null;

  for (let firstMatchCaps of validatedFirstMatchCaps) {
    try {
      matchedCaps = mergeCaps(requiredCaps, firstMatchCaps);

      if (matchedCaps) {
        break;
      }
    } catch (err) {
      _logger.default.warn(err.message);

      validationErrors.push(err.message);
    }
  }

  return {
    requiredCaps,
    allFirstMatchCaps,
    validatedFirstMatchCaps,
    matchedCaps,
    validationErrors
  };
}

function processCapabilities(caps, constraints = {}, shouldValidateCaps = true) {
  const {
    matchedCaps,
    validationErrors
  } = parseCaps(caps, constraints, shouldValidateCaps);

  if (!_appiumSupport.util.hasValue(matchedCaps)) {
    if (_lodash.default.isArray(caps.firstMatch) && caps.firstMatch.length > 1) {
      throw new _errors.errors.InvalidArgumentError(`Could not find matching capabilities from ${JSON.stringify(caps)}:\n ${validationErrors.join('\n')}`);
    } else {
      throw new _errors.errors.InvalidArgumentError(validationErrors[0]);
    }
  }

  return matchedCaps;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NhcGFiaWxpdGllcy5qcyJdLCJuYW1lcyI6WyJtZXJnZUNhcHMiLCJwcmltYXJ5Iiwic2Vjb25kYXJ5IiwicmVzdWx0IiwiT2JqZWN0IiwiYXNzaWduIiwibmFtZSIsInZhbHVlIiwiXyIsInRvUGFpcnMiLCJpc1VuZGVmaW5lZCIsImVycm9ycyIsIkludmFsaWRBcmd1bWVudEVycm9yIiwiSlNPTiIsInN0cmluZ2lmeSIsInZhbGlkYXRlQ2FwcyIsImNhcHMiLCJjb25zdHJhaW50cyIsIm9wdHMiLCJza2lwUHJlc2VuY2VDb25zdHJhaW50IiwiaXNQbGFpbk9iamVjdCIsImNsb25lRGVlcCIsImtleSIsImtleXMiLCJwcmVzZW5jZSIsInZhbGlkYXRpb25FcnJvcnMiLCJ2YWxpZGF0b3IiLCJ2YWxpZGF0ZSIsInBpY2tCeSIsInV0aWwiLCJoYXNWYWx1ZSIsImZ1bGxNZXNzYWdlcyIsIm1lc3NhZ2UiLCJhdHRyaWJ1dGUiLCJyZWFzb25zIiwicmVhc29uIiwicHVzaCIsImpvaW4iLCJTVEFOREFSRF9DQVBTIiwiaXNTdGFuZGFyZENhcCIsImNhcCIsImZpbmQiLCJzdGFuZGFyZENhcCIsInRvTG93ZXJDYXNlIiwic3RyaXBBcHBpdW1QcmVmaXhlcyIsInByZWZpeCIsInByZWZpeGVkQ2FwcyIsImZpbHRlciIsInN0YXJ0c1dpdGgiLCJiYWRQcmVmaXhlZENhcHMiLCJwcmVmaXhlZENhcCIsInN0cmlwcGVkQ2FwTmFtZSIsInN1YnN0ciIsImxlbmd0aCIsImlzTmlsIiwibG9nIiwid2FybiIsImZpbmROb25QcmVmaXhlZENhcHMiLCJhbHdheXNNYXRjaCIsImZpcnN0TWF0Y2giLCJjaGFpbiIsInJlZHVjZSIsInVucHJlZml4ZWRDYXBzIiwiaW5jbHVkZXMiLCJ1bmlxIiwicGFyc2VDYXBzIiwic2hvdWxkVmFsaWRhdGVDYXBzIiwicmVxdWlyZWRDYXBzIiwiYWxsRmlyc3RNYXRjaENhcHMiLCJpc0FycmF5Iiwibm9uUHJlZml4ZWRDYXBzIiwiaXNFbXB0eSIsImZpcnN0TWF0Y2hDYXBzIiwiZmlsdGVyZWRDb25zdHJhaW50cyIsInJlcXVpcmVkQ2Fwc0tleXMiLCJ2YWxpZGF0ZWRGaXJzdE1hdGNoQ2FwcyIsIm1hcCIsImUiLCJpc051bGwiLCJtYXRjaGVkQ2FwcyIsImVyciIsInByb2Nlc3NDYXBhYmlsaXRpZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFJQSxTQUFTQSxTQUFULENBQW9CQyxPQUFPLEdBQUcsRUFBOUIsRUFBa0NDLFNBQVMsR0FBRyxFQUE5QyxFQUFrRDtBQUNoRCxNQUFJQyxNQUFNLEdBQUdDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JKLE9BQWxCLENBQWI7O0FBRUEsT0FBSyxJQUFJLENBQUNLLElBQUQsRUFBT0MsS0FBUCxDQUFULElBQTBCQyxnQkFBRUMsT0FBRixDQUFVUCxTQUFWLENBQTFCLEVBQWdEO0FBRTlDLFFBQUksQ0FBQ00sZ0JBQUVFLFdBQUYsQ0FBY1QsT0FBTyxDQUFDSyxJQUFELENBQXJCLENBQUwsRUFBbUM7QUFDakMsWUFBTSxJQUFJSyxlQUFPQyxvQkFBWCxDQUFpQyxhQUFZTixJQUFLLHVDQUFzQ08sSUFBSSxDQUFDQyxTQUFMLENBQWViLE9BQWYsQ0FBd0Isb0JBQW1CWSxJQUFJLENBQUNDLFNBQUwsQ0FBZVosU0FBZixDQUEwQixVQUE3SixDQUFOO0FBQ0Q7O0FBQ0RDLElBQUFBLE1BQU0sQ0FBQ0csSUFBRCxDQUFOLEdBQWVDLEtBQWY7QUFDRDs7QUFFRCxTQUFPSixNQUFQO0FBQ0Q7O0FBR0QsU0FBU1ksWUFBVCxDQUF1QkMsSUFBdkIsRUFBNkJDLFdBQVcsR0FBRyxFQUEzQyxFQUErQ0MsSUFBSSxHQUFHLEVBQXRELEVBQTBEO0FBRXhELE1BQUk7QUFBQ0MsSUFBQUE7QUFBRCxNQUEyQkQsSUFBL0I7O0FBRUEsTUFBSSxDQUFDVixnQkFBRVksYUFBRixDQUFnQkosSUFBaEIsQ0FBTCxFQUE0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QUF4RSxHQUFQO0FBQ0Q7O0FBR0QsU0FBU3dELG1CQUFULENBQThCakUsSUFBOUIsRUFBb0NDLFdBQVcsR0FBRyxFQUFsRCxFQUFzRGlELGtCQUFrQixHQUFHLElBQTNFLEVBQWlGO0FBQy9FLFFBQU07QUFBQ2EsSUFBQUEsV0FBRDtBQUFjdEQsSUFBQUE7QUFBZCxNQUFrQ3dDLFNBQVMsQ0FBQ2pELElBQUQsRUFBT0MsV0FBUCxFQUFvQmlELGtCQUFwQixDQUFqRDs7QUFHQSxNQUFJLENBQUNyQyxvQkFBS0MsUUFBTCxDQUFjaUQsV0FBZCxDQUFMLEVBQWlDO0FBQy9CLFFBQUl2RSxnQkFBRTZELE9BQUYsQ0FBVXJELElBQUksQ0FBQzJDLFVBQWYsS0FBOEIzQyxJQUFJLENBQUMyQyxVQUFMLENBQWdCTixNQUFoQixHQUF5QixDQUEzRCxFQUE4RDtBQUU1RCxZQUFNLElBQUkxQyxlQUFPQyxvQkFBWCxDQUFpQyw2Q0FBNENDLElBQUksQ0FBQ0MsU0FBTCxDQUFlRSxJQUFmLENBQXFCLE9BQU1TLGdCQUFnQixDQUFDWSxJQUFqQixDQUFzQixJQUF0QixDQUE0QixFQUFwSSxDQUFOO0FBQ0QsS0FIRCxNQUdPO0FBRUwsWUFBTSxJQUFJMUIsZUFBT0Msb0JBQVgsQ0FBZ0NhLGdCQUFnQixDQUFDLENBQUQsQ0FBaEQsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQsU0FBT3NELFdBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyB2YWxpZGF0b3IgfSBmcm9tICcuL2Rlc2lyZWQtY2Fwcyc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICcuLi9wcm90b2NvbC9lcnJvcnMnO1xuXG4vLyBUYWtlcyBwcmltYXJ5IGNhcHMgb2JqZWN0IGFuZCBtZXJnZXMgaXQgaW50byBhIHNlY29uZGFyeSBjYXBzIG9iamVjdC5cbi8vIChzZWUgaHR0cHM6Ly93d3cudzMub3JnL1RSL3dlYmRyaXZlci8jZGZuLW1lcmdpbmctY2FwYWJpbGl0aWVzKVxuZnVuY3Rpb24gbWVyZ2VDYXBzIChwcmltYXJ5ID0ge30sIHNlY29uZGFyeSA9IHt9KSB7XG4gIGxldCByZXN1bHQgPSBPYmplY3QuYXNzaWduKHt9LCBwcmltYXJ5KTtcblxuICBmb3IgKGxldCBbbmFtZSwgdmFsdWVdIG9mIF8udG9QYWlycyhzZWNvbmRhcnkpKSB7XG4gICAgLy8gT3ZlcndyaXRpbmcgaXMgbm90IGFsbG93ZWQuIFByaW1hcnkgYW5kIHNlY29uZGFyeSBtdXN0IGhhdmUgZGlmZmVyZW50IHByb3BlcnRpZXMgKHczYyBydWxlIDQuNClcbiAgICBpZiAoIV8uaXNVbmRlZmluZWQocHJpbWFyeVtuYW1lXSkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoYHByb3BlcnR5ICcke25hbWV9JyBzaG91bGQgbm90IGV4aXN0IG9uIGJvdGggcHJpbWFyeSAoJHtKU09OLnN0cmluZ2lmeShwcmltYXJ5KX0pIGFuZCBzZWNvbmRhcnkgKCR7SlNPTi5zdHJpbmdpZnkoc2Vjb25kYXJ5KX0pIG9iamVjdGApO1xuICAgIH1cbiAgICByZXN1bHRbbmFtZV0gPSB2YWx1ZTtcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cbi8vIFZhbGlkYXRlcyBjYXBzIGFnYWluc3QgYSBzZXQgb2YgY29uc3RyYWludHNcbmZ1bmN0aW9uIHZhbGlkYXRlQ2FwcyAoY2FwcywgY29uc3RyYWludHMgPSB7fSwgb3B0cyA9IHt9KSB7XG5cbiAgbGV0IHtza2lwUHJlc2VuY2VDb25zdHJhaW50fSA9IG9wdHM7XG5cbiAgaWYgKCFfLmlzUGxhaW5PYmplY3QoY2FwcykpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRBcmd1bWVudEVycm9yKGBtdXN0IGJlIGEgSlNPTiBvYmplY3RgKTtcbiAgfVxuXG4gIGNvbnN0cmFpbnRzID0gXy5jbG9uZURlZXAoY29uc3RyYWludHMpOyAvLyBEZWZlbnNpdmUgY29weVxuXG4gIGlmIChza2lwUHJlc2VuY2VDb25zdHJhaW50KSB7XG4gICAgLy8gUmVtb3ZlIHRoZSAncHJlc2VuY2UnIGNvbnN0cmFpbnQgaWYgd2UncmUgbm90IGNoZWNraW5nIGZvciBpdFxuICAgIGZvciAobGV0IGtleSBvZiBfLmtleXMoY29uc3RyYWludHMpKSB7XG4gICAgICBkZWxldGUgY29uc3RyYWludHNba2V5XS5wcmVzZW5jZTtcbiAgICB9XG4gIH1cblxuICBsZXQgdmFsaWRhdGlvbkVycm9ycyA9IHZhbGlkYXRvci52YWxpZGF0ZShfLnBpY2tCeShjYXBzLCB1dGlsLmhhc1ZhbHVlKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdHJhaW50cyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7ZnVsbE1lc3NhZ2VzOiBmYWxzZX0pO1xuXG4gIGlmICh2YWxpZGF0aW9uRXJyb3JzKSB7XG4gICAgbGV0IG1lc3NhZ2UgPSBbXTtcbiAgICBmb3IgKGxldCBbYXR0cmlidXRlLCByZWFzb25zXSBvZiBfLnRvUGFpcnModmFsaWRhdGlvbkVycm9ycykpIHtcbiAgICAgIGZvciAobGV0IHJlYXNvbiBvZiByZWFzb25zKSB7XG4gICAgICAgIG1lc3NhZ2UucHVzaChgJyR7YXR0cmlidXRlfScgJHtyZWFzb259YCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IobWVzc2FnZS5qb2luKCc7ICcpKTtcbiAgfVxuXG4gIC8vIFJldHVybiBjYXBzXG4gIHJldHVybiBjYXBzO1xufVxuXG4vLyBTdGFuZGFyZCwgbm9uLXByZWZpeGVkIGNhcGFiaWxpdGllcyAoc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi93ZWJkcml2ZXIvI2Rmbi10YWJsZS1vZi1zdGFuZGFyZC1jYXBhYmlsaXRpZXMpXG5jb25zdCBTVEFOREFSRF9DQVBTID0gW1xuICAnYnJvd3Nlck5hbWUnLFxuICAnYnJvd3NlclZlcnNpb24nLFxuICAncGxhdGZvcm1OYW1lJyxcbiAgJ2FjY2VwdEluc2VjdXJlQ2VydHMnLFxuICAncGFnZUxvYWRTdHJhdGVneScsXG4gICdwcm94eScsXG4gICdzZXRXaW5kb3dSZWN0JyxcbiAgJ3RpbWVvdXRzJyxcbiAgJ3VuaGFuZGxlZFByb21wdEJlaGF2aW9yJ1xuXTtcblxuZnVuY3Rpb24gaXNTdGFuZGFyZENhcCAoY2FwKSB7XG4gIHJldHVybiAhIV8uZmluZChTVEFOREFSRF9DQVBTLCAoc3RhbmRhcmRDYXApID0+IHN0YW5kYXJkQ2FwLnRvTG93ZXJDYXNlKCkgPT09IGAke2NhcH1gLnRvTG93ZXJDYXNlKCkpO1xufVxuXG4vLyBJZiB0aGUgJ2FwcGl1bTonIHByZWZpeCB3YXMgcHJvdmlkZWQgYW5kIGl0J3MgYSB2YWxpZCBjYXBhYmlsaXR5LCBzdHJpcCBvdXQgdGhlIHByZWZpeCAoc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi93ZWJkcml2ZXIvI2Rmbi1leHRlbnNpb24tY2FwYWJpbGl0aWVzKVxuLy8gKE5PVEU6IE1ldGhvZCBpcyBkZXN0cnVjdGl2ZSBhbmQgbXV0YXRlcyBjb250ZW50cyBvZiBjYXBzKVxuZnVuY3Rpb24gc3RyaXBBcHBpdW1QcmVmaXhlcyAoY2Fwcykge1xuICBjb25zdCBwcmVmaXggPSAnYXBwaXVtOic7XG4gIGNvbnN0IHByZWZpeGVkQ2FwcyA9IF8uZmlsdGVyKF8ua2V5cyhjYXBzKSwgKGNhcCkgPT4gYCR7Y2FwfWAuc3RhcnRzV2l0aChwcmVmaXgpKTtcbiAgY29uc3QgYmFkUHJlZml4ZWRDYXBzID0gW107XG5cbiAgLy8gU3RyaXAgb3V0IHRoZSAnYXBwaXVtOicgcHJlZml4XG4gIGZvciAobGV0IHByZWZpeGVkQ2FwIG9mIHByZWZpeGVkQ2Fwcykge1xuICAgIGNvbnN0IHN0cmlwcGVkQ2FwTmFtZSA9IHByZWZpeGVkQ2FwLnN1YnN0cihwcmVmaXgubGVuZ3RoKTtcblxuICAgIC8vIElmIGl0J3Mgc3RhbmRhcmQgY2FwYWJpbGl0eSB0aGF0IHdhcyBwcmVmaXhlZCwgYWRkIGl0IHRvIGFuIGFycmF5IG9mIGluY29ycmVjdGx5IHByZWZpeGVkIGNhcGFiaWxpdGllc1xuICAgIGlmIChpc1N0YW5kYXJkQ2FwKHN0cmlwcGVkQ2FwTmFtZSkpIHtcbiAgICAgIGJhZFByZWZpeGVkQ2Fwcy5wdXNoKHN0cmlwcGVkQ2FwTmFtZSk7XG4gICAgICBpZiAoXy5pc05pbChjYXBzW3N0cmlwcGVkQ2FwTmFtZV0pKSB7XG4gICAgICAgIGNhcHNbc3RyaXBwZWRDYXBOYW1lXSA9IGNhcHNbcHJlZml4ZWRDYXBdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLndhcm4oYElnbm9yaW5nIGNhcGFiaWxpdHkgJyR7cHJlZml4ZWRDYXB9PSR7Y2Fwc1twcmVmaXhlZENhcF19JyBhbmQgYCArXG4gICAgICAgICAgYHVzaW5nIGNhcGFiaWxpdHkgJyR7c3RyaXBwZWRDYXBOYW1lfT0ke2NhcHNbc3RyaXBwZWRDYXBOYW1lXX0nYCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNhcHNbc3RyaXBwZWRDYXBOYW1lXSA9IGNhcHNbcHJlZml4ZWRDYXBdO1xuICAgIH1cblxuICAgIC8vIFN0cmlwIG91dCB0aGUgcHJlZml4XG4gICAgZGVsZXRlIGNhcHNbcHJlZml4ZWRDYXBdO1xuICB9XG5cbiAgLy8gSWYgd2UgZm91bmQgc3RhbmRhcmQgY2FwcyB0aGF0IHdlcmUgaW5jb3JyZWN0bHkgcHJlZml4ZWQsIHRocm93IGFuIGV4Y2VwdGlvbiAoZS5nLjogZG9uJ3QgYWNjZXB0ICdhcHBpdW06cGxhdGZvcm1OYW1lJywgb25seSBhY2NlcHQganVzdCAncGxhdGZvcm1OYW1lJylcbiAgaWYgKGJhZFByZWZpeGVkQ2Fwcy5sZW5ndGggPiAwKSB7XG4gICAgbG9nLndhcm4oYFRoZSBjYXBhYmlsaXRpZXMgJHtKU09OLnN0cmluZ2lmeShiYWRQcmVmaXhlZENhcHMpfSBhcmUgc3RhbmRhcmQgY2FwYWJpbGl0aWVzIGFuZCBkbyBub3QgcmVxdWlyZSBcImFwcGl1bTpcIiBwcmVmaXhgKTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCBhbiBhcnJheSBvZiBhbGwgdGhlIHVucHJlZml4ZWQgY2FwcyB0aGF0IGFyZSBiZWluZyB1c2VkIGluICdhbHdheXNNYXRjaCcgYW5kIGFsbCBvZiB0aGUgJ2ZpcnN0TWF0Y2gnIG9iamVjdFxuICogQHBhcmFtIHtPYmplY3R9IGNhcHMgQSBjYXBhYmlsaXRpZXMgb2JqZWN0XG4gKi9cbmZ1bmN0aW9uIGZpbmROb25QcmVmaXhlZENhcHMgKHthbHdheXNNYXRjaCA9IHt9LCBmaXJzdE1hdGNoID0gW119KSB7XG4gIHJldHVybiBfLmNoYWluKFthbHdheXNNYXRjaCwgLi4uZmlyc3RNYXRjaF0pXG4gICAgLnJlZHVjZSgodW5wcmVmaXhlZENhcHMsIGNhcHMpID0+IFtcbiAgICAgIC4uLnVucHJlZml4ZWRDYXBzLFxuICAgICAgLi4uXyhjYXBzKS5rZXlzKCkuZmlsdGVyKChjYXApID0+ICFjYXAuaW5jbHVkZXMoJzonKSAmJiAhaXNTdGFuZGFyZENhcChjYXApKSxcbiAgICBdLCBbXSlcbiAgICAudW5pcSgpXG4gICAgLnZhbHVlKCk7XG59XG5cbi8vIFBhcnNlIGNhcGFiaWxpdGllcyAoYmFzZWQgb24gaHR0cHM6Ly93d3cudzMub3JnL1RSL3dlYmRyaXZlci8jcHJvY2Vzc2luZy1jYXBhYmlsaXRpZXMpXG5mdW5jdGlvbiBwYXJzZUNhcHMgKGNhcHMsIGNvbnN0cmFpbnRzID0ge30sIHNob3VsZFZhbGlkYXRlQ2FwcyA9IHRydWUpIHtcbiAgLy8gSWYgY2FwYWJpbGl0aWVzIHJlcXVlc3QgaXMgbm90IGFuIG9iamVjdCwgcmV0dXJuIGVycm9yICgjMS4xKVxuICBpZiAoIV8uaXNQbGFpbk9iamVjdChjYXBzKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoJ1RoZSBjYXBhYmlsaXRpZXMgYXJndW1lbnQgd2FzIG5vdCB2YWxpZCBmb3IgdGhlIGZvbGxvd2luZyByZWFzb24ocyk6IFwiY2FwYWJpbGl0aWVzXCIgbXVzdCBiZSBhIEpTT04gb2JqZWN0LicpO1xuICB9XG5cbiAgLy8gTGV0ICdyZXF1aXJlZENhcHMnIGJlIHByb3BlcnR5IG5hbWVkICdhbHdheXNNYXRjaCcgZnJvbSBjYXBhYmlsaXRpZXMgcmVxdWVzdCAoIzIpXG4gIC8vIGFuZCAnYWxsRmlyc3RNYXRjaENhcHMnIGJlIHByb3BlcnR5IG5hbWVkICdmaXJzdE1hdGNoJyBmcm9tIGNhcGFiaWxpdGllcyByZXF1ZXN0ICgjMylcbiAgbGV0IHtcbiAgICBhbHdheXNNYXRjaDogcmVxdWlyZWRDYXBzID0ge30sIC8vIElmICdyZXF1aXJlZENhcHMnIGlzIHVuZGVmaW5lZCwgc2V0IGl0IHRvIGFuIGVtcHR5IEpTT04gb2JqZWN0ICgjMi4xKVxuICAgIGZpcnN0TWF0Y2g6IGFsbEZpcnN0TWF0Y2hDYXBzID0gW3t9XSwgLy8gSWYgJ2ZpcnN0TWF0Y2gnIGlzIHVuZGVmaW5lZCBzZXQgaXQgdG8gYSBzaW5nbGV0b24gbGlzdCB3aXRoIG9uZSBlbXB0eSBvYmplY3QgKCMzLjEpXG4gIH0gPSBjYXBzO1xuXG4gIC8vIFJlamVjdCAnZmlyc3RNYXRjaCcgYXJndW1lbnQgaWYgaXQncyBub3QgYW4gYXJyYXkgKCMzLjIpXG4gIGlmICghXy5pc0FycmF5KGFsbEZpcnN0TWF0Y2hDYXBzKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoJ1RoZSBjYXBhYmlsaXRpZXMuZmlyc3RNYXRjaCBhcmd1bWVudCB3YXMgbm90IHZhbGlkIGZvciB0aGUgZm9sbG93aW5nIHJlYXNvbihzKTogXCJjYXBhYmlsaXRpZXMuZmlyc3RNYXRjaFwiIG11c3QgYmUgYSBKU09OIGFycmF5IG9yIHVuZGVmaW5lZCcpO1xuICB9XG5cbiAgLy8gSWYgYW4gZW1wdHkgYXJyYXkgYXMgcHJvdmlkZWQsIHdlJ2xsIGJlIGZvcmdpdmluZyBhbmQgbWFrZSBpdCBhbiBhcnJheSBvZiBvbmUgZW1wdHkgb2JqZWN0XG4gIGlmIChhbGxGaXJzdE1hdGNoQ2Fwcy5sZW5ndGggPT09IDApIHtcbiAgICBhbGxGaXJzdE1hdGNoQ2Fwcy5wdXNoKHt9KTtcbiAgfVxuXG4gIC8vIENoZWNrIGZvciBub24tcHJlZml4ZWQsIG5vbi1zdGFuZGFyZCBjYXBhYmlsaXRpZXMgYW5kIGxvZyB3YXJuaW5ncyBpZiB0aGV5IGFyZSBmb3VuZFxuICBsZXQgbm9uUHJlZml4ZWRDYXBzID0gZmluZE5vblByZWZpeGVkQ2FwcyhjYXBzKTtcbiAgaWYgKCFfLmlzRW1wdHkobm9uUHJlZml4ZWRDYXBzKSkge1xuICAgIGxvZy53YXJuKGBUaGUgZm9sbG93aW5nIGNhcGFiaWxpdGllcyBhcmUgbm90IHN0YW5kYXJkIGNhcGFiaWxpdGllcyBhbmQgc2hvdWxkIGhhdmUgYW4gZXh0ZW5zaW9uIHByZWZpeDpgKTtcbiAgICBmb3IgKGNvbnN0IGNhcCBvZiBub25QcmVmaXhlZENhcHMpIHtcbiAgICAgIGxvZy53YXJuKGAgICR7Y2FwfWApO1xuICAgIH1cbiAgfVxuXG4gIC8vIFN0cmlwIG91dCB0aGUgJ2FwcGl1bTonIHByZWZpeCBmcm9tIGFsbFxuICBzdHJpcEFwcGl1bVByZWZpeGVzKHJlcXVpcmVkQ2Fwcyk7XG4gIGZvciAobGV0IGZpcnN0TWF0Y2hDYXBzIG9mIGFsbEZpcnN0TWF0Y2hDYXBzKSB7XG4gICAgc3RyaXBBcHBpdW1QcmVmaXhlcyhmaXJzdE1hdGNoQ2Fwcyk7XG4gIH1cblxuICAvLyBWYWxpZGF0ZSB0aGUgcmVxdWlyZWRDYXBzLiBCdXQgZG9uJ3QgdmFsaWRhdGUgJ3ByZXNlbmNlJyBiZWNhdXNlIGlmIHRoYXQgY29uc3RyYWludCBmYWlscyBvbiAnYWx3YXlzTWF0Y2gnIGl0IGNvdWxkIHN0aWxsIHBhc3Mgb24gb25lIG9mIHRoZSAnZmlyc3RNYXRjaCcga2V5c1xuICBpZiAoc2hvdWxkVmFsaWRhdGVDYXBzKSB7XG4gICAgcmVxdWlyZWRDYXBzID0gdmFsaWRhdGVDYXBzKHJlcXVpcmVkQ2FwcywgY29uc3RyYWludHMsIHtza2lwUHJlc2VuY2VDb25zdHJhaW50OiB0cnVlfSk7XG4gIH1cblxuXG4gIC8vIFJlbW92ZSB0aGUgJ3ByZXNlbmNlJyBjb25zdHJhaW50IGZvciBhbnkga2V5cyB0aGF0IGFyZSBhbHJlYWR5IHByZXNlbnQgaW4gJ3JlcXVpcmVkQ2FwcydcbiAgLy8gc2luY2Ugd2Uga25vdyB0aGF0IHRoaXMgY29uc3RyYWludCBoYXMgYWxyZWFkeSBwYXNzZWRcbiAgbGV0IGZpbHRlcmVkQ29uc3RyYWludHMgPSB7Li4uY29uc3RyYWludHN9O1xuICBsZXQgcmVxdWlyZWRDYXBzS2V5cyA9IF8ua2V5cyhyZXF1aXJlZENhcHMpO1xuICBmb3IgKGxldCBrZXkgb2YgXy5rZXlzKGZpbHRlcmVkQ29uc3RyYWludHMpKSB7XG4gICAgaWYgKHJlcXVpcmVkQ2Fwc0tleXMuaW5jbHVkZXMoa2V5KSkge1xuICAgICAgZGVsZXRlIGZpbHRlcmVkQ29uc3RyYWludHNba2V5XTtcbiAgICB9XG4gIH1cblxuICAvLyBWYWxpZGF0ZSBhbGwgb2YgdGhlIGZpcnN0IG1hdGNoIGNhcGFiaWxpdGllcyBhbmQgcmV0dXJuIGFuIGFycmF5IHdpdGggb25seSB0aGUgdmFsaWQgY2FwcyAoc2VlIHNwZWMgIzUpXG4gIGxldCB2YWxpZGF0aW9uRXJyb3JzID0gW107XG4gIGxldCB2YWxpZGF0ZWRGaXJzdE1hdGNoQ2FwcyA9IGFsbEZpcnN0TWF0Y2hDYXBzLm1hcCgoZmlyc3RNYXRjaENhcHMpID0+IHtcbiAgICB0cnkge1xuICAgICAgLy8gVmFsaWRhdGUgZmlyc3RNYXRjaCBjYXBzXG4gICAgICByZXR1cm4gc2hvdWxkVmFsaWRhdGVDYXBzID8gdmFsaWRhdGVDYXBzKGZpcnN0TWF0Y2hDYXBzLCBmaWx0ZXJlZENvbnN0cmFpbnRzKSA6IGZpcnN0TWF0Y2hDYXBzO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHZhbGlkYXRpb25FcnJvcnMucHVzaChlLm1lc3NhZ2UpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9KS5maWx0ZXIoKGNhcHMpID0+ICFfLmlzTnVsbChjYXBzKSk7XG5cbiAgLy8gVHJ5IHRvIG1lcmdlIHJlcXVpcmVkQ2FwcyB3aXRoIGZpcnN0IG1hdGNoIGNhcGFiaWxpdGllcywgYnJlYWsgb25jZSBpdCBmaW5kcyBpdHMgZmlyc3QgbWF0Y2ggKHNlZSBzcGVjICM2KVxuICBsZXQgbWF0Y2hlZENhcHMgPSBudWxsO1xuICBmb3IgKGxldCBmaXJzdE1hdGNoQ2FwcyBvZiB2YWxpZGF0ZWRGaXJzdE1hdGNoQ2Fwcykge1xuICAgIHRyeSB7XG4gICAgICBtYXRjaGVkQ2FwcyA9IG1lcmdlQ2FwcyhyZXF1aXJlZENhcHMsIGZpcnN0TWF0Y2hDYXBzKTtcbiAgICAgIGlmIChtYXRjaGVkQ2Fwcykge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGVyci5tZXNzYWdlKTtcbiAgICAgIHZhbGlkYXRpb25FcnJvcnMucHVzaChlcnIubWVzc2FnZSk7XG4gICAgfVxuICB9XG5cbiAgLy8gUmV0dXJucyB2YXJpYWJsZXMgZm9yIHRlc3RpbmcgcHVycG9zZXNcbiAgcmV0dXJuIHtyZXF1aXJlZENhcHMsIGFsbEZpcnN0TWF0Y2hDYXBzLCB2YWxpZGF0ZWRGaXJzdE1hdGNoQ2FwcywgbWF0Y2hlZENhcHMsIHZhbGlkYXRpb25FcnJvcnN9O1xufVxuXG4vLyBDYWxscyBwYXJzZUNhcHMgYW5kIGp1c3QgcmV0dXJucyB0aGUgbWF0Y2hlZENhcHMgdmFyaWFibGVcbmZ1bmN0aW9uIHByb2Nlc3NDYXBhYmlsaXRpZXMgKGNhcHMsIGNvbnN0cmFpbnRzID0ge30sIHNob3VsZFZhbGlkYXRlQ2FwcyA9IHRydWUpIHtcbiAgY29uc3Qge21hdGNoZWRDYXBzLCB2YWxpZGF0aW9uRXJyb3JzfSA9IHBhcnNlQ2FwcyhjYXBzLCBjb25zdHJhaW50cywgc2hvdWxkVmFsaWRhdGVDYXBzKTtcblxuICAvLyBJZiB3ZSBmb3VuZCBhbiBlcnJvciB0aHJvdyBhbiBleGNlcHRpb25cbiAgaWYgKCF1dGlsLmhhc1ZhbHVlKG1hdGNoZWRDYXBzKSkge1xuICAgIGlmIChfLmlzQXJyYXkoY2Fwcy5maXJzdE1hdGNoKSAmJiBjYXBzLmZpcnN0TWF0Y2gubGVuZ3RoID4gMSkge1xuICAgICAgLy8gSWYgdGhlcmUgd2FzIG1vcmUgdGhhbiBvbmUgJ2ZpcnN0TWF0Y2gnIGNhcCwgaW5kaWNhdGUgdGhhdCB3ZSBjb3VsZG4ndCBmaW5kIGEgbWF0Y2hpbmcgY2FwYWJpbGl0aWVzIHNldCBhbmQgc2hvdyBhbGwgdGhlIGVycm9yc1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQXJndW1lbnRFcnJvcihgQ291bGQgbm90IGZpbmQgbWF0Y2hpbmcgY2FwYWJpbGl0aWVzIGZyb20gJHtKU09OLnN0cmluZ2lmeShjYXBzKX06XFxuICR7dmFsaWRhdGlvbkVycm9ycy5qb2luKCdcXG4nKX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gT3RoZXJ3aXNlLCBqdXN0IHNob3cgdGhlIHNpbmd1bGFyIGVycm9yIG1lc3NhZ2VcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IodmFsaWRhdGlvbkVycm9yc1swXSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG1hdGNoZWRDYXBzO1xufVxuXG5cbmV4cG9ydCB7XG4gIHBhcnNlQ2FwcywgcHJvY2Vzc0NhcGFiaWxpdGllcywgdmFsaWRhdGVDYXBzLCBtZXJnZUNhcHMsXG4gIGZpbmROb25QcmVmaXhlZENhcHMsIGlzU3RhbmRhcmRDYXBcbn07XG4iXSwiZmlsZSI6ImxpYi9iYXNlZHJpdmVyL2NhcGFiaWxpdGllcy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
