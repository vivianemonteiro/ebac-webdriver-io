"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("../logger"));

var _protocol = require("../../protocol");

var _appiumSupport = require("appium-support");

var _capabilities = require("../capabilities");

let commands = {};

commands.createSession = async function createSession(jsonwpDesiredCapabilities, jsonwpRequiredCaps, w3cCapabilities) {
  if (this.sessionId !== null) {
    throw new _protocol.errors.SessionNotCreatedError('Cannot create a new session ' + 'while one is in progress');
  }

  _logger.default.debug();

  let caps;

  if (w3cCapabilities) {
    this.setProtocolW3C();

    if (jsonwpDesiredCapabilities) {
      _logger.default.debug(`W3C capabilities and MJSONWP desired capabilities were provided`);
    }

    if (jsonwpDesiredCapabilities && !_lodash.default.isPlainObject(w3cCapabilities)) {
      if (!_lodash.default.isEmpty(w3cCapabilities)) {
        _logger.default.warn(`Expected W3C "capabilities" to be a JSON Object but was provided with: ${JSON.stringify(w3cCapabilities)}`);
      }

      _logger.default.warn(`Falling back to MJSONWP desired capabilities`);

      this.setProtocolMJSONWP();
      caps = jsonwpDesiredCapabilities;
    } else {
      _logger.default.debug(`Creating session with W3C capabilities: ${JSON.stringify(w3cCapabilities, null, 2)}`);

      caps = (0, _capabilities.processCapabilities)(w3cCapabilities, this.desiredCapConstraints, this.shouldValidateCaps);
    }
  } else {
    this.setProtocolMJSONWP();

    _logger.default.debug(`Creating session with MJSONWP desired capabilities: ${JSON.stringify(jsonwpDesiredCapabilities, null, 2)}`);

    caps = jsonwpDesiredCapabilities || {};
  }

  caps = fixCaps(caps, this.desiredCapConstraints);
  this.validateDesiredCaps(caps);
  this.sessionId = _appiumSupport.util.uuidV4();
  this.caps = caps;
  this.opts = _lodash.default.cloneDeep(this.initialOpts);
  Object.assign(this.opts, this.caps);

  if (this.opts.noReset && this.opts.fullReset) {
    throw new Error("The 'noReset' and 'fullReset' capabilities are mutually " + 'exclusive and should not both be set to true. You ' + "probably meant to just use 'fullReset' on its own");
  }

  if (this.opts.noReset === true) {
    this.opts.fullReset = false;
  }

  if (this.opts.fullReset === true) {
    this.opts.noReset = false;
  }

  this.opts.fastReset = !this.opts.fullReset && !this.opts.noReset;
  this.opts.skipUninstall = this.opts.fastReset || this.opts.noReset;

  if (typeof this.opts.app === 'string' && this.opts.app.trim() === '') {
    this.opts.app = null;
  }

  if (!_lodash.default.isUndefined(this.caps.newCommandTimeout)) {
    this.newCommandTimeoutMs = this.caps.newCommandTimeout * 1000;
  }

  _logger.default.info(`Session created with session id: ${this.sessionId}`);

  return [this.sessionId, caps];
};

commands.getSessions = async function getSessions() {
  let ret = [];

  if (this.sessionId) {
    ret.push({
      id: this.sessionId,
      capabilities: this.caps
    });
  }

  return ret;
};

commands.getSession = async function getSession() {
  if (this.caps.eventTimings) {
    return Object.assign({}, this.caps, {
      events: this.eventHistory
    });
  }

  return this.caps;
};

commands.deleteSession = async function deleteSession() {
  this.clearNewCommandTimeout();

  if (this.isCommandsQueueEnabled && this.commandsQueueGuard.isBusy()) {
    for (const key of _lodash.default.keys(this.commandsQueueGuard.queues)) {
      this.commandsQueueGuard.queues[key] = [];
    }
  }

  this.sessionId = null;
};

function fixCaps(originalCaps, desiredCapConstraints = {}) {
  let caps = _lodash.default.clone(originalCaps);

  let booleanCaps = _lodash.default.keys(_lodash.default.pickBy(desiredCapConstraints, k => k.isBoolean === true));

  for (let cap of booleanCaps) {
    let value = originalCaps[cap];

    if (_lodash.default.isString(value)) {
      value = value.toLowerCase();

      if (value === 'true' || value === 'false') {
        _logger.default.warn(`Capability '${cap}' changed from string to boolean. This may cause unexpected behavior`);

        caps[cap] = value === 'true';
      }
    }
  }

  let intCaps = _lodash.default.keys(_lodash.default.pickBy(desiredCapConstraints, k => k.isNumber === true));

  for (let cap of intCaps) {
    let value = originalCaps[cap];

    if (_lodash.default.isString(value) && !isNaN(value)) {
      value = value.trim();
      let newValue = parseInt(value, 10);

      if (value !== `${newValue}`) {
        newValue = parseFloat(value);
      }

      _logger.default.warn(`Capability '${cap}' changed from string ('${value}') to integer (${newValue}). This may cause unexpected behavior`);

      caps[cap] = newValue;
    }
  }

  return caps;
}

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL3Nlc3Npb24uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJjcmVhdGVTZXNzaW9uIiwianNvbndwRGVzaXJlZENhcGFiaWxpdGllcyIsImpzb253cFJlcXVpcmVkQ2FwcyIsInczY0NhcGFiaWxpdGllcyIsInNlc3Npb25JZCIsImVycm9ycyIsIlNlc3Npb25Ob3RDcmVhdGVkRXJyb3IiLCJsb2ciLCJkZWJ1ZyIsImNhcHMiLCJzZXRQcm90b2NvbFczQyIsIl8iLCJpc1BsYWluT2JqZWN0IiwiaXNFbXB0eSIsIndhcm4iLCJKU09OIiwic3RyaW5naWZ5Iiwic2V0UHJvdG9jb2xNSlNPTldQIiwiZGVzaXJlZENhcENvbnN0cmFpbnRzIiwic2hvdWxkVmFsaWRhdGVDYXBzIiwiZml4Q2FwcyIsInZhbGlkYXRlRGVzaXJlZENhcHMiLCJ1dGlsIiwidXVpZFY0Iiwib3B0cyIsImNsb25lRGVlcCIsImluaXRpYWxPcHRzIiwiT2JqZWN0IiwiYXNzaWduIiwibm9SZXNldCIsImZ1bGxSZXNldCIsIkVycm9yIiwiZmFzdFJlc2V0Iiwic2tpcFVuaW5zdGFsbCIsImFwcCIsInRyaW0iLCJpc1VuZGVmaW5lZCIsIm5ld0NvbW1hbmRUaW1lb3V0IiwibmV3Q29tbWFuZFRpbWVvdXRNcyIsImluZm8iLCJnZXRTZXNzaW9ucyIsInJldCIsInB1c2giLCJpZCIsImNhcGFiaWxpdGllcyIsImdldFNlc3Npb24iLCJldmVudFRpbWluZ3MiLCJldmVudHMiLCJldmVudEhpc3RvcnkiLCJkZWxldGVTZXNzaW9uIiwiY2xlYXJOZXdDb21tYW5kVGltZW91dCIsImlzQ29tbWFuZHNRdWV1ZUVuYWJsZWQiLCJjb21tYW5kc1F1ZXVlR3VhcmQiLCJpc0J1c3kiLCJrZXkiLCJrZXlzIiwicXVldWVzIiwib3JpZ2luYWxDYXBzIiwiY2xvbmUiLCJib29sZWFuQ2FwcyIsInBpY2tCeSIsImsiLCJpc0Jvb2xlYW4iLCJjYXAiLCJ2YWx1ZSIsImlzU3RyaW5nIiwidG9Mb3dlckNhc2UiLCJpbnRDYXBzIiwiaXNOdW1iZXIiLCJpc05hTiIsIm5ld1ZhbHVlIiwicGFyc2VJbnQiLCJwYXJzZUZsb2F0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmOztBQUVBQSxRQUFRLENBQUNDLGFBQVQsR0FBeUIsZUFBZUEsYUFBZixDQUE4QkMseUJBQTlCLEVBQXlEQyxrQkFBekQsRUFBNkVDLGVBQTdFLEVBQThGO0FBQ3JILE1BQUksS0FBS0MsU0FBTCxLQUFtQixJQUF2QixFQUE2QjtBQUMzQixVQUFNLElBQUlDLGlCQUFPQyxzQkFBWCxDQUFrQyxpQ0FDQSwwQkFEbEMsQ0FBTjtBQUVEOztBQUVEQyxrQkFBSUMsS0FBSjs7QUFHQSxNQUFJQyxJQUFKOztBQUNBLE1BQUlOLGVBQUosRUFBcUI7QUFDbkIsU0FBS08sY0FBTDs7QUFDQSxRQUFJVCx5QkFBSixFQUErQjtBQUM3Qk0sc0JBQUlDLEtBQUosQ0FBVyxpRUFBWDtBQUNEOztBQUVELFFBQUlQLHlCQUF5QixJQUFJLENBQUNVLGdCQUFFQyxhQUFGLENBQWdCVCxlQUFoQixDQUFsQyxFQUFvRTtBQUdsRSxVQUFJLENBQUNRLGdCQUFFRSxPQUFGLENBQVVWLGVBQVYsQ0FBTCxFQUFpQztBQUMvQkksd0JBQUlPLElBQUosQ0FBVSwwRUFBeUVDLElBQUksQ0FBQ0MsU0FBTCxDQUFlYixlQUFmLENBQWdDLEVBQW5IO0FBQ0Q7O0FBQ0RJLHNCQUFJTyxJQUFKLENBQVUsOENBQVY7O0FBQ0EsV0FBS0csa0JBQUw7QUFDQVIsTUFBQUEsSUFBSSxHQUFHUix5QkFBUDtBQUNELEtBVEQsTUFTTztBQUNMTSxzQkFBSUMsS0FBSixDQUFXLDJDQUEwQ08sSUFBSSxDQUFDQyxTQUFMLENBQWViLGVBQWYsRUFBZ0MsSUFBaEMsRUFBc0MsQ0FBdEMsQ0FBeUMsRUFBOUY7O0FBQ0FNLE1BQUFBLElBQUksR0FBRyx1Q0FBb0JOLGVB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QUFJTyxJQUFKLENBQVUsZUFBY2lELEdBQUksc0VBQTVCOztBQUNBdEQsUUFBQUEsSUFBSSxDQUFDc0QsR0FBRCxDQUFKLEdBQWFDLEtBQUssS0FBSyxNQUF2QjtBQUNEO0FBQ0Y7QUFDRjs7QUFHRCxNQUFJRyxPQUFPLEdBQUd4RCxnQkFBRTRDLElBQUYsQ0FBTzVDLGdCQUFFaUQsTUFBRixDQUFTMUMscUJBQVQsRUFBaUMyQyxDQUFELElBQU9BLENBQUMsQ0FBQ08sUUFBRixLQUFlLElBQXRELENBQVAsQ0FBZDs7QUFDQSxPQUFLLElBQUlMLEdBQVQsSUFBZ0JJLE9BQWhCLEVBQXlCO0FBQ3ZCLFFBQUlILEtBQUssR0FBR1AsWUFBWSxDQUFDTSxHQUFELENBQXhCOztBQUNBLFFBQUlwRCxnQkFBRXNELFFBQUYsQ0FBV0QsS0FBWCxLQUFxQixDQUFDSyxLQUFLLENBQUNMLEtBQUQsQ0FBL0IsRUFBd0M7QUFDdENBLE1BQUFBLEtBQUssR0FBR0EsS0FBSyxDQUFDN0IsSUFBTixFQUFSO0FBQ0EsVUFBSW1DLFFBQVEsR0FBR0MsUUFBUSxDQUFDUCxLQUFELEVBQVEsRUFBUixDQUF2Qjs7QUFDQSxVQUFJQSxLQUFLLEtBQU0sR0FBRU0sUUFBUyxFQUExQixFQUE2QjtBQUMzQkEsUUFBQUEsUUFBUSxHQUFHRSxVQUFVLENBQUNSLEtBQUQsQ0FBckI7QUFDRDs7QUFDRHpELHNCQUFJTyxJQUFKLENBQVUsZUFBY2lELEdBQUksMkJBQTBCQyxLQUFNLGtCQUFpQk0sUUFBUyx1Q0FBdEY7O0FBQ0E3RCxNQUFBQSxJQUFJLENBQUNzRCxHQUFELENBQUosR0FBWU8sUUFBWjtBQUNEO0FBQ0Y7O0FBRUQsU0FBTzdELElBQVA7QUFDRDs7ZUFFY1YsUSIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIHJlcXVpcmUtYXdhaXQgKi9cbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICcuLi8uLi9wcm90b2NvbCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgcHJvY2Vzc0NhcGFiaWxpdGllcyB9IGZyb20gJy4uL2NhcGFiaWxpdGllcyc7XG5cbmxldCBjb21tYW5kcyA9IHt9O1xuXG5jb21tYW5kcy5jcmVhdGVTZXNzaW9uID0gYXN5bmMgZnVuY3Rpb24gY3JlYXRlU2Vzc2lvbiAoanNvbndwRGVzaXJlZENhcGFiaWxpdGllcywganNvbndwUmVxdWlyZWRDYXBzLCB3M2NDYXBhYmlsaXRpZXMpIHtcbiAgaWYgKHRoaXMuc2Vzc2lvbklkICE9PSBudWxsKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5TZXNzaW9uTm90Q3JlYXRlZEVycm9yKCdDYW5ub3QgY3JlYXRlIGEgbmV3IHNlc3Npb24gJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd3aGlsZSBvbmUgaXMgaW4gcHJvZ3Jlc3MnKTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZygpO1xuXG4gIC8vIERldGVybWluZSB3ZWF0aGVyIHdlIHNob3VsZCB1c2UganNvbndwRGVzaXJlZENhcGFiaWxpdGllcyBvciB3M2NDYXBhYmlsaXRpZXMgdG8gZ2V0IGNhcHMgZnJvbVxuICBsZXQgY2FwcztcbiAgaWYgKHczY0NhcGFiaWxpdGllcykge1xuICAgIHRoaXMuc2V0UHJvdG9jb2xXM0MoKTtcbiAgICBpZiAoanNvbndwRGVzaXJlZENhcGFiaWxpdGllcykge1xuICAgICAgbG9nLmRlYnVnKGBXM0MgY2FwYWJpbGl0aWVzIGFuZCBNSlNPTldQIGRlc2lyZWQgY2FwYWJpbGl0aWVzIHdlcmUgcHJvdmlkZWRgKTtcbiAgICB9XG5cbiAgICBpZiAoanNvbndwRGVzaXJlZENhcGFiaWxpdGllcyAmJiAhXy5pc1BsYWluT2JqZWN0KHczY0NhcGFiaWxpdGllcykpIHtcbiAgICAgIC8vIElmIFczQyBDYXBhYmlsaXRpZXMgYW5kIE1KU09OV1AgQ2FwYWJpbGl0aWVzIHdlcmUgcHJvdmlkZWQgYW5kIFczQyBjYXBzIGFyZW4ndCBhIHBsYWluIG9iamVjdCxcbiAgICAgIC8vIGxvZyBhIHdhcm5pbmcgYW5kIGZhbGwgYmFjayB0byBNSlNPTldQXG4gICAgICBpZiAoIV8uaXNFbXB0eSh3M2NDYXBhYmlsaXRpZXMpKSB7XG4gICAgICAgIGxvZy53YXJuKGBFeHBlY3RlZCBXM0MgXCJjYXBhYmlsaXRpZXNcIiB0byBiZSBhIEpTT04gT2JqZWN0IGJ1dCB3YXMgcHJvdmlkZWQgd2l0aDogJHtKU09OLnN0cmluZ2lmeSh3M2NDYXBhYmlsaXRpZXMpfWApO1xuICAgICAgfVxuICAgICAgbG9nLndhcm4oYEZhbGxpbmcgYmFjayB0byBNSlNPTldQIGRlc2lyZWQgY2FwYWJpbGl0aWVzYCk7XG4gICAgICB0aGlzLnNldFByb3RvY29sTUpTT05XUCgpO1xuICAgICAgY2FwcyA9IGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZyhgQ3JlYXRpbmcgc2Vzc2lvbiB3aXRoIFczQyBjYXBhYmlsaXRpZXM6ICR7SlNPTi5zdHJpbmdpZnkodzNjQ2FwYWJpbGl0aWVzLCBudWxsLCAyKX1gKTtcbiAgICAgIGNhcHMgPSBwcm9jZXNzQ2FwYWJpbGl0aWVzKHczY0NhcGFiaWxpdGllcywgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMsIHRoaXMuc2hvdWxkVmFsaWRhdGVDYXBzKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgdGhpcy5zZXRQcm90b2NvbE1KU09OV1AoKTtcbiAgICBsb2cuZGVidWcoYENyZWF0aW5nIHNlc3Npb24gd2l0aCBNSlNPTldQIGRlc2lyZWQgY2FwYWJpbGl0aWVzOiAke0pTT04uc3RyaW5naWZ5KGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMsIG51bGwsIDIpfWApO1xuICAgIGNhcHMgPSBqc29ud3BEZXNpcmVkQ2FwYWJpbGl0aWVzIHx8IHt9O1xuICB9XG5cbiAgY2FwcyA9IGZpeENhcHMoY2FwcywgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMpO1xuICB0aGlzLnZhbGlkYXRlRGVzaXJlZENhcHMoY2Fwcyk7XG5cbiAgdGhpcy5zZXNzaW9uSWQgPSB1dGlsLnV1aWRWNCgpO1xuICB0aGlzLmNhcHMgPSBjYXBzO1xuICB0aGlzLm9wdHMgPSBfLmNsb25lRGVlcCh0aGlzLmluaXRpYWxPcHRzKTtcblxuICAvLyBtZXJnZSBjYXBzIG9udG8gb3B0cyBzbyB3ZSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IHdoYXQncyB3aGVyZVxuICBPYmplY3QuYXNzaWduKHRoaXMub3B0cywgdGhpcy5jYXBzKTtcblxuICAvLyBkZWFsIHdpdGggcmVzZXRzXG4gIC8vIHNvbWUgcGVvcGxlIGxpa2UgdG8gZG8gd2VpcmQgdGhpbmdzIGJ5IHNldHRpbmcgbm9SZXNldCBhbmQgZnVsbFJlc2V0XG4gIC8vIGJvdGggdG8gdHJ1ZSwgYnV0IHRoaXMgaXMgbWlzZ3VpZGVkIGFuZCBzdHJhbmdlLCBzbyBlcnJvciBoZXJlIGluc3RlYWRcbiAgaWYgKHRoaXMub3B0cy5ub1Jlc2V0ICYmIHRoaXMub3B0cy5mdWxsUmVzZXQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGUgJ25vUmVzZXQnIGFuZCAnZnVsbFJlc2V0JyBjYXBhYmlsaXRpZXMgYXJlIG11dHVhbGx5IFwiICtcbiAgICAgICAgICAgICAgICAgICAgJ2V4Y2x1c2l2ZSBhbmQgc2hvdWxkIG5vdCBib3RoIGJlIHNldCB0byB0cnVlLiBZb3UgJyArXG4gICAgICAgICAgICAgICAgICAgIFwicHJvYmFibHkgbWVhbnQgdG8ganVzdCB1c2UgJ2Z1bGxSZXNldCcgb24gaXRzIG93blwiKTtcbiAgfVxuICBpZiAodGhpcy5vcHRzLm5vUmVzZXQgPT09IHRydWUpIHtcbiAgICB0aGlzLm9wdHMuZnVsbFJlc2V0ID0gZmFsc2U7XG4gIH1cbiAgaWYgKHRoaXMub3B0cy5mdWxsUmVzZXQgPT09IHRydWUpIHtcbiAgICB0aGlzLm9wdHMubm9SZXNldCA9IGZhbHNlO1xuICB9XG4gIHRoaXMub3B0cy5mYXN0UmVzZXQgPSAhdGhpcy5vcHRzLmZ1bGxSZXNldCAmJiAhdGhpcy5vcHRzLm5vUmVzZXQ7XG4gIHRoaXMub3B0cy5za2lwVW5pbnN0YWxsID0gdGhpcy5vcHRzLmZhc3RSZXNldCB8fCB0aGlzLm9wdHMubm9SZXNldDtcblxuICAvLyBQcmV2ZW50cyBlbXB0eSBzdHJpbmcgY2FwcyBzbyB3ZSBkb24ndCBuZWVkIHRvIHRlc3QgaXQgZXZlcnl3aGVyZVxuICBpZiAodHlwZW9mIHRoaXMub3B0cy5hcHAgPT09ICdzdHJpbmcnICYmIHRoaXMub3B0cy5hcHAudHJpbSgpID09PSAnJykge1xuICAgIHRoaXMub3B0cy5hcHAgPSBudWxsO1xuICB9XG5cbiAgaWYgKCFfLmlzVW5kZWZpbmVkKHRoaXMuY2Fwcy5uZXdDb21tYW5kVGltZW91dCkpIHtcbiAgICB0aGlzLm5ld0NvbW1hbmRUaW1lb3V0TXMgPSAodGhpcy5jYXBzLm5ld0NvbW1hbmRUaW1lb3V0ICogMTAwMCk7XG4gIH1cblxuICBsb2cuaW5mbyhgU2Vzc2lvbiBjcmVhdGVkIHdpdGggc2Vzc2lvbiBpZDogJHt0aGlzLnNlc3Npb25JZH1gKTtcblxuICByZXR1cm4gW3RoaXMuc2Vzc2lvbklkLCBjYXBzXTtcbn07XG5cbmNvbW1hbmRzLmdldFNlc3Npb25zID0gYXN5bmMgZnVuY3Rpb24gZ2V0U2Vzc2lvbnMgKCkge1xuICBsZXQgcmV0ID0gW107XG5cbiAgaWYgKHRoaXMuc2Vzc2lvbklkKSB7XG4gICAgcmV0LnB1c2goe1xuICAgICAgaWQ6IHRoaXMuc2Vzc2lvbklkLFxuICAgICAgY2FwYWJpbGl0aWVzOiB0aGlzLmNhcHNcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiByZXQ7XG59O1xuXG5jb21tYW5kcy5nZXRTZXNzaW9uID0gYXN5bmMgZnVuY3Rpb24gZ2V0U2Vzc2lvbiAoKSB7XG4gIGlmICh0aGlzLmNhcHMuZXZlbnRUaW1pbmdzKSB7XG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHRoaXMuY2Fwcywge2V2ZW50czogdGhpcy5ldmVudEhpc3Rvcnl9KTtcbiAgfVxuICByZXR1cm4gdGhpcy5jYXBzO1xufTtcblxuY29tbWFuZHMuZGVsZXRlU2Vzc2lvbiA9IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZVNlc3Npb24gKC8qIHNlc3Npb25JZCAqLykge1xuICB0aGlzLmNsZWFyTmV3Q29tbWFuZFRpbWVvdXQoKTtcbiAgaWYgKHRoaXMuaXNDb21tYW5kc1F1ZXVlRW5hYmxlZCAmJiB0aGlzLmNvbW1hbmRzUXVldWVHdWFyZC5pc0J1c3koKSkge1xuICAgIC8vIHNpbXBsZSBoYWNrIHRvIHJlbGVhc2UgcGVuZGluZyBjb21tYW5kcyBpZiB0aGV5IGV4aXN0XG4gICAgZm9yIChjb25zdCBrZXkgb2YgXy5rZXlzKHRoaXMuY29tbWFuZHNRdWV1ZUd1YXJkLnF1ZXVlcykpIHtcbiAgICAgIHRoaXMuY29tbWFuZHNRdWV1ZUd1YXJkLnF1ZXVlc1trZXldID0gW107XG4gICAgfVxuICB9XG4gIHRoaXMuc2Vzc2lvbklkID0gbnVsbDtcbn07XG5cbmZ1bmN0aW9uIGZpeENhcHMgKG9yaWdpbmFsQ2FwcywgZGVzaXJlZENhcENvbnN0cmFpbnRzID0ge30pIHtcbiAgbGV0IGNhcHMgPSBfLmNsb25lKG9yaWdpbmFsQ2Fwcyk7XG5cbiAgLy8gYm9vbGVhbiBjYXBhYmlsaXRpZXMgY2FuIGJlIHBhc3NlZCBpbiBhcyBzdHJpbmdzICdmYWxzZScgYW5kICd0cnVlJ1xuICAvLyB3aGljaCB3ZSB3YW50IHRvIHRyYW5zbGF0ZSBpbnRvIGJvb2xlYW4gdmFsdWVzXG4gIGxldCBib29sZWFuQ2FwcyA9IF8ua2V5cyhfLnBpY2tCeShkZXNpcmVkQ2FwQ29uc3RyYWludHMsIChrKSA9PiBrLmlzQm9vbGVhbiA9PT0gdHJ1ZSkpO1xuICBmb3IgKGxldCBjYXAgb2YgYm9vbGVhbkNhcHMpIHtcbiAgICBsZXQgdmFsdWUgPSBvcmlnaW5hbENhcHNbY2FwXTtcbiAgICBpZiAoXy5pc1N0cmluZyh2YWx1ZSkpIHtcbiAgICAgIHZhbHVlID0gdmFsdWUudG9Mb3dlckNhc2UoKTtcbiAgICAgIGlmICh2YWx1ZSA9PT0gJ3RydWUnIHx8IHZhbHVlID09PSAnZmFsc2UnKSB7XG4gICAgICAgIGxvZy53YXJuKGBDYXBhYmlsaXR5ICcke2NhcH0nIGNoYW5nZWQgZnJvbSBzdHJpbmcgdG8gYm9vbGVhbi4gVGhpcyBtYXkgY2F1c2UgdW5leHBlY3RlZCBiZWhhdmlvcmApO1xuICAgICAgICBjYXBzW2NhcF0gPSAodmFsdWUgPT09ICd0cnVlJyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gaW50IGNhcGFiaWxpdGllcyBhcmUgb2Z0ZW4gc2VudCBpbiBhcyBzdHJpbmdzIGJ5IGZyYW1ld29ya3NcbiAgbGV0IGludENhcHMgPSBfLmtleXMoXy5waWNrQnkoZGVzaXJlZENhcENvbnN0cmFpbnRzLCAoaykgPT4gay5pc051bWJlciA9PT0gdHJ1ZSkpO1xuICBmb3IgKGxldCBjYXAgb2YgaW50Q2Fwcykge1xuICAgIGxldCB2YWx1ZSA9IG9yaWdpbmFsQ2Fwc1tjYXBdO1xuICAgIGlmIChfLmlzU3RyaW5nKHZhbHVlKSAmJiAhaXNOYU4odmFsdWUpKSB7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnRyaW0oKTtcbiAgICAgIGxldCBuZXdWYWx1ZSA9IHBhcnNlSW50KHZhbHVlLCAxMCk7XG4gICAgICBpZiAodmFsdWUgIT09IGAke25ld1ZhbHVlfWApIHtcbiAgICAgICAgbmV3VmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTtcbiAgICAgIH1cbiAgICAgIGxvZy53YXJuKGBDYXBhYmlsaXR5ICcke2NhcH0nIGNoYW5nZWQgZnJvbSBzdHJpbmcgKCcke3ZhbHVlfScpIHRvIGludGVnZXIgKCR7bmV3VmFsdWV9KS4gVGhpcyBtYXkgY2F1c2UgdW5leHBlY3RlZCBiZWhhdmlvcmApO1xuICAgICAgY2Fwc1tjYXBdID0gbmV3VmFsdWU7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGNhcHM7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sImZpbGUiOiJsaWIvYmFzZWRyaXZlci9jb21tYW5kcy9zZXNzaW9uLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uIn0=
