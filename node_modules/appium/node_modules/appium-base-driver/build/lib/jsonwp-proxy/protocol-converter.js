"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.COMMAND_URLS_CONFLICTS = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _helpers = require("../basedriver/helpers");

var _constants = require("../constants");

var _helpers2 = require("../protocol/helpers");

const log = _appiumSupport.logger.getLogger('Protocol Converter');

const COMMAND_URLS_CONFLICTS = [{
  commandNames: ['execute', 'executeAsync'],
  jsonwpConverter: url => url.replace(/\/execute.*/, url.includes('async') ? '/execute_async' : '/execute'),
  w3cConverter: url => url.replace(/\/execute.*/, url.includes('async') ? '/execute/async' : '/execute/sync')
}, {
  commandNames: ['getElementScreenshot'],
  jsonwpConverter: url => url.replace(/\/element\/([^/]+)\/screenshot$/, '/screenshot/$1'),
  w3cConverter: url => url.replace(/\/screenshot\/([^/]+)/, '/element/$1/screenshot')
}, {
  commandNames: ['getWindowHandles', 'getWindowHandle'],

  jsonwpConverter(url) {
    return /\/window$/.test(url) ? url.replace(/\/window$/, '/window_handle') : url.replace(/\/window\/handle(s?)$/, '/window_handle$1');
  },

  w3cConverter(url) {
    return /\/window_handle$/.test(url) ? url.replace(/\/window_handle$/, '/window') : url.replace(/\/window_handles$/, '/window/handles');
  }

}, {
  commandNames: ['getProperty'],
  jsonwpConverter: w3cUrl => {
    const w3cPropertyRegex = /\/element\/([^/]+)\/property\/([^/]+)/;
    const jsonwpUrl = w3cUrl.replace(w3cPropertyRegex, '/element/$1/attribute/$2');
    log.info(`Converting W3C '${w3cUrl}' to '${jsonwpUrl}'`);
    return jsonwpUrl;
  },
  w3cConverter: jsonwpUrl => jsonwpUrl
}];
exports.COMMAND_URLS_CONFLICTS = COMMAND_URLS_CONFLICTS;
const {
  MJSONWP,
  W3C
} = _constants.PROTOCOLS;

class ProtocolConverter {
  constructor(proxyFunc) {
    this.proxyFunc = proxyFunc;
    this._downstreamProtocol = null;
  }

  set downstreamProtocol(value) {
    this._downstreamProtocol = value;
  }

  get downstreamProtocol() {
    return this._downstreamProtocol;
  }

  getTimeoutRequestObjects(body) {
    if (this.downstreamProtocol === W3C && _lodash.default.has(body, 'ms') && _lodash.default.has(body, 'type')) {
      const typeToW3C = x => x === 'page load' ? 'pageLoad' : x;

      return [{
        [typeToW3C(body.type)]: body.ms
      }];
    }

    if (this.downstreamProtocol === MJSONWP && (!_lodash.default.has(body, 'ms') || !_lodash.default.has(body, 'type'))) {
      const typeToJSONWP = x => x === 'pageLoad' ? 'page load' : x;

      return _lodash.default.toPairs(body).filter(pair => /^\d+(?:[.,]\d*?)?$/.test(`${pair[1]}`)).map(function (pair) {
        return {
          type: typeToJSONWP(pair[0]),
          ms: pair[1]
        };
      });
    }

    return [body];
  }

  async proxySetTimeouts(url, method, body) {
    let response, resBody;
    const timeoutRequestObjects = this.getTimeoutRequestObjects(body);
    log.debug(`Will send the following request bodies to /timeouts: ${JSON.stringify(timeoutRequestObjects)}`);

    for (const timeoutObj of timeoutRequestObjects) {
      [response, resBody] = await this.proxyFunc(url, method, timeoutObj);

      if (this.downstreamProtocol !== MJSONWP) {
        return [response, resBody];
      }

      if (response.statusCode >= 400) {
        return [response, resBody];
      }
    }

    return [response, resBody];
  }

  async proxySetWindow(url, method, body) {
    const bodyObj = _appiumSupport.util.safeJsonParse(body);

    if (_lodash.default.isPlainObject(bodyObj)) {
      if (this.downstreamProtocol === W3C && _lodash.default.has(bodyObj, 'name') && !_lodash.default.has(bodyObj, 'handle')) {
        log.debug(`Copied 'name' value '${bodyObj.name}' to 'handle' as per W3C spec`);
        return await this.proxyFunc(url, method, { ...bodyObj,
          handle: bodyObj.name
        });
      }

      if (this.downstreamProtocol === MJSONWP && _lodash.default.has(bodyObj, 'handle') && !_lodash.default.has(bodyObj, 'name')) {
        log.debug(`Copied 'handle' value '${bodyObj.handle}' to 'name' as per JSONWP spec`);
        return await this.proxyFunc(url, method, { ...bodyObj,
          name: bodyObj.handle
        });
      }
    }

    return await this.proxyFunc(url, method, body);
  }

  async proxySetValue(url, method, body) {
    const bodyObj = _appiumSupport.util.safeJsonParse(body);

    if (_lodash.default.isPlainObject(bodyObj) && (_appiumSupport.util.hasValue(bodyObj.text) || _appiumSupport.util.hasValue(bodyObj.value))) {
      let {
        text,
        value
      } = bodyObj;

      if (_appiumSupport.util.hasValue(text) && !_appiumSupport.util.hasValue(value)) {
        value = _lodash.default.isString(text) ? [...text] : _lodash.default.isArray(text) ? text : [];
        log.debug(`Added 'value' property ${JSON.stringify(value)} to 'setValue' request body`);
      } else if (!_appiumSupport.util.hasValue(text) && _appiumSupport.util.hasValue(value)) {
        text = _lodash.default.isArray(value) ? value.join('') : _lodash.default.isString(value) ? value : '';
        log.debug(`Added 'text' property ${JSON.stringify(text)} to 'setValue' request body`);
      }

      return await this.proxyFunc(url, method, Object.assign({}, bodyObj, {
        text,
        value
      }));
    }

    return await this.proxyFunc(url, method, body);
  }

  async proxySetFrame(url, method, body) {
    const bodyObj = _appiumSupport.util.safeJsonParse(body);

    return _lodash.default.has(bodyObj, 'id') && _lodash.default.isPlainObject(bodyObj.id) ? await this.proxyFunc(url, method, { ...bodyObj,
      id: (0, _helpers.duplicateKeys)(bodyObj.id, _constants.MJSONWP_ELEMENT_KEY, _constants.W3C_ELEMENT_KEY)
    }) : await this.proxyFunc(url, method, body);
  }

  async proxyPerformActions(url, method, body) {
    const bodyObj = _appiumSupport.util.safeJsonParse(body);

    return _lodash.default.isPlainObject(bodyObj) ? await this.proxyFunc(url, method, (0, _helpers.duplicateKeys)(bodyObj, _constants.MJSONWP_ELEMENT_KEY, _constants.W3C_ELEMENT_KEY)) : await this.proxyFunc(url, method, body);
  }

  async convertAndProxy(commandName, url, method, body) {
    if (!this.downstreamProtocol) {
      const [res, resBodyObj] = await this.proxyFunc(url, method, body);
      return [res, (0, _helpers2.formatStatus)(resBodyObj, res.statusCode)];
    }

    switch (commandName) {
      case 'timeouts':
        return await this.proxySetTimeouts(url, method, body);

      case 'setWindow':
        return await this.proxySetWindow(url, method, body);

      case 'setValue':
        return await this.proxySetValue(url, method, body);

      case 'performActions':
        return await this.proxyPerformActions(url, method, body);

      case 'setFrame':
        return await this.proxySetFrame(url, method, body);

      default:
        break;
    }

    for (const {
      commandNames,
      jsonwpConverter,
      w3cConverter
    } of COMMAND_URLS_CONFLICTS) {
      if (!commandNames.includes(commandName)) {
        continue;
      }

      const rewrittenUrl = this.downstreamProtocol === MJSONWP ? jsonwpConverter(url) : w3cConverter(url);

      if (rewrittenUrl === url) {
        log.debug(`Did not know how to rewrite the original URL '${url}' ` + `for ${this.downstreamProtocol} protocol`);
        break;
      }

      log.info(`Rewrote the original URL '${url}' to '${rewrittenUrl}' ` + `for ${this.downstreamProtocol} protocol`);
      return await this.proxyFunc(rewrittenUrl, method, body);
    }

    return await this.proxyFunc(url, method, body);
  }

}

var _default = ProtocolConverter;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJvdG9jb2wtY29udmVydGVyLmpzIl0sIm5hbWVzIjpbImxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIkNPTU1BTkRfVVJMU19DT05GTElDVFMiLCJjb21tYW5kTmFtZXMiLCJqc29ud3BDb252ZXJ0ZXIiLCJ1cmwiLCJyZXBsYWNlIiwiaW5jbHVkZXMiLCJ3M2NDb252ZXJ0ZXIiLCJ0ZXN0IiwidzNjVXJsIiwidzNjUHJvcGVydHlSZWdleCIsImpzb253cFVybCIsImluZm8iLCJNSlNPTldQIiwiVzNDIiwiUFJPVE9DT0xTIiwiUHJvdG9jb2xDb252ZXJ0ZXIiLCJjb25zdHJ1Y3RvciIsInByb3h5RnVuYyIsIl9kb3duc3RyZWFtUHJvdG9jb2wiLCJkb3duc3RyZWFtUHJvdG9jb2wiLCJ2YWx1ZSIsImdldFRpbWVvdXRSZXF1ZXN0T2JqZWN0cyIsImJvZHkiLCJfIiwiaGFzIiwidHlwZVRvVzNDIiwieCIsInR5cGUiLCJtcyIsInR5cGVUb0pTT05XUCIsInRvUGFpcnMiLCJmaWx0ZXIiLCJwYWlyIiwibWFwIiwicHJveHlTZXRUaW1lb3V0cyIsIm1ldGhvZCIsInJlc3BvbnNlIiwicmVzQm9keSIsInRpbWVvdXRSZXF1ZXN0T2JqZWN0cyIsImRlYnVnIiwiSlNPTiIsInN0cmluZ2lmeSIsInRpbWVvdXRPYmoiLCJzdGF0dXNDb2RlIiwicHJveHlTZXRXaW5kb3ciLCJib2R5T2JqIiwidXRpbCIsInNhZmVKc29uUGFyc2UiLCJpc1BsYWluT2JqZWN0IiwibmFtZSIsImhhbmRsZSIsInByb3h5U2V0VmFsdWUiLCJoYXNWYWx1ZSIsInRleHQiLCJpc1N0cmluZyIsImlzQXJyYXkiLCJqb2luIiwiT2JqZWN0IiwiYXNzaWduIiwicHJveHlTZXRGcmFtZSIsImlkIiwiTUpTT05XUF9FTEVNRU5UX0tFWSIsIlczQ19FTEVNRU5UX0tFWSIsInByb3h5UGVyZm9ybUFjdGlvbnMiLCJjb252ZXJ0QW5kUHJveHkiLCJjb21tYW5kTmFtZSIsInJlcyIsInJlc0JvZHlPYmoiLCJyZXdyaXR0ZW5VcmwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBRUEsTUFBTUEsR0FBRyxHQUFHQyxzQkFBT0MsU0FBUCxDQUFpQixvQkFBakIsQ0FBWjs7QUFHTyxNQUFNQyxzQkFBc0IsR0FBRyxDQUNwQztBQUNFQyxFQUFBQSxZQUFZLEVBQUUsQ0FBQyxTQUFELEVBQVksY0FBWixDQURoQjtBQUVFQyxFQUFBQSxlQUFlLEVBQUdDLEdBQUQsSUFBU0EsR0FBRyxDQUFDQyxPQUFKLENBQVksYUFBWixFQUN4QkQsR0FBRyxDQUFDRSxRQUFKLENBQWEsT0FBYixJQUF3QixnQkFBeEIsR0FBMkMsVUFEbkIsQ0FGNUI7QUFJRUMsRUFBQUEsWUFBWSxFQUFHSCxHQUFELElBQVNBLEdBQUcsQ0FBQ0MsT0FBSixDQUFZLGFBQVosRUFDckJELEdBQUcsQ0FBQ0UsUUFBSixDQUFhLE9BQWIsSUFBd0IsZ0JBQXhCLEdBQTJDLGVBRHRCO0FBSnpCLENBRG9DLEVBUXBDO0FBQ0VKLEVBQUFBLFlBQVksRUFBRSxDQUFDLHNCQUFELENBRGhCO0FBRUVDLEVBQUFBLGVBQWUsRUFBR0MsR0FBRCxJQUFTQSxHQUFHLENBQUNDLE9BQUosQ0FBWSxpQ0FBWixFQUN4QixnQkFEd0IsQ0FGNUI7QUFJRUUsRUFBQUEsWUFBWSxFQUFHSCxHQUFELElBQVNBLEdBQUcsQ0FBQ0MsT0FBSixDQUFZLHVCQUFaLEVBQ3JCLHdCQURxQjtBQUp6QixDQVJvQyxFQWVwQztBQUNFSCxFQUFBQSxZQUFZLEVBQUUsQ0FBQyxrQkFBRCxFQUFxQixpQkFBckIsQ0FEaEI7O0FBRUVDLEVBQUFBLGVBQWUsQ0FBRUMsR0FBRixFQUFPO0FBQ3BCLFdBQU8sWUFBWUksSUFBWixDQUFpQkosR0FBakIsSUFDSEEsR0FBRyxDQUFDQyxPQUFKLENBQVksV0FBWixFQUF5QixnQkFBekIsQ0FERyxHQUVIRCxHQUFHLENBQUNDLE9BQUosQ0FBWSx1QkFBWixFQUFxQyxrQkFBckMsQ0FGSjtBQUdELEdBTkg7O0FBT0VFLEVBQUFBLFlBQVksQ0FBRUgsR0FBRixFQUFPO0FBQ2pCLFdBQU8sbUJBQW1CSSxJQUFuQixDQUF3QkosR0FBeEIsSUFDSEEsR0FBRyxDQUFDQyxPQUFKLENBQVksa0JBQVosRUFBZ0MsU0FBaEMsQ0FERyxHQUVIRCxHQUFHLENBQUNDLE9BQUosQ0FBWSxtQkFBWixFQUFpQyxpQkFBakMsQ0FGSjtBQUdEOztBQVhILENBZm9DLEVBNEJwQztBQUNFSCxFQUFBQSxZQUFZLEVBQUUsQ0FBQyxhQUFELENBRGhCO0FBRUVDLEVBQUFBLGVBQWUsRUFBR00sTUFBRCxJQUFZO0FBQzNCLFVBQU1DLGdCQUFnQixHQUFHLHVDQUF6QjtBQUNBLFVBQU1DLFNBQVMsR0FBR0YsTUFBTSxDQUFDSixPQUFQLENBQWVLLGdCQUFmLEVBQWlDLDBCQUFqQyxDQUFsQjtBQUNBWixJQUFBQSxHQUFHLENBQUNjLElBQUosQ0FBVSxtQkFBa0JILE1BQU8sU0FBUUUsU0FBVSxHQUFyRDtBQUNBLFdBQU9BLFNBQVA7QUFDRCxHQVBIO0FBUUVKLEVBQUFBLFlBQVksRUFBR0ksU0FBRCxJQUFlQTtBQVIvQixDQTVCb0MsQ0FBL0I7O0FBd0NQLE1BQU07QUFBQ0UsRUFBQUEsT0FBRDtBQUFVQyxFQUFBQTtBQUFWLElBQWlCQyxvQkFBdkI7O0FBR0EsTUFBTUMsaUJBQU4sQ0FBd0I7QUFDdEJDLEVBQUFBLFdBQVcsQ0FBRUMsU0FBRixFQUFhO0FBQ3RCLFNBQUtBLFNBQUwsR0FBaUJBLFNBQWpCO0FBQ0EsU0FBS0MsbUJBQUwsR0FBMkIsSUFBM0I7QUFDRDs7QUFFRCxNQUFJQyxrQkFBSixDQUF3QkMsS0FBeEIsRUFBK0I7QUFDN0IsU0FBS0YsbUJBQUwsR0FBMkJFLEtBQTNCO0FBQ0Q7O0FBRUQsTUFBSUQsa0JBQUosR0FBMEI7QUFDeEIsV0FBTyxLQUFLRCxtQkFBWjtBQUNEOztBQVVERyxFQUFBQSx3QkFBd0IsQ0FBRUMsSUFBRixFQUFRO0FBQzlCLFFBQUksS0FBS0gsa0JBQUwsS0FBNEJOLEdBQTVCLElBQW1DVSxnQkFBRUMsR0FBRixDQUFNRixJQUFOLEVBQVksSUFBWixDQUFuQyxJQUF3REMsZ0JBQUVDLEdBQUYsQ0FBTUYsSUFBTixFQUFZLE1BQVosQ0FBNUQsRUFBaUY7QUFDL0UsWUFBTUcsU0FBUyxHQUFJQyxDQUFELElBQU9BLENBQUMsS0FBSyxXQUFOLEdBQW9CLFVBQXBCLEdBQWlDQSxDQUExRDs7QUFDQSxhQUFPLENBQUM7QUFDTixTQUFDRCxTQUFTLENBQUNILElBQUksQ0FBQ0ssSUFBTixDQUFWLEdBQXdCTCxJQUFJLENBQUNNO0FBRHZCLE9BQUQsQ0FBUDtBQUdEOztBQUVELFFBQUksS0FBS1Qsa0JBQUwsS0FBNEJQLE9BQTVCLEtBQXdDLENBQUNXLGdCQUFFQyxHQUFGLENBQU1GLElBQU4sRUFBWSxJQUFaLENBQUQsSUFBc0IsQ0FBQ0MsZ0JBQUVDLEdBQUYsQ0FBTUYsSUFBTixFQUFZLE1BQVosQ0FBL0QsQ0FBSixFQUF5RjtBQUN2RixZQUFNTyxZQUFZLEdBQUlILENBQUQsSUFBT0EsQ0FBQyxLQUFLLFVBQU4sR0FBbUIsV0FBbkIsR0FBaUNBLENBQTdEOztBQUNBLGFBQU9ILGdCQUFFTyxPQUFGLENBQVVSLElBQVYsRUFFSlMsTUFGSSxDQUVJQyxJQUFELElBQVUscUJBQXFCekIsSUFBckIsQ0FBMkIsR0FBRXlCLElBQUksQ0FBQyxDQUFELENBQUksRUFBckMsQ0FGYixFQUdKQyxHQUhJLENBR0EsVUFBVUQsSUFBVixFQUFnQjtBQUNuQixlQUFPO0FBQ0xMLFVBQUFBLElBQUksRUFBRUUsWUFBWSxDQUFDRyxJQUFJLENBQUMsQ0FBRCxDQUFMLENBRGI7QUFFTEosVUFBQUEsRUFBRSxFQUFFSSxJQUFJLENBQUMsQ0FBRDtBQUZILFNBQVA7QUFJRCxPQVJJLENBQVA7QUFTRDs7QUFFRCxXQUFPLENBQUNWLElBQUQsQ0FBUDtBQUNEOztBQVFELFFBQU1ZLGdCQUFOLENBQXdCL0IsR0FBeEIsRUFBNkJnQyxNQUE3QixFQUFxQ2IsSUFBckMsRUFBMkM7QUFDekMsUUFBSWMsUUFBSixFQUFjQyxPQUFkO0FBRUEsVUFBTUMscUJBQXFCLEdBQUcsS0FBS2pCLHdCQUFMLENBQThCQyxJQUE5QixDQUE5QjtBQUNBekIsSUFBQUEsR0FBRyxDQUFDMEMsS0FBSixDQUFXLHdEQUF1REMsSUFBSSxDQUFDQyxTQUFMLENBQWVILHFCQUFmLENBQXNDLEVBQXhHOztBQUNBLFNBQUssTUFBTUksVUFBWCxJQUF5QkoscUJBQXpCLEVBQWdEO0FBQzlDLE9BQUNGLFFBQUQsRUFBV0MsT0FBWCxJQUFzQixNQUFNLEtBQUtwQixTQUFMLENBQWVkLEdBQWYsRUFBb0JnQyxNQUFwQixFQUE0Qk8sVUFBNUIsQ0FBNUI7O0FBR0EsVUFBSSxLQUFLdkIsa0JBQUwsS0FBNEJQLE9BQWhDLEVBQXlDO0FBQ3ZDLGVBQU8sQ0FBQ3dCLFFBQUQsRUFBV0MsT0FBWCxDQUFQO0FBQ0Q7O0FBR0QsVUFBSUQsUUFBUSxDQUFDTyxVQUFULElBQXVCLEdBQTNCLEVBQWdDO0FBQzlCLGVBQU8sQ0FBQ1AsUUFBRCxFQUFXQyxPQUFYLENBQVA7QUFDRDtBQUdGOztBQUNELFdBQU8sQ0FBQ0QsUUFBRCxFQUFXQyxPQUFYLENBQVA7QUFDRDs7QUFFRCxRQUFNTyxjQUFOLENBQXNCekMsR0FBdEIsRUFBMkJnQyxNQUEzQixFQUFtQ2IsSUFBbkMsRUFBeUM7QUFDdkMsVUFBTXVCLE9BQU8sR0FBR0Msb0JBQUtDLGFBQUwsQ0FBbUJ6QixJQUFuQixDQUFoQjs7QUFDQSxRQUFJQyxnQkFBRXlCLGFBQUYsQ0FBZ0JILE9BQWhCLENBQUosRUFBOEI7QUFDNUIsVUFBSSxLQUFLMUIsa0JBQUwsS0FBNEJOLEdBQTVCLElBQW1DVSxnQkFBRUMsR0FBRixDQUFNcUIsT0FBTixFQUFlLE1BQWYsQ0FBbkMsSUFBNkQsQ0FBQ3RCLGdCQUFFQyxHQUFGLENBQU1xQixPQUFOLEVBQWUsUUFBZixDQUFsRSxFQUE0RjtBQUMxRmhELFFBQUFBLEdBQUcsQ0FBQzBDLEtBQUosQ0FBVyx3QkFBdUJNLE9BQU8sQ0FBQ0ksSUFBSywrQkFBL0M7QUFDQSxlQUFPLE1BQU0sS0FBS2hDLFNBQUwsQ0FBZWQsR0FBZixFQUFvQmdDLE1BQXBCLEVBQTRCLEVBQ3ZDLEdBQUdVLE9BRG9DO0FBRXZDSyxVQUFBQSxNQUFNLEVBQUVMLE9BQU8sQ0FBQ0k7QUFGdUIsU0FBNUIsQ0FBYjtBQUlEOztBQUNELFVBQUksS0FBSzlCLGtCQUFMLEtBQTRCUCxPQUE1QixJQUF1Q1csZ0JBQUVDLEdBQUYsQ0FBTXFCLE9BQU4sRUFBZSxRQUFmLENBQXZDLElBQW1FLENBQUN0QixnQkFBRUMsR0FBRixDQUFNcUIsT0FBTixFQUFlLE1BQWYsQ0FBeEUsRUFBZ0c7QUFDOUZoRCxRQUFBQSxHQUFHLENBQUMwQyxLQUFKLENBQVcsMEJBQXlCTSxPQUFPLENBQUNLLE1BQU8sZ0NBQW5EO0FBQ0EsZUFBTyxNQUFNLEtBQUtqQyxTQUFMLENBQWVkLEdBQWYsRUFBb0JnQyxNQUFwQixFQUE0QixFQUN2QyxHQUFHVSxPQURvQztBQUV2Q0ksVUFBQUEsSUFBSSxFQUFFSixPQUFPLENBQUNLO0FBRnlCLFNBQTVCLENBQWI7QUFJRDtBQUNGOztBQUVELFdBQU8sTUFBTSxLQUFLakMsU0FBTCxDQUFlZCxHQUFmLEVBQW9CZ0MsTUFBcEIsRUFBNEJiLElBQTVCLENBQWI7QUFDRDs7QUFFRCxRQUFNNkIsYUFBTixDQUFxQmhELEdBQXJCLEVBQTBCZ0MsTUFBMUIsRUFBa0NiLElBQWxDLEVBQXdDO0FBQ3RDLFVBQU11QixPQUFPLEdBQUdDLG9CQUFLQyxhQUFMLENBQW1CekIsSUFBbkIsQ0FBaEI7O0FBQ0EsUUFBSUMsZ0JBQUV5QixhQUFGLENBQWdCSCxPQUFoQixNQUE2QkMsb0JBQUtNLFFBQUwsQ0FBY1AsT0FBTyxDQUFDUSxJQUF0QixLQUErQlAsb0JBQUtNLFFBQUwsQ0FBY1AsT0FBTyxDQUFDekIsS0FBdEIsQ0FBNUQsQ0FBSixFQUErRjtBQUM3RixVQUFJO0FBQUNpQyxRQUFBQSxJQUFEO0FBQU9qQyxRQUFBQTtBQUFQLFVBQWdCeUIsT0FBcEI7O0FBQ0EsVUFBSUMsb0JBQUtNLFFBQUwsQ0FBY0MsSUFBZCxLQUF1QixDQUFDUCxvQkFBS00sUUFBTCxDQUFjaEMsS0FBZCxDQUE1QixFQUFrRDtBQUNoREEsUUFBQUEsS0FBSyxHQUFHRyxnQkFBRStCLFFBQUYsQ0FBV0QsSUFBWCxJQUNKLENBQUMsR0FBR0EsSUFBSixDQURJLEdBRUg5QixnQkFBRWdDLE9BQUYsQ0FBVUYsSUFBVixJQUFrQkEsSUFBbEIsR0FBeUIsRUFGOUI7QUFHQXhELFFBQUFBLEdBQUcsQ0FBQzBDLEtBQUosQ0FBVywwQkFBeUJDLElBQUksQ0FBQ0MsU0FBTCxDQUFlckIsS0FBZixDQUFzQiw2QkFBMUQ7QUFDRCxPQUxELE1BS08sSUFBSSxDQUFDMEIsb0JBQUtNLFFBQUwsQ0FBY0MsSUFBZCxDQUFELElBQXdCUCxvQkFBS00sUUFBTCxDQUFjaEMsS0FBZCxDQUE1QixFQUFrRDtBQUN2RGlDLFFBQUFBLElBQUksR0FBRzlCLGdCQUFFZ0MsT0FBRixDQUFVbkMsS0FBVixJQUNIQSxLQUFLLENBQUNvQyxJQUFOLENBQVcsRUFBWCxDQURHLEdBRUZqQyxnQkFBRStCLFFBQUYsQ0FBV2xDLEtBQVgsSUFBb0JBLEtBQXBCLEdBQTRCLEVBRmpDO0FBR0F2QixRQUFBQSxHQUFHLENBQUMwQyxLQUFKLENBQVcseUJBQXdCQyxJQUFJLENBQUNDLFNBQUwsQ0FBZVksSUFBZixDQUFxQiw2QkFBeEQ7QUFDRDs7QUFDRCxhQUFPLE1BQU0sS0FBS3BDLFNBQUwsQ0FBZWQsR0FBZixFQUFvQmdDLE1BQXBCLEVBQTRCc0IsTUFBTSxDQUFDQyxNQUFQLENBQWMsRUFBZCxFQUFrQmIsT0FBbEIsRUFBMkI7QUFDbEVRLFFBQUFBLElBRGtFO0FBRWxFakMsUUFBQUE7QUFGa0UsT0FBM0IsQ0FBNUIsQ0FBYjtBQUlEOztBQUVELFdBQU8sTUFBTSxLQUFLSCxTQUFMLENBQWVkLEdBQWYsRUFBb0JnQyxNQUFwQixFQUE0QmIsSUFBNUIsQ0FBYjtBQUNEOztBQUVELFFBQU1xQyxhQUFOLENBQXFCeEQsR0FBckIsRUFBMEJnQyxNQUExQixFQUFrQ2IsSUFBbEMsRUFBd0M7QUFDdEMsVUFBTXVCLE9BQU8sR0FBR0Msb0JBQUtDLGFBQUwsQ0FBbUJ6QixJQUFuQixDQUFoQjs7QUFDQSxXQUFPQyxnQkFBRUMsR0FBRixDQUFNcUIsT0FBTixFQUFlLElBQWYsS0FBd0J0QixnQkFBRXlCLGFBQUYsQ0FBZ0JILE9BQU8sQ0FBQ2UsRUFBeEIsQ0FBeEIsR0FDSCxNQUFNLEtBQUszQyxTQUFMLENBQWVkLEdBQWYsRUFBb0JnQyxNQUFwQixFQUE0QixFQUNsQyxHQUFHVSxPQUQrQjtBQUVsQ2UsTUFBQUEsRUFBRSxFQUFFLDRCQUFjZixPQUFPLENBQUNlLEVBQXRCLEVBQTBCQyw4QkFBMUIsRUFBK0NDLDBCQUEvQztBQUY4QixLQUE1QixDQURILEdBS0gsTUFBTSxLQUFLN0MsU0FBTCxDQUFlZCxHQUFmLEVBQW9CZ0MsTUFBcEIsRUFBNEJiLElBQTVCLENBTFY7QUFNRDs7QUFFRCxRQUFNeUMsbUJBQU4sQ0FBMkI1RCxHQUEzQixFQUFnQ2dDLE1BQWhDLEVBQXdDYixJQUF4QyxFQUE4QztBQUM1QyxVQUFNdUIsT0FBTyxHQUFHQyxvQkFBS0MsYUFBTCxDQUFtQnpCLElBQW5CLENBQWhCOztBQUNBLFdBQU9DLGdCQUFFeUIsYUFBRixDQUFnQkgsT0FBaEIsSUFDSCxNQUFNLEtBQUs1QixTQUFMLENBQWVkLEdBQWYsRUFBb0JnQyxNQUFwQixFQUE0Qiw0QkFBY1UsT0FBZCxFQUF1QmdCLDhCQUF2QixFQUE0Q0MsMEJBQTVDLENBQTVCLENBREgsR0FFSCxNQUFNLEtBQUs3QyxTQUFMLENBQWVkLEdBQWYsRUFBb0JnQyxNQUFwQixFQUE0QmIsSUFBNUIsQ0FGVjtBQUdEOztBQVlELFFBQU0wQyxlQUFOLENBQXVCQyxXQUF2QixFQUFvQzlELEdBQXBDLEVBQXlDZ0MsTUFBekMsRUFBaURiLElBQWpELEVBQXVEO0FBQ3JELFFBQUksQ0FBQyxLQUFLSCxrQkFBVixFQUE4QjtBQUc1QixZQUFNLENBQUMrQyxHQUFELEVBQU1DLFVBQU4sSUFBb0IsTUFBTSxLQUFLbEQsU0FBTCxDQUFlZCxHQUFmLEVBQW9CZ0MsTUFBcEIsRUFBNEJiLElBQTVCLENBQWhDO0FBQ0EsYUFBTyxDQUFDNEMsR0FBRCxFQUFNLDRCQUFhQyxVQUFiLEVBQXlCRCxHQUFHLENBQUN2QixVQUE3QixDQUFOLENBQVA7QUFDRDs7QUFHRCxZQUFRc0IsV0FBUjtBQUNFLFdBQUssVUFBTDtBQUNFLGVBQU8sTUFBTSxLQUFLL0IsZ0JBQUwsQ0FBc0IvQixHQUF0QixFQUEyQmdDLE1BQTNCLEVBQW1DYixJQUFuQyxDQUFiOztBQUNGLFdBQUssV0FBTDtBQUNFLGVBQU8sTUFBTSxLQUFLc0IsY0FBTCxDQUFvQnpDLEdBQXBCLEVBQXlCZ0MsTUFBekIsRUFBaUNiLElBQWpDLENBQWI7O0FBQ0YsV0FBSyxVQUFMO0FBQ0UsZUFBTyxNQUFNLEtBQUs2QixhQUFMLENBQW1CaEQsR0FBbkIsRUFBd0JnQyxNQUF4QixFQUFnQ2IsSUFBaEMsQ0FBYjs7QUFDRixXQUFLLGdCQUFMO0FBQ0UsZUFBTyxNQUFNLEtBQUt5QyxtQkFBTCxDQUF5QjVELEdBQXpCLEVBQThCZ0MsTUFBOUIsRUFBc0NiLElBQXRDLENBQWI7O0FBQ0YsV0FBSyxVQUFMO0FBQ0UsZUFBTyxNQUFNLEtBQUtxQyxhQUFMLENBQW1CeEQsR0FBbkIsRUFBd0JnQyxNQUF4QixFQUFnQ2IsSUFBaEMsQ0FBYjs7QUFDRjtBQUNFO0FBWko7O0FBZ0JBLFNBQUssTUFBTTtBQUFDckIsTUFBQUEsWUFBRDtBQUFlQyxNQUFBQSxlQUFmO0FBQWdDSSxNQUFBQTtBQUFoQyxLQUFYLElBQTRETixzQkFBNUQsRUFBb0Y7QUFDbEYsVUFBSSxDQUFDQyxZQUFZLENBQUNJLFFBQWIsQ0FBc0I0RCxXQUF0QixDQUFMLEVBQXlDO0FBQ3ZDO0FBQ0Q7O0FBRUQsWUFBTUcsWUFBWSxHQUFHLEtBQUtqRCxrQkFBTCxLQUE0QlAsT0FBNUIsR0FDakJWLGVBQWUsQ0FBQ0MsR0FBRCxDQURFLEdBRWpCRyxZQUFZLENBQUNILEdBQUQsQ0FGaEI7O0FBR0EsVUFBSWlFLFlBQVksS0FBS2pFLEdBQXJCLEVBQTBCO0FBQ3hCTixRQUFBQSxHQUFHLENBQUMwQyxLQUFKLENBQVcsaURBQWdEcEMsR0FBSSxJQUFyRCxHQUNQLE9BQU0sS0FBS2dCLGtCQUFtQixXQURqQztBQUVBO0FBQ0Q7O0FBQ0R0QixNQUFBQSxHQUFHLENBQUNjLElBQUosQ0FBVSw2QkFBNEJSLEdBQUksU0FBUWlFLFlBQWEsSUFBdEQsR0FDTixPQUFNLEtBQUtqRCxrQkFBbUIsV0FEakM7QUFFQSxhQUFPLE1BQU0sS0FBS0YsU0FBTCxDQUFlbUQsWUFBZixFQUE2QmpDLE1BQTdCLEVBQXFDYixJQUFyQyxDQUFiO0FBQ0Q7O0FBR0QsV0FBTyxNQUFNLEtBQUtMLFNBQUwsQ0FBZWQsR0FBZixFQUFvQmdDLE1BQXBCLEVBQTRCYixJQUE1QixDQUFiO0FBQ0Q7O0FBak1xQjs7ZUFvTVRQLGlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGxvZ2dlciwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGR1cGxpY2F0ZUtleXMgfSBmcm9tICcuLi9iYXNlZHJpdmVyL2hlbHBlcnMnO1xuaW1wb3J0IHtcbiAgTUpTT05XUF9FTEVNRU5UX0tFWSwgVzNDX0VMRU1FTlRfS0VZLCBQUk9UT0NPTFNcbn0gZnJvbSAnLi4vY29uc3RhbnRzJztcbmltcG9ydCB7IGZvcm1hdFN0YXR1cyB9IGZyb20gJy4uL3Byb3RvY29sL2hlbHBlcnMnO1xuXG5jb25zdCBsb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdQcm90b2NvbCBDb252ZXJ0ZXInKTtcblxuXG5leHBvcnQgY29uc3QgQ09NTUFORF9VUkxTX0NPTkZMSUNUUyA9IFtcbiAge1xuICAgIGNvbW1hbmROYW1lczogWydleGVjdXRlJywgJ2V4ZWN1dGVBc3luYyddLFxuICAgIGpzb253cENvbnZlcnRlcjogKHVybCkgPT4gdXJsLnJlcGxhY2UoL1xcL2V4ZWN1dGUuKi8sXG4gICAgICB1cmwuaW5jbHVkZXMoJ2FzeW5jJykgPyAnL2V4ZWN1dGVfYXN5bmMnIDogJy9leGVjdXRlJyksXG4gICAgdzNjQ29udmVydGVyOiAodXJsKSA9PiB1cmwucmVwbGFjZSgvXFwvZXhlY3V0ZS4qLyxcbiAgICAgIHVybC5pbmNsdWRlcygnYXN5bmMnKSA/ICcvZXhlY3V0ZS9hc3luYycgOiAnL2V4ZWN1dGUvc3luYycpLFxuICB9LFxuICB7XG4gICAgY29tbWFuZE5hbWVzOiBbJ2dldEVsZW1lbnRTY3JlZW5zaG90J10sXG4gICAganNvbndwQ29udmVydGVyOiAodXJsKSA9PiB1cmwucmVwbGFjZSgvXFwvZWxlbWVudFxcLyhbXi9dKylcXC9zY3JlZW5zaG90JC8sXG4gICAgICAnL3NjcmVlbnNob3QvJDEnKSxcbiAgICB3M2NDb252ZXJ0ZXI6ICh1cmwpID0+IHVybC5yZXBsYWNlKC9cXC9zY3JlZW5zaG90XFwvKFteL10rKS8sXG4gICAgICAnL2VsZW1lbnQvJDEvc2NyZWVuc2hvdCcpLFxuICB9LFxuICB7XG4gICAgY29tbWFuZE5hbWVzOiBbJ2dldFdpbmRvd0hhbmRsZXMnLCAnZ2V0V2luZG93SGFuZGxlJ10sXG4gICAganNvbndwQ29udmVydGVyICh1cmwpIHtcbiAgICAgIHJldHVybiAvXFwvd2luZG93JC8udGVzdCh1cmwpXG4gICAgICAgID8gdXJsLnJlcGxhY2UoL1xcL3dpbmRvdyQvLCAnL3dpbmRvd19oYW5kbGUnKVxuICAgICAgICA6IHVybC5yZXBsYWNlKC9cXC93aW5kb3dcXC9oYW5kbGUocz8pJC8sICcvd2luZG93X2hhbmRsZSQxJyk7XG4gICAgfSxcbiAgICB3M2NDb252ZXJ0ZXIgKHVybCkge1xuICAgICAgcmV0dXJuIC9cXC93aW5kb3dfaGFuZGxlJC8udGVzdCh1cmwpXG4gICAgICAgID8gdXJsLnJlcGxhY2UoL1xcL3dpbmRvd19oYW5kbGUkLywgJy93aW5kb3cnKVxuICAgICAgICA6IHVybC5yZXBsYWNlKC9cXC93aW5kb3dfaGFuZGxlcyQvLCAnL3dpbmRvdy9oYW5kbGVzJyk7XG4gICAgfSxcbiAgfSxcbiAge1xuICAgIGNvbW1hbmROYW1lczogWydnZXRQcm9wZXJ0eSddLFxuICAgIGpzb253cENvbnZlcnRlcjogKHczY1VybCkgPT4ge1xuICAgICAgY29uc3QgdzNjUHJvcGVydHlSZWdleCA9IC9cXC9lbGVtZW50XFwvKFteL10rKVxcL3Byb3BlcnR5XFwvKFteL10rKS87XG4gICAgICBjb25zdCBqc29ud3BVcmwgPSB3M2NVcmwucmVwbGFjZSh3M2NQcm9wZXJ0eVJlZ2V4LCAnL2VsZW1lbnQvJDEvYXR0cmlidXRlLyQyJyk7XG4gICAgICBsb2cuaW5mbyhgQ29udmVydGluZyBXM0MgJyR7dzNjVXJsfScgdG8gJyR7anNvbndwVXJsfSdgKTtcbiAgICAgIHJldHVybiBqc29ud3BVcmw7XG4gICAgfSxcbiAgICB3M2NDb252ZXJ0ZXI6IChqc29ud3BVcmwpID0+IGpzb253cFVybCAvLyBEb24ndCBjb252ZXJ0IEpTT05XUCBVUkwgdG8gVzNDLiBXM0MgYWNjZXB0cyAvYXR0cmlidXRlIGFuZCAvcHJvcGVydHlcbiAgfVxuXTtcblxuY29uc3Qge01KU09OV1AsIFczQ30gPSBQUk9UT0NPTFM7XG5cblxuY2xhc3MgUHJvdG9jb2xDb252ZXJ0ZXIge1xuICBjb25zdHJ1Y3RvciAocHJveHlGdW5jKSB7XG4gICAgdGhpcy5wcm94eUZ1bmMgPSBwcm94eUZ1bmM7XG4gICAgdGhpcy5fZG93bnN0cmVhbVByb3RvY29sID0gbnVsbDtcbiAgfVxuXG4gIHNldCBkb3duc3RyZWFtUHJvdG9jb2wgKHZhbHVlKSB7XG4gICAgdGhpcy5fZG93bnN0cmVhbVByb3RvY29sID0gdmFsdWU7XG4gIH1cblxuICBnZXQgZG93bnN0cmVhbVByb3RvY29sICgpIHtcbiAgICByZXR1cm4gdGhpcy5fZG93bnN0cmVhbVByb3RvY29sO1xuICB9XG5cbiAgLyoqXG4gICAqIFczQyAvdGltZW91dHMgY2FuIHRha2UgYXMgbWFueSBhcyAzIHRpbWVvdXQgdHlwZXMgYXQgb25jZSwgTUpTT05XUCAvdGltZW91dHMgb25seSB0YWtlcyBvbmVcbiAgICogYXQgYSB0aW1lLiBTbyBpZiB3ZSdyZSB1c2luZyBXM0MgYW5kIHByb3h5aW5nIHRvIE1KU09OV1AgYW5kIHRoZXJlJ3MgbW9yZSB0aGFuIG9uZSB0aW1lb3V0IHR5cGVcbiAgICogcHJvdmlkZWQgaW4gdGhlIHJlcXVlc3QsIHdlIG5lZWQgdG8gZG8gMyBwcm94aWVzIGFuZCBjb21iaW5lIHRoZSByZXN1bHRcbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IGJvZHkgUmVxdWVzdCBib2R5XG4gICAqIEByZXR1cm4ge0FycmF5fSBBcnJheSBvZiBXM0MgKyBNSlNPTldQIGNvbXBhdGlibGUgdGltZW91dCBvYmplY3RzXG4gICAqL1xuICBnZXRUaW1lb3V0UmVxdWVzdE9iamVjdHMgKGJvZHkpIHtcbiAgICBpZiAodGhpcy5kb3duc3RyZWFtUHJvdG9jb2wgPT09IFczQyAmJiBfLmhhcyhib2R5LCAnbXMnKSAmJiBfLmhhcyhib2R5LCAndHlwZScpKSB7XG4gICAgICBjb25zdCB0eXBlVG9XM0MgPSAoeCkgPT4geCA9PT0gJ3BhZ2UgbG9hZCcgPyAncGFnZUxvYWQnIDogeDtcbiAgICAgIHJldHVybiBbe1xuICAgICAgICBbdHlwZVRvVzNDKGJvZHkudHlwZSldOiBib2R5Lm1zLFxuICAgICAgfV07XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuZG93bnN0cmVhbVByb3RvY29sID09PSBNSlNPTldQICYmICghXy5oYXMoYm9keSwgJ21zJykgfHwgIV8uaGFzKGJvZHksICd0eXBlJykpKSB7XG4gICAgICBjb25zdCB0eXBlVG9KU09OV1AgPSAoeCkgPT4geCA9PT0gJ3BhZ2VMb2FkJyA/ICdwYWdlIGxvYWQnIDogeDtcbiAgICAgIHJldHVybiBfLnRvUGFpcnMoYm9keSlcbiAgICAgICAgLy8gT25seSB0cmFuc2Zvcm0gdGhlIGVudHJ5IGlmIG1zIHZhbHVlIGlzIGEgdmFsaWQgcG9zaXRpdmUgZmxvYXQgbnVtYmVyXG4gICAgICAgIC5maWx0ZXIoKHBhaXIpID0+IC9eXFxkKyg/OlsuLF1cXGQqPyk/JC8udGVzdChgJHtwYWlyWzFdfWApKVxuICAgICAgICAubWFwKGZ1bmN0aW9uIChwYWlyKSB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR5cGU6IHR5cGVUb0pTT05XUChwYWlyWzBdKSxcbiAgICAgICAgICAgIG1zOiBwYWlyWzFdLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBbYm9keV07XG4gIH1cblxuICAvKipcbiAgICogUHJveHkgYW4gYXJyYXkgb2YgdGltZW91dCBvYmplY3RzIGFuZCBtZXJnZSB0aGUgcmVzdWx0XG4gICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwgRW5kcG9pbnQgdXJsXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgRW5kcG9pbnQgbWV0aG9kXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBib2R5IFJlcXVlc3QgYm9keVxuICAgKi9cbiAgYXN5bmMgcHJveHlTZXRUaW1lb3V0cyAodXJsLCBtZXRob2QsIGJvZHkpIHtcbiAgICBsZXQgcmVzcG9uc2UsIHJlc0JvZHk7XG5cbiAgICBjb25zdCB0aW1lb3V0UmVxdWVzdE9iamVjdHMgPSB0aGlzLmdldFRpbWVvdXRSZXF1ZXN0T2JqZWN0cyhib2R5KTtcbiAgICBsb2cuZGVidWcoYFdpbGwgc2VuZCB0aGUgZm9sbG93aW5nIHJlcXVlc3QgYm9kaWVzIHRvIC90aW1lb3V0czogJHtKU09OLnN0cmluZ2lmeSh0aW1lb3V0UmVxdWVzdE9iamVjdHMpfWApO1xuICAgIGZvciAoY29uc3QgdGltZW91dE9iaiBvZiB0aW1lb3V0UmVxdWVzdE9iamVjdHMpIHtcbiAgICAgIFtyZXNwb25zZSwgcmVzQm9keV0gPSBhd2FpdCB0aGlzLnByb3h5RnVuYyh1cmwsIG1ldGhvZCwgdGltZW91dE9iaik7XG5cbiAgICAgIC8vIElmIHdlIGdvdCBhIG5vbi1NSlNPTldQIHJlc3BvbnNlLCByZXR1cm4gdGhlIHJlc3VsdCwgbm90aGluZyBsZWZ0IHRvIGRvXG4gICAgICBpZiAodGhpcy5kb3duc3RyZWFtUHJvdG9jb2wgIT09IE1KU09OV1ApIHtcbiAgICAgICAgcmV0dXJuIFtyZXNwb25zZSwgcmVzQm9keV07XG4gICAgICB9XG5cbiAgICAgIC8vIElmIHdlIGdvdCBhbiBlcnJvciwgcmV0dXJuIHRoZSBlcnJvciByaWdodCBhd2F5XG4gICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA+PSA0MDApIHtcbiAgICAgICAgcmV0dXJuIFtyZXNwb25zZSwgcmVzQm9keV07XG4gICAgICB9XG5cbiAgICAgIC8vIC4uLk90aGVyd2lzZSwgY29udGludWUgdG8gdGhlIG5leHQgdGltZW91dHMgY2FsbFxuICAgIH1cbiAgICByZXR1cm4gW3Jlc3BvbnNlLCByZXNCb2R5XTtcbiAgfVxuXG4gIGFzeW5jIHByb3h5U2V0V2luZG93ICh1cmwsIG1ldGhvZCwgYm9keSkge1xuICAgIGNvbnN0IGJvZHlPYmogPSB1dGlsLnNhZmVKc29uUGFyc2UoYm9keSk7XG4gICAgaWYgKF8uaXNQbGFpbk9iamVjdChib2R5T2JqKSkge1xuICAgICAgaWYgKHRoaXMuZG93bnN0cmVhbVByb3RvY29sID09PSBXM0MgJiYgXy5oYXMoYm9keU9iaiwgJ25hbWUnKSAmJiAhXy5oYXMoYm9keU9iaiwgJ2hhbmRsZScpKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgQ29waWVkICduYW1lJyB2YWx1ZSAnJHtib2R5T2JqLm5hbWV9JyB0byAnaGFuZGxlJyBhcyBwZXIgVzNDIHNwZWNgKTtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kLCB7XG4gICAgICAgICAgLi4uYm9keU9iaixcbiAgICAgICAgICBoYW5kbGU6IGJvZHlPYmoubmFtZSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5kb3duc3RyZWFtUHJvdG9jb2wgPT09IE1KU09OV1AgJiYgXy5oYXMoYm9keU9iaiwgJ2hhbmRsZScpICYmICFfLmhhcyhib2R5T2JqLCAnbmFtZScpKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgQ29waWVkICdoYW5kbGUnIHZhbHVlICcke2JvZHlPYmouaGFuZGxlfScgdG8gJ25hbWUnIGFzIHBlciBKU09OV1Agc3BlY2ApO1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUZ1bmModXJsLCBtZXRob2QsIHtcbiAgICAgICAgICAuLi5ib2R5T2JqLFxuICAgICAgICAgIG5hbWU6IGJvZHlPYmouaGFuZGxlLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUZ1bmModXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG5cbiAgYXN5bmMgcHJveHlTZXRWYWx1ZSAodXJsLCBtZXRob2QsIGJvZHkpIHtcbiAgICBjb25zdCBib2R5T2JqID0gdXRpbC5zYWZlSnNvblBhcnNlKGJvZHkpO1xuICAgIGlmIChfLmlzUGxhaW5PYmplY3QoYm9keU9iaikgJiYgKHV0aWwuaGFzVmFsdWUoYm9keU9iai50ZXh0KSB8fCB1dGlsLmhhc1ZhbHVlKGJvZHlPYmoudmFsdWUpKSkge1xuICAgICAgbGV0IHt0ZXh0LCB2YWx1ZX0gPSBib2R5T2JqO1xuICAgICAgaWYgKHV0aWwuaGFzVmFsdWUodGV4dCkgJiYgIXV0aWwuaGFzVmFsdWUodmFsdWUpKSB7XG4gICAgICAgIHZhbHVlID0gXy5pc1N0cmluZyh0ZXh0KVxuICAgICAgICAgID8gWy4uLnRleHRdXG4gICAgICAgICAgOiAoXy5pc0FycmF5KHRleHQpID8gdGV4dCA6IFtdKTtcbiAgICAgICAgbG9nLmRlYnVnKGBBZGRlZCAndmFsdWUnIHByb3BlcnR5ICR7SlNPTi5zdHJpbmdpZnkodmFsdWUpfSB0byAnc2V0VmFsdWUnIHJlcXVlc3QgYm9keWApO1xuICAgICAgfSBlbHNlIGlmICghdXRpbC5oYXNWYWx1ZSh0ZXh0KSAmJiB1dGlsLmhhc1ZhbHVlKHZhbHVlKSkge1xuICAgICAgICB0ZXh0ID0gXy5pc0FycmF5KHZhbHVlKVxuICAgICAgICAgID8gdmFsdWUuam9pbignJylcbiAgICAgICAgICA6IChfLmlzU3RyaW5nKHZhbHVlKSA/IHZhbHVlIDogJycpO1xuICAgICAgICBsb2cuZGVidWcoYEFkZGVkICd0ZXh0JyBwcm9wZXJ0eSAke0pTT04uc3RyaW5naWZ5KHRleHQpfSB0byAnc2V0VmFsdWUnIHJlcXVlc3QgYm9keWApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kLCBPYmplY3QuYXNzaWduKHt9LCBib2R5T2JqLCB7XG4gICAgICAgIHRleHQsXG4gICAgICAgIHZhbHVlLFxuICAgICAgfSkpO1xuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5RnVuYyh1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cblxuICBhc3luYyBwcm94eVNldEZyYW1lICh1cmwsIG1ldGhvZCwgYm9keSkge1xuICAgIGNvbnN0IGJvZHlPYmogPSB1dGlsLnNhZmVKc29uUGFyc2UoYm9keSk7XG4gICAgcmV0dXJuIF8uaGFzKGJvZHlPYmosICdpZCcpICYmIF8uaXNQbGFpbk9iamVjdChib2R5T2JqLmlkKVxuICAgICAgPyBhd2FpdCB0aGlzLnByb3h5RnVuYyh1cmwsIG1ldGhvZCwge1xuICAgICAgICAuLi5ib2R5T2JqLFxuICAgICAgICBpZDogZHVwbGljYXRlS2V5cyhib2R5T2JqLmlkLCBNSlNPTldQX0VMRU1FTlRfS0VZLCBXM0NfRUxFTUVOVF9LRVkpLFxuICAgICAgfSlcbiAgICAgIDogYXdhaXQgdGhpcy5wcm94eUZ1bmModXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG5cbiAgYXN5bmMgcHJveHlQZXJmb3JtQWN0aW9ucyAodXJsLCBtZXRob2QsIGJvZHkpIHtcbiAgICBjb25zdCBib2R5T2JqID0gdXRpbC5zYWZlSnNvblBhcnNlKGJvZHkpO1xuICAgIHJldHVybiBfLmlzUGxhaW5PYmplY3QoYm9keU9iailcbiAgICAgID8gYXdhaXQgdGhpcy5wcm94eUZ1bmModXJsLCBtZXRob2QsIGR1cGxpY2F0ZUtleXMoYm9keU9iaiwgTUpTT05XUF9FTEVNRU5UX0tFWSwgVzNDX0VMRU1FTlRfS0VZKSlcbiAgICAgIDogYXdhaXQgdGhpcy5wcm94eUZ1bmModXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBcImNyb3NzaW5nXCIgZW5kcG9pbnRzIGZvciB0aGUgY2FzZVxuICAgKiB3aGVuIHVwc3RyZWFtIGFuZCBkb3duc3RyZWFtIGRyaXZlcnMgb3BlcmF0ZSBkaWZmZXJlbnQgcHJvdG9jb2xzXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb21tYW5kTmFtZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2RcbiAgICogQHBhcmFtIHs/c3RyaW5nfG9iamVjdH0gYm9keVxuICAgKiBAcmV0dXJucyBUaGUgcHJveHlmeWluZyByZXN1bHQgYXMgW3Jlc3BvbnNlLCByZXNwb25zZUJvZHldIHR1cGxlXG4gICAqL1xuICBhc3luYyBjb252ZXJ0QW5kUHJveHkgKGNvbW1hbmROYW1lLCB1cmwsIG1ldGhvZCwgYm9keSkge1xuICAgIGlmICghdGhpcy5kb3duc3RyZWFtUHJvdG9jb2wpIHtcbiAgICAgIC8vIFBhdGNoIGNhbGxzIHdpdGggR0VORVJJQyBwcm90b2NvbFxuICAgICAgLy8gdG8gcHJlc2VydmUgdGhlIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgICAgIGNvbnN0IFtyZXMsIHJlc0JvZHlPYmpdID0gYXdhaXQgdGhpcy5wcm94eUZ1bmModXJsLCBtZXRob2QsIGJvZHkpO1xuICAgICAgcmV0dXJuIFtyZXMsIGZvcm1hdFN0YXR1cyhyZXNCb2R5T2JqLCByZXMuc3RhdHVzQ29kZSldO1xuICAgIH1cblxuICAgIC8vIFNhbWUgdXJsLCBidXQgZGlmZmVyZW50IGFyZ3VtZW50c1xuICAgIHN3aXRjaCAoY29tbWFuZE5hbWUpIHtcbiAgICAgIGNhc2UgJ3RpbWVvdXRzJzpcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlTZXRUaW1lb3V0cyh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgICBjYXNlICdzZXRXaW5kb3cnOlxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eVNldFdpbmRvdyh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgICBjYXNlICdzZXRWYWx1ZSc6XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5U2V0VmFsdWUodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgICAgY2FzZSAncGVyZm9ybUFjdGlvbnMnOlxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eVBlcmZvcm1BY3Rpb25zKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgICAgIGNhc2UgJ3NldEZyYW1lJzpcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlTZXRGcmFtZSh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICAvLyBTYW1lIGFyZ3VtZW50cywgYnV0IGRpZmZlcmVudCBVUkxzXG4gICAgZm9yIChjb25zdCB7Y29tbWFuZE5hbWVzLCBqc29ud3BDb252ZXJ0ZXIsIHczY0NvbnZlcnRlcn0gb2YgQ09NTUFORF9VUkxTX0NPTkZMSUNUUykge1xuICAgICAgaWYgKCFjb21tYW5kTmFtZXMuaW5jbHVkZXMoY29tbWFuZE5hbWUpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZXdyaXR0ZW5VcmwgPSB0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCA9PT0gTUpTT05XUFxuICAgICAgICA/IGpzb253cENvbnZlcnRlcih1cmwpXG4gICAgICAgIDogdzNjQ29udmVydGVyKHVybCk7XG4gICAgICBpZiAocmV3cml0dGVuVXJsID09PSB1cmwpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBEaWQgbm90IGtub3cgaG93IHRvIHJld3JpdGUgdGhlIG9yaWdpbmFsIFVSTCAnJHt1cmx9JyBgICtcbiAgICAgICAgICBgZm9yICR7dGhpcy5kb3duc3RyZWFtUHJvdG9jb2x9IHByb3RvY29sYCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgbG9nLmluZm8oYFJld3JvdGUgdGhlIG9yaWdpbmFsIFVSTCAnJHt1cmx9JyB0byAnJHtyZXdyaXR0ZW5Vcmx9JyBgICtcbiAgICAgICAgYGZvciAke3RoaXMuZG93bnN0cmVhbVByb3RvY29sfSBwcm90b2NvbGApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlGdW5jKHJld3JpdHRlblVybCwgbWV0aG9kLCBib2R5KTtcbiAgICB9XG5cbiAgICAvLyBObyBtYXRjaGVzIGZvdW5kLiBQcm9jZWVkIG5vcm1hbGx5XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBQcm90b2NvbENvbnZlcnRlcjtcbiJdLCJmaWxlIjoibGliL2pzb253cC1wcm94eS9wcm90b2NvbC1jb252ZXJ0ZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
