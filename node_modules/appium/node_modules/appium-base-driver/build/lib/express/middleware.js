"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.allowCrossDomain = allowCrossDomain;
exports.fixPythonContentType = fixPythonContentType;
exports.defaultToJSONContentType = defaultToJSONContentType;
exports.catchAllHandler = catchAllHandler;
exports.allowCrossDomainAsyncExecute = allowCrossDomainAsyncExecute;
exports.catch404Handler = catch404Handler;
Object.defineProperty(exports, "handleIdempotency", {
  enumerable: true,
  get: function () {
    return _idempotency.handleIdempotency;
  }
});

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _protocol = require("../protocol");

var _idempotency = require("./idempotency");

function allowCrossDomain(req, res, next) {
  try {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, OPTIONS, DELETE');
    res.header('Access-Control-Allow-Headers', 'Cache-Control, Pragma, Origin, X-Requested-With, Content-Type, Accept, User-Agent');

    if ('OPTIONS' === req.method) {
      return res.sendStatus(200);
    }
  } catch (err) {
    _logger.default.error(`Unexpected error: ${err.stack}`);
  }

  next();
}

function allowCrossDomainAsyncExecute(basePath) {
  return (req, res, next) => {
    const receiveAsyncResponseRegExp = new RegExp(`${_lodash.default.escapeRegExp(basePath)}/session/[a-f0-9-]+/(appium/)?receive_async_response`);

    if (!receiveAsyncResponseRegExp.test(req.url)) {
      return next();
    }

    allowCrossDomain(req, res, next);
  };
}

function fixPythonContentType(basePath) {
  return (req, res, next) => {
    if (new RegExp(`^${_lodash.default.escapeRegExp(basePath)}`).test(req.path) && /^Python/.test(req.headers['user-agent'])) {
      if (req.headers['content-type'] === 'application/x-www-form-urlencoded') {
        req.headers['content-type'] = 'application/json; charset=utf-8';
      }
    }

    next();
  };
}

function defaultToJSONContentType(req, res, next) {
  if (!req.headers['content-type']) {
    req.headers['content-type'] = 'application/json; charset=utf-8';
  }

  next();
}

function catchAllHandler(err, req, res, next) {
  if (res.headersSent) {
    return next(err);
  }

  _logger.default.error(`Uncaught error: ${err.message}`);

  _logger.default.error('Sending generic error response');

  const error = _protocol.errors.UnknownError;
  res.status(error.w3cStatus()).json(patchWithSessionId(req, {
    status: error.code(),
    value: {
      error: error.error(),
      message: `An unknown server-side error occurred while processing the command: ${err.message}`,
      stacktrace: err.stack
    }
  }));

  _logger.default.error(err);
}

function catch404Handler(req, res) {
  _logger.default.debug(`No route found for ${req.url}`);

  const error = _protocol.errors.UnknownCommandError;
  res.status(error.w3cStatus()).json(patchWithSessionId(req, {
    status: error.code(),
    value: {
      error: error.error(),
      message: 'The requested resource could not be found, or a request was ' + 'received using an HTTP method that is not supported by the mapped ' + 'resource',
      stacktrace: ''
    }
  }));
}

const SESSION_ID_PATTERN = /\/session\/([^/]+)/;

function patchWithSessionId(req, body) {
  const match = SESSION_ID_PATTERN.exec(req.url);

  if (match) {
    body.sessionId = match[1];
  }

  return body;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leHByZXNzL21pZGRsZXdhcmUuanMiXSwibmFtZXMiOlsiYWxsb3dDcm9zc0RvbWFpbiIsInJlcSIsInJlcyIsIm5leHQiLCJoZWFkZXIiLCJtZXRob2QiLCJzZW5kU3RhdHVzIiwiZXJyIiwibG9nIiwiZXJyb3IiLCJzdGFjayIsImFsbG93Q3Jvc3NEb21haW5Bc3luY0V4ZWN1dGUiLCJiYXNlUGF0aCIsInJlY2VpdmVBc3luY1Jlc3BvbnNlUmVnRXhwIiwiUmVnRXhwIiwiXyIsImVzY2FwZVJlZ0V4cCIsInRlc3QiLCJ1cmwiLCJmaXhQeXRob25Db250ZW50VHlwZSIsInBhdGgiLCJoZWFkZXJzIiwiZGVmYXVsdFRvSlNPTkNvbnRlbnRUeXBlIiwiY2F0Y2hBbGxIYW5kbGVyIiwiaGVhZGVyc1NlbnQiLCJtZXNzYWdlIiwiZXJyb3JzIiwiVW5rbm93bkVycm9yIiwic3RhdHVzIiwidzNjU3RhdHVzIiwianNvbiIsInBhdGNoV2l0aFNlc3Npb25JZCIsImNvZGUiLCJ2YWx1ZSIsInN0YWNrdHJhY2UiLCJjYXRjaDQwNEhhbmRsZXIiLCJkZWJ1ZyIsIlVua25vd25Db21tYW5kRXJyb3IiLCJTRVNTSU9OX0lEX1BBVFRFUk4iLCJib2R5IiwibWF0Y2giLCJleGVjIiwic2Vzc2lvbklkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsU0FBU0EsZ0JBQVQsQ0FBMkJDLEdBQTNCLEVBQWdDQyxHQUFoQyxFQUFxQ0MsSUFBckMsRUFBMkM7QUFDekMsTUFBSTtBQUNGRCxJQUFBQSxHQUFHLENBQUNFLE1BQUosQ0FBVyw2QkFBWCxFQUEwQyxHQUExQztBQUNBRixJQUFBQSxHQUFHLENBQUNFLE1BQUosQ0FBVyw4QkFBWCxFQUEyQyxpQ0FBM0M7QUFDQUYsSUFBQUEsR0FBRyxDQUFDRSxNQUFKLENBQVcsOEJBQVgsRUFBMkMsbUZBQTNDOztBQUdBLFFBQUksY0FBY0gsR0FBRyxDQUFDSSxN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VCxDQUEwQmxDLEdBQTFCLEVBQStCQyxHQUEvQixFQUFvQztBQUNsQ00sa0JBQUk0QixLQUFKLENBQVcsc0JBQXFCbkMsR0FBRyxDQUFDaUIsR0FBSSxFQUF4Qzs7QUFDQSxRQUFNVCxLQUFLLEdBQUdpQixpQkFBT1csbUJBQXJCO0FBQ0FuQyxFQUFBQSxHQUFHLENBQUMwQixNQUFKLENBQVduQixLQUFLLENBQUNvQixTQUFOLEVBQVgsRUFBOEJDLElBQTlCLENBQW1DQyxrQkFBa0IsQ0FBQzlCLEdBQUQsRUFBTTtBQUN6RDJCLElBQUFBLE1BQU0sRUFBRW5CLEtBQUssQ0FBQ3VCLElBQU4sRUFEaUQ7QUFFekRDLElBQUFBLEtBQUssRUFBRTtBQUNMeEIsTUFBQUEsS0FBSyxFQUFFQSxLQUFLLENBQUNBLEtBQU4sRUFERjtBQUVMZ0IsTUFBQUEsT0FBTyxFQUFFLGlFQUNQLG9FQURPLEdBRVAsVUFKRztBQUtMUyxNQUFBQSxVQUFVLEVBQUU7QUFMUDtBQUZrRCxHQUFOLENBQXJEO0FBVUQ7O0FBR0QsTUFBTUksa0JBQWtCLEdBQUcsb0JBQTNCOztBQUVBLFNBQVNQLGtCQUFULENBQTZCOUIsR0FBN0IsRUFBa0NzQyxJQUFsQyxFQUF3QztBQUN0QyxRQUFNQyxLQUFLLEdBQUdGLGtCQUFrQixDQUFDRyxJQUFuQixDQUF3QnhDLEdBQUcsQ0FBQ2lCLEdBQTVCLENBQWQ7O0FBQ0EsTUFBSXNCLEtBQUosRUFBVztBQUNURCxJQUFBQSxJQUFJLENBQUNHLFNBQUwsR0FBaUJGLEtBQUssQ0FBQyxDQUFELENBQXRCO0FBQ0Q7O0FBQ0QsU0FBT0QsSUFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnLi4vcHJvdG9jb2wnO1xuaW1wb3J0IHsgaGFuZGxlSWRlbXBvdGVuY3kgfSBmcm9tICcuL2lkZW1wb3RlbmN5JztcblxuZnVuY3Rpb24gYWxsb3dDcm9zc0RvbWFpbiAocmVxLCByZXMsIG5leHQpIHtcbiAgdHJ5IHtcbiAgICByZXMuaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nLCAnKicpO1xuICAgIHJlcy5oZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMnLCAnR0VULCBQT1NULCBQVVQsIE9QVElPTlMsIERFTEVURScpO1xuICAgIHJlcy5oZWFkZXIoJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnLCAnQ2FjaGUtQ29udHJvbCwgUHJhZ21hLCBPcmlnaW4sIFgtUmVxdWVzdGVkLVdpdGgsIENvbnRlbnQtVHlwZSwgQWNjZXB0LCBVc2VyLUFnZW50Jyk7XG5cbiAgICAvLyBuZWVkIHRvIHJlc3BvbmQgMjAwIHRvIE9QVElPTlNcbiAgICBpZiAoJ09QVElPTlMnID09PSByZXEubWV0aG9kKSB7XG4gICAgICByZXR1cm4gcmVzLnNlbmRTdGF0dXMoMjAwKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvcihgVW5leHBlY3RlZCBlcnJvcjogJHtlcnIuc3RhY2t9YCk7XG4gIH1cbiAgbmV4dCgpO1xufVxuXG5mdW5jdGlvbiBhbGxvd0Nyb3NzRG9tYWluQXN5bmNFeGVjdXRlIChiYXNlUGF0aCkge1xuICByZXR1cm4gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgLy8gdGhlcmUgYXJlIHR3byBwYXRocyBmb3IgYXN5bmMgcmVzcG9uc2VzLCBzbyBjb3ZlciBib3RoXG4gICAgLy8gaHR0cHM6Ly9yZWdleDEwMS5jb20vci90eFlpRXovMVxuICAgIGNvbnN0IHJlY2VpdmVBc3luY1Jlc3BvbnNlUmVnRXhwID0gbmV3IFJlZ0V4cChgJHtfLmVzY2FwZVJlZ0V4cChiYXNlUGF0aCl9L3Nlc3Npb24vW2EtZjAtOS1dKy8oYXBwaXVtLyk/cmVjZWl2ZV9hc3luY19yZXNwb25zZWApO1xuICAgIGlmICghcmVjZWl2ZUFzeW5jUmVzcG9uc2VSZWdFeHAudGVzdChyZXEudXJsKSkge1xuICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICB9XG4gICAgYWxsb3dDcm9zc0RvbWFpbihyZXEsIHJlcywgbmV4dCk7XG4gIH07XG59XG5cbmZ1bmN0aW9uIGZpeFB5dGhvbkNvbnRlbnRUeXBlIChiYXNlUGF0aCkge1xuICByZXR1cm4gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgLy8gaGFjayBiZWNhdXNlIHB5dGhvbiBjbGllbnQgbGlicmFyeSBnaXZlcyB1cyB3cm9uZyBjb250ZW50LXR5cGVcbiAgICBpZiAobmV3IFJlZ0V4cChgXiR7Xy5lc2NhcGVSZWdFeHAoYmFzZVBhdGgpfWApLnRlc3QocmVxLnBhdGgpICYmIC9eUHl0aG9uLy50ZXN0KHJlcS5oZWFkZXJzWyd1c2VyLWFnZW50J10pKSB7XG4gICAgICBpZiAocmVxLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddID09PSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJykge1xuICAgICAgICByZXEuaGVhZGVyc1snY29udGVudC10eXBlJ10gPSAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCc7XG4gICAgICB9XG4gICAgfVxuICAgIG5leHQoKTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gZGVmYXVsdFRvSlNPTkNvbnRlbnRUeXBlIChyZXEsIHJlcywgbmV4dCkge1xuICBpZiAoIXJlcS5oZWFkZXJzWydjb250ZW50LXR5cGUnXSkge1xuICAgIHJlcS5oZWFkZXJzWydjb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04JztcbiAgfVxuICBuZXh0KCk7XG59XG5cbmZ1bmN0aW9uIGNhdGNoQWxsSGFuZGxlciAoZXJyLCByZXEsIHJlcywgbmV4dCkge1xuICBpZiAocmVzLmhlYWRlcnNTZW50KSB7XG4gICAgcmV0dXJuIG5leHQoZXJyKTtcbiAgfVxuXG4gIGxvZy5lcnJvcihgVW5jYXVnaHQgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIGxvZy5lcnJvcignU2VuZGluZyBnZW5lcmljIGVycm9yIHJlc3BvbnNlJyk7XG4gIGNvbnN0IGVycm9yID0gZXJyb3JzLlVua25vd25FcnJvcjtcbiAgcmVzLnN0YXR1cyhlcnJvci53M2NTdGF0dXMoKSkuanNvbihwYXRjaFdpdGhTZXNzaW9uSWQocmVxLCB7XG4gICAgc3RhdHVzOiBlcnJvci5jb2RlKCksXG4gICAgdmFsdWU6IHtcbiAgICAgIGVycm9yOiBlcnJvci5lcnJvcigpLFxuICAgICAgbWVzc2FnZTogYEFuIHVua25vd24gc2VydmVyLXNpZGUgZXJyb3Igb2NjdXJyZWQgd2hpbGUgcHJvY2Vzc2luZyB0aGUgY29tbWFuZDogJHtlcnIubWVzc2FnZX1gLFxuICAgICAgc3RhY2t0cmFjZTogZXJyLnN0YWNrLFxuICAgIH1cbiAgfSkpO1xuICBsb2cuZXJyb3IoZXJyKTtcbn1cblxuZnVuY3Rpb24gY2F0Y2g0MDRIYW5kbGVyIChyZXEsIHJlcykge1xuICBsb2cuZGVidWcoYE5vIHJvdXRlIGZvdW5kIGZvciAke3JlcS51cmx9YCk7XG4gIGNvbnN0IGVycm9yID0gZXJyb3JzLlVua25vd25Db21tYW5kRXJyb3I7XG4gIHJlcy5zdGF0dXMoZXJyb3IudzNjU3RhdHVzKCkpLmpzb24ocGF0Y2hXaXRoU2Vzc2lvbklkKHJlcSwge1xuICAgIHN0YXR1czogZXJyb3IuY29kZSgpLFxuICAgIHZhbHVlOiB7XG4gICAgICBlcnJvcjogZXJyb3IuZXJyb3IoKSxcbiAgICAgIG1lc3NhZ2U6ICdUaGUgcmVxdWVzdGVkIHJlc291cmNlIGNvdWxkIG5vdCBiZSBmb3VuZCwgb3IgYSByZXF1ZXN0IHdhcyAnICtcbiAgICAgICAgJ3JlY2VpdmVkIHVzaW5nIGFuIEhUVFAgbWV0aG9kIHRoYXQgaXMgbm90IHN1cHBvcnRlZCBieSB0aGUgbWFwcGVkICcgK1xuICAgICAgICAncmVzb3VyY2UnLFxuICAgICAgc3RhY2t0cmFjZTogJycsXG4gICAgfVxuICB9KSk7XG59XG5cblxuY29uc3QgU0VTU0lPTl9JRF9QQVRURVJOID0gL1xcL3Nlc3Npb25cXC8oW14vXSspLztcblxuZnVuY3Rpb24gcGF0Y2hXaXRoU2Vzc2lvbklkIChyZXEsIGJvZHkpIHtcbiAgY29uc3QgbWF0Y2ggPSBTRVNTSU9OX0lEX1BBVFRFUk4uZXhlYyhyZXEudXJsKTtcbiAgaWYgKG1hdGNoKSB7XG4gICAgYm9keS5zZXNzaW9uSWQgPSBtYXRjaFsxXTtcbiAgfVxuICByZXR1cm4gYm9keTtcbn1cblxuZXhwb3J0IHtcbiAgYWxsb3dDcm9zc0RvbWFpbiwgZml4UHl0aG9uQ29udGVudFR5cGUsIGRlZmF1bHRUb0pTT05Db250ZW50VHlwZSxcbiAgY2F0Y2hBbGxIYW5kbGVyLCBhbGxvd0Nyb3NzRG9tYWluQXN5bmNFeGVjdXRlLCBoYW5kbGVJZGVtcG90ZW5jeSxcbiAgY2F0Y2g0MDRIYW5kbGVyLFxufTtcbiJdLCJmaWxlIjoibGliL2V4cHJlc3MvbWlkZGxld2FyZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
