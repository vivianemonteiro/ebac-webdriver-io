"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.addWebSocketHandler = addWebSocketHandler;
exports.removeWebSocketHandler = removeWebSocketHandler;
exports.removeAllWebSocketHandlers = removeAllWebSocketHandlers;
exports.getWebSocketHandlers = getWebSocketHandlers;
exports.DEFAULT_WS_PATHNAME_PREFIX = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _url = _interopRequireDefault(require("url"));

const DEFAULT_WS_PATHNAME_PREFIX = '/ws';
exports.DEFAULT_WS_PATHNAME_PREFIX = DEFAULT_WS_PATHNAME_PREFIX;

async function addWebSocketHandler(handlerPathname, handlerServer) {
  let isUpgradeListenerAssigned = true;

  if (_lodash.default.isUndefined(this.webSocketsMapping)) {
    this.webSocketsMapping = {};
    isUpgradeListenerAssigned = false;
  }

  this.webSocketsMapping[handlerPathname] = handlerServer;

  if (isUpgradeListenerAssigned) {
    return;
  }

  this.on('upgrade', (request, socket, head) => {
    const currentPathname = _url.default.parse(request.url).pathname;

    for (const [pathname, wsServer] of _lodash.default.toPairs(this.webSocketsMapping)) {
      if (currentPathname === pathname) {
        wsServer.handleUpgrade(request, socket, head, ws => {
          wsServer.emit('connection', ws, request);
        });
        return;
      }
    }

    socket.destroy();
  });
}

async function getWebSocketHandlers(keysFilter = null) {
  if (_lodash.default.isEmpty(this.webSocketsMapping)) {
    return {};
  }

  let result = {};

  for (const [pathname, wsServer] of _lodash.default.toPairs(this.webSocketsMapping)) {
    if (!_lodash.default.isString(keysFilter) || pathname.includes(keysFilter)) {
      result[pathname] = wsServer;
    }
  }

  return result;
}

async function removeWebSocketHandler(handlerPathname) {
  if (!this.webSocketsMapping || !this.webSocketsMapping[handlerPathname]) {
    return false;
  }

  const wsServer = this.webSocketsMapping[handlerPathname];

  try {
    wsServer.close();

    for (const client of wsServer.clients) {
      client.terminate();
    }

    return true;
  } catch (ign) {} finally {
    delete this.webSocketsMapping[handlerPathname];
  }

  return false;
}

async function removeAllWebSocketHandlers() {
  if (_lodash.default.isEmpty(this.webSocketsMapping)) {
    return false;
  }

  let result = false;

  for (const pathname of _lodash.default.keys(this.webSocketsMapping)) {
    result = result || (await this.removeWebSocketHandler(pathname));
  }

  return result;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leHByZXNzL3dlYnNvY2tldC5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWCIsImFkZFdlYlNvY2tldEhhbmRsZXIiLCJoYW5kbGVyUGF0aG5hbWUiLCJoYW5kbGVyU2VydmVyIiwiaXNVcGdyYWRlTGlzdGVuZXJBc3NpZ25lZCIsIl8iLCJpc1VuZGVmaW5lZCIsIndlYlNvY2tldHNNYXBwaW5nIiwib24iLCJyZXF1ZXN0Iiwic29ja2V0IiwiaGVhZCIsImN1cnJlbnRQYXRobmFtZSIsInVybCIsInBhcnNlIiwicGF0aG5hbWUiLCJ3c1NlcnZlciIsInRvUGFpcnMiLCJoYW5kbGVVcGdyYWRlIiwid3MiLCJlbWl0IiwiZGVzdHJveSIsImdldFdlYlNvY2tldEhhbmRsZXJzIiwia2V5c0ZpbHRlciIsImlzRW1wdHkiLCJyZXN1bHQiLCJpc1N0cmluZyIsImluY2x1ZGVzIiwicmVtb3ZlV2ViU29ja2V0SGFuZGxlciIsImNsb3NlIiwiY2xpZW50IiwiY2xpZW50cyIsInRlcm1pbmF0ZSIsImlnbiIsInJlbW92ZUFsbFdlYlNvY2tldEhhbmRsZXJzIiwia2V5cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUEsTUFBTUEsMEJBQTBCLEdBQUcsS0FBbkM7OztBQWdCQSxlQUFlQyxtQkFBZixDQUFvQ0MsZUFBcEMsRUFBcURDLGFBQXJELEVBQW9FO0FBQ2xFLE1BQUlDLHlCQUF5QixHQUFHLElBQWhDOztBQUNBLE1BQUlDLGdCQUFFQyxXQUFGLENBQWMsS0FBS0MsaUJBQW5CLENBQUosRUFBMkM7QUFDekMsU0FBS0EsaUJBQUwsR0FBeUIsRUFBekI7QUFDQUgsSUFBQUEseUJBQXlCLEdBQUcsS0FBNUI7QUFDRDs7QUFDRCxPQUFLRyxpQkFBTCxDQUF1QkwsZUFBdkIsSUFBMENDLGFBQTFDOztBQUNBLE1BQUlDLHlCQUFKLEVBQStCO0FBQzdCO0FBQ0Q7O0FBR0QsT0FBS0ksRUFBTCxDQUFRLFNBQVIsRUFBbUIsQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEVBQWtCQyxJQUFsQixLQUEyQjtBQUM1QyxVQUFNQyxlQUFlLEdBQUdDLGFBQUlDLEtBQUosQ0FBVUwsT0FBTyxDQUFDSSxHQUFsQixFQUF1QkUsUUFBL0M7O0FBQ0EsU0FBSyxNQUFNLENBQUNBLFFBQUQsRUFBV0MsUUFBWCxDQUFYLElBQW1DWCxnQkFBRVksT0FBRixDQUFVLEtBQUtWLGlCQUFmLENBQW5DLEVBQXNFO0FBQ3BFLFVBQUlLLGVBQWUsS0FBS0csUUFBeEIsRUFBa0M7QUFDaENDLFFBQUFBLFFBQVEsQ0FBQ0UsYUFBVCxDQUF1QlQsT0FBdkIsRUFBZ0NDLE1BQWhDLEVBQXdDQyxJQUF4QyxFQUErQ1EsRUFBRCxJQUFRO0FBQ3BESCxVQUFBQSxRQUFRLENBQUNJLElBQVQsQ0FBYyxZQUFkLEVBQTRCRCxFQUE1QixFQUFnQ1YsT0FBaEM7QUFDRCxTQUZEO0FBR0E7QUFDRDtBQUNGOztBQUNEQyxJQUFBQSxNQUFNLENBQUNXLE9BQVA7QUFDRCxHQVhEO0FBWUQ7O0FBYUQsZUFBZUMsb0JBQWYsQ0FBcUNDLFVBQVUsR0FBRyxJQUFsRCxFQUF3RDtBQUN0RCxNQUFJbEIsZ0JBQUVtQixPQUFGLENBQVUsS0FBS2pCLGlCQUFmLENBQUosRUFBdUM7QUFDckMsV0FBTyxFQUFQO0FBQ0Q7O0FBRUQsTUFBSWtCLE1BQU0sR0FBRyxFQUFiOztBQUNBLE9BQUssTUFBTSxDQUFDVixRQUFELEVBQVdDLFFBQVgsQ0FBWCxJQUFtQ1gsZ0JBQUVZLE9BQUYsQ0FBVSxLQUFLVixpQkFBZixDQUFuQyxFQUFzRTtBQUNwRSxRQUFJLENBQUNGLGdCQUFFcUIsUUFBRixDQUFXSCxVQUFYLENBQUQsSUFBMkJSLFFBQVEsQ0FBQ1ksUUFBVCxDQUFrQkosVUFBbEIsQ0FBL0IsRUFBOEQ7QUFDNURFLE1BQUFBLE1BQU0sQ0FBQ1YsUUFBRCxDQUFOLEdBQW1CQyxRQUFuQjtBQUNEO0FBQ0Y7O0FBQ0QsU0FBT1MsTUFBUDtBQUNEOztBQVlELGVBQWVHLHNCQUFmLENBQXVDMUIsZUFBdkMsRUFBd0Q7QUFDdEQsTUFBSSxDQUFDLEtBQUtLLGlCQUFOLElBQTJCLENBQUMsS0FBS0EsaUJBQUwsQ0FBdUJMLGVBQXZCLENBQWhDLEVBQXlFO0FBQ3ZFLFdBQU8sS0FBUDtBQUNEOztBQUVELFFBQU1jLFFBQVEsR0FBRyxLQUFLVCxpQkFBTCxDQUF1QkwsZUFBdkIsQ0FBakI7O0FBQ0EsTUFBSTtBQUNGYyxJQUFBQSxRQUFRLENBQUNhLEtBQVQ7O0FBQ0EsU0FBSyxNQUFNQyxNQUFYLElBQXFCZCxRQUFRLENBQUNlLE9BQTlCLEVBQXVDO0FBQ3JDRCxNQUFBQSxNQUFNLENBQUNFLFNBQVA7QUFDRDs7QUFDRCxXQUFPLElBQVA7QUFDRCxHQU5ELENBTUUsT0FBT0MsR0FBUCxFQUFZLENBRWIsQ0FSRCxTQVFVO0FBQ1IsV0FBTyxLQUFLMUIsaUJBQUwsQ0FBdUJMLGVBQXZCLENBQVA7QUFDRDs7QUFDRCxTQUFPLEtBQVA7QUFDRDs7QUFTRCxlQUFlZ0MsMEJBQWYsR0FBNkM7QUFDM0MsTUFBSTdCLGdCQUFFbUIsT0FBRixDQUFVLEtBQUtqQixpQkFBZixDQUFKLEVBQXVDO0FBQ3JDLFdBQU8sS0FBUDtBQUNEOztBQUVELE1BQUlrQixNQUFNLEdBQUcsS0FBYjs7QUFDQSxPQUFLLE1BQU1WLFFBQVgsSUFBdUJWLGdCQUFFOEIsSUFBRixDQUFPLEtBQUs1QixpQkFBWixDQUF2QixFQUF1RDtBQUNyRGtCLElBQUFBLE1BQU0sR0FBR0EsTUFBTSxLQUFJLE1BQU0sS0FBS0csc0JBQUwsQ0FBNEJiLFFBQTVCLENBQVYsQ0FBZjtBQUNEOztBQUNELFNBQU9VLE1BQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5cbmNvbnN0IERFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYID0gJy93cyc7XG5cblxuLyoqXG4gKiBBZGRzIHdlYnNvY2tldCBoYW5kbGVyIHRvIGV4cHJlc3Mgc2VydmVyIGluc3RhbmNlLlxuICogSXQgaXMgZXhwZWN0ZWQgdGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgaW4gRXhwcmVzc1xuICogc2VydmVyIGluc3RhbmNlIGNvbnRleHQuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IHNlcnZlciAtIEFuIGluc3RhbmNlIG9mIGV4cHJlc3MgSFRUUCBzZXJ2ZXIuXG4gKiBAcGFyYW0ge3N0cmluZ30gaGFuZGxlclBhdGhuYW1lIC0gV2ViIHNvY2tldCBlbmRwb2ludCBwYXRoIHN0YXJ0aW5nIHdpdGhcbiAqIGEgc2luZ2xlIHNsYXNoIGNoYXJhY3Rlci4gSXQgaXMgcmVjb21tZW5kZWQgdG8gYWx3YXlzIGFkZFxuICogREVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVggdG8gYWxsIHdlYiBzb2NrZXQgcGF0aG5hbWVzLlxuICogQHBhcmFtIHtPYmplY3R9IGhhbmRsZXJTZXJ2ZXIgLSBXZWJTb2NrZXQgc2VydmVyIGluc3RhbmNlLiBTZWVcbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS93ZWJzb2NrZXRzL3dzL3B1bGwvODg1IGZvciBtb3JlIGRldGFpbHNcbiAqIG9uIGhvdyB0byBjb25maWd1cmUgdGhlIGhhbmRsZXIgcHJvcGVybHkuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGFkZFdlYlNvY2tldEhhbmRsZXIgKGhhbmRsZXJQYXRobmFtZSwgaGFuZGxlclNlcnZlcikgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgbGV0IGlzVXBncmFkZUxpc3RlbmVyQXNzaWduZWQgPSB0cnVlO1xuICBpZiAoXy5pc1VuZGVmaW5lZCh0aGlzLndlYlNvY2tldHNNYXBwaW5nKSkge1xuICAgIHRoaXMud2ViU29ja2V0c01hcHBpbmcgPSB7fTtcbiAgICBpc1VwZ3JhZGVMaXN0ZW5lckFzc2lnbmVkID0gZmFsc2U7XG4gIH1cbiAgdGhpcy53ZWJTb2NrZXRzTWFwcGluZ1toYW5kbGVyUGF0aG5hbWVdID0gaGFuZGxlclNlcnZlcjtcbiAgaWYgKGlzVXBncmFkZUxpc3RlbmVyQXNzaWduZWQpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICAvLyBodHRwczovL2dpdGh1Yi5jb20vd2Vic29ja2V0cy93cy9wdWxsLzg4NVxuICB0aGlzLm9uKCd1cGdyYWRlJywgKHJlcXVlc3QsIHNvY2tldCwgaGVhZCkgPT4ge1xuICAgIGNvbnN0IGN1cnJlbnRQYXRobmFtZSA9IHVybC5wYXJzZShyZXF1ZXN0LnVybCkucGF0aG5hbWU7XG4gICAgZm9yIChjb25zdCBbcGF0aG5hbWUsIHdzU2VydmVyXSBvZiBfLnRvUGFpcnModGhpcy53ZWJTb2NrZXRzTWFwcGluZykpIHtcbiAgICAgIGlmIChjdXJyZW50UGF0aG5hbWUgPT09IHBhdGhuYW1lKSB7XG4gICAgICAgIHdzU2VydmVyLmhhbmRsZVVwZ3JhZGUocmVxdWVzdCwgc29ja2V0LCBoZWFkLCAod3MpID0+IHtcbiAgICAgICAgICB3c1NlcnZlci5lbWl0KCdjb25uZWN0aW9uJywgd3MsIHJlcXVlc3QpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgICBzb2NrZXQuZGVzdHJveSgpO1xuICB9KTtcbn1cblxuLyoqXG4gKiBSZXR1cm5zIHdlYiBzb2NrZXQgaGFuZGxlcnMgcmVnaXN0ZXJlZCBmb3IgdGhlIGdpdmVuIHNlcnZlclxuICogaW5zdGFuY2UuXG4gKiBJdCBpcyBleHBlY3RlZCB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBpbiBFeHByZXNzXG4gKiBzZXJ2ZXIgaW5zdGFuY2UgY29udGV4dC5cbiAqXG4gKiBAcGFyYW0gez9zdHJpbmd9IGtleXNGaWx0ZXIgW251bGxdLSBPbmx5IGluY2x1ZGUgcGF0aG5hbWVzIHdpdGggZ2l2ZW5cbiAqIGBrZXlzRmlsdGVyYCB2YWx1ZSBpZiBzZXQuIEFsbCBwYWlycyB3aWxsIGJlIGluY2x1ZGVkIGJ5IGRlZmF1bHQuXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBwYXRobmFtZXMgdG8gd2Vic29ja2V0IHNlcnZlciBpc250YW5jZXMgbWFwcGluZ1xuICogbWF0Y2hpbmcgdGhlIHNlYXJjaCBjcml0ZXJpYSBvciBhbiBlbXB0eSBvYmplY3Qgb3RoZXJ3aXNlLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRXZWJTb2NrZXRIYW5kbGVycyAoa2V5c0ZpbHRlciA9IG51bGwpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gIGlmIChfLmlzRW1wdHkodGhpcy53ZWJTb2NrZXRzTWFwcGluZykpIHtcbiAgICByZXR1cm4ge307XG4gIH1cblxuICBsZXQgcmVzdWx0ID0ge307XG4gIGZvciAoY29uc3QgW3BhdGhuYW1lLCB3c1NlcnZlcl0gb2YgXy50b1BhaXJzKHRoaXMud2ViU29ja2V0c01hcHBpbmcpKSB7XG4gICAgaWYgKCFfLmlzU3RyaW5nKGtleXNGaWx0ZXIpIHx8IHBhdGhuYW1lLmluY2x1ZGVzKGtleXNGaWx0ZXIpKSB7XG4gICAgICByZXN1bHRbcGF0aG5hbWVdID0gd3NTZXJ2ZXI7XG4gICAgfVxuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbi8qKlxuICogUmVtb3ZlcyBleGlzdGluZyB3ZWJzb2NrZXQgaGFuZGxlciBmcm9tIGV4cHJlc3Mgc2VydmVyIGluc3RhbmNlLlxuICogVGhlIGNhbGwgaXMgaWdub3JlZCBpZiB0aGUgZ2l2ZW4gYGhhbmRsZXJQYXRobmFtZWAgaGFuZGxlclxuICogaXMgbm90IHByZXNlbnQgaW4gdGhlIGhhbmRsZXJzIGxpc3QuXG4gKiBJdCBpcyBleHBlY3RlZCB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBpbiBFeHByZXNzXG4gKiBzZXJ2ZXIgaW5zdGFuY2UgY29udGV4dC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gaGFuZGxlclBhdGhuYW1lIC0gV2Vic29ja2V0IGVuZHBvaW50IHBhdGguXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gdHJ1ZSBpZiB0aGUgaGFuZGxlclBhdGhuYW1lIHdhcyBmb3VuZCBhbmQgZGVsZXRlZFxuICovXG5hc3luYyBmdW5jdGlvbiByZW1vdmVXZWJTb2NrZXRIYW5kbGVyIChoYW5kbGVyUGF0aG5hbWUpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gIGlmICghdGhpcy53ZWJTb2NrZXRzTWFwcGluZyB8fCAhdGhpcy53ZWJTb2NrZXRzTWFwcGluZ1toYW5kbGVyUGF0aG5hbWVdKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgY29uc3Qgd3NTZXJ2ZXIgPSB0aGlzLndlYlNvY2tldHNNYXBwaW5nW2hhbmRsZXJQYXRobmFtZV07XG4gIHRyeSB7XG4gICAgd3NTZXJ2ZXIuY2xvc2UoKTtcbiAgICBmb3IgKGNvbnN0IGNsaWVudCBvZiB3c1NlcnZlci5jbGllbnRzKSB7XG4gICAgICBjbGllbnQudGVybWluYXRlKCk7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChpZ24pIHtcbiAgICAvLyBpZ25vcmVcbiAgfSBmaW5hbGx5IHtcbiAgICBkZWxldGUgdGhpcy53ZWJTb2NrZXRzTWFwcGluZ1toYW5kbGVyUGF0aG5hbWVdO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuLyoqXG4gKiBSZW1vdmVzIGFsbCBleGlzdGluZyB3ZWJzb2NrZXQgaGFuZGxlciBmcm9tIGV4cHJlc3Mgc2VydmVyIGluc3RhbmNlLlxuICogSXQgaXMgZXhwZWN0ZWQgdGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgaW4gRXhwcmVzc1xuICogc2VydmVyIGluc3RhbmNlIGNvbnRleHQuXG4gKlxuICogQHJldHVybnMge2Jvb2xlYW59IHRydWUgaWYgYXQgbGVhc3Qgb25lIGhhbmRsZXIgaGFzIGJlZW4gZGVsZXRlZFxuICovXG5hc3luYyBmdW5jdGlvbiByZW1vdmVBbGxXZWJTb2NrZXRIYW5kbGVycyAoKSB7XG4gIGlmIChfLmlzRW1wdHkodGhpcy53ZWJTb2NrZXRzTWFwcGluZykpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBsZXQgcmVzdWx0ID0gZmFsc2U7XG4gIGZvciAoY29uc3QgcGF0aG5hbWUgb2YgXy5rZXlzKHRoaXMud2ViU29ja2V0c01hcHBpbmcpKSB7XG4gICAgcmVzdWx0ID0gcmVzdWx0IHx8IGF3YWl0IHRoaXMucmVtb3ZlV2ViU29ja2V0SGFuZGxlcihwYXRobmFtZSk7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZXhwb3J0IHtcbiAgYWRkV2ViU29ja2V0SGFuZGxlciwgcmVtb3ZlV2ViU29ja2V0SGFuZGxlciwgcmVtb3ZlQWxsV2ViU29ja2V0SGFuZGxlcnMsXG4gIGdldFdlYlNvY2tldEhhbmRsZXJzLCBERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWCxcbn07XG4iXSwiZmlsZSI6ImxpYi9leHByZXNzL3dlYnNvY2tldC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
