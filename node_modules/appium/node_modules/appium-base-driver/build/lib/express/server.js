"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.server = server;
exports.configureServer = configureServer;
exports.normalizeBasePath = normalizeBasePath;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _serveFavicon = _interopRequireDefault(require("serve-favicon"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var _methodOverride = _interopRequireDefault(require("method-override"));

var _logger = _interopRequireDefault(require("./logger"));

var _expressLogging = require("./express-logging");

var _middleware = require("./middleware");

var _static = require("./static");

var _crash = require("./crash");

var _websocket = require("./websocket");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _constants = require("../constants");

var _events = require("events");

const KEEP_ALIVE_TIMEOUT_MS = 10 * 60 * 1000;

async function server(opts = {}) {
  const {
    routeConfiguringFunction,
    port,
    hostname = null,
    allowCors = true,
    basePath = _constants.DEFAULT_BASE_PATH,
    plugins = [],
    keepAliveTimeout = KEEP_ALIVE_TIMEOUT_MS
  } = opts;
  const app = (0, _express.default)();

  const httpServer = _http.default.createServer(app);

  return await new _bluebird.default(async (resolve, reject) => {
    try {
      configureHttp({
        httpServer,
        reject,
        keepAliveTimeout
      });
      configureServer({
        app,
        addRoutes: routeConfiguringFunction,
        allowCors,
        basePath,
        plugins
      });
      await configureServerPlugins({
        app,
        httpServer,
        plugins
      });
      app.all('*', _middleware.catch404Handler);
      await startServer({
        httpServer,
        hostname,
        port,
        keepAliveTimeout
      });
      resolve(httpServer);
    } catch (err) {
      reject(err);
    }
  });
}

function configureServer({
  app,
  addRoutes,
  allowCors = true,
  basePath = _constants.DEFAULT_BASE_PATH,
  plugins = []
}) {
  basePath = normalizeBasePath(basePath);
  app.use(_expressLogging.endLogFormatter);
  app.use((0, _serveFavicon.default)(_path.default.resolve(_static.STATIC_DIR, 'favicon.ico')));
  app.use(_express.default.static(_static.STATIC_DIR));
  app.use(`${basePath}/produce_error`, _crash.produceError);
  app.use(`${basePath}/crash`, _crash.produceCrash);

  if (allowCors) {
    app.use(_middleware.allowCrossDomain);
  } else {
    app.use((0, _middleware.allowCrossDomainAsyncExecute)(basePath));
  }

  app.use(_middleware.handleIdempotency);
  app.use((0, _middleware.fixPythonContentType)(basePath));
  app.use(_middleware.defaultToJSONContentType);
  app.use(_bodyParser.default.urlencoded({
    extended: true
  }));
  app.use((0, _methodOverride.default)());
  app.use(_middleware.catchAllHandler);
  app.use(_bodyParser.default.json({
    limit: '1gb'
  }));
  app.use(_expressLogging.startLogFormatter);
  const extraMethods = plugins.filter(p => {
    if (!_lodash.default.isPlainObject(p.newMethodMap)) {
      _logger.default.warn(`Tried to apply newMethodMap from plugin '${p.name}' but it was invalid. Will ` + `skip adding these methods to the method map.`);

      return false;
    }

    return true;
  }).map(p => p.newMethodMap);
  addRoutes(app, {
    basePath,
    extraMethods
  });
  app.all('/welcome', _static.welcome);
  app.all('/test/guinea-pig', _static.guineaPig);
  app.all('/test/guinea-pig-scrollable', _static.guineaPigScrollable);
  app.all('/test/guinea-pig-app-banner', _static.guineaPigAppBanner);
}

function configureHttp({
  httpServer,
  reject,
  keepAliveTimeout
}) {
  const serverState = {
    notifier: new _events.EventEmitter(),
    closed: false
  };
  httpServer.addWebSocketHandler = _websocket.addWebSocketHandler;
  httpServer.removeWebSocketHandler = _websocket.removeWebSocketHandler;
  httpServer.removeAllWebSocketHandlers = _websocket.removeAllWebSocketHandlers;
  httpServer.getWebSocketHandlers = _websocket.getWebSocketHandlers;
  const close = httpServer.close.bind(httpServer);

  httpServer.close = async () => await new _bluebird.default((resolve, reject) => {
    serverState.closed = true;
    serverState.notifier.emit('shutdown');

    _logger.default.info('Waiting until the server is closed');

    httpServer.on('close', () => {
      _logger.default.info('Received server close event');

      resolve();
    });
    close(err => {
      if (err) reject(err);
    });
  });

  httpServer.on('error', err => {
    if (err.code === 'EADDRNOTAVAIL') {
      _logger.default.error('Could not start REST http interface listener. ' + 'Requested address is not available.');
    } else {
      _logger.default.error('Could not start REST http interface listener. The requested ' + 'port may already be in use. Please make sure there is no ' + 'other instance of this server running already.');
    }

    reject(err);
  });
  httpServer.on('connection', socket => {
    socket.setTimeout(keepAliveTimeout);
    socket.on('error', reject);

    function destroy() {
      socket.destroy();
    }

    socket._openReqCount = 0;
    socket.once('close', () => serverState.notifier.removeListener('shutdown', destroy));
    serverState.notifier.once('shutdown', destroy);
  });
  httpServer.on('request', function (req, res) {
    const socket = req.connection || req.socket;
    socket._openReqCount++;
    res.on('finish', function () {
      socket._openReqCount--;

      if (serverState.closed && socket._openReqCount === 0) {
        socket.destroy();
      }
    });
  });
}

async function configureServerPlugins({
  plugins,
  app,
  httpServer
}) {
  for (const plugin of plugins.filter(p => p.updatesServer)) {
    _logger.default.info(`Allowing plugin ${plugin.name} to modify the Appium server`);

    try {
      await plugin.updateServer(app, httpServer);
    } catch (err) {
      _logger.default.error(`Plugin '${plugin.name}' tried to update the server but the updateServer ` + `method was not implemented, did not return a promise, or threw an ` + `error. Original message: ${err}.`);

      throw err;
    }
  }
}

async function startServer({
  httpServer,
  port,
  hostname,
  keepAliveTimeout
}) {
  const serverArgs = [port];

  if (hostname) {
    serverArgs.push(hostname);
  }

  const startPromise = _bluebird.default.promisify(httpServer.listen, {
    context: httpServer
  })(...serverArgs);

  httpServer.keepAliveTimeout = keepAliveTimeout;
  httpServer.headersTimeout = keepAliveTimeout + 5 * 1000;
  await startPromise;
}

function normalizeBasePath(basePath) {
  if (!_lodash.default.isString(basePath)) {
    throw new Error(`Invalid path prefix ${basePath}`);
  }

  basePath = basePath.replace(/\/$/, '');

  if (basePath !== '' && basePath[0] !== '/') {
    basePath = `/${basePath}`;
  }

  return basePath;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leHByZXNzL3NlcnZlci5qcyJdLCJuYW1lcyI6WyJLRUVQX0FMSVZFX1RJTUVPVVRfTVMiLCJzZXJ2ZXIiLCJvcHRzIiwicm91dGVDb25maWd1cmluZ0Z1bmN0aW9uIiwicG9ydCIsImhvc3RuYW1lIiwiYWxsb3dDb3JzIiwiYmFzZVBhdGgiLCJERUZBVUxUX0JBU0VfUEFUSCIsInBsdWdpbnMiLCJrZWVwQWxpdmVUaW1lb3V0IiwiYXBwIiwiaHR0cFNlcnZlciIsImh0dHAiLCJjcmVhdGVTZXJ2ZXIiLCJCIiwicmVzb2x2ZSIsInJlamVjdCIsImNvbmZpZ3VyZUh0dHAiLCJjb25maWd1cmVTZXJ2ZXIiLCJhZGRSb3V0ZXMiLCJjb25maWd1cmVTZXJ2ZXJQbHVnaW5zIiwiYWxsIiwiY2F0Y2g0MDRIYW5kbGVyIiwic3RhcnRTZXJ2ZXIiLCJlcnIiLCJub3JtYWxpemVCYXNlUGF0aCIsInVzZSIsImVuZExvZ0Zvcm1hdHRlciIsInBhdGgiLCJTVEFUSUNfRElSIiwiZXhwcmVzcyIsInN0YXRpYyIsInByb2R1Y2VFcnJvciIsInByb2R1Y2VDcmFzaCIsImFsbG93Q3Jvc3NEb21haW4iLCJoYW5kbGVJZGVtcG90ZW5jeSIsImRlZmF1bHRUb0pTT05Db250ZW50VHlwZSIsImJvZHlQYXJzZXIiLCJ1cmxlbmNvZGVkIiwiZXh0ZW5kZWQiLCJjYXRjaEFsbEhhbmRsZXIiLCJqc29uIiwibGltaXQiLCJzdGFydExvZ0Zvcm1hdHRlciIsImV4dHJhTWV0aG9kcyIsImZpbHRlciIsInAiLCJfIiwiaXNQbGFpbk9iamVjdCIsIm5ld01ldGhvZE1hcCIsImxvZyIsIndhcm4iLCJuYW1lIiwibWFwIiwid2VsY29tZSIsImd1aW5lYVBpZyIsImd1aW5lYVBpZ1Njcm9sbGFibGUiLCJndWluZWFQaWdBcHBCYW5uZXIiLCJzZXJ2ZXJTdGF0ZSIsIm5vdGlmaWVyIiwiRXZlbnRFbWl0dGVyIiwiY2xvc2VkIiwiYWRkV2ViU29ja2V0SGFuZGxlciIsInJlbW92ZVdlYlNvY2tldEhhbmRsZXIiLCJyZW1vdmVBbGxXZWJTb2NrZXRIYW5kbGVycyIsImdldFdlYlNvY2tldEhhbmRsZXJzIiwiY2xvc2UiLCJiaW5kIiwiZW1pdCIsImluZm8iLCJvbiIsImNvZGUiLCJlcnJvciIsInNvY2tldCIsInNldFRpbWVvdXQiLCJkZXN0cm95IiwiX29wZW5SZXFDb3VudCIsIm9uY2UiLCJyZW1vdmVMaXN0ZW5lciIsInJlcSIsInJlcyIsImNvbm5lY3Rpb24iLCJwbHVnaW4iLCJ1cGRhdGVzU2VydmVyIiwidXBkYXRlU2VydmVyIiwic2VydmVyQXJncyIsInB1c2giLCJzdGFydFByb21pc2UiLCJwcm9taXNpZnkiLCJsaXN0ZW4iLCJjb250ZXh0IiwiaGVhZGVyc1RpbWVvdXQiLCJpc1N0cmluZyIsIkVycm9yIiwicmVwbGFjZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUtBOztBQUNBOztBQUNBOztBQUlBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLHFCQUFxQixHQUFHLEtBQUssRUFBTCxHQUFVLElBQXhDOztBQUdBLGVBQWVDLE1BQWYsQ0FBdUJDLElBQUksR0FBRyxFQUE5QixFQUFrQztBQUNoQyxRQUFNO0FBQ0pDLElBQUFBLHdCQURJO0FBRUpDLElBQUFBLElBRkk7QUFHSkMsSUFBQUEsUUFBUSxHQUFHLElBSFA7QUFJSkMsSUFBQUEsU0FBUyxHQUFHLElBSlI7QUFLSkMsSUFBQUEsUUFBUSxHQUFHQyw0QkFMUDtBQU1KQyxJQUFBQSxPQUFPLEdBQUcsRUFOTjtBQU9KQyxJQUFBQSxnQkFBZ0IsR0FBR1Y7QUFQZixNQVFGRSxJQVJKO0FBV0EsUUFBTVMsR0FBRyxHQUFHLHVCQUFaOztBQUNBLFFBQU1DLFVBQVUsR0FBR0MsY0FBS0MsWUFBTCxDQUFrQkgsR0FBbEIsQ0FBbkI7O0FBQ0EsU0FBTyxNQUFNLElBQUlJLGlCQUFKLENBQU0sT0FBT0MsT0FBUCxFQUFn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d0YsT0FBVCxDQUFpQixLQUFqQixFQUF3QixFQUF4QixDQUFYOztBQUlBLE1BQUl4RixRQUFRLEtBQUssRUFBYixJQUFtQkEsUUFBUSxDQUFDLENBQUQsQ0FBUixLQUFnQixHQUF2QyxFQUE0QztBQUMxQ0EsSUFBQUEsUUFBUSxHQUFJLElBQUdBLFFBQVMsRUFBeEI7QUFDRDs7QUFFRCxTQUFPQSxRQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnO1xuaW1wb3J0IGZhdmljb24gZnJvbSAnc2VydmUtZmF2aWNvbic7XG5pbXBvcnQgYm9keVBhcnNlciBmcm9tICdib2R5LXBhcnNlcic7XG5pbXBvcnQgbWV0aG9kT3ZlcnJpZGUgZnJvbSAnbWV0aG9kLW92ZXJyaWRlJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgc3RhcnRMb2dGb3JtYXR0ZXIsIGVuZExvZ0Zvcm1hdHRlciB9IGZyb20gJy4vZXhwcmVzcy1sb2dnaW5nJztcbmltcG9ydCB7XG4gIGFsbG93Q3Jvc3NEb21haW4sIGZpeFB5dGhvbkNvbnRlbnRUeXBlLCBkZWZhdWx0VG9KU09OQ29udGVudFR5cGUsXG4gIGNhdGNoQWxsSGFuZGxlciwgYWxsb3dDcm9zc0RvbWFpbkFzeW5jRXhlY3V0ZSwgaGFuZGxlSWRlbXBvdGVuY3ksXG4gIGNhdGNoNDA0SGFuZGxlcixcbn0gZnJvbSAnLi9taWRkbGV3YXJlJztcbmltcG9ydCB7IGd1aW5lYVBpZywgZ3VpbmVhUGlnU2Nyb2xsYWJsZSwgZ3VpbmVhUGlnQXBwQmFubmVyLCB3ZWxjb21lLCBTVEFUSUNfRElSIH0gZnJvbSAnLi9zdGF0aWMnO1xuaW1wb3J0IHsgcHJvZHVjZUVycm9yLCBwcm9kdWNlQ3Jhc2ggfSBmcm9tICcuL2NyYXNoJztcbmltcG9ydCB7XG4gIGFkZFdlYlNvY2tldEhhbmRsZXIsIHJlbW92ZVdlYlNvY2tldEhhbmRsZXIsIHJlbW92ZUFsbFdlYlNvY2tldEhhbmRsZXJzLFxuICBnZXRXZWJTb2NrZXRIYW5kbGVyc1xufSBmcm9tICcuL3dlYnNvY2tldCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBERUZBVUxUX0JBU0VfUEFUSCB9IGZyb20gJy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuXG5cbmNvbnN0IEtFRVBfQUxJVkVfVElNRU9VVF9NUyA9IDEwICogNjAgKiAxMDAwOyAvLyAxMCBtaW51dGVzXG5cblxuYXN5bmMgZnVuY3Rpb24gc2VydmVyIChvcHRzID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbixcbiAgICBwb3J0LFxuICAgIGhvc3RuYW1lID0gbnVsbCxcbiAgICBhbGxvd0NvcnMgPSB0cnVlLFxuICAgIGJhc2VQYXRoID0gREVGQVVMVF9CQVNFX1BBVEgsXG4gICAgcGx1Z2lucyA9IFtdLFxuICAgIGtlZXBBbGl2ZVRpbWVvdXQgPSBLRUVQX0FMSVZFX1RJTUVPVVRfTVMsXG4gIH0gPSBvcHRzO1xuXG4gIC8vIGNyZWF0ZSB0aGUgYWN0dWFsIGh0dHAgc2VydmVyXG4gIGNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcbiAgY29uc3QgaHR0cFNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKGFwcCk7XG4gIHJldHVybiBhd2FpdCBuZXcgQihhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgLy8gd2UgcHV0IGFuIGFzeW5jIGZ1bmN0aW9uIGFzIHRoZSBwcm9taXNlIGNvbnN0cnVjdG9yIGJlY2F1c2Ugd2Ugd2FudCBzb21lIHRoaW5ncyB0byBoYXBwZW4gaW5cbiAgICAvLyBzZXJpYWwgKGFwcGxpY2F0aW9uIG9mIHBsdWdpbiB1cGRhdGVzLCBmb3IgZXhhbXBsZSkuIEJ1dCB3ZSBzdGlsbCBuZWVkIHRvIHVzZSBhIHByb21pc2UgaGVyZVxuICAgIC8vIGJlY2F1c2Ugc29tZSBlbGVtZW50cyBvZiBzZXJ2ZXIgc3RhcnQgZmFpbHVyZSBvbmx5IGhhcHBlbiBpbiBodHRwU2VydmVyIGxpc3RlbmVycy4gU28gdGhlXG4gICAgLy8gd2F5IHdlIHJlc29sdmUgaXQgaXMgdG8gdXNlIGFuIGFzeW5jIGZ1bmN0aW9uIGhlcmUgYnV0IHRvIHdyYXAgYWxsIHRoZSBpbm5lciBsb2dpYyBpblxuICAgIC8vIHRyeS9jYXRjaCBzbyBhbnkgZXJyb3JzIGNhbiBiZSBwYXNzZWQgdG8gcmVqZWN0LlxuICAgIHRyeSB7XG4gICAgICBjb25maWd1cmVIdHRwKHtodHRwU2VydmVyLCByZWplY3QsIGtlZXBBbGl2ZVRpbWVvdXR9KTtcbiAgICAgIGNvbmZpZ3VyZVNlcnZlcih7YXBwLCBhZGRSb3V0ZXM6IHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbiwgYWxsb3dDb3JzLCBiYXNlUGF0aCwgcGx1Z2luc30pO1xuICAgICAgYXdhaXQgY29uZmlndXJlU2VydmVyUGx1Z2lucyh7YXBwLCBodHRwU2VydmVyLCBwbHVnaW5zfSk7XG5cbiAgICAgIC8vIG9uY2UgYWxsIGNvbmZpZ3VyYXRpb25zIGFuZCBwbHVnaW5zIGhhdmUgYmVlbiBhcHBsaWVkLCBtYWtlIHN1cmUgdG8gc2V0IHVwIGEgY2F0Y2hhbGxcbiAgICAgIC8vIGhhbmRsZXIgc28gdGhhdCBhbnl0aGluZyB1bmtub3duIDQwNHMuIEJ1dCBkbyB0aGlzIGFmdGVyIGV2ZXJ5dGhpbmcgZWxzZSBzaW5jZSB3ZSBkb24ndFxuICAgICAgLy8gd2FudCB0byBibG9jayBwbHVnaW5zJyBhYmlsaXR5IHRvIGFkZCByb3V0ZXMgaWYgdGhleSB3YW50LlxuICAgICAgYXBwLmFsbCgnKicsIGNhdGNoNDA0SGFuZGxlcik7XG5cbiAgICAgIGF3YWl0IHN0YXJ0U2VydmVyKHtodHRwU2VydmVyLCBob3N0bmFtZSwgcG9ydCwga2VlcEFsaXZlVGltZW91dH0pO1xuICAgICAgcmVzb2x2ZShodHRwU2VydmVyKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJlamVjdChlcnIpO1xuICAgIH1cbiAgfSk7XG5cbn1cblxuZnVuY3Rpb24gY29uZmlndXJlU2VydmVyICh7XG4gIGFwcCxcbiAgYWRkUm91dGVzLFxuICBhbGxvd0NvcnMgPSB0cnVlLFxuICBiYXNlUGF0aCA9IERFRkFVTFRfQkFTRV9QQVRILFxuICBwbHVnaW5zID0gW10sXG59KSB7XG4gIGJhc2VQYXRoID0gbm9ybWFsaXplQmFzZVBhdGgoYmFzZVBhdGgpO1xuXG4gIGFwcC51c2UoZW5kTG9nRm9ybWF0dGVyKTtcblxuICAvLyBzZXQgdXAgc3RhdGljIGFzc2V0c1xuICBhcHAudXNlKGZhdmljb24ocGF0aC5yZXNvbHZlKFNUQVRJQ19ESVIsICdmYXZpY29uLmljbycpKSk7XG4gIGFwcC51c2UoZXhwcmVzcy5zdGF0aWMoU1RBVElDX0RJUikpO1xuXG4gIC8vIGNyYXNoIHJvdXRlcywgZm9yIHRlc3RpbmdcbiAgYXBwLnVzZShgJHtiYXNlUGF0aH0vcHJvZHVjZV9lcnJvcmAsIHByb2R1Y2VFcnJvcik7XG4gIGFwcC51c2UoYCR7YmFzZVBhdGh9L2NyYXNoYCwgcHJvZHVjZUNyYXNoKTtcblxuICAvLyBhZGQgbWlkZGxld2FyZXNcbiAgaWYgKGFsbG93Q29ycykge1xuICAgIGFwcC51c2UoYWxsb3dDcm9zc0RvbWFpbik7XG4gIH0gZWxzZSB7XG4gICAgYXBwLnVzZShhbGxvd0Nyb3NzRG9tYWluQXN5bmNFeGVjdXRlKGJhc2VQYXRoKSk7XG4gIH1cbiAgYXBwLnVzZShoYW5kbGVJZGVtcG90ZW5jeSk7XG4gIGFwcC51c2UoZml4UHl0aG9uQ29udGVudFR5cGUoYmFzZVBhdGgpKTtcbiAgYXBwLnVzZShkZWZhdWx0VG9KU09OQ29udGVudFR5cGUpO1xuICBhcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7ZXh0ZW5kZWQ6IHRydWV9KSk7XG4gIGFwcC51c2UobWV0aG9kT3ZlcnJpZGUoKSk7XG4gIGFwcC51c2UoY2F0Y2hBbGxIYW5kbGVyKTtcblxuICAvLyBtYWtlIHN1cmUgYXBwaXVtIG5ldmVyIGZhaWxzIGJlY2F1c2Ugb2YgYSBmaWxlIHNpemUgdXBsb2FkIGxpbWl0XG4gIGFwcC51c2UoYm9keVBhcnNlci5qc29uKHtsaW1pdDogJzFnYid9KSk7XG5cbiAgLy8gc2V0IHVwIHN0YXJ0IGxvZ2dpbmcgKHdoaWNoIGRlcGVuZHMgb24gYm9keVBhcnNlciBkb2luZyBpdHMgdGhpbmcpXG4gIGFwcC51c2Uoc3RhcnRMb2dGb3JtYXR0ZXIpO1xuXG4gIGNvbnN0IGV4dHJhTWV0aG9kcyA9IHBsdWdpbnMuZmlsdGVyKChwKSA9PiB7XG4gICAgaWYgKCFfLmlzUGxhaW5PYmplY3QocC5uZXdNZXRob2RNYXApKSB7XG4gICAgICBsb2cud2FybihgVHJpZWQgdG8gYXBwbHkgbmV3TWV0aG9kTWFwIGZyb20gcGx1Z2luICcke3AubmFtZX0nIGJ1dCBpdCB3YXMgaW52YWxpZC4gV2lsbCBgICtcbiAgICAgICAgICAgICAgIGBza2lwIGFkZGluZyB0aGVzZSBtZXRob2RzIHRvIHRoZSBtZXRob2QgbWFwLmApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSkubWFwKChwKSA9PiBwLm5ld01ldGhvZE1hcCk7XG4gIGFkZFJvdXRlcyhhcHAsIHtiYXNlUGF0aCwgZXh0cmFNZXRob2RzfSk7XG5cbiAgLy8gZHluYW1pYyByb3V0ZXMgZm9yIHRlc3RpbmcsIGV0Yy5cbiAgYXBwLmFsbCgnL3dlbGNvbWUnLCB3ZWxjb21lKTtcbiAgYXBwLmFsbCgnL3Rlc3QvZ3VpbmVhLXBpZycsIGd1aW5lYVBpZyk7XG4gIGFwcC5hbGwoJy90ZXN0L2d1aW5lYS1waWctc2Nyb2xsYWJsZScsIGd1aW5lYVBpZ1Njcm9sbGFibGUpO1xuICBhcHAuYWxsKCcvdGVzdC9ndWluZWEtcGlnLWFwcC1iYW5uZXInLCBndWluZWFQaWdBcHBCYW5uZXIpO1xufVxuXG5mdW5jdGlvbiBjb25maWd1cmVIdHRwICh7aHR0cFNlcnZlciwgcmVqZWN0LCBrZWVwQWxpdmVUaW1lb3V0fSkge1xuICBjb25zdCBzZXJ2ZXJTdGF0ZSA9IHtcbiAgICBub3RpZmllcjogbmV3IEV2ZW50RW1pdHRlcigpLFxuICAgIGNsb3NlZDogZmFsc2UsXG4gIH07XG4gIGh0dHBTZXJ2ZXIuYWRkV2ViU29ja2V0SGFuZGxlciA9IGFkZFdlYlNvY2tldEhhbmRsZXI7XG4gIGh0dHBTZXJ2ZXIucmVtb3ZlV2ViU29ja2V0SGFuZGxlciA9IHJlbW92ZVdlYlNvY2tldEhhbmRsZXI7XG4gIGh0dHBTZXJ2ZXIucmVtb3ZlQWxsV2ViU29ja2V0SGFuZGxlcnMgPSByZW1vdmVBbGxXZWJTb2NrZXRIYW5kbGVycztcbiAgaHR0cFNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycyA9IGdldFdlYlNvY2tldEhhbmRsZXJzO1xuXG4gIC8vIGh0dHAuU2VydmVyLmNsb3NlKCkgb25seSBzdG9wcyBuZXcgY29ubmVjdGlvbnMsIGJ1dCB3ZSBuZWVkIHRvIHdhaXQgdW50aWxcbiAgLy8gYWxsIGNvbm5lY3Rpb25zIGFyZSBjbG9zZWQgYW5kIHRoZSBgY2xvc2VgIGV2ZW50IGlzIGVtaXR0ZWRcbiAgY29uc3QgY2xvc2UgPSBodHRwU2VydmVyLmNsb3NlLmJpbmQoaHR0cFNlcnZlcik7XG4gIGh0dHBTZXJ2ZXIuY2xvc2UgPSBhc3luYyAoKSA9PiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL25vZGVqcy9ub2RlLXYwLngtYXJjaGl2ZS9pc3N1ZXMvOTA2NiNpc3N1ZWNvbW1lbnQtMTI0MjEwNTc2XG4gICAgc2VydmVyU3RhdGUuY2xvc2VkID0gdHJ1ZTtcbiAgICBzZXJ2ZXJTdGF0ZS5ub3RpZmllci5lbWl0KCdzaHV0ZG93bicpO1xuICAgIGxvZy5pbmZvKCdXYWl0aW5nIHVudGlsIHRoZSBzZXJ2ZXIgaXMgY2xvc2VkJyk7XG4gICAgaHR0cFNlcnZlci5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICBsb2cuaW5mbygnUmVjZWl2ZWQgc2VydmVyIGNsb3NlIGV2ZW50Jyk7XG4gICAgICByZXNvbHZlKCk7XG4gICAgfSk7XG4gICAgY2xvc2UoKGVycikgPT4ge1xuICAgICAgaWYgKGVycikgcmVqZWN0KGVycik7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICB9KTtcbiAgfSk7XG5cbiAgaHR0cFNlcnZlci5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgaWYgKGVyci5jb2RlID09PSAnRUFERFJOT1RBVkFJTCcpIHtcbiAgICAgIGxvZy5lcnJvcignQ291bGQgbm90IHN0YXJ0IFJFU1QgaHR0cCBpbnRlcmZhY2UgbGlzdGVuZXIuICcgK1xuICAgICAgICAgICAgICAgICdSZXF1ZXN0ZWQgYWRkcmVzcyBpcyBub3QgYXZhaWxhYmxlLicpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZXJyb3IoJ0NvdWxkIG5vdCBzdGFydCBSRVNUIGh0dHAgaW50ZXJmYWNlIGxpc3RlbmVyLiBUaGUgcmVxdWVzdGVkICcgK1xuICAgICAgICAgICAgICAgICdwb3J0IG1heSBhbHJlYWR5IGJlIGluIHVzZS4gUGxlYXNlIG1ha2Ugc3VyZSB0aGVyZSBpcyBubyAnICtcbiAgICAgICAgICAgICAgICAnb3RoZXIgaW5zdGFuY2Ugb2YgdGhpcyBzZXJ2ZXIgcnVubmluZyBhbHJlYWR5LicpO1xuICAgIH1cbiAgICByZWplY3QoZXJyKTtcbiAgfSk7XG5cbiAgaHR0cFNlcnZlci5vbignY29ubmVjdGlvbicsIChzb2NrZXQpID0+IHtcbiAgICBzb2NrZXQuc2V0VGltZW91dChrZWVwQWxpdmVUaW1lb3V0KTtcbiAgICBzb2NrZXQub24oJ2Vycm9yJywgcmVqZWN0KTtcblxuICAgIGZ1bmN0aW9uIGRlc3Ryb3kgKCkge1xuICAgICAgc29ja2V0LmRlc3Ryb3koKTtcbiAgICB9XG4gICAgc29ja2V0Ll9vcGVuUmVxQ291bnQgPSAwO1xuICAgIHNvY2tldC5vbmNlKCdjbG9zZScsICgpID0+IHNlcnZlclN0YXRlLm5vdGlmaWVyLnJlbW92ZUxpc3RlbmVyKCdzaHV0ZG93bicsIGRlc3Ryb3kpKTtcbiAgICBzZXJ2ZXJTdGF0ZS5ub3RpZmllci5vbmNlKCdzaHV0ZG93bicsIGRlc3Ryb3kpO1xuICB9KTtcblxuICBodHRwU2VydmVyLm9uKCdyZXF1ZXN0JywgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gICAgY29uc3Qgc29ja2V0ID0gcmVxLmNvbm5lY3Rpb24gfHwgcmVxLnNvY2tldDtcbiAgICBzb2NrZXQuX29wZW5SZXFDb3VudCsrO1xuICAgIHJlcy5vbignZmluaXNoJywgZnVuY3Rpb24gKCkge1xuICAgICAgc29ja2V0Ll9vcGVuUmVxQ291bnQtLTtcbiAgICAgIGlmIChzZXJ2ZXJTdGF0ZS5jbG9zZWQgJiYgc29ja2V0Ll9vcGVuUmVxQ291bnQgPT09IDApIHtcbiAgICAgICAgc29ja2V0LmRlc3Ryb3koKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbmZpZ3VyZVNlcnZlclBsdWdpbnMgKHtwbHVnaW5zLCBhcHAsIGh0dHBTZXJ2ZXJ9KSB7XG4gIC8vIGFsbG93IHBsdWdpbnMgdG8gdXBkYXRlIHRoZSBhcHAgYW5kIGh0dHAgc2VydmVyIG9iamVjdHNcbiAgZm9yIChjb25zdCBwbHVnaW4gb2YgcGx1Z2lucy5maWx0ZXIoKHApID0+IHAudXBkYXRlc1NlcnZlcikpIHtcbiAgICBsb2cuaW5mbyhgQWxsb3dpbmcgcGx1Z2luICR7cGx1Z2luLm5hbWV9IHRvIG1vZGlmeSB0aGUgQXBwaXVtIHNlcnZlcmApO1xuICAgIHRyeSB7XG4gICAgICAvLyB3cmFwIHRoaXMgaW4gZXJyb3IgaGFuZGxpbmcgaW4gY2FzZSB0aGUgcGx1Z2luIGZvcmdvdCB0byBtYXJrIHRoZSBmdW5jdGlvbiBhc3luYyBvclxuICAgICAgLy8gZm9yZ290IHRvIGltcGxlbWVudCBpdFxuICAgICAgYXdhaXQgcGx1Z2luLnVwZGF0ZVNlcnZlcihhcHAsIGh0dHBTZXJ2ZXIpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yKGBQbHVnaW4gJyR7cGx1Z2luLm5hbWV9JyB0cmllZCB0byB1cGRhdGUgdGhlIHNlcnZlciBidXQgdGhlIHVwZGF0ZVNlcnZlciBgICtcbiAgICAgICAgICAgICAgICBgbWV0aG9kIHdhcyBub3QgaW1wbGVtZW50ZWQsIGRpZCBub3QgcmV0dXJuIGEgcHJvbWlzZSwgb3IgdGhyZXcgYW4gYCArXG4gICAgICAgICAgICAgICAgYGVycm9yLiBPcmlnaW5hbCBtZXNzYWdlOiAke2Vycn0uYCk7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHN0YXJ0U2VydmVyICh7aHR0cFNlcnZlciwgcG9ydCwgaG9zdG5hbWUsIGtlZXBBbGl2ZVRpbWVvdXR9KSB7XG4gIGNvbnN0IHNlcnZlckFyZ3MgPSBbcG9ydF07XG4gIGlmIChob3N0bmFtZSkge1xuICAgIC8vIElmIHRoZSBob3N0bmFtZSBpcyBvbWl0dGVkLCB0aGUgc2VydmVyIHdpbGwgYWNjZXB0XG4gICAgLy8gY29ubmVjdGlvbnMgb24gYW55IElQIGFkZHJlc3NcbiAgICBzZXJ2ZXJBcmdzLnB1c2goaG9zdG5hbWUpO1xuICB9XG4gIGNvbnN0IHN0YXJ0UHJvbWlzZSA9IEIucHJvbWlzaWZ5KGh0dHBTZXJ2ZXIubGlzdGVuLCB7Y29udGV4dDogaHR0cFNlcnZlcn0pKC4uLnNlcnZlckFyZ3MpO1xuICBodHRwU2VydmVyLmtlZXBBbGl2ZVRpbWVvdXQgPSBrZWVwQWxpdmVUaW1lb3V0O1xuICAvLyBoZWFkZXJzIHRpbWVvdXQgbXVzdCBiZSBncmVhdGVyIHRoYW4ga2VlcEFsaXZlVGltZW91dFxuICBodHRwU2VydmVyLmhlYWRlcnNUaW1lb3V0ID0ga2VlcEFsaXZlVGltZW91dCArIDUgKiAxMDAwO1xuICBhd2FpdCBzdGFydFByb21pc2U7XG59XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZUJhc2VQYXRoIChiYXNlUGF0aCkge1xuICBpZiAoIV8uaXNTdHJpbmcoYmFzZVBhdGgpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHBhdGggcHJlZml4ICR7YmFzZVBhdGh9YCk7XG4gIH1cblxuICAvLyBlbnN1cmUgdGhlIHBhdGggcHJlZml4IGRvZXMgbm90IGVuZCBpbiAnLycsIHNpbmNlIG91ciBtZXRob2QgbWFwXG4gIC8vIHN0YXJ0cyBhbGwgcGF0aHMgd2l0aCAnLydcbiAgYmFzZVBhdGggPSBiYXNlUGF0aC5yZXBsYWNlKC9cXC8kLywgJycpO1xuXG4gIC8vIGxpa2V3aXNlLCBlbnN1cmUgdGhlIHBhdGggcHJlZml4IGRvZXMgYWx3YXlzIFNUQVJUIHdpdGggLywgdW5sZXNzIHRoZSBwYXRoXG4gIC8vIGlzIGVtcHR5IG1lYW5pbmcgbm8gYmFzZSBwYXRoIGF0IGFsbFxuICBpZiAoYmFzZVBhdGggIT09ICcnICYmIGJhc2VQYXRoWzBdICE9PSAnLycpIHtcbiAgICBiYXNlUGF0aCA9IGAvJHtiYXNlUGF0aH1gO1xuICB9XG5cbiAgcmV0dXJuIGJhc2VQYXRoO1xufVxuXG5leHBvcnQgeyBzZXJ2ZXIsIGNvbmZpZ3VyZVNlcnZlciwgbm9ybWFsaXplQmFzZVBhdGggfTtcbiJdLCJmaWxlIjoibGliL2V4cHJlc3Mvc2VydmVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
