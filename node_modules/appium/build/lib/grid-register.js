"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _axios = _interopRequireDefault(require("axios"));

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

const hubUri = config => {
  const protocol = config.hubProtocol || 'http';
  return `${protocol}://${config.hubHost}:${config.hubPort}`;
};

async function registerNode(configFile, addr, port) {
  let data;

  try {
    data = await _appiumSupport.fs.readFile(configFile, 'utf-8');
  } catch (err) {
    _logger.default.error(`Unable to load node configuration file to register with grid: ${err.message}`);

    return;
  }

  if (!data) {
    _logger.default.error('No data found in the node configuration file to send to the grid');

    return;
  }

  postRequest(data, addr, port);
}

async function registerToGrid(postOptions, configHolder) {
  try {
    const {
      status
    } = await (0, _axios.default)(postOptions);

    if (status !== 200) {
      throw new Error(`Request failed with code ${status}`);
    }

    _logger.default.debug(`Appium successfully registered with the the grid on ` + hubUri(configHolder.configuration));
  } catch (err) {
    _logger.default.error(`An attempt to register with the grid was unsuccessful: ${err.message}`);
  }
}

function postRequest(data, addr, port) {
  let configHolder;

  try {
    configHolder = JSON.parse(data);
  } catch (err) {
    _logger.default.errorAndThrow(`Syntax error in node configuration file: ${err.message}`);
  }

  if (!_lodash.default.has(configHolder, 'configuration')) {
    let configuration = {};

    for (const property in configHolder) {
      if (_lodash.default.has(configHolder, property) && property !== 'capabilities') {
        configuration[property] = configHolder[property];
        delete configHolder[property];
      }
    }

    configHolder.configuration = configuration;
  }

  if (!configHolder.configuration.url || !configHolder.configuration.host || !configHolder.configuration.port) {
    configHolder.configuration.url = `http://${addr}:${port}/wd/hub`;
    configHolder.configuration.host = addr;
    configHolder.configuration.port = port;
  }

  if (!configHolder.configuration.id) {
    configHolder.configuration.id = `http://${configHolder.configuration.host}:${configHolder.configuration.port}`;
  }

  const regRequest = {
    url: `${hubUri(configHolder.configuration)}/grid/register`,
    method: 'POST',
    data: configHolder
  };

  if (configHolder.configuration.register !== true) {
    _logger.default.debug(`No registration sent (${configHolder.configuration.register} = false)`);

    return;
  }

  const registerCycleInterval = configHolder.configuration.registerCycle;

  if (isNaN(registerCycleInterval) || registerCycleInterval <= 0) {
    _logger.default.warn(`'registerCycle' is not a valid positive number. ` + `No registration request will be sent to the grid.`);

    return;
  }

  let first = true;

  _logger.default.debug(`Starting auto register thread for the grid. ` + `Will try to register every ${registerCycleInterval} ms.`);

  setInterval(async function registerRetry() {
    if (first) {
      first = false;
      await registerToGrid(regRequest, configHolder);
    } else if (!(await isAlreadyRegistered(configHolder))) {
      await registerToGrid(regRequest, configHolder);
    }
  }, registerCycleInterval);
}

async function isAlreadyRegistered(configHolder) {
  const id = configHolder.configuration.id;

  try {
    const {
      data,
      status
    } = await (0, _axios.default)({
      url: `${hubUri(configHolder.configuration)}/grid/api/proxy?id=${id}`,
      timeout: 10000
    });

    if (status !== 200) {
      throw new Error(`Request failed with code ${status}`);
    }

    if (!data.success) {
      _logger.default.debug(`Grid registration error: ${data.msg}`);
    }

    return data.success;
  } catch (err) {
    _logger.default.debug(`Hub down or not responding: ${err.message}`);
  }
}

var _default = registerNode;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ncmlkLXJlZ2lzdGVyLmpzIl0sIm5hbWVzIjpbImh1YlVyaSIsImNvbmZpZyIsInByb3RvY29sIiwiaHViUHJvdG9jb2wiLCJodWJIb3N0IiwiaHViUG9ydCIsInJlZ2lzdGVyTm9kZSIsImNvbmZpZ0ZpbGUiLCJhZGRyIiwicG9ydCIsImRhdGEiLCJmcyIsInJlYWRGaWxlIiwiZXJyIiwibG9nZ2VyIiwiZXJyb3IiLCJtZXNzYWdlIiwicG9zdFJlcXVlc3QiLCJyZWdpc3RlclRvR3JpZCIsInBvc3RPcHRpb25zIiwiY29uZmlnSG9sZGVyIiwic3RhdHVzIiwiRXJyb3IiLCJkZWJ1ZyIsImNvbmZpZ3VyYXRpb24iLCJKU09OIiwicGFyc2UiLCJlcnJvckFuZFRocm93IiwiXyIsImhhcyIsInByb3BlcnR5IiwidXJsIiwiaG9zdCIsImlkIiwicmVnUmVxdWVzdCIsIm1ldGhvZCIsInJlZ2lzdGVyIiwicmVnaXN0ZXJDeWNsZUludGVydmFsIiwicmVnaXN0ZXJDeWNsZSIsImlzTmFOIiwid2FybiIsImZpcnN0Iiwic2V0SW50ZXJ2YWwiLCJyZWdpc3RlclJldHJ5IiwiaXNBbHJlYWR5UmVnaXN0ZXJlZCIsInRpbWVvdXQiLCJzdWNjZXNzIiwibXNnIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLE1BQU0sR0FBSUMsTUFBRCxJQUFZO0FBQ3pCLFFBQU1DLFFBQVEsR0FBR0QsTUFBTSxDQUFDRSxXQUFQLElBQXNCLE1BQXZDO0FBQ0EsU0FBUSxHQUFFRCxRQUFTLE1BQUtELE1BQU0sQ0FBQ0csT0FBUSxJQUFHSCxNQUFNLENBQUNJLE9BQVEsRUFBekQ7QUFDRCxDQUhEOztBQUtBLGVBQWVDLFlBQWYsQ0FBNkJDLFVBQTdCLEVBQXlDQyxJQUF6QyxFQUErQ0MsSUFBL0MsRUFBcUQ7QUFDbkQsTUFBSUMsSUFBSjs7QUFDQSxNQUFJO0FBQ0ZBLElBQUFBLElBQUksR0FBRyxNQUFNQyxrQkFBR0Ms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LE1BQUFBO0FBQVAsUUFBaUIsTUFBTSxvQkFBTTtBQUNqQ1UsTUFBQUEsR0FBRyxFQUFHLEdBQUUvQixNQUFNLENBQUNvQixZQUFZLENBQUNJLGFBQWQsQ0FBNkIsc0JBQXFCUyxFQUFHLEVBRGxDO0FBRWpDWSxNQUFBQSxPQUFPLEVBQUU7QUFGd0IsS0FBTixDQUE3Qjs7QUFJQSxRQUFJeEIsTUFBTSxLQUFLLEdBQWYsRUFBb0I7QUFDbEIsWUFBTSxJQUFJQyxLQUFKLENBQVcsNEJBQTJCRCxNQUFPLEVBQTdDLENBQU47QUFDRDs7QUFDRCxRQUFJLENBQUNYLElBQUksQ0FBQ29DLE9BQVYsRUFBbUI7QUFFakJoQyxzQkFBT1MsS0FBUCxDQUFjLDRCQUEyQmIsSUFBSSxDQUFDcUMsR0FBSSxFQUFsRDtBQUNEOztBQUNELFdBQU9yQyxJQUFJLENBQUNvQyxPQUFaO0FBQ0QsR0FiRCxDQWFFLE9BQU9qQyxHQUFQLEVBQVk7QUFDWkMsb0JBQU9TLEtBQVAsQ0FBYywrQkFBOEJWLEdBQUcsQ0FBQ0csT0FBUSxFQUF4RDtBQUNEO0FBQ0Y7O2VBR2NWLFkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cblxuY29uc3QgaHViVXJpID0gKGNvbmZpZykgPT4ge1xuICBjb25zdCBwcm90b2NvbCA9IGNvbmZpZy5odWJQcm90b2NvbCB8fCAnaHR0cCc7XG4gIHJldHVybiBgJHtwcm90b2NvbH06Ly8ke2NvbmZpZy5odWJIb3N0fToke2NvbmZpZy5odWJQb3J0fWA7XG59O1xuXG5hc3luYyBmdW5jdGlvbiByZWdpc3Rlck5vZGUgKGNvbmZpZ0ZpbGUsIGFkZHIsIHBvcnQpIHtcbiAgbGV0IGRhdGE7XG4gIHRyeSB7XG4gICAgZGF0YSA9IGF3YWl0IGZzLnJlYWRGaWxlKGNvbmZpZ0ZpbGUsICd1dGYtOCcpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2dnZXIuZXJyb3IoYFVuYWJsZSB0byBsb2FkIG5vZGUgY29uZmlndXJhdGlvbiBmaWxlIHRvIHJlZ2lzdGVyIHdpdGggZ3JpZDogJHtlcnIubWVzc2FnZX1gKTtcbiAgICByZXR1cm47XG4gIH1cblxuICAvLyBDaGVjayBwcmVzZW5jZSBvZiBkYXRhIGJlZm9yZSBwb3N0aW5nICBpdCB0byB0aGUgc2VsZW5pdW0gZ3JpZFxuICBpZiAoIWRhdGEpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ05vIGRhdGEgZm91bmQgaW4gdGhlIG5vZGUgY29uZmlndXJhdGlvbiBmaWxlIHRvIHNlbmQgdG8gdGhlIGdyaWQnKTtcbiAgICByZXR1cm47XG4gIH1cbiAgcG9zdFJlcXVlc3QoZGF0YSwgYWRkciwgcG9ydCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlZ2lzdGVyVG9HcmlkIChwb3N0T3B0aW9ucywgY29uZmlnSG9sZGVyKSB7XG4gIHRyeSB7XG4gICAgY29uc3Qge3N0YXR1c30gPSBhd2FpdCBheGlvcyhwb3N0T3B0aW9ucyk7XG4gICAgaWYgKHN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlcXVlc3QgZmFpbGVkIHdpdGggY29kZSAke3N0YXR1c31gKTtcbiAgICB9XG4gICAgbG9nZ2VyLmRlYnVnKGBBcHBpdW0gc3VjY2Vzc2Z1bGx5IHJlZ2lzdGVyZWQgd2l0aCB0aGUgdGhlIGdyaWQgb24gYCArXG4gICAgICBodWJVcmkoY29uZmlnSG9sZGVyLmNvbmZpZ3VyYXRpb24pKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLmVycm9yKGBBbiBhdHRlbXB0IHRvIHJlZ2lzdGVyIHdpdGggdGhlIGdyaWQgd2FzIHVuc3VjY2Vzc2Z1bDogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBwb3N0UmVxdWVzdCAoZGF0YSwgYWRkciwgcG9ydCkge1xuICAvLyBwYXJzZSBqc29uIHRvIGdldCBodWIgaG9zdCBhbmQgcG9ydFxuICBsZXQgY29uZmlnSG9sZGVyO1xuICB0cnkge1xuICAgIGNvbmZpZ0hvbGRlciA9IEpTT04ucGFyc2UoZGF0YSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBTeW50YXggZXJyb3IgaW4gbm9kZSBjb25maWd1cmF0aW9uIGZpbGU6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cblxuICAvLyBNb3ZlIFNlbGVuaXVtIDMgY29uZmlndXJhdGlvbiBwcm9wZXJ0aWVzIHRvIGNvbmZpZ3VyYXRpb24gb2JqZWN0XG4gIGlmICghXy5oYXMoY29uZmlnSG9sZGVyLCAnY29uZmlndXJhdGlvbicpKSB7XG4gICAgbGV0IGNvbmZpZ3VyYXRpb24gPSB7fTtcbiAgICBmb3IgKGNvbnN0IHByb3BlcnR5IGluIGNvbmZpZ0hvbGRlcikge1xuICAgICAgaWYgKF8uaGFzKGNvbmZpZ0hvbGRlciwgcHJvcGVydHkpICYmIHByb3BlcnR5ICE9PSAnY2FwYWJpbGl0aWVzJykge1xuICAgICAgICBjb25maWd1cmF0aW9uW3Byb3BlcnR5XSA9IGNvbmZpZ0hvbGRlcltwcm9wZXJ0eV07XG4gICAgICAgIGRlbGV0ZSBjb25maWdIb2xkZXJbcHJvcGVydHldO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25maWdIb2xkZXIuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247XG4gIH1cblxuICAvLyBpZiB0aGUgbm9kZSBjb25maWcgZG9lcyBub3QgaGF2ZSB0aGUgYXBwaXVtL3dlYmRyaXZlciB1cmwsIGhvc3QsIGFuZCBwb3J0LFxuICAvLyBhdXRvbWF0aWNhbGx5IGFkZCBpdCBiYXNlZCBvbiBob3cgYXBwaXVtIHdhcyBpbml0aWFsaXplZFxuICAvLyBvdGhlcndpc2UsIHdlIHdpbGwgdGFrZSB3aGF0ZXZlciB0aGUgdXNlciBzZXR1cFxuICAvLyBiZWNhdXNlIHdlIHdpbGwgYWx3YXlzIHNldCBsb2NhbGhvc3QvMTI3LjAuMC4xLiB0aGlzIHdvbid0IHdvcmsgaWYgeW91clxuICAvLyBub2RlIGFuZCBncmlkIGFyZW4ndCBpbiB0aGUgc2FtZSBwbGFjZVxuICBpZiAoIWNvbmZpZ0hvbGRlci5jb25maWd1cmF0aW9uLnVybCB8fCAhY29uZmlnSG9sZGVyLmNvbmZpZ3VyYXRpb24uaG9zdCB8fCAhY29uZmlnSG9sZGVyLmNvbmZpZ3VyYXRpb24ucG9ydCkge1xuICAgIGNvbmZpZ0hvbGRlci5jb25maWd1cmF0aW9uLnVybCA9IGBodHRwOi8vJHthZGRyfToke3BvcnR9L3dkL2h1YmA7XG4gICAgY29uZmlnSG9sZGVyLmNvbmZpZ3VyYXRpb24uaG9zdCA9IGFkZHI7XG4gICAgY29uZmlnSG9sZGVyLmNvbmZpZ3VyYXRpb24ucG9ydCA9IHBvcnQ7XG4gIH1cbiAgLy8gaWYgdGhlIG5vZGUgY29uZmlnIGRvZXMgbm90IGhhdmUgaWQgYXV0b21hdGljYWxseSBhZGQgaXRcbiAgaWYgKCFjb25maWdIb2xkZXIuY29uZmlndXJhdGlvbi5pZCkge1xuICAgIGNvbmZpZ0hvbGRlci5jb25maWd1cmF0aW9uLmlkID0gYGh0dHA6Ly8ke2NvbmZpZ0hvbGRlci5jb25maWd1cmF0aW9uLmhvc3R9OiR7Y29uZmlnSG9sZGVyLmNvbmZpZ3VyYXRpb24ucG9ydH1gO1xuICB9XG5cbiAgLy8gdGhlIHBvc3Qgb3B0aW9uc1xuICBjb25zdCByZWdSZXF1ZXN0ID0ge1xuICAgIHVybDogYCR7aHViVXJpKGNvbmZpZ0hvbGRlci5jb25maWd1cmF0aW9uKX0vZ3JpZC9yZWdpc3RlcmAsXG4gICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgZGF0YTogY29uZmlnSG9sZGVyLFxuICB9O1xuXG4gIGlmIChjb25maWdIb2xkZXIuY29uZmlndXJhdGlvbi5yZWdpc3RlciAhPT0gdHJ1ZSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgTm8gcmVnaXN0cmF0aW9uIHNlbnQgKCR7Y29uZmlnSG9sZGVyLmNvbmZpZ3VyYXRpb24ucmVnaXN0ZXJ9ID0gZmFsc2UpYCk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgcmVnaXN0ZXJDeWNsZUludGVydmFsID0gY29uZmlnSG9sZGVyLmNvbmZpZ3VyYXRpb24ucmVnaXN0ZXJDeWNsZTtcbiAgaWYgKGlzTmFOKHJlZ2lzdGVyQ3ljbGVJbnRlcnZhbCkgfHwgcmVnaXN0ZXJDeWNsZUludGVydmFsIDw9IDApIHtcbiAgICBsb2dnZXIud2FybihgJ3JlZ2lzdGVyQ3ljbGUnIGlzIG5vdCBhIHZhbGlkIHBvc2l0aXZlIG51bWJlci4gYCArXG4gICAgICBgTm8gcmVnaXN0cmF0aW9uIHJlcXVlc3Qgd2lsbCBiZSBzZW50IHRvIHRoZSBncmlkLmApO1xuICAgIHJldHVybjtcbiAgfVxuICAvLyBpbml0aWF0ZSBhIG5ldyBUaHJlYWRcbiAgbGV0IGZpcnN0ID0gdHJ1ZTtcbiAgbG9nZ2VyLmRlYnVnKGBTdGFydGluZyBhdXRvIHJlZ2lzdGVyIHRocmVhZCBmb3IgdGhlIGdyaWQuIGAgK1xuICAgIGBXaWxsIHRyeSB0byByZWdpc3RlciBldmVyeSAke3JlZ2lzdGVyQ3ljbGVJbnRlcnZhbH0gbXMuYCk7XG4gIHNldEludGVydmFsKGFzeW5jIGZ1bmN0aW9uIHJlZ2lzdGVyUmV0cnkgKCkge1xuICAgIGlmIChmaXJzdCkge1xuICAgICAgZmlyc3QgPSBmYWxzZTtcbiAgICAgIGF3YWl0IHJlZ2lzdGVyVG9HcmlkKHJlZ1JlcXVlc3QsIGNvbmZpZ0hvbGRlcik7XG4gICAgfSBlbHNlIGlmICghYXdhaXQgaXNBbHJlYWR5UmVnaXN0ZXJlZChjb25maWdIb2xkZXIpKSB7XG4gICAgICAvLyBtYWtlIHRoZSBodHRwIFBPU1QgdG8gdGhlIGdyaWQgZm9yIHJlZ2lzdHJhdGlvblxuICAgICAgYXdhaXQgcmVnaXN0ZXJUb0dyaWQocmVnUmVxdWVzdCwgY29uZmlnSG9sZGVyKTtcbiAgICB9XG4gIH0sIHJlZ2lzdGVyQ3ljbGVJbnRlcnZhbCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGlzQWxyZWFkeVJlZ2lzdGVyZWQgKGNvbmZpZ0hvbGRlcikge1xuICAvL2NoZWNrIGlmIG5vZGUgaXMgYWxyZWFkeSByZWdpc3RlcmVkXG4gIGNvbnN0IGlkID0gY29uZmlnSG9sZGVyLmNvbmZpZ3VyYXRpb24uaWQ7XG4gIHRyeSB7XG4gICAgY29uc3Qge2RhdGEsIHN0YXR1c30gPSBhd2FpdCBheGlvcyh7XG4gICAgICB1cmw6IGAke2h1YlVyaShjb25maWdIb2xkZXIuY29uZmlndXJhdGlvbil9L2dyaWQvYXBpL3Byb3h5P2lkPSR7aWR9YCxcbiAgICAgIHRpbWVvdXQ6IDEwMDAwLFxuICAgIH0pO1xuICAgIGlmIChzdGF0dXMgIT09IDIwMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZXF1ZXN0IGZhaWxlZCB3aXRoIGNvZGUgJHtzdGF0dXN9YCk7XG4gICAgfVxuICAgIGlmICghZGF0YS5zdWNjZXNzKSB7XG4gICAgICAvLyBpZiByZWdpc3RlciBmYWlsLCBwcmludCB0aGUgZGVidWcgbXNnXG4gICAgICBsb2dnZXIuZGVidWcoYEdyaWQgcmVnaXN0cmF0aW9uIGVycm9yOiAke2RhdGEubXNnfWApO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YS5zdWNjZXNzO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2dnZXIuZGVidWcoYEh1YiBkb3duIG9yIG5vdCByZXNwb25kaW5nOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG59XG5cblxuZXhwb3J0IGRlZmF1bHQgcmVnaXN0ZXJOb2RlO1xuIl0sImZpbGUiOiJsaWIvZ3JpZC1yZWdpc3Rlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
